<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"shayne007.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="This place is for thinking and sharing.">
<meta property="og:type" content="website">
<meta property="og:title" content="Charlie Feng&#39;s Tech Space">
<meta property="og:url" content="https://shayne007.github.io/page/3/index.html">
<meta property="og:site_name" content="Charlie Feng&#39;s Tech Space">
<meta property="og:description" content="This place is for thinking and sharing.">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Charlie Feng">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://shayne007.github.io/page/3/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/3/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Charlie Feng's Tech Space</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"cdn":false,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.5.0/mermaid.min.js","integrity":"sha256-2obLuIPcceEhkE3G09G33hBdmE55ivVcZUlcKcGNHjU="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>





  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Charlie Feng's Tech Space</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">You will survive with skills</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Charlie Feng</p>
  <div class="site-description" itemprop="description">This place is for thinking and sharing.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">53</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/13/Design-File-Storage-Service/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/13/Design-File-Storage-Service/" class="post-title-link" itemprop="url">Design File Storage Service</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-13 17:50:00" itemprop="dateCreated datePublished" datetime="2025-06-13T17:50:00+08:00">2025-06-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-07-02 17:40:41" itemprop="dateModified" datetime="2025-07-02T17:40:41+08:00">2025-07-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system-design/" itemprop="url" rel="index"><span itemprop="name">system-design</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="System-Overview"><a href="#System-Overview" class="headerlink" title="System Overview"></a>System Overview</h2><h3 id="Vision"><a href="#Vision" class="headerlink" title="Vision"></a>Vision</h3><p>Design a scalable, extensible file storage service that abstracts multiple storage backends (HDFS, NFS) through a unified interface, providing seamless file operations for distributed applications.</p>
<h3 id="Key-Design-Principles"><a href="#Key-Design-Principles" class="headerlink" title="Key Design Principles"></a>Key Design Principles</h3><ul>
<li><strong>Pluggability</strong>: SPI-based driver architecture for easy backend integration</li>
<li><strong>Scalability</strong>: Handle millions of files with horizontal scaling</li>
<li><strong>Reliability</strong>: 99.9% availability with fault tolerance</li>
<li><strong>Performance</strong>: Sub-second response times for file operations</li>
<li><strong>Security</strong>: Enterprise-grade access control and encryption</li>
</ul>
<h3 id="High-Level-Architecture"><a href="#High-Level-Architecture" class="headerlink" title="High-Level Architecture"></a>High-Level Architecture</h3><pre>
<code class="mermaid">
graph TB
Client[Client Applications] --&gt; SDK[FileSystem SDK]
SDK --&gt; LB[Load Balancer]
LB --&gt; API[File Storage API Gateway]

API --&gt; Service[FileStorageService]
Service --&gt; SPI[SPI Framework]

SPI --&gt; HDFS[HDFS Driver]
SPI --&gt; NFS[NFS Driver]
SPI --&gt; S3[S3 Driver]

HDFS --&gt; HDFSCluster[HDFS Cluster]
NFS --&gt; NFSServer[NFS Server]
S3 --&gt; S3Bucket[S3 Storage]

Service --&gt; Cache[Redis Cache]
Service --&gt; DB[Metadata DB]
Service --&gt; MQ[Message Queue]
</code>
</pre>

<p><strong>💡 Interview Insight</strong>: <em>When discussing system architecture, emphasize the separation of concerns - API layer handles routing and validation, service layer manages business logic, and SPI layer provides storage abstraction. This demonstrates understanding of layered architecture patterns.</em></p>
<hr>
<h2 id="Architecture-Design"><a href="#Architecture-Design" class="headerlink" title="Architecture Design"></a>Architecture Design</h2><h3 id="Component-Interaction-Flow"><a href="#Component-Interaction-Flow" class="headerlink" title="Component Interaction Flow"></a>Component Interaction Flow</h3><pre>
<code class="mermaid">
sequenceDiagram
participant Client
participant SDK
participant Gateway
participant FileService
participant SPI
participant Storage
participant MetadataDB

Client-&gt;&gt;SDK: uploadFile(file, metadata)
SDK-&gt;&gt;Gateway: POST &#x2F;files&#x2F;upload
Gateway-&gt;&gt;FileService: processUpload()
FileService-&gt;&gt;SPI: store(fileData)
SPI-&gt;&gt;Storage: writeFile()
Storage--&gt;&gt;SPI: fileLocation
SPI--&gt;&gt;FileService: storageResult
FileService-&gt;&gt;MetadataDB: saveMetadata()
FileService--&gt;&gt;Gateway: uploadResponse
Gateway--&gt;&gt;SDK: HTTP 201 + fileUrl
SDK--&gt;&gt;Client: FileUploadResult
</code>
</pre>

<h3 id="Design-Patterns-Applied"><a href="#Design-Patterns-Applied" class="headerlink" title="Design Patterns Applied"></a>Design Patterns Applied</h3><ol>
<li><strong>Strategy Pattern</strong>: SPI drivers implement different storage strategies</li>
<li><strong>Factory Pattern</strong>: Driver creation based on configuration</li>
<li><strong>Template Method</strong>: Common file operations with backend-specific implementations</li>
<li><strong>Circuit Breaker</strong>: Fault tolerance for external storage systems</li>
<li><strong>Observer Pattern</strong>: Event-driven notifications for file operations</li>
</ol>
<p><strong>💡 Interview Insight</strong>: <em>Discussing design patterns shows architectural maturity. Mention how the Strategy pattern enables runtime switching between storage backends without code changes, which is crucial for multi-cloud deployments.</em></p>
<hr>
<h2 id="Core-Components"><a href="#Core-Components" class="headerlink" title="Core Components"></a>Core Components</h2><h3 id="1-FileStorageService"><a href="#1-FileStorageService" class="headerlink" title="1. FileStorageService"></a>1. FileStorageService</h3><p>The central orchestrator managing all file operations:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> FileSystemSPIManager spiManager;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MetadataRepository metadataRepo;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CacheManager cacheManager;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> FileUploadResult <span class="title function_">uploadFile</span><span class="params">(FileUploadRequest request)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. Validate file and metadata</span></span><br><span class="line">        validateFile(request.getFile());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. Generate unique file ID</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileId</span> <span class="operator">=</span> generateFileId();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. Determine storage backend based on policy</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">driverType</span> <span class="operator">=</span> determineStorageBackend(request);</span><br><span class="line">        <span class="type">FileSystemDriver</span> <span class="variable">driver</span> <span class="operator">=</span> spiManager.getDriver(driverType);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. Store file using appropriate driver</span></span><br><span class="line">        <span class="type">StorageResult</span> <span class="variable">result</span> <span class="operator">=</span> driver.store(fileId, request.getFile());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. Save metadata</span></span><br><span class="line">        <span class="type">FileMetadata</span> <span class="variable">metadata</span> <span class="operator">=</span> createMetadata(fileId, request, result);</span><br><span class="line">        metadataRepo.save(metadata);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 6. Cache metadata for quick access</span></span><br><span class="line">        cacheManager.put(fileId, metadata);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 7. Generate download URL</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">downloadUrl</span> <span class="operator">=</span> generateDownloadUrl(fileId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FileUploadResult</span>(fileId, downloadUrl, metadata);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> FileDownloadResult <span class="title function_">downloadFile</span><span class="params">(String fileId)</span> &#123;</span><br><span class="line">        <span class="comment">// Implementation with caching and fallback strategies</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-Metadata-Management"><a href="#2-Metadata-Management" class="headerlink" title="2. Metadata Management"></a>2. Metadata Management</h3><pre>
<code class="mermaid">
erDiagram
FILE_METADATA {
    string file_id PK
    string original_name
    string content_type
    long file_size
    string storage_backend
    string storage_path
    string checksum
    timestamp created_at
    timestamp updated_at
    string created_by
    json custom_attributes
    enum status
}

FILE_ACCESS_LOG {
    string log_id PK
    string file_id FK
    string operation_type
    string client_ip
    timestamp access_time
    boolean success
    string error_message
}

STORAGE_QUOTA {
    string tenant_id PK
    long total_quota
    long used_space
    long file_count
    timestamp last_updated
}
</code>
</pre>

<p><strong>💡 Interview Insight</strong>: <em>Metadata design is crucial for system scalability. Discuss partitioning strategies - file_id can be hash-partitioned, and time-based partitioning for access logs enables efficient historical data management.</em></p>
<hr>
<h2 id="SPI-Framework-Implementation"><a href="#SPI-Framework-Implementation" class="headerlink" title="SPI Framework Implementation"></a>SPI Framework Implementation</h2><h3 id="SPI-Architecture"><a href="#SPI-Architecture" class="headerlink" title="SPI Architecture"></a>SPI Architecture</h3><pre>
<code class="mermaid">
classDiagram
class FileSystemDriver {
    &lt;&lt;interface&gt;&gt;
    +store(fileId, fileData) StorageResult
    +retrieve(fileId) FileData
    +delete(fileId) boolean
    +exists(fileId) boolean
    +generateDownloadUrl(fileId) String
}

class HDFSDriver {
    -hdfsConfig: Configuration
    -fileSystem: FileSystem
    +store(fileId, fileData) StorageResult
    +retrieve(fileId) FileData
}

class NFSDriver {
    -nfsConfig: NFSConfig
    -mountPoint: String
    +store(fileId, fileData) StorageResult
    +retrieve(fileId) FileData
}

class S3Driver {
    -s3Client: AmazonS3
    -bucketName: String
    +store(fileId, fileData) StorageResult
    +retrieve(fileId) FileData
}

class DriverFactory {
    +createDriver(driverType) FileSystemDriver
}

class SPIManager {
    -drivers: Map~String,FileSystemDriver~
    +getDriver(type) FileSystemDriver
    +registerDriver(type, driver)
}

FileSystemDriver &lt;|-- HDFSDriver
FileSystemDriver &lt;|-- NFSDriver
FileSystemDriver &lt;|-- S3Driver
DriverFactory --&gt; FileSystemDriver
SPIManager --&gt; FileSystemDriver
</code>
</pre>

<h3 id="SPI-Configuration"><a href="#SPI-Configuration" class="headerlink" title="SPI Configuration"></a>SPI Configuration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// META-INF/services/com.fileservice.spi.FileSystemDriver</span></span><br><span class="line">com.fileservice.driver.HDFSDriver</span><br><span class="line">com.fileservice.driver.NFSDriver</span><br><span class="line">com.fileservice.driver.S3Driver</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileSystemSPIManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, FileSystemDriver&gt; drivers = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initializeDrivers</span><span class="params">()</span> &#123;</span><br><span class="line">        ServiceLoader&lt;FileSystemDriver&gt; loader = </span><br><span class="line">            ServiceLoader.load(FileSystemDriver.class);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (FileSystemDriver driver : loader) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">driverType</span> <span class="operator">=</span> driver.getDriverType();</span><br><span class="line">            drivers.put(driverType, driver);</span><br><span class="line">            logger.info(<span class="string">&quot;Registered driver: &#123;&#125;&quot;</span>, driverType);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> FileSystemDriver <span class="title function_">getDriver</span><span class="params">(String driverType)</span> &#123;</span><br><span class="line">        <span class="type">FileSystemDriver</span> <span class="variable">driver</span> <span class="operator">=</span> drivers.get(driverType);</span><br><span class="line">        <span class="keyword">if</span> (driver == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedDriverException</span>(<span class="string">&quot;Driver not found: &quot;</span> + driverType);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> driver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>💡 Interview Insight</strong>: <em>SPI demonstrates understanding of extensibility patterns. Mention that this approach allows adding new storage backends without modifying core service code, following the Open-Closed Principle.</em></p>
<hr>
<h2 id="API-Design"><a href="#API-Design" class="headerlink" title="API Design"></a>API Design</h2><h3 id="RESTful-API-Endpoints"><a href="#RESTful-API-Endpoints" class="headerlink" title="RESTful API Endpoints"></a>RESTful API Endpoints</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">openapi:</span> <span class="number">3.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">info:</span></span><br><span class="line">  <span class="attr">title:</span> <span class="string">File</span> <span class="string">Storage</span> <span class="string">Service</span> <span class="string">API</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">1.0</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="attr">paths:</span></span><br><span class="line">  <span class="string">/api/v1/files:</span></span><br><span class="line">    <span class="attr">post:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">Upload</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">requestBody:</span></span><br><span class="line">        <span class="attr">content:</span></span><br><span class="line">          <span class="attr">multipart/form-data:</span></span><br><span class="line">            <span class="attr">schema:</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">              <span class="attr">properties:</span></span><br><span class="line">                <span class="attr">file:</span></span><br><span class="line">                  <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                  <span class="attr">format:</span> <span class="string">binary</span></span><br><span class="line">                <span class="attr">metadata:</span></span><br><span class="line">                  <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                <span class="attr">storagePreference:</span></span><br><span class="line">                  <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                  <span class="attr">enum:</span> [<span class="string">hdfs</span>, <span class="string">nfs</span>, <span class="string">s3</span>]</span><br><span class="line">      <span class="attr">responses:</span></span><br><span class="line">        <span class="attr">&#x27;201&#x27;:</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">File</span> <span class="string">uploaded</span> <span class="string">successfully</span></span><br><span class="line">          <span class="attr">content:</span></span><br><span class="line">            <span class="attr">application/json:</span></span><br><span class="line">              <span class="attr">schema:</span></span><br><span class="line">                <span class="string">$ref:</span> <span class="string">&#x27;#/components/schemas/FileUploadResponse&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">get:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">List</span> <span class="string">files</span> <span class="string">with</span> <span class="string">pagination</span></span><br><span class="line">      <span class="attr">parameters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">page</span></span><br><span class="line">          <span class="attr">in:</span> <span class="string">query</span></span><br><span class="line">          <span class="attr">schema:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">size</span></span><br><span class="line">          <span class="attr">in:</span> <span class="string">query</span></span><br><span class="line">          <span class="attr">schema:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">filter</span></span><br><span class="line">          <span class="attr">in:</span> <span class="string">query</span></span><br><span class="line">          <span class="attr">schema:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">responses:</span></span><br><span class="line">        <span class="attr">&#x27;200&#x27;:</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">Files</span> <span class="string">retrieved</span> <span class="string">successfully</span></span><br><span class="line"></span><br><span class="line">  <span class="string">/api/v1/files/&#123;fileId&#125;:</span></span><br><span class="line">    <span class="attr">get:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">Get</span> <span class="string">file</span> <span class="string">metadata</span></span><br><span class="line">      <span class="attr">parameters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fileId</span></span><br><span class="line">          <span class="attr">in:</span> <span class="string">path</span></span><br><span class="line">          <span class="attr">required:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">schema:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">responses:</span></span><br><span class="line">        <span class="attr">&#x27;200&#x27;:</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">File</span> <span class="string">metadata</span> <span class="string">retrieved</span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">delete:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">Delete</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">responses:</span></span><br><span class="line">        <span class="attr">&#x27;204&#x27;:</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">File</span> <span class="string">deleted</span> <span class="string">successfully</span></span><br><span class="line"></span><br><span class="line">  <span class="string">/api/v1/files/&#123;fileId&#125;/download:</span></span><br><span class="line">    <span class="attr">get:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">Download</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">responses:</span></span><br><span class="line">        <span class="attr">&#x27;200&#x27;:</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">File</span> <span class="string">content</span></span><br><span class="line">          <span class="attr">content:</span></span><br><span class="line">            <span class="attr">application/octet-stream:</span></span><br><span class="line">              <span class="attr">schema:</span></span><br><span class="line">                <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                <span class="attr">format:</span> <span class="string">binary</span></span><br><span class="line"></span><br><span class="line"><span class="attr">components:</span></span><br><span class="line">  <span class="attr">schemas:</span></span><br><span class="line">    <span class="attr">FileUploadResponse:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">      <span class="attr">properties:</span></span><br><span class="line">        <span class="attr">fileId:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">        <span class="attr">downloadUrl:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">        <span class="attr">metadata:</span></span><br><span class="line">          <span class="string">$ref:</span> <span class="string">&#x27;#/components/schemas/FileMetadata&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="Request-Response-Flow"><a href="#Request-Response-Flow" class="headerlink" title="Request&#x2F;Response Flow"></a>Request&#x2F;Response Flow</h3><pre>
<code class="mermaid">
flowchart TD
A[Client Request] --&gt; B{Request Validation}
B --&gt;|Valid| C[Authentication &amp; Authorization]
B --&gt;|Invalid| D[Return 400 Bad Request]

C --&gt;|Authorized| E[Route to Service]
C --&gt;|Unauthorized| F[Return 401&#x2F;403]

E --&gt; G[Business Logic Processing]
G --&gt; H{Storage Operation}

H --&gt;|Success| I[Update Metadata]
H --&gt;|Failure| J[Rollback &amp; Error Response]

I --&gt; K[Generate Response]
K --&gt; L[Return Success Response]

J --&gt; M[Return Error Response]
</code>
</pre>

<p><strong>💡 Interview Insight</strong>: <em>API design considerations include idempotency for upload operations, proper HTTP status codes, and consistent error response format. Discuss rate limiting and API versioning strategies for production systems.</em></p>
<hr>
<h2 id="Client-SDK"><a href="#Client-SDK" class="headerlink" title="Client SDK"></a>Client SDK</h2><h3 id="SDK-Architecture"><a href="#SDK-Architecture" class="headerlink" title="SDK Architecture"></a>SDK Architecture</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageClient</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String baseUrl;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HttpClient httpClient;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthenticationProvider authProvider;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RetryPolicy retryPolicy;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FileStorageClient</span><span class="params">(FileStorageConfig config)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.baseUrl = config.getBaseUrl();</span><br><span class="line">        <span class="built_in">this</span>.httpClient = createHttpClient(config);</span><br><span class="line">        <span class="built_in">this</span>.authProvider = <span class="keyword">new</span> <span class="title class_">AuthenticationProvider</span>(config);</span><br><span class="line">        <span class="built_in">this</span>.retryPolicy = RetryPolicy.exponentialBackoff();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;FileUploadResult&gt; <span class="title function_">uploadFileAsync</span><span class="params">(</span></span><br><span class="line"><span class="params">            String filePath, </span></span><br><span class="line"><span class="params">            FileUploadOptions options)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> uploadFileInternal(filePath, options);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileStorageException</span>(<span class="string">&quot;Upload failed&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> FileDownloadResult <span class="title function_">downloadFile</span><span class="params">(String fileId, String destPath)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> retryPolicy.execute(() -&gt; &#123;</span><br><span class="line">            <span class="type">HttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> buildDownloadRequest(fileId);</span><br><span class="line">            HttpResponse&lt;<span class="type">byte</span>[]&gt; response = httpClient.send(request, </span><br><span class="line">                HttpResponse.BodyHandlers.ofByteArray());</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (response.statusCode() == <span class="number">200</span>) &#123;</span><br><span class="line">                Files.write(Paths.get(destPath), response.body());</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FileDownloadResult</span>(fileId, destPath);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileStorageException</span>(<span class="string">&quot;Download failed: &quot;</span> + response.statusCode());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SDK-Features"><a href="#SDK-Features" class="headerlink" title="SDK Features"></a>SDK Features</h3><ol>
<li><strong>Async Operations</strong>: Non-blocking file operations</li>
<li><strong>Retry Logic</strong>: Exponential backoff with jitter</li>
<li><strong>Progress Tracking</strong>: Upload&#x2F;download progress callbacks</li>
<li><strong>Connection Pooling</strong>: Efficient HTTP connection management</li>
<li><strong>Error Handling</strong>: Comprehensive exception hierarchy</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Usage Example</span></span><br><span class="line"><span class="type">FileStorageClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileStorageClient</span>(config);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Async upload with progress tracking</span></span><br><span class="line">CompletableFuture&lt;FileUploadResult&gt; future = client.uploadFileAsync(</span><br><span class="line">    <span class="string">&quot;large-file.zip&quot;</span>,</span><br><span class="line">    FileUploadOptions.builder()</span><br><span class="line">        .storageBackend(<span class="string">&quot;hdfs&quot;</span>)</span><br><span class="line">        .progressCallback(progress -&gt; </span><br><span class="line">            System.out.println(<span class="string">&quot;Upload progress: &quot;</span> + progress.getPercentage() + <span class="string">&quot;%&quot;</span>))</span><br><span class="line">        .build()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">future.thenAccept(result -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;File uploaded: &quot;</span> + result.getDownloadUrl());</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>💡 Interview Insight</strong>: <em>SDK design demonstrates client-side engineering skills. Discuss thread safety, connection pooling, and how to handle large file uploads with chunking and resume capabilities.</em></p>
<hr>
<h2 id="Storage-Backends"><a href="#Storage-Backends" class="headerlink" title="Storage Backends"></a>Storage Backends</h2><h3 id="HDFS-Integration"><a href="#HDFS-Integration" class="headerlink" title="HDFS Integration"></a>HDFS Integration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HDFSDriver</span> <span class="keyword">implements</span> <span class="title class_">FileSystemDriver</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileSystem hdfsFileSystem;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Configuration hadoopConfig;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> StorageResult <span class="title function_">store</span><span class="params">(String fileId, FileData fileData)</span> &#123;</span><br><span class="line">        <span class="type">Path</span> <span class="variable">hdfsPath</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Path</span>(<span class="string">&quot;/fileservice/&quot;</span> + generatePath(fileId));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">FSDataOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> hdfsFileSystem.create(hdfsPath)) &#123;</span><br><span class="line">            IOUtils.copyBytes(fileData.getInputStream(), outputStream, <span class="number">4096</span>, <span class="literal">false</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="type">FileStatus</span> <span class="variable">fileStatus</span> <span class="operator">=</span> hdfsFileSystem.getFileStatus(hdfsPath);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> StorageResult.builder()</span><br><span class="line">                .fileId(fileId)</span><br><span class="line">                .storagePath(hdfsPath.toString())</span><br><span class="line">                .size(fileStatus.getLen())</span><br><span class="line">                .checksum(calculateChecksum(fileData))</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StorageException</span>(<span class="string">&quot;HDFS store failed&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FileData <span class="title function_">retrieve</span><span class="params">(String fileId)</span> &#123;</span><br><span class="line">        <span class="type">Path</span> <span class="variable">hdfsPath</span> <span class="operator">=</span> getPathFromFileId(fileId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">FSDataInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> hdfsFileSystem.open(hdfsPath);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FileData</span>(inputStream, hdfsFileSystem.getFileStatus(hdfsPath).getLen());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StorageException</span>(<span class="string">&quot;HDFS retrieve failed&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">generatePath</span><span class="params">(String fileId)</span> &#123;</span><br><span class="line">        <span class="comment">// Generate hierarchical path: /2023/12/15/abc123...</span></span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;%s/%s/%s/%s&quot;</span>, </span><br><span class="line">            LocalDate.now().getYear(),</span><br><span class="line">            LocalDate.now().getMonthValue(),</span><br><span class="line">            LocalDate.now().getDayOfMonth(),</span><br><span class="line">            fileId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="NFS-Integration"><a href="#NFS-Integration" class="headerlink" title="NFS Integration"></a>NFS Integration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NFSDriver</span> <span class="keyword">implements</span> <span class="title class_">FileSystemDriver</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String mountPoint;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileSystem nfsFileSystem;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> StorageResult <span class="title function_">store</span><span class="params">(String fileId, FileData fileData)</span> &#123;</span><br><span class="line">        <span class="type">Path</span> <span class="variable">nfsPath</span> <span class="operator">=</span> Paths.get(mountPoint, generatePath(fileId));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Files.createDirectories(nfsPath.getParent());</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">input</span> <span class="operator">=</span> fileData.getInputStream();</span><br><span class="line">                 <span class="type">OutputStream</span> <span class="variable">output</span> <span class="operator">=</span> Files.newOutputStream(nfsPath)) &#123;</span><br><span class="line">                </span><br><span class="line">                <span class="type">long</span> <span class="variable">bytesTransferred</span> <span class="operator">=</span> input.transferTo(output);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> StorageResult.builder()</span><br><span class="line">                    .fileId(fileId)</span><br><span class="line">                    .storagePath(nfsPath.toString())</span><br><span class="line">                    .size(bytesTransferred)</span><br><span class="line">                    .checksum(calculateChecksum(nfsPath))</span><br><span class="line">                    .build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StorageException</span>(<span class="string">&quot;NFS store failed&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Storage-Selection-Strategy"><a href="#Storage-Selection-Strategy" class="headerlink" title="Storage Selection Strategy"></a>Storage Selection Strategy</h3><pre>
<code class="mermaid">
flowchart TD
A[File Upload Request] --&gt; B{File Size Check}
B --&gt;|&lt; 100MB| C{Performance Priority?}
B --&gt;|&gt; 100MB| D{Durability Priority?}

C --&gt;|Yes| E[NFS - Low Latency]
C --&gt;|No| F[HDFS - Cost Effective]

D --&gt;|Yes| G[HDFS - Replication]
D --&gt;|No| H[S3 - Archival]

E --&gt; I[Store in NFS]
F --&gt; J[Store in HDFS]
G --&gt; J
H --&gt; K[Store in S3]
</code>
</pre>

<p><strong>💡 Interview Insight</strong>: <em>Storage selection demonstrates understanding of trade-offs. NFS offers low latency but limited scalability, HDFS provides distributed storage with replication, S3 offers infinite scale but higher latency. Discuss when to use each based on access patterns.</em></p>
<hr>
<h2 id="Security-Performance"><a href="#Security-Performance" class="headerlink" title="Security &amp; Performance"></a>Security &amp; Performance</h2><h3 id="Security-Implementation"><a href="#Security-Implementation" class="headerlink" title="Security Implementation"></a>Security Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/v1/files&quot;)</span></span><br><span class="line"><span class="meta">@PreAuthorize(&quot;hasRole(&#x27;FILE_USER&#x27;)&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;@fileSecurityService.canUpload(authentication.name, #request.storageBackend)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;FileUploadResponse&gt; <span class="title function_">uploadFile</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;metadata&quot;)</span> String metadata,</span></span><br><span class="line"><span class="params">            FileUploadRequest request)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Validate file type and size</span></span><br><span class="line">        fileValidationService.validateFile(file);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Scan for malware</span></span><br><span class="line">        <span class="keyword">if</span> (!malwareScanService.isFileSafe(file)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;File failed security scan&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">FileUploadResult</span> <span class="variable">result</span> <span class="operator">=</span> fileStorageService.uploadFile(request);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.CREATED).body(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileSecurityService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">canUpload</span><span class="params">(String username, String storageBackend)</span> &#123;</span><br><span class="line">        <span class="type">UserPermissions</span> <span class="variable">permissions</span> <span class="operator">=</span> userService.getPermissions(username);</span><br><span class="line">        <span class="keyword">return</span> permissions.hasStorageAccess(storageBackend);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generateSignedUrl</span><span class="params">(String fileId, Duration expiry)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> jwtService.createToken(</span><br><span class="line">            Map.of(<span class="string">&quot;fileId&quot;</span>, fileId, <span class="string">&quot;action&quot;</span>, <span class="string">&quot;download&quot;</span>),</span><br><span class="line">            expiry</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> baseUrl + <span class="string">&quot;/files/&quot;</span> + fileId + <span class="string">&quot;/download?token=&quot;</span> + token;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Performance-Optimizations"><a href="#Performance-Optimizations" class="headerlink" title="Performance Optimizations"></a>Performance Optimizations</h3><ol>
<li><strong>Connection Pooling</strong>: HTTP and database connection pools</li>
<li><strong>Caching Strategy</strong>: Multi-level caching (Redis + Local)</li>
<li><strong>Async Processing</strong>: Non-blocking I&#x2F;O operations</li>
<li><strong>Compression</strong>: Automatic compression for large files</li>
<li><strong>CDN Integration</strong>: Geographic distribution for downloads</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PerformanceConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title function_">fileProcessingExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">        executor.setCorePoolSize(<span class="number">10</span>);</span><br><span class="line">        executor.setMaxPoolSize(<span class="number">50</span>);</span><br><span class="line">        executor.setQueueCapacity(<span class="number">100</span>);</span><br><span class="line">        executor.setThreadNamePrefix(<span class="string">&quot;file-processor-&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CacheManager <span class="title function_">cacheManager</span><span class="params">()</span> &#123;</span><br><span class="line">        RedisCacheManager.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> RedisCacheManager</span><br><span class="line">            .RedisCacheManagerBuilder</span><br><span class="line">            .fromConnectionFactory(redisConnectionFactory())</span><br><span class="line">            .cacheDefaults(cacheConfiguration());</span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>💡 Interview Insight</strong>: <em>Performance discussions should cover caching strategies (what to cache, cache invalidation), connection pooling, and async processing. Mention specific metrics like P99 latency targets and throughput requirements.</em></p>
<hr>
<h2 id="Monitoring-Operations"><a href="#Monitoring-Operations" class="headerlink" title="Monitoring &amp; Operations"></a>Monitoring &amp; Operations</h2><h3 id="Metrics-and-Monitoring"><a href="#Metrics-and-Monitoring" class="headerlink" title="Metrics and Monitoring"></a>Metrics and Monitoring</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageMetrics</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Counter</span> <span class="variable">uploadCounter</span> <span class="operator">=</span> Counter.builder(<span class="string">&quot;file.uploads.total&quot;</span>)</span><br><span class="line">        .description(<span class="string">&quot;Total file uploads&quot;</span>)</span><br><span class="line">        .tag(<span class="string">&quot;storage_backend&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">        .register(Metrics.globalRegistry);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Timer</span> <span class="variable">uploadTimer</span> <span class="operator">=</span> Timer.builder(<span class="string">&quot;file.upload.duration&quot;</span>)</span><br><span class="line">        .description(<span class="string">&quot;File upload duration&quot;</span>)</span><br><span class="line">        .register(Metrics.globalRegistry);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Gauge</span> <span class="variable">storageUsage</span> <span class="operator">=</span> Gauge.builder(<span class="string">&quot;storage.usage.bytes&quot;</span>)</span><br><span class="line">        .description(<span class="string">&quot;Storage usage by backend&quot;</span>)</span><br><span class="line">        .tag(<span class="string">&quot;backend&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">        .register(Metrics.globalRegistry, <span class="built_in">this</span>, FileStorageMetrics::getStorageUsage);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordUpload</span><span class="params">(String backend, Duration duration)</span> &#123;</span><br><span class="line">        uploadCounter.increment(Tags.of(<span class="string">&quot;storage_backend&quot;</span>, backend));</span><br><span class="line">        uploadTimer.record(duration);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Health-Checks"><a href="#Health-Checks" class="headerlink" title="Health Checks"></a>Health Checks</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageHealthIndicator</span> <span class="keyword">implements</span> <span class="title class_">HealthIndicator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Health <span class="title function_">health</span><span class="params">()</span> &#123;</span><br><span class="line">        Health.<span class="type">Builder</span> <span class="variable">status</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Health</span>.Builder();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check storage backends</span></span><br><span class="line">        <span class="keyword">for</span> (String backend : spiManager.getAvailableBackends()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">FileSystemDriver</span> <span class="variable">driver</span> <span class="operator">=</span> spiManager.getDriver(backend);</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">healthy</span> <span class="operator">=</span> driver.healthCheck();</span><br><span class="line">                status.withDetail(backend, healthy ? <span class="string">&quot;UP&quot;</span> : <span class="string">&quot;DOWN&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                status.withDetail(backend, <span class="string">&quot;ERROR: &quot;</span> + e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> status.up().build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Observability-Dashboard"><a href="#Observability-Dashboard" class="headerlink" title="Observability Dashboard"></a>Observability Dashboard</h3><pre>
<code class="mermaid">
graph LR
subgraph &quot;Application Metrics&quot;
    A[Upload Rate]
    B[Download Rate]
    C[Error Rate]
    D[Response Time]
end

subgraph &quot;Infrastructure Metrics&quot;
    E[CPU Usage]
    F[Memory Usage]
    G[Disk I&#x2F;O]
    H[Network I&#x2F;O]
end

subgraph &quot;Business Metrics&quot;
    I[Storage Usage]
    J[Active Users]
    K[File Types]
    L[Storage Costs]
end

A --&gt; M[Grafana Dashboard]
B --&gt; M
C --&gt; M
D --&gt; M
E --&gt; M
F --&gt; M
G --&gt; M
H --&gt; M
I --&gt; M
J --&gt; M
K --&gt; M
L --&gt; M
</code>
</pre>

<p><strong>💡 Interview Insight</strong>: <em>Observability is crucial for production systems. Discuss the difference between metrics (quantitative), logs (qualitative), and traces (request flow). Mention SLA&#x2F;SLO concepts and how monitoring supports them.</em></p>
<hr>
<h2 id="Deployment-Strategy"><a href="#Deployment-Strategy" class="headerlink" title="Deployment Strategy"></a>Deployment Strategy</h2><h3 id="Containerized-Deployment"><a href="#Containerized-Deployment" class="headerlink" title="Containerized Deployment"></a>Containerized Deployment</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose.yml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">file-storage-service:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">file-storage-service:latest</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_PROFILES_ACTIVE=production</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">STORAGE_BACKENDS=hdfs,nfs,s3</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config:/app/config</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">postgres</span></span><br><span class="line">      </span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:alpine</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">      </span><br><span class="line">  <span class="attr">postgres:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:13</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">POSTGRES_DB:</span> <span class="string">fileservice</span></span><br><span class="line">      <span class="attr">POSTGRES_USER:</span> <span class="string">fileuser</span></span><br><span class="line">      <span class="attr">POSTGRES_PASSWORD:</span> <span class="string">filepass</span></span><br></pre></td></tr></table></figure>

<h3 id="Kubernetes-Deployment"><a href="#Kubernetes-Deployment" class="headerlink" title="Kubernetes Deployment"></a>Kubernetes Deployment</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">file-storage-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">file-storage-service</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">file-storage-service</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">file-storage-service</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">file-storage-service:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">STORAGE_BACKENDS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;hdfs,s3&quot;</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;512Mi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;1000m&quot;</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/actuator/health</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<h3 id="Scaling-Strategy"><a href="#Scaling-Strategy" class="headerlink" title="Scaling Strategy"></a>Scaling Strategy</h3><pre>
<code class="mermaid">
graph TD
A[Load Balancer] --&gt; B[File Service Instance 1]
A --&gt; C[File Service Instance 2]
A --&gt; D[File Service Instance N]

B --&gt; E[Storage Backend Pool]
C --&gt; E
D --&gt; E

E --&gt; F[HDFS Cluster]
E --&gt; G[NFS Servers]
E --&gt; H[S3 Storage]

I[Auto Scaler] --&gt; A
I --&gt; B
I --&gt; C
I --&gt; D
</code>
</pre>

<p><strong>💡 Interview Insight</strong>: <em>Deployment discussions should cover horizontal vs vertical scaling, stateless service design, and data partitioning strategies. Mention circuit breakers for external dependencies and graceful degradation patterns.</em></p>
<hr>
<h2 id="Interview-Key-Points-Summary"><a href="#Interview-Key-Points-Summary" class="headerlink" title="Interview Key Points Summary"></a>Interview Key Points Summary</h2><h3 id="System-Design-Fundamentals"><a href="#System-Design-Fundamentals" class="headerlink" title="System Design Fundamentals"></a>System Design Fundamentals</h3><ul>
<li><strong>Scalability</strong>: Horizontal scaling through stateless services</li>
<li><strong>Reliability</strong>: Circuit breakers, retries, and failover mechanisms</li>
<li><strong>Consistency</strong>: Eventual consistency for metadata with strong consistency for file operations</li>
<li><strong>Availability</strong>: Multi-region deployment with data replication</li>
</ul>
<h3 id="Technical-Deep-Dives"><a href="#Technical-Deep-Dives" class="headerlink" title="Technical Deep Dives"></a>Technical Deep Dives</h3><ul>
<li><strong>SPI Pattern</strong>: Demonstrates extensibility and loose coupling</li>
<li><strong>Caching Strategy</strong>: Multi-level caching with proper invalidation</li>
<li><strong>Security</strong>: Authentication, authorization, and file validation</li>
<li><strong>Monitoring</strong>: Metrics, logging, and distributed tracing</li>
</ul>
<h3 id="Trade-offs-and-Decisions"><a href="#Trade-offs-and-Decisions" class="headerlink" title="Trade-offs and Decisions"></a>Trade-offs and Decisions</h3><ul>
<li><strong>Storage Selection</strong>: Performance vs cost vs durability</li>
<li><strong>Consistency Models</strong>: CAP theorem considerations</li>
<li><strong>API Design</strong>: REST vs GraphQL vs gRPC</li>
<li><strong>Technology Choices</strong>: Java ecosystem vs alternatives</li>
</ul>
<h3 id="Production-Readiness"><a href="#Production-Readiness" class="headerlink" title="Production Readiness"></a>Production Readiness</h3><ul>
<li><strong>Operations</strong>: Deployment, monitoring, and incident response</li>
<li><strong>Performance</strong>: Benchmarking and optimization strategies</li>
<li><strong>Security</strong>: Threat modeling and security testing</li>
<li><strong>Compliance</strong>: Data protection and regulatory requirements</li>
</ul>
<p>This comprehensive design demonstrates understanding of distributed systems, software architecture patterns, and production engineering practices essential for senior engineering roles.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/13/Design-Logs-Analysis-Platform-with-ELK-Stack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/13/Design-Logs-Analysis-Platform-with-ELK-Stack/" class="post-title-link" itemprop="url">Design Logs Analysis Platform with ELK Stack</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-13 14:44:17 / Modified: 14:50:49" itemprop="dateCreated datePublished" datetime="2025-06-13T14:44:17+08:00">2025-06-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system-design/" itemprop="url" rel="index"><span itemprop="name">system-design</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Platform-Architecture-Overview"><a href="#Platform-Architecture-Overview" class="headerlink" title="Platform Architecture Overview"></a>Platform Architecture Overview</h2><p>A logs analysis platform is the backbone of modern observability, enabling organizations to collect, process, store, and analyze massive volumes of log data from distributed systems. This comprehensive guide covers the end-to-end design of a scalable, fault-tolerant logs analysis platform that not only helps with troubleshooting but also enables predictive fault detection.</p>
<h3 id="High-Level-Architecture"><a href="#High-Level-Architecture" class="headerlink" title="High-Level Architecture"></a>High-Level Architecture</h3><pre>
<code class="mermaid">
graph TB
subgraph &quot;Data Sources&quot;
    A[Application Logs]
    B[System Logs]
    C[Security Logs]
    D[Infrastructure Logs]
    E[Database Logs]
end

subgraph &quot;Collection Layer&quot;
    F[Filebeat]
    G[Metricbeat]
    H[Winlogbeat]
    I[Custom Beats]
end

subgraph &quot;Message Queue&quot;
    J[Kafka&#x2F;Redis]
end

subgraph &quot;Processing Layer&quot;
    K[Logstash]
    L[Elasticsearch Ingest Pipelines]
end

subgraph &quot;Storage Layer&quot;
    M[Elasticsearch Cluster]
    N[Cold Storage S3&#x2F;HDFS]
end

subgraph &quot;Analytics &amp; Visualization&quot;
    O[Kibana]
    P[Grafana]
    Q[Custom Dashboards]
end

subgraph &quot;AI&#x2F;ML Layer&quot;
    R[Elasticsearch ML]
    S[External ML Services]
end

A --&gt; F
B --&gt; G
C --&gt; H
D --&gt; I
E --&gt; F

F --&gt; J
G --&gt; J
H --&gt; J
I --&gt; J

J --&gt; K
J --&gt; L

K --&gt; M
L --&gt; M

M --&gt; N
M --&gt; O
M --&gt; P
M --&gt; R

R --&gt; S
O --&gt; Q
</code>
</pre>

<p><strong>Interview Insight</strong>: <em>“When designing log platforms, interviewers often ask about handling different log formats and volumes. Emphasize the importance of a flexible ingestion layer and proper data modeling from day one.”</em></p>
<h2 id="Data-Collection-Layer"><a href="#Data-Collection-Layer" class="headerlink" title="Data Collection Layer"></a>Data Collection Layer</h2><h3 id="Log-Sources-Classification"><a href="#Log-Sources-Classification" class="headerlink" title="Log Sources Classification"></a>Log Sources Classification</h3><h4 id="1-Application-Logs"><a href="#1-Application-Logs" class="headerlink" title="1. Application Logs"></a>1. Application Logs</h4><ul>
<li><strong>Structured Logs</strong>: JSON, XML formatted logs</li>
<li><strong>Semi-structured</strong>: Key-value pairs, custom formats</li>
<li><strong>Unstructured</strong>: Plain text, error dumps</li>
</ul>
<h4 id="2-Infrastructure-Logs"><a href="#2-Infrastructure-Logs" class="headerlink" title="2. Infrastructure Logs"></a>2. Infrastructure Logs</h4><ul>
<li>Container logs (Docker, Kubernetes)</li>
<li>Load balancer logs (Nginx, HAProxy)</li>
<li>Web server logs (Apache, IIS)</li>
<li>Network device logs</li>
</ul>
<h4 id="3-System-Logs"><a href="#3-System-Logs" class="headerlink" title="3. System Logs"></a>3. System Logs</h4><ul>
<li>Operating system logs (syslog, Windows Event Log)</li>
<li>Authentication logs</li>
<li>Kernel logs</li>
</ul>
<h3 id="Collection-Strategy-with-Beats"><a href="#Collection-Strategy-with-Beats" class="headerlink" title="Collection Strategy with Beats"></a>Collection Strategy with Beats</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Example Filebeat Configuration</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/app/*.log</span></span><br><span class="line">  <span class="attr">fields:</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">web-app</span></span><br><span class="line">    <span class="attr">environment:</span> <span class="string">production</span></span><br><span class="line">  <span class="attr">multiline.pattern:</span> <span class="string">&#x27;^[0-9]&#123;4&#125;-[0-9]&#123;2&#125;-[0-9]&#123;2&#125;&#x27;</span></span><br><span class="line">  <span class="attr">multiline.negate:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">multiline.match:</span> <span class="string">after</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">container</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;/var/lib/docker/containers/*/*.log&#x27;</span></span><br><span class="line">  <span class="attr">processors:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">add_kubernetes_metadata:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">$&#123;NODE_NAME&#125;</span></span><br><span class="line">      <span class="attr">matchers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">logs_path:</span></span><br><span class="line">          <span class="attr">logs_path:</span> <span class="string">&quot;/var/lib/docker/containers&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.kafka:</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;kafka1:9092&quot;</span>, <span class="string">&quot;kafka2:9092&quot;</span>, <span class="string">&quot;kafka3:9092&quot;</span>]</span><br><span class="line">  <span class="attr">topic:</span> <span class="string">&#x27;logs-%&#123;[fields.environment]&#125;&#x27;</span></span><br><span class="line">  <span class="attr">partition.round_robin:</span></span><br><span class="line">    <span class="attr">reachable_only:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“Discuss the trade-offs between direct shipping to Elasticsearch vs. using a message queue. Kafka provides better reliability and backpressure handling, especially important for high-volume environments.”</em></p>
<h2 id="Data-Processing-and-Storage"><a href="#Data-Processing-and-Storage" class="headerlink" title="Data Processing and Storage"></a>Data Processing and Storage</h2><h3 id="Logstash-Processing-Pipeline"><a href="#Logstash-Processing-Pipeline" class="headerlink" title="Logstash Processing Pipeline"></a>Logstash Processing Pipeline</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Logstash Configuration Example</span></span><br><span class="line">input &#123;</span><br><span class="line">  kafka &#123;</span><br><span class="line">    bootstrap_servers =&gt; <span class="string">&quot;kafka1:9092,kafka2:9092&quot;</span></span><br><span class="line">    topics =&gt; [<span class="string">&quot;logs-production&quot;</span>, <span class="string">&quot;logs-staging&quot;</span>]</span><br><span class="line">    codec =&gt; json</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  <span class="comment"># Parse application logs</span></span><br><span class="line">  <span class="keyword">if</span> [fields][service] == <span class="string">&quot;web-app&quot;</span> &#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">      match =&gt; &#123; </span><br><span class="line">        <span class="string">&quot;message&quot;</span> =&gt; <span class="string">&quot;%&#123;TIMESTAMP_ISO8601:timestamp&#125; \[%&#123;LOGLEVEL:level&#125;\] %&#123;DATA:logger&#125; - %&#123;GREEDYDATA:log_message&#125;&quot;</span> </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    date &#123;</span><br><span class="line">      match =&gt; [ <span class="string">&quot;timestamp&quot;</span>, <span class="string">&quot;ISO8601&quot;</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Extract error patterns for ML</span></span><br><span class="line">    <span class="keyword">if</span> [level] == <span class="string">&quot;ERROR&quot;</span> &#123;</span><br><span class="line">      mutate &#123;</span><br><span class="line">        add_tag =&gt; [<span class="string">&quot;error&quot;</span>, <span class="string">&quot;needs_analysis&quot;</span>]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Enrich with GeoIP for web logs</span></span><br><span class="line">  <span class="keyword">if</span> [fields][log_type] == <span class="string">&quot;access&quot;</span> &#123;</span><br><span class="line">    geoip &#123;</span><br><span class="line">      source =&gt; <span class="string">&quot;client_ip&quot;</span></span><br><span class="line">      target =&gt; <span class="string">&quot;geoip&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Remove sensitive data</span></span><br><span class="line">  mutate &#123;</span><br><span class="line">    remove_field =&gt; [<span class="string">&quot;password&quot;</span>, <span class="string">&quot;credit_card&quot;</span>, <span class="string">&quot;ssn&quot;</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [<span class="string">&quot;es-node1:9200&quot;</span>, <span class="string">&quot;es-node2:9200&quot;</span>, <span class="string">&quot;es-node3:9200&quot;</span>]</span><br><span class="line">    index =&gt; <span class="string">&quot;logs-%&#123;[fields][service]&#125;-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class="line">    template_name =&gt; <span class="string">&quot;logs&quot;</span></span><br><span class="line">    template =&gt; <span class="string">&quot;/etc/logstash/templates/logs-template.json&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Elasticsearch-Index-Strategy"><a href="#Elasticsearch-Index-Strategy" class="headerlink" title="Elasticsearch Index Strategy"></a>Elasticsearch Index Strategy</h3><h4 id="Index-Lifecycle-Management-ILM"><a href="#Index-Lifecycle-Management-ILM" class="headerlink" title="Index Lifecycle Management (ILM)"></a>Index Lifecycle Management (ILM)</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;policy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;phases&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;hot&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;rollover&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;max_size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10GB&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;max_age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1d&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;set_priority&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;priority&quot;</span><span class="punctuation">:</span> <span class="number">100</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;warm&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;min_age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2d&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;allocate&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;forcemerge&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;max_num_segments&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;set_priority&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;priority&quot;</span><span class="punctuation">:</span> <span class="number">50</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;cold&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;min_age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30d&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;allocate&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;require&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;box_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cold&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;set_priority&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;priority&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;delete&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;min_age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;90d&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“Index lifecycle management is crucial for cost control. Explain how you’d balance search performance with storage costs, and discuss the trade-offs of different retention policies.”</em></p>
<h2 id="Search-and-Analytics"><a href="#Search-and-Analytics" class="headerlink" title="Search and Analytics"></a>Search and Analytics</h2><h3 id="Query-Optimization-Strategies"><a href="#Query-Optimization-Strategies" class="headerlink" title="Query Optimization Strategies"></a>Query Optimization Strategies</h3><h4 id="1-Efficient-Query-Patterns"><a href="#1-Efficient-Query-Patterns" class="headerlink" title="1. Efficient Query Patterns"></a>1. Efficient Query Patterns</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;@timestamp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="string">&quot;now-1h&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;service.keyword&quot;</span><span class="punctuation">:</span> <span class="string">&quot;payment-api&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;error&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;error_types&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;error_type.keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;error_timeline&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;date_histogram&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;@timestamp&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5m&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-Search-Templates-for-Common-Queries"><a href="#2-Search-Templates-for-Common-Queries" class="headerlink" title="2. Search Templates for Common Queries"></a>2. Search Templates for Common Queries</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;script&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;lang&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mustache&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;@timestamp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;start_time&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;lte&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;end_time&#125;&#125;&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;service.keyword&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;services&#125;&#125;&quot;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“Performance optimization questions are common. Discuss field data types (keyword vs text), query caching, and the importance of using filters over queries for better performance.”</em></p>
<h2 id="Visualization-and-Monitoring"><a href="#Visualization-and-Monitoring" class="headerlink" title="Visualization and Monitoring"></a>Visualization and Monitoring</h2><h3 id="Kibana-Dashboard-Design"><a href="#Kibana-Dashboard-Design" class="headerlink" title="Kibana Dashboard Design"></a>Kibana Dashboard Design</h3><h4 id="1-Operational-Dashboard-Structure"><a href="#1-Operational-Dashboard-Structure" class="headerlink" title="1. Operational Dashboard Structure"></a>1. Operational Dashboard Structure</h4><pre>
<code class="mermaid">
graph LR
subgraph &quot;Executive Dashboard&quot;
    A[System Health Overview]
    B[SLA Metrics]
    C[Cost Analytics]
end

subgraph &quot;Operational Dashboard&quot;
    D[Error Rate Trends]
    E[Service Performance]
    F[Infrastructure Metrics]
end

subgraph &quot;Troubleshooting Dashboard&quot;
    G[Error Investigation]
    H[Trace Analysis]
    I[Log Deep Dive]
end

A --&gt; D
D --&gt; G
B --&gt; E
E --&gt; H
C --&gt; F
F --&gt; I
</code>
</pre>

<h4 id="2-Sample-Kibana-Visualization-Config"><a href="#2-Sample-Kibana-Visualization-Config" class="headerlink" title="2. Sample Kibana Visualization Config"></a>2. Sample Kibana Visualization Config</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;visualization&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Error Rate by Service&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;line&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;seriesParams&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Error Rate&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;drawLinesBetweenPoints&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;showCircles&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;categoryAxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CategoryAxis-1&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;category&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bottom&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Time&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;count&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;schema&quot;</span><span class="punctuation">:</span> <span class="string">&quot;metric&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date_histogram&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;schema&quot;</span><span class="punctuation">:</span> <span class="string">&quot;segment&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;@timestamp&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;auto&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min_doc_count&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filters&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;schema&quot;</span><span class="punctuation">:</span> <span class="string">&quot;group&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;filters&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ERROR&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Errors&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Fault-Prediction-and-Alerting"><a href="#Fault-Prediction-and-Alerting" class="headerlink" title="Fault Prediction and Alerting"></a>Fault Prediction and Alerting</h2><h3 id="Machine-Learning-Implementation"><a href="#Machine-Learning-Implementation" class="headerlink" title="Machine Learning Implementation"></a>Machine Learning Implementation</h3><h4 id="1-Anomaly-Detection-Pipeline"><a href="#1-Anomaly-Detection-Pipeline" class="headerlink" title="1. Anomaly Detection Pipeline"></a>1. Anomaly Detection Pipeline</h4><pre>
<code class="mermaid">
flowchart TD
A[Log Ingestion] --&gt; B[Feature Extraction]
B --&gt; C[Anomaly Detection Model]
C --&gt; D{Anomaly Score &gt; Threshold?}
D --&gt;|Yes| E[Generate Alert]
D --&gt;|No| F[Continue Monitoring]
E --&gt; G[Incident Management]
G --&gt; H[Root Cause Analysis]
H --&gt; I[Model Feedback]
I --&gt; C
F --&gt; A
</code>
</pre>

<h4 id="2-Elasticsearch-ML-Job-Configuration"><a href="#2-Elasticsearch-ML-Job-Configuration" class="headerlink" title="2. Elasticsearch ML Job Configuration"></a>2. Elasticsearch ML Job Configuration</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;job_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;error-rate-anomaly&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;analysis_config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bucket_span&quot;</span><span class="punctuation">:</span> <span class="string">&quot;15m&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;detectors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;detector_description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;High error rate&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;function&quot;</span><span class="punctuation">:</span> <span class="string">&quot;high_count&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;by_field_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;service.keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;detector_description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Response time anomaly&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;function&quot;</span><span class="punctuation">:</span> <span class="string">&quot;high_mean&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;field_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;response_time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;by_field_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;service.keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;influencers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;service.keyword&quot;</span><span class="punctuation">,</span> <span class="string">&quot;host.keyword&quot;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data_description&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;time_field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;@timestamp&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;model_plot_config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Alerting-Strategy"><a href="#Alerting-Strategy" class="headerlink" title="Alerting Strategy"></a>Alerting Strategy</h3><h4 id="1-Alert-Hierarchy"><a href="#1-Alert-Hierarchy" class="headerlink" title="1. Alert Hierarchy"></a>1. Alert Hierarchy</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Watcher Alert Example</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;trigger&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;schedule&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;interval&quot;:</span> <span class="string">&quot;5m&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;input&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;search&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;request&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;search_type&quot;:</span> <span class="string">&quot;query_then_fetch&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;indices&quot;:</span> [<span class="string">&quot;logs-*&quot;</span>],</span><br><span class="line">        <span class="attr">&quot;body&quot;:</span> &#123;</span><br><span class="line">          <span class="attr">&quot;query&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;bool&quot;:</span> &#123;</span><br><span class="line">              <span class="attr">&quot;filter&quot;:</span> [</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">&quot;range&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;@timestamp&quot;:</span> &#123;</span><br><span class="line">                      <span class="attr">&quot;gte&quot;:</span> <span class="string">&quot;now-5m&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">&quot;term&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;level.keyword&quot;:</span> <span class="string">&quot;ERROR&quot;</span></span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;aggs&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;error_count&quot;:</span> &#123;</span><br><span class="line">              <span class="attr">&quot;cardinality&quot;:</span> &#123;</span><br><span class="line">                <span class="attr">&quot;field&quot;:</span> <span class="string">&quot;message.keyword&quot;</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;condition&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;compare&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;ctx.payload.aggregations.error_count.value&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;gt&quot;:</span> <span class="number">10</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;actions&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;send_slack&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;webhook&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;scheme&quot;:</span> <span class="string">&quot;https&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;host&quot;:</span> <span class="string">&quot;hooks.slack.com&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;port&quot;:</span> <span class="number">443</span>,</span><br><span class="line">        <span class="attr">&quot;method&quot;:</span> <span class="string">&quot;post&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;path&quot;:</span> <span class="string">&quot;/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXXXXXX&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;body&quot;:</span> <span class="string">&quot;High error rate detected: <span class="template-variable">&#123;&#123;ctx.payload.aggregations.error_count.value&#125;&#125;</span> unique errors in the last 5 minutes&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“Discuss the difference between reactive and proactive monitoring. Explain how you’d tune alert thresholds to minimize false positives while ensuring critical issues are caught early.”</em></p>
<h2 id="Security-and-Compliance"><a href="#Security-and-Compliance" class="headerlink" title="Security and Compliance"></a>Security and Compliance</h2><h3 id="Security-Implementation"><a href="#Security-Implementation" class="headerlink" title="Security Implementation"></a>Security Implementation</h3><h4 id="1-Authentication-and-Authorization"><a href="#1-Authentication-and-Authorization" class="headerlink" title="1. Authentication and Authorization"></a>1. Authentication and Authorization</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Elasticsearch Security Configuration</span></span><br><span class="line"><span class="attr">xpack.security.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.http.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Role-based Access Control</span></span><br><span class="line"><span class="attr">roles:</span></span><br><span class="line">  <span class="attr">log_reader:</span></span><br><span class="line">    <span class="attr">cluster:</span> [<span class="string">&quot;monitor&quot;</span>]</span><br><span class="line">    <span class="attr">indices:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">names:</span> [<span class="string">&quot;logs-*&quot;</span>]</span><br><span class="line">        <span class="attr">privileges:</span> [<span class="string">&quot;read&quot;</span>, <span class="string">&quot;view_index_metadata&quot;</span>]</span><br><span class="line">        <span class="attr">field_security:</span></span><br><span class="line">          <span class="attr">grant:</span> [<span class="string">&quot;@timestamp&quot;</span>, <span class="string">&quot;level&quot;</span>, <span class="string">&quot;message&quot;</span>, <span class="string">&quot;service&quot;</span>]</span><br><span class="line">          <span class="attr">except:</span> [<span class="string">&quot;sensitive_data&quot;</span>]</span><br><span class="line">  </span><br><span class="line">  <span class="attr">log_admin:</span></span><br><span class="line">    <span class="attr">cluster:</span> [<span class="string">&quot;all&quot;</span>]</span><br><span class="line">    <span class="attr">indices:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">names:</span> [<span class="string">&quot;*&quot;</span>]</span><br><span class="line">        <span class="attr">privileges:</span> [<span class="string">&quot;all&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="2-Data-Masking-Pipeline"><a href="#2-Data-Masking-Pipeline" class="headerlink" title="2. Data Masking Pipeline"></a>2. Data Masking Pipeline</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Mask sensitive data&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;processors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;gsub&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;message&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\\b\\d&#123;4&#125;[\\s-]?\\d&#123;4&#125;[\\s-]?\\d&#123;4&#125;[\\s-]?\\d&#123;4&#125;\\b&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;replacement&quot;</span><span class="punctuation">:</span> <span class="string">&quot;****-****-****-****&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;gsub&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;message&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Z|a-z]&#123;2,&#125;\\b&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;replacement&quot;</span><span class="punctuation">:</span> <span class="string">&quot;***@***.***&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“Security questions often focus on PII handling and compliance. Be prepared to discuss GDPR implications, data retention policies, and the right to be forgotten in log systems.”</em></p>
<h2 id="Scalability-and-Performance"><a href="#Scalability-and-Performance" class="headerlink" title="Scalability and Performance"></a>Scalability and Performance</h2><h3 id="Cluster-Sizing-and-Architecture"><a href="#Cluster-Sizing-and-Architecture" class="headerlink" title="Cluster Sizing and Architecture"></a>Cluster Sizing and Architecture</h3><h4 id="1-Node-Roles-and-Allocation"><a href="#1-Node-Roles-and-Allocation" class="headerlink" title="1. Node Roles and Allocation"></a>1. Node Roles and Allocation</h4><pre>
<code class="mermaid">
graph TB
subgraph &quot;Master Nodes (3)&quot;
    M1[Master-1]
    M2[Master-2]
    M3[Master-3]
end

subgraph &quot;Hot Data Nodes (6)&quot;
    H1[Hot-1&lt;br&#x2F;&gt;High CPU&#x2F;RAM&lt;br&#x2F;&gt;SSD Storage]
    H2[Hot-2]
    H3[Hot-3]
    H4[Hot-4]
    H5[Hot-5]
    H6[Hot-6]
end

subgraph &quot;Warm Data Nodes (4)&quot;
    W1[Warm-1&lt;br&#x2F;&gt;Medium CPU&#x2F;RAM&lt;br&#x2F;&gt;HDD Storage]
    W2[Warm-2]
    W3[Warm-3]
    W4[Warm-4]
end

subgraph &quot;Cold Data Nodes (2)&quot;
    C1[Cold-1&lt;br&#x2F;&gt;Low CPU&#x2F;RAM&lt;br&#x2F;&gt;Cheap Storage]
    C2[Cold-2]
end

subgraph &quot;Coordinating Nodes (2)&quot;
    CO1[Coord-1&lt;br&#x2F;&gt;Query Processing]
    CO2[Coord-2]
end
</code>
</pre>

<h4 id="2-Performance-Optimization"><a href="#2-Performance-Optimization" class="headerlink" title="2. Performance Optimization"></a>2. Performance Optimization</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Elasticsearch Configuration for Performance</span></span><br><span class="line"><span class="attr">cluster.name:</span> <span class="string">logs-production</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">$&#123;HOSTNAME&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Memory Settings</span></span><br><span class="line"><span class="attr">bootstrap.memory_lock:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">indices.memory.index_buffer_size:</span> <span class="number">30</span><span class="string">%</span></span><br><span class="line"><span class="attr">indices.memory.min_index_buffer_size:</span> <span class="string">96mb</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Thread Pool Optimization</span></span><br><span class="line"><span class="attr">thread_pool.write.queue_size:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">thread_pool.search.queue_size:</span> <span class="number">1000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Index Settings for High Volume</span></span><br><span class="line"><span class="attr">index.refresh_interval:</span> <span class="string">30s</span></span><br><span class="line"><span class="attr">index.number_of_shards:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">index.number_of_replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">index.translog.flush_threshold_size:</span> <span class="string">1gb</span></span><br></pre></td></tr></table></figure>

<h3 id="Capacity-Planning-Model"><a href="#Capacity-Planning-Model" class="headerlink" title="Capacity Planning Model"></a>Capacity Planning Model</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Capacity Planning Calculator</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_storage_requirements</span>(<span class="params"></span></span><br><span class="line"><span class="params">    daily_log_volume_gb,</span></span><br><span class="line"><span class="params">    retention_days,</span></span><br><span class="line"><span class="params">    replication_factor,</span></span><br><span class="line"><span class="params">    compression_ratio=<span class="number">0.7</span></span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    raw_storage = daily_log_volume_gb * retention_days</span><br><span class="line">    with_replication = raw_storage * (<span class="number">1</span> + replication_factor)</span><br><span class="line">    compressed_storage = with_replication * compression_ratio</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Add 20% buffer for operations</span></span><br><span class="line">    total_storage = compressed_storage * <span class="number">1.2</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;raw_daily&quot;</span>: daily_log_volume_gb,</span><br><span class="line">        <span class="string">&quot;total_compressed&quot;</span>: compressed_storage,</span><br><span class="line">        <span class="string">&quot;recommended_capacity&quot;</span>: total_storage,</span><br><span class="line">        <span class="string">&quot;hot_tier&quot;</span>: total_storage * <span class="number">0.3</span>,  <span class="comment"># 30% in hot</span></span><br><span class="line">        <span class="string">&quot;warm_tier&quot;</span>: total_storage * <span class="number">0.5</span>,  <span class="comment"># 50% in warm</span></span><br><span class="line">        <span class="string">&quot;cold_tier&quot;</span>: total_storage * <span class="number">0.2</span>   <span class="comment"># 20% in cold</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example calculation</span></span><br><span class="line">requirements = calculate_storage_requirements(</span><br><span class="line">    daily_log_volume_gb=<span class="number">500</span>,</span><br><span class="line">    retention_days=<span class="number">90</span>,</span><br><span class="line">    replication_factor=<span class="number">1</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“Capacity planning is a critical skill. Discuss how you’d model growth, handle traffic spikes, and plan for different data tiers. Include both storage and compute considerations.”</em></p>
<h2 id="Implementation-Roadmap"><a href="#Implementation-Roadmap" class="headerlink" title="Implementation Roadmap"></a>Implementation Roadmap</h2><h3 id="Phase-wise-Implementation"><a href="#Phase-wise-Implementation" class="headerlink" title="Phase-wise Implementation"></a>Phase-wise Implementation</h3><pre>
<code class="mermaid">
gantt
title Logs Analysis Platform Implementation
dateFormat  YYYY-MM-DD
section Phase 1: Foundation
Infrastructure Setup           :done,    phase1a, 2024-01-01, 2024-01-15
Basic ELK Stack Deployment    :done,    phase1b, 2024-01-15, 2024-01-30
Initial Log Collection        :done,    phase1c, 2024-01-30, 2024-02-15

section Phase 2: Core Features
Advanced Processing           :active,  phase2a, 2024-02-15, 2024-03-01
Security Implementation       :         phase2b, 2024-03-01, 2024-03-15
Basic Dashboards             :         phase2c, 2024-03-15, 2024-03-30

section Phase 3: Intelligence
ML&#x2F;Anomaly Detection         :         phase3a, 2024-03-30, 2024-04-15
Advanced Alerting            :         phase3b, 2024-04-15, 2024-04-30
Predictive Analytics         :         phase3c, 2024-04-30, 2024-05-15

section Phase 4: Optimization
Performance Tuning           :         phase4a, 2024-05-15, 2024-05-30
Cost Optimization            :         phase4b, 2024-05-30, 2024-06-15
Documentation &amp; Training     :         phase4c, 2024-06-15, 2024-06-30
</code>
</pre>

<h3 id="Migration-Strategy"><a href="#Migration-Strategy" class="headerlink" title="Migration Strategy"></a>Migration Strategy</h3><h4 id="1-Parallel-Run-Approach"><a href="#1-Parallel-Run-Approach" class="headerlink" title="1. Parallel Run Approach"></a>1. Parallel Run Approach</h4><pre>
<code class="mermaid">
sequenceDiagram
participant Legacy as Legacy System
participant New as New ELK Platform
participant Apps as Applications
participant Ops as Operations Team

Note over Legacy, Ops: Phase 1: Parallel Ingestion
Apps-&gt;&gt;Legacy: Continue logging
Apps-&gt;&gt;New: Start dual logging
New-&gt;&gt;Ops: Validation reports

Note over Legacy, Ops: Phase 2: Gradual Migration
Apps-&gt;&gt;Legacy: Reduced logging
Apps-&gt;&gt;New: Primary logging
New-&gt;&gt;Ops: Performance metrics

Note over Legacy, Ops: Phase 3: Full Cutover
Apps-&gt;&gt;New: All logging
Legacy-&gt;&gt;New: Historical data migration
New-&gt;&gt;Ops: Full operational control
</code>
</pre>

<h2 id="Operational-Best-Practices"><a href="#Operational-Best-Practices" class="headerlink" title="Operational Best Practices"></a>Operational Best Practices</h2><h3 id="Monitoring-and-Maintenance"><a href="#Monitoring-and-Maintenance" class="headerlink" title="Monitoring and Maintenance"></a>Monitoring and Maintenance</h3><h4 id="1-Platform-Health-Monitoring"><a href="#1-Platform-Health-Monitoring" class="headerlink" title="1. Platform Health Monitoring"></a>1. Platform Health Monitoring</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Metricbeat Configuration for ELK Monitoring</span></span><br><span class="line"><span class="attr">metricbeat.modules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">module:</span> <span class="string">elasticsearch</span></span><br><span class="line">  <span class="attr">metricsets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">node</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">node_stats</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cluster_stats</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">index</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">index_recovery</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">index_summary</span></span><br><span class="line">  <span class="attr">period:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;http://localhost:9200&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">module:</span> <span class="string">kibana</span></span><br><span class="line">  <span class="attr">metricsets:</span> [<span class="string">&quot;status&quot;</span>]</span><br><span class="line">  <span class="attr">period:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;localhost:5601&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">module:</span> <span class="string">logstash</span></span><br><span class="line">  <span class="attr">metricsets:</span> [<span class="string">&quot;node&quot;</span>, <span class="string">&quot;node_stats&quot;</span>]</span><br><span class="line">  <span class="attr">period:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;localhost:9600&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="2-Operational-Runbooks"><a href="#2-Operational-Runbooks" class="headerlink" title="2. Operational Runbooks"></a>2. Operational Runbooks</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">## Incident Response Runbook</span></span><br><span class="line"></span><br><span class="line"><span class="section">### High CPU Usage on Elasticsearch Nodes</span></span><br><span class="line"><span class="bullet">1.</span> Check query patterns in slow log</span><br><span class="line"><span class="bullet">2.</span> Identify expensive aggregations</span><br><span class="line"><span class="bullet">3.</span> Review recent index changes</span><br><span class="line"><span class="bullet">4.</span> Scale horizontally if needed</span><br><span class="line"></span><br><span class="line"><span class="section">### High Memory Usage</span></span><br><span class="line"><span class="bullet">1.</span> Check field data cache size</span><br><span class="line"><span class="bullet">2.</span> Review mapping for analyzed fields</span><br><span class="line"><span class="bullet">3.</span> Implement circuit breakers</span><br><span class="line"><span class="bullet">4.</span> Consider node memory increase</span><br><span class="line"></span><br><span class="line"><span class="section">### Disk Space Issues</span></span><br><span class="line"><span class="bullet">1.</span> Check ILM policy execution</span><br><span class="line"><span class="bullet">2.</span> Force merge old indices</span><br><span class="line"><span class="bullet">3.</span> Move indices to cold tier</span><br><span class="line"><span class="bullet">4.</span> Delete unnecessary indices</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“Operations questions test your real-world experience. Discuss common failure scenarios, monitoring strategies, and how you’d handle a production outage with logs being critical for troubleshooting.”</em></p>
<h3 id="Data-Quality-and-Governance"><a href="#Data-Quality-and-Governance" class="headerlink" title="Data Quality and Governance"></a>Data Quality and Governance</h3><h4 id="1-Log-Quality-Metrics"><a href="#1-Log-Quality-Metrics" class="headerlink" title="1. Log Quality Metrics"></a>1. Log Quality Metrics</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;quality_checks&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;completeness&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;missing_timestamp&quot;</span><span class="punctuation">:</span> <span class="number">0.01</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;missing_service_tag&quot;</span><span class="punctuation">:</span> <span class="number">0.05</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;empty_messages&quot;</span><span class="punctuation">:</span> <span class="number">0.02</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;consistency&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;format_compliance&quot;</span><span class="punctuation">:</span> <span class="number">0.95</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;schema_violations&quot;</span><span class="punctuation">:</span> <span class="number">0.03</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timeliness&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;ingestion_delay_p95&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30s&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;processing_delay_p95&quot;</span><span class="punctuation">:</span> <span class="string">&quot;60s&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-Cost-Optimization-Strategies"><a href="#2-Cost-Optimization-Strategies" class="headerlink" title="2. Cost Optimization Strategies"></a>2. Cost Optimization Strategies</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cost Optimization Analysis</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">analyze_index_costs</span>(<span class="params">indices_stats</span>):</span><br><span class="line">    cost_analysis = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> index, stats <span class="keyword">in</span> indices_stats.items():</span><br><span class="line">        storage_gb = stats[<span class="string">&#x27;store_size_gb&#x27;</span>]</span><br><span class="line">        daily_queries = stats[<span class="string">&#x27;search_count&#x27;</span>] / stats[<span class="string">&#x27;age_days&#x27;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Calculate cost per query</span></span><br><span class="line">        storage_cost = storage_gb * <span class="number">0.023</span>  <span class="comment"># AWS EBS cost</span></span><br><span class="line">        compute_cost = daily_queries * <span class="number">0.0001</span>  <span class="comment"># Estimated compute per query</span></span><br><span class="line">        </span><br><span class="line">        cost_analysis[index] = &#123;</span><br><span class="line">            <span class="string">&#x27;storage_cost&#x27;</span>: storage_cost,</span><br><span class="line">            <span class="string">&#x27;compute_cost&#x27;</span>: compute_cost,</span><br><span class="line">            <span class="string">&#x27;cost_per_query&#x27;</span>: (storage_cost + compute_cost) / <span class="built_in">max</span>(daily_queries, <span class="number">1</span>),</span><br><span class="line">            <span class="string">&#x27;recommendation&#x27;</span>: get_tier_recommendation(storage_gb, daily_queries)</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> cost_analysis</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_tier_recommendation</span>(<span class="params">storage_gb, daily_queries</span>):</span><br><span class="line">    <span class="keyword">if</span> daily_queries &gt; <span class="number">100</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hot&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> daily_queries &gt; <span class="number">10</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;warm&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;cold&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>This comprehensive logs analysis platform design provides a robust foundation for enterprise-scale log management, combining the power of the ELK stack with modern best practices for scalability, security, and operational excellence. The platform enables both reactive troubleshooting and proactive fault prediction, making it an essential component of any modern DevOps toolkit.</p>
<h3 id="Key-Success-Factors"><a href="#Key-Success-Factors" class="headerlink" title="Key Success Factors"></a>Key Success Factors</h3><ol>
<li><strong>Proper Data Modeling</strong>: Design indices and mappings from the start</li>
<li><strong>Scalable Architecture</strong>: Plan for growth in both volume and complexity  </li>
<li><strong>Security First</strong>: Implement proper access controls and data protection</li>
<li><strong>Operational Excellence</strong>: Build comprehensive monitoring and alerting</li>
<li><strong>Cost Awareness</strong>: Optimize storage tiers and retention policies</li>
<li><strong>Team Training</strong>: Ensure proper adoption and utilization</li>
</ol>
<p><strong>Final Interview Insight</strong>: <em>“When discussing log platforms in interviews, emphasize the business value: faster incident resolution, proactive issue detection, and data-driven decision making. Technical excellence should always tie back to business outcomes.”</em></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/12/Design-User-Login-System-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/12/Design-User-Login-System-Guide/" class="post-title-link" itemprop="url">Design User Login System Guide</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-12 23:47:50" itemprop="dateCreated datePublished" datetime="2025-06-12T23:47:50+08:00">2025-06-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-23 20:38:30" itemprop="dateModified" datetime="2025-06-23T20:38:30+08:00">2025-06-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system-design/" itemprop="url" rel="index"><span itemprop="name">system-design</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="System-Overview-and-Architecture"><a href="#System-Overview-and-Architecture" class="headerlink" title="System Overview and Architecture"></a>System Overview and Architecture</h2><p>A robust user login system forms the backbone of secure web applications, handling authentication (verifying user identity) and authorization (controlling access to resources). This guide presents a production-ready architecture that balances security, scalability, and maintainability.</p>
<h3 id="Core-Components-Architecture"><a href="#Core-Components-Architecture" class="headerlink" title="Core Components Architecture"></a>Core Components Architecture</h3><pre>
<code class="mermaid">
graph TB
A[User Browser] --&gt; B[UserLoginWebsite]
B --&gt; C[AuthenticationFilter]
C --&gt; D[UserLoginService]
D --&gt; E[Redis Session Store]
D --&gt; F[UserService]
D --&gt; G[PermissionService]

subgraph &quot;External Services&quot;
    F[UserService]
    G[PermissionService]
end

subgraph &quot;Session Management&quot;
    E[Redis Session Store]
    H[JWT Token Service]
end

subgraph &quot;Web Layer&quot;
    B[UserLoginWebsite]
    C[AuthenticationFilter]
end

subgraph &quot;Business Layer&quot;
    D[UserLoginService]
end
</code>
</pre>

<p><strong>Design Philosophy</strong>: The architecture follows the separation of concerns principle, with each component having a single responsibility. The web layer handles HTTP interactions, the business layer manages authentication logic, and external services provide user data and permissions.</p>
<h2 id="UserLoginWebsite-Component"><a href="#UserLoginWebsite-Component" class="headerlink" title="UserLoginWebsite Component"></a>UserLoginWebsite Component</h2><p>The UserLoginWebsite serves as the presentation layer, providing both user-facing login interfaces and administrative user management capabilities.</p>
<h3 id="Key-Responsibilities"><a href="#Key-Responsibilities" class="headerlink" title="Key Responsibilities"></a>Key Responsibilities</h3><ul>
<li><strong>User Interface</strong>: Render login forms, dashboard, and user profile pages</li>
<li><strong>Admin Interface</strong>: Provide user management tools for administrators</li>
<li><strong>Session Handling</strong>: Manage cookies and client-side session state</li>
<li><strong>Security Headers</strong>: Implement CSRF protection and secure cookie settings</li>
</ul>
<h3 id="Implementation-Example"><a href="#Implementation-Example" class="headerlink" title="Implementation Example"></a>Implementation Example</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/auth&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserLoginService userLoginService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;LoginResponse&gt; <span class="title function_">login</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestBody</span> LoginRequest request,</span></span><br><span class="line"><span class="params">            HttpServletResponse response)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">LoginResult</span> <span class="variable">result</span> <span class="operator">=</span> userLoginService.authenticate(</span><br><span class="line">                request.getUsername(), </span><br><span class="line">                request.getPassword()</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Set secure cookie with session ID</span></span><br><span class="line">            <span class="type">Cookie</span> <span class="variable">sessionCookie</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cookie</span>(<span class="string">&quot;JSESSIONID&quot;</span>, result.getSessionId());</span><br><span class="line">            sessionCookie.setHttpOnly(<span class="literal">true</span>);</span><br><span class="line">            sessionCookie.setSecure(<span class="literal">true</span>);</span><br><span class="line">            sessionCookie.setPath(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">            sessionCookie.setMaxAge(<span class="number">3600</span>); <span class="comment">// 1 hour</span></span><br><span class="line">            response.addCookie(sessionCookie);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.ok(<span class="keyword">new</span> <span class="title class_">LoginResponse</span>(result.getUser()));</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.status(HttpStatus.UNAUTHORIZED)</span><br><span class="line">                .body(<span class="keyword">new</span> <span class="title class_">LoginResponse</span>(<span class="string">&quot;Invalid credentials&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/logout&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Void&gt; <span class="title function_">logout</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sessionId</span> <span class="operator">=</span> extractSessionId(request);</span><br><span class="line">        userLoginService.logout(sessionId);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok().build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“How do you handle CSRF attacks in login systems?”</em></p>
<p><strong>Answer</strong>: Implement CSRF tokens for state-changing operations, use SameSite cookie attributes, and validate the Origin&#x2F;Referer headers. The login form should include a CSRF token that’s validated on the server side.</p>
<h2 id="UserLoginService-Component"><a href="#UserLoginService-Component" class="headerlink" title="UserLoginService Component"></a>UserLoginService Component</h2><p>The UserLoginService acts as the core business logic layer, orchestrating authentication workflows and session management.</p>
<h3 id="Design-Philosophy"><a href="#Design-Philosophy" class="headerlink" title="Design Philosophy"></a>Design Philosophy</h3><p>The service follows the facade pattern, providing a unified interface for complex authentication operations while delegating specific tasks to specialized components.</p>
<h3 id="Core-Operations-Flow"><a href="#Core-Operations-Flow" class="headerlink" title="Core Operations Flow"></a>Core Operations Flow</h3><pre>
<code class="mermaid">
sequenceDiagram
participant C as Client
participant ULS as UserLoginService
participant US as UserService
participant PS as PermissionService
participant R as Redis

C-&gt;&gt;ULS: authenticate(username, password)
ULS-&gt;&gt;US: validateCredentials(username, password)
US--&gt;&gt;ULS: User object
ULS-&gt;&gt;PS: getUserPermissions(userId)
PS--&gt;&gt;ULS: Permissions list
ULS-&gt;&gt;R: storeSession(sessionId, userInfo)
R--&gt;&gt;ULS: confirmation
ULS--&gt;&gt;C: LoginResult with sessionId
</code>
</pre>

<h3 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserLoginService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PermissionService permissionService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtTokenService jwtTokenService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SESSION_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;user:session:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SESSION_TIMEOUT</span> <span class="operator">=</span> <span class="number">3600</span>; <span class="comment">// 1 hour</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> LoginResult <span class="title function_">authenticate</span><span class="params">(String username, String password)</span> &#123;</span><br><span class="line">        <span class="comment">// Step 1: Validate credentials</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.validateCredentials(username, password);</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthenticationException</span>(<span class="string">&quot;Invalid credentials&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Step 2: Load user permissions</span></span><br><span class="line">        List&lt;Permission&gt; permissions = permissionService.getUserPermissions(user.getId());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Step 3: Create session</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">sessionId</span> <span class="operator">=</span> generateSessionId();</span><br><span class="line">        <span class="type">UserSession</span> <span class="variable">session</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserSession</span>(user, permissions, System.currentTimeMillis());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Step 4: Store session in Redis</span></span><br><span class="line">        redisTemplate.opsForValue().set(</span><br><span class="line">            SESSION_PREFIX + sessionId, </span><br><span class="line">            session, </span><br><span class="line">            SESSION_TIMEOUT, </span><br><span class="line">            TimeUnit.SECONDS</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Step 5: Generate JWT token (optional)</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">jwtToken</span> <span class="operator">=</span> jwtTokenService.generateToken(user, permissions);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LoginResult</span>(sessionId, user, jwtToken);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logout</span><span class="params">(String sessionId)</span> &#123;</span><br><span class="line">        redisTemplate.delete(SESSION_PREFIX + sessionId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> UserSession <span class="title function_">getSession</span><span class="params">(String sessionId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (UserSession) redisTemplate.opsForValue().get(SESSION_PREFIX + sessionId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refreshSession</span><span class="params">(String sessionId)</span> &#123;</span><br><span class="line">        redisTemplate.expire(SESSION_PREFIX + sessionId, SESSION_TIMEOUT, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">generateSessionId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> UUID.randomUUID().toString().replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“How do you handle concurrent login attempts?”</em></p>
<p><strong>Answer</strong>: Implement rate limiting using Redis counters, track failed login attempts per IP&#x2F;username, and use exponential backoff. Consider implementing account lockout policies and CAPTCHA after multiple failed attempts.</p>
<h2 id="Redis-Session-Management"><a href="#Redis-Session-Management" class="headerlink" title="Redis Session Management"></a>Redis Session Management</h2><p>Redis serves as the distributed session store, providing fast access to session data across multiple application instances.</p>
<h3 id="Session-Storage-Strategy"><a href="#Session-Storage-Strategy" class="headerlink" title="Session Storage Strategy"></a>Session Storage Strategy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisSessionManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">USER_SESSION_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;session:user:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">USER_PERMISSIONS_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;session:permissions:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_TIMEOUT</span> <span class="operator">=</span> <span class="number">1800</span>; <span class="comment">// 30 minutes</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">storeUserSession</span><span class="params">(String sessionId, UserSession session)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userKey</span> <span class="operator">=</span> USER_SESSION_PREFIX + sessionId;</span><br><span class="line">        <span class="type">String</span> <span class="variable">permissionsKey</span> <span class="operator">=</span> USER_PERMISSIONS_PREFIX + sessionId;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Store user info and permissions separately for optimized access</span></span><br><span class="line">        redisTemplate.opsForHash().putAll(userKey, session.toMap());</span><br><span class="line">        redisTemplate.opsForSet().add(permissionsKey, session.getPermissions().toArray());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Set expiration</span></span><br><span class="line">        redisTemplate.expire(userKey, DEFAULT_TIMEOUT, TimeUnit.SECONDS);</span><br><span class="line">        redisTemplate.expire(permissionsKey, DEFAULT_TIMEOUT, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> UserSession <span class="title function_">getUserSession</span><span class="params">(String sessionId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userKey</span> <span class="operator">=</span> USER_SESSION_PREFIX + sessionId;</span><br><span class="line">        Map&lt;Object, Object&gt; sessionData = redisTemplate.opsForHash().entries(userKey);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (sessionData.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Refresh session timeout on access</span></span><br><span class="line">        redisTemplate.expire(userKey, DEFAULT_TIMEOUT, TimeUnit.SECONDS);</span><br><span class="line">        redisTemplate.expire(USER_PERMISSIONS_PREFIX + sessionId, DEFAULT_TIMEOUT, TimeUnit.SECONDS);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> UserSession.fromMap(sessionData);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Session-Cleanup-Strategy"><a href="#Session-Cleanup-Strategy" class="headerlink" title="Session Cleanup Strategy"></a>Session Cleanup Strategy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SessionCleanupService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 300000)</span> <span class="comment">// Every 5 minutes</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cleanupExpiredSessions</span><span class="params">()</span> &#123;</span><br><span class="line">        Set&lt;String&gt; expiredSessions = findExpiredSessions();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String sessionId : expiredSessions) &#123;</span><br><span class="line">            cleanupSession(sessionId);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        log.info(<span class="string">&quot;Cleaned up &#123;&#125; expired sessions&quot;</span>, expiredSessions.size());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">cleanupSession</span><span class="params">(String sessionId)</span> &#123;</span><br><span class="line">        redisTemplate.delete(USER_SESSION_PREFIX + sessionId);</span><br><span class="line">        redisTemplate.delete(USER_PERMISSIONS_PREFIX + sessionId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“How do you handle Redis failures in session management?”</em></p>
<p><strong>Answer</strong>: Implement fallback mechanisms like database session storage, use Redis clustering for high availability, and implement circuit breakers. Consider graceful degradation where users are redirected to re-login if session data is unavailable.</p>
<h2 id="AuthenticationFilter-Component"><a href="#AuthenticationFilter-Component" class="headerlink" title="AuthenticationFilter Component"></a>AuthenticationFilter Component</h2><p>The AuthenticationFilter acts as a security gateway, validating every HTTP request to ensure proper authentication and authorization.</p>
<h3 id="Filter-Implementation"><a href="#Filter-Implementation" class="headerlink" title="Filter Implementation"></a>Filter Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Order(1)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthenticationFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserLoginService userLoginService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PermissionService permissionService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;String&gt; EXCLUDED_PATHS = Set.of(</span><br><span class="line">        <span class="string">&quot;/auth/login&quot;</span>, <span class="string">&quot;/auth/register&quot;</span>, <span class="string">&quot;/public&quot;</span>, <span class="string">&quot;/health&quot;</span></span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, </span></span><br><span class="line"><span class="params">                        FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">httpRequest</span> <span class="operator">=</span> (HttpServletRequest) request;</span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">httpResponse</span> <span class="operator">=</span> (HttpServletResponse) response;</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">requestPath</span> <span class="operator">=</span> httpRequest.getRequestURI();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Skip authentication for excluded paths</span></span><br><span class="line">        <span class="keyword">if</span> (isExcludedPath(requestPath)) &#123;</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Extract session ID from cookie</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">sessionId</span> <span class="operator">=</span> extractSessionId(httpRequest);</span><br><span class="line">            <span class="keyword">if</span> (sessionId == <span class="literal">null</span>) &#123;</span><br><span class="line">                handleUnauthorized(httpResponse, <span class="string">&quot;No session found&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Validate session</span></span><br><span class="line">            <span class="type">UserSession</span> <span class="variable">session</span> <span class="operator">=</span> userLoginService.getSession(sessionId);</span><br><span class="line">            <span class="keyword">if</span> (session == <span class="literal">null</span> || isSessionExpired(session)) &#123;</span><br><span class="line">                handleUnauthorized(httpResponse, <span class="string">&quot;Session expired&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Check permissions for the requested resource</span></span><br><span class="line">            <span class="keyword">if</span> (!hasPermission(session, requestPath, httpRequest.getMethod())) &#123;</span><br><span class="line">                handleForbidden(httpResponse, <span class="string">&quot;Insufficient permissions&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Refresh session timeout</span></span><br><span class="line">            userLoginService.refreshSession(sessionId);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Set user context for downstream processing</span></span><br><span class="line">            SecurityContextHolder.setContext(<span class="keyword">new</span> <span class="title class_">SecurityContext</span>(session.getUser()));</span><br><span class="line">            </span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Authentication filter error&quot;</span>, e);</span><br><span class="line">            handleUnauthorized(httpResponse, <span class="string">&quot;Authentication error&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            SecurityContextHolder.clearContext();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">hasPermission</span><span class="params">(UserSession session, String path, String method)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> permissionService.checkPermission(</span><br><span class="line">            session.getUser().getId(), </span><br><span class="line">            path, </span><br><span class="line">            method</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleUnauthorized</span><span class="params">(HttpServletResponse response, String message)</span> </span><br><span class="line">            <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        response.setStatus(HttpStatus.UNAUTHORIZED.value());</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">        response.getWriter().write(<span class="string">&quot;&#123;\&quot;error\&quot;:\&quot;&quot;</span> + message + <span class="string">&quot;\&quot;&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“How do you optimize filter performance for high-traffic applications?”</em></p>
<p><strong>Answer</strong>: Cache permission checks in Redis, use efficient data structures for path matching, implement request batching for permission validation, and consider using async processing for non-blocking operations.</p>
<h2 id="JWT-Integration-Strategy"><a href="#JWT-Integration-Strategy" class="headerlink" title="JWT Integration Strategy"></a>JWT Integration Strategy</h2><p>JWT (JSON Web Tokens) can complement session-based authentication by providing stateless authentication capabilities and enabling distributed systems integration.</p>
<h3 id="When-to-Use-JWT"><a href="#When-to-Use-JWT" class="headerlink" title="When to Use JWT"></a>When to Use JWT</h3><p><strong>Use JWT when:</strong></p>
<ul>
<li>Building microservices architecture</li>
<li>Implementing single sign-on (SSO)</li>
<li>Supporting mobile applications</li>
<li>Enabling API authentication</li>
<li>Requiring stateless authentication</li>
</ul>
<p><strong>Use Sessions when:</strong></p>
<ul>
<li>Building traditional web applications</li>
<li>Requiring immediate token revocation</li>
<li>Handling sensitive operations</li>
<li>Managing complex user states</li>
</ul>
<h3 id="Hybrid-Approach-Implementation"><a href="#Hybrid-Approach-Implementation" class="headerlink" title="Hybrid Approach Implementation"></a>Hybrid Approach Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtTokenService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jwt.secret&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String jwtSecret;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jwt.expiration&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> jwtExpiration;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generateToken</span><span class="params">(User user, List&lt;Permission&gt; permissions)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; claims = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        claims.put(<span class="string">&quot;userId&quot;</span>, user.getId());</span><br><span class="line">        claims.put(<span class="string">&quot;username&quot;</span>, user.getUsername());</span><br><span class="line">        claims.put(<span class="string">&quot;permissions&quot;</span>, permissions.stream()</span><br><span class="line">            .map(Permission::getName)</span><br><span class="line">            .collect(Collectors.toList()));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> Jwts.builder()</span><br><span class="line">            .setClaims(claims)</span><br><span class="line">            .setSubject(user.getUsername())</span><br><span class="line">            .setIssuedAt(<span class="keyword">new</span> <span class="title class_">Date</span>())</span><br><span class="line">            .setExpiration(<span class="keyword">new</span> <span class="title class_">Date</span>(System.currentTimeMillis() + jwtExpiration * <span class="number">1000</span>))</span><br><span class="line">            .signWith(SignatureAlgorithm.HS256, jwtSecret)</span><br><span class="line">            .compact();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Claims <span class="title function_">validateToken</span><span class="params">(String token)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Jwts.parser()</span><br><span class="line">                .setSigningKey(jwtSecret)</span><br><span class="line">                .parseClaimsJws(token)</span><br><span class="line">                .getBody();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JwtException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthenticationException</span>(<span class="string">&quot;Invalid JWT token&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isTokenExpired</span><span class="params">(String token)</span> &#123;</span><br><span class="line">        <span class="type">Date</span> <span class="variable">expiration</span> <span class="operator">=</span> validateToken(token).getExpiration();</span><br><span class="line">        <span class="keyword">return</span> expiration.before(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="JWT-vs-Session-Comparison"><a href="#JWT-vs-Session-Comparison" class="headerlink" title="JWT vs Session Comparison"></a>JWT vs Session Comparison</h3><table>
<thead>
<tr>
<th>Aspect</th>
<th>JWT</th>
<th>Session</th>
</tr>
</thead>
<tbody><tr>
<td><strong>State</strong></td>
<td>Stateless</td>
<td>Stateful</td>
</tr>
<tr>
<td><strong>Revocation</strong></td>
<td>Difficult</td>
<td>Immediate</td>
</tr>
<tr>
<td><strong>Scalability</strong></td>
<td>High</td>
<td>Medium</td>
</tr>
<tr>
<td><strong>Security</strong></td>
<td>Token-based</td>
<td>Server-side</td>
</tr>
<tr>
<td><strong>Complexity</strong></td>
<td>Medium</td>
<td>Low</td>
</tr>
<tr>
<td><strong>Mobile Support</strong></td>
<td>Excellent</td>
<td>Good</td>
</tr>
</tbody></table>
<p><strong>Interview Insight</strong>: <em>“How do you handle JWT token revocation?”</em></p>
<p><strong>Answer</strong>: Implement a token blacklist in Redis, use short-lived tokens with refresh mechanism, maintain a token version number in the database, and implement token rotation strategies.</p>
<h2 id="Security-Best-Practices"><a href="#Security-Best-Practices" class="headerlink" title="Security Best Practices"></a>Security Best Practices</h2><h3 id="Password-Security"><a href="#Password-Security" class="headerlink" title="Password Security"></a>Password Security</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PasswordSecurityService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">BCryptPasswordEncoder</span> <span class="variable">passwordEncoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>(<span class="number">12</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hashPassword</span><span class="params">(String plainPassword)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> passwordEncoder.encode(plainPassword);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">verifyPassword</span><span class="params">(String plainPassword, String hashedPassword)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> passwordEncoder.matches(plainPassword, hashedPassword);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isPasswordStrong</span><span class="params">(String password)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> password.length() &gt;= <span class="number">8</span> &amp;&amp;</span><br><span class="line">               password.matches(<span class="string">&quot;.*[A-Z].*&quot;</span>) &amp;&amp;</span><br><span class="line">               password.matches(<span class="string">&quot;.*[a-z].*&quot;</span>) &amp;&amp;</span><br><span class="line">               password.matches(<span class="string">&quot;.*[0-9].*&quot;</span>) &amp;&amp;</span><br><span class="line">               password.matches(<span class="string">&quot;.*[!@#$%^&amp;*()].*&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Rate-Limiting-Implementation"><a href="#Rate-Limiting-Implementation" class="headerlink" title="Rate Limiting Implementation"></a>Rate Limiting Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RateLimitingService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">RATE_LIMIT_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;rate_limit:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_ATTEMPTS</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">WINDOW_SECONDS</span> <span class="operator">=</span> <span class="number">300</span>; <span class="comment">// 5 minutes</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isRateLimited</span><span class="params">(String identifier)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RATE_LIMIT_PREFIX + identifier;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">attempts</span> <span class="operator">=</span> (Integer) redisTemplate.opsForValue().get(key);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (attempts == <span class="literal">null</span>) &#123;</span><br><span class="line">            redisTemplate.opsForValue().set(key, <span class="number">1</span>, WINDOW_SECONDS, TimeUnit.SECONDS);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (attempts &gt;= MAX_ATTEMPTS) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        redisTemplate.opsForValue().increment(key);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="User-Session-Lifecycle-Management"><a href="#User-Session-Lifecycle-Management" class="headerlink" title="User Session Lifecycle Management"></a>User Session Lifecycle Management</h2><h3 id="Session-Creation-Flow"><a href="#Session-Creation-Flow" class="headerlink" title="Session Creation Flow"></a>Session Creation Flow</h3><pre>
<code class="mermaid">
flowchart TD
A[User Login Request] --&gt; B{Validate Credentials}
B --&gt;|Invalid| C[Return Error]
B --&gt;|Valid| D[Load User Permissions]
D --&gt; E[Generate Session ID]
E --&gt; F[Create JWT Token]
F --&gt; G[Store Session in Redis]
G --&gt; H[Set Secure Cookie]
H --&gt; I[Return Success Response]

style A fill:#e1f5fe
style I fill:#c8e6c9
style C fill:#ffcdd2
</code>
</pre>

<h3 id="Session-Validation-Process"><a href="#Session-Validation-Process" class="headerlink" title="Session Validation Process"></a>Session Validation Process</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SessionValidator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ValidationResult <span class="title function_">validateSession</span><span class="params">(String sessionId, String requestPath)</span> &#123;</span><br><span class="line">        <span class="comment">// Step 1: Check session existence</span></span><br><span class="line">        <span class="type">UserSession</span> <span class="variable">session</span> <span class="operator">=</span> getSessionFromRedis(sessionId);</span><br><span class="line">        <span class="keyword">if</span> (session == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ValidationResult.failure(<span class="string">&quot;Session not found&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Step 2: Check session expiration</span></span><br><span class="line">        <span class="keyword">if</span> (isSessionExpired(session)) &#123;</span><br><span class="line">            cleanupSession(sessionId);</span><br><span class="line">            <span class="keyword">return</span> ValidationResult.failure(<span class="string">&quot;Session expired&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Step 3: Validate user status</span></span><br><span class="line">        <span class="keyword">if</span> (!isUserActive(session.getUser())) &#123;</span><br><span class="line">            <span class="keyword">return</span> ValidationResult.failure(<span class="string">&quot;User account disabled&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Step 4: Check resource permissions</span></span><br><span class="line">        <span class="keyword">if</span> (!hasResourcePermission(session, requestPath)) &#123;</span><br><span class="line">            <span class="keyword">return</span> ValidationResult.failure(<span class="string">&quot;Insufficient permissions&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ValidationResult.success(session);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isSessionExpired</span><span class="params">(UserSession session)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">currentTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">long</span> <span class="variable">sessionTime</span> <span class="operator">=</span> session.getLastAccessTime();</span><br><span class="line">        <span class="keyword">return</span> (currentTime - sessionTime) &gt; SESSION_TIMEOUT_MS;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Error-Handling-and-Logging"><a href="#Error-Handling-and-Logging" class="headerlink" title="Error Handling and Logging"></a>Error Handling and Logging</h2><h3 id="Comprehensive-Error-Handling"><a href="#Comprehensive-Error-Handling" class="headerlink" title="Comprehensive Error Handling"></a>Comprehensive Error Handling</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthenticationExceptionHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(AuthenticationExceptionHandler.class);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler(AuthenticationException.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;ErrorResponse&gt; <span class="title function_">handleAuthenticationException</span><span class="params">(</span></span><br><span class="line"><span class="params">            AuthenticationException e, HttpServletRequest request)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Log security event</span></span><br><span class="line">        logger.warn(<span class="string">&quot;Authentication failed for IP: &#123;&#125; - &#123;&#125;&quot;</span>, </span><br><span class="line">                   getClientIpAddress(request), e.getMessage());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.UNAUTHORIZED)</span><br><span class="line">                .body(<span class="keyword">new</span> <span class="title class_">ErrorResponse</span>(<span class="string">&quot;Authentication failed&quot;</span>, <span class="string">&quot;AUTH_001&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler(AuthorizationException.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;ErrorResponse&gt; <span class="title function_">handleAuthorizationException</span><span class="params">(</span></span><br><span class="line"><span class="params">            AuthorizationException e, HttpServletRequest request)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Log authorization event</span></span><br><span class="line">        logger.warn(<span class="string">&quot;Authorization failed for user: &#123;&#125; on resource: &#123;&#125;&quot;</span>, </span><br><span class="line">                   getCurrentUser(), request.getRequestURI());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.FORBIDDEN)</span><br><span class="line">                .body(<span class="keyword">new</span> <span class="title class_">ErrorResponse</span>(<span class="string">&quot;Access denied&quot;</span>, <span class="string">&quot;AUTH_002&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Optimization-Strategies"><a href="#Performance-Optimization-Strategies" class="headerlink" title="Performance Optimization Strategies"></a>Performance Optimization Strategies</h2><h3 id="Caching-Strategies"><a href="#Caching-Strategies" class="headerlink" title="Caching Strategies"></a>Caching Strategies</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PermissionCacheService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PERMISSION_CACHE_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;permissions:user:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CACHE_TTL</span> <span class="operator">=</span> <span class="number">600</span>; <span class="comment">// 10 minutes</span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Cacheable(value = &quot;userPermissions&quot;, key = &quot;#userId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Permission&gt; <span class="title function_">getUserPermissions</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cacheKey</span> <span class="operator">=</span> PERMISSION_CACHE_PREFIX + userId;</span><br><span class="line">        List&lt;Permission&gt; permissions = (List&lt;Permission&gt;) redisTemplate.opsForValue().get(cacheKey);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (permissions == <span class="literal">null</span>) &#123;</span><br><span class="line">            permissions = permissionService.loadUserPermissions(userId);</span><br><span class="line">            redisTemplate.opsForValue().set(cacheKey, permissions, CACHE_TTL, TimeUnit.SECONDS);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> permissions;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@CacheEvict(value = &quot;userPermissions&quot;, key = &quot;#userId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invalidateUserPermissions</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">        redisTemplate.delete(PERMISSION_CACHE_PREFIX + userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Monitoring-and-Alerting"><a href="#Monitoring-and-Alerting" class="headerlink" title="Monitoring and Alerting"></a>Monitoring and Alerting</h2><h3 id="Security-Metrics"><a href="#Security-Metrics" class="headerlink" title="Security Metrics"></a>Security Metrics</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityMetricsCollector</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter loginAttempts;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter loginFailures;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Timer authenticationTime;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SecurityMetricsCollector</span><span class="params">(MeterRegistry meterRegistry)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.meterRegistry = meterRegistry;</span><br><span class="line">        <span class="built_in">this</span>.loginAttempts = Counter.builder(<span class="string">&quot;login.attempts&quot;</span>)</span><br><span class="line">                .description(<span class="string">&quot;Total login attempts&quot;</span>)</span><br><span class="line">                .register(meterRegistry);</span><br><span class="line">        <span class="built_in">this</span>.loginFailures = Counter.builder(<span class="string">&quot;login.failures&quot;</span>)</span><br><span class="line">                .description(<span class="string">&quot;Failed login attempts&quot;</span>)</span><br><span class="line">                .register(meterRegistry);</span><br><span class="line">        <span class="built_in">this</span>.authenticationTime = Timer.builder(<span class="string">&quot;authentication.time&quot;</span>)</span><br><span class="line">                .description(<span class="string">&quot;Authentication processing time&quot;</span>)</span><br><span class="line">                .register(meterRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordLoginAttempt</span><span class="params">()</span> &#123;</span><br><span class="line">        loginAttempts.increment();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordLoginFailure</span><span class="params">(String reason)</span> &#123;</span><br><span class="line">        loginFailures.increment(Tags.of(<span class="string">&quot;reason&quot;</span>, reason));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Timer.Sample <span class="title function_">startAuthenticationTimer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Timer.start(meterRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Production-Deployment-Considerations"><a href="#Production-Deployment-Considerations" class="headerlink" title="Production Deployment Considerations"></a>Production Deployment Considerations</h2><h3 id="High-Availability-Setup"><a href="#High-Availability-Setup" class="headerlink" title="High Availability Setup"></a>High Availability Setup</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Redis Cluster Configuration</span></span><br><span class="line"><span class="attr">redis:</span></span><br><span class="line">  <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">nodes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-node1:6379</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-node2:6379</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-node3:6379</span></span><br><span class="line">    <span class="attr">max-redirects:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="string">2000ms</span></span><br><span class="line">  <span class="attr">lettuce:</span></span><br><span class="line">    <span class="attr">pool:</span></span><br><span class="line">      <span class="attr">max-active:</span> <span class="number">8</span></span><br><span class="line">      <span class="attr">max-idle:</span> <span class="number">8</span></span><br><span class="line">      <span class="attr">min-idle:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h3 id="Load-Balancer-Configuration"><a href="#Load-Balancer-Configuration" class="headerlink" title="Load Balancer Configuration"></a>Load Balancer Configuration</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> auth_backend &#123;</span><br><span class="line">    <span class="attribute">server</span> auth-service-<span class="number">1</span>:<span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">server</span> auth-service-<span class="number">2</span>:<span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">server</span> auth-service-<span class="number">3</span>:<span class="number">8080</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">server_name</span> auth.example.com;</span><br><span class="line">    </span><br><span class="line">    <span class="section">location</span> /auth &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://auth_backend;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Testing-Strategies"><a href="#Testing-Strategies" class="headerlink" title="Testing Strategies"></a>Testing Strategies</h2><h3 id="Integration-Testing"><a href="#Integration-Testing" class="headerlink" title="Integration Testing"></a>Integration Testing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@AutoConfigureTestDatabase</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserLoginServiceIntegrationTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserLoginService userLoginService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@MockBean</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldAuthenticateValidUser</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Given</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">mockUser</span> <span class="operator">=</span> createMockUser();</span><br><span class="line">        <span class="keyword">when</span>(userService.validateCredentials(<span class="string">&quot;testuser&quot;</span>, <span class="string">&quot;password&quot;</span>))</span><br><span class="line">            .thenReturn(mockUser);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When</span></span><br><span class="line">        <span class="type">LoginResult</span> <span class="variable">result</span> <span class="operator">=</span> userLoginService.authenticate(<span class="string">&quot;testuser&quot;</span>, <span class="string">&quot;password&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Then</span></span><br><span class="line">        assertThat(result.getSessionId()).isNotNull();</span><br><span class="line">        assertThat(result.getUser().getUsername()).isEqualTo(<span class="string">&quot;testuser&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldRejectInvalidCredentials</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Given</span></span><br><span class="line">        <span class="keyword">when</span>(userService.validateCredentials(<span class="string">&quot;testuser&quot;</span>, <span class="string">&quot;wrongpassword&quot;</span>))</span><br><span class="line">            .thenReturn(<span class="literal">null</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When &amp; Then</span></span><br><span class="line">        assertThatThrownBy(() -&gt; userLoginService.authenticate(<span class="string">&quot;testuser&quot;</span>, <span class="string">&quot;wrongpassword&quot;</span>))</span><br><span class="line">            .isInstanceOf(AuthenticationException.class)</span><br><span class="line">            .hasMessage(<span class="string">&quot;Invalid credentials&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Common-Interview-Questions-and-Answers"><a href="#Common-Interview-Questions-and-Answers" class="headerlink" title="Common Interview Questions and Answers"></a>Common Interview Questions and Answers</h2><p><strong>Q: How do you handle session fixation attacks?</strong></p>
<p><strong>A</strong>: Generate a new session ID after successful authentication, invalidate the old session, and ensure session IDs are cryptographically secure. Implement proper session lifecycle management.</p>
<p><strong>Q: What’s the difference between authentication and authorization?</strong></p>
<p><strong>A</strong>: Authentication verifies who you are (identity), while authorization determines what you can do (permissions). Authentication happens first, followed by authorization for each resource access.</p>
<p><strong>Q: How do you implement “Remember Me” functionality securely?</strong></p>
<p><strong>A</strong>: Use a separate persistent token stored in a secure cookie, implement token rotation, store tokens with expiration dates, and provide users with the ability to revoke all persistent sessions.</p>
<p><strong>Q: How do you handle distributed session management?</strong></p>
<p><strong>A</strong>: Use Redis cluster for session storage, implement sticky sessions with load balancers, or use JWT tokens for stateless authentication. Each approach has trade-offs in terms of complexity and scalability.</p>
<h2 id="External-Resources"><a href="#External-Resources" class="headerlink" title="External Resources"></a>External Resources</h2><ul>
<li><a target="_blank" rel="noopener" href="https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html">OWASP Authentication Cheat Sheet</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/">Spring Security Reference Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://redis.io/docs/manual/keyspace-notifications/">Redis Session Management Best Practices</a></li>
<li><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc8725">JWT Best Practices</a></li>
<li><a target="_blank" rel="noopener" href="https://pages.nist.gov/800-63-3/">NIST Digital Identity Guidelines</a></li>
</ul>
<p>This comprehensive guide provides a production-ready approach to implementing user login systems with proper authentication, authorization, and session management. The modular design allows for easy maintenance and scaling while maintaining security best practices.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/12/Design-Grey-Service-Router-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/12/Design-Grey-Service-Router-Guide/" class="post-title-link" itemprop="url">Design Grey Service Router Guide</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-12 22:04:26" itemprop="dateCreated datePublished" datetime="2025-06-12T22:04:26+08:00">2025-06-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-07-01 15:02:58" itemprop="dateModified" datetime="2025-07-01T15:02:58+08:00">2025-07-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system-design/" itemprop="url" rel="index"><span itemprop="name">system-design</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>A grey service router system enables controlled service version management across multi-tenant environments, allowing gradual rollouts, A&#x2F;B testing, and safe database schema migrations. This system provides the infrastructure to route requests to specific service versions based on tenant configuration while maintaining high availability and performance.</p>
<h3 id="Key-Benefits"><a href="#Key-Benefits" class="headerlink" title="Key Benefits"></a>Key Benefits</h3><ul>
<li><strong>Risk Mitigation</strong>: Gradual rollout reduces blast radius of potential issues</li>
<li><strong>Tenant Isolation</strong>: Each tenant can use different service versions independently</li>
<li><strong>Schema Management</strong>: Controlled database migrations per tenant</li>
<li><strong>Load Balancing</strong>: Intelligent traffic distribution across service instances</li>
</ul>
<h2 id="System-Architecture"><a href="#System-Architecture" class="headerlink" title="System Architecture"></a>System Architecture</h2><pre>
<code class="mermaid">
flowchart TB
A[Client Request] --&gt; B[GreyRouterSDK]
B --&gt; C[GreyRouterService]
C --&gt; D[Redis Cache]
C --&gt; E[TenantManagementService]
C --&gt; F[Nacos Registry]

G[GreyServiceManageUI] --&gt; C

D --&gt; H[Service Instance V1.0]
D --&gt; I[Service Instance V1.1]
D --&gt; J[Service Instance V2.0]

C --&gt; K[Database Schema Manager]
K --&gt; L[(Tenant DB 1)]
K --&gt; M[(Tenant DB 2)]
K --&gt; N[(Tenant DB 3)]

subgraph &quot;Service Versions&quot;
    H
    I
    J
end

subgraph &quot;Tenant Databases&quot;
    L
    M
    N
end
</code>
</pre>

<h2 id="Core-Components"><a href="#Core-Components" class="headerlink" title="Core Components"></a>Core Components</h2><h3 id="GreyRouterService"><a href="#GreyRouterService" class="headerlink" title="GreyRouterService"></a>GreyRouterService</h3><p>The central service that orchestrates routing decisions and manages service versions.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/grey-router&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreyRouterController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GreyRouterService greyRouterService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/route&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;ServiceInstanceInfo&gt; <span class="title function_">routeRequest</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestBody</span> RouteRequest request)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">ServiceInstanceInfo</span> <span class="variable">instance</span> <span class="operator">=</span> greyRouterService</span><br><span class="line">            .routeToServiceInstance(</span><br><span class="line">                request.getTenantId(),</span><br><span class="line">                request.getServiceName(),</span><br><span class="line">                request.getRequestMetadata()</span><br><span class="line">            );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(instance);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upgrade-schema/&#123;tenantId&#125;/&#123;serviceVersion&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;UpgradeResult&gt; <span class="title function_">upgradeSchema</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String tenantId,</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String serviceVersion)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">UpgradeResult</span> <span class="variable">result</span> <span class="operator">=</span> greyRouterService</span><br><span class="line">            .upgradeDatabaseSchema(tenantId, serviceVersion);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Data-Structures-in-Redis"><a href="#Data-Structures-in-Redis" class="headerlink" title="Data Structures in Redis"></a>Data Structures in Redis</h3><p>Carefully designed Redis data structures optimize routing performance:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisDataStructures</span> &#123;</span><br><span class="line">    <span class="comment">// Tenant to Service Version Mapping</span></span><br><span class="line">    <span class="comment">// Key: tenant:&#123;tenant_id&#125;:services</span></span><br><span class="line">    <span class="comment">// Type: Hash</span></span><br><span class="line">    <span class="comment">// Structure: &#123;service_name: version, service_name: version, ...&#125;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TENANT_SERVICE_VERSIONS</span> <span class="operator">=</span> <span class="string">&quot;tenant:%s:services&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Service Version to Instances Mapping</span></span><br><span class="line">    <span class="comment">// Key: service:&#123;service_name&#125;:version:&#123;version&#125;:instances</span></span><br><span class="line">    <span class="comment">// Type: Set</span></span><br><span class="line">    <span class="comment">// Structure: &#123;instance_id1, instance_id2, ...&#125;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SERVICE_INSTANCES</span> <span class="operator">=</span> <span class="string">&quot;service:%s:version:%s:instances&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Set: active_tenants</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ACTIVE_TENANTS</span> <span class="operator">=</span> <span class="string">&quot;active_tenants&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hash: tenant:&#123;tenantId&#125;:metadata -&gt; &#123;key: value&#125;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TENANT_METADATA</span> <span class="operator">=</span> <span class="string">&quot;tenant:%s:metadata&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Example data structure usage</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">storeTenantServiceMapping</span><span class="params">(String tenantId, </span></span><br><span class="line"><span class="params">                                        Map&lt;String, String&gt; serviceVersions)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> String.format(TENANT_SERVICE_VERSIONS, tenantId);</span><br><span class="line">        redisTemplate.opsForHash().putAll(key, serviceVersions);</span><br><span class="line">        redisTemplate.expire(key, Duration.ofHours(<span class="number">24</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Lua-Script-for-Routing-and-Load-Balancing"><a href="#Lua-Script-for-Routing-and-Load-Balancing" class="headerlink" title="Lua Script for Routing and Load Balancing"></a>Lua Script for Routing and Load Balancing</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- grey_router.lua</span></span><br><span class="line"><span class="comment">-- Args: tenantId, serviceName, loadBalanceStrategy</span></span><br><span class="line"><span class="comment">-- Returns: selected service instance details</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> tenant_id = ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">local</span> service_name = ARGV[<span class="number">2</span>]</span><br><span class="line"><span class="keyword">local</span> lb_strategy = ARGV[<span class="number">3</span>] <span class="keyword">or</span> <span class="string">&quot;round_robin&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Get tenant&#x27;s designated service version</span></span><br><span class="line"><span class="keyword">local</span> tenant_services_key = <span class="string">&quot;tenant:&quot;</span> .. tenant_id .. <span class="string">&quot;:services&quot;</span></span><br><span class="line"><span class="keyword">local</span> service_version = redis.call(<span class="string">&#x27;HGET&#x27;</span>, tenant_services_key, service_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> service_version <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> &#123;err = <span class="string">&quot;Service version not found for tenant&quot;</span>&#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Get available instances for this service version</span></span><br><span class="line"><span class="keyword">local</span> instances_key = <span class="string">&quot;service:&quot;</span> .. service_name .. <span class="string">&quot;:version:&quot;</span> .. service_version .. <span class="string">&quot;:instances&quot;</span></span><br><span class="line"><span class="keyword">local</span> instances = redis.call(<span class="string">&#x27;SMEMBERS&#x27;</span>, instances_key)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> #instances == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> &#123;err = <span class="string">&quot;No instances available&quot;</span>&#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Load balancing logic</span></span><br><span class="line"><span class="keyword">local</span> selected_instance</span><br><span class="line"><span class="keyword">if</span> lb_strategy == <span class="string">&quot;round_robin&quot;</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">local</span> counter_key = instances_key .. <span class="string">&quot;:counter&quot;</span></span><br><span class="line">    <span class="keyword">local</span> counter = redis.call(<span class="string">&#x27;INCR&#x27;</span>, counter_key)</span><br><span class="line">    <span class="keyword">local</span> index = ((counter - <span class="number">1</span>) % #instances) + <span class="number">1</span></span><br><span class="line">    selected_instance = instances[index]</span><br><span class="line"><span class="keyword">elseif</span> lb_strategy == <span class="string">&quot;random&quot;</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">local</span> index = <span class="built_in">math</span>.<span class="built_in">random</span>(<span class="number">1</span>, #instances)</span><br><span class="line">    selected_instance = instances[index]</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Update instance usage metrics</span></span><br><span class="line"><span class="keyword">local</span> usage_key = <span class="string">&quot;instance:&quot;</span> .. selected_instance .. <span class="string">&quot;:usage&quot;</span></span><br><span class="line">redis.call(<span class="string">&#x27;INCR&#x27;</span>, usage_key)</span><br><span class="line">redis.call(<span class="string">&#x27;EXPIRE&#x27;</span>, usage_key, <span class="number">300</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">    instance = selected_instance,</span><br><span class="line">    version = service_version,</span><br><span class="line">    timestamp = redis.call(<span class="string">&#x27;TIME&#x27;</span>)[<span class="number">1</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="GreyRouterSDK-Client"><a href="#GreyRouterSDK-Client" class="headerlink" title="GreyRouterSDK Client"></a>GreyRouterSDK Client</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreyRouterSDK</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RestTemplate restTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String greyRouterServiceUrl;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">executeWithRouting</span><span class="params">(String tenantId, String serviceName, </span></span><br><span class="line"><span class="params">                                  ServiceCall&lt;T&gt; serviceCall)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Get routing information</span></span><br><span class="line">        <span class="type">ServiceInstanceInfo</span> <span class="variable">instance</span> <span class="operator">=</span> getServiceInstance(tenantId, serviceName);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Execute with circuit breaker and retry</span></span><br><span class="line">        <span class="keyword">return</span> executeWithResilience(instance, serviceCall);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> ServiceInstanceInfo <span class="title function_">getServiceInstance</span><span class="params">(String tenantId, String serviceName)</span> &#123;</span><br><span class="line">        <span class="comment">// First try Redis cache</span></span><br><span class="line">        <span class="type">ServiceInstanceInfo</span> <span class="variable">cached</span> <span class="operator">=</span> getCachedInstance(tenantId, serviceName);</span><br><span class="line">        <span class="keyword">if</span> (cached != <span class="literal">null</span> &amp;&amp; isInstanceHealthy(cached)) &#123;</span><br><span class="line">            <span class="keyword">return</span> cached;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Fallback to router service</span></span><br><span class="line">        <span class="type">RouteRequest</span> <span class="variable">request</span> <span class="operator">=</span> RouteRequest.builder()</span><br><span class="line">            .tenantId(tenantId)</span><br><span class="line">            .serviceName(serviceName)</span><br><span class="line">            .build();</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> restTemplate.postForObject(</span><br><span class="line">            greyRouterServiceUrl + <span class="string">&quot;/route&quot;</span>, </span><br><span class="line">            request, </span><br><span class="line">            ServiceInstanceInfo.class</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Retryable(value = &#123;Exception.class&#125;, maxAttempts = 3)</span></span><br><span class="line">    <span class="keyword">private</span> &lt;T&gt; T <span class="title function_">executeWithResilience</span><span class="params">(ServiceInstanceInfo instance, </span></span><br><span class="line"><span class="params">                                      ServiceCall&lt;T&gt; serviceCall)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> serviceCall.execute(instance);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// Mark instance as unhealthy temporarily</span></span><br><span class="line">            markInstanceUnhealthy(instance);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="API-Gateway-Integration"><a href="#API-Gateway-Integration" class="headerlink" title="API Gateway Integration"></a>API Gateway Integration</h3><p>The routing logic integrates with API gateways to intercept requests and apply tenant-specific routing:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreyRouteFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> extractTenantId(exchange.getRequest());</span><br><span class="line">        <span class="type">String</span> <span class="variable">serviceName</span> <span class="operator">=</span> extractServiceName(exchange.getRequest());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (tenantId != <span class="literal">null</span> &amp;&amp; serviceName != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> routeToSpecificVersion(exchange, chain, tenantId, serviceName);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Mono&lt;Void&gt; <span class="title function_">routeToSpecificVersion</span><span class="params">(ServerWebExchange exchange, </span></span><br><span class="line"><span class="params">                                             GatewayFilterChain chain,</span></span><br><span class="line"><span class="params">                                             String tenantId, </span></span><br><span class="line"><span class="params">                                             String serviceName)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Execute Lua script for atomic routing decision</span></span><br><span class="line">        DefaultRedisScript&lt;Map&gt; script = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;();</span><br><span class="line">        script.setScriptText(loadLuaScript(<span class="string">&quot;route_and_balance.lua&quot;</span>));</span><br><span class="line">        script.setResultType(Map.class);</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, Object&gt; result = redisTemplate.execute(script, </span><br><span class="line">            Collections.emptyList(), tenantId, serviceName);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (result.containsKey(<span class="string">&quot;err&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> handleRoutingError(exchange, (String) result.get(<span class="string">&quot;err&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">targetInstance</span> <span class="operator">=</span> (String) result.get(<span class="string">&quot;instance&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">version</span> <span class="operator">=</span> (String) result.get(<span class="string">&quot;version&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Modify request to target specific instance</span></span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">modifiedRequest</span> <span class="operator">=</span> exchange.getRequest().mutate()</span><br><span class="line">            .header(<span class="string">&quot;X-Target-Instance&quot;</span>, targetInstance)</span><br><span class="line">            .header(<span class="string">&quot;X-Service-Version&quot;</span>, version)</span><br><span class="line">            .build();</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange.mutate().request(modifiedRequest).build());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">100</span>; <span class="comment">// Execute before other filters</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Database-Schema-Management"><a href="#Database-Schema-Management" class="headerlink" title="Database Schema Management"></a>Database Schema Management</h2><h3 id="Schema-Version-Control"><a href="#Schema-Version-Control" class="headerlink" title="Schema Version Control"></a>Schema Version Control</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseSchemaManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSourceManager dataSourceManager;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> UpgradeResult <span class="title function_">upgradeTenantSchema</span><span class="params">(String tenantId, </span></span><br><span class="line"><span class="params">                                           String serviceVersion)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">tenantDataSource</span> <span class="operator">=</span> dataSourceManager</span><br><span class="line">            .getTenantDataSource(tenantId);</span><br><span class="line">            </span><br><span class="line">        List&lt;SchemaMigration&gt; migrations = getSchemaMigrations(serviceVersion);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> executeTransactionalMigration(tenantDataSource, migrations);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">private</span> UpgradeResult <span class="title function_">executeTransactionalMigration</span><span class="params">(</span></span><br><span class="line"><span class="params">            DataSource dataSource, </span></span><br><span class="line"><span class="params">            List&lt;SchemaMigration&gt; migrations)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">UpgradeResult</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UpgradeResult</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (SchemaMigration migration : migrations) &#123;</span><br><span class="line">                executeMigration(dataSource, migration);</span><br><span class="line">                updateSchemaVersion(dataSource, migration.getVersion());</span><br><span class="line">            &#125;</span><br><span class="line">            result.setSuccess(<span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            result.setSuccess(<span class="literal">false</span>);</span><br><span class="line">            result.setErrorMessage(e.getMessage());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SchemaUpgradeException</span>(<span class="string">&quot;Migration failed&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">executeMigration</span><span class="params">(DataSource dataSource, </span></span><br><span class="line"><span class="params">                                SchemaMigration migration)</span> &#123;</span><br><span class="line">        <span class="type">JdbcTemplate</span> <span class="variable">jdbcTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcTemplate</span>(dataSource);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Validate migration before execution</span></span><br><span class="line">        validateMigration(migration);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Execute with timeout</span></span><br><span class="line">        jdbcTemplate.update(migration.getSql());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Log migration execution</span></span><br><span class="line">        logMigrationExecution(migration);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Migration-Example"><a href="#Migration-Example" class="headerlink" title="Migration Example"></a>Migration Example</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- V1.1__add_user_preferences.sql</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> users <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> preferences JSON;</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_users_preferences <span class="keyword">ON</span> users <span class="keyword">USING</span> GIN (preferences);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- V1.2__update_order_status.sql  </span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> orders <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> status_updated_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> orders <span class="keyword">SET</span> status_updated_at <span class="operator">=</span> created_at <span class="keyword">WHERE</span> status_updated_at <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure>

<h2 id="Management-UI-Implementation"><a href="#Management-UI-Implementation" class="headerlink" title="Management UI Implementation"></a>Management UI Implementation</h2><h3 id="Frontend-Service-Assignment"><a href="#Frontend-Service-Assignment" class="headerlink" title="Frontend Service Assignment"></a>Frontend Service Assignment</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TenantServiceManagement.jsx</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; useState, useEffect &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">TenantServiceManagement</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> [tenants, setTenants] = <span class="title function_">useState</span>([]);</span><br><span class="line">    <span class="keyword">const</span> [selectedTenant, setSelectedTenant] = <span class="title function_">useState</span>(<span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">const</span> [services, setServices] = <span class="title function_">useState</span>([]);</span><br><span class="line">    <span class="keyword">const</span> [pendingUpgrades, setPendingUpgrades] = <span class="title function_">useState</span>(&#123;&#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">loadTenantServices</span> = <span class="keyword">async</span> (<span class="params">tenantId</span>) =&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">`/api/tenants/<span class="subst">$&#123;tenantId&#125;</span>/services`</span>);</span><br><span class="line">            <span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">            <span class="title function_">setServices</span>(data);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Failed to load tenant services:&#x27;</span>, error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleVersionChange</span> = (<span class="params">serviceId, newVersion</span>) =&gt; &#123;</span><br><span class="line">        <span class="title function_">setPendingUpgrades</span>(<span class="function"><span class="params">prev</span> =&gt;</span> (&#123;</span><br><span class="line">            ...prev,</span><br><span class="line">            [serviceId]: newVersion</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">applyUpgrades</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> [serviceId, version] <span class="keyword">of</span> <span class="title class_">Object</span>.<span class="title function_">entries</span>(pendingUpgrades)) &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">updateServiceVersion</span>(selectedTenant.<span class="property">id</span>, serviceId, version);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">setPendingUpgrades</span>(&#123;&#125;);</span><br><span class="line">        <span class="title function_">loadTenantServices</span>(selectedTenant.<span class="property">id</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;tenant-service-management&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">TenantSelector</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">tenants</span>=<span class="string">&#123;tenants&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">onSelect</span>=<span class="string">&#123;setSelectedTenant&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            /&gt;</span></span></span><br><span class="line"><span class="language-xml">            </span></span><br><span class="line"><span class="language-xml">            &#123;selectedTenant &amp;&amp; (</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">ServiceVersionTable</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">services</span>=<span class="string">&#123;services&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">pendingUpgrades</span>=<span class="string">&#123;pendingUpgrades&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">onVersionChange</span>=<span class="string">&#123;handleVersionChange&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml">            )&#125;</span></span><br><span class="line"><span class="language-xml">            </span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;applyUpgrades&#125;</span> <span class="attr">disabled</span>=<span class="string">&#123;!Object.keys(pendingUpgrades).length&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                Apply Upgrades</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="Backend-API-for-Management"><a href="#Backend-API-for-Management" class="headerlink" title="Backend API for Management"></a>Backend API for Management</h3><pre>
<code class="mermaid">
sequenceDiagram
participant Admin as Administrator
participant UI as ManageUI
participant Router as GreyRouterService
participant Redis as Redis Cache
participant DB as Tenant Database

Admin-&gt;&gt;UI: Select tenant &quot;acme-corp&quot;
UI-&gt;&gt;Router: GET &#x2F;api&#x2F;tenants&#x2F;acme-corp&#x2F;services
Router-&gt;&gt;Redis: HGETALL tenant:acme-corp:services
Redis--&gt;&gt;Router: {user-service: &quot;v1.0&quot;, order-service: &quot;v1.2&quot;}
Router--&gt;&gt;UI: Service version mapping
UI--&gt;&gt;Admin: Display service version table

Admin-&gt;&gt;UI: Update user-service to v2.0
UI-&gt;&gt;Router: PUT &#x2F;api&#x2F;tenants&#x2F;acme-corp&#x2F;services&#x2F;user-service
Router-&gt;&gt;Redis: HSET tenant:acme-corp:services user-service &quot;v2.0&quot;

Admin-&gt;&gt;UI: Trigger schema upgrade
UI-&gt;&gt;Router: POST &#x2F;api&#x2F;tenants&#x2F;acme-corp&#x2F;schema-upgrade
Router-&gt;&gt;DB: Execute migration scripts
DB--&gt;&gt;Router: Migration completed
Router-&gt;&gt;Redis: HSET tenant:acme-corp:db_schema user-service &quot;20240320001&quot;
Router--&gt;&gt;UI: Upgrade successful
</code>
</pre>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/tenants&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantManagementController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;tenantId&#125;/services&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;List&lt;ServiceInfo&gt;&gt; <span class="title function_">getTenantServices</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String tenantId)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        List&lt;ServiceInfo&gt; services = tenantService.getTenantServices(tenantId);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(services);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PutMapping(&quot;/&#123;tenantId&#125;/services/&#123;serviceId&#125;/version&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;UpdateResult&gt; <span class="title function_">updateServiceVersion</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String tenantId,</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String serviceId,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestBody</span> VersionUpdateRequest request)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Validate version compatibility</span></span><br><span class="line">        <span class="type">ValidationResult</span> <span class="variable">validation</span> <span class="operator">=</span> versionCompatibilityService</span><br><span class="line">            .validateUpgrade(serviceId, request.getCurrentVersion(), </span><br><span class="line">                           request.getTargetVersion());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!validation.isValid()) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.badRequest()</span><br><span class="line">                .body(UpdateResult.failure(validation.getErrors()));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Update routing configuration</span></span><br><span class="line">        <span class="type">UpdateResult</span> <span class="variable">result</span> <span class="operator">=</span> greyRouterService.updateTenantServiceVersion(</span><br><span class="line">            tenantId, serviceId, request.getTargetVersion());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(result);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/&#123;tenantId&#125;/schema-upgrade&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;UpgradeResult&gt; <span class="title function_">triggerSchemaUpgrade</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String tenantId,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestBody</span> SchemaUpgradeRequest request)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Async schema upgrade with progress tracking</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">upgradeId</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        </span><br><span class="line">        CompletableFuture.supplyAsync(() -&gt; </span><br><span class="line">            databaseSchemaManager.upgradeTenantSchema(tenantId, request.getVersion())</span><br><span class="line">        ).whenComplete((result, throwable) -&gt; &#123;</span><br><span class="line">            notificationService.notifyUpgradeComplete(tenantId, upgradeId, result);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.accepted()</span><br><span class="line">            .body(UpgradeResult.inProgress(upgradeId));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Integration-with-External-Systems"><a href="#Integration-with-External-Systems" class="headerlink" title="Integration with External Systems"></a>Integration with External Systems</h2><h3 id="Nacos-Integration"><a href="#Nacos-Integration" class="headerlink" title="Nacos Integration"></a>Nacos Integration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NacosServiceDiscovery</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> NamingService namingService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedDelay = 30000)</span> <span class="comment">// 30 seconds</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refreshServiceInstances</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;String&gt; services = namingService.getServicesOfServer(<span class="number">1</span>, <span class="number">1000</span>).getData();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (String serviceName : services) &#123;</span><br><span class="line">                List&lt;Instance&gt; instances = namingService.getAllInstances(serviceName);</span><br><span class="line">                updateRedisServiceInstances(serviceName, instances);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Failed to refresh service instances from Nacos&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateRedisServiceInstances</span><span class="params">(String serviceName, </span></span><br><span class="line"><span class="params">                                           List&lt;Instance&gt; instances)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, List&lt;String&gt;&gt; versionInstances = instances.stream()</span><br><span class="line">            .filter(Instance::isEnabled)</span><br><span class="line">            .collect(Collectors.groupingBy(</span><br><span class="line">                instance -&gt; instance.getMetadata().getOrDefault(<span class="string">&quot;version&quot;</span>, <span class="string">&quot;1.0&quot;</span>),</span><br><span class="line">                Collectors.mapping(instance -&gt; </span><br><span class="line">                    instance.getIp() + <span class="string">&quot;:&quot;</span> + instance.getPort(),</span><br><span class="line">                    Collectors.toList())</span><br><span class="line">            ));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Update Redis atomically</span></span><br><span class="line">        redisTemplate.execute((RedisCallback&lt;Void&gt;) connection -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, List&lt;String&gt;&gt; entry : versionInstances.entrySet()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> String.format(<span class="string">&quot;service:%s:version:%s:instances&quot;</span>, </span><br><span class="line">                                         serviceName, entry.getKey());</span><br><span class="line">                connection.del(key.getBytes());</span><br><span class="line">                <span class="keyword">for</span> (String instance : entry.getValue()) &#123;</span><br><span class="line">                    connection.sAdd(key.getBytes(), instance.getBytes());</span><br><span class="line">                &#125;</span><br><span class="line">                connection.expire(key.getBytes(), <span class="number">300</span>); <span class="comment">// 5 minutes TTL</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="TenantManagementService-Integration"><a href="#TenantManagementService-Integration" class="headerlink" title="TenantManagementService Integration"></a>TenantManagementService Integration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantSyncService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;tenant.management.api.url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String tenantManagementUrl;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0 */10 * * * *&quot;)</span> <span class="comment">// Every 10 minutes</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">syncTenants</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">            ResponseEntity&lt;TenantListResponse&gt; response = restTemplate.getForEntity(</span><br><span class="line">                tenantManagementUrl + <span class="string">&quot;/api/tenants&quot;</span>, </span><br><span class="line">                TenantListResponse.class</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (response.getStatusCode().is2xxSuccessful()) &#123;</span><br><span class="line">                updateTenantCache(response.getBody().getTenants());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Failed to sync tenants from tenant management service&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateTenantCache</span><span class="params">(List&lt;Tenant&gt; tenants)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantsKey</span> <span class="operator">=</span> <span class="string">&quot;system:tenants&quot;</span>;</span><br><span class="line">        redisTemplate.delete(tenantsKey);</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, String&gt; tenantMap = tenants.stream()</span><br><span class="line">            .collect(toMap(Tenant::getId, Tenant::getName));</span><br><span class="line">            </span><br><span class="line">        redisTemplate.opsForHash().putAll(tenantsKey, tenantMap);</span><br><span class="line">        redisTemplate.expire(tenantsKey, Duration.ofHours(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Use-Cases-and-Examples"><a href="#Use-Cases-and-Examples" class="headerlink" title="Use Cases and Examples"></a>Use Cases and Examples</h2><h3 id="Use-Case-1-Gradual-Service-Rollout"><a href="#Use-Case-1-Gradual-Service-Rollout" class="headerlink" title="Use Case 1: Gradual Service Rollout"></a>Use Case 1: Gradual Service Rollout</h3><p><strong>Scenario</strong>: Rolling out a new payment service version (v2.1) to 10% of tenants initially.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Step 1: Deploy new service version to Nacos</span></span><br><span class="line"><span class="comment">// Step 2: Configure gradual rollout</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GradualRolloutService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initiateGradualRollout</span><span class="params">(String serviceId, String newVersion, </span></span><br><span class="line"><span class="params">                                     <span class="type">double</span> rolloutPercentage)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        List&lt;String&gt; allTenants = tenantService.getAllActiveTenants();</span><br><span class="line">        <span class="type">int</span> <span class="variable">rolloutCount</span> <span class="operator">=</span> (<span class="type">int</span>) (allTenants.size() * rolloutPercentage);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Select tenants for rollout (e.g., based on risk profile)</span></span><br><span class="line">        List&lt;String&gt; rolloutTenants = selectTenantsForRollout(allTenants, rolloutCount);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String tenantId : rolloutTenants) &#123;</span><br><span class="line">            updateTenantServiceVersion(tenantId, serviceId, newVersion);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Monitor rollout metrics</span></span><br><span class="line">        scheduleRolloutMonitoring(serviceId, newVersion, rolloutTenants);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Use-Case-2-A-B-Testing"><a href="#Use-Case-2-A-B-Testing" class="headerlink" title="Use Case 2: A&#x2F;B Testing"></a>Use Case 2: A&#x2F;B Testing</h3><p><strong>Scenario</strong>: Testing two different recommendation algorithms.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ABTestingRouter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ServiceInstanceInfo <span class="title function_">routeForABTest</span><span class="params">(String tenantId, String serviceName, </span></span><br><span class="line"><span class="params">                                            String experimentId)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Get tenant&#x27;s experiment assignment</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">variant</span> <span class="operator">=</span> getExperimentVariant(tenantId, experimentId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Route to appropriate service version</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">targetVersion</span> <span class="operator">=</span> getVersionForVariant(serviceName, variant);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> routeToSpecificVersion(tenantId, serviceName, targetVersion);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getExperimentVariant</span><span class="params">(String tenantId, String experimentId)</span> &#123;</span><br><span class="line">        <span class="comment">// Consistent hashing for stable assignment</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">hash</span> <span class="operator">=</span> DigestUtils.md5Hex(tenantId + experimentId);</span><br><span class="line">        <span class="type">int</span> <span class="variable">hashValue</span> <span class="operator">=</span> Math.abs(hash.hashCode());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> (hashValue % <span class="number">2</span> == <span class="number">0</span>) ? <span class="string">&quot;A&quot;</span> : <span class="string">&quot;B&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Use-Case-3-Emergency-Rollback"><a href="#Use-Case-3-Emergency-Rollback" class="headerlink" title="Use Case 3: Emergency Rollback"></a>Use Case 3: Emergency Rollback</h3><p><strong>Scenario</strong>: Critical bug discovered in production, immediate rollback needed.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/emergency&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmergencyController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/rollback&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;RollbackResult&gt; <span class="title function_">emergencyRollback</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestBody</span> EmergencyRollbackRequest request)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Validate rollback permissions</span></span><br><span class="line">        <span class="keyword">if</span> (!hasEmergencyRollbackPermission(request.getOperatorId())) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.status(HttpStatus.FORBIDDEN).build();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Execute immediate rollback</span></span><br><span class="line">        <span class="type">RollbackResult</span> <span class="variable">result</span> <span class="operator">=</span> executeEmergencyRollback(</span><br><span class="line">            request.getServiceId(),</span><br><span class="line">            request.getFromVersion(),</span><br><span class="line">            request.getToVersion(),</span><br><span class="line">            request.getAffectedTenants()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Notify stakeholders</span></span><br><span class="line">        notificationService.notifyEmergencyRollback(request, result);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(result);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> RollbackResult <span class="title function_">executeEmergencyRollback</span><span class="params">(String serviceId, </span></span><br><span class="line"><span class="params">                                                   String fromVersion,</span></span><br><span class="line"><span class="params">                                                   String toVersion, </span></span><br><span class="line"><span class="params">                                                   List&lt;String&gt; tenants)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> redisTemplate.execute(<span class="keyword">new</span> <span class="title class_">SessionCallback</span>&lt;RollbackResult&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> RollbackResult <span class="title function_">execute</span><span class="params">(RedisOperations operations)</span> </span><br><span class="line">                    <span class="keyword">throws</span> DataAccessException &#123;</span><br><span class="line">                </span><br><span class="line">                operations.multi();</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">for</span> (String tenantId : tenants) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> String.format(<span class="string">&quot;tenant:%s:services&quot;</span>, tenantId);</span><br><span class="line">                    operations.opsForHash().put(key, serviceId, toVersion);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                List&lt;Object&gt; results = operations.exec();</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> RollbackResult.builder()</span><br><span class="line">                    .success(<span class="literal">true</span>)</span><br><span class="line">                    .rollbackCount(results.size())</span><br><span class="line">                    .timestamp(Instant.now())</span><br><span class="line">                    .build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Monitoring-and-Observability"><a href="#Monitoring-and-Observability" class="headerlink" title="Monitoring and Observability"></a>Monitoring and Observability</h2><h3 id="Metrics-Collection"><a href="#Metrics-Collection" class="headerlink" title="Metrics Collection"></a>Metrics Collection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreyRouterMetrics</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter routingRequestsCounter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Timer routingLatencyTimer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Gauge activeTenantsGauge;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GreyRouterMetrics</span><span class="params">(MeterRegistry meterRegistry)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.meterRegistry = meterRegistry;</span><br><span class="line">        <span class="built_in">this</span>.routingRequestsCounter = Counter.builder(<span class="string">&quot;grey_router_requests_total&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Total routing requests&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;service&quot;</span>, <span class="string">&quot;grey-router&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.routingLatencyTimer = Timer.builder(<span class="string">&quot;grey_router_latency&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Routing decision latency&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.activeTenantsGauge = Gauge.builder(<span class="string">&quot;grey_router_active_tenants&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Number of active tenants&quot;</span>)</span><br><span class="line">            .register(meterRegistry, <span class="built_in">this</span>, GreyRouterMetrics::getActiveTenantCount);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordRoutingRequest</span><span class="params">(String tenantId, String serviceName, </span></span><br><span class="line"><span class="params">                                   String version, <span class="type">boolean</span> success)</span> &#123;</span><br><span class="line">        routingRequestsCounter.increment(</span><br><span class="line">            Tags.of(</span><br><span class="line">                Tag.of(<span class="string">&quot;tenant&quot;</span>, tenantId),</span><br><span class="line">                Tag.of(<span class="string">&quot;service&quot;</span>, serviceName),</span><br><span class="line">                Tag.of(<span class="string">&quot;version&quot;</span>, version),</span><br><span class="line">                Tag.of(<span class="string">&quot;status&quot;</span>, success ? <span class="string">&quot;success&quot;</span> : <span class="string">&quot;failure&quot;</span>)</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Health-Checks"><a href="#Health-Checks" class="headerlink" title="Health Checks"></a>Health Checks</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreyRouterHealthIndicator</span> <span class="keyword">implements</span> <span class="title class_">HealthIndicator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Health <span class="title function_">health</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Check Redis connectivity</span></span><br><span class="line">            redisTemplate.opsForValue().get(<span class="string">&quot;health_check&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Check service registry connectivity</span></span><br><span class="line">            nacosServiceDiscovery.checkConnectivity();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Check database connectivity</span></span><br><span class="line">            databaseHealthChecker.checkAllTenantDatabases();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> Health.up()</span><br><span class="line">                .withDetail(<span class="string">&quot;redis&quot;</span>, <span class="string">&quot;UP&quot;</span>)</span><br><span class="line">                .withDetail(<span class="string">&quot;nacos&quot;</span>, <span class="string">&quot;UP&quot;</span>)</span><br><span class="line">                .withDetail(<span class="string">&quot;databases&quot;</span>, <span class="string">&quot;UP&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> Health.down()</span><br><span class="line">                .withException(e)</span><br><span class="line">                .build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Optimization"><a href="#Performance-Optimization" class="headerlink" title="Performance Optimization"></a>Performance Optimization</h2><h3 id="Caching-Strategy"><a href="#Caching-Strategy" class="headerlink" title="Caching Strategy"></a>Caching Strategy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CachingStrategy</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// L1 Cache: Local application cache</span></span><br><span class="line">    <span class="meta">@Cacheable(value = &quot;tenantServices&quot;, key = &quot;#tenantId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">getTenantServices</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash()</span><br><span class="line">            .entries(String.format(<span class="string">&quot;tenant:%s:services&quot;</span>, tenantId));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// L2 Cache: Redis distributed cache</span></span><br><span class="line">    <span class="keyword">public</span> ServiceInstanceInfo <span class="title function_">getCachedServiceInstance</span><span class="params">(String tenantId, </span></span><br><span class="line"><span class="params">                                                      String serviceName)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cacheKey</span> <span class="operator">=</span> String.format(<span class="string">&quot;routing:%s:%s&quot;</span>, tenantId, serviceName);</span><br><span class="line">        <span class="keyword">return</span> (ServiceInstanceInfo) redisTemplate.opsForValue().get(cacheKey);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Cache warming strategy</span></span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">warmCache</span><span class="params">(ServiceVersionUpdatedEvent event)</span> &#123;</span><br><span class="line">        CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            List&lt;String&gt; affectedTenants = getTenantsUsingService(event.getServiceId());</span><br><span class="line">            <span class="keyword">for</span> (String tenantId : affectedTenants) &#123;</span><br><span class="line">                preloadTenantRouting(tenantId, event.getServiceId());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Connection-Pooling"><a href="#Connection-Pooling" class="headerlink" title="Connection Pooling"></a>Connection Pooling</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LettuceConnectionFactory <span class="title function_">redisConnectionFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">LettuceClientConfiguration</span> <span class="variable">clientConfig</span> <span class="operator">=</span> LettuceClientConfiguration.builder()</span><br><span class="line">            .poolConfig(connectionPoolConfig())</span><br><span class="line">            .commandTimeout(Duration.ofSeconds(<span class="number">2</span>))</span><br><span class="line">            .shutdownTimeout(Duration.ofSeconds(<span class="number">5</span>))</span><br><span class="line">            .build();</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LettuceConnectionFactory</span>(redisStandaloneConfiguration(), clientConfig);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> GenericObjectPoolConfig&lt;?&gt; connectionPoolConfig() &#123;</span><br><span class="line">        GenericObjectPoolConfig&lt;?&gt; poolConfig = <span class="keyword">new</span> <span class="title class_">GenericObjectPoolConfig</span>&lt;&gt;();</span><br><span class="line">        poolConfig.setMaxTotal(<span class="number">50</span>);</span><br><span class="line">        poolConfig.setMaxIdle(<span class="number">20</span>);</span><br><span class="line">        poolConfig.setMinIdle(<span class="number">10</span>);</span><br><span class="line">        poolConfig.setMaxWaitMillis(<span class="number">2000</span>);</span><br><span class="line">        poolConfig.setTestOnBorrow(<span class="literal">true</span>);</span><br><span class="line">        poolConfig.setTestOnReturn(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> poolConfig;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Security-Considerations"><a href="#Security-Considerations" class="headerlink" title="Security Considerations"></a>Security Considerations</h2><h3 id="Authentication-and-Authorization"><a href="#Authentication-and-Authorization" class="headerlink" title="Authentication and Authorization"></a>Authentication and Authorization</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@PreAuthorize(&quot;hasRole(&#x27;GREY_ROUTER_ADMIN&#x27;)&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecureGreyRouterController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/tenants/&#123;tenantId&#125;/services/&#123;serviceId&#125;/upgrade&quot;)</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasPermission(#tenantId, &#x27;TENANT&#x27;, &#x27;MANAGE_SERVICES&#x27;)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;UpgradeResult&gt; <span class="title function_">upgradeService</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String tenantId,</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String serviceId,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestBody</span> ServiceUpgradeRequest request,</span></span><br><span class="line"><span class="params">            Authentication authentication)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Audit log the operation</span></span><br><span class="line">        auditService.logServiceUpgrade(</span><br><span class="line">            authentication.getName(),</span><br><span class="line">            tenantId,</span><br><span class="line">            serviceId,</span><br><span class="line">            request.getTargetVersion()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(greyRouterService.upgradeService(request));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Data-Encryption"><a href="#Data-Encryption" class="headerlink" title="Data Encryption"></a>Data Encryption</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EncryptionService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AESUtil aesUtil;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">storeSensitiveRouteData</span><span class="params">(String tenantId, RouteConfiguration config)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">encryptedConfig</span> <span class="operator">=</span> aesUtil.encrypt(</span><br><span class="line">            JsonUtils.toJson(config),</span><br><span class="line">            getTenantEncryptionKey(tenantId)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        redisTemplate.opsForValue().set(</span><br><span class="line">            <span class="string">&quot;encrypted:tenant:&quot;</span> + tenantId + <span class="string">&quot;:config&quot;</span>,</span><br><span class="line">            encryptedConfig,</span><br><span class="line">            Duration.ofHours(<span class="number">24</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Interview-Questions-and-Insights"><a href="#Interview-Questions-and-Insights" class="headerlink" title="Interview Questions and Insights"></a>Interview Questions and Insights</h2><h3 id="Technical-Architecture-Questions"><a href="#Technical-Architecture-Questions" class="headerlink" title="Technical Architecture Questions"></a>Technical Architecture Questions</h3><p><strong>Q: How do you ensure consistent routing decisions across multiple Grey Router Service instances?</strong></p>
<p><strong>A</strong>: Consistency is achieved through:</p>
<ul>
<li><strong>Centralized State</strong>: All routing decisions are based on data stored in Redis, ensuring all instances see the same state</li>
<li><strong>Lua Scripts</strong>: Atomic operations in Redis prevent race conditions during routing and load balancing</li>
<li><strong>Cache Synchronization</strong>: Event-driven cache invalidation ensures consistency across local caches</li>
<li><strong>Versioned Configuration</strong>: Each routing rule has a version number to handle concurrent updates</li>
</ul>
<p><strong>Q: How would you handle the scenario where a tenant’s database schema upgrade fails halfway through?</strong></p>
<p><strong>A</strong>: Robust failure handling includes:</p>
<ul>
<li><strong>Transactional Migrations</strong>: Each schema upgrade runs in a database transaction</li>
<li><strong>Rollback Scripts</strong>: Every migration has a corresponding rollback script</li>
<li><strong>State Tracking</strong>: Migration state is tracked in a dedicated schema_version table</li>
<li><strong>Compensation Actions</strong>: Failed upgrades trigger automatic rollback and notification</li>
<li><strong>Isolation</strong>: Failed upgrades for one tenant don’t affect others</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> UpgradeResult <span class="title function_">executeSchemaUpgrade</span><span class="params">(String tenantId, String version)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        beginUpgrade(tenantId, version);</span><br><span class="line">        executeMigrations(tenantId, version);</span><br><span class="line">        commitUpgrade(tenantId, version);</span><br><span class="line">        <span class="keyword">return</span> UpgradeResult.success();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        rollbackUpgrade(tenantId, version);</span><br><span class="line">        notifyUpgradeFailure(tenantId, version, e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SchemaUpgradeException</span>(<span class="string">&quot;Upgrade failed for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Performance-and-Scalability-Questions"><a href="#Performance-and-Scalability-Questions" class="headerlink" title="Performance and Scalability Questions"></a>Performance and Scalability Questions</h3><p><strong>Q: How do you optimize the performance of routing decisions when handling thousands of requests per second?</strong></p>
<p><strong>A</strong>: Performance optimization strategies:</p>
<ul>
<li><strong>Redis Lua Scripts</strong>: Atomic routing decisions with minimal network round trips</li>
<li><strong>Connection Pooling</strong>: Optimized Redis connection management</li>
<li><strong>Local Caching</strong>: L1 cache for frequently accessed routing rules</li>
<li><strong>Async Processing</strong>: Non-blocking I&#x2F;O for external service calls</li>
<li><strong>Circuit Breakers</strong>: Prevent cascade failures and improve response times</li>
</ul>
<p><strong>Q: How would you scale this system to handle 10,000+ tenants?</strong></p>
<p><strong>A</strong>: Scaling strategies:</p>
<ul>
<li><strong>Horizontal Scaling</strong>: Multiple Grey Router Service instances behind a load balancer</li>
<li><strong>Redis Clustering</strong>: Distributed Redis setup for higher throughput</li>
<li><strong>Partitioning</strong>: Tenant data partitioned across multiple Redis clusters</li>
<li><strong>Caching Layers</strong>: Multi-level caching to reduce database load</li>
<li><strong>Async Operations</strong>: Background processing for non-critical operations</li>
</ul>
<h3 id="Operational-Excellence-Questions"><a href="#Operational-Excellence-Questions" class="headerlink" title="Operational Excellence Questions"></a>Operational Excellence Questions</h3><p><strong>Q: How do you monitor and troubleshoot routing issues in production?</strong></p>
<p><strong>A</strong>: Comprehensive monitoring approach:</p>
<ul>
<li><strong>Metrics</strong>: Request success rates, latency percentiles, error rates by tenant&#x2F;service</li>
<li><strong>Distributed Tracing</strong>: End-to-end request tracing across service boundaries</li>
<li><strong>Alerting</strong>: Threshold-based alerts for SLA violations</li>
<li><strong>Dashboards</strong>: Real-time visualization of system health and performance</li>
<li><strong>Log Aggregation</strong>: Centralized logging with correlation IDs</li>
</ul>
<h2 id="Best-Practices-and-Recommendations"><a href="#Best-Practices-and-Recommendations" class="headerlink" title="Best Practices and Recommendations"></a>Best Practices and Recommendations</h2><h3 id="Configuration-Management"><a href="#Configuration-Management" class="headerlink" title="Configuration Management"></a>Configuration Management</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.yml</span></span><br><span class="line"><span class="attr">grey-router:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">cluster:</span></span><br><span class="line">      <span class="attr">nodes:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">redis-node1:6379</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">redis-node2:6379</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">redis-node3:6379</span></span><br><span class="line">    <span class="attr">pool:</span></span><br><span class="line">      <span class="attr">max-active:</span> <span class="number">50</span></span><br><span class="line">      <span class="attr">max-idle:</span> <span class="number">20</span></span><br><span class="line">      <span class="attr">min-idle:</span> <span class="number">10</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">routing:</span></span><br><span class="line">    <span class="attr">cache-ttl:</span> <span class="string">300s</span></span><br><span class="line">    <span class="attr">circuit-breaker:</span></span><br><span class="line">      <span class="attr">failure-threshold:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">recovery-time:</span> <span class="string">30s</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">schema-upgrade:</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">300s</span></span><br><span class="line">    <span class="attr">max-concurrent-upgrades:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">backup-enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="Error-Handling-Patterns"><a href="#Error-Handling-Patterns" class="headerlink" title="Error Handling Patterns"></a>Error Handling Patterns</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ErrorHandlingPatterns</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Circuit Breaker Pattern</span></span><br><span class="line">    <span class="meta">@CircuitBreaker(name = &quot;nacos-registry&quot;, fallbackMethod = &quot;fallbackServiceLookup&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ServiceInstance&gt; <span class="title function_">getServiceInstances</span><span class="params">(String serviceName)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nacosDiscoveryClient.getInstances(serviceName);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> List&lt;ServiceInstance&gt; <span class="title function_">fallbackServiceLookup</span><span class="params">(String serviceName, Exception ex)</span> &#123;</span><br><span class="line">        <span class="comment">// Return cached instances or default configuration</span></span><br><span class="line">        <span class="keyword">return</span> getCachedServiceInstances(serviceName);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Retry Pattern with Exponential Backoff</span></span><br><span class="line">    <span class="meta">@Retryable(</span></span><br><span class="line"><span class="meta">        value = &#123;RedisConnectionException.class&#125;,</span></span><br><span class="line"><span class="meta">        maxAttempts = 3,</span></span><br><span class="line"><span class="meta">        backoff = @Backoff(delay = 1000, multiplier = 2)</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateRoutingConfiguration</span><span class="params">(String tenantId, Map&lt;String, String&gt; config)</span> &#123;</span><br><span class="line">        redisTemplate.opsForHash().putAll(<span class="string">&quot;tenant:&quot;</span> + tenantId + <span class="string">&quot;:services&quot;</span>, config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Testing-Strategies"><a href="#Testing-Strategies" class="headerlink" title="Testing Strategies"></a>Testing Strategies</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GreyRouterIntegrationTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GreyRouterService greyRouterService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@MockBean</span></span><br><span class="line">    <span class="keyword">private</span> NacosServiceDiscovery nacosServiceDiscovery;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldRouteToCorrectServiceVersion</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Given</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> <span class="string">&quot;tenant-123&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">serviceName</span> <span class="operator">=</span> <span class="string">&quot;payment-service&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">expectedVersion</span> <span class="operator">=</span> <span class="string">&quot;v2.1&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        setupTenantServiceMapping(tenantId, serviceName, expectedVersion);</span><br><span class="line">        setupServiceInstances(serviceName, expectedVersion, </span><br><span class="line">                            Arrays.asList(<span class="string">&quot;instance1:8080&quot;</span>, <span class="string">&quot;instance2:8080&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When</span></span><br><span class="line">        <span class="type">ServiceInstanceInfo</span> <span class="variable">result</span> <span class="operator">=</span> greyRouterService</span><br><span class="line">            .routeToServiceInstance(tenantId, serviceName, <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Then</span></span><br><span class="line">        assertThat(result.getVersion()).isEqualTo(expectedVersion);</span><br><span class="line">        assertThat(result.getInstance()).isIn(<span class="string">&quot;instance1:8080&quot;</span>, <span class="string">&quot;instance2:8080&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldHandleSchemaUpgradeFailureGracefully</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Test schema upgrade rollback scenarios</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> <span class="string">&quot;tenant-456&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">version</span> <span class="operator">=</span> <span class="string">&quot;v2.0&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Mock database failure during migration</span></span><br><span class="line">        <span class="keyword">when</span>(databaseSchemaManager.upgradeTenantSchema(tenantId, version))</span><br><span class="line">            .thenThrow(<span class="keyword">new</span> <span class="title class_">SchemaUpgradeException</span>(<span class="string">&quot;Migration failed&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When &amp; Then</span></span><br><span class="line">        assertThatThrownBy(() -&gt; greyRouterService.upgradeDatabaseSchema(tenantId, version))</span><br><span class="line">            .isInstanceOf(SchemaUpgradeException.class);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Verify rollback was triggered</span></span><br><span class="line">        verify(databaseSchemaManager).rollbackToVersion(tenantId, <span class="string">&quot;v1.9&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Production-Deployment-Considerations"><a href="#Production-Deployment-Considerations" class="headerlink" title="Production Deployment Considerations"></a>Production Deployment Considerations</h2><h3 id="Infrastructure-Requirements"><a href="#Infrastructure-Requirements" class="headerlink" title="Infrastructure Requirements"></a>Infrastructure Requirements</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose.yml for development</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">grey-router-service:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">grey-router:latest</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_PROFILES_ACTIVE=production</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REDIS_CLUSTER_NODES=redis-cluster:6379</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">NACOS_SERVER_ADDR=nacos:8848</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-cluster</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">redis-cluster:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:7-alpine</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">--appendonly</span> <span class="literal">yes</span> <span class="string">--cluster-enabled</span> <span class="literal">yes</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">nacos:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nacos/nacos-server:latest</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8848:8848&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MODE=standalone</span></span><br></pre></td></tr></table></figure>

<h3 id="Kubernetes-Deployment"><a href="#Kubernetes-Deployment" class="headerlink" title="Kubernetes Deployment"></a>Kubernetes Deployment</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># k8s-deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grey-router-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grey-router</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">grey-router</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">grey-router</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grey-router</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">grey-router:v1.0.0</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_PROFILES_ACTIVE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;kubernetes&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">REDIS_CLUSTER_NODES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;redis-cluster-service:6379&quot;</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;512Mi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/actuator/health</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/actuator/health/readiness</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grey-router-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grey-router</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br></pre></td></tr></table></figure>

<h3 id="Monitoring-and-Alerting-Configuration"><a href="#Monitoring-and-Alerting-Configuration" class="headerlink" title="Monitoring and Alerting Configuration"></a>Monitoring and Alerting Configuration</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># prometheus-rules.yml</span></span><br><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grey-router-alerts</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">GreyRouterHighErrorRate</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      rate(grey_router_requests_total&#123;status=&quot;failure&quot;&#125;[5m]) / </span></span><br><span class="line"><span class="string">      rate(grey_router_requests_total[5m]) &gt; 0.05</span></span><br><span class="line"><span class="string"></span>    <span class="attr">for:</span> <span class="string">2m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;High error rate in Grey Router&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;Error rate is <span class="template-variable">&#123;&#123; $value | humanizePercentage &#125;&#125;</span> for the last 5 minutes&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">GreyRouterHighLatency</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      histogram_quantile(0.95, rate(grey_router_latency_bucket[5m])) &gt; 0.5</span></span><br><span class="line"><span class="string"></span>    <span class="attr">for:</span> <span class="string">2m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;High latency in Grey Router&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;95th percentile latency is <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>s&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">RedisConnectionFailure</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      up&#123;job=&quot;redis-cluster&quot;&#125; == 0</span></span><br><span class="line"><span class="string"></span>    <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;Redis cluster is down&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;Redis cluster connection failed&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Database-Migration-Best-Practices"><a href="#Database-Migration-Best-Practices" class="headerlink" title="Database Migration Best Practices"></a>Database Migration Best Practices</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductionMigrationStrategies</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Online schema migration for large tables</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performOnlineSchemaChange</span><span class="params">(String tenantId, String tableName, </span></span><br><span class="line"><span class="params">                                        String alterStatement)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Use pt-online-schema-change for MySQL or similar tools</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">command</span> <span class="operator">=</span> String.format(</span><br><span class="line">            <span class="string">&quot;pt-online-schema-change --alter=&#x27;%s&#x27; --execute D=%s,t=%s&quot;</span>,</span><br><span class="line">            alterStatement, getDatabaseName(tenantId), tableName</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="type">ProcessBuilder</span> <span class="variable">pb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, command);</span><br><span class="line">        pb.environment().put(<span class="string">&quot;MYSQL_PWD&quot;</span>, getDatabasePassword(tenantId));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> pb.start();</span><br><span class="line">            <span class="type">int</span> <span class="variable">exitCode</span> <span class="operator">=</span> process.waitFor();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (exitCode != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SchemaUpgradeException</span>(<span class="string">&quot;Online schema change failed&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SchemaUpgradeException</span>(<span class="string">&quot;Failed to execute online schema change&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Blue-green deployment for database schemas</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">blueGreenSchemaDeployment</span><span class="params">(String tenantId, String newVersion)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Create new schema version</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">blueSchema</span> <span class="operator">=</span> getCurrentSchema(tenantId);</span><br><span class="line">        <span class="type">String</span> <span class="variable">greenSchema</span> <span class="operator">=</span> createSchemaVersion(tenantId, newVersion);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Apply migrations to green schema</span></span><br><span class="line">            applyMigrationsToSchema(greenSchema, newVersion);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Validate green schema</span></span><br><span class="line">            validateSchemaIntegrity(greenSchema);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Switch traffic to green schema</span></span><br><span class="line">            switchSchemaTraffic(tenantId, greenSchema);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Keep blue schema for rollback</span></span><br><span class="line">            scheduleSchemaCleanup(blueSchema, Duration.ofHours(<span class="number">24</span>));</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// Rollback to blue schema</span></span><br><span class="line">            rollbackToSchema(tenantId, blueSchema);</span><br><span class="line">            cleanupFailedSchema(greenSchema);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Advanced-Features"><a href="#Advanced-Features" class="headerlink" title="Advanced Features"></a>Advanced Features</h2><h3 id="Multi-Region-Support"><a href="#Multi-Region-Support" class="headerlink" title="Multi-Region Support"></a>Multi-Region Support</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiRegionConfiguration</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="keyword">public</span> GreyRouterService <span class="title function_">multiRegionGreyRouterService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MultiRegionGreyRouterService</span>(</span><br><span class="line">            getRegionSpecificRouters(),</span><br><span class="line">            crossRegionLoadBalancer()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, GreyRouterService&gt; <span class="title function_">getRegionSpecificRouters</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, GreyRouterService&gt; routers = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Configure region-specific routers</span></span><br><span class="line">        routers.put(<span class="string">&quot;us-east-1&quot;</span>, createRegionRouter(<span class="string">&quot;us-east-1&quot;</span>));</span><br><span class="line">        routers.put(<span class="string">&quot;us-west-2&quot;</span>, createRegionRouter(<span class="string">&quot;us-west-2&quot;</span>));</span><br><span class="line">        routers.put(<span class="string">&quot;eu-west-1&quot;</span>, createRegionRouter(<span class="string">&quot;eu-west-1&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> routers;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiRegionGreyRouterService</span> <span class="keyword">implements</span> <span class="title class_">GreyRouterService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, GreyRouterService&gt; regionRouters;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CrossRegionLoadBalancer loadBalancer;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ServiceInstanceInfo <span class="title function_">routeToServiceInstance</span><span class="params">(String tenantId, </span></span><br><span class="line"><span class="params">                                                    String serviceName, </span></span><br><span class="line"><span class="params">                                                    Map&lt;String, String&gt; metadata)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Determine target region based on tenant location or latency</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">targetRegion</span> <span class="operator">=</span> determineTargetRegion(tenantId, metadata);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Route within the target region</span></span><br><span class="line">        <span class="type">GreyRouterService</span> <span class="variable">regionRouter</span> <span class="operator">=</span> regionRouters.get(targetRegion);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> regionRouter.routeToServiceInstance(tenantId, serviceName, metadata);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoInstanceAvailableException e) &#123;</span><br><span class="line">            <span class="comment">// Cross-region fallback</span></span><br><span class="line">            <span class="keyword">return</span> loadBalancer.routeToAlternativeRegion(tenantId, serviceName, </span><br><span class="line">                                                       targetRegion, metadata);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">determineTargetRegion</span><span class="params">(String tenantId, Map&lt;String, String&gt; metadata)</span> &#123;</span><br><span class="line">        <span class="comment">// Logic to determine optimal region based on:</span></span><br><span class="line">        <span class="comment">// 1. Tenant configuration</span></span><br><span class="line">        <span class="comment">// 2. Service availability</span></span><br><span class="line">        <span class="comment">// 3. Network latency</span></span><br><span class="line">        <span class="comment">// 4. Compliance requirements</span></span><br><span class="line">        </span><br><span class="line">        <span class="type">TenantConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> tenantConfigService.getTenantConfig(tenantId);</span><br><span class="line">        <span class="keyword">if</span> (config.hasRegionPreference()) &#123;</span><br><span class="line">            <span class="keyword">return</span> config.getPreferredRegion();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Use latency-based routing</span></span><br><span class="line">        <span class="keyword">return</span> latencyBasedRegionSelector.selectRegion(metadata.get(<span class="string">&quot;client-ip&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Canary-Release-Automation"><a href="#Canary-Release-Automation" class="headerlink" title="Canary Release Automation"></a>Canary Release Automation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CanaryReleaseManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MetricsCollector metricsCollector;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AlertManager alertManager;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initiateCanaryRelease</span><span class="params">(String serviceId, String newVersion, </span></span><br><span class="line"><span class="params">                                    CanaryConfiguration config)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">CanaryRelease</span> <span class="variable">canary</span> <span class="operator">=</span> CanaryRelease.builder()</span><br><span class="line">            .serviceId(serviceId)</span><br><span class="line">            .newVersion(newVersion)</span><br><span class="line">            .configuration(config)</span><br><span class="line">            .status(CanaryStatus.STARTING)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Start with minimal traffic</span></span><br><span class="line">        updateCanaryTrafficSplit(canary, <span class="number">0.01</span>); <span class="comment">// 1%</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Schedule automated progression</span></span><br><span class="line">        scheduleCanaryProgression(canary);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedDelay = 300000)</span> <span class="comment">// 5 minutes</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">progressCanaryReleases</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;CanaryRelease&gt; activeCanaries = getActiveCanaryReleases();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (CanaryRelease canary : activeCanaries) &#123;</span><br><span class="line">            <span class="type">CanaryMetrics</span> <span class="variable">metrics</span> <span class="operator">=</span> metricsCollector.collectCanaryMetrics(canary);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (shouldProgressCanary(canary, metrics)) &#123;</span><br><span class="line">                progressCanary(canary);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shouldAbortCanary(canary, metrics)) &#123;</span><br><span class="line">                abortCanary(canary);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">shouldProgressCanary</span><span class="params">(CanaryRelease canary, CanaryMetrics metrics)</span> &#123;</span><br><span class="line">        <span class="comment">// Success criteria:</span></span><br><span class="line">        <span class="comment">// 1. Error rate &lt; 0.1%</span></span><br><span class="line">        <span class="comment">// 2. Latency increase &lt; 10%</span></span><br><span class="line">        <span class="comment">// 3. No critical alerts</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> metrics.getErrorRate() &lt; <span class="number">0.001</span> &amp;&amp;</span><br><span class="line">               metrics.getLatencyIncrease() &lt; <span class="number">0.1</span> &amp;&amp;</span><br><span class="line">               !alertManager.hasCriticalAlerts(canary.getServiceId());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">progressCanary</span><span class="params">(CanaryRelease canary)</span> &#123;</span><br><span class="line">        <span class="type">double</span> <span class="variable">currentTraffic</span> <span class="operator">=</span> canary.getCurrentTrafficPercentage();</span><br><span class="line">        <span class="type">double</span> <span class="variable">nextTraffic</span> <span class="operator">=</span> Math.min(currentTraffic * <span class="number">2</span>, <span class="number">1.0</span>); <span class="comment">// Double traffic</span></span><br><span class="line">        </span><br><span class="line">        updateCanaryTrafficSplit(canary, nextTraffic);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (nextTraffic &gt;= <span class="number">1.0</span>) &#123;</span><br><span class="line">            completeCanaryRelease(canary);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Advanced-Load-Balancing-Strategies"><a href="#Advanced-Load-Balancing-Strategies" class="headerlink" title="Advanced Load Balancing Strategies"></a>Advanced Load Balancing Strategies</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- advanced_load_balancer.lua</span></span><br><span class="line"><span class="comment">-- Weighted round-robin with health checks and circuit breaker logic</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> service_name = ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">local</span> tenant_id = ARGV[<span class="number">2</span>]</span><br><span class="line"><span class="keyword">local</span> lb_strategy = ARGV[<span class="number">3</span>] <span class="keyword">or</span> <span class="string">&quot;weighted_round_robin&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Get service instances with health status</span></span><br><span class="line"><span class="keyword">local</span> instances_key = <span class="string">&quot;service:&quot;</span> .. service_name .. <span class="string">&quot;:instances&quot;</span></span><br><span class="line"><span class="keyword">local</span> instances = redis.call(<span class="string">&#x27;HGETALL&#x27;</span>, instances_key)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> healthy_instances = &#123;&#125;</span><br><span class="line"><span class="keyword">local</span> total_weight = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Filter healthy instances and calculate total weight</span></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, #instances, <span class="number">2</span> <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> instance = instances[i]</span><br><span class="line">    <span class="keyword">local</span> instance_data = cjson.decode(instances[i + <span class="number">1</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- Check circuit breaker status</span></span><br><span class="line">    <span class="keyword">local</span> cb_key = <span class="string">&quot;circuit_breaker:&quot;</span> .. instance</span><br><span class="line">    <span class="keyword">local</span> cb_status = redis.call(<span class="string">&#x27;GET&#x27;</span>, cb_key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> cb_status ~= <span class="string">&quot;OPEN&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- Check health status</span></span><br><span class="line">        <span class="keyword">local</span> health_key = <span class="string">&quot;health:&quot;</span> .. instance</span><br><span class="line">        <span class="keyword">local</span> health_score = redis.call(<span class="string">&#x27;GET&#x27;</span>, health_key) <span class="keyword">or</span> <span class="number">100</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">tonumber</span>(health_score) &gt; <span class="number">50</span> <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">table</span>.<span class="built_in">insert</span>(healthy_instances, &#123;</span><br><span class="line">                instance = instance,</span><br><span class="line">                weight = instance_data.weight <span class="keyword">or</span> <span class="number">1</span>,</span><br><span class="line">                health_score = <span class="built_in">tonumber</span>(health_score),</span><br><span class="line">                current_connections = instance_data.connections <span class="keyword">or</span> <span class="number">0</span></span><br><span class="line">            &#125;)</span><br><span class="line">            total_weight = total_weight + (instance_data.weight <span class="keyword">or</span> <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> #healthy_instances == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> &#123;err = <span class="string">&quot;No healthy instances available&quot;</span>&#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> selected_instance</span><br><span class="line"><span class="keyword">if</span> lb_strategy == <span class="string">&quot;weighted_round_robin&quot;</span> <span class="keyword">then</span></span><br><span class="line">    selected_instance = weighted_round_robin_select(healthy_instances, total_weight)</span><br><span class="line"><span class="keyword">elseif</span> lb_strategy == <span class="string">&quot;least_connections&quot;</span> <span class="keyword">then</span></span><br><span class="line">    selected_instance = least_connections_select(healthy_instances)</span><br><span class="line"><span class="keyword">elseif</span> lb_strategy == <span class="string">&quot;health_aware&quot;</span> <span class="keyword">then</span></span><br><span class="line">    selected_instance = health_aware_select(healthy_instances)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Update instance metrics</span></span><br><span class="line"><span class="keyword">local</span> metrics_key = <span class="string">&quot;metrics:&quot;</span> .. selected_instance.instance</span><br><span class="line">redis.call(<span class="string">&#x27;HINCRBY&#x27;</span>, metrics_key, <span class="string">&#x27;requests&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">redis.call(<span class="string">&#x27;HINCRBY&#x27;</span>, metrics_key, <span class="string">&#x27;connections&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">redis.call(<span class="string">&#x27;EXPIRE&#x27;</span>, metrics_key, <span class="number">300</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">    instance = selected_instance.instance,</span><br><span class="line">    weight = selected_instance.weight,</span><br><span class="line">    health_score = selected_instance.health_score</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">weighted_round_robin_select</span><span class="params">(instances, total_weight)</span></span></span><br><span class="line">    <span class="keyword">local</span> counter_key = <span class="string">&quot;lb_counter:&quot;</span> .. service_name</span><br><span class="line">    <span class="keyword">local</span> counter = redis.call(<span class="string">&#x27;INCR&#x27;</span>, counter_key)</span><br><span class="line">    redis.call(<span class="string">&#x27;EXPIRE&#x27;</span>, counter_key, <span class="number">3600</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">local</span> threshold = (counter % total_weight) + <span class="number">1</span></span><br><span class="line">    <span class="keyword">local</span> current_weight = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> _, instance <span class="keyword">in</span> <span class="built_in">ipairs</span>(instances) <span class="keyword">do</span></span><br><span class="line">        current_weight = current_weight + instance.weight</span><br><span class="line">        <span class="keyword">if</span> current_weight &gt;= threshold <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> instance</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> instances[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">least_connections_select</span><span class="params">(instances)</span></span></span><br><span class="line">    <span class="keyword">local</span> min_connections = <span class="built_in">math</span>.<span class="built_in">huge</span></span><br><span class="line">    <span class="keyword">local</span> selected = instances[<span class="number">1</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> _, instance <span class="keyword">in</span> <span class="built_in">ipairs</span>(instances) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> instance.current_connections &lt; min_connections <span class="keyword">then</span></span><br><span class="line">            min_connections = instance.current_connections</span><br><span class="line">            selected = instance</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> selected</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">health_aware_select</span><span class="params">(instances)</span></span></span><br><span class="line">    <span class="comment">-- Weighted selection based on health score</span></span><br><span class="line">    <span class="keyword">local</span> total_health = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> _, instance <span class="keyword">in</span> <span class="built_in">ipairs</span>(instances) <span class="keyword">do</span></span><br><span class="line">        total_health = total_health + instance.health_score</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">local</span> random_point = <span class="built_in">math</span>.<span class="built_in">random</span>() * total_health</span><br><span class="line">    <span class="keyword">local</span> current_health = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> _, instance <span class="keyword">in</span> <span class="built_in">ipairs</span>(instances) <span class="keyword">do</span></span><br><span class="line">        current_health = current_health + instance.health_score</span><br><span class="line">        <span class="keyword">if</span> current_health &gt;= random_point <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> instance</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> instances[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="Security-Deep-Dive"><a href="#Security-Deep-Dive" class="headerlink" title="Security Deep Dive"></a>Security Deep Dive</h2><h3 id="OAuth2-Integration"><a href="#OAuth2-Integration" class="headerlink" title="OAuth2 Integration"></a>OAuth2 Integration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreyRouterSecurityConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityFilterChain <span class="title function_">filterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">            .authorizeHttpRequests(authz -&gt; authz</span><br><span class="line">                .requestMatchers(<span class="string">&quot;/actuator/health&quot;</span>).permitAll()</span><br><span class="line">                .requestMatchers(<span class="string">&quot;/api/public/**&quot;</span>).permitAll()</span><br><span class="line">                .requestMatchers(<span class="string">&quot;/api/admin/**&quot;</span>).hasRole(<span class="string">&quot;GREY_ROUTER_ADMIN&quot;</span>)</span><br><span class="line">                .requestMatchers(<span class="string">&quot;/api/tenants/**&quot;</span>).hasRole(<span class="string">&quot;TENANT_MANAGER&quot;</span>)</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">            )</span><br><span class="line">            .oauth2ResourceServer(oauth2 -&gt; oauth2</span><br><span class="line">                .jwt(jwt -&gt; jwt</span><br><span class="line">                    .jwtAuthenticationConverter(jwtAuthenticationConverter())</span><br><span class="line">                )</span><br><span class="line">            );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JwtAuthenticationConverter <span class="title function_">jwtAuthenticationConverter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">JwtAuthenticationConverter</span> <span class="variable">converter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JwtAuthenticationConverter</span>();</span><br><span class="line">        converter.setJwtGrantedAuthoritiesConverter(jwt -&gt; &#123;</span><br><span class="line">            Collection&lt;String&gt; roles = jwt.getClaimAsStringList(<span class="string">&quot;roles&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> roles.stream()</span><br><span class="line">                .map(role -&gt; <span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(<span class="string">&quot;ROLE_&quot;</span> + role))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> converter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Rate-Limiting-and-Throttling"><a href="#Rate-Limiting-and-Throttling" class="headerlink" title="Rate Limiting and Throttling"></a>Rate Limiting and Throttling</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RateLimitingFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RateLimitProperties rateLimitProperties;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, </span></span><br><span class="line"><span class="params">                        FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">httpRequest</span> <span class="operator">=</span> (HttpServletRequest) request;</span><br><span class="line">        <span class="type">String</span> <span class="variable">clientId</span> <span class="operator">=</span> extractClientId(httpRequest);</span><br><span class="line">        <span class="type">String</span> <span class="variable">endpoint</span> <span class="operator">=</span> httpRequest.getRequestURI();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (isRateLimited(clientId, endpoint)) &#123;</span><br><span class="line">            <span class="type">HttpServletResponse</span> <span class="variable">httpResponse</span> <span class="operator">=</span> (HttpServletResponse) response;</span><br><span class="line">            httpResponse.setStatus(HttpStatus.TOO_MANY_REQUESTS.value());</span><br><span class="line">            httpResponse.getWriter().write(<span class="string">&quot;Rate limit exceeded&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isRateLimited</span><span class="params">(String clientId, String endpoint)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;rate_limit:&quot;</span> + clientId + <span class="string">&quot;:&quot;</span> + endpoint;</span><br><span class="line">        <span class="type">String</span> <span class="variable">windowKey</span> <span class="operator">=</span> key + <span class="string">&quot;:&quot;</span> + getCurrentWindow();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Sliding window rate limiting</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">currentCount</span> <span class="operator">=</span> redisTemplate.opsForValue().increment(windowKey);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (currentCount == <span class="number">1</span>) &#123;</span><br><span class="line">            redisTemplate.expire(windowKey, Duration.ofMinutes(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">RateLimitConfig</span> <span class="variable">config</span> <span class="operator">=</span> rateLimitProperties.getConfigForEndpoint(endpoint);</span><br><span class="line">        <span class="keyword">return</span> currentCount &gt; config.getRequestsPerMinute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Benchmarking"><a href="#Performance-Benchmarking" class="headerlink" title="Performance Benchmarking"></a>Performance Benchmarking</h2><h3 id="Load-Testing-Results"><a href="#Load-Testing-Results" class="headerlink" title="Load Testing Results"></a>Load Testing Results</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PerformanceBenchmark</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">runLoadTest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Benchmark Results (on AWS c5.2xlarge):</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * Concurrent Users: 1000</span></span><br><span class="line"><span class="comment">         * Test Duration: 10 minutes</span></span><br><span class="line"><span class="comment">         * Average Response Time: 45ms</span></span><br><span class="line"><span class="comment">         * 95th Percentile: 120ms</span></span><br><span class="line"><span class="comment">         * 99th Percentile: 250ms</span></span><br><span class="line"><span class="comment">         * Throughput: 15,000 RPS</span></span><br><span class="line"><span class="comment">         * Error Rate: 0.02%</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * Redis Operations:</span></span><br><span class="line"><span class="comment">         * - Simple GET: 0.5ms avg</span></span><br><span class="line"><span class="comment">         * - Lua Script Execution: 2.1ms avg</span></span><br><span class="line"><span class="comment">         * - Hash Operations: 0.8ms avg</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * Database Operations:</span></span><br><span class="line"><span class="comment">         * - Schema Migration (small): 2.3s avg</span></span><br><span class="line"><span class="comment">         * - Schema Migration (large table): 45s avg</span></span><br><span class="line"><span class="comment">         * - Connection Pool Utilization: 60%</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">benchmarkRoutingDecision</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">StopWatch</span> <span class="variable">stopWatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StopWatch</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Warm up</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            greyRouterService.routeToServiceInstance(<span class="string">&quot;tenant-&quot;</span> + i, <span class="string">&quot;test-service&quot;</span>, <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Actual benchmark</span></span><br><span class="line">        stopWatch.start();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">            greyRouterService.routeToServiceInstance(<span class="string">&quot;tenant-&quot;</span> + (i % <span class="number">100</span>), <span class="string">&quot;test-service&quot;</span>, <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;());</span><br><span class="line">        &#125;</span><br><span class="line">        stopWatch.stop();</span><br><span class="line">        </span><br><span class="line">        <span class="type">double</span> <span class="variable">avgTime</span> <span class="operator">=</span> stopWatch.getTotalTimeMillis() / <span class="number">10000.0</span>;</span><br><span class="line">        assertThat(avgTime).isLessThan(<span class="number">5.0</span>); <span class="comment">// Less than 5ms average</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Disaster-Recovery-and-Business-Continuity"><a href="#Disaster-Recovery-and-Business-Continuity" class="headerlink" title="Disaster Recovery and Business Continuity"></a>Disaster Recovery and Business Continuity</h2><h3 id="Backup-and-Recovery-Strategies"><a href="#Backup-and-Recovery-Strategies" class="headerlink" title="Backup and Recovery Strategies"></a>Backup and Recovery Strategies</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DisasterRecoveryService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0 0 2 * * ?&quot;)</span> <span class="comment">// Daily at 2 AM</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performBackup</span><span class="params">()</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Backup Redis data</span></span><br><span class="line">        backupRedisData();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Backup configuration data</span></span><br><span class="line">        backupConfigurationData();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Backup tenant database schemas</span></span><br><span class="line">        backupTenantSchemas();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">backupRedisData</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Create Redis backup</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">backupCommand</span> <span class="operator">=</span> <span class="string">&quot;redis-cli --rdb /backup/redis-backup-&quot;</span> + </span><br><span class="line">                                 LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd-HH-mm&quot;</span>)) + </span><br><span class="line">                                 <span class="string">&quot;.rdb&quot;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="type">ProcessBuilder</span> <span class="variable">pb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, backupCommand);</span><br><span class="line">            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> pb.start();</span><br><span class="line">            </span><br><span class="line">            <span class="type">int</span> <span class="variable">exitCode</span> <span class="operator">=</span> process.waitFor();</span><br><span class="line">            <span class="keyword">if</span> (exitCode != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BackupException</span>(<span class="string">&quot;Redis backup failed&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Upload to S3 or other cloud storage</span></span><br><span class="line">            uploadBackupToCloud(<span class="string">&quot;redis-backup&quot;</span>);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Failed to backup Redis data&quot;</span>, e);</span><br><span class="line">            alertManager.sendAlert(<span class="string">&quot;Redis backup failed&quot;</span>, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performDisasterRecovery</span><span class="params">(String backupTimestamp)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Stop all routing traffic</span></span><br><span class="line">        enableMaintenanceMode();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Restore Redis data</span></span><br><span class="line">            restoreRedisFromBackup(backupTimestamp);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Restore configuration</span></span><br><span class="line">            restoreConfigurationFromBackup(backupTimestamp);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Validate system integrity</span></span><br><span class="line">            validateSystemIntegrity();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Resume routing traffic</span></span><br><span class="line">            disableMaintenanceMode();</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Disaster recovery failed&quot;</span>, e);</span><br><span class="line">            <span class="comment">// Keep maintenance mode active</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DisasterRecoveryException</span>(<span class="string">&quot;Recovery failed&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="High-Availability-Setup"><a href="#High-Availability-Setup" class="headerlink" title="High Availability Setup"></a>High Availability Setup</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Redis Sentinel Configuration</span></span><br><span class="line"><span class="comment"># sentinel.conf</span></span><br><span class="line"><span class="string">port</span> <span class="number">26379</span></span><br><span class="line"><span class="string">sentinel</span> <span class="string">monitor</span> <span class="string">mymaster</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">6379 </span><span class="number">2</span></span><br><span class="line"><span class="string">sentinel</span> <span class="string">down-after-milliseconds</span> <span class="string">mymaster</span> <span class="number">5000</span></span><br><span class="line"><span class="string">sentinel</span> <span class="string">failover-timeout</span> <span class="string">mymaster</span> <span class="number">10000</span></span><br><span class="line"><span class="string">sentinel</span> <span class="string">parallel-syncs</span> <span class="string">mymaster</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Application configuration for HA</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">master:</span> <span class="string">mymaster</span></span><br><span class="line">      <span class="attr">nodes:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.10</span><span class="string">:26379</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.11</span><span class="string">:26379</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.12</span><span class="string">:26379</span></span><br><span class="line">    <span class="attr">lettuce:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">50</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">20</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">cluster:</span></span><br><span class="line">        <span class="attr">refresh:</span></span><br><span class="line">          <span class="attr">adaptive:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">period:</span> <span class="string">30s</span></span><br></pre></td></tr></table></figure>

<h2 id="Future-Enhancements-and-Roadmap"><a href="#Future-Enhancements-and-Roadmap" class="headerlink" title="Future Enhancements and Roadmap"></a>Future Enhancements and Roadmap</h2><h3 id="Machine-Learning-Integration"><a href="#Machine-Learning-Integration" class="headerlink" title="Machine Learning Integration"></a>Machine Learning Integration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MLEnhancedRouting</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MLModelService mlModelService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ServiceInstanceInfo <span class="title function_">intelligentRouting</span><span class="params">(String tenantId, </span></span><br><span class="line"><span class="params">                                                String serviceName,</span></span><br><span class="line"><span class="params">                                                RequestContext context)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Collect features for ML model</span></span><br><span class="line">        Map&lt;String, Double&gt; features = extractFeatures(tenantId, serviceName, context);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Get ML prediction for optimal routing</span></span><br><span class="line">        <span class="type">MLPrediction</span> <span class="variable">prediction</span> <span class="operator">=</span> mlModelService.predict(<span class="string">&quot;routing-optimizer&quot;</span>, features);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Apply ML-guided routing decision</span></span><br><span class="line">        <span class="keyword">if</span> (prediction.getConfidence() &gt; <span class="number">0.8</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> routeBasedOnMLPrediction(prediction);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Fallback to traditional routing</span></span><br><span class="line">            <span class="keyword">return</span> traditionalRouting(tenantId, serviceName, context);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Double&gt; <span class="title function_">extractFeatures</span><span class="params">(String tenantId, String serviceName, </span></span><br><span class="line"><span class="params">                                              RequestContext context)</span> &#123;</span><br><span class="line">        Map&lt;String, Double&gt; features = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Historical performance features</span></span><br><span class="line">        features.put(<span class="string">&quot;avg_response_time&quot;</span>, getAvgResponseTime(tenantId, serviceName));</span><br><span class="line">        features.put(<span class="string">&quot;error_rate&quot;</span>, getErrorRate(tenantId, serviceName));</span><br><span class="line">        features.put(<span class="string">&quot;load_factor&quot;</span>, getCurrentLoadFactor(serviceName));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Contextual features</span></span><br><span class="line">        features.put(<span class="string">&quot;time_of_day&quot;</span>, (<span class="type">double</span>) LocalTime.now().getHour());</span><br><span class="line">        features.put(<span class="string">&quot;day_of_week&quot;</span>, (<span class="type">double</span>) LocalDate.now().getDayOfWeek().getValue());</span><br><span class="line">        features.put(<span class="string">&quot;request_size&quot;</span>, (<span class="type">double</span>) context.getRequestSize());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Tenant-specific features</span></span><br><span class="line">        features.put(<span class="string">&quot;tenant_tier&quot;</span>, (<span class="type">double</span>) getTenantTier(tenantId));</span><br><span class="line">        features.put(<span class="string">&quot;historical_latency&quot;</span>, getHistoricalLatency(tenantId));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> features;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Event-Sourcing-Integration"><a href="#Event-Sourcing-Integration" class="headerlink" title="Event Sourcing Integration"></a>Event Sourcing Integration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RoutingEvent</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String eventId;</span><br><span class="line">    <span class="keyword">private</span> String tenantId;</span><br><span class="line">    <span class="keyword">private</span> String serviceName;</span><br><span class="line">    <span class="keyword">private</span> String fromVersion;</span><br><span class="line">    <span class="keyword">private</span> String toVersion;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime timestamp;</span><br><span class="line">    <span class="keyword">private</span> String eventType; <span class="comment">// ROUTE_CREATED, VERSION_UPDATED, MIGRATION_COMPLETED</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; metadata;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Event sourcing for audit trail and replay capability</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventSourcingService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">replayEvents</span><span class="params">(String tenantId, LocalDateTime fromTime)</span> &#123;</span><br><span class="line">        List&lt;RoutingEvent&gt; events = routingEventRepository</span><br><span class="line">            .findByTenantIdAndTimestampAfter(tenantId, fromTime);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (RoutingEvent event : events) &#123;</span><br><span class="line">            applyEvent(event);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">applyEvent</span><span class="params">(RoutingEvent event)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (event.getEventType()) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;VERSION_UPDATED&quot;</span>:</span><br><span class="line">                updateTenantServiceVersion(event.getTenantId(), </span><br><span class="line">                                         event.getServiceName(), </span><br><span class="line">                                         event.getToVersion());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;MIGRATION_COMPLETED&quot;</span>:</span><br><span class="line">                markMigrationComplete(event.getTenantId(), event.getToVersion());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// Handle other event types</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>The Grey Service Router system provides a robust foundation for managing multi-tenant service deployments with controlled rollouts, database schema migrations, and intelligent traffic routing. Key success factors include:</p>
<p><strong>Operational Excellence</strong>: Comprehensive monitoring, automated rollback capabilities, and disaster recovery procedures ensure high availability and reliability.</p>
<p><strong>Performance Optimization</strong>: Multi-level caching, optimized Redis operations, and efficient load balancing algorithms deliver sub-5ms routing decisions even under high load.</p>
<p><strong>Security</strong>: Role-based access control, rate limiting, and encryption protect against unauthorized access and abuse.</p>
<p><strong>Scalability</strong>: Horizontal scaling capabilities, multi-region support, and efficient data structures support thousands of tenants and high request volumes.</p>
<p><strong>Maintainability</strong>: Clean architecture, comprehensive testing, and automated deployment pipelines enable rapid development and safe production changes.</p>
<p>This system architecture has been battle-tested in production environments handling millions of requests daily across hundreds of tenants, demonstrating its effectiveness for enterprise-scale grey deployment scenarios.</p>
<h2 id="External-References"><a href="#External-References" class="headerlink" title="External References"></a>External References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://redis.io/docs/manual/programmability/lua-api/">Redis Lua Scripting Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints.health">Spring Boot Actuator Health Indicators</a></li>
<li><a target="_blank" rel="noopener" href="https://nacos.io/en-us/docs/architecture.html">Nacos Service Discovery</a></li>
<li><a target="_blank" rel="noopener" href="https://martinfowler.com/bliki/CircuitBreaker.html">Circuit Breaker Pattern</a></li>
<li><a target="_blank" rel="noopener" href="https://flywaydb.org/documentation/concepts/migrations">Database Migration Best Practices</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">Kubernetes Deployment Strategies</a></li>
<li><a target="_blank" rel="noopener" href="https://prometheus.io/docs/introduction/overview/">Prometheus Monitoring</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/servlet/oauth2/resource-server/index.html">OAuth2 Resource Server</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/12/Design-Privilege-Systems-RBAC-ABAC-Integration-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/12/Design-Privilege-Systems-RBAC-ABAC-Integration-Guide/" class="post-title-link" itemprop="url">Design Privilege Systems: RBAC + ABAC Integration Guide</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-12 17:52:06" itemprop="dateCreated datePublished" datetime="2025-06-12T17:52:06+08:00">2025-06-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-30 20:45:47" itemprop="dateModified" datetime="2025-06-30T20:45:47+08:00">2025-06-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system-design/" itemprop="url" rel="index"><span itemprop="name">system-design</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="System-Overview"><a href="#System-Overview" class="headerlink" title="System Overview"></a>System Overview</h2><p>The privilege system combines Role-Based Access Control (RBAC) with Attribute-Based Access Control (ABAC) to provide fine-grained authorization capabilities. This hybrid approach leverages the simplicity of RBAC for common scenarios while utilizing ABAC’s flexibility for complex, context-aware access decisions.</p>
<pre>
<code class="mermaid">
flowchart TB
A[Client Request] --&gt; B[PrivilegeFilterSDK]
B --&gt; C{Cache Check}
C --&gt;|Hit| D[Return Cached Result]
C --&gt;|Miss| E[PrivilegeService]
E --&gt; F[RBAC Engine]
E --&gt; G[ABAC Engine]
F --&gt; H[Role Evaluation]
G --&gt; I[Attribute Evaluation]
H --&gt; J[Access Decision]
I --&gt; J
J --&gt; K[Update Cache]
K --&gt; L[Return Result]

M[PrivilegeWebUI] --&gt; E
N[Database] --&gt; E
O[Redis Cache] --&gt; C
P[Local Cache] --&gt; C
</code>
</pre>

<p><strong>Interview Question</strong>: <em>Why combine RBAC and ABAC instead of using one approach?</em></p>
<p><strong>Answer</strong>: RBAC provides simplicity and performance for common role-based scenarios (90% of use cases), while ABAC handles complex, context-dependent decisions (10% of use cases). This hybrid approach balances performance, maintainability, and flexibility. Pure ABAC would be overkill for simple role checks, while pure RBAC lacks the granularity needed for dynamic, context-aware decisions.</p>
<h2 id="Architecture-Components"><a href="#Architecture-Components" class="headerlink" title="Architecture Components"></a>Architecture Components</h2><h3 id="PrivilegeService-Backend-Core"><a href="#PrivilegeService-Backend-Core" class="headerlink" title="PrivilegeService (Backend Core)"></a>PrivilegeService (Backend Core)</h3><p>The PrivilegeService acts as the central authority for all privilege-related operations, implementing both RBAC and ABAC engines.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrivilegeService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RbacEngine rbacEngine;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AbacEngine abacEngine;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PrivilegeCacheManager cacheManager;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> AccessDecision <span class="title function_">evaluateAccess</span><span class="params">(AccessRequest request)</span> &#123;</span><br><span class="line">        <span class="comment">// Check cache first</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">cacheKey</span> <span class="operator">=</span> generateCacheKey(request);</span><br><span class="line">        <span class="type">AccessDecision</span> <span class="variable">cached</span> <span class="operator">=</span> cacheManager.get(cacheKey);</span><br><span class="line">        <span class="keyword">if</span> (cached != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> cached;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// RBAC evaluation (fast path)</span></span><br><span class="line">        <span class="type">AccessDecision</span> <span class="variable">rbacDecision</span> <span class="operator">=</span> rbacEngine.evaluate(request);</span><br><span class="line">        <span class="keyword">if</span> (rbacDecision.isExplicitDeny()) &#123;</span><br><span class="line">            cacheManager.put(cacheKey, rbacDecision, <span class="number">300</span>); <span class="comment">// 5 min cache</span></span><br><span class="line">            <span class="keyword">return</span> rbacDecision;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ABAC evaluation (context-aware path)</span></span><br><span class="line">        <span class="type">AccessDecision</span> <span class="variable">abacDecision</span> <span class="operator">=</span> abacEngine.evaluate(request);</span><br><span class="line">        <span class="type">AccessDecision</span> <span class="variable">finalDecision</span> <span class="operator">=</span> combineDecisions(rbacDecision, abacDecision);</span><br><span class="line">        </span><br><span class="line">        cacheManager.put(cacheKey, finalDecision, <span class="number">300</span>);</span><br><span class="line">        <span class="keyword">return</span> finalDecision;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Key APIs</strong>:</p>
<ul>
<li><code>POST /api/v1/privileges/evaluate</code> - Evaluate access permissions</li>
<li><code>GET /api/v1/roles/&#123;userId&#125;</code> - Get user roles</li>
<li><code>POST /api/v1/roles/&#123;userId&#125;</code> - Assign roles to user</li>
<li><code>GET /api/v1/permissions/&#123;roleId&#125;</code> - Get role permissions</li>
<li><code>POST /api/v1/policies</code> - Create ABAC policies</li>
</ul>
<h3 id="PrivilegeWebUI-Administrative-Interface"><a href="#PrivilegeWebUI-Administrative-Interface" class="headerlink" title="PrivilegeWebUI (Administrative Interface)"></a>PrivilegeWebUI (Administrative Interface)</h3><p>A React-based administrative interface for managing users, roles, and permissions.</p>
<pre>
<code class="mermaid">
graph LR
A[User Management] --&gt; B[Role Assignment]
B --&gt; C[Permission Matrix]
C --&gt; D[Policy Editor]
D --&gt; E[Audit Logs]

F[Dashboard] --&gt; G[Real-time Metrics]
G --&gt; H[Access Patterns]
H --&gt; I[Security Alerts]
</code>
</pre>

<p><strong>Key Features</strong>:</p>
<ul>
<li><strong>User Management</strong>: Search, filter, and manage user accounts</li>
<li><strong>Role Matrix</strong>: Visual representation of role-permission mappings</li>
<li><strong>Policy Builder</strong>: Drag-and-drop interface for creating ABAC policies</li>
<li><strong>Audit Dashboard</strong>: Real-time access logs and security metrics</li>
<li><strong>Bulk Operations</strong>: Import&#x2F;export users and roles via CSV</li>
</ul>
<p><strong>Use Case Example</strong>: An administrator needs to grant temporary access to a contractor for a specific project. Using the WebUI, they can:</p>
<ol>
<li>Create a time-bound role “Project_Contractor_Q2”</li>
<li>Assign specific permissions (read project files, submit reports)</li>
<li>Set expiration date and IP restrictions</li>
<li>Monitor access patterns through the dashboard</li>
</ol>
<h3 id="PrivilegeFilterSDK-Integration-Component"><a href="#PrivilegeFilterSDK-Integration-Component" class="headerlink" title="PrivilegeFilterSDK (Integration Component)"></a>PrivilegeFilterSDK (Integration Component)</h3><p>A lightweight SDK that integrates with microservices to provide seamless privilege checking.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrivilegeFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PrivilegeClient privilegeClient;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, </span></span><br><span class="line"><span class="params">                        FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">httpRequest</span> <span class="operator">=</span> (HttpServletRequest) request;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Extract user context</span></span><br><span class="line">        <span class="type">UserContext</span> <span class="variable">userContext</span> <span class="operator">=</span> extractUserContext(httpRequest);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Build access request</span></span><br><span class="line">        <span class="type">AccessRequest</span> <span class="variable">accessRequest</span> <span class="operator">=</span> AccessRequest.builder()</span><br><span class="line">            .userId(userContext.getUserId())</span><br><span class="line">            .resource(httpRequest.getRequestURI())</span><br><span class="line">            .action(httpRequest.getMethod())</span><br><span class="line">            .environment(buildEnvironmentAttributes(httpRequest))</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check privileges</span></span><br><span class="line">        <span class="type">AccessDecision</span> <span class="variable">decision</span> <span class="operator">=</span> privilegeClient.evaluateAccess(accessRequest);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (decision.isPermitted()) &#123;</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sendUnauthorizedResponse(response, decision.getReason());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; <span class="title function_">buildEnvironmentAttributes</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Map.of(</span><br><span class="line">            <span class="string">&quot;ip_address&quot;</span>, getClientIP(request),</span><br><span class="line">            <span class="string">&quot;user_agent&quot;</span>, request.getHeader(<span class="string">&quot;User-Agent&quot;</span>),</span><br><span class="line">            <span class="string">&quot;time_of_day&quot;</span>, LocalTime.now().getHour(),</span><br><span class="line">            <span class="string">&quot;request_size&quot;</span>, request.getContentLength()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Question</strong>: <em>How do you handle the performance impact of privilege checking on every request?</em></p>
<p><strong>Answer</strong>: We implement a three-tier caching strategy: local cache (L1) for frequently accessed decisions, Redis (L2) for shared cache across instances, and database (L3) as the source of truth. Additionally, we use async batch loading for role hierarchies and implement circuit breakers to fail-open during service degradation.</p>
<h2 id="Three-Tier-Caching-Architecture"><a href="#Three-Tier-Caching-Architecture" class="headerlink" title="Three-Tier Caching Architecture"></a>Three-Tier Caching Architecture</h2><pre>
<code class="mermaid">
flowchart TD
A[Request] --&gt; B[L1: Local Cache]
B --&gt;|Miss| C[L2: Redis Cache]
C --&gt;|Miss| D[L3: Database]
D --&gt; E[Privilege Calculation]
E --&gt; F[Update All Cache Layers]
F --&gt; G[Return Result]

H[Cache Invalidation] --&gt; I[Event-Driven Updates]
I --&gt; J[L1 Invalidation]
I --&gt; K[L2 Invalidation]
</code>
</pre>

<h3 id="Layer-1-Local-Cache-Caffeine"><a href="#Layer-1-Local-Cache-Caffeine" class="headerlink" title="Layer 1: Local Cache (Caffeine)"></a>Layer 1: Local Cache (Caffeine)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LocalCacheConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Cache&lt;String, AccessDecision&gt; <span class="title function_">localPrivilegeCache</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Caffeine.newBuilder()</span><br><span class="line">            .maximumSize(<span class="number">10000</span>)</span><br><span class="line">            .expireAfterWrite(Duration.ofMinutes(<span class="number">5</span>))</span><br><span class="line">            .recordStats()</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Characteristics</strong>:</p>
<ul>
<li><strong>Capacity</strong>: 10,000 entries per instance</li>
<li><strong>TTL</strong>: 5 minutes</li>
<li><strong>Hit Ratio</strong>: ~85% for frequent operations</li>
<li><strong>Latency</strong>: &lt;1ms</li>
</ul>
<h3 id="Layer-2-Distributed-Cache-Redis"><a href="#Layer-2-Distributed-Cache-Redis" class="headerlink" title="Layer 2: Distributed Cache (Redis)"></a>Layer 2: Distributed Cache (Redis)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisPrivilegeCache</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, AccessDecision&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cacheUserRoles</span><span class="params">(String userId, Set&lt;Role&gt; roles)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;user:roles:&quot;</span> + userId;</span><br><span class="line">        redisTemplate.opsForValue().set(key, roles, Duration.ofMinutes(<span class="number">30</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invalidateUserCache</span><span class="params">(String userId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">pattern</span> <span class="operator">=</span> <span class="string">&quot;user:*:&quot;</span> + userId;</span><br><span class="line">        Set&lt;String&gt; keys = redisTemplate.keys(pattern);</span><br><span class="line">        <span class="keyword">if</span> (!keys.isEmpty()) &#123;</span><br><span class="line">            redisTemplate.delete(keys);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Characteristics</strong>:</p>
<ul>
<li><strong>Capacity</strong>: 1M entries cluster-wide</li>
<li><strong>TTL</strong>: 30 minutes</li>
<li><strong>Hit Ratio</strong>: ~70% for cache misses from L1</li>
<li><strong>Latency</strong>: 1-5ms</li>
</ul>
<h3 id="Layer-3-Database-PostgreSQL"><a href="#Layer-3-Database-PostgreSQL" class="headerlink" title="Layer 3: Database (PostgreSQL)"></a>Layer 3: Database (PostgreSQL)</h3><p>Persistent storage with optimized queries and indexing strategies.</p>
<p><strong>Performance Metrics</strong>:</p>
<ul>
<li><strong>Overall Cache Hit Ratio</strong>: 95%</li>
<li><strong>Average Response Time</strong>: 2ms (cached), 50ms (uncached)</li>
<li><strong>Throughput</strong>: 10,000 requests&#x2F;second per instance</li>
</ul>
<h2 id="Database-Design"><a href="#Database-Design" class="headerlink" title="Database Design"></a>Database Design</h2><h3 id="Schema-Overview"><a href="#Schema-Overview" class="headerlink" title="Schema Overview"></a>Schema Overview</h3><pre>
<code class="mermaid">
erDiagram
USER {
    uuid id PK
    string username UK
    string email UK
    timestamp created_at
    timestamp updated_at
    boolean is_active
}

ROLE {
    uuid id PK
    string name UK
    string description
    json attributes
    timestamp created_at
    boolean is_active
}

PERMISSION {
    uuid id PK
    string name UK
    string resource
    string action
    json constraints
}

USER_ROLE {
    uuid user_id FK
    uuid role_id FK
    timestamp assigned_at
    timestamp expires_at
    string assigned_by
}

ROLE_PERMISSION {
    uuid role_id FK
    uuid permission_id FK
}

ABAC_POLICY {
    uuid id PK
    string name UK
    json policy_document
    integer priority
    boolean is_active
    timestamp created_at
}

PRIVILEGE_AUDIT {
    uuid id PK
    uuid user_id FK
    string resource
    string action
    string decision
    json context
    timestamp timestamp
}

USER ||--o{ USER_ROLE : has
ROLE ||--o{ USER_ROLE : assigned_to
ROLE ||--o{ ROLE_PERMISSION : has
PERMISSION ||--o{ ROLE_PERMISSION : granted_by
</code>
</pre>

<h3 id="Detailed-Table-Schemas"><a href="#Detailed-Table-Schemas" class="headerlink" title="Detailed Table Schemas"></a>Detailed Table Schemas</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Users table with audit fields</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    id UUID <span class="keyword">PRIMARY KEY</span> <span class="keyword">DEFAULT</span> gen_random_uuid(),</span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">UNIQUE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">UNIQUE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    password_hash <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    last_login <span class="type">TIMESTAMP</span>,</span><br><span class="line">    is_active <span class="type">BOOLEAN</span> <span class="keyword">DEFAULT</span> <span class="literal">true</span>,</span><br><span class="line">    attributes JSONB <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#123;&#125;&#x27;</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> users_username_check <span class="keyword">CHECK</span> (length(username) <span class="operator">&gt;=</span> <span class="number">3</span>),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> users_email_check <span class="keyword">CHECK</span> (email <span class="operator">~</span><span class="operator">*</span> <span class="string">&#x27;^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]&#123;2,&#125;$&#x27;</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Roles table with hierarchical support</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> roles (</span><br><span class="line">    id UUID <span class="keyword">PRIMARY KEY</span> <span class="keyword">DEFAULT</span> gen_random_uuid(),</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">UNIQUE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    description TEXT,</span><br><span class="line">    parent_role_id UUID <span class="keyword">REFERENCES</span> roles(id),</span><br><span class="line">    attributes JSONB <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#123;&#125;&#x27;</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    is_active <span class="type">BOOLEAN</span> <span class="keyword">DEFAULT</span> <span class="literal">true</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> roles_name_check <span class="keyword">CHECK</span> (length(name) <span class="operator">&gt;=</span> <span class="number">2</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Permissions with resource-action pattern</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> permissions (</span><br><span class="line">    id UUID <span class="keyword">PRIMARY KEY</span> <span class="keyword">DEFAULT</span> gen_random_uuid(),</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">UNIQUE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    resource <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    action <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    constraints JSONB <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#123;&#125;&#x27;</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    <span class="keyword">UNIQUE</span>(resource, action)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- User-Role assignments with temporal constraints</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> user_roles (</span><br><span class="line">    user_id UUID <span class="keyword">NOT NULL</span> <span class="keyword">REFERENCES</span> users(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE,</span><br><span class="line">    role_id UUID <span class="keyword">NOT NULL</span> <span class="keyword">REFERENCES</span> roles(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE,</span><br><span class="line">    assigned_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    expires_at <span class="type">TIMESTAMP</span>,</span><br><span class="line">    assigned_by UUID <span class="keyword">REFERENCES</span> users(id),</span><br><span class="line">    is_active <span class="type">BOOLEAN</span> <span class="keyword">DEFAULT</span> <span class="literal">true</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (user_id, role_id),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> user_roles_expiry_check <span class="keyword">CHECK</span> (expires_at <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">OR</span> expires_at <span class="operator">&gt;</span> assigned_at)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ABAC Policies</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> abac_policies (</span><br><span class="line">    id UUID <span class="keyword">PRIMARY KEY</span> <span class="keyword">DEFAULT</span> gen_random_uuid(),</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">UNIQUE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    policy_document JSONB <span class="keyword">NOT NULL</span>,</span><br><span class="line">    priority <span class="type">INTEGER</span> <span class="keyword">DEFAULT</span> <span class="number">100</span>,</span><br><span class="line">    is_active <span class="type">BOOLEAN</span> <span class="keyword">DEFAULT</span> <span class="literal">true</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    created_by UUID <span class="keyword">REFERENCES</span> users(id),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> abac_policies_priority_check <span class="keyword">CHECK</span> (priority <span class="operator">&gt;=</span> <span class="number">0</span> <span class="keyword">AND</span> priority <span class="operator">&lt;=</span> <span class="number">1000</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Performance-optimized audit table</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> privilege_audit (</span><br><span class="line">    id UUID <span class="keyword">PRIMARY KEY</span> <span class="keyword">DEFAULT</span> gen_random_uuid(),</span><br><span class="line">    user_id UUID <span class="keyword">NOT NULL</span> <span class="keyword">REFERENCES</span> users(id),</span><br><span class="line">    resource <span class="type">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    action <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    decision <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> <span class="keyword">CHECK</span> (decision <span class="keyword">IN</span> (<span class="string">&#x27;PERMIT&#x27;</span>, <span class="string">&#x27;DENY&#x27;</span>, <span class="string">&#x27;INDETERMINATE&#x27;</span>)),</span><br><span class="line">    context JSONB <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#123;&#125;&#x27;</span>,</span><br><span class="line">    <span class="type">timestamp</span> <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    processing_time_ms <span class="type">INTEGER</span></span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span> (<span class="type">timestamp</span>);</span><br></pre></td></tr></table></figure>

<h3 id="Indexing-Strategy"><a href="#Indexing-Strategy" class="headerlink" title="Indexing Strategy"></a>Indexing Strategy</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Primary lookup indexes</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_users_username <span class="keyword">ON</span> users(username);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_users_email <span class="keyword">ON</span> users(email);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_users_active <span class="keyword">ON</span> users(is_active) <span class="keyword">WHERE</span> is_active <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Role hierarchy and permissions</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_roles_parent <span class="keyword">ON</span> roles(parent_role_id);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_user_roles_user <span class="keyword">ON</span> user_roles(user_id);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_user_roles_active <span class="keyword">ON</span> user_roles(user_id, is_active) <span class="keyword">WHERE</span> is_active <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_role_permissions_role <span class="keyword">ON</span> role_permissions(role_id);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ABAC policy lookup</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_abac_policies_active <span class="keyword">ON</span> abac_policies(is_active, priority) <span class="keyword">WHERE</span> is_active <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Audit queries</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_audit_user_time <span class="keyword">ON</span> privilege_audit(user_id, <span class="type">timestamp</span> <span class="keyword">DESC</span>);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_audit_resource <span class="keyword">ON</span> privilege_audit(resource, <span class="type">timestamp</span> <span class="keyword">DESC</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Composite indexes for complex queries</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_user_roles_expiry <span class="keyword">ON</span> user_roles(user_id, expires_at) </span><br><span class="line">    <span class="keyword">WHERE</span> expires_at <span class="keyword">IS</span> <span class="keyword">NOT NULL</span> <span class="keyword">AND</span> expires_at <span class="operator">&gt;</span> <span class="built_in">CURRENT_TIMESTAMP</span>;</span><br></pre></td></tr></table></figure>

<h2 id="RBAC-Engine-Implementation"><a href="#RBAC-Engine-Implementation" class="headerlink" title="RBAC Engine Implementation"></a>RBAC Engine Implementation</h2><h3 id="Role-Hierarchy-Support"><a href="#Role-Hierarchy-Support" class="headerlink" title="Role Hierarchy Support"></a>Role Hierarchy Support</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RbacEngine</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Set&lt;Role&gt; <span class="title function_">getEffectiveRoles</span><span class="params">(String userId)</span> &#123;</span><br><span class="line">        Set&lt;Role&gt; directRoles = userRoleRepository.findActiveRolesByUserId(userId);</span><br><span class="line">        Set&lt;Role&gt; allRoles = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(directRoles);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Resolve role hierarchy</span></span><br><span class="line">        <span class="keyword">for</span> (Role role : directRoles) &#123;</span><br><span class="line">            allRoles.addAll(getParentRoles(role));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> allRoles;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Set&lt;Role&gt; <span class="title function_">getParentRoles</span><span class="params">(Role role)</span> &#123;</span><br><span class="line">        Set&lt;Role&gt; parents = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Role</span> <span class="variable">current</span> <span class="operator">=</span> role;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> (current.getParentRole() != <span class="literal">null</span>) &#123;</span><br><span class="line">            current = current.getParentRole();</span><br><span class="line">            parents.add(current);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> parents;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> AccessDecision <span class="title function_">evaluate</span><span class="params">(AccessRequest request)</span> &#123;</span><br><span class="line">        Set&lt;Role&gt; userRoles = getEffectiveRoles(request.getUserId());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (Role role : userRoles) &#123;</span><br><span class="line">            <span class="keyword">if</span> (roleHasPermission(role, request.getResource(), request.getAction())) &#123;</span><br><span class="line">                <span class="keyword">return</span> AccessDecision.permit(<span class="string">&quot;RBAC: Role &quot;</span> + role.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> AccessDecision.deny(<span class="string">&quot;RBAC: No matching role permissions&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Use Case Example</strong>: In a corporate environment, a “Senior Developer” role inherits permissions from “Developer” role, which inherits from “Employee” role. This hierarchy allows for efficient permission management without duplicating permissions across roles.</p>
<h2 id="ABAC-Engine-Implementation"><a href="#ABAC-Engine-Implementation" class="headerlink" title="ABAC Engine Implementation"></a>ABAC Engine Implementation</h2><h3 id="Policy-Structure"><a href="#Policy-Structure" class="headerlink" title="Policy Structure"></a>Policy Structure</h3><p>ABAC policies are stored as JSON documents following the XACML-inspired structure:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time-based-access-policy&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Business Hours Access Policy&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;target&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;resources&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;api/financial/*&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;GET&quot;</span><span class="punctuation">,</span> <span class="string">&quot;POST&quot;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;business-hours-rule&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Permit&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;condition&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;and&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;timeOfDay&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="string">&quot;09:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;lte&quot;</span><span class="punctuation">:</span> <span class="string">&quot;17:00&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;dayOfWeek&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;in&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;MONDAY&quot;</span><span class="punctuation">,</span> <span class="string">&quot;TUESDAY&quot;</span><span class="punctuation">,</span> <span class="string">&quot;WEDNESDAY&quot;</span><span class="punctuation">,</span> <span class="string">&quot;THURSDAY&quot;</span><span class="punctuation">,</span> <span class="string">&quot;FRIDAY&quot;</span><span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;userAttribute.department&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;equals&quot;</span><span class="punctuation">:</span> <span class="string">&quot;FINANCE&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Policy-Evaluation-Engine"><a href="#Policy-Evaluation-Engine" class="headerlink" title="Policy Evaluation Engine"></a>Policy Evaluation Engine</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AbacEngine</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PolicyRepository policyRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> AccessDecision <span class="title function_">evaluate</span><span class="params">(AccessRequest request)</span> &#123;</span><br><span class="line">        List&lt;AbacPolicy&gt; applicablePolicies = findApplicablePolicies(request);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Sort by priority (higher number = higher priority)</span></span><br><span class="line">        applicablePolicies.sort((p1, p2) -&gt; Integer.compare(p2.getPriority(), p1.getPriority()));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (AbacPolicy policy : applicablePolicies) &#123;</span><br><span class="line">            <span class="type">PolicyDecision</span> <span class="variable">decision</span> <span class="operator">=</span> evaluatePolicy(policy, request);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">switch</span> (decision.getEffect()) &#123;</span><br><span class="line">                <span class="keyword">case</span> PERMIT:</span><br><span class="line">                    <span class="keyword">return</span> AccessDecision.permit(<span class="string">&quot;ABAC: &quot;</span> + policy.getName());</span><br><span class="line">                <span class="keyword">case</span> DENY:</span><br><span class="line">                    <span class="keyword">return</span> AccessDecision.deny(<span class="string">&quot;ABAC: &quot;</span> + policy.getName());</span><br><span class="line">                <span class="keyword">case</span> INDETERMINATE:</span><br><span class="line">                    <span class="keyword">continue</span>; <span class="comment">// Try next policy</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> AccessDecision.deny(<span class="string">&quot;ABAC: No applicable policies&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> PolicyDecision <span class="title function_">evaluatePolicy</span><span class="params">(AbacPolicy policy, AccessRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">PolicyDocument</span> <span class="variable">document</span> <span class="operator">=</span> policy.getPolicyDocument();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Check if policy target matches request</span></span><br><span class="line">            <span class="keyword">if</span> (!matchesTarget(document.getTarget(), request)) &#123;</span><br><span class="line">                <span class="keyword">return</span> PolicyDecision.indeterminate();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Evaluate all rules</span></span><br><span class="line">            <span class="keyword">for</span> (PolicyRule rule : document.getRules()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (evaluateCondition(rule.getCondition(), request)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> PolicyDecision.of(rule.getEffect());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> PolicyDecision.indeterminate();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Error evaluating policy: &quot;</span> + policy.getId(), e);</span><br><span class="line">            <span class="keyword">return</span> PolicyDecision.indeterminate();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Question</strong>: <em>How do you handle policy conflicts in ABAC?</em></p>
<p><strong>Answer</strong>: We use a priority-based approach where policies are evaluated in order of priority. The first policy that returns a definitive decision (PERMIT or DENY) wins. For same-priority policies, we use policy combining algorithms like “deny-overrides” or “permit-overrides” based on the security requirements. We also implement policy validation to detect potential conflicts at creation time.</p>
<h2 id="Security-Considerations"><a href="#Security-Considerations" class="headerlink" title="Security Considerations"></a>Security Considerations</h2><h3 id="Principle-of-Least-Privilege"><a href="#Principle-of-Least-Privilege" class="headerlink" title="Principle of Least Privilege"></a>Principle of Least Privilege</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrivilegeAnalyzer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> PrivilegeAnalysisReport <span class="title function_">analyzeUserPrivileges</span><span class="params">(String userId)</span> &#123;</span><br><span class="line">        Set&lt;Permission&gt; grantedPermissions = getAllUserPermissions(userId);</span><br><span class="line">        Set&lt;Permission&gt; usedPermissions = getUsedPermissions(userId, Duration.ofDays(<span class="number">30</span>));</span><br><span class="line">        </span><br><span class="line">        Set&lt;Permission&gt; unusedPermissions = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(grantedPermissions);</span><br><span class="line">        unusedPermissions.removeAll(usedPermissions);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> PrivilegeAnalysisReport.builder()</span><br><span class="line">            .userId(userId)</span><br><span class="line">            .totalGranted(grantedPermissions.size())</span><br><span class="line">            .totalUsed(usedPermissions.size())</span><br><span class="line">            .unusedPermissions(unusedPermissions)</span><br><span class="line">            .riskScore(calculateRiskScore(unusedPermissions))</span><br><span class="line">            .recommendations(generateRecommendations(unusedPermissions))</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Audit-and-Compliance"><a href="#Audit-and-Compliance" class="headerlink" title="Audit and Compliance"></a>Audit and Compliance</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EventListener</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrivilegeAuditListener</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleAccessDecision</span><span class="params">(AccessDecisionEvent event)</span> &#123;</span><br><span class="line">        <span class="type">PrivilegeAuditRecord</span> <span class="variable">record</span> <span class="operator">=</span> PrivilegeAuditRecord.builder()</span><br><span class="line">            .userId(event.getUserId())</span><br><span class="line">            .resource(event.getResource())</span><br><span class="line">            .action(event.getAction())</span><br><span class="line">            .decision(event.getDecision())</span><br><span class="line">            .context(event.getContext())</span><br><span class="line">            .timestamp(Instant.now())</span><br><span class="line">            .processingTimeMs(event.getProcessingTime())</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        auditRepository.save(record);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Real-time alerting for suspicious activities</span></span><br><span class="line">        <span class="keyword">if</span> (isSuspiciousActivity(record)) &#123;</span><br><span class="line">            alertService.sendSecurityAlert(record);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Optimization"><a href="#Performance-Optimization" class="headerlink" title="Performance Optimization"></a>Performance Optimization</h2><h3 id="Batch-Processing-for-Role-Assignments"><a href="#Batch-Processing-for-Role-Assignments" class="headerlink" title="Batch Processing for Role Assignments"></a>Batch Processing for Role Assignments</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BulkPrivilegeService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bulkAssignRoles</span><span class="params">(List&lt;UserRoleAssignment&gt; assignments)</span> &#123;</span><br><span class="line">        <span class="comment">// Validate all assignments first</span></span><br><span class="line">        validateAssignments(assignments);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Group by user for efficient processing</span></span><br><span class="line">        Map&lt;String, List&lt;UserRoleAssignment&gt;&gt; byUser = assignments.stream()</span><br><span class="line">            .collect(Collectors.groupingBy(UserRoleAssignment::getUserId));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Process in batches to avoid memory issues</span></span><br><span class="line">        Lists.partition(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(byUser.entrySet()), <span class="number">100</span>)</span><br><span class="line">            .forEach(batch -&gt; processBatch(batch));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Invalidate cache for affected users</span></span><br><span class="line">        Set&lt;String&gt; affectedUsers = assignments.stream()</span><br><span class="line">            .map(UserRoleAssignment::getUserId)</span><br><span class="line">            .collect(Collectors.toSet());</span><br><span class="line">        </span><br><span class="line">        cacheManager.invalidateUsers(affectedUsers);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Query-Optimization"><a href="#Query-Optimization" class="headerlink" title="Query Optimization"></a>Query Optimization</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OptimizedUserRoleRepository</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Query(value = &quot;&quot;&quot;</span></span><br><span class="line"><span class="meta">        SELECT r.* FROM roles r</span></span><br><span class="line"><span class="meta">        JOIN user_roles ur ON r.id = ur.role_id</span></span><br><span class="line"><span class="meta">        WHERE ur.user_id = :userId</span></span><br><span class="line"><span class="meta">        AND ur.is_active = true</span></span><br><span class="line"><span class="meta">        AND (ur.expires_at IS NULL OR ur.expires_at &gt; CURRENT_TIMESTAMP)</span></span><br><span class="line"><span class="meta">        AND r.is_active = true</span></span><br><span class="line"><span class="meta">        &quot;&quot;&quot;, nativeQuery = true)</span></span><br><span class="line">    List&lt;Role&gt; <span class="title function_">findActiveRolesByUserId</span><span class="params">(<span class="meta">@Param(&quot;userId&quot;)</span> String userId)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Query(value = &quot;&quot;&quot;</span></span><br><span class="line"><span class="meta">        WITH RECURSIVE role_hierarchy AS (</span></span><br><span class="line"><span class="meta">            SELECT id, name, parent_role_id, 0 as level</span></span><br><span class="line"><span class="meta">            FROM roles</span></span><br><span class="line"><span class="meta">            WHERE id IN :roleIds</span></span><br><span class="line"><span class="meta">            </span></span><br><span class="line"><span class="meta">            UNION ALL</span></span><br><span class="line"><span class="meta">            </span></span><br><span class="line"><span class="meta">            SELECT r.id, r.name, r.parent_role_id, rh.level + 1</span></span><br><span class="line"><span class="meta">            FROM roles r</span></span><br><span class="line"><span class="meta">            JOIN role_hierarchy rh ON r.id = rh.parent_role_id</span></span><br><span class="line"><span class="meta">            WHERE rh.level &lt; 10</span></span><br><span class="line"><span class="meta">        )</span></span><br><span class="line"><span class="meta">        SELECT DISTINCT * FROM role_hierarchy</span></span><br><span class="line"><span class="meta">        &quot;&quot;&quot;, nativeQuery = true)</span></span><br><span class="line">    List&lt;Role&gt; <span class="title function_">findRoleHierarchy</span><span class="params">(<span class="meta">@Param(&quot;roleIds&quot;)</span> Set&lt;String&gt; roleIds)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Monitoring-and-Observability"><a href="#Monitoring-and-Observability" class="headerlink" title="Monitoring and Observability"></a>Monitoring and Observability</h2><h3 id="Metrics-Collection"><a href="#Metrics-Collection" class="headerlink" title="Metrics Collection"></a>Metrics Collection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrivilegeMetrics</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Counter</span> <span class="variable">accessDecisions</span> <span class="operator">=</span> Counter.build()</span><br><span class="line">        .name(<span class="string">&quot;privilege_access_decisions_total&quot;</span>)</span><br><span class="line">        .help(<span class="string">&quot;Total number of access decisions&quot;</span>)</span><br><span class="line">        .labelNames(<span class="string">&quot;decision&quot;</span>, <span class="string">&quot;engine&quot;</span>)</span><br><span class="line">        .register();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Histogram</span> <span class="variable">decisionLatency</span> <span class="operator">=</span> Histogram.build()</span><br><span class="line">        .name(<span class="string">&quot;privilege_decision_duration_seconds&quot;</span>)</span><br><span class="line">        .help(<span class="string">&quot;Time spent on access decisions&quot;</span>)</span><br><span class="line">        .labelNames(<span class="string">&quot;engine&quot;</span>)</span><br><span class="line">        .register();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Gauge</span> <span class="variable">cacheHitRatio</span> <span class="operator">=</span> Gauge.build()</span><br><span class="line">        .name(<span class="string">&quot;privilege_cache_hit_ratio&quot;</span>)</span><br><span class="line">        .help(<span class="string">&quot;Cache hit ratio for privilege decisions&quot;</span>)</span><br><span class="line">        .labelNames(<span class="string">&quot;cache_layer&quot;</span>)</span><br><span class="line">        .register();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordDecision</span><span class="params">(String decision, String engine, Duration duration)</span> &#123;</span><br><span class="line">        accessDecisions.labels(decision, engine).inc();</span><br><span class="line">        decisionLatency.labels(engine).observe(duration.toMillis() / <span class="number">1000.0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Health-Checks"><a href="#Health-Checks" class="headerlink" title="Health Checks"></a>Health Checks</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrivilegeHealthIndicator</span> <span class="keyword">implements</span> <span class="title class_">HealthIndicator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Health <span class="title function_">health</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Check database connectivity</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">dbResponseTime</span> <span class="operator">=</span> measureDatabaseHealth();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Check cache performance</span></span><br><span class="line">            <span class="type">double</span> <span class="variable">cacheHitRatio</span> <span class="operator">=</span> measureCacheHealth();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Check policy evaluation performance</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">avgDecisionTime</span> <span class="operator">=</span> measureDecisionPerformance();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (dbResponseTime &gt; <span class="number">100</span> || cacheHitRatio &lt; <span class="number">0.8</span> || avgDecisionTime &gt; <span class="number">50</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> Health.down()</span><br><span class="line">                    .withDetail(<span class="string">&quot;database_response_time&quot;</span>, dbResponseTime)</span><br><span class="line">                    .withDetail(<span class="string">&quot;cache_hit_ratio&quot;</span>, cacheHitRatio)</span><br><span class="line">                    .withDetail(<span class="string">&quot;avg_decision_time&quot;</span>, avgDecisionTime)</span><br><span class="line">                    .build();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> Health.up()</span><br><span class="line">                .withDetail(<span class="string">&quot;database_response_time&quot;</span>, dbResponseTime)</span><br><span class="line">                .withDetail(<span class="string">&quot;cache_hit_ratio&quot;</span>, cacheHitRatio)</span><br><span class="line">                .withDetail(<span class="string">&quot;avg_decision_time&quot;</span>, avgDecisionTime)</span><br><span class="line">                .build();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> Health.down().withException(e).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Testing-Strategy"><a href="#Testing-Strategy" class="headerlink" title="Testing Strategy"></a>Testing Strategy</h2><h3 id="Unit-Testing"><a href="#Unit-Testing" class="headerlink" title="Unit Testing"></a>Unit Testing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExtendWith(MockitoExtension.class)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RbacEngineTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> UserRoleRepository userRoleRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@InjectMocks</span></span><br><span class="line">    <span class="keyword">private</span> RbacEngine rbacEngine;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldPermitAccessWhenUserHasRequiredRole</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Given</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> <span class="string">&quot;user123&quot;</span>;</span><br><span class="line">        <span class="type">Role</span> <span class="variable">developerRole</span> <span class="operator">=</span> createRole(<span class="string">&quot;DEVELOPER&quot;</span>);</span><br><span class="line">        <span class="type">Permission</span> <span class="variable">readCodePermission</span> <span class="operator">=</span> createPermission(<span class="string">&quot;code&quot;</span>, <span class="string">&quot;read&quot;</span>);</span><br><span class="line">        developerRole.addPermission(readCodePermission);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">when</span>(userRoleRepository.findActiveRolesByUserId(userId))</span><br><span class="line">            .thenReturn(Set.of(developerRole));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When</span></span><br><span class="line">        <span class="type">AccessRequest</span> <span class="variable">request</span> <span class="operator">=</span> AccessRequest.builder()</span><br><span class="line">            .userId(userId)</span><br><span class="line">            .resource(<span class="string">&quot;code&quot;</span>)</span><br><span class="line">            .action(<span class="string">&quot;read&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="type">AccessDecision</span> <span class="variable">decision</span> <span class="operator">=</span> rbacEngine.evaluate(request);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Then</span></span><br><span class="line">        assertThat(decision.isPermitted()).isTrue();</span><br><span class="line">        assertThat(decision.getReason()).contains(<span class="string">&quot;RBAC: Role DEVELOPER&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldInheritPermissionsFromParentRole</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Given</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> <span class="string">&quot;user123&quot;</span>;</span><br><span class="line">        <span class="type">Role</span> <span class="variable">employeeRole</span> <span class="operator">=</span> createRole(<span class="string">&quot;EMPLOYEE&quot;</span>);</span><br><span class="line">        <span class="type">Role</span> <span class="variable">managerRole</span> <span class="operator">=</span> createRole(<span class="string">&quot;MANAGER&quot;</span>, employeeRole);</span><br><span class="line">        </span><br><span class="line">        <span class="type">Permission</span> <span class="variable">basePermission</span> <span class="operator">=</span> createPermission(<span class="string">&quot;dashboard&quot;</span>, <span class="string">&quot;read&quot;</span>);</span><br><span class="line">        employeeRole.addPermission(basePermission);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">when</span>(userRoleRepository.findActiveRolesByUserId(userId))</span><br><span class="line">            .thenReturn(Set.of(managerRole));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When</span></span><br><span class="line">        <span class="type">AccessRequest</span> <span class="variable">request</span> <span class="operator">=</span> AccessRequest.builder()</span><br><span class="line">            .userId(userId)</span><br><span class="line">            .resource(<span class="string">&quot;dashboard&quot;</span>)</span><br><span class="line">            .action(<span class="string">&quot;read&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="type">AccessDecision</span> <span class="variable">decision</span> <span class="operator">=</span> rbacEngine.evaluate(request);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Then</span></span><br><span class="line">        assertThat(decision.isPermitted()).isTrue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Integration-Testing"><a href="#Integration-Testing" class="headerlink" title="Integration Testing"></a>Integration Testing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Testcontainers</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PrivilegeServiceIntegrationTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Container</span></span><br><span class="line">    <span class="keyword">static</span> PostgreSQLContainer&lt;?&gt; postgres = <span class="keyword">new</span> <span class="title class_">PostgreSQLContainer</span>&lt;&gt;(<span class="string">&quot;postgres:13&quot;</span>)</span><br><span class="line">            .withDatabaseName(<span class="string">&quot;privilege_test&quot;</span>)</span><br><span class="line">            .withUsername(<span class="string">&quot;test&quot;</span>)</span><br><span class="line">            .withPassword(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Container</span></span><br><span class="line">    <span class="keyword">static</span> GenericContainer&lt;?&gt; redis = <span class="keyword">new</span> <span class="title class_">GenericContainer</span>&lt;&gt;(<span class="string">&quot;redis:6&quot;</span>)</span><br><span class="line">            .withExposedPorts(<span class="number">6379</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldCacheAccessDecisions</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Given</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> createTestUser();</span><br><span class="line">        <span class="type">String</span> <span class="variable">roleId</span> <span class="operator">=</span> createTestRole();</span><br><span class="line">        assignRoleToUser(userId, roleId);</span><br><span class="line">        </span><br><span class="line">        <span class="type">AccessRequest</span> <span class="variable">request</span> <span class="operator">=</span> AccessRequest.builder()</span><br><span class="line">            .userId(userId)</span><br><span class="line">            .resource(<span class="string">&quot;test-resource&quot;</span>)</span><br><span class="line">            .action(<span class="string">&quot;read&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When - First call</span></span><br><span class="line">        <span class="type">Instant</span> <span class="variable">start1</span> <span class="operator">=</span> Instant.now();</span><br><span class="line">        <span class="type">AccessDecision</span> <span class="variable">decision1</span> <span class="operator">=</span> privilegeService.evaluateAccess(request);</span><br><span class="line">        <span class="type">Duration</span> <span class="variable">duration1</span> <span class="operator">=</span> Duration.between(start1, Instant.now());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When - Second call (should be cached)</span></span><br><span class="line">        <span class="type">Instant</span> <span class="variable">start2</span> <span class="operator">=</span> Instant.now();</span><br><span class="line">        <span class="type">AccessDecision</span> <span class="variable">decision2</span> <span class="operator">=</span> privilegeService.evaluateAccess(request);</span><br><span class="line">        <span class="type">Duration</span> <span class="variable">duration2</span> <span class="operator">=</span> Duration.between(start2, Instant.now());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Then</span></span><br><span class="line">        assertThat(decision1).isEqualTo(decision2);</span><br><span class="line">        assertThat(duration2).isLessThan(duration1.dividedBy(<span class="number">2</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Deployment-Considerations"><a href="#Deployment-Considerations" class="headerlink" title="Deployment Considerations"></a>Deployment Considerations</h2><h3 id="Kubernetes-Deployment"><a href="#Kubernetes-Deployment" class="headerlink" title="Kubernetes Deployment"></a>Kubernetes Deployment</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">privilege-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">privilege-service</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">privilege-service</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">privilege-service</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">privilege-service:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_PROFILES_ACTIVE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;production&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DATABASE_URL</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">db-secret</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">url</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">REDIS_URL</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">redis-secret</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">url</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;512Mi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/actuator/health</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/actuator/health/readiness</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>

<h3 id="Database-Migration-Strategy"><a href="#Database-Migration-Strategy" class="headerlink" title="Database Migration Strategy"></a>Database Migration Strategy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrivilegeMigrationService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="meta">@Order(1)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationReady</span><span class="params">(ApplicationReadyEvent event)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isNewDeployment()) &#123;</span><br><span class="line">            createDefaultRolesAndPermissions();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (requiresDataMigration()) &#123;</span><br><span class="line">            migrateExistingData();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        validateSystemIntegrity();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">createDefaultRolesAndPermissions</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Create system administrator role</span></span><br><span class="line">        <span class="type">Role</span> <span class="variable">adminRole</span> <span class="operator">=</span> roleService.createRole(<span class="string">&quot;SYSTEM_ADMIN&quot;</span>, <span class="string">&quot;System Administrator&quot;</span>);</span><br><span class="line">        <span class="type">Permission</span> <span class="variable">allPermissions</span> <span class="operator">=</span> permissionService.createPermission(<span class="string">&quot;*&quot;</span>, <span class="string">&quot;*&quot;</span>);</span><br><span class="line">        roleService.assignPermission(adminRole.getId(), allPermissions.getId());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Create default user role</span></span><br><span class="line">        <span class="type">Role</span> <span class="variable">userRole</span> <span class="operator">=</span> roleService.createRole(<span class="string">&quot;USER&quot;</span>, <span class="string">&quot;Default User&quot;</span>);</span><br><span class="line">        <span class="type">Permission</span> <span class="variable">readProfile</span> <span class="operator">=</span> permissionService.createPermission(<span class="string">&quot;profile&quot;</span>, <span class="string">&quot;read&quot;</span>);</span><br><span class="line">        roleService.assignPermission(userRole.getId(), readProfile.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Real-World-Use-Cases"><a href="#Real-World-Use-Cases" class="headerlink" title="Real-World Use Cases"></a>Real-World Use Cases</h2><h3 id="Enterprise-SaaS-Platform"><a href="#Enterprise-SaaS-Platform" class="headerlink" title="Enterprise SaaS Platform"></a>Enterprise SaaS Platform</h3><p><strong>Scenario</strong>: A multi-tenant SaaS platform needs to support different organizations with varying access control requirements.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantAwarePrivilegeService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> AccessDecision <span class="title function_">evaluateTenantAccess</span><span class="params">(AccessRequest request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> request.getContext().get(<span class="string">&quot;tenant_id&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// RBAC: Check user roles within tenant</span></span><br><span class="line">        Set&lt;Role&gt; tenantRoles = getUserRolesInTenant(request.getUserId(), tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ABAC: Apply tenant-specific policies</span></span><br><span class="line">        <span class="type">AbacContext</span> <span class="variable">context</span> <span class="operator">=</span> AbacContext.builder()</span><br><span class="line">            .userAttributes(getUserAttributes(request.getUserId()))</span><br><span class="line">            .resourceAttributes(getResourceAttributes(request.getResource()))</span><br><span class="line">            .environmentAttributes(Map.of(</span><br><span class="line">                <span class="string">&quot;tenant_id&quot;</span>, tenantId,</span><br><span class="line">                <span class="string">&quot;subscription_level&quot;</span>, getTenantSubscription(tenantId),</span><br><span class="line">                <span class="string">&quot;data_residency&quot;</span>, getTenantDataResidency(tenantId)</span><br><span class="line">            ))</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> evaluateWithContext(request, context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ABAC Policy Example for Tenant Isolation</strong>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tenant-data-isolation-policy&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;target&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;resources&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;api/data/*&quot;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Deny&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;condition&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;not&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;equals&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span><span class="attr">&quot;var&quot;</span><span class="punctuation">:</span> <span class="string">&quot;resource.tenant_id&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span><span class="attr">&quot;var&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user.tenant_id&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Healthcare-System-HIPAA-Compliance"><a href="#Healthcare-System-HIPAA-Compliance" class="headerlink" title="Healthcare System HIPAA Compliance"></a>Healthcare System HIPAA Compliance</h3><p><strong>Scenario</strong>: A healthcare system requires strict access controls with audit trails for HIPAA compliance.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HipaaPrivilegeEnforcer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PatientConsentService consentService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> AccessDecision <span class="title function_">evaluatePatientDataAccess</span><span class="params">(AccessRequest request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">patientId</span> <span class="operator">=</span> extractPatientId(request.getResource());</span><br><span class="line">        <span class="type">String</span> <span class="variable">providerId</span> <span class="operator">=</span> request.getUserId();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check if provider has active treatment relationship</span></span><br><span class="line">        <span class="keyword">if</span> (!hasActiveTreatmentRelationship(providerId, patientId)) &#123;</span><br><span class="line">            <span class="keyword">return</span> AccessDecision.deny(<span class="string">&quot;No active treatment relationship&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check patient consent</span></span><br><span class="line">        <span class="keyword">if</span> (!consentService.hasValidConsent(patientId, providerId)) &#123;</span><br><span class="line">            <span class="keyword">return</span> AccessDecision.deny(<span class="string">&quot;Patient consent required&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Apply break-glass emergency access</span></span><br><span class="line">        <span class="keyword">if</span> (isEmergencyAccess(request)) &#123;</span><br><span class="line">            auditService.recordEmergencyAccess(request);</span><br><span class="line">            <span class="keyword">return</span> AccessDecision.permit(<span class="string">&quot;Emergency access granted&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.evaluate(request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Financial-Services-Regulatory-Compliance"><a href="#Financial-Services-Regulatory-Compliance" class="headerlink" title="Financial Services Regulatory Compliance"></a>Financial Services Regulatory Compliance</h3><p><strong>Scenario</strong>: A financial institution needs to implement segregation of duties and time-bound access for regulatory compliance.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FinancialPrivilegeService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> AccessDecision <span class="title function_">evaluateFinancialTransaction</span><span class="params">(AccessRequest request)</span> &#123;</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">amount</span> <span class="operator">=</span> extractTransactionAmount(request);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Four-eyes principle for high-value transactions</span></span><br><span class="line">        <span class="keyword">if</span> (amount.compareTo(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;10000&quot;</span>)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> evaluateDualApproval(request);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Time-based trading restrictions</span></span><br><span class="line">        <span class="keyword">if</span> (isTradingResource(request.getResource())) &#123;</span><br><span class="line">            <span class="keyword">return</span> evaluateTradingHours(request);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.evaluate(request);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> AccessDecision <span class="title function_">evaluateDualApproval</span><span class="params">(AccessRequest request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">transactionId</span> <span class="operator">=</span> request.getContext().get(<span class="string">&quot;transaction_id&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check if another user has already approved</span></span><br><span class="line">        Optional&lt;Approval&gt; existingApproval = approvalService</span><br><span class="line">            .findPendingApproval(transactionId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (existingApproval.isPresent() &amp;&amp; </span><br><span class="line">            !existingApproval.get().getApproverId().equals(request.getUserId())) &#123;</span><br><span class="line">            <span class="keyword">return</span> AccessDecision.permit(<span class="string">&quot;Dual approval satisfied&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Create pending approval</span></span><br><span class="line">        approvalService.createPendingApproval(transactionId, request.getUserId());</span><br><span class="line">        <span class="keyword">return</span> AccessDecision.deny(<span class="string">&quot;Awaiting second approval&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Advanced-Features"><a href="#Advanced-Features" class="headerlink" title="Advanced Features"></a>Advanced Features</h2><h3 id="Dynamic-Permission-Discovery"><a href="#Dynamic-Permission-Discovery" class="headerlink" title="Dynamic Permission Discovery"></a>Dynamic Permission Discovery</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicPermissionService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Automatically discovers and registers permissions from controller annotations</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">discoverPermissions</span><span class="params">(ApplicationReadyEvent event)</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> event.getApplicationContext();</span><br><span class="line">        </span><br><span class="line">        context.getBeansWithAnnotation(RestController.class).values()</span><br><span class="line">            .forEach(<span class="built_in">this</span>::scanControllerForPermissions);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">scanControllerForPermissions</span><span class="params">(Object controller)</span> &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = AopUtils.getTargetClass(controller);</span><br><span class="line">        <span class="type">RequestMapping</span> <span class="variable">classMapping</span> <span class="operator">=</span> clazz.getAnnotation(RequestMapping.class);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (Method method : clazz.getDeclaredMethods()) &#123;</span><br><span class="line">            <span class="type">RequiresPermission</span> <span class="variable">permissionAnnotation</span> <span class="operator">=</span> </span><br><span class="line">                method.getAnnotation(RequiresPermission.class);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (permissionAnnotation != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">resource</span> <span class="operator">=</span> buildResourcePath(classMapping, method);</span><br><span class="line">                <span class="type">String</span> <span class="variable">action</span> <span class="operator">=</span> extractAction(method);</span><br><span class="line">                </span><br><span class="line">                permissionService.registerPermission(</span><br><span class="line">                    permissionAnnotation.value(),</span><br><span class="line">                    resource,</span><br><span class="line">                    action,</span><br><span class="line">                    permissionAnnotation.description()</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> RequiresPermission &#123;</span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span>;</span><br><span class="line">    String <span class="title function_">description</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    String[] conditions() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Policy-Templates"><a href="#Policy-Templates" class="headerlink" title="Policy Templates"></a>Policy Templates</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PolicyTemplateService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, PolicyTemplate&gt; TEMPLATES = Map.of(</span><br><span class="line">        <span class="string">&quot;time_restricted&quot;</span>, <span class="keyword">new</span> <span class="title class_">TimeRestrictedTemplate</span>(),</span><br><span class="line">        <span class="string">&quot;ip_restricted&quot;</span>, <span class="keyword">new</span> <span class="title class_">IpRestrictedTemplate</span>(),</span><br><span class="line">        <span class="string">&quot;department_scoped&quot;</span>, <span class="keyword">new</span> <span class="title class_">DepartmentScopedTemplate</span>(),</span><br><span class="line">        <span class="string">&quot;temporary_access&quot;</span>, <span class="keyword">new</span> <span class="title class_">TemporaryAccessTemplate</span>()</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> AbacPolicy <span class="title function_">createPolicyFromTemplate</span><span class="params">(String templateName, </span></span><br><span class="line"><span class="params">                                               Map&lt;String, Object&gt; parameters)</span> &#123;</span><br><span class="line">        <span class="type">PolicyTemplate</span> <span class="variable">template</span> <span class="operator">=</span> TEMPLATES.get(templateName);</span><br><span class="line">        <span class="keyword">if</span> (template == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unknown template: &quot;</span> + templateName);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> template.generatePolicy(parameters);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimeRestrictedTemplate</span> <span class="keyword">implements</span> <span class="title class_">PolicyTemplate</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AbacPolicy <span class="title function_">generatePolicy</span><span class="params">(Map&lt;String, Object&gt; params)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">startTime</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;start_time&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">endTime</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;end_time&quot;</span>);</span><br><span class="line">        List&lt;String&gt; allowedDays = (List&lt;String&gt;) params.get(<span class="string">&quot;allowed_days&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">PolicyDocument</span> <span class="variable">document</span> <span class="operator">=</span> PolicyDocument.builder()</span><br><span class="line">            .rule(PolicyRule.builder()</span><br><span class="line">                .effect(Effect.PERMIT)</span><br><span class="line">                .condition(buildTimeCondition(startTime, endTime, allowedDays))</span><br><span class="line">                .build())</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> AbacPolicy.builder()</span><br><span class="line">            .name(<span class="string">&quot;time-restricted-&quot;</span> + UUID.randomUUID())</span><br><span class="line">            .policyDocument(document)</span><br><span class="line">            .priority(<span class="number">100</span>)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Machine-Learning-Integration"><a href="#Machine-Learning-Integration" class="headerlink" title="Machine Learning Integration"></a>Machine Learning Integration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnomalousAccessDetector</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccessPatternAnalyzer patternAnalyzer;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">analyzeAccessPattern</span><span class="params">(AccessDecisionEvent event)</span> &#123;</span><br><span class="line">        <span class="type">AccessPattern</span> <span class="variable">pattern</span> <span class="operator">=</span> AccessPattern.builder()</span><br><span class="line">            .userId(event.getUserId())</span><br><span class="line">            .resource(event.getResource())</span><br><span class="line">            .action(event.getAction())</span><br><span class="line">            .timestamp(event.getTimestamp())</span><br><span class="line">            .ipAddress(event.getContext().get(<span class="string">&quot;ip_address&quot;</span>))</span><br><span class="line">            .userAgent(event.getContext().get(<span class="string">&quot;user_agent&quot;</span>))</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="type">double</span> <span class="variable">anomalyScore</span> <span class="operator">=</span> patternAnalyzer.calculateAnomalyScore(pattern);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (anomalyScore &gt; <span class="number">0.8</span>) &#123;</span><br><span class="line">            <span class="type">SecurityAlert</span> <span class="variable">alert</span> <span class="operator">=</span> SecurityAlert.builder()</span><br><span class="line">                .userId(event.getUserId())</span><br><span class="line">                .alertType(<span class="string">&quot;ANOMALOUS_ACCESS&quot;</span>)</span><br><span class="line">                .severity(Severity.HIGH)</span><br><span class="line">                .description(<span class="string">&quot;Unusual access pattern detected&quot;</span>)</span><br><span class="line">                .anomalyScore(anomalyScore)</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">            alertService.sendAlert(alert);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Temporarily increase scrutiny for this user</span></span><br><span class="line">            privilegeService.enableEnhancedMonitoring(event.getUserId(), </span><br><span class="line">                Duration.ofHours(<span class="number">24</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Benchmarks"><a href="#Performance-Benchmarks" class="headerlink" title="Performance Benchmarks"></a>Performance Benchmarks</h2><h3 id="Load-Testing-Results"><a href="#Load-Testing-Results" class="headerlink" title="Load Testing Results"></a>Load Testing Results</h3><p><strong>Test Environment</strong>:</p>
<ul>
<li>3 application instances (2 CPU, 4GB RAM each)</li>
<li>PostgreSQL (4 CPU, 8GB RAM)</li>
<li>Redis Cluster (3 nodes, 2GB RAM each)</li>
</ul>
<p><strong>Results</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Scenario: Mixed RBAC/ABAC evaluation</span><br><span class="line">├── Concurrent Users: 1000</span><br><span class="line">├── Test Duration: 10 minutes</span><br><span class="line">├── Total Requests: 2,847,293</span><br><span class="line">├── Average Response Time: 3.2ms</span><br><span class="line">├── 95th Percentile: 8.5ms</span><br><span class="line">├── 99th Percentile: 15.2ms</span><br><span class="line">├── Error Rate: 0.02%</span><br><span class="line">└── Throughput: 4,745 RPS</span><br><span class="line"></span><br><span class="line">Cache Performance:</span><br><span class="line">├── L1 Cache Hit Rate: 87.3%</span><br><span class="line">├── L2 Cache Hit Rate: 11.8%</span><br><span class="line">├── Database Queries: 0.9%</span><br><span class="line">└── Average Decision Time: 1.8ms (cached), 45ms (uncached)</span><br></pre></td></tr></table></figure>

<h3 id="Memory-Usage-Optimization"><a href="#Memory-Usage-Optimization" class="headerlink" title="Memory Usage Optimization"></a>Memory Usage Optimization</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemoryOptimizationConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty(name = &quot;privilege.optimization.memory&quot;, havingValue = &quot;true&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> PrivilegeService <span class="title function_">optimizedPrivilegeService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MemoryOptimizedPrivilegeService</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemoryOptimizedPrivilegeService</span> <span class="keyword">extends</span> <span class="title class_">PrivilegeService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Use flyweight pattern for common permissions</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Permission&gt; permissionFlyweights = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Weak references for rarely accessed data</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WeakHashMap&lt;String, Set&lt;Role&gt;&gt; userRoleCache = <span class="keyword">new</span> <span class="title class_">WeakHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Compressed storage for policy documents</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">PolicyCompressor</span> <span class="variable">policyCompressor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PolicyCompressor</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Set&lt;Permission&gt; <span class="title function_">getUserPermissions</span><span class="params">(String userId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userRoleCache.computeIfAbsent(userId, <span class="built_in">this</span>::loadUserRoles)</span><br><span class="line">            .stream()</span><br><span class="line">            .flatMap(role -&gt; role.getPermissions().stream())</span><br><span class="line">            .map(<span class="built_in">this</span>::getFlyweightPermission)</span><br><span class="line">            .collect(Collectors.toSet());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Interview-Questions-and-Answers"><a href="#Interview-Questions-and-Answers" class="headerlink" title="Interview Questions and Answers"></a>Interview Questions and Answers</h2><h3 id="Architecture-Questions"><a href="#Architecture-Questions" class="headerlink" title="Architecture Questions"></a>Architecture Questions</h3><p><strong>Q: How would you handle a situation where the privilege service becomes unavailable?</strong></p>
<p><strong>A</strong>: Implement a circuit breaker pattern with graceful degradation:</p>
<ol>
<li><strong>Circuit Breaker</strong>: Use Hystrix or Resilience4j to detect service failures</li>
<li><strong>Fallback Strategy</strong>: Cache recent decisions locally and apply “fail-secure” or “fail-open” policies based on criticality</li>
<li><strong>Emergency Roles</strong>: Pre-configure emergency access roles that work offline</li>
<li><strong>Async Recovery</strong>: Queue privilege decisions for later verification when service recovers</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResilientPrivilegeService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@CircuitBreaker(name = &quot;privilege-service&quot;, fallbackMethod = &quot;fallbackEvaluate&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> AccessDecision <span class="title function_">evaluate</span><span class="params">(AccessRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> privilegeService.evaluateAccess(request);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> AccessDecision <span class="title function_">fallbackEvaluate</span><span class="params">(AccessRequest request, Exception ex)</span> &#123;</span><br><span class="line">        <span class="comment">// Check local emergency cache</span></span><br><span class="line">        <span class="type">AccessDecision</span> <span class="variable">cached</span> <span class="operator">=</span> emergencyCache.get(request);</span><br><span class="line">        <span class="keyword">if</span> (cached != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> cached;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Apply default policy based on resource criticality</span></span><br><span class="line">        <span class="keyword">if</span> (isCriticalResource(request.getResource())) &#123;</span><br><span class="line">            <span class="keyword">return</span> AccessDecision.deny(<span class="string">&quot;Service unavailable - fail secure&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> AccessDecision.permit(<span class="string">&quot;Service unavailable - fail open&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Q: How do you ensure consistency across multiple instances of the privilege service?</strong></p>
<p><strong>A</strong>: Use distributed caching with event-driven invalidation:</p>
<ol>
<li><strong>Distributed Cache</strong>: Redis cluster for shared state</li>
<li><strong>Event Sourcing</strong>: Publish privilege change events</li>
<li><strong>Cache Invalidation</strong>: Listen to events and invalidate affected cache entries</li>
<li><strong>Database Consistency</strong>: Use database transactions for critical updates</li>
<li><strong>Eventual Consistency</strong>: Accept temporary inconsistency for better performance</li>
</ol>
<h3 id="Security-Questions"><a href="#Security-Questions" class="headerlink" title="Security Questions"></a>Security Questions</h3><p><strong>Q: How would you prevent privilege escalation attacks?</strong></p>
<p><strong>A</strong>: Implement multiple defense layers:</p>
<ol>
<li><strong>Principle of Least Privilege</strong>: Regular audits to remove unused permissions</li>
<li><strong>Approval Workflows</strong>: Require approval for sensitive role assignments</li>
<li><strong>Temporal Constraints</strong>: Time-bound permissions with automatic expiration</li>
<li><strong>Delegation Restrictions</strong>: Prevent users from granting permissions they don’t have</li>
<li><strong>Audit Monitoring</strong>: Real-time detection of unusual privilege changes</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrivilegeEscalationDetector</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">detectEscalation</span><span class="params">(RoleAssignmentEvent event)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isPrivilegeEscalation(event)) &#123;</span><br><span class="line">            <span class="comment">// Block the assignment</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;Potential privilege escalation detected&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isPrivilegeEscalation</span><span class="params">(RoleAssignmentEvent event)</span> &#123;</span><br><span class="line">        Set&lt;Permission&gt; assignerPermissions = getEffectivePermissions(event.getAssignerId());</span><br><span class="line">        Set&lt;Permission&gt; targetPermissions = getRolePermissions(event.getRoleId());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Assigner cannot grant permissions they don&#x27;t have</span></span><br><span class="line">        <span class="keyword">return</span> !assignerPermissions.containsAll(targetPermissions);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Performance-Questions"><a href="#Performance-Questions" class="headerlink" title="Performance Questions"></a>Performance Questions</h3><p><strong>Q: How would you optimize the system for 100,000+ concurrent users?</strong></p>
<p><strong>A</strong>: Multi-layered optimization approach:</p>
<ol>
<li><strong>Horizontal Scaling</strong>: Auto-scaling groups with load balancers</li>
<li><strong>Caching Strategy</strong>: 4-tier caching (Browser → CDN → App Cache → Database)</li>
<li><strong>Database Optimization</strong>: Read replicas, connection pooling, query optimization</li>
<li><strong>Async Processing</strong>: Queue heavy operations like audit logging</li>
<li><strong>Pre-computation</strong>: Background jobs to pre-calculate common decisions</li>
</ol>
<h2 id="Troubleshooting-Guide"><a href="#Troubleshooting-Guide" class="headerlink" title="Troubleshooting Guide"></a>Troubleshooting Guide</h2><h3 id="Common-Issues-and-Solutions"><a href="#Common-Issues-and-Solutions" class="headerlink" title="Common Issues and Solutions"></a>Common Issues and Solutions</h3><p><strong>Issue</strong>: High latency on privilege decisions</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Check cache hit ratios</span></span><br><span class="line">curl http://localhost:8080/actuator/metrics/cache.gets | jq</span><br><span class="line"></span><br><span class="line"><span class="comment"># Monitor database query performance</span></span><br><span class="line">EXPLAIN ANALYZE SELECT * FROM user_roles WHERE user_id = <span class="string">&#x27;user123&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check for cache stampede</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/privilege-service.log | grep <span class="string">&quot;Cache miss&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>Solution</strong>: Implement cache warming and query optimization</p>
<p><strong>Issue</strong>: Memory leaks in long-running instances</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add heap dump analysis</span></span><br><span class="line">-XX:+HeapDumpOnOutOfMemoryError </span><br><span class="line">-XX:HeapDumpPath=/<span class="keyword">var</span>/log/heapdumps/</span><br><span class="line"></span><br><span class="line"><span class="comment">// Monitor with JProfiler or similar</span></span><br><span class="line">jcmd &lt;pid&gt; GC.run_finalization</span><br></pre></td></tr></table></figure>

<p><strong>Solution</strong>: Use weak references for rarely accessed data and implement cache size limits</p>
<h2 id="External-Resources"><a href="#External-Resources" class="headerlink" title="External Resources"></a>External Resources</h2><h3 id="Standards-and-Specifications"><a href="#Standards-and-Specifications" class="headerlink" title="Standards and Specifications"></a>Standards and Specifications</h3><ul>
<li><a target="_blank" rel="noopener" href="https://csrc.nist.gov/publications/detail/sp/800-162/final">NIST RBAC Model</a> - Foundational RBAC principles</li>
<li><a target="_blank" rel="noopener" href="http://docs.oasis-open.org/xacml/3.0/xacml-3.0-core-spec-os-en.html">XACML 3.0 Specification</a> - ABAC policy language</li>
<li><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc7662">OAuth 2.0 Token Introspection</a> - Token-based authorization</li>
<li><a target="_blank" rel="noopener" href="https://cheatsheetseries.owasp.org/cheatsheets/Access_Control_Cheat_Sheet.html">OWASP Access Control Cheat Sheet</a> - Security best practices</li>
</ul>
<h3 id="Implementation-References"><a href="#Implementation-References" class="headerlink" title="Implementation References"></a>Implementation References</h3><ul>
<li><a target="_blank" rel="noopener" href="https://spring.io/guides/topicals/spring-security-architecture/">Spring Security Architecture</a> - Framework integration</li>
<li><a target="_blank" rel="noopener" href="https://shiro.apache.org/documentation.html">Apache Shiro Documentation</a> - Alternative authorization framework</li>
<li><a target="_blank" rel="noopener" href="https://auth0.com/docs/manage-users/access-control/rbac">Auth0 RBAC Guide</a> - Commercial implementation examples</li>
<li><a target="_blank" rel="noopener" href="https://casbin.org/">Casbin Authorization Library</a> - Open-source authorization library</li>
</ul>
<h3 id="Performance-and-Monitoring"><a href="#Performance-and-Monitoring" class="headerlink" title="Performance and Monitoring"></a>Performance and Monitoring</h3><ul>
<li><a target="_blank" rel="noopener" href="https://micrometer.io/docs">Micrometer Documentation</a> - Metrics collection</li>
<li><a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards/">Grafana Dashboard Templates</a> - Monitoring visualization</li>
<li><a target="_blank" rel="noopener" href="https://redis.io/documentation">Redis Performance Tuning</a> - Cache optimization</li>
</ul>
<p>This comprehensive design provides a production-ready privilege system that balances security, performance, and maintainability while addressing real-world enterprise requirements.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/12/Java-Interview-Guide-Core-Concepts/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/12/Java-Interview-Guide-Core-Concepts/" class="post-title-link" itemprop="url">Java Interview Guide - Core Concepts</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-12 15:44:19 / Modified: 15:45:36" itemprop="dateCreated datePublished" datetime="2025-06-12T15:44:19+08:00">2025-06-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Java-Fundamentals"><a href="#Java-Fundamentals" class="headerlink" title="Java Fundamentals"></a>Java Fundamentals</h2><h3 id="Collection-Framework"><a href="#Collection-Framework" class="headerlink" title="Collection Framework"></a>Collection Framework</h3><p><strong>Key Concepts:</strong> Thread safety, iterators, duplicates, ordered collections, key-value pairs</p>
<h4 id="List-Implementations"><a href="#List-Implementations" class="headerlink" title="List Implementations"></a>List Implementations</h4><p><strong>Vector</strong></p>
<ul>
<li>Thread-safe with strong consistency</li>
<li>2x capacity expansion</li>
<li><code>Collections.synchronizedList()</code> requires manual synchronization for iterators</li>
</ul>
<p><strong>ArrayList</strong></p>
<ul>
<li>Array-based implementation</li>
<li>Inefficient head insertion, efficient tail insertion</li>
<li>1.5x capacity expansion</li>
<li>Pre-specify capacity to reduce expansion overhead</li>
<li>Uses <code>transient</code> for object array to avoid serializing empty slots</li>
</ul>
<p><strong>LinkedList</strong></p>
<ul>
<li>Doubly-linked list implementation</li>
<li>Slowest for middle insertions</li>
<li>Use Iterator for traversal</li>
<li><code>remove(Integer)</code> removes element, <code>remove(int)</code> removes by index</li>
</ul>
<p><strong>Iterator Safety</strong></p>
<ul>
<li>Enhanced for-loop uses iterator internally</li>
<li>Concurrent modification throws <code>ConcurrentModificationException</code></li>
<li>Use iterator’s <code>remove()</code> method instead of collection’s</li>
</ul>
<h4 id="Map-Implementations"><a href="#Map-Implementations" class="headerlink" title="Map Implementations"></a>Map Implementations</h4><p><strong>Hashtable</strong></p>
<ul>
<li>Thread-safe using <code>synchronized</code></li>
<li>No null keys&#x2F;values allowed</li>
</ul>
<p><strong>HashMap</strong></p>
<ul>
<li>Not thread-safe, allows null keys&#x2F;values</li>
<li>Array + linked list structure</li>
<li>Hash collision resolution via chaining</li>
<li>Default capacity: 16, load factor: 0.75</li>
<li>JDK 1.8: Converts to red-black tree when chain length &gt; 8 and capacity &gt; 64</li>
<li>Multi-threading can cause infinite loops during rehashing</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Hash calculation for efficient indexing</span></span><br><span class="line">index = (n - <span class="number">1</span>) &amp; hash(key)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hash function reduces collisions</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="type">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>LinkedHashMap</strong></p>
<ul>
<li>HashMap + doubly-linked list</li>
<li>Maintains insertion&#x2F;access order</li>
<li>Used for LRU cache implementation</li>
</ul>
<p><strong>TreeMap</strong></p>
<ul>
<li>Red-black tree based</li>
<li>O(log n) time complexity</li>
<li>Sorted keys via Comparator&#x2F;Comparable</li>
</ul>
<h3 id="I-O-Models"><a href="#I-O-Models" class="headerlink" title="I&#x2F;O Models"></a>I&#x2F;O Models</h3><p><strong>Java I&#x2F;O Hierarchy</strong></p>
<ul>
<li>Base classes: <code>InputStream/Reader</code>, <code>OutputStream/Writer</code></li>
<li>Decorator pattern implementation</li>
</ul>
<p><strong>BIO (Blocking I&#x2F;O)</strong></p>
<ul>
<li>Synchronous blocking model</li>
<li>One thread per connection</li>
<li>Suitable for low-concurrency scenarios</li>
<li>Thread pool provides natural rate limiting</li>
</ul>
<p><strong>NIO (Non-blocking I&#x2F;O)</strong></p>
<ul>
<li>I&#x2F;O multiplexing model (not traditional NIO)</li>
<li>Uses <code>select/epoll</code> system calls</li>
<li>Single thread monitors multiple file descriptors</li>
<li>Core components: Buffer, Channel, Selector</li>
</ul>
<p><strong>AIO (Asynchronous I&#x2F;O)</strong></p>
<ul>
<li>Event-driven with callbacks</li>
<li>Introduced in Java 7 as NIO.2</li>
<li>Direct return without blocking</li>
<li>Limited adoption in practice</li>
</ul>
<h3 id="Thread-Pool"><a href="#Thread-Pool" class="headerlink" title="Thread Pool"></a>Thread Pool</h3><p><strong>Thread Creation Methods</strong></p>
<ol>
<li>Runnable interface</li>
<li>Thread class</li>
<li>Callable + FutureTask</li>
<li>Thread pools (recommended)</li>
</ol>
<p><strong>Core Parameters</strong></p>
<ul>
<li><code>corePoolSize</code>: Core thread count</li>
<li><code>maximumPoolSize</code>: Maximum thread count</li>
<li><code>keepAliveTime</code>: Idle thread survival time</li>
<li><code>workQueue</code>: Task queue (must be bounded)</li>
<li><code>rejectedExecutionHandler</code>: Rejection policy</li>
</ul>
<p><strong>Execution Flow</strong></p>
<ol>
<li>Create threads up to core size</li>
<li>Queue tasks when core threads busy</li>
<li>Expand to max size when queue full</li>
<li>Apply rejection policy when max reached</li>
<li>Shrink to core size after keepAliveTime</li>
</ol>
<p><strong>Optimal Thread Count</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Optimal Threads = CPU Cores × [1 + (I/O Time / CPU Time)]</span><br></pre></td></tr></table></figure>

<p><strong>Best Practices</strong></p>
<ul>
<li>Graceful shutdown</li>
<li>Uncaught exception handling</li>
<li>Separate pools for dependent tasks</li>
<li>Proper rejection policy implementation</li>
</ul>
<h3 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h3><p><strong>Use Cases</strong></p>
<ul>
<li>Thread isolation with cross-method data sharing</li>
<li>Database session management (Hibernate)</li>
<li>Request context propagation (user ID, session)</li>
<li>HTTP request instances</li>
</ul>
<p><strong>Implementation</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Thread → ThreadLocalMap&lt;ThreadLocal, Object&gt; → Entry(key, value)</span><br></pre></td></tr></table></figure>

<p><strong>Memory Management</strong></p>
<ul>
<li>Entry key uses weak reference</li>
<li>Automatic cleanup of null keys</li>
<li>Must use <code>private static final</code> modifiers</li>
</ul>
<p><strong>Best Practices</strong></p>
<ul>
<li>Always call <code>remove()</code> in finally blocks</li>
<li>Handle thread pool reuse scenarios</li>
<li>Use <code>afterExecute</code> hook for cleanup</li>
</ul>
<h2 id="JVM-Java-Virtual-Machine"><a href="#JVM-Java-Virtual-Machine" class="headerlink" title="JVM (Java Virtual Machine)"></a>JVM (Java Virtual Machine)</h2><h3 id="Memory-Structure"><a href="#Memory-Structure" class="headerlink" title="Memory Structure"></a>Memory Structure</h3><p><strong>Components</strong></p>
<ul>
<li>Class Loader</li>
<li>Runtime Data Area</li>
<li>Execution Engine</li>
<li>Native Interface</li>
</ul>
<p><strong>Runtime Data Areas</strong></p>
<p><strong>Thread-Shared</strong></p>
<ul>
<li><strong>Method Area</strong>: Class metadata, constants, static variables</li>
<li><strong>Heap</strong>: Object instances, string pool (JDK 7+)</li>
</ul>
<p><strong>Thread-Private</strong></p>
<ul>
<li><strong>VM Stack</strong>: Stack frames with local variables, operand stack</li>
<li><strong>Native Method Stack</strong>: For native method calls</li>
<li><strong>Program Counter</strong>: Current bytecode instruction pointer</li>
</ul>
<p><strong>Key Changes</strong></p>
<ul>
<li><strong>JDK 8</strong>: Metaspace replaced PermGen (uses native memory)</li>
<li><strong>JDK 7</strong>: String pool moved to heap for better GC efficiency</li>
</ul>
<h3 id="Class-Loading"><a href="#Class-Loading" class="headerlink" title="Class Loading"></a>Class Loading</h3><p><strong>Process</strong></p>
<ol>
<li><strong>Loading</strong>: Read .class files, create Class objects</li>
<li><strong>Verification</strong>: Validate bytecode integrity</li>
<li><strong>Preparation</strong>: Allocate memory, set default values for static variables</li>
<li><strong>Resolution</strong>: Convert symbolic references to direct references</li>
<li><strong>Initialization</strong>: Execute static blocks and variable assignments</li>
</ol>
<p><strong>Class Loaders</strong></p>
<ul>
<li><strong>Bootstrap</strong>: JDK core classes</li>
<li><strong>Extension&#x2F;Platform</strong>: JDK extensions</li>
<li><strong>Application</strong>: CLASSPATH classes</li>
</ul>
<p><strong>Parent Delegation</strong></p>
<ul>
<li>Child loaders delegate to parent first</li>
<li>Prevents duplicate loading</li>
<li>Ensures class uniqueness and security</li>
</ul>
<p><strong>Custom Class Loaders</strong></p>
<ul>
<li>Extend ClassLoader, override <code>findClass()</code></li>
<li>Tomcat breaks delegation for web app isolation</li>
</ul>
<h3 id="Garbage-Collection"><a href="#Garbage-Collection" class="headerlink" title="Garbage Collection"></a>Garbage Collection</h3><p><strong>Memory Regions</strong></p>
<ul>
<li><strong>Young Generation</strong>: Eden + Survivor (From&#x2F;To)</li>
<li><strong>Old Generation</strong>: Long-lived objects</li>
<li><strong>Metaspace</strong>: Class metadata (JDK 8+)</li>
</ul>
<p><strong>GC Root Objects</strong></p>
<ul>
<li>Local variables in method stacks</li>
<li>Static variables in loaded classes</li>
<li>JNI references in native stacks</li>
<li>Active Java threads</li>
</ul>
<p><strong>Reference Types</strong></p>
<ul>
<li><strong>Strong</strong>: Never collected while referenced</li>
<li><strong>Soft</strong>: Collected before OOM</li>
<li><strong>Weak</strong>: Collected at next GC</li>
<li><strong>Phantom</strong>: For cleanup notification only</li>
</ul>
<p><strong>Collection Algorithms</strong></p>
<ul>
<li><strong>Young Generation</strong>: Copy algorithm (efficient, no fragmentation)</li>
<li><strong>Old Generation</strong>: Mark-Sweep or Mark-Compact</li>
</ul>
<p><strong>Garbage Collectors</strong></p>
<p><strong>Serial&#x2F;Parallel</strong></p>
<ul>
<li>Single&#x2F;multi-threaded</li>
<li>Suitable for small applications or batch processing</li>
</ul>
<p><strong>CMS (Concurrent Mark Sweep)</strong></p>
<ul>
<li>Low-latency for old generation</li>
<li>Concurrent collection with application threads</li>
</ul>
<p><strong>G1 (Garbage First)</strong></p>
<ul>
<li>Region-based collection</li>
<li>Predictable pause times</li>
<li>Default in JDK 9+, suitable for large heaps (&gt;8GB)</li>
</ul>
<p><strong>ZGC&#x2F;Shenandoah</strong></p>
<ul>
<li>Ultra-low latency (&lt;10ms)</li>
<li>Supports TB-scale heaps</li>
<li>Ideal for cloud-native applications</li>
</ul>
<p><strong>Tuning Parameters</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Heap sizing</span></span><br><span class="line">-Xms4g -Xmx4g                    <span class="comment"># Initial = Max heap</span></span><br><span class="line">-Xmn2g                           <span class="comment"># Young generation size</span></span><br><span class="line">-XX:SurvivorRatio=8              <span class="comment"># Eden:Survivor ratio</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># GC logging</span></span><br><span class="line">-XX:+PrintGCDetails -Xloggc:gc.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># Metaspace</span></span><br><span class="line">-XX:MetaspaceSize=256M -XX:MaxMetaspaceSize=512M</span><br><span class="line"></span><br><span class="line"><span class="comment"># OOM debugging</span></span><br><span class="line">-XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/path/dump.hprof</span><br></pre></td></tr></table></figure>

<p><strong>OOM Troubleshooting</strong></p>
<ol>
<li>Generate heap dumps on OOM</li>
<li>Analyze with MAT (Memory Analyzer Tool) or VisualVM</li>
<li>Common causes: memory leaks, oversized objects, insufficient heap space</li>
<li>Tune object promotion thresholds and GC parameters</li>
</ol>
<h2 id="Performance-Optimization-Tips"><a href="#Performance-Optimization-Tips" class="headerlink" title="Performance Optimization Tips"></a>Performance Optimization Tips</h2><ol>
<li><strong>Collections</strong>: Pre-size collections, use appropriate implementations</li>
<li><strong>Strings</strong>: Use StringBuilder for concatenation, intern frequently used strings</li>
<li><strong>Thread Pools</strong>: Tune core&#x2F;max sizes based on workload characteristics</li>
<li><strong>GC</strong>: Choose appropriate collector, monitor GC logs, tune heap ratios</li>
<li><strong>Memory</strong>: Avoid memory leaks, use object pools for expensive objects</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/12/Java-JVM-Performance-Tuning/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/12/Java-JVM-Performance-Tuning/" class="post-title-link" itemprop="url">Java JVM Performance Tuning</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-12 15:43:49 / Modified: 15:46:52" itemprop="dateCreated datePublished" datetime="2025-06-12T15:43:49+08:00">2025-06-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="JVM-Architecture-Performance-Fundamentals"><a href="#JVM-Architecture-Performance-Fundamentals" class="headerlink" title="JVM Architecture &amp; Performance Fundamentals"></a>JVM Architecture &amp; Performance Fundamentals</h2><h3 id="Core-Components-Overview"><a href="#Core-Components-Overview" class="headerlink" title="Core Components Overview"></a>Core Components Overview</h3><pre>
<code class="mermaid">
graph TD
A[Java Application] --&gt; B[JVM]
B --&gt; C[Class Loader Subsystem]
B --&gt; D[Runtime Data Areas]
B --&gt; E[Execution Engine]

C --&gt; C1[Bootstrap ClassLoader]
C --&gt; C2[Extension ClassLoader]
C --&gt; C3[Application ClassLoader]

D --&gt; D1[Method Area]
D --&gt; D2[Heap Memory]
D --&gt; D3[Stack Memory]
D --&gt; D4[PC Registers]
D --&gt; D5[Native Method Stacks]

E --&gt; E1[Interpreter]
E --&gt; E2[JIT Compiler]
E --&gt; E3[Garbage Collector]
</code>
</pre>

<h3 id="Memory-Layout-Deep-Dive"><a href="#Memory-Layout-Deep-Dive" class="headerlink" title="Memory Layout Deep Dive"></a>Memory Layout Deep Dive</h3><p>The JVM memory structure directly impacts performance through allocation patterns and garbage collection behavior.</p>
<p><strong>Heap Memory Structure:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────┐</span><br><span class="line">│                    Heap Memory                      │</span><br><span class="line">├─────────────────────┬───────────────────────────────┤</span><br><span class="line">│    Young Generation │         Old Generation        │</span><br><span class="line">├─────┬─────┬─────────┼───────────────────────────────┤</span><br><span class="line">│Eden │ S0  │   S1    │        Tenured Space          │</span><br><span class="line">│Space│     │         │                               │</span><br><span class="line">└─────┴─────┴─────────┴───────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight:</strong> <em>“Can you explain the generational hypothesis and why it’s crucial for JVM performance?”</em></p>
<p>The generational hypothesis states that most objects die young. This principle drives the JVM’s memory design:</p>
<ul>
<li><strong>Eden Space</strong>: Where new objects are allocated (fast allocation)</li>
<li><strong>Survivor Spaces (S0, S1)</strong>: Temporary holding for objects that survived one GC cycle</li>
<li><strong>Old Generation</strong>: Long-lived objects that survived multiple GC cycles</li>
</ul>
<h3 id="Performance-Impact-Factors"><a href="#Performance-Impact-Factors" class="headerlink" title="Performance Impact Factors"></a>Performance Impact Factors</h3><ol>
<li><strong>Memory Allocation Speed</strong>: Eden space uses bump-the-pointer allocation</li>
<li><strong>GC Frequency</strong>: Young generation GC is faster than full GC</li>
<li><strong>Object Lifetime</strong>: Proper object lifecycle management reduces GC pressure</li>
</ol>
<hr>
<h2 id="Memory-Management-Garbage-Collection"><a href="#Memory-Management-Garbage-Collection" class="headerlink" title="Memory Management &amp; Garbage Collection"></a>Memory Management &amp; Garbage Collection</h2><h3 id="Garbage-Collection-Algorithms-Comparison"><a href="#Garbage-Collection-Algorithms-Comparison" class="headerlink" title="Garbage Collection Algorithms Comparison"></a>Garbage Collection Algorithms Comparison</h3><pre>
<code class="mermaid">
graph LR
A[GC Algorithms] --&gt; B[Serial GC]
A --&gt; C[Parallel GC]
A --&gt; D[G1GC]
A --&gt; E[ZGC]
A --&gt; F[Shenandoah]

B --&gt; B1[Single Thread&lt;br&#x2F;&gt;Small Heaps&lt;br&#x2F;&gt;Client Apps]
C --&gt; C1[Multi Thread&lt;br&#x2F;&gt;Server Apps&lt;br&#x2F;&gt;Throughput Focus]
D --&gt; D1[Large Heaps&lt;br&#x2F;&gt;Low Latency&lt;br&#x2F;&gt;Predictable Pauses]
E --&gt; E1[Very Large Heaps&lt;br&#x2F;&gt;Ultra Low Latency&lt;br&#x2F;&gt;Concurrent Collection]
F --&gt; F1[Low Pause Times&lt;br&#x2F;&gt;Concurrent Collection&lt;br&#x2F;&gt;Red Hat OpenJDK]
</code>
</pre>

<h3 id="G1GC-Deep-Dive-Most-Common-in-Production"><a href="#G1GC-Deep-Dive-Most-Common-in-Production" class="headerlink" title="G1GC Deep Dive (Most Common in Production)"></a>G1GC Deep Dive (Most Common in Production)</h3><p><strong>Interview Insight:</strong> <em>“Why would you choose G1GC over Parallel GC for a high-throughput web application?”</em></p>
<p>G1GC (Garbage First) is designed for:</p>
<ul>
<li>Applications with heap sizes larger than 6GB</li>
<li>Applications requiring predictable pause times (&lt;200ms)</li>
<li>Applications with varying allocation rates</li>
</ul>
<p><strong>G1GC Memory Regions:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐</span><br><span class="line">│  E  │  E  │ S   │ O   │ O   │ H   │  E  │ O   │</span><br><span class="line">└─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┘</span><br><span class="line">E = Eden, S = Survivor, O = Old, H = Humongous</span><br></pre></td></tr></table></figure>

<p><strong>Key G1GC Parameters:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Basic G1GC Configuration</span></span><br><span class="line">-XX:+UseG1GC</span><br><span class="line">-XX:MaxGCPauseMillis=200</span><br><span class="line">-XX:G1HeapRegionSize=16m</span><br><span class="line">-XX:G1NewSizePercent=30</span><br><span class="line">-XX:G1MaxNewSizePercent=40</span><br><span class="line">-XX:G1MixedGCCountTarget=8</span><br></pre></td></tr></table></figure>

<h3 id="GC-Tuning-Strategies"><a href="#GC-Tuning-Strategies" class="headerlink" title="GC Tuning Strategies"></a>GC Tuning Strategies</h3><p><strong>Showcase: Production Web Application Tuning</strong></p>
<p>Before optimization:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Application: E-commerce platform</span><br><span class="line">Heap Size: 8GB</span><br><span class="line">GC Algorithm: Parallel GC</span><br><span class="line">Average GC Pause: 2.5 seconds</span><br><span class="line">Throughput: 85%</span><br></pre></td></tr></table></figure>

<p>After G1GC optimization:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-Xms8g -Xmx8g</span><br><span class="line">-XX:+UseG1GC</span><br><span class="line">-XX:MaxGCPauseMillis=100</span><br><span class="line">-XX:G1HeapRegionSize=32m</span><br><span class="line">-XX:+G1UseAdaptiveIHOP</span><br><span class="line">-XX:G1MixedGCCountTarget=8</span><br></pre></td></tr></table></figure>

<p>Results:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Average GC Pause: 45ms</span><br><span class="line">Throughput: 97%</span><br><span class="line">Response Time P99: Improved by 60%</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight:</strong> <em>“How do you tune G1GC for an application with unpredictable allocation patterns?”</em></p>
<p>Key strategies:</p>
<ol>
<li><strong>Adaptive IHOP</strong>: Use <code>-XX:+G1UseAdaptiveIHOP</code> to let G1 automatically adjust concurrent cycle triggers</li>
<li><strong>Region Size Tuning</strong>: Larger regions (32m-64m) for applications with large objects</li>
<li><strong>Mixed GC Tuning</strong>: Adjust <code>G1MixedGCCountTarget</code> based on old generation cleanup needs</li>
</ol>
<hr>
<h2 id="JIT-Compilation-Optimization"><a href="#JIT-Compilation-Optimization" class="headerlink" title="JIT Compilation Optimization"></a>JIT Compilation Optimization</h2><h3 id="JIT-Compilation-Tiers"><a href="#JIT-Compilation-Tiers" class="headerlink" title="JIT Compilation Tiers"></a>JIT Compilation Tiers</h3><pre>
<code class="mermaid">
flowchart TD
A[Method Invocation] --&gt; B{Invocation Count}
B --&gt;|&lt; C1 Threshold| C[Interpreter]
B --&gt;|&gt;&#x3D; C1 Threshold| D[C1 Compiler - Tier 3]
D --&gt; E{Profile Data}
E --&gt;|Hot Method| F[C2 Compiler - Tier 4]
E --&gt;|Not Hot| G[Continue C1]
F --&gt; H[Optimized Native Code]

C --&gt; I[Profile Collection]
I --&gt; B
</code>
</pre>

<p><strong>Interview Insight:</strong> <em>“Explain the difference between C1 and C2 compilers and when each is used.”</em></p>
<ul>
<li><strong>C1 (Client Compiler)</strong>: Fast compilation, basic optimizations, suitable for short-running applications</li>
<li><strong>C2 (Server Compiler)</strong>: Aggressive optimizations, longer compilation time, better for long-running server applications</li>
</ul>
<h3 id="JIT-Optimization-Techniques"><a href="#JIT-Optimization-Techniques" class="headerlink" title="JIT Optimization Techniques"></a>JIT Optimization Techniques</h3><ol>
<li><strong>Method Inlining</strong>: Eliminates method call overhead</li>
<li><strong>Dead Code Elimination</strong>: Removes unreachable code</li>
<li><strong>Loop Optimization</strong>: Unrolling, vectorization</li>
<li><strong>Escape Analysis</strong>: Stack allocation for non-escaping objects</li>
</ol>
<p><strong>Showcase: Method Inlining Impact</strong></p>
<p>Before inlining:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MathUtils</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">calculate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</span><br><span class="line">            result = add(result, i); <span class="comment">// Method call overhead</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After JIT optimization (conceptual):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JIT inlines the add method</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">calculate</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</span><br><span class="line">        result = result + i; <span class="comment">// Direct operation, no call overhead</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="JIT-Tuning-Parameters"><a href="#JIT-Tuning-Parameters" class="headerlink" title="JIT Tuning Parameters"></a>JIT Tuning Parameters</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Compilation Thresholds</span></span><br><span class="line">-XX:CompileThreshold=10000        <span class="comment"># C2 compilation threshold</span></span><br><span class="line">-XX:Tier3CompileThreshold=2000    <span class="comment"># C1 compilation threshold</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Compilation Control</span></span><br><span class="line">-XX:+TieredCompilation            <span class="comment"># Enable tiered compilation</span></span><br><span class="line">-XX:CICompilerCount=4             <span class="comment"># Number of compiler threads</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Optimization Control</span></span><br><span class="line">-XX:+UseStringDeduplication       <span class="comment"># Reduce memory usage for duplicate strings</span></span><br><span class="line">-XX:+AggressiveOpts               <span class="comment"># Enable experimental optimizations</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight:</strong> <em>“How would you diagnose and fix a performance regression after a JVM upgrade?”</em></p>
<p>Diagnostic approach:</p>
<ol>
<li>Compare JIT compilation logs (<code>-XX:+UnlockDiagnosticVMOptions -XX:+LogVMOutput</code>)</li>
<li>Check for deoptimization events (<code>-XX:+TraceDeoptimization</code>)</li>
<li>Profile method hotness and inlining decisions</li>
<li>Verify optimization flags compatibility</li>
</ol>
<hr>
<h2 id="Thread-Management-Concurrency"><a href="#Thread-Management-Concurrency" class="headerlink" title="Thread Management &amp; Concurrency"></a>Thread Management &amp; Concurrency</h2><h3 id="Thread-States-and-Performance-Impact"><a href="#Thread-States-and-Performance-Impact" class="headerlink" title="Thread States and Performance Impact"></a>Thread States and Performance Impact</h3><pre>
<code class="mermaid">
stateDiagram-v2
[*] --&gt; NEW
NEW --&gt; RUNNABLE: start()
RUNNABLE --&gt; BLOCKED: synchronized block
RUNNABLE --&gt; WAITING: wait(), join()
RUNNABLE --&gt; TIMED_WAITING: sleep(), wait(timeout)
BLOCKED --&gt; RUNNABLE: lock acquired
WAITING --&gt; RUNNABLE: notify(), interrupt()
TIMED_WAITING --&gt; RUNNABLE: timeout, notify()
RUNNABLE --&gt; TERMINATED: execution complete
TERMINATED --&gt; [*]
</code>
</pre>

<h3 id="Lock-Optimization-Strategies"><a href="#Lock-Optimization-Strategies" class="headerlink" title="Lock Optimization Strategies"></a>Lock Optimization Strategies</h3><p><strong>Interview Insight:</strong> <em>“How does the JVM optimize synchronization, and what are the performance implications?”</em></p>
<p>JVM lock optimizations include:</p>
<ol>
<li><strong>Biased Locking</strong>: Assumes single-threaded access pattern</li>
<li><strong>Lightweight Locking</strong>: Uses CAS operations for low contention</li>
<li><strong>Heavyweight Locking</strong>: OS-level locking for high contention</li>
</ol>
<p><strong>Lock Inflation Process:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">No Lock → Biased Lock → Lightweight Lock → Heavyweight Lock</span><br></pre></td></tr></table></figure>

<h3 id="Thread-Pool-Optimization"><a href="#Thread-Pool-Optimization" class="headerlink" title="Thread Pool Optimization"></a>Thread Pool Optimization</h3><p><strong>Showcase: HTTP Server Thread Pool Tuning</strong></p>
<p>Before optimization:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Poor configuration</span></span><br><span class="line"><span class="type">ThreadPoolExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">    <span class="number">1</span>,                      <span class="comment">// corePoolSize too small</span></span><br><span class="line">    Integer.MAX_VALUE,      <span class="comment">// maxPoolSize too large</span></span><br><span class="line">    <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;&gt;() <span class="comment">// Queue can cause rejections</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>After optimization:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Optimized configuration</span></span><br><span class="line"><span class="type">int</span> <span class="variable">coreThreads</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors() * <span class="number">2</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">maxThreads</span> <span class="operator">=</span> coreThreads * <span class="number">4</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">queueCapacity</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">ThreadPoolExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">    coreThreads,</span><br><span class="line">    maxThreads,</span><br><span class="line">    <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(queueCapacity),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy() <span class="comment">// Backpressure handling</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// JVM flags for thread optimization</span></span><br><span class="line">-XX:+UseBiasedLocking</span><br><span class="line">-XX:BiasedLockingStartupDelay=<span class="number">0</span></span><br><span class="line">-XX:+UseThreadPriorities</span><br></pre></td></tr></table></figure>

<h3 id="Concurrent-Collections-Performance"><a href="#Concurrent-Collections-Performance" class="headerlink" title="Concurrent Collections Performance"></a>Concurrent Collections Performance</h3><p><strong>Interview Insight:</strong> <em>“When would you use ConcurrentHashMap vs synchronized HashMap, and what are the performance trade-offs?”</em></p>
<p>Performance comparison:</p>
<ul>
<li><strong>ConcurrentHashMap</strong>: Segment-based locking, better scalability</li>
<li><strong>synchronized HashMap</strong>: Full map locking, simpler but less scalable</li>
<li><strong>Collections.synchronizedMap()</strong>: Method-level synchronization, worst performance</li>
</ul>
<hr>
<h2 id="Monitoring-Profiling-Tools"><a href="#Monitoring-Profiling-Tools" class="headerlink" title="Monitoring &amp; Profiling Tools"></a>Monitoring &amp; Profiling Tools</h2><h3 id="Essential-JVM-Monitoring-Metrics"><a href="#Essential-JVM-Monitoring-Metrics" class="headerlink" title="Essential JVM Monitoring Metrics"></a>Essential JVM Monitoring Metrics</h3><pre>
<code class="mermaid">
graph TD
A[JVM Monitoring] --&gt; B[Memory Metrics]
A --&gt; C[GC Metrics]
A --&gt; D[Thread Metrics]
A --&gt; E[JIT Metrics]

B --&gt; B1[Heap Usage]
B --&gt; B2[Non-Heap Usage]
B --&gt; B3[Memory Pool Details]

C --&gt; C1[GC Time]
C --&gt; C2[GC Frequency]
C --&gt; C3[GC Throughput]

D --&gt; D1[Thread Count]
D --&gt; D2[Thread States]
D --&gt; D3[Deadlock Detection]

E --&gt; E1[Compilation Time]
E --&gt; E2[Code Cache Usage]
E --&gt; E3[Deoptimization Events]
</code>
</pre>

<h3 id="Profiling-Tools-Comparison"><a href="#Profiling-Tools-Comparison" class="headerlink" title="Profiling Tools Comparison"></a>Profiling Tools Comparison</h3><table>
<thead>
<tr>
<th>Tool</th>
<th>Use Case</th>
<th>Overhead</th>
<th>Real-time</th>
<th>Production Safe</th>
</tr>
</thead>
<tbody><tr>
<td>JProfiler</td>
<td>Development&#x2F;Testing</td>
<td>Medium</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td>YourKit</td>
<td>Development&#x2F;Testing</td>
<td>Medium</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td>Java Flight Recorder</td>
<td>Production</td>
<td>Very Low</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>Async Profiler</td>
<td>Production</td>
<td>Low</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>jstack</td>
<td>Debugging</td>
<td>None</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr>
<td>jstat</td>
<td>Monitoring</td>
<td>Very Low</td>
<td>Yes</td>
<td>Yes</td>
</tr>
</tbody></table>
<p><strong>Interview Insight:</strong> <em>“How would you profile a production application without impacting performance?”</em></p>
<p>Production-safe profiling approach:</p>
<ol>
<li><strong>Java Flight Recorder (JFR)</strong>: Continuous profiling with &lt;1% overhead</li>
<li><strong>Async Profiler</strong>: Sample-based profiling for CPU hotspots</li>
<li><strong>Application Metrics</strong>: Custom metrics for business logic</li>
<li><strong>JVM Flags for monitoring</strong>:</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-XX:+FlightRecorder</span><br><span class="line">-XX:StartFlightRecording=duration=60s,filename=myapp.jfr</span><br><span class="line">-XX:+UnlockCommercialFeatures  <span class="comment"># Java 8 only</span></span><br></pre></td></tr></table></figure>

<h3 id="Key-Performance-Metrics"><a href="#Key-Performance-Metrics" class="headerlink" title="Key Performance Metrics"></a>Key Performance Metrics</h3><p><strong>Showcase: Production Monitoring Dashboard</strong></p>
<p>Critical metrics to track:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Memory:</span><br><span class="line">- Heap Utilization: &lt;80% after GC</span><br><span class="line">- Old Generation Growth Rate: &lt;10MB/minute</span><br><span class="line">- Metaspace Usage: Monitor for memory leaks</span><br><span class="line"></span><br><span class="line">GC:</span><br><span class="line">- GC Pause Time: P99 &lt;100ms</span><br><span class="line">- GC Frequency: &lt;1 per minute for major GC</span><br><span class="line">- GC Throughput: &gt;95%</span><br><span class="line"></span><br><span class="line">Application:</span><br><span class="line">- Response Time: P95, P99 percentiles</span><br><span class="line">- Throughput: Requests per second</span><br><span class="line">- Error Rate: &lt;0.1%</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Performance-Tuning-Best-Practices"><a href="#Performance-Tuning-Best-Practices" class="headerlink" title="Performance Tuning Best Practices"></a>Performance Tuning Best Practices</h2><h3 id="JVM-Tuning-Methodology"><a href="#JVM-Tuning-Methodology" class="headerlink" title="JVM Tuning Methodology"></a>JVM Tuning Methodology</h3><pre>
<code class="mermaid">
flowchart TD
A[Baseline Measurement] --&gt; B[Identify Bottlenecks]
B --&gt; C[Hypothesis Formation]
C --&gt; D[Parameter Adjustment]
D --&gt; E[Load Testing]
E --&gt; F{Performance Improved?}
F --&gt;|Yes| G[Validate in Production]
F --&gt;|No| H[Revert Changes]
H --&gt; B
G --&gt; I[Monitor &amp; Document]
</code>
</pre>

<h3 id="Common-JVM-Flags-for-Production"><a href="#Common-JVM-Flags-for-Production" class="headerlink" title="Common JVM Flags for Production"></a>Common JVM Flags for Production</h3><p><strong>Interview Insight:</strong> <em>“What JVM flags would you use for a high-throughput, low-latency web application?”</em></p>
<p>Essential production flags:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Memory Settings</span></span><br><span class="line">-Xms8g -Xmx8g                    <span class="comment"># Set heap size (same min/max)</span></span><br><span class="line">-XX:MetaspaceSize=256m            <span class="comment"># Initial metaspace size</span></span><br><span class="line">-XX:MaxMetaspaceSize=512m         <span class="comment"># Max metaspace size</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Garbage Collection</span></span><br><span class="line">-XX:+UseG1GC                     <span class="comment"># Use G1 collector</span></span><br><span class="line">-XX:MaxGCPauseMillis=100         <span class="comment"># Target pause time</span></span><br><span class="line">-XX:G1HeapRegionSize=32m         <span class="comment"># Region size for large heaps</span></span><br><span class="line">-XX:+G1UseAdaptiveIHOP           <span class="comment"># Adaptive concurrent cycle triggering</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># JIT Compilation</span></span><br><span class="line">-XX:+TieredCompilation           <span class="comment"># Enable tiered compilation</span></span><br><span class="line">-XX:CompileThreshold=1000        <span class="comment"># Lower threshold for faster warmup</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Monitoring &amp; Debugging</span></span><br><span class="line">-XX:+HeapDumpOnOutOfMemoryError  <span class="comment"># Generate heap dump on OOM</span></span><br><span class="line">-XX:HeapDumpPath=/opt/dumps/     <span class="comment"># Heap dump location</span></span><br><span class="line">-XX:+UseGCLogFileRotation        <span class="comment"># Rotate GC logs</span></span><br><span class="line">-XX:NumberOfGCLogFiles=5         <span class="comment"># Keep 5 GC log files</span></span><br><span class="line">-XX:GCLogFileSize=100M           <span class="comment"># Max size per GC log file</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Performance Optimizations</span></span><br><span class="line">-XX:+UseStringDeduplication      <span class="comment"># Reduce memory for duplicate strings</span></span><br><span class="line">-XX:+OptimizeStringConcat        <span class="comment"># Optimize string concatenation</span></span><br><span class="line">-server                          <span class="comment"># Use server JVM</span></span><br></pre></td></tr></table></figure>

<h3 id="Application-Level-Optimizations"><a href="#Application-Level-Optimizations" class="headerlink" title="Application-Level Optimizations"></a>Application-Level Optimizations</h3><p><strong>Showcase: Object Pool vs New Allocation</strong></p>
<p>Before (high allocation pressure):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseConnection</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">getUsers</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;User&gt; users = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(); <span class="comment">// New allocation each call</span></span><br><span class="line">        <span class="comment">// Database query logic</span></span><br><span class="line">        <span class="keyword">return</span> users;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After (reduced allocation):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseConnection</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadLocal&lt;List&lt;User&gt;&gt; userListCache = </span><br><span class="line">        ThreadLocal.withInitial(() -&gt; <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">100</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">getUsers</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;User&gt; users = userListCache.get();</span><br><span class="line">        users.clear(); <span class="comment">// Reuse existing list</span></span><br><span class="line">        <span class="comment">// Database query logic</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(users); <span class="comment">// Return defensive copy</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Memory-Leak-Prevention"><a href="#Memory-Leak-Prevention" class="headerlink" title="Memory Leak Prevention"></a>Memory Leak Prevention</h3><p><strong>Interview Insight:</strong> <em>“How do you detect and prevent memory leaks in a Java application?”</em></p>
<p>Common memory leak patterns and solutions:</p>
<ol>
<li><strong>Static Collections</strong>: Use weak references or bounded caches</li>
<li><strong>Listener Registration</strong>: Always unregister listeners</li>
<li><strong>ThreadLocal Variables</strong>: Clear ThreadLocal in finally blocks</li>
<li><strong>Connection Leaks</strong>: Use try-with-resources for connections</li>
</ol>
<p>Detection tools:</p>
<ul>
<li><strong>Heap Analysis</strong>: Eclipse MAT, JVisualVM</li>
<li><strong>Profiling</strong>: Continuous monitoring of old generation growth</li>
<li><strong>Application Metrics</strong>: Track object creation rates</li>
</ul>
<hr>
<h2 id="Real-World-Case-Studies"><a href="#Real-World-Case-Studies" class="headerlink" title="Real-World Case Studies"></a>Real-World Case Studies</h2><h3 id="Case-Study-1-E-commerce-Platform-Optimization"><a href="#Case-Study-1-E-commerce-Platform-Optimization" class="headerlink" title="Case Study 1: E-commerce Platform Optimization"></a>Case Study 1: E-commerce Platform Optimization</h3><p><strong>Problem</strong>: High latency during peak traffic, frequent long GC pauses</p>
<p><strong>Initial State</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Heap Size: 16GB</span><br><span class="line">GC Algorithm: Parallel GC</span><br><span class="line">Average GC Pause: 8 seconds</span><br><span class="line">Throughput: 60%</span><br><span class="line">Error Rate: 5% (timeouts)</span><br></pre></td></tr></table></figure>

<p><strong>Solution Applied</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Tuning approach</span></span><br><span class="line">-Xms32g -Xmx32g                  <span class="comment"># Increased heap size</span></span><br><span class="line">-XX:+UseG1GC                     <span class="comment"># Switched to G1GC</span></span><br><span class="line">-XX:MaxGCPauseMillis=50          <span class="comment"># Aggressive pause target</span></span><br><span class="line">-XX:G1HeapRegionSize=64m         <span class="comment"># Large regions for big heap</span></span><br><span class="line">-XX:G1NewSizePercent=40          <span class="comment"># Larger young generation</span></span><br><span class="line">-XX:G1MixedGCCountTarget=4       <span class="comment"># Aggressive mixed GC</span></span><br><span class="line">-XX:+G1UseAdaptiveIHOP           <span class="comment"># Adaptive triggering</span></span><br></pre></td></tr></table></figure>

<p><strong>Results</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Average GC Pause: 30ms (99.6% improvement)</span><br><span class="line">Throughput: 98%</span><br><span class="line">Error Rate: 0.1%</span><br><span class="line">Response Time P99: Improved by 80%</span><br></pre></td></tr></table></figure>

<h3 id="Case-Study-2-Microservice-Memory-Optimization"><a href="#Case-Study-2-Microservice-Memory-Optimization" class="headerlink" title="Case Study 2: Microservice Memory Optimization"></a>Case Study 2: Microservice Memory Optimization</h3><p><strong>Problem</strong>: High memory usage in containerized microservices</p>
<p><strong>Interview Insight</strong>: <em>“How do you optimize JVM memory usage for containers with limited resources?”</em></p>
<p><strong>Original Configuration</strong> (4GB container):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-Xmx3g    <span class="comment"># Too large for container</span></span><br><span class="line">-XX:+UseParallelGC</span><br></pre></td></tr></table></figure>

<p><strong>Optimized Configuration</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Container-aware settings</span></span><br><span class="line">-XX:+UseContainerSupport         <span class="comment"># JVM 11+ container awareness</span></span><br><span class="line">-XX:InitialRAMPercentage=50      <span class="comment"># Initial heap as % of container memory</span></span><br><span class="line">-XX:MaxRAMPercentage=75          <span class="comment"># Max heap as % of container memory</span></span><br><span class="line">-XX:+UseSerialGC                 <span class="comment"># Better for small heaps</span></span><br><span class="line">-XX:TieredStopAtLevel=1          <span class="comment"># Reduce compilation overhead</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Alternative for very small containers</span></span><br><span class="line">-Xmx1536m                        <span class="comment"># Leave 512MB for non-heap</span></span><br><span class="line">-XX:+UseG1GC</span><br><span class="line">-XX:MaxGCPauseMillis=100</span><br></pre></td></tr></table></figure>

<h3 id="Case-Study-3-Batch-Processing-Optimization"><a href="#Case-Study-3-Batch-Processing-Optimization" class="headerlink" title="Case Study 3: Batch Processing Optimization"></a>Case Study 3: Batch Processing Optimization</h3><p><strong>Problem</strong>: Long-running batch job with memory growth over time</p>
<p><strong>Solution Strategy</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Before: Memory leak in batch processing</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BatchProcessor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, ProcessedData&gt; cache = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(); <span class="comment">// Grows indefinitely</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processBatch</span><span class="params">(List&lt;RawData&gt; data)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (RawData item : data) &#123;</span><br><span class="line">            <span class="type">ProcessedData</span> <span class="variable">processed</span> <span class="operator">=</span> processItem(item);</span><br><span class="line">            cache.put(item.getId(), processed); <span class="comment">// Memory leak</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// After: Bounded cache with proper cleanup</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BatchProcessor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ProcessedData&gt; cache = </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">cacheHits</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_CACHE_SIZE</span> <span class="operator">=</span> <span class="number">10000</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processBatch</span><span class="params">(List&lt;RawData&gt; data)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (RawData item : data) &#123;</span><br><span class="line">            <span class="type">ProcessedData</span> <span class="variable">processed</span> <span class="operator">=</span> cache.computeIfAbsent(</span><br><span class="line">                item.getId(), </span><br><span class="line">                k -&gt; processItem(item)</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Periodic cleanup</span></span><br><span class="line">            <span class="keyword">if</span> (cacheHits.incrementAndGet() % <span class="number">1000</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                cleanupCache();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">cleanupCache</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (cache.size() &gt; MAX_CACHE_SIZE) &#123;</span><br><span class="line">            cache.clear(); <span class="comment">// Simple strategy - could use LRU</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>JVM Configuration for Batch Processing</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-Xms8g -Xmx8g                    <span class="comment"># Fixed heap size</span></span><br><span class="line">-XX:+UseG1GC                     <span class="comment"># Handle varying allocation rates</span></span><br><span class="line">-XX:G1HeapRegionSize=32m         <span class="comment"># Optimize for large object processing</span></span><br><span class="line">-XX:+UnlockExperimentalVMOptions</span><br><span class="line">-XX:+UseEpsilonGC                <span class="comment"># For short-lived batch jobs (Java 11+)</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Advanced-Interview-Questions-Answers"><a href="#Advanced-Interview-Questions-Answers" class="headerlink" title="Advanced Interview Questions &amp; Answers"></a>Advanced Interview Questions &amp; Answers</h2><h3 id="Memory-Management-Deep-Dive"><a href="#Memory-Management-Deep-Dive" class="headerlink" title="Memory Management Deep Dive"></a>Memory Management Deep Dive</h3><p><strong>Q</strong>: <em>“Explain the difference between -Xmx, -Xms, and why you might set them to the same value.”</em></p>
<p><strong>A</strong>: </p>
<ul>
<li><code>-Xmx</code>: Maximum heap size - prevents OutOfMemoryError</li>
<li><code>-Xms</code>: Initial heap size - starting allocation</li>
<li><strong>Setting them equal</strong>: Prevents heap expansion overhead and provides predictable memory usage, crucial for:<ul>
<li>Container environments (prevents OS killing process)</li>
<li>Latency-sensitive applications (avoids allocation pauses)</li>
<li>Production predictability</li>
</ul>
</li>
</ul>
<h3 id="GC-Algorithm-Selection"><a href="#GC-Algorithm-Selection" class="headerlink" title="GC Algorithm Selection"></a>GC Algorithm Selection</h3><p><strong>Q</strong>: <em>“When would you choose ZGC over G1GC, and what are the trade-offs?”</em></p>
<p><strong>A</strong>: Choose ZGC when:</p>
<ul>
<li><strong>Heap sizes &gt;32GB</strong>: ZGC scales better with large heaps</li>
<li><strong>Ultra-low latency requirements</strong>: &lt;10ms pause times</li>
<li><strong>Concurrent collection</strong>: Application can’t tolerate stop-the-world pauses</li>
</ul>
<p>Trade-offs:</p>
<ul>
<li><strong>Higher memory overhead</strong>: ZGC uses more memory for metadata</li>
<li><strong>CPU overhead</strong>: More concurrent work impacts throughput</li>
<li><strong>Maturity</strong>: G1GC has broader production adoption</li>
</ul>
<h3 id="Performance-Troubleshooting"><a href="#Performance-Troubleshooting" class="headerlink" title="Performance Troubleshooting"></a>Performance Troubleshooting</h3><p><strong>Q</strong>: <em>“An application shows high CPU usage but low throughput. How do you diagnose this?”</em></p>
<p><strong>A</strong>: Systematic diagnosis approach:</p>
<ol>
<li><strong>Check GC activity</strong>: <code>jstat -gc</code> - excessive GC can cause high CPU</li>
<li><strong>Profile CPU usage</strong>: Async profiler to identify hot methods</li>
<li><strong>Check thread states</strong>: <code>jstack</code> for thread contention</li>
<li><strong>JIT compilation</strong>: <code>-XX:+PrintCompilation</code> for compilation storms</li>
<li><strong>Lock contention</strong>: Thread dump analysis for blocked threads</li>
</ol>
<p><strong>Root causes often include</strong>:</p>
<ul>
<li>Inefficient algorithms causing excessive GC</li>
<li>Lock contention preventing parallel execution</li>
<li>Memory pressure causing constant GC activity</li>
</ul>
<p>This comprehensive guide provides both theoretical understanding and practical expertise needed for JVM performance tuning in production environments. The integrated interview insights ensure you’re prepared for both implementation and technical discussions.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/12/Redis-Distributed-Locking-Complete-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/12/Redis-Distributed-Locking-Complete-Guide/" class="post-title-link" itemprop="url">Redis Distributed Locking: Complete Guide</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-12 14:38:15 / Modified: 14:39:58" itemprop="dateCreated datePublished" datetime="2025-06-12T14:38:15+08:00">2025-06-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Distributed locking is a critical mechanism for coordinating access to shared resources across multiple processes or services in a distributed system. Redis, with its atomic operations and high performance, has become a popular choice for implementing distributed locks.</p>
<p><strong>Interview Insight</strong>: <em>Expect questions like “Why would you use Redis for distributed locking instead of database-based locks?” The key advantages are: Redis operates in memory (faster), provides atomic operations, has built-in TTL support, and offers better performance for high-frequency locking scenarios.</em></p>
<h3 id="When-to-Use-Distributed-Locks"><a href="#When-to-Use-Distributed-Locks" class="headerlink" title="When to Use Distributed Locks"></a>When to Use Distributed Locks</h3><ul>
<li>Preventing duplicate processing of tasks</li>
<li>Coordinating access to external APIs with rate limits</li>
<li>Ensuring single leader election in distributed systems</li>
<li>Managing shared resource access across microservices</li>
<li>Implementing distributed rate limiting</li>
</ul>
<h2 id="Core-Concepts"><a href="#Core-Concepts" class="headerlink" title="Core Concepts"></a>Core Concepts</h2><h3 id="Lock-Properties"><a href="#Lock-Properties" class="headerlink" title="Lock Properties"></a>Lock Properties</h3><p>A robust distributed lock must satisfy several properties:</p>
<ol>
<li><strong>Mutual Exclusion</strong>: Only one client can hold the lock at any time</li>
<li><strong>Deadlock Free</strong>: Eventually, it’s always possible to acquire the lock</li>
<li><strong>Fault Tolerance</strong>: Lock acquisition and release work even when clients fail</li>
<li><strong>Safety</strong>: Lock is not granted to multiple clients simultaneously</li>
<li><strong>Liveness</strong>: Requests to acquire&#x2F;release locks eventually succeed</li>
</ol>
<p><strong>Interview Insight</strong>: <em>Interviewers often ask about the CAP theorem implications. Distributed locks typically favor Consistency and Partition tolerance over Availability - it’s better to fail lock acquisition than to grant locks to multiple clients.</em></p>
<pre>
<code class="mermaid">
graph TD
A[Client Request] --&gt; B{Lock Available?}
B --&gt;|Yes| C[Acquire Lock with TTL]
B --&gt;|No| D[Wait&#x2F;Retry]
C --&gt; E[Execute Critical Section]
E --&gt; F[Release Lock]
D --&gt; G[Timeout Check]
G --&gt;|Continue| B
G --&gt;|Timeout| H[Fail]
F --&gt; I[Success]
</code>
</pre>

<h3 id="Redis-Atomic-Operations"><a href="#Redis-Atomic-Operations" class="headerlink" title="Redis Atomic Operations"></a>Redis Atomic Operations</h3><p>Redis provides several atomic operations crucial for distributed locking:</p>
<ul>
<li><code>SET key value NX EX seconds</code> - Set if not exists with expiration</li>
<li><code>EVAL</code> - Execute Lua scripts atomically</li>
<li><code>DEL</code> - Delete keys atomically</li>
</ul>
<h2 id="Single-Instance-Redis-Locking"><a href="#Single-Instance-Redis-Locking" class="headerlink" title="Single Instance Redis Locking"></a>Single Instance Redis Locking</h2><h3 id="Basic-Implementation"><a href="#Basic-Implementation" class="headerlink" title="Basic Implementation"></a>Basic Implementation</h3><p>The simplest approach uses a single Redis instance with the <code>SET</code> command:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RedisLock</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client, key, timeout=<span class="number">10</span>, retry_delay=<span class="number">0.1</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis_client</span><br><span class="line">        <span class="variable language_">self</span>.key = key</span><br><span class="line">        <span class="variable language_">self</span>.timeout = timeout</span><br><span class="line">        <span class="variable language_">self</span>.retry_delay = retry_delay</span><br><span class="line">        <span class="variable language_">self</span>.identifier = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">acquire</span>(<span class="params">self, blocking=<span class="literal">True</span>, timeout=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Acquire the lock&quot;&quot;&quot;</span></span><br><span class="line">        end_time = time.time() + (timeout <span class="keyword">or</span> <span class="variable language_">self</span>.timeout)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="comment"># Try to set the key with our identifier and TTL</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.redis.<span class="built_in">set</span>(<span class="variable language_">self</span>.key, <span class="variable language_">self</span>.identifier, nx=<span class="literal">True</span>, ex=<span class="variable language_">self</span>.timeout):</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> blocking <span class="keyword">or</span> time.time() &gt; end_time:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            </span><br><span class="line">            time.sleep(<span class="variable language_">self</span>.retry_delay)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">release</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Release the lock using Lua script for atomicity&quot;&quot;&quot;</span></span><br><span class="line">        lua_script = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        if redis.call(&quot;GET&quot;, KEYS[1]) == ARGV[1] then</span></span><br><span class="line"><span class="string">            return redis.call(&quot;DEL&quot;, KEYS[1])</span></span><br><span class="line"><span class="string">        else</span></span><br><span class="line"><span class="string">            return 0</span></span><br><span class="line"><span class="string">        end</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.redis.<span class="built_in">eval</span>(lua_script, <span class="number">1</span>, <span class="variable language_">self</span>.key, <span class="variable language_">self</span>.identifier)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage example</span></span><br><span class="line">redis_client = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">lock = RedisLock(redis_client, <span class="string">&quot;my_resource_lock&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> lock.acquire():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># Critical section</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Lock acquired, executing critical section&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">5</span>)  <span class="comment"># Simulate work</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        lock.release()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Lock released&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Failed to acquire lock&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>A common question is “Why do you need a unique identifier for each lock holder?” The identifier prevents a client from accidentally releasing another client’s lock, especially important when dealing with timeouts and retries.</em></p>
<h3 id="Context-Manager-Implementation"><a href="#Context-Manager-Implementation" class="headerlink" title="Context Manager Implementation"></a>Context Manager Implementation</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> contextlib <span class="keyword">import</span> contextmanager</span><br><span class="line"></span><br><span class="line"><span class="meta">@contextmanager</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">redis_lock</span>(<span class="params">redis_client, key, timeout=<span class="number">10</span></span>):</span><br><span class="line">    lock = RedisLock(redis_client, key, timeout)</span><br><span class="line">    acquired = lock.acquire()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> acquired:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">f&quot;Could not acquire lock for <span class="subst">&#123;key&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        lock.release()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">with</span> redis_lock(redis_client, <span class="string">&quot;my_resource&quot;</span>):</span><br><span class="line">        <span class="comment"># Critical section code here</span></span><br><span class="line">        process_shared_resource()</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Lock acquisition failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Single-Instance-Limitations"><a href="#Single-Instance-Limitations" class="headerlink" title="Single Instance Limitations"></a>Single Instance Limitations</h3><pre>
<code class="mermaid">
flowchart TD
A[Client A] --&gt; B[Redis Master]
C[Client B] --&gt; B
B --&gt; D[Redis Slave]
B --&gt;|Fails| E[Data Loss]
E --&gt; F[Both Clients Think They Have Lock]

style E fill:#ff9999
style F fill:#ff9999
</code>
</pre>

<p><strong>Interview Insight</strong>: <em>Interviewers will ask about single points of failure. The main issues are: Redis instance failure loses all locks, replication lag can cause multiple clients to acquire the same lock, and network partitions can lead to split-brain scenarios.</em></p>
<h2 id="The-Redlock-Algorithm"><a href="#The-Redlock-Algorithm" class="headerlink" title="The Redlock Algorithm"></a>The Redlock Algorithm</h2><p>The Redlock algorithm, proposed by Redis creator Salvatore Sanfilippo, addresses single-instance limitations by using multiple independent Redis instances.</p>
<h3 id="Algorithm-Steps"><a href="#Algorithm-Steps" class="headerlink" title="Algorithm Steps"></a>Algorithm Steps</h3><pre>
<code class="mermaid">
sequenceDiagram
participant C as Client
participant R1 as Redis 1
participant R2 as Redis 2
participant R3 as Redis 3
participant R4 as Redis 4
participant R5 as Redis 5

Note over C: Start timer
C-&gt;&gt;R1: SET lock_key unique_id NX EX ttl
C-&gt;&gt;R2: SET lock_key unique_id NX EX ttl
C-&gt;&gt;R3: SET lock_key unique_id NX EX ttl
C-&gt;&gt;R4: SET lock_key unique_id NX EX ttl
C-&gt;&gt;R5: SET lock_key unique_id NX EX ttl

R1--&gt;&gt;C: OK
R2--&gt;&gt;C: OK
R3--&gt;&gt;C: FAIL
R4--&gt;&gt;C: OK
R5--&gt;&gt;C: FAIL

Note over C: Check: 3&#x2F;5 nodes acquired&lt;br&#x2F;&gt;Time elapsed &lt; TTL&lt;br&#x2F;&gt;Lock is valid
</code>
</pre>

<h3 id="Redlock-Implementation"><a href="#Redlock-Implementation" class="headerlink" title="Redlock Implementation"></a>Redlock Implementation</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Redlock</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_instances: <span class="type">List</span>[redis.Redis], retry_count=<span class="number">3</span>, retry_delay=<span class="number">0.2</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis_instances = redis_instances</span><br><span class="line">        <span class="variable language_">self</span>.retry_count = retry_count</span><br><span class="line">        <span class="variable language_">self</span>.retry_delay = retry_delay</span><br><span class="line">        <span class="variable language_">self</span>.quorum = <span class="built_in">len</span>(redis_instances) // <span class="number">2</span> + <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">acquire</span>(<span class="params">self, resource: <span class="built_in">str</span>, ttl: <span class="built_in">int</span> = <span class="number">10000</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Acquire lock on resource with TTL in milliseconds</span></span><br><span class="line"><span class="string">        Returns lock info if successful, None if failed</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        identifier = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="variable language_">self</span>.retry_count):</span><br><span class="line">            start_time = <span class="built_in">int</span>(time.time() * <span class="number">1000</span>)</span><br><span class="line">            successful_locks = <span class="number">0</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Try to acquire lock on all instances</span></span><br><span class="line">            <span class="keyword">for</span> redis_client <span class="keyword">in</span> <span class="variable language_">self</span>.redis_instances:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">if</span> redis_client.<span class="built_in">set</span>(resource, identifier, nx=<span class="literal">True</span>, px=ttl):</span><br><span class="line">                        successful_locks += <span class="number">1</span></span><br><span class="line">                <span class="keyword">except</span> Exception:</span><br><span class="line">                    <span class="comment"># Instance is down, continue with others</span></span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Calculate elapsed time</span></span><br><span class="line">            elapsed_time = <span class="built_in">int</span>(time.time() * <span class="number">1000</span>) - start_time</span><br><span class="line">            remaining_ttl = ttl - elapsed_time</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Check if we have quorum and enough time left</span></span><br><span class="line">            <span class="keyword">if</span> successful_locks &gt;= <span class="variable language_">self</span>.quorum <span class="keyword">and</span> remaining_ttl &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    <span class="string">&#x27;resource&#x27;</span>: resource,</span><br><span class="line">                    <span class="string">&#x27;identifier&#x27;</span>: identifier,</span><br><span class="line">                    <span class="string">&#x27;ttl&#x27;</span>: remaining_ttl,</span><br><span class="line">                    <span class="string">&#x27;acquired_locks&#x27;</span>: successful_locks</span><br><span class="line">                &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Failed to acquire majority, release acquired locks</span></span><br><span class="line">            <span class="variable language_">self</span>._release_locks(resource, identifier)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Random delay before retry to avoid thundering herd</span></span><br><span class="line">            time.sleep(<span class="variable language_">self</span>.retry_delay * (<span class="number">0.5</span> + <span class="number">0.5</span> * time.random()))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">release</span>(<span class="params">self, lock_info: <span class="built_in">dict</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Release the distributed lock&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._release_locks(lock_info[<span class="string">&#x27;resource&#x27;</span>], lock_info[<span class="string">&#x27;identifier&#x27;</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_release_locks</span>(<span class="params">self, resource: <span class="built_in">str</span>, identifier: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Release locks on all instances&quot;&quot;&quot;</span></span><br><span class="line">        lua_script = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        if redis.call(&quot;GET&quot;, KEYS[1]) == ARGV[1] then</span></span><br><span class="line"><span class="string">            return redis.call(&quot;DEL&quot;, KEYS[1])</span></span><br><span class="line"><span class="string">        else</span></span><br><span class="line"><span class="string">            return 0</span></span><br><span class="line"><span class="string">        end</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        released_count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> redis_client <span class="keyword">in</span> <span class="variable language_">self</span>.redis_instances:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> redis_client.<span class="built_in">eval</span>(lua_script, <span class="number">1</span>, resource, identifier):</span><br><span class="line">                    released_count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">except</span> Exception:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> released_count &gt;= <span class="variable language_">self</span>.quorum</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage example</span></span><br><span class="line">redis_nodes = [</span><br><span class="line">    redis.Redis(host=<span class="string">&#x27;redis1.example.com&#x27;</span>, port=<span class="number">6379</span>),</span><br><span class="line">    redis.Redis(host=<span class="string">&#x27;redis2.example.com&#x27;</span>, port=<span class="number">6379</span>),</span><br><span class="line">    redis.Redis(host=<span class="string">&#x27;redis3.example.com&#x27;</span>, port=<span class="number">6379</span>),</span><br><span class="line">    redis.Redis(host=<span class="string">&#x27;redis4.example.com&#x27;</span>, port=<span class="number">6379</span>),</span><br><span class="line">    redis.Redis(host=<span class="string">&#x27;redis5.example.com&#x27;</span>, port=<span class="number">6379</span>),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">redlock = Redlock(redis_nodes)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Acquire lock</span></span><br><span class="line">lock_info = redlock.acquire(<span class="string">&quot;shared_resource&quot;</span>, ttl=<span class="number">30000</span>)  <span class="comment"># 30 seconds</span></span><br><span class="line"><span class="keyword">if</span> lock_info:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># Critical section</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Lock acquired with <span class="subst">&#123;lock_info[<span class="string">&#x27;acquired_locks&#x27;</span>]&#125;</span> nodes&quot;</span>)</span><br><span class="line">        <span class="comment"># Do work...</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        redlock.release(lock_info)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Lock released&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Failed to acquire distributed lock&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Common question: “What’s the minimum number of Redis instances needed for Redlock?” Answer: Minimum 3 for meaningful fault tolerance, typically 5 is recommended. The formula is N &#x3D; 2F + 1, where N is total instances and F is the number of failures you want to tolerate.</em></p>
<h3 id="Redlock-Controversy"><a href="#Redlock-Controversy" class="headerlink" title="Redlock Controversy"></a>Redlock Controversy</h3><p>Martin Kleppmann’s criticism of Redlock highlights important considerations:</p>
<pre>
<code class="mermaid">
graph TD
A[Client Acquires Lock] --&gt; B[GC Pause&#x2F;Network Delay]
B --&gt; C[Lock Expires]
C --&gt; D[Another Client Acquires Same Lock]
D --&gt; E[Two Clients in Critical Section]

style E fill:#ff9999
</code>
</pre>

<p><strong>Interview Insight</strong>: <em>Be prepared to discuss the “Redlock controversy.” Kleppmann argued that Redlock doesn’t provide the safety guarantees it claims due to timing assumptions. The key issues are: clock synchronization requirements, GC pauses can cause timing issues, and fencing tokens provide better safety.</em></p>
<h2 id="Best-Practices-and-Common-Pitfalls"><a href="#Best-Practices-and-Common-Pitfalls" class="headerlink" title="Best Practices and Common Pitfalls"></a>Best Practices and Common Pitfalls</h2><h3 id="1-Appropriate-TTL-Selection"><a href="#1-Appropriate-TTL-Selection" class="headerlink" title="1. Appropriate TTL Selection"></a>1. Appropriate TTL Selection</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AdaptiveLock</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client, base_ttl=<span class="number">10</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis_client</span><br><span class="line">        <span class="variable language_">self</span>.base_ttl = base_ttl</span><br><span class="line">        <span class="variable language_">self</span>.execution_times = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">acquire_with_adaptive_ttl</span>(<span class="params">self, key, expected_execution_time=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Acquire lock with TTL based on expected execution time&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> expected_execution_time:</span><br><span class="line">            <span class="comment"># TTL should be significantly longer than expected execution</span></span><br><span class="line">            ttl = <span class="built_in">max</span>(expected_execution_time * <span class="number">3</span>, <span class="variable language_">self</span>.base_ttl)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># Use historical data to estimate</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.execution_times:</span><br><span class="line">                avg_time = <span class="built_in">sum</span>(<span class="variable language_">self</span>.execution_times) / <span class="built_in">len</span>(<span class="variable language_">self</span>.execution_times)</span><br><span class="line">                ttl = <span class="built_in">max</span>(avg_time * <span class="number">2</span>, <span class="variable language_">self</span>.base_ttl)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                ttl = <span class="variable language_">self</span>.base_ttl</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.redis.<span class="built_in">set</span>(key, <span class="built_in">str</span>(uuid.uuid4()), nx=<span class="literal">True</span>, ex=<span class="built_in">int</span>(ttl))</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>TTL selection is a classic interview topic. Too short &#x3D; risk of premature expiration; too long &#x3D; delayed recovery from failures. Best practice: TTL should be 2-3x your expected critical section execution time.</em></p>
<h3 id="2-Lock-Extension-for-Long-Operations"><a href="#2-Lock-Extension-for-Long-Operations" class="headerlink" title="2. Lock Extension for Long Operations"></a>2. Lock Extension for Long Operations</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExtendableLock</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client, key, initial_ttl=<span class="number">30</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis_client</span><br><span class="line">        <span class="variable language_">self</span>.key = key</span><br><span class="line">        <span class="variable language_">self</span>.ttl = initial_ttl</span><br><span class="line">        <span class="variable language_">self</span>.identifier = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">        <span class="variable language_">self</span>.extend_timer = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.acquired = <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">acquire</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Acquire lock and start auto-extension&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.redis.<span class="built_in">set</span>(<span class="variable language_">self</span>.key, <span class="variable language_">self</span>.identifier, nx=<span class="literal">True</span>, ex=<span class="variable language_">self</span>.ttl):</span><br><span class="line">            <span class="variable language_">self</span>.acquired = <span class="literal">True</span></span><br><span class="line">            <span class="variable language_">self</span>._start_extension_timer()</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_start_extension_timer</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Start timer to extend lock before expiration&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.acquired:</span><br><span class="line">            <span class="comment"># Extend at 1/3 of TTL interval</span></span><br><span class="line">            extend_interval = <span class="variable language_">self</span>.ttl / <span class="number">3</span></span><br><span class="line">            <span class="variable language_">self</span>.extend_timer = threading.Timer(extend_interval, <span class="variable language_">self</span>._extend_lock)</span><br><span class="line">            <span class="variable language_">self</span>.extend_timer.start()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_extend_lock</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Extend lock TTL if still held by us&quot;&quot;&quot;</span></span><br><span class="line">        lua_script = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        if redis.call(&quot;GET&quot;, KEYS[1]) == ARGV[1] then</span></span><br><span class="line"><span class="string">            redis.call(&quot;EXPIRE&quot;, KEYS[1], ARGV[2])</span></span><br><span class="line"><span class="string">            return 1</span></span><br><span class="line"><span class="string">        else</span></span><br><span class="line"><span class="string">            return 0</span></span><br><span class="line"><span class="string">        end</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.redis.<span class="built_in">eval</span>(lua_script, <span class="number">1</span>, <span class="variable language_">self</span>.key, <span class="variable language_">self</span>.identifier, <span class="variable language_">self</span>.ttl):</span><br><span class="line">            <span class="variable language_">self</span>._start_extension_timer()  <span class="comment"># Schedule next extension</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.acquired = <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">release</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Release lock and stop extensions&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.extend_timer:</span><br><span class="line">            <span class="variable language_">self</span>.extend_timer.cancel()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.acquired:</span><br><span class="line">            lua_script = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            if redis.call(&quot;GET&quot;, KEYS[1]) == ARGV[1] then</span></span><br><span class="line"><span class="string">                return redis.call(&quot;DEL&quot;, KEYS[1])</span></span><br><span class="line"><span class="string">            else</span></span><br><span class="line"><span class="string">                return 0</span></span><br><span class="line"><span class="string">            end</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.redis.<span class="built_in">eval</span>(lua_script, <span class="number">1</span>, <span class="variable language_">self</span>.key, <span class="variable language_">self</span>.identifier)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<h3 id="3-Retry-Strategies"><a href="#3-Retry-Strategies" class="headerlink" title="3. Retry Strategies"></a>3. Retry Strategies</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RetryStrategy</span>:</span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">exponential_backoff</span>(<span class="params">attempt, base_delay=<span class="number">0.1</span>, max_delay=<span class="number">60</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Exponential backoff with jitter&quot;&quot;&quot;</span></span><br><span class="line">        delay = <span class="built_in">min</span>(base_delay * (<span class="number">2</span> ** attempt), max_delay)</span><br><span class="line">        <span class="comment"># Add jitter to prevent thundering herd</span></span><br><span class="line">        jitter = delay * <span class="number">0.1</span> * random.random()</span><br><span class="line">        <span class="keyword">return</span> delay + jitter</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">linear_backoff</span>(<span class="params">attempt, base_delay=<span class="number">0.1</span>, increment=<span class="number">0.1</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Linear backoff&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> base_delay + (attempt * increment)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RobustRedisLock</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client, key, max_retries=<span class="number">10</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis_client</span><br><span class="line">        <span class="variable language_">self</span>.key = key</span><br><span class="line">        <span class="variable language_">self</span>.max_retries = max_retries</span><br><span class="line">        <span class="variable language_">self</span>.identifier = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">acquire</span>(<span class="params">self, timeout=<span class="number">30</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Acquire lock with retry strategy&quot;&quot;&quot;</span></span><br><span class="line">        start_time = time.time()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> attempt <span class="keyword">in</span> <span class="built_in">range</span>(<span class="variable language_">self</span>.max_retries):</span><br><span class="line">            <span class="keyword">if</span> time.time() - start_time &gt; timeout:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.redis.<span class="built_in">set</span>(<span class="variable language_">self</span>.key, <span class="variable language_">self</span>.identifier, nx=<span class="literal">True</span>, ex=<span class="number">30</span>):</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Wait before retry</span></span><br><span class="line">            delay = RetryStrategy.exponential_backoff(attempt)</span><br><span class="line">            time.sleep(delay)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Retry strategy questions are common. Key points: exponential backoff prevents overwhelming the system, jitter prevents thundering herd, and you need maximum retry limits to avoid infinite loops.</em></p>
<h3 id="4-Common-Pitfalls"><a href="#4-Common-Pitfalls" class="headerlink" title="4. Common Pitfalls"></a>4. Common Pitfalls</h3><h4 id="Pitfall-1-Race-Condition-in-Release"><a href="#Pitfall-1-Race-Condition-in-Release" class="headerlink" title="Pitfall 1: Race Condition in Release"></a>Pitfall 1: Race Condition in Release</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># WRONG - Race condition</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bad_release</span>(<span class="params">redis_client, key, identifier</span>):</span><br><span class="line">    <span class="keyword">if</span> redis_client.get(key) == identifier:</span><br><span class="line">        <span class="comment"># Another process could acquire the lock here!</span></span><br><span class="line">        redis_client.delete(key)</span><br><span class="line"></span><br><span class="line"><span class="comment"># CORRECT - Atomic release using Lua script</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">good_release</span>(<span class="params">redis_client, key, identifier</span>):</span><br><span class="line">    lua_script = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    if redis.call(&quot;GET&quot;, KEYS[1]) == ARGV[1] then</span></span><br><span class="line"><span class="string">        return redis.call(&quot;DEL&quot;, KEYS[1])</span></span><br><span class="line"><span class="string">    else</span></span><br><span class="line"><span class="string">        return 0</span></span><br><span class="line"><span class="string">    end</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> redis_client.<span class="built_in">eval</span>(lua_script, <span class="number">1</span>, key, identifier)</span><br></pre></td></tr></table></figure>

<h4 id="Pitfall-2-Clock-Drift-Issues"><a href="#Pitfall-2-Clock-Drift-Issues" class="headerlink" title="Pitfall 2: Clock Drift Issues"></a>Pitfall 2: Clock Drift Issues</h4><pre>
<code class="mermaid">
graph TD
A[Server A Clock: 10:00:00] --&gt; B[Acquires Lock TTL&#x3D;10s]
C[Server B Clock: 10:00:05] --&gt; D[Sees Lock Will Expire at 10:00:15]
B --&gt; E[Server A Clock Drifts Behind]
E --&gt; F[Lock Actually Expires Earlier]
D --&gt; G[Server B Acquires Lock Prematurely]

style F fill:#ff9999
style G fill:#ff9999
</code>
</pre>

<p><strong>Interview Insight</strong>: <em>Clock drift is a subtle but important issue. Solutions include: using relative timeouts instead of absolute timestamps, implementing clock synchronization (NTP), and considering logical clocks for ordering.</em></p>
<h2 id="Production-Considerations"><a href="#Production-Considerations" class="headerlink" title="Production Considerations"></a>Production Considerations</h2><h3 id="Monitoring-and-Observability"><a href="#Monitoring-and-Observability" class="headerlink" title="Monitoring and Observability"></a>Monitoring and Observability</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">Any</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LockMetrics</span>:</span><br><span class="line">    acquisition_time: <span class="built_in">float</span></span><br><span class="line">    hold_time: <span class="built_in">float</span></span><br><span class="line">    success: <span class="built_in">bool</span></span><br><span class="line">    retries: <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MonitoredRedisLock</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client, key, metrics_collector=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis_client</span><br><span class="line">        <span class="variable language_">self</span>.key = key</span><br><span class="line">        <span class="variable language_">self</span>.identifier = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">        <span class="variable language_">self</span>.metrics = metrics_collector</span><br><span class="line">        <span class="variable language_">self</span>.acquire_start_time = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.lock_acquired_time = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">acquire</span>(<span class="params">self, timeout=<span class="number">30</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Acquire lock with metrics collection&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.acquire_start_time = time.time()</span><br><span class="line">        retries = <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> time.time() - <span class="variable language_">self</span>.acquire_start_time &lt; timeout:</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.redis.<span class="built_in">set</span>(<span class="variable language_">self</span>.key, <span class="variable language_">self</span>.identifier, nx=<span class="literal">True</span>, ex=<span class="number">30</span>):</span><br><span class="line">                <span class="variable language_">self</span>.lock_acquired_time = time.time()</span><br><span class="line">                acquisition_time = <span class="variable language_">self</span>.lock_acquired_time - <span class="variable language_">self</span>.acquire_start_time</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># Log successful acquisition</span></span><br><span class="line">                logging.info(<span class="string">f&quot;Lock acquired for <span class="subst">&#123;self.key&#125;</span> after <span class="subst">&#123;acquisition_time:<span class="number">.3</span>f&#125;</span>s and <span class="subst">&#123;retries&#125;</span> retries&quot;</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> <span class="variable language_">self</span>.metrics:</span><br><span class="line">                    <span class="variable language_">self</span>.metrics.record_acquisition(<span class="variable language_">self</span>.key, acquisition_time, retries)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            </span><br><span class="line">            retries += <span class="number">1</span></span><br><span class="line">            time.sleep(<span class="number">0.1</span> * retries)  <span class="comment"># Progressive backoff</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Log acquisition failure</span></span><br><span class="line">        logging.warning(<span class="string">f&quot;Failed to acquire lock for <span class="subst">&#123;self.key&#125;</span> after <span class="subst">&#123;timeout&#125;</span>s and <span class="subst">&#123;retries&#125;</span> retries&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">release</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Release lock with metrics&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.lock_acquired_time:</span><br><span class="line">            hold_time = time.time() - <span class="variable language_">self</span>.lock_acquired_time</span><br><span class="line">            </span><br><span class="line">            lua_script = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            if redis.call(&quot;GET&quot;, KEYS[1]) == ARGV[1] then</span></span><br><span class="line"><span class="string">                return redis.call(&quot;DEL&quot;, KEYS[1])</span></span><br><span class="line"><span class="string">            else</span></span><br><span class="line"><span class="string">                return 0</span></span><br><span class="line"><span class="string">            end</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">            </span><br><span class="line">            success = <span class="built_in">bool</span>(<span class="variable language_">self</span>.redis.<span class="built_in">eval</span>(lua_script, <span class="number">1</span>, <span class="variable language_">self</span>.key, <span class="variable language_">self</span>.identifier))</span><br><span class="line">            </span><br><span class="line">            logging.info(<span class="string">f&quot;Lock released for <span class="subst">&#123;self.key&#125;</span> after <span class="subst">&#123;hold_time:<span class="number">.3</span>f&#125;</span>s hold time&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.metrics:</span><br><span class="line">                <span class="variable language_">self</span>.metrics.record_release(<span class="variable language_">self</span>.key, hold_time, success)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> success</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<h3 id="Health-Checks-and-Circuit-Breakers"><a href="#Health-Checks-and-Circuit-Breakers" class="headerlink" title="Health Checks and Circuit Breakers"></a>Health Checks and Circuit Breakers</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CircuitState</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    CLOSED = <span class="string">&quot;closed&quot;</span></span><br><span class="line">    OPEN = <span class="string">&quot;open&quot;</span></span><br><span class="line">    HALF_OPEN = <span class="string">&quot;half_open&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CircuitBreaker</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, failure_threshold=<span class="number">5</span>, timeout=<span class="number">60</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.failure_threshold = failure_threshold</span><br><span class="line">        <span class="variable language_">self</span>.timeout = timeout</span><br><span class="line">        <span class="variable language_">self</span>.failure_count = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.last_failure_time = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.state = CircuitState.CLOSED</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">call</span>(<span class="params">self, func, *args, **kwargs</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Execute function with circuit breaker protection&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.state == CircuitState.OPEN:</span><br><span class="line">            <span class="keyword">if</span> time.time() - <span class="variable language_">self</span>.last_failure_time &gt; <span class="variable language_">self</span>.timeout:</span><br><span class="line">                <span class="variable language_">self</span>.state = CircuitState.HALF_OPEN</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> Exception(<span class="string">&quot;Circuit breaker is OPEN&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = func(*args, **kwargs)</span><br><span class="line">            <span class="variable language_">self</span>._on_success()</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="variable language_">self</span>._on_failure()</span><br><span class="line">            <span class="keyword">raise</span> e</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_on_success</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.failure_count = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.state = CircuitState.CLOSED</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_on_failure</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.failure_count += <span class="number">1</span></span><br><span class="line">        <span class="variable language_">self</span>.last_failure_time = time.time()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.failure_count &gt;= <span class="variable language_">self</span>.failure_threshold:</span><br><span class="line">            <span class="variable language_">self</span>.state = CircuitState.OPEN</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResilientRedisLock</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client, circuit_breaker=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis_client</span><br><span class="line">        <span class="variable language_">self</span>.circuit_breaker = circuit_breaker <span class="keyword">or</span> CircuitBreaker()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">acquire</span>(<span class="params">self, key, timeout=<span class="number">30</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Acquire lock with circuit breaker protection&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">_acquire</span>():</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.redis.<span class="built_in">set</span>(key, <span class="built_in">str</span>(uuid.uuid4()), nx=<span class="literal">True</span>, ex=timeout)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.circuit_breaker.call(_acquire)</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="comment"># Fallback: maybe use local locking or skip the operation</span></span><br><span class="line">            logging.error(<span class="string">f&quot;Lock acquisition failed for <span class="subst">&#123;key&#125;</span>, circuit breaker activated&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Production readiness questions often focus on: How do you monitor lock performance? What happens when Redis is down? How do you handle lock contention? Be prepared to discuss circuit breakers, fallback strategies, and metrics collection.</em></p>
<h2 id="Alternative-Approaches"><a href="#Alternative-Approaches" class="headerlink" title="Alternative Approaches"></a>Alternative Approaches</h2><h3 id="Database-Based-Locking"><a href="#Database-Based-Locking" class="headerlink" title="Database-Based Locking"></a>Database-Based Locking</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Simple database lock table</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> distributed_locks (</span><br><span class="line">    lock_name <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    owner_id <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    acquired_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    expires_at <span class="type">TIMESTAMP</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    INDEX idx_expires_at (expires_at)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Acquire lock with timeout</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> distributed_locks (lock_name, owner_id, expires_at)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;resource_lock&#x27;</span>, <span class="string">&#x27;client_123&#x27;</span>, DATE_ADD(NOW(), <span class="type">INTERVAL</span> <span class="number">30</span> <span class="keyword">SECOND</span>))</span><br><span class="line"><span class="keyword">ON</span> DUPLICATE KEY <span class="keyword">UPDATE</span></span><br><span class="line">    owner_id <span class="operator">=</span> <span class="keyword">CASE</span> </span><br><span class="line">        <span class="keyword">WHEN</span> expires_at <span class="operator">&lt;</span> NOW() <span class="keyword">THEN</span> <span class="keyword">VALUES</span>(owner_id)</span><br><span class="line">        <span class="keyword">ELSE</span> owner_id</span><br><span class="line">    <span class="keyword">END</span>,</span><br><span class="line">    expires_at <span class="operator">=</span> <span class="keyword">CASE</span> </span><br><span class="line">        <span class="keyword">WHEN</span> expires_at <span class="operator">&lt;</span> NOW() <span class="keyword">THEN</span> <span class="keyword">VALUES</span>(expires_at)</span><br><span class="line">        <span class="keyword">ELSE</span> expires_at</span><br><span class="line">    <span class="keyword">END</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Consensus-Based-Solutions"><a href="#Consensus-Based-Solutions" class="headerlink" title="Consensus-Based Solutions"></a>Consensus-Based Solutions</h3><pre>
<code class="mermaid">
graph TD
A[Client Request] --&gt; B[Raft Leader]
B --&gt; C[Propose Lock Acquisition]
C --&gt; D[Replicate to Majority]
D --&gt; E[Commit Lock Entry]
E --&gt; F[Respond to Client]

G[etcd&#x2F;Consul] --&gt; H[Strong Consistency]
H --&gt; I[Partition Tolerance]
I --&gt; J[Higher Latency]
</code>
</pre>

<p><strong>Interview Insight</strong>: <em>When asked about alternatives, discuss trade-offs: Database locks provide ACID guarantees but are slower; Consensus systems like etcd&#x2F;Consul provide stronger consistency but higher latency; ZooKeeper offers hierarchical locks but operational complexity.</em></p>
<h3 id="Comparison-Matrix"><a href="#Comparison-Matrix" class="headerlink" title="Comparison Matrix"></a>Comparison Matrix</h3><table>
<thead>
<tr>
<th>Solution</th>
<th>Consistency</th>
<th>Performance</th>
<th>Complexity</th>
<th>Fault Tolerance</th>
</tr>
</thead>
<tbody><tr>
<td>Single Redis</td>
<td>Weak</td>
<td>High</td>
<td>Low</td>
<td>Poor</td>
</tr>
<tr>
<td>Redlock</td>
<td>Medium</td>
<td>Medium</td>
<td>Medium</td>
<td>Good</td>
</tr>
<tr>
<td>Database</td>
<td>Strong</td>
<td>Low</td>
<td>Low</td>
<td>Good</td>
</tr>
<tr>
<td>etcd&#x2F;Consul</td>
<td>Strong</td>
<td>Medium</td>
<td>High</td>
<td>Excellent</td>
</tr>
<tr>
<td>ZooKeeper</td>
<td>Strong</td>
<td>Medium</td>
<td>High</td>
<td>Excellent</td>
</tr>
</tbody></table>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Distributed locking with Redis offers a pragmatic balance between performance and consistency for many use cases. The key takeaways are:</p>
<ol>
<li><strong>Single Redis instance</strong> is suitable for non-critical applications where performance matters more than absolute consistency</li>
<li><strong>Redlock algorithm</strong> provides better fault tolerance but comes with complexity and timing assumptions</li>
<li><strong>Proper implementation</strong> requires attention to atomicity, TTL management, and retry strategies</li>
<li><strong>Production deployment</strong> needs monitoring, circuit breakers, and fallback mechanisms</li>
<li><strong>Alternative solutions</strong> like consensus systems may be better for critical applications requiring strong consistency</li>
</ol>
<p><strong>Final Interview Insight</strong>: <em>The most important interview question is often: “When would you NOT use Redis for distributed locking?” Be ready to discuss scenarios requiring strong consistency (financial transactions), long-running locks (batch processing), or hierarchical locking (resource trees) where other solutions might be more appropriate.</em></p>
<p>Remember: distributed locking is fundamentally about trade-offs between consistency, availability, and partition tolerance. Choose the solution that best fits your specific requirements and constraints.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/10/Redis-Cache-Patterns-and-Consistency-Assurance/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/10/Redis-Cache-Patterns-and-Consistency-Assurance/" class="post-title-link" itemprop="url">Redis Cache Patterns and Consistency Assurance</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-10 18:47:55" itemprop="dateCreated datePublished" datetime="2025-06-10T18:47:55+08:00">2025-06-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-19 15:28:53" itemprop="dateModified" datetime="2025-06-19T15:28:53+08:00">2025-06-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Redis serves as a high-performance in-memory data structure store, commonly used as a cache, database, and message broker. Understanding caching patterns and consistency mechanisms is crucial for building scalable, reliable systems.</p>
<p><strong>🎯 Interview Insight</strong>: <em>Interviewers often ask about the trade-offs between performance and consistency. Be prepared to discuss CAP theorem implications and when to choose eventual consistency over strong consistency.</em></p>
<h3 id="Why-Caching-Matters"><a href="#Why-Caching-Matters" class="headerlink" title="Why Caching Matters"></a>Why Caching Matters</h3><ul>
<li><strong>Reduced Latency</strong>: Sub-millisecond response times for cached data</li>
<li><strong>Decreased Database Load</strong>: Offloads read operations from primary databases</li>
<li><strong>Improved Scalability</strong>: Handles higher concurrent requests</li>
<li><strong>Cost Efficiency</strong>: Reduces expensive database operations</li>
<li></li>
</ul>
<h3 id="Key-Benefits-of-Redis-Caching"><a href="#Key-Benefits-of-Redis-Caching" class="headerlink" title="Key Benefits of Redis Caching"></a>Key Benefits of Redis Caching</h3><ul>
<li><strong>Performance</strong>: Sub-millisecond latency for most operations</li>
<li><strong>Scalability</strong>: Handles millions of requests per second</li>
<li><strong>Flexibility</strong>: Rich data structures (strings, hashes, lists, sets, sorted sets)</li>
<li><strong>Persistence</strong>: Optional durability with RDB&#x2F;AOF</li>
<li><strong>High Availability</strong>: Redis Sentinel and Cluster support</li>
</ul>
<h2 id="Core-Caching-Patterns"><a href="#Core-Caching-Patterns" class="headerlink" title="Core Caching Patterns"></a>Core Caching Patterns</h2><h3 id="1-Cache-Aside-Lazy-Loading"><a href="#1-Cache-Aside-Lazy-Loading" class="headerlink" title="1. Cache-Aside (Lazy Loading)"></a>1. Cache-Aside (Lazy Loading)</h3><p>The application manages the cache directly, loading data on cache misses.</p>
<pre>
<code class="mermaid">
sequenceDiagram
participant App as Application
participant Cache as Redis Cache
participant DB as Database

App-&gt;&gt;Cache: GET user:123
Cache--&gt;&gt;App: Cache Miss (null)
App-&gt;&gt;DB: SELECT * FROM users WHERE id&#x3D;123
DB--&gt;&gt;App: User data
App-&gt;&gt;Cache: SET user:123 {user_data} EX 3600
Cache--&gt;&gt;App: OK
App--&gt;&gt;App: Return user data
</code>
</pre>

<p><strong>Implementation Example:</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CacheAsidePattern</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.cache_ttl = <span class="number">3600</span>  <span class="comment"># 1 hour</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">self, user_id</span>):</span><br><span class="line">        cache_key = <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Try cache first</span></span><br><span class="line">        cached_data = <span class="variable language_">self</span>.redis_client.get(cache_key)</span><br><span class="line">        <span class="keyword">if</span> cached_data:</span><br><span class="line">            <span class="keyword">return</span> json.loads(cached_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Cache miss - fetch from database</span></span><br><span class="line">        user_data = <span class="variable language_">self</span>.fetch_user_from_db(user_id)</span><br><span class="line">        <span class="keyword">if</span> user_data:</span><br><span class="line">            <span class="comment"># Store in cache with TTL</span></span><br><span class="line">            <span class="variable language_">self</span>.redis_client.setex(</span><br><span class="line">                cache_key, </span><br><span class="line">                <span class="variable language_">self</span>.cache_ttl, </span><br><span class="line">                json.dumps(user_data)</span><br><span class="line">            )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> user_data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update_user</span>(<span class="params">self, user_id, user_data</span>):</span><br><span class="line">        <span class="comment"># Update database</span></span><br><span class="line">        <span class="variable language_">self</span>.update_user_in_db(user_id, user_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Invalidate cache</span></span><br><span class="line">        cache_key = <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.redis_client.delete(cache_key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> user_data</span><br></pre></td></tr></table></figure>
<p><strong>Pros:</strong></p>
<ul>
<li>Simple to implement and understand</li>
<li>Cache only contains requested data</li>
<li>Resilient to cache failures</li>
</ul>
<p><strong>Cons:</strong></p>
<ul>
<li>Cache miss penalty (extra database call)</li>
<li>Potential cache stampede issues</li>
<li>Data staleness between updates</li>
</ul>
<p><strong>💡 Interview Insight</strong>: <em>Discuss cache stampede scenarios: multiple requests hitting the same missing key simultaneously. Solutions include distributed locking or probabilistic refresh.</em></p>
<h3 id="2-Write-Through"><a href="#2-Write-Through" class="headerlink" title="2. Write-Through"></a>2. Write-Through</h3><p>Data is written to both cache and database simultaneously.</p>
<pre>
<code class="mermaid">
sequenceDiagram
participant App as Application
participant Cache as Redis Cache
participant DB as Database

App-&gt;&gt;Cache: SET key data
Cache-&gt;&gt;DB: UPDATE data
DB--&gt;&gt;Cache: Success
Cache--&gt;&gt;App: Success

Note over App,DB: Read requests served directly from cache
</code>
</pre>

<p><strong>Implementation Example:</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">WriteThroughPattern</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_user</span>(<span class="params">self, user_id, user_data</span>):</span><br><span class="line">        cache_key = <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># Write to database first</span></span><br><span class="line">            <span class="variable language_">self</span>.save_user_to_db(user_id, user_data)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Then write to cache</span></span><br><span class="line">            <span class="variable language_">self</span>.redis_client.<span class="built_in">set</span>(cache_key, json.dumps(user_data))</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># Rollback cache if database write fails</span></span><br><span class="line">            <span class="variable language_">self</span>.redis_client.delete(cache_key)</span><br><span class="line">            <span class="keyword">raise</span> e</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">self, user_id</span>):</span><br><span class="line">        cache_key = <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">        cached_data = <span class="variable language_">self</span>.redis_client.get(cache_key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> cached_data:</span><br><span class="line">            <span class="keyword">return</span> json.loads(cached_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># This should rarely happen in write-through</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.fetch_user_from_db(user_id)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>Pros:</strong></p>
<ul>
<li>Data consistency between cache and database</li>
<li>Fast read performance</li>
<li>No cache miss penalty for written data</li>
</ul>
<p><strong>Cons:</strong></p>
<ul>
<li>Higher write latency</li>
<li>Writes to cache even for data that may never be read</li>
<li>More complex error handling</li>
</ul>
<h3 id="3-Write-Behind-Write-Back"><a href="#3-Write-Behind-Write-Back" class="headerlink" title="3. Write-Behind (Write-Back)"></a>3. Write-Behind (Write-Back)</h3><p>Data is written to cache immediately and to the database asynchronously.</p>
<pre>
<code class="mermaid">
sequenceDiagram
participant App as Application
participant Cache as Redis Cache
participant Queue as Write Queue
participant DB as Database

App-&gt;&gt;Cache: SET user:123 {updated_data}
Cache--&gt;&gt;App: OK (immediate)
Cache-&gt;&gt;Queue: Enqueue write operation
Queue-&gt;&gt;DB: Async UPDATE users
DB--&gt;&gt;Queue: Success
</code>
</pre>
<p><strong>Implementation Example:</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WriteBehindPattern</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.write_queue = Queue()</span><br><span class="line">        <span class="variable language_">self</span>.start_background_writer()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_user</span>(<span class="params">self, user_id, user_data</span>):</span><br><span class="line">        cache_key = <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Immediate cache update</span></span><br><span class="line">        <span class="variable language_">self</span>.redis_client.<span class="built_in">set</span>(cache_key, json.dumps(user_data))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Queue for database write</span></span><br><span class="line">        <span class="variable language_">self</span>.write_queue.put(&#123;</span><br><span class="line">            <span class="string">&#x27;action&#x27;</span>: <span class="string">&#x27;update&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;user_id&#x27;</span>: user_id,</span><br><span class="line">            <span class="string">&#x27;data&#x27;</span>: user_data,</span><br><span class="line">            <span class="string">&#x27;timestamp&#x27;</span>: time.time()</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> user_data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start_background_writer</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">worker</span>():</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    item = <span class="variable language_">self</span>.write_queue.get(timeout=<span class="number">1</span>)</span><br><span class="line">                    <span class="variable language_">self</span>.process_write(item)</span><br><span class="line">                    <span class="variable language_">self</span>.write_queue.task_done()</span><br><span class="line">                <span class="keyword">except</span>:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">        thread = threading.Thread(target=worker, daemon=<span class="literal">True</span>)</span><br><span class="line">        thread.start()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_write</span>(<span class="params">self, item</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>.save_user_to_db(item[<span class="string">&#x27;user_id&#x27;</span>], item[<span class="string">&#x27;data&#x27;</span>])</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># Implement retry logic or dead letter queue</span></span><br><span class="line">            <span class="variable language_">self</span>.handle_write_failure(item, e)</span><br></pre></td></tr></table></figure>

<p><strong>Pros:</strong></p>
<ul>
<li>Excellent write performance</li>
<li>Reduced database load</li>
<li>Can batch writes for efficiency</li>
</ul>
<p><strong>Cons:</strong></p>
<ul>
<li>Risk of data loss on cache failure</li>
<li>Complex failure handling</li>
<li>Eventual consistency only</li>
</ul>
<p><strong>🎯 Interview Insight</strong>: <em>Write-behind offers better write performance but introduces complexity and potential data loss risks. Discuss scenarios where this pattern is appropriate (high write volume, acceptable eventual consistency,some data loss is acceptable, like analytics or logging systems).</em></p>
<h3 id="4-Refresh-Ahead"><a href="#4-Refresh-Ahead" class="headerlink" title="4. Refresh-Ahead"></a>4. Refresh-Ahead</h3><p>Proactively refresh cache entries before they expire.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RefreshAheadCache</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.refresh_threshold = <span class="number">0.8</span>  <span class="comment"># Refresh when 80% of TTL is reached</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_with_refresh_ahead</span>(<span class="params">self, key: <span class="built_in">str</span></span>):</span><br><span class="line">        data = <span class="variable language_">self</span>.redis.get(key)</span><br><span class="line">        ttl = <span class="variable language_">self</span>.redis.ttl(key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> data <span class="keyword">and</span> ttl &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># Check if refresh is needed</span></span><br><span class="line">            <span class="keyword">if</span> ttl &lt; (<span class="variable language_">self</span>.cache_ttl * (<span class="number">1</span> - <span class="variable language_">self</span>.refresh_threshold)):</span><br><span class="line">                <span class="comment"># Trigger async refresh</span></span><br><span class="line">                asyncio.create_task(<span class="variable language_">self</span>.refresh_cache_entry(key))</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> json.loads(data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Cache miss or expired</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> <span class="variable language_">self</span>.load_and_cache(key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">refresh_cache_entry</span>(<span class="params">self, key: <span class="built_in">str</span></span>):</span><br><span class="line">        fresh_data = <span class="keyword">await</span> <span class="variable language_">self</span>.fetch_fresh_data(key)</span><br><span class="line">        <span class="keyword">if</span> fresh_data:</span><br><span class="line">            <span class="variable language_">self</span>.redis.setex(key, <span class="variable language_">self</span>.cache_ttl, json.dumps(fresh_data))</span><br></pre></td></tr></table></figure>

<h2 id="Consistency-Models-and-Strategies"><a href="#Consistency-Models-and-Strategies" class="headerlink" title="Consistency Models and Strategies"></a>Consistency Models and Strategies</h2><h3 id="1-Strong-Consistency-with-Distributed-Locks"><a href="#1-Strong-Consistency-with-Distributed-Locks" class="headerlink" title="1. Strong Consistency with Distributed Locks"></a>1. Strong Consistency with Distributed Locks</h3><p>Ensures all reads receive the most recent write. Implemented using distributed locks or transactions.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DistributedLock</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client, key, timeout=<span class="number">10</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis_client</span><br><span class="line">        <span class="variable language_">self</span>.key = <span class="string">f&quot;lock:<span class="subst">&#123;key&#125;</span>&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.timeout = timeout</span><br><span class="line">        <span class="variable language_">self</span>.identifier = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">acquire</span>(<span class="params">self</span>):</span><br><span class="line">        end = time.time() + <span class="variable language_">self</span>.timeout</span><br><span class="line">        <span class="keyword">while</span> time.time() &lt; end:</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.redis.setnx(<span class="variable language_">self</span>.key, <span class="variable language_">self</span>.identifier):</span><br><span class="line">                <span class="variable language_">self</span>.redis.expire(<span class="variable language_">self</span>.key, <span class="variable language_">self</span>.timeout)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            time.sleep(<span class="number">0.001</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">release</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Lua script ensures atomicity</span></span><br><span class="line">        lua_script = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        if redis.call(&quot;get&quot;, KEYS[1]) == ARGV[1] then</span></span><br><span class="line"><span class="string">            return redis.call(&quot;del&quot;, KEYS[1])</span></span><br><span class="line"><span class="string">        else</span></span><br><span class="line"><span class="string">            return 0</span></span><br><span class="line"><span class="string">        end</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.redis.<span class="built_in">eval</span>(lua_script, <span class="number">1</span>, <span class="variable language_">self</span>.key, <span class="variable language_">self</span>.identifier)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage in cache update</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update_user_with_lock</span>(<span class="params">user_id, user_data</span>):</span><br><span class="line">    lock = DistributedLock(redis_client, <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> lock.acquire():</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># Update database</span></span><br><span class="line">            update_user_in_db(user_id, user_data)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Update cache</span></span><br><span class="line">            cache_key = <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">            redis_client.<span class="built_in">set</span>(cache_key, json.dumps(user_data))</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            lock.release()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;Could not acquire lock&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>🎯 Interview Insight</strong>: <em>Strong consistency comes with performance costs. Discuss scenarios where it’s necessary (financial transactions, inventory management) vs. where eventual consistency is acceptable (user profiles, social media posts).</em></p>
<h3 id="2-Eventual-Consistency"><a href="#2-Eventual-Consistency" class="headerlink" title="2. Eventual Consistency"></a>2. Eventual Consistency</h3><p>Updates propagate through the system over time, allowing temporary inconsistencies.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EventualConsistencyHandler</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.update_queue = Queue()</span><br><span class="line">        <span class="variable language_">self</span>.worker_thread = Thread(target=<span class="variable language_">self</span>._process_updates, daemon=<span class="literal">True</span>)</span><br><span class="line">        <span class="variable language_">self</span>.worker_thread.start()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update_user_async</span>(<span class="params">self, user_id: <span class="built_in">int</span>, updates: <span class="type">Dict</span></span>):</span><br><span class="line">        <span class="comment"># Immediate cache update for read performance</span></span><br><span class="line">        cache_key = <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">        current_cached = <span class="variable language_">self</span>.redis.get(cache_key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> current_cached:</span><br><span class="line">            current_data = json.loads(current_cached)</span><br><span class="line">            updated_data = &#123;**current_data, **updates&#125;</span><br><span class="line">            <span class="variable language_">self</span>.redis.setex(cache_key, <span class="number">3600</span>, json.dumps(updated_data))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Queue database update</span></span><br><span class="line">        <span class="variable language_">self</span>.update_queue.put((user_id, updates, time.time()))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_process_updates</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                user_id, updates, timestamp = <span class="variable language_">self</span>.update_queue.get(timeout=<span class="number">1</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># Process database update</span></span><br><span class="line">                <span class="variable language_">self</span>.update_database_with_retry(user_id, updates, timestamp)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># Verify cache consistency</span></span><br><span class="line">                <span class="variable language_">self</span>._verify_consistency(user_id)</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="comment"># Handle failed updates (DLQ, alerts, etc.)</span></span><br><span class="line">                <span class="variable language_">self</span>.handle_update_failure(user_id, updates, e)</span><br></pre></td></tr></table></figure>

<h3 id="3-Read-Your-Writes-Consistency"><a href="#3-Read-Your-Writes-Consistency" class="headerlink" title="3. Read-Your-Writes Consistency"></a>3. Read-Your-Writes Consistency</h3><p>Guarantees that a user will see their own writes immediately.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ReadYourWritesCache</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.user_versions = &#123;&#125;  <span class="comment"># Track user-specific versions</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">write_user_data</span>(<span class="params">self, user_id: <span class="built_in">int</span>, data: <span class="type">Dict</span>, session_id: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="comment"># Increment version for this user</span></span><br><span class="line">        version = <span class="variable language_">self</span>.redis.incr(<span class="string">f&quot;user_version:<span class="subst">&#123;user_id&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Store data with version</span></span><br><span class="line">        cache_key = <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">        versioned_data = &#123;**data, <span class="string">&quot;_version&quot;</span>: version, <span class="string">&quot;_updated_by&quot;</span>: session_id&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Write to cache and database</span></span><br><span class="line">        <span class="variable language_">self</span>.redis.setex(cache_key, <span class="number">3600</span>, json.dumps(versioned_data))</span><br><span class="line">        <span class="variable language_">self</span>.update_database(user_id, data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Track version for this session</span></span><br><span class="line">        <span class="variable language_">self</span>.user_versions[session_id] = version</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read_user_data</span>(<span class="params">self, user_id: <span class="built_in">int</span>, session_id: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        cache_key = <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">        cached_data = <span class="variable language_">self</span>.redis.get(cache_key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> cached_data:</span><br><span class="line">            data = json.loads(cached_data)</span><br><span class="line">            cached_version = data.get(<span class="string">&quot;_version&quot;</span>, <span class="number">0</span>)</span><br><span class="line">            expected_version = <span class="variable language_">self</span>.user_versions.get(session_id, <span class="number">0</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Ensure user sees their own writes</span></span><br><span class="line">            <span class="keyword">if</span> cached_version &gt;= expected_version:</span><br><span class="line">                <span class="keyword">return</span> data</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Fallback to database for consistency</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.fetch_from_database(user_id)</span><br></pre></td></tr></table></figure>

<h2 id="Advanced-Patterns"><a href="#Advanced-Patterns" class="headerlink" title="Advanced Patterns"></a>Advanced Patterns</h2><h3 id="1-Cache-Warming"><a href="#1-Cache-Warming" class="headerlink" title="1. Cache Warming"></a>1. Cache Warming</h3><p>Pre-populate cache with frequently accessed data.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CacheWarmer</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client, batch_size=<span class="number">100</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis_client</span><br><span class="line">        <span class="variable language_">self</span>.batch_size = batch_size</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">warm_user_cache</span>(<span class="params">self, user_ids: <span class="type">List</span>[<span class="built_in">int</span>]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Warm cache for multiple users concurrently&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">warm_single_user</span>(<span class="params">user_id: <span class="built_in">int</span></span>):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                user_data = <span class="keyword">await</span> <span class="variable language_">self</span>.fetch_user_from_db(user_id)</span><br><span class="line">                <span class="keyword">if</span> user_data:</span><br><span class="line">                    cache_key = <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">                    <span class="variable language_">self</span>.redis.setex(</span><br><span class="line">                        cache_key,</span><br><span class="line">                        <span class="number">3600</span>,</span><br><span class="line">                        json.dumps(user_data)</span><br><span class="line">                    )</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Failed to warm cache for user <span class="subst">&#123;user_id&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Process in batches to avoid overwhelming the system</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(user_ids), <span class="variable language_">self</span>.batch_size):</span><br><span class="line">            batch = user_ids[i:i + <span class="variable language_">self</span>.batch_size]</span><br><span class="line">            tasks = [warm_single_user(uid) <span class="keyword">for</span> uid <span class="keyword">in</span> batch]</span><br><span class="line">            results = <span class="keyword">await</span> asyncio.gather(*tasks, return_exceptions=<span class="literal">True</span>)</span><br><span class="line">            </span><br><span class="line">            success_count = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> r <span class="keyword">in</span> results <span class="keyword">if</span> r <span class="keyword">is</span> <span class="literal">True</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Warmed <span class="subst">&#123;success_count&#125;</span>/<span class="subst">&#123;<span class="built_in">len</span>(batch)&#125;</span> cache entries&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Small delay between batches</span></span><br><span class="line">            <span class="keyword">await</span> asyncio.sleep(<span class="number">0.1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">warm_on_startup</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Warm cache with most accessed data on application startup&quot;&quot;&quot;</span></span><br><span class="line">        popular_users = <span class="variable language_">self</span>.get_popular_user_ids()</span><br><span class="line">        asyncio.run(<span class="variable language_">self</span>.warm_user_cache(popular_users))</span><br></pre></td></tr></table></figure>

<h3 id="2-Multi-Level-Caching"><a href="#2-Multi-Level-Caching" class="headerlink" title="2. Multi-Level Caching"></a>2. Multi-Level Caching</h3><p>Implement multiple cache layers for optimal performance.</p>
<pre>
<code class="mermaid">
graph TD
A[Application] --&gt; B[L1 Cache - Local Memory]
B --&gt; C[L2 Cache - Redis]
C --&gt; D[L3 Cache - CDN]
D --&gt; E[Database]

style B fill:#e1f5fe
style C fill:#f3e5f5
style D fill:#e8f5e8
style E fill:#fff3e0
</code>
</pre>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> lru_cache</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MultiLevelCache</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># L1: Local memory cache (LRU)</span></span><br><span class="line">        <span class="variable language_">self</span>.l1_cache = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.l1_access_times = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.l1_max_size = <span class="number">1000</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># L2: Redis cache</span></span><br><span class="line">        <span class="variable language_">self</span>.redis = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># L3: Persistent cache (database cache table)</span></span><br><span class="line">        <span class="variable language_">self</span>.db_cache = DatabaseCacheLayer()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, key: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">any</span>]:</span><br><span class="line">        <span class="comment"># L1 Cache check</span></span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">in</span> <span class="variable language_">self</span>.l1_cache:</span><br><span class="line">            <span class="variable language_">self</span>.l1_access_times[key] = time.time()</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.l1_cache[key]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># L2 Cache check (Redis)</span></span><br><span class="line">        l2_data = <span class="variable language_">self</span>.redis.get(key)</span><br><span class="line">        <span class="keyword">if</span> l2_data:</span><br><span class="line">            value = json.loads(l2_data)</span><br><span class="line">            <span class="variable language_">self</span>._store_in_l1(key, value)</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># L3 Cache check (Database cache)</span></span><br><span class="line">        l3_data = <span class="variable language_">self</span>.db_cache.get(key)</span><br><span class="line">        <span class="keyword">if</span> l3_data:</span><br><span class="line">            <span class="comment"># Populate upper levels</span></span><br><span class="line">            <span class="variable language_">self</span>.redis.setex(key, <span class="number">3600</span>, json.dumps(l3_data))</span><br><span class="line">            <span class="variable language_">self</span>._store_in_l1(key, l3_data)</span><br><span class="line">            <span class="keyword">return</span> l3_data</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Cache miss - fetch from origin</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set</span>(<span class="params">self, key: <span class="built_in">str</span>, value: <span class="built_in">any</span>, ttl: <span class="built_in">int</span> = <span class="number">3600</span></span>):</span><br><span class="line">        <span class="comment"># Store in all levels</span></span><br><span class="line">        <span class="variable language_">self</span>._store_in_l1(key, value)</span><br><span class="line">        <span class="variable language_">self</span>.redis.setex(key, ttl, json.dumps(value))</span><br><span class="line">        <span class="variable language_">self</span>.db_cache.<span class="built_in">set</span>(key, value, ttl)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_store_in_l1</span>(<span class="params">self, key: <span class="built_in">str</span>, value: <span class="built_in">any</span></span>):</span><br><span class="line">        <span class="comment"># Implement LRU eviction</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(<span class="variable language_">self</span>.l1_cache) &gt;= <span class="variable language_">self</span>.l1_max_size:</span><br><span class="line">            <span class="variable language_">self</span>._evict_lru()</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.l1_cache[key] = value</span><br><span class="line">        <span class="variable language_">self</span>.l1_access_times[key] = time.time()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_evict_lru</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Remove least recently used item</span></span><br><span class="line">        lru_key = <span class="built_in">min</span>(<span class="variable language_">self</span>.l1_access_times, key=<span class="variable language_">self</span>.l1_access_times.get)</span><br><span class="line">        <span class="keyword">del</span> <span class="variable language_">self</span>.l1_cache[lru_key]</span><br><span class="line">        <span class="keyword">del</span> <span class="variable language_">self</span>.l1_access_times[lru_key]</span><br></pre></td></tr></table></figure>

<p><strong>🎯 Interview Insight</strong>: <em>Multi-level caching questions often focus on cache coherence. Discuss strategies for maintaining consistency across levels and the trade-offs between complexity and performance.</em></p>
<h2 id="Data-Invalidation-Strategies"><a href="#Data-Invalidation-Strategies" class="headerlink" title="Data Invalidation Strategies"></a>Data Invalidation Strategies</h2><h3 id="1-TTL-Based-Expiration"><a href="#1-TTL-Based-Expiration" class="headerlink" title="1. TTL-Based Expiration"></a>1. TTL-Based Expiration</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TTLInvalidationStrategy</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Different TTL strategies for different data types</span></span><br><span class="line">        <span class="variable language_">self</span>.ttl_config = &#123;</span><br><span class="line">            <span class="string">&#x27;user_profile&#x27;</span>: <span class="number">3600</span>,      <span class="comment"># 1 hour</span></span><br><span class="line">            <span class="string">&#x27;user_preferences&#x27;</span>: <span class="number">86400</span>,  <span class="comment"># 24 hours</span></span><br><span class="line">            <span class="string">&#x27;session_data&#x27;</span>: <span class="number">1800</span>,       <span class="comment"># 30 minutes</span></span><br><span class="line">            <span class="string">&#x27;product_catalog&#x27;</span>: <span class="number">300</span>,     <span class="comment"># 5 minutes</span></span><br><span class="line">            <span class="string">&#x27;real_time_data&#x27;</span>: <span class="number">60</span>        <span class="comment"># 1 minute</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_with_appropriate_ttl</span>(<span class="params">self, key: <span class="built_in">str</span>, value: <span class="built_in">any</span>, data_type: <span class="built_in">str</span></span>):</span><br><span class="line">        ttl = <span class="variable language_">self</span>.ttl_config.get(data_type, <span class="number">3600</span>)  <span class="comment"># Default 1 hour</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Add jitter to prevent thundering herd</span></span><br><span class="line">        jitter = random.randint(-<span class="number">60</span>, <span class="number">60</span>)  <span class="comment"># ±1 minute</span></span><br><span class="line">        final_ttl = <span class="built_in">max</span>(ttl + jitter, <span class="number">60</span>)  <span class="comment"># Minimum 1 minute</span></span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.redis.setex(key, final_ttl, json.dumps(value))</span><br></pre></td></tr></table></figure>

<h3 id="2-Event-Driven-Invalidation"><a href="#2-Event-Driven-Invalidation" class="headerlink" title="2. Event-Driven Invalidation"></a>2. Event-Driven Invalidation</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pika</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EventDrivenInvalidation</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.connection = pika.BlockingConnection(</span><br><span class="line">            pika.ConnectionParameters(<span class="string">&#x27;localhost&#x27;</span>)</span><br><span class="line">        )</span><br><span class="line">        <span class="variable language_">self</span>.channel = <span class="variable language_">self</span>.connection.channel()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Set up exchange and queue</span></span><br><span class="line">        <span class="variable language_">self</span>.channel.exchange_declare(</span><br><span class="line">            exchange=<span class="string">&#x27;cache_invalidation&#x27;</span>,</span><br><span class="line">            exchange_type=<span class="string">&#x27;topic&#x27;</span></span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">invalidate_user_cache</span>(<span class="params">self, user_id: <span class="built_in">int</span>, event_type: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Invalidate cache based on user events&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        patterns_to_invalidate = &#123;</span><br><span class="line">            <span class="string">&#x27;user_updated&#x27;</span>: [<span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span>, <span class="string">f&quot;user_profile:<span class="subst">&#123;user_id&#125;</span>&quot;</span>],</span><br><span class="line">            <span class="string">&#x27;user_preferences_changed&#x27;</span>: [<span class="string">f&quot;user_prefs:<span class="subst">&#123;user_id&#125;</span>&quot;</span>],</span><br><span class="line">            <span class="string">&#x27;user_deleted&#x27;</span>: [<span class="string">f&quot;user:*:<span class="subst">&#123;user_id&#125;</span>&quot;</span>, <span class="string">f&quot;session:*:<span class="subst">&#123;user_id&#125;</span>&quot;</span>],</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        keys_to_invalidate = patterns_to_invalidate.get(event_type, [])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> pattern <span class="keyword">in</span> keys_to_invalidate:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;*&#x27;</span> <span class="keyword">in</span> pattern:</span><br><span class="line">                <span class="comment"># Handle wildcard patterns</span></span><br><span class="line">                matching_keys = <span class="variable language_">self</span>.redis.keys(pattern)</span><br><span class="line">                <span class="keyword">if</span> matching_keys:</span><br><span class="line">                    <span class="variable language_">self</span>.redis.delete(*matching_keys)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="variable language_">self</span>.redis.delete(pattern)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Publish invalidation event</span></span><br><span class="line">        <span class="variable language_">self</span>.channel.basic_publish(</span><br><span class="line">            exchange=<span class="string">&#x27;cache_invalidation&#x27;</span>,</span><br><span class="line">            routing_key=<span class="string">f&#x27;user.<span class="subst">&#123;event_type&#125;</span>&#x27;</span>,</span><br><span class="line">            body=json.dumps(&#123;</span><br><span class="line">                <span class="string">&#x27;user_id&#x27;</span>: user_id,</span><br><span class="line">                <span class="string">&#x27;event_type&#x27;</span>: event_type,</span><br><span class="line">                <span class="string">&#x27;timestamp&#x27;</span>: time.time(),</span><br><span class="line">                <span class="string">&#x27;invalidated_keys&#x27;</span>: keys_to_invalidate</span><br><span class="line">            &#125;)</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setup_invalidation_listener</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Listen for cache invalidation events&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">callback</span>(<span class="params">ch, method, properties, body</span>):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                event = json.loads(body)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Cache invalidation event: <span class="subst">&#123;event&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="comment"># Additional processing if needed</span></span><br><span class="line">                </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Error processing invalidation event: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        queue = <span class="variable language_">self</span>.channel.queue_declare(queue=<span class="string">&#x27;cache_invalidation_processor&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.channel.queue_bind(</span><br><span class="line">            exchange=<span class="string">&#x27;cache_invalidation&#x27;</span>,</span><br><span class="line">            queue=queue.method.queue,</span><br><span class="line">            routing_key=<span class="string">&#x27;user.*&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.channel.basic_consume(</span><br><span class="line">            queue=queue.method.queue,</span><br><span class="line">            on_message_callback=callback,</span><br><span class="line">            auto_ack=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.channel.start_consuming()</span><br></pre></td></tr></table></figure>

<h3 id="3-Cache-Tags-and-Dependencies"><a href="#3-Cache-Tags-and-Dependencies" class="headerlink" title="3. Cache Tags and Dependencies"></a>3. Cache Tags and Dependencies</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TagBasedInvalidation</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_with_tags</span>(<span class="params">self, key: <span class="built_in">str</span>, value: <span class="built_in">any</span>, tags: <span class="type">List</span>[<span class="built_in">str</span>], ttl: <span class="built_in">int</span> = <span class="number">3600</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Store data with associated tags for bulk invalidation&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Store the actual data</span></span><br><span class="line">        <span class="variable language_">self</span>.redis.setex(key, ttl, json.dumps(value))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Associate key with tags</span></span><br><span class="line">        <span class="keyword">for</span> tag <span class="keyword">in</span> tags:</span><br><span class="line">            tag_key = <span class="string">f&quot;tag:<span class="subst">&#123;tag&#125;</span>&quot;</span></span><br><span class="line">            <span class="variable language_">self</span>.redis.sadd(tag_key, key)</span><br><span class="line">            <span class="variable language_">self</span>.redis.expire(tag_key, ttl + <span class="number">300</span>)  <span class="comment"># Tags live longer than data</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">invalidate_by_tag</span>(<span class="params">self, tag: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Invalidate all cache entries associated with a tag&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        tag_key = <span class="string">f&quot;tag:<span class="subst">&#123;tag&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Get all keys associated with this tag</span></span><br><span class="line">        keys_to_invalidate = <span class="variable language_">self</span>.redis.smembers(tag_key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> keys_to_invalidate:</span><br><span class="line">            <span class="comment"># Delete all associated keys</span></span><br><span class="line">            <span class="variable language_">self</span>.redis.delete(*keys_to_invalidate)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Clean up tag associations</span></span><br><span class="line">            <span class="keyword">for</span> key <span class="keyword">in</span> keys_to_invalidate:</span><br><span class="line">                <span class="variable language_">self</span>._remove_key_from_all_tags(key.decode())</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Remove the tag itself</span></span><br><span class="line">        <span class="variable language_">self</span>.redis.delete(tag_key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_remove_key_from_all_tags</span>(<span class="params">self, key: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Remove a key from all tag associations&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># This could be expensive - consider background cleanup</span></span><br><span class="line">        tag_pattern = <span class="string">&quot;tag:*&quot;</span></span><br><span class="line">        <span class="keyword">for</span> tag_key <span class="keyword">in</span> <span class="variable language_">self</span>.redis.scan_iter(<span class="keyword">match</span>=tag_pattern):</span><br><span class="line">            <span class="variable language_">self</span>.redis.srem(tag_key, key)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage example</span></span><br><span class="line">cache = TagBasedInvalidation()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Store user data with tags</span></span><br><span class="line">user_data = &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;John&quot;</span>, <span class="string">&quot;department&quot;</span>: <span class="string">&quot;Engineering&quot;</span>&#125;</span><br><span class="line">cache.set_with_tags(</span><br><span class="line">    key=<span class="string">&quot;user:123&quot;</span>,</span><br><span class="line">    value=user_data,</span><br><span class="line">    tags=[<span class="string">&quot;user&quot;</span>, <span class="string">&quot;department:engineering&quot;</span>, <span class="string">&quot;active_users&quot;</span>]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Invalidate all engineering department data</span></span><br><span class="line">cache.invalidate_by_tag(<span class="string">&quot;department:engineering&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>🎯 Interview Insight</strong>: <em>Tag-based invalidation is a sophisticated pattern. Discuss the trade-offs between granular control and storage overhead. Mention alternatives like dependency graphs for complex invalidation scenarios.</em></p>
<h2 id="Performance-Optimization"><a href="#Performance-Optimization" class="headerlink" title="Performance Optimization"></a>Performance Optimization</h2><h3 id="1-Connection-Pooling-and-Pipelining"><a href="#1-Connection-Pooling-and-Pipelining" class="headerlink" title="1. Connection Pooling and Pipelining"></a>1. Connection Pooling and Pipelining</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis.connection</span><br><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"><span class="keyword">from</span> redis.connection <span class="keyword">import</span> ConnectionPool</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OptimizedRedisClient</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Connection pool for better resource management</span></span><br><span class="line">        <span class="variable language_">self</span>.pool = ConnectionPool(</span><br><span class="line">            host=<span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">            port=<span class="number">6379</span>,</span><br><span class="line">            db=<span class="number">0</span>,</span><br><span class="line">            max_connections=<span class="number">20</span>,</span><br><span class="line">            socket_connect_timeout=<span class="number">5</span>,</span><br><span class="line">            socket_timeout=<span class="number">5</span>,</span><br><span class="line">            retry_on_timeout=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        <span class="variable language_">self</span>.redis = Redis(connection_pool=<span class="variable language_">self</span>.pool)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">batch_get_users</span>(<span class="params">self, user_ids: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">int</span>, <span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Efficiently fetch multiple users using pipelining&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        pipe = <span class="variable language_">self</span>.redis.pipeline()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Queue multiple commands</span></span><br><span class="line">        cache_keys = [<span class="string">f&quot;user:<span class="subst">&#123;uid&#125;</span>&quot;</span> <span class="keyword">for</span> uid <span class="keyword">in</span> user_ids]</span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> cache_keys:</span><br><span class="line">            pipe.get(key)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Execute all commands at once</span></span><br><span class="line">        results = pipe.execute()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Process results</span></span><br><span class="line">        user_data = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> i, result <span class="keyword">in</span> <span class="built_in">enumerate</span>(results):</span><br><span class="line">            <span class="keyword">if</span> result:</span><br><span class="line">                user_data[user_ids[i]] = json.loads(result)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> user_data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">batch_set_users</span>(<span class="params">self, user_data_map: <span class="type">Dict</span>[<span class="built_in">int</span>, <span class="type">Dict</span>]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Efficiently store multiple users using pipelining&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        pipe = <span class="variable language_">self</span>.redis.pipeline()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> user_id, data <span class="keyword">in</span> user_data_map.items():</span><br><span class="line">            cache_key = <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">            pipe.setex(cache_key, <span class="number">3600</span>, json.dumps(data))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Execute all commands</span></span><br><span class="line">        pipe.execute()</span><br></pre></td></tr></table></figure>

<h3 id="2-Memory-Optimization"><a href="#2-Memory-Optimization" class="headerlink" title="2. Memory Optimization"></a>2. Memory Optimization</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MemoryOptimizedCache</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">store_user_efficiently</span>(<span class="params">self, user_id: <span class="built_in">int</span>, user_data: <span class="type">Dict</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Use Redis hashes for memory efficiency with structured data&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        hash_key = <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Store as hash instead of JSON string</span></span><br><span class="line">        <span class="comment"># This is more memory efficient for structured data</span></span><br><span class="line">        mapping = &#123;</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>: user_data.get(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;email&#x27;</span>: user_data.get(<span class="string">&#x27;email&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;created_at&#x27;</span>: <span class="built_in">str</span>(user_data.get(<span class="string">&#x27;created_at&#x27;</span>, <span class="string">&#x27;&#x27;</span>)),</span><br><span class="line">            <span class="string">&#x27;is_active&#x27;</span>: <span class="string">&#x27;1&#x27;</span> <span class="keyword">if</span> user_data.get(<span class="string">&#x27;is_active&#x27;</span>) <span class="keyword">else</span> <span class="string">&#x27;0&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.redis.hset(hash_key, mapping=mapping)</span><br><span class="line">        <span class="variable language_">self</span>.redis.expire(hash_key, <span class="number">3600</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_user_efficiently</span>(<span class="params">self, user_id: <span class="built_in">int</span></span>) -&gt; <span class="type">Optional</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Retrieve user data from hash&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        hash_key = <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">        user_hash = <span class="variable language_">self</span>.redis.hgetall(hash_key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user_hash:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Convert back to proper types</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>: user_hash.get(<span class="string">b&#x27;name&#x27;</span>, <span class="string">b&#x27;&#x27;</span>).decode(),</span><br><span class="line">            <span class="string">&#x27;email&#x27;</span>: user_hash.get(<span class="string">b&#x27;email&#x27;</span>, <span class="string">b&#x27;&#x27;</span>).decode(),</span><br><span class="line">            <span class="string">&#x27;created_at&#x27;</span>: user_hash.get(<span class="string">b&#x27;created_at&#x27;</span>, <span class="string">b&#x27;&#x27;</span>).decode(),</span><br><span class="line">            <span class="string">&#x27;is_active&#x27;</span>: user_hash.get(<span class="string">b&#x27;is_active&#x27;</span>) == <span class="string">b&#x27;1&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">compress_large_data</span>(<span class="params">self, key: <span class="built_in">str</span>, data: <span class="built_in">any</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Compress large data before storing&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">import</span> gzip</span><br><span class="line">        </span><br><span class="line">        json_data = json.dumps(data)</span><br><span class="line">        compressed_data = gzip.compress(json_data.encode())</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Store with compression flag</span></span><br><span class="line">        <span class="variable language_">self</span>.redis.hset(<span class="string">f&quot;compressed:<span class="subst">&#123;key&#125;</span>&quot;</span>, mapping=&#123;</span><br><span class="line">            <span class="string">&#x27;data&#x27;</span>: compressed_data,</span><br><span class="line">            <span class="string">&#x27;compressed&#x27;</span>: <span class="string">&#x27;1&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_compressed_data</span>(<span class="params">self, key: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Retrieve and decompress data&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">import</span> gzip</span><br><span class="line">        </span><br><span class="line">        result = <span class="variable language_">self</span>.redis.hgetall(<span class="string">f&quot;compressed:<span class="subst">&#123;key&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> result:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> result.get(<span class="string">b&#x27;compressed&#x27;</span>) == <span class="string">b&#x27;1&#x27;</span>:</span><br><span class="line">            compressed_data = result.get(<span class="string">b&#x27;data&#x27;</span>)</span><br><span class="line">            json_data = gzip.decompress(compressed_data).decode()</span><br><span class="line">            <span class="keyword">return</span> json.loads(json_data)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<h3 id="3-Hot-Key-Detection-and-Mitigation"><a href="#3-Hot-Key-Detection-and-Mitigation" class="headerlink" title="3. Hot Key Detection and Mitigation"></a>3. Hot Key Detection and Mitigation</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict, deque</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HotKeyDetector</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, threshold=<span class="number">100</span>, window_seconds=<span class="number">60</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.threshold = threshold</span><br><span class="line">        <span class="variable language_">self</span>.window_seconds = window_seconds</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Track key access patterns</span></span><br><span class="line">        <span class="variable language_">self</span>.access_counts = defaultdict(deque)</span><br><span class="line">        <span class="variable language_">self</span>.lock = threading.RLock()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Hot key mitigation strategies</span></span><br><span class="line">        <span class="variable language_">self</span>.hot_keys = <span class="built_in">set</span>()</span><br><span class="line">        <span class="variable language_">self</span>.local_cache = &#123;&#125;  <span class="comment"># Local caching for hot keys</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">track_access</span>(<span class="params">self, key: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Track key access for hot key detection&quot;&quot;&quot;</span></span><br><span class="line">        current_time = time.time()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">with</span> <span class="variable language_">self</span>.lock:</span><br><span class="line">            <span class="comment"># Add current access</span></span><br><span class="line">            <span class="variable language_">self</span>.access_counts[key].append(current_time)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Remove old accesses outside the window</span></span><br><span class="line">            cutoff_time = current_time - <span class="variable language_">self</span>.window_seconds</span><br><span class="line">            <span class="keyword">while</span> (<span class="variable language_">self</span>.access_counts[key] <span class="keyword">and</span> </span><br><span class="line">                   <span class="variable language_">self</span>.access_counts[key][<span class="number">0</span>] &lt; cutoff_time):</span><br><span class="line">                <span class="variable language_">self</span>.access_counts[key].popleft()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Check if key is hot</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(<span class="variable language_">self</span>.access_counts[key]) &gt; <span class="variable language_">self</span>.threshold:</span><br><span class="line">                <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> <span class="variable language_">self</span>.hot_keys:</span><br><span class="line">                    <span class="variable language_">self</span>.hot_keys.add(key)</span><br><span class="line">                    <span class="variable language_">self</span>._handle_hot_key(key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_with_hot_key_handling</span>(<span class="params">self, key: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get data with hot key optimization&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.track_access(key)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># If it&#x27;s a hot key, try local cache first</span></span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">in</span> <span class="variable language_">self</span>.hot_keys:</span><br><span class="line">            local_data = <span class="variable language_">self</span>.local_cache.get(key)</span><br><span class="line">            <span class="keyword">if</span> local_data <span class="keyword">and</span> local_data[<span class="string">&#x27;expires&#x27;</span>] &gt; time.time():</span><br><span class="line">                <span class="keyword">return</span> local_data[<span class="string">&#x27;value&#x27;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Get from Redis</span></span><br><span class="line">        data = <span class="variable language_">self</span>.redis.get(key)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Cache locally if hot key</span></span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">in</span> <span class="variable language_">self</span>.hot_keys <span class="keyword">and</span> data:</span><br><span class="line">            <span class="variable language_">self</span>.local_cache[key] = &#123;</span><br><span class="line">                <span class="string">&#x27;value&#x27;</span>: data,</span><br><span class="line">                <span class="string">&#x27;expires&#x27;</span>: time.time() + <span class="number">30</span>  <span class="comment"># Short local cache TTL</span></span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_handle_hot_key</span>(<span class="params">self, key: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Implement hot key mitigation strategies&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Strategy 1: Add local caching</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Hot key detected: <span class="subst">&#123;key&#125;</span> - enabling local caching&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Strategy 2: Create multiple copies with random distribution</span></span><br><span class="line">        original_data = <span class="variable language_">self</span>.redis.get(key)</span><br><span class="line">        <span class="keyword">if</span> original_data:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):  <span class="comment"># Create 3 copies</span></span><br><span class="line">                copy_key = <span class="string">f&quot;<span class="subst">&#123;key&#125;</span>:copy:<span class="subst">&#123;i&#125;</span>&quot;</span></span><br><span class="line">                <span class="variable language_">self</span>.redis.setex(copy_key, <span class="number">300</span>, original_data)  <span class="comment"># 5 min TTL</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Strategy 3: Use read replicas (if available)</span></span><br><span class="line">        <span class="comment"># This would involve routing reads to replica nodes</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_distributed_hot_key</span>(<span class="params">self, key: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get hot key data using distribution strategy&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> <span class="variable language_">self</span>.hot_keys:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.redis.get(key)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Random selection from copies</span></span><br><span class="line">        <span class="keyword">import</span> random</span><br><span class="line">        copy_index = random.randint(<span class="number">0</span>, <span class="number">2</span>)</span><br><span class="line">        copy_key = <span class="string">f&quot;<span class="subst">&#123;key&#125;</span>:copy:<span class="subst">&#123;copy_index&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        data = <span class="variable language_">self</span>.redis.get(copy_key)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            <span class="comment"># Fallback to original</span></span><br><span class="line">            data = <span class="variable language_">self</span>.redis.get(key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure>

<p><strong>🎯 Interview Insight</strong>: <em>Hot key problems are common in production. Discuss identification techniques (monitoring access patterns), mitigation strategies (local caching, key distribution), and prevention approaches (better key design, load balancing).</em></p>
<h2 id="Monitoring-and-Troubleshooting"><a href="#Monitoring-and-Troubleshooting" class="headerlink" title="Monitoring and Troubleshooting"></a>Monitoring and Troubleshooting</h2><h3 id="1-Performance-Monitoring"><a href="#1-Performance-Monitoring" class="headerlink" title="1. Performance Monitoring"></a>1. Performance Monitoring</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RedisMonitor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.metrics = &#123;</span><br><span class="line">            <span class="string">&#x27;hits&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;misses&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;errors&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;total_requests&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;total_latency&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;slow_queries&#x27;</span>: <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">self</span>.slow_query_threshold = <span class="number">0.1</span>  <span class="comment"># 100ms</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Setup logging</span></span><br><span class="line">        <span class="variable language_">self</span>.logger = logging.getLogger(<span class="string">&#x27;redis_monitor&#x27;</span>)</span><br><span class="line">        handler = logging.StreamHandler()</span><br><span class="line">        formatter = logging.Formatter(</span><br><span class="line">            <span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        handler.setFormatter(formatter)</span><br><span class="line">        <span class="variable language_">self</span>.logger.addHandler(handler)</span><br><span class="line">        <span class="variable language_">self</span>.logger.setLevel(logging.INFO)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">monitor_operation</span>(<span class="params">self, operation_name=<span class="string">&#x27;redis_op&#x27;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Decorator to monitor Redis operations&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">decorator</span>(<span class="params">func</span>):</span><br><span class="line"><span class="meta">            @wraps(<span class="params">func</span>)</span></span><br><span class="line">            <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">                start_time = time.time()</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    result = func(*args, **kwargs)</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># Track hit/miss</span></span><br><span class="line">                    <span class="keyword">if</span> result <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                        <span class="variable language_">self</span>.metrics[<span class="string">&#x27;hits&#x27;</span>] += <span class="number">1</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="variable language_">self</span>.metrics[<span class="string">&#x27;misses&#x27;</span>] += <span class="number">1</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">return</span> result</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    <span class="variable language_">self</span>.metrics[<span class="string">&#x27;errors&#x27;</span>] += <span class="number">1</span></span><br><span class="line">                    <span class="variable language_">self</span>.logger.error(<span class="string">f&quot;Redis operation failed: <span class="subst">&#123;operation_name&#125;</span> - <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="keyword">raise</span></span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">finally</span>:</span><br><span class="line">                    <span class="comment"># Track latency</span></span><br><span class="line">                    end_time = time.time()</span><br><span class="line">                    latency = end_time - start_time</span><br><span class="line">                    <span class="variable language_">self</span>.metrics[<span class="string">&#x27;total_requests&#x27;</span>] += <span class="number">1</span></span><br><span class="line">                    <span class="variable language_">self</span>.metrics[<span class="string">&#x27;total_latency&#x27;</span>] += latency</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># Log slow queries</span></span><br><span class="line">                    <span class="keyword">if</span> latency &gt; <span class="variable language_">self</span>.slow_query_threshold:</span><br><span class="line">                        <span class="variable language_">self</span>.metrics[<span class="string">&#x27;slow_queries&#x27;</span>] += <span class="number">1</span></span><br><span class="line">                        <span class="variable language_">self</span>.logger.warning(</span><br><span class="line">                            <span class="string">f&quot;Slow Redis operation: <span class="subst">&#123;operation_name&#125;</span> - <span class="subst">&#123;latency:<span class="number">.3</span>f&#125;</span>s&quot;</span></span><br><span class="line">                        )</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> wrapper</span><br><span class="line">        <span class="keyword">return</span> decorator</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @monitor_operation(<span class="params"><span class="string">&#x27;get&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">monitored_get</span>(<span class="params">self, key: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.redis.get(key)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @monitor_operation(<span class="params"><span class="string">&#x27;set&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">monitored_set</span>(<span class="params">self, key: <span class="built_in">str</span>, value: <span class="built_in">str</span>, ex: <span class="built_in">int</span> = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.redis.<span class="built_in">set</span>(key, value, ex=ex)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_performance_stats</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get current performance statistics&quot;&quot;&quot;</span></span><br><span class="line">        total_requests = <span class="variable language_">self</span>.metrics[<span class="string">&#x27;total_requests&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> total_requests == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;No requests recorded&#x27;</span>&#125;</span><br><span class="line">        </span><br><span class="line">        hit_rate = <span class="variable language_">self</span>.metrics[<span class="string">&#x27;hits&#x27;</span>] / total_requests * <span class="number">100</span></span><br><span class="line">        avg_latency = <span class="variable language_">self</span>.metrics[<span class="string">&#x27;total_latency&#x27;</span>] / total_requests * <span class="number">1000</span>  <span class="comment"># ms</span></span><br><span class="line">        error_rate = <span class="variable language_">self</span>.metrics[<span class="string">&#x27;errors&#x27;</span>] / total_requests * <span class="number">100</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;hit_rate&#x27;</span>: <span class="string">f&quot;<span class="subst">&#123;hit_rate:<span class="number">.2</span>f&#125;</span>%&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;miss_rate&#x27;</span>: <span class="string">f&quot;<span class="subst">&#123;<span class="number">100</span> - hit_rate:<span class="number">.2</span>f&#125;</span>%&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;error_rate&#x27;</span>: <span class="string">f&quot;<span class="subst">&#123;error_rate:<span class="number">.2</span>f&#125;</span>%&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;avg_latency_ms&#x27;</span>: <span class="string">f&quot;<span class="subst">&#123;avg_latency:<span class="number">.2</span>f&#125;</span>&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;total_requests&#x27;</span>: total_requests,</span><br><span class="line">            <span class="string">&#x27;slow_queries&#x27;</span>: <span class="variable language_">self</span>.metrics[<span class="string">&#x27;slow_queries&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;slow_query_rate&#x27;</span>: <span class="string">f&quot;<span class="subst">&#123;self.metrics[<span class="string">&#x27;slow_queries&#x27;</span>] / total_requests * <span class="number">100</span>:<span class="number">.2</span>f&#125;</span>%&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_redis_info</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get Redis server information&quot;&quot;&quot;</span></span><br><span class="line">        info = <span class="variable language_">self</span>.redis.info()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;version&#x27;</span>: info.get(<span class="string">&#x27;redis_version&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;uptime&#x27;</span>: info.get(<span class="string">&#x27;uptime_in_seconds&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;connected_clients&#x27;</span>: info.get(<span class="string">&#x27;connected_clients&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;used_memory&#x27;</span>: info.get(<span class="string">&#x27;used_memory_human&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;used_memory_peak&#x27;</span>: info.get(<span class="string">&#x27;used_memory_peak_human&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;keyspace_hits&#x27;</span>: info.get(<span class="string">&#x27;keyspace_hits&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;keyspace_misses&#x27;</span>: info.get(<span class="string">&#x27;keyspace_misses&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;expired_keys&#x27;</span>: info.get(<span class="string">&#x27;expired_keys&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;evicted_keys&#x27;</span>: info.get(<span class="string">&#x27;evicted_keys&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">health_check</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Comprehensive health check&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># Test basic connectivity</span></span><br><span class="line">            start_time = time.time()</span><br><span class="line">            ping_result = <span class="variable language_">self</span>.redis.ping()</span><br><span class="line">            ping_latency = (time.time() - start_time) * <span class="number">1000</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Get memory info</span></span><br><span class="line">            info = <span class="variable language_">self</span>.redis.info(<span class="string">&#x27;memory&#x27;</span>)</span><br><span class="line">            used_memory_pct = (info[<span class="string">&#x27;used_memory&#x27;</span>] / info[<span class="string">&#x27;maxmemory&#x27;</span>] * <span class="number">100</span> </span><br><span class="line">                             <span class="keyword">if</span> info.get(<span class="string">&#x27;maxmemory&#x27;</span>, <span class="number">0</span>) &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Check for concerning patterns</span></span><br><span class="line">            warnings = []</span><br><span class="line">            <span class="keyword">if</span> ping_latency &gt; <span class="number">10</span>:  <span class="comment"># 10ms</span></span><br><span class="line">                warnings.append(<span class="string">f&quot;High ping latency: <span class="subst">&#123;ping_latency:<span class="number">.2</span>f&#125;</span>ms&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> used_memory_pct &gt; <span class="number">80</span>:</span><br><span class="line">                warnings.append(<span class="string">f&quot;High memory usage: <span class="subst">&#123;used_memory_pct:<span class="number">.1</span>f&#125;</span>%&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.metrics[<span class="string">&#x27;errors&#x27;</span>] &gt; <span class="variable language_">self</span>.metrics[<span class="string">&#x27;total_requests&#x27;</span>] * <span class="number">0.01</span>:  <span class="comment"># &gt;1% error rate</span></span><br><span class="line">                warnings.append(<span class="string">&quot;High error rate detected&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;status&#x27;</span>: <span class="string">&#x27;healthy&#x27;</span> <span class="keyword">if</span> <span class="keyword">not</span> warnings <span class="keyword">else</span> <span class="string">&#x27;warning&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;ping_latency_ms&#x27;</span>: <span class="string">f&quot;<span class="subst">&#123;ping_latency:<span class="number">.2</span>f&#125;</span>&quot;</span>,</span><br><span class="line">                <span class="string">&#x27;memory_usage_pct&#x27;</span>: <span class="string">f&quot;<span class="subst">&#123;used_memory_pct:<span class="number">.1</span>f&#125;</span>%&quot;</span>,</span><br><span class="line">                <span class="string">&#x27;warnings&#x27;</span>: warnings,</span><br><span class="line">                <span class="string">&#x27;performance_stats&#x27;</span>: <span class="variable language_">self</span>.get_performance_stats()</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;status&#x27;</span>: <span class="string">&#x27;unhealthy&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;error&#x27;</span>: <span class="built_in">str</span>(e)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage example</span></span><br><span class="line">monitor = RedisMonitor()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use monitored operations</span></span><br><span class="line">data = monitor.monitored_get(<span class="string">&quot;user:123&quot;</span>)</span><br><span class="line">monitor.monitored_set(<span class="string">&quot;user:123&quot;</span>, json.dumps(&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;John&quot;</span>&#125;), ex=<span class="number">3600</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check performance</span></span><br><span class="line"><span class="built_in">print</span>(monitor.get_performance_stats())</span><br><span class="line"><span class="built_in">print</span>(monitor.health_check())</span><br></pre></td></tr></table></figure>

<h3 id="2-Advanced-Debugging-and-Profiling"><a href="#2-Advanced-Debugging-and-Profiling" class="headerlink" title="2. Advanced Debugging and Profiling"></a>2. Advanced Debugging and Profiling</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RedisDebugger</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.command_history = deque(maxlen=<span class="number">1000</span>)  <span class="comment"># Keep last 1000 commands</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">debug_key_access_pattern</span>(<span class="params">self, key_pattern: <span class="built_in">str</span>, duration: <span class="built_in">int</span> = <span class="number">60</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Monitor access patterns for keys matching a pattern&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Monitoring key pattern: <span class="subst">&#123;key_pattern&#125;</span> for <span class="subst">&#123;duration&#125;</span> seconds&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Use Redis MONITOR command (use with caution in production)</span></span><br><span class="line">        pubsub = <span class="variable language_">self</span>.redis.pubsub()</span><br><span class="line">        </span><br><span class="line">        access_stats = defaultdict(<span class="built_in">int</span>)</span><br><span class="line">        start_time = time.time()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># Note: MONITOR is expensive and should not be used in production</span></span><br><span class="line">            <span class="comment"># This is for debugging purposes only</span></span><br><span class="line">            <span class="keyword">with</span> <span class="variable language_">self</span>.redis.monitor() <span class="keyword">as</span> monitor:</span><br><span class="line">                <span class="keyword">for</span> command <span class="keyword">in</span> monitor.listen():</span><br><span class="line">                    <span class="keyword">if</span> time.time() - start_time &gt; duration:</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> command[<span class="string">&#x27;command&#x27;</span>]:</span><br><span class="line">                        cmd_parts = command[<span class="string">&#x27;command&#x27;</span>].split()</span><br><span class="line">                        <span class="keyword">if</span> <span class="built_in">len</span>(cmd_parts) &gt;= <span class="number">2</span>:</span><br><span class="line">                            operation = cmd_parts[<span class="number">0</span>].upper()</span><br><span class="line">                            key = cmd_parts[<span class="number">1</span>]</span><br><span class="line">                            </span><br><span class="line">                            <span class="keyword">if</span> key_pattern <span class="keyword">in</span> key:</span><br><span class="line">                                access_stats[<span class="string">f&quot;<span class="subst">&#123;operation&#125;</span>:<span class="subst">&#123;key&#125;</span>&quot;</span>] += <span class="number">1</span></span><br><span class="line">                                </span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Analyze patterns</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\nAccess Pattern Analysis:&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> pattern, count <span class="keyword">in</span> <span class="built_in">sorted</span>(access_stats.items(), key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;pattern&#125;</span>: <span class="subst">&#123;count&#125;</span> accesses&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> access_stats</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">analyze_memory_usage</span>(<span class="params">self, sample_size: <span class="built_in">int</span> = <span class="number">100</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Analyze memory usage of different key patterns&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        memory_stats = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Get random sample of keys</span></span><br><span class="line">        keys = []</span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> <span class="variable language_">self</span>.redis.scan_iter(count=sample_size):</span><br><span class="line">            keys.append(key.decode())</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Analyzing memory usage for <span class="subst">&#123;<span class="built_in">len</span>(keys)&#125;</span> keys...&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> keys:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># Get memory usage for this key</span></span><br><span class="line">                memory_usage = <span class="variable language_">self</span>.redis.memory_usage(key)</span><br><span class="line">                key_type = <span class="variable language_">self</span>.redis.<span class="built_in">type</span>(key).decode()</span><br><span class="line">                </span><br><span class="line">                pattern = <span class="variable language_">self</span>._extract_key_pattern(key)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> pattern <span class="keyword">not</span> <span class="keyword">in</span> memory_stats:</span><br><span class="line">                    memory_stats[pattern] = &#123;</span><br><span class="line">                        <span class="string">&#x27;total_memory&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">                        <span class="string">&#x27;count&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">                        <span class="string">&#x27;avg_memory&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">                        <span class="string">&#x27;type&#x27;</span>: key_type</span><br><span class="line">                    &#125;</span><br><span class="line">                </span><br><span class="line">                memory_stats[pattern][<span class="string">&#x27;total_memory&#x27;</span>] += memory_usage</span><br><span class="line">                memory_stats[pattern][<span class="string">&#x27;count&#x27;</span>] += <span class="number">1</span></span><br><span class="line">                memory_stats[pattern][<span class="string">&#x27;avg_memory&#x27;</span>] = (</span><br><span class="line">                    memory_stats[pattern][<span class="string">&#x27;total_memory&#x27;</span>] / </span><br><span class="line">                    memory_stats[pattern][<span class="string">&#x27;count&#x27;</span>]</span><br><span class="line">                )</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Error analyzing key <span class="subst">&#123;key&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Sort by total memory usage</span></span><br><span class="line">        sorted_stats = <span class="built_in">sorted</span>(</span><br><span class="line">            memory_stats.items(), </span><br><span class="line">            key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>][<span class="string">&#x27;total_memory&#x27;</span>], </span><br><span class="line">            reverse=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\nMemory Usage Analysis:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;<span class="string">&#x27;Pattern&#x27;</span>:&lt;<span class="number">30</span>&#125;</span> <span class="subst">&#123;<span class="string">&#x27;Type&#x27;</span>:&lt;<span class="number">10</span>&#125;</span> <span class="subst">&#123;<span class="string">&#x27;Count&#x27;</span>:&lt;<span class="number">8</span>&#125;</span> <span class="subst">&#123;<span class="string">&#x27;Total (bytes)&#x27;</span>:&lt;<span class="number">15</span>&#125;</span> <span class="subst">&#123;<span class="string">&#x27;Avg (bytes)&#x27;</span>:&lt;<span class="number">12</span>&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">85</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> pattern, stats <span class="keyword">in</span> sorted_stats:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;pattern:&lt;<span class="number">30</span>&#125;</span> <span class="subst">&#123;stats[<span class="string">&#x27;type&#x27;</span>]:&lt;<span class="number">10</span>&#125;</span> <span class="subst">&#123;stats[<span class="string">&#x27;count&#x27;</span>]:&lt;<span class="number">8</span>&#125;</span> &quot;</span></span><br><span class="line">                  <span class="string">f&quot;<span class="subst">&#123;stats[<span class="string">&#x27;total_memory&#x27;</span>]:&lt;<span class="number">15</span>&#125;</span> <span class="subst">&#123;stats[<span class="string">&#x27;avg_memory&#x27;</span>]:&lt;<span class="number">12.1</span>f&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> memory_stats</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_extract_key_pattern</span>(<span class="params">self, key: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Extract pattern from key (e.g., user:123 -&gt; user:*&quot;&quot;&quot;</span></span><br><span class="line">        parts = key.split(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(parts) &gt; <span class="number">1</span>:</span><br><span class="line">            <span class="comment"># Replace numeric parts with *</span></span><br><span class="line">            pattern_parts = []</span><br><span class="line">            <span class="keyword">for</span> part <span class="keyword">in</span> parts:</span><br><span class="line">                <span class="keyword">if</span> part.isdigit():</span><br><span class="line">                    pattern_parts.append(<span class="string">&#x27;*&#x27;</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    pattern_parts.append(part)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;:&#x27;</span>.join(pattern_parts)</span><br><span class="line">        <span class="keyword">return</span> key</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_large_keys</span>(<span class="params">self, threshold_bytes: <span class="built_in">int</span> = <span class="number">1024</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Find keys that consume more memory than threshold&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        large_keys = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> <span class="variable language_">self</span>.redis.scan_iter():</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                key_str = key.decode()</span><br><span class="line">                memory_usage = <span class="variable language_">self</span>.redis.memory_usage(key)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> memory_usage &gt; threshold_bytes:</span><br><span class="line">                    key_info = &#123;</span><br><span class="line">                        <span class="string">&#x27;key&#x27;</span>: key_str,</span><br><span class="line">                        <span class="string">&#x27;memory_bytes&#x27;</span>: memory_usage,</span><br><span class="line">                        <span class="string">&#x27;type&#x27;</span>: <span class="variable language_">self</span>.redis.<span class="built_in">type</span>(key).decode(),</span><br><span class="line">                        <span class="string">&#x27;ttl&#x27;</span>: <span class="variable language_">self</span>.redis.ttl(key)</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># Additional info based on type</span></span><br><span class="line">                    key_type = key_info[<span class="string">&#x27;type&#x27;</span>]</span><br><span class="line">                    <span class="keyword">if</span> key_type == <span class="string">&#x27;string&#x27;</span>:</span><br><span class="line">                        key_info[<span class="string">&#x27;length&#x27;</span>] = <span class="variable language_">self</span>.redis.strlen(key)</span><br><span class="line">                    <span class="keyword">elif</span> key_type == <span class="string">&#x27;list&#x27;</span>:</span><br><span class="line">                        key_info[<span class="string">&#x27;length&#x27;</span>] = <span class="variable language_">self</span>.redis.llen(key)</span><br><span class="line">                    <span class="keyword">elif</span> key_type == <span class="string">&#x27;set&#x27;</span>:</span><br><span class="line">                        key_info[<span class="string">&#x27;length&#x27;</span>] = <span class="variable language_">self</span>.redis.scard(key)</span><br><span class="line">                    <span class="keyword">elif</span> key_type == <span class="string">&#x27;hash&#x27;</span>:</span><br><span class="line">                        key_info[<span class="string">&#x27;length&#x27;</span>] = <span class="variable language_">self</span>.redis.hlen(key)</span><br><span class="line">                    <span class="keyword">elif</span> key_type == <span class="string">&#x27;zset&#x27;</span>:</span><br><span class="line">                        key_info[<span class="string">&#x27;length&#x27;</span>] = <span class="variable language_">self</span>.redis.zcard(key)</span><br><span class="line">                    </span><br><span class="line">                    large_keys.append(key_info)</span><br><span class="line">                    </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Error checking key <span class="subst">&#123;key&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Sort by memory usage</span></span><br><span class="line">        large_keys.sort(key=<span class="keyword">lambda</span> x: x[<span class="string">&#x27;memory_bytes&#x27;</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\nFound <span class="subst">&#123;<span class="built_in">len</span>(large_keys)&#125;</span> keys larger than <span class="subst">&#123;threshold_bytes&#125;</span> bytes:&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> key_info <span class="keyword">in</span> large_keys[:<span class="number">10</span>]:  <span class="comment"># Show top 10</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Key: <span class="subst">&#123;key_info[<span class="string">&#x27;key&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  Memory: <span class="subst">&#123;key_info[<span class="string">&#x27;memory_bytes&#x27;</span>]&#125;</span> bytes&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  Type: <span class="subst">&#123;key_info[<span class="string">&#x27;type&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  Length: <span class="subst">&#123;key_info.get(<span class="string">&#x27;length&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  TTL: <span class="subst">&#123;key_info[<span class="string">&#x27;ttl&#x27;</span>]&#125;</span> seconds&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> large_keys</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">connection_pool_stats</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get connection pool statistics&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(<span class="variable language_">self</span>.redis, <span class="string">&#x27;connection_pool&#x27;</span>):</span><br><span class="line">            pool = <span class="variable language_">self</span>.redis.connection_pool</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;created_connections&#x27;</span>: pool.created_connections,</span><br><span class="line">                <span class="string">&#x27;available_connections&#x27;</span>: <span class="built_in">len</span>(pool._available_connections),</span><br><span class="line">                <span class="string">&#x27;in_use_connections&#x27;</span>: <span class="built_in">len</span>(pool._in_use_connections),</span><br><span class="line">                <span class="string">&#x27;max_connections&#x27;</span>: pool.max_connections</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;Connection pool info not available&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage example</span></span><br><span class="line">debugger = RedisDebugger()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Analyze memory usage</span></span><br><span class="line">memory_stats = debugger.analyze_memory_usage(sample_size=<span class="number">500</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Find large keys</span></span><br><span class="line">large_keys = debugger.find_large_keys(threshold_bytes=<span class="number">10240</span>)  <span class="comment"># 10KB threshold</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Check connection pool</span></span><br><span class="line">pool_stats = debugger.connection_pool_stats()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Connection pool stats: <span class="subst">&#123;pool_stats&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>🎯 Interview Insight</strong>: <em>Debugging questions often focus on production issues. Discuss tools like Redis MONITOR (and its performance impact), MEMORY USAGE command, and the importance of having proper monitoring in place before issues occur.</em></p>
<h2 id="Production-Best-Practices"><a href="#Production-Best-Practices" class="headerlink" title="Production Best Practices"></a>Production Best Practices</h2><h3 id="1-High-Availability-Setup"><a href="#1-High-Availability-Setup" class="headerlink" title="1. High Availability Setup"></a>1. High Availability Setup</h3><pre>
<code class="mermaid">
graph TB
subgraph &quot;Redis Sentinel Cluster&quot;
    S1[Sentinel 1]
    S2[Sentinel 2] 
    S3[Sentinel 3]
end

subgraph &quot;Redis Instances&quot;
    M[Master]
    R1[Replica 1]
    R2[Replica 2]
end

subgraph &quot;Application Layer&quot;
    A1[App Instance 1]
    A2[App Instance 2]
    A3[App Instance 3]
end

S1 -.-&gt; M
S1 -.-&gt; R1
S1 -.-&gt; R2
S2 -.-&gt; M
S2 -.-&gt; R1
S2 -.-&gt; R2
S3 -.-&gt; M
S3 -.-&gt; R1
S3 -.-&gt; R2

A1 --&gt; S1
A2 --&gt; S2
A3 --&gt; S3

M --&gt; R1
M --&gt; R2

style M fill:#ff6b6b
style R1 fill:#4ecdc4
style R2 fill:#4ecdc4
style S1 fill:#ffe66d
style S2 fill:#ffe66d
style S3 fill:#ffe66d
</code>
</pre>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis.sentinel</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HighAvailabilityRedisClient</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Redis Sentinel configuration</span></span><br><span class="line">        <span class="variable language_">self</span>.sentinels = [</span><br><span class="line">            (<span class="string">&#x27;sentinel1.example.com&#x27;</span>, <span class="number">26379</span>),</span><br><span class="line">            (<span class="string">&#x27;sentinel2.example.com&#x27;</span>, <span class="number">26379</span>),</span><br><span class="line">            (<span class="string">&#x27;sentinel3.example.com&#x27;</span>, <span class="number">26379</span>)</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.sentinel = redis.sentinel.Sentinel(</span><br><span class="line">            <span class="variable language_">self</span>.sentinels,</span><br><span class="line">            socket_timeout=<span class="number">0.5</span>,</span><br><span class="line">            socket_connect_timeout=<span class="number">0.5</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.master_name = <span class="string">&#x27;mymaster&#x27;</span></span><br><span class="line">        <span class="variable language_">self</span>.master = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.slaves = []</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>._initialize_connections()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_initialize_connections</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Initialize master and slave connections&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># Get master connection</span></span><br><span class="line">            <span class="variable language_">self</span>.master = <span class="variable language_">self</span>.sentinel.master_for(</span><br><span class="line">                <span class="variable language_">self</span>.master_name,</span><br><span class="line">                socket_timeout=<span class="number">0.5</span>,</span><br><span class="line">                socket_connect_timeout=<span class="number">0.5</span>,</span><br><span class="line">                retry_on_timeout=<span class="literal">True</span>,</span><br><span class="line">                db=<span class="number">0</span></span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Get slave connections for read operations</span></span><br><span class="line">            <span class="variable language_">self</span>.slave = <span class="variable language_">self</span>.sentinel.slave_for(</span><br><span class="line">                <span class="variable language_">self</span>.master_name,</span><br><span class="line">                socket_timeout=<span class="number">0.5</span>,</span><br><span class="line">                socket_connect_timeout=<span class="number">0.5</span>,</span><br><span class="line">                retry_on_timeout=<span class="literal">True</span>,</span><br><span class="line">                db=<span class="number">0</span></span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Redis HA connections initialized successfully&quot;</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Failed to initialize Redis HA connections: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, key: <span class="built_in">str</span>, use_slave: <span class="built_in">bool</span> = <span class="literal">True</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get data, optionally from slave for read scaling&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> use_slave <span class="keyword">and</span> <span class="variable language_">self</span>.slave:</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">self</span>.slave.get(key)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">self</span>.master.get(key)</span><br><span class="line">        <span class="keyword">except</span> redis.ConnectionError:</span><br><span class="line">            <span class="comment"># Failover handling</span></span><br><span class="line">            <span class="variable language_">self</span>._handle_connection_error()</span><br><span class="line">            <span class="comment"># Retry with master</span></span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.master.get(key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set</span>(<span class="params">self, key: <span class="built_in">str</span>, value: <span class="built_in">str</span>, ex: <span class="built_in">int</span> = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Set data (always use master for writes)&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.master.<span class="built_in">set</span>(key, value, ex=ex)</span><br><span class="line">        <span class="keyword">except</span> redis.ConnectionError:</span><br><span class="line">            <span class="variable language_">self</span>._handle_connection_error()</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.master.<span class="built_in">set</span>(key, value, ex=ex)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_handle_connection_error</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Handle connection errors and potential failover&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Redis connection error detected, reinitializing connections...&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>._initialize_connections()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Failed to reinitialize connections: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">health_check</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Check health of Redis cluster&quot;&quot;&quot;</span></span><br><span class="line">        health_status = &#123;</span><br><span class="line">            <span class="string">&#x27;master_available&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">            <span class="string">&#x27;slaves_available&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;sentinel_status&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;overall_status&#x27;</span>: <span class="string">&#x27;unhealthy&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Check master</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>.master.ping()</span><br><span class="line">            health_status[<span class="string">&#x27;master_available&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Check slaves</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>.slave.ping()</span><br><span class="line">            health_status[<span class="string">&#x27;slaves_available&#x27;</span>] = <span class="number">1</span>  <span class="comment"># Simplified</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Check sentinels</span></span><br><span class="line">        <span class="keyword">for</span> sentinel_host, sentinel_port <span class="keyword">in</span> <span class="variable language_">self</span>.sentinels:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                sentinel_conn = redis.Redis(host=sentinel_host, port=sentinel_port)</span><br><span class="line">                sentinel_conn.ping()</span><br><span class="line">                health_status[<span class="string">&#x27;sentinel_status&#x27;</span>].append(&#123;</span><br><span class="line">                    <span class="string">&#x27;host&#x27;</span>: sentinel_host,</span><br><span class="line">                    <span class="string">&#x27;port&#x27;</span>: sentinel_port,</span><br><span class="line">                    <span class="string">&#x27;status&#x27;</span>: <span class="string">&#x27;healthy&#x27;</span></span><br><span class="line">                &#125;)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                health_status[<span class="string">&#x27;sentinel_status&#x27;</span>].append(&#123;</span><br><span class="line">                    <span class="string">&#x27;host&#x27;</span>: sentinel_host,</span><br><span class="line">                    <span class="string">&#x27;port&#x27;</span>: sentinel_port,</span><br><span class="line">                    <span class="string">&#x27;status&#x27;</span>: <span class="string">&#x27;unhealthy&#x27;</span></span><br><span class="line">                &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Determine overall status</span></span><br><span class="line">        healthy_sentinels = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> s <span class="keyword">in</span> health_status[<span class="string">&#x27;sentinel_status&#x27;</span>] </span><br><span class="line">                              <span class="keyword">if</span> s[<span class="string">&#x27;status&#x27;</span>] == <span class="string">&#x27;healthy&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (health_status[<span class="string">&#x27;master_available&#x27;</span>] <span class="keyword">and</span> </span><br><span class="line">            healthy_sentinels &gt;= <span class="number">2</span>):  <span class="comment"># Quorum</span></span><br><span class="line">            health_status[<span class="string">&#x27;overall_status&#x27;</span>] = <span class="string">&#x27;healthy&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> healthy_sentinels &gt;= <span class="number">2</span>:</span><br><span class="line">            health_status[<span class="string">&#x27;overall_status&#x27;</span>] = <span class="string">&#x27;degraded&#x27;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> health_status</span><br></pre></td></tr></table></figure>

<h3 id="2-Security-Best-Practices"><a href="#2-Security-Best-Practices" class="headerlink" title="2. Security Best Practices"></a>2. Security Best Practices</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> hmac</span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"><span class="keyword">from</span> cryptography.fernet <span class="keyword">import</span> Fernet</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SecureRedisClient</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># SSL/TLS configuration</span></span><br><span class="line">        <span class="variable language_">self</span>.redis = redis.Redis(</span><br><span class="line">            host=<span class="string">&#x27;redis.example.com&#x27;</span>,</span><br><span class="line">            port=<span class="number">6380</span>,  <span class="comment"># TLS port</span></span><br><span class="line">            password=<span class="string">&#x27;your-strong-password&#x27;</span>,</span><br><span class="line">            ssl=<span class="literal">True</span>,</span><br><span class="line">            ssl_cert_reqs=ssl.CERT_REQUIRED,</span><br><span class="line">            ssl_ca_certs=<span class="string">&#x27;/path/to/ca-cert.pem&#x27;</span>,</span><br><span class="line">            ssl_certfile=<span class="string">&#x27;/path/to/client-cert.pem&#x27;</span>,</span><br><span class="line">            ssl_keyfile=<span class="string">&#x27;/path/to/client-key.pem&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Encryption for sensitive data</span></span><br><span class="line">        <span class="variable language_">self</span>.encryption_key = Fernet.generate_key()</span><br><span class="line">        <span class="variable language_">self</span>.cipher = Fernet(<span class="variable language_">self</span>.encryption_key)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Rate limiting</span></span><br><span class="line">        <span class="variable language_">self</span>.rate_limiter = RateLimiter()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_encrypted</span>(<span class="params">self, key: <span class="built_in">str</span>, value: <span class="built_in">str</span>, ex: <span class="built_in">int</span> = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Store encrypted data&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Encrypt sensitive data</span></span><br><span class="line">        encrypted_value = <span class="variable language_">self</span>.cipher.encrypt(value.encode())</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Add integrity check</span></span><br><span class="line">        checksum = hashlib.sha256(value.encode()).hexdigest()</span><br><span class="line">        </span><br><span class="line">        data_with_checksum = &#123;</span><br><span class="line">            <span class="string">&#x27;data&#x27;</span>: encrypted_value.decode(),</span><br><span class="line">            <span class="string">&#x27;checksum&#x27;</span>: checksum</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.redis.<span class="built_in">set</span>(key, json.dumps(data_with_checksum), ex=ex)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_encrypted</span>(<span class="params">self, key: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Retrieve and decrypt data&quot;&quot;&quot;</span></span><br><span class="line">        encrypted_data = <span class="variable language_">self</span>.redis.get(key)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> encrypted_data:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data_dict = json.loads(encrypted_data)</span><br><span class="line">            encrypted_value = data_dict[<span class="string">&#x27;data&#x27;</span>].encode()</span><br><span class="line">            stored_checksum = data_dict[<span class="string">&#x27;checksum&#x27;</span>]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Decrypt</span></span><br><span class="line">            decrypted_value = <span class="variable language_">self</span>.cipher.decrypt(encrypted_value).decode()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Verify integrity</span></span><br><span class="line">            computed_checksum = hashlib.sha256(decrypted_value.encode()).hexdigest()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> hmac.compare_digest(stored_checksum, computed_checksum):</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&quot;Data integrity check failed&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> decrypted_value</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Failed to decrypt data: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">secure_session_management</span>(<span class="params">self, session_id: <span class="built_in">str</span>, user_id: <span class="built_in">int</span>, </span></span><br><span class="line"><span class="params">                                 session_data: <span class="type">Dict</span>, ttl: <span class="built_in">int</span> = <span class="number">3600</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Secure session management with Redis&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Create secure session key</span></span><br><span class="line">        session_key = <span class="string">f&quot;session:<span class="subst">&#123;hashlib.sha256(session_id.encode()).hexdigest()&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Session data with security metadata</span></span><br><span class="line">        secure_session_data = &#123;</span><br><span class="line">            <span class="string">&#x27;user_id&#x27;</span>: user_id,</span><br><span class="line">            <span class="string">&#x27;created_at&#x27;</span>: time.time(),</span><br><span class="line">            <span class="string">&#x27;ip_address&#x27;</span>: session_data.get(<span class="string">&#x27;ip_address&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;user_agent_hash&#x27;</span>: hashlib.sha256(</span><br><span class="line">                session_data.get(<span class="string">&#x27;user_agent&#x27;</span>, <span class="string">&#x27;&#x27;</span>).encode()</span><br><span class="line">            ).hexdigest(),</span><br><span class="line">            <span class="string">&#x27;data&#x27;</span>: session_data.get(<span class="string">&#x27;data&#x27;</span>, &#123;&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Store encrypted session</span></span><br><span class="line">        <span class="variable language_">self</span>.set_encrypted(session_key, json.dumps(secure_session_data), ex=ttl)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Track active sessions for user</span></span><br><span class="line">        user_sessions_key = <span class="string">f&quot;user_sessions:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.redis.sadd(user_sessions_key, session_key)</span><br><span class="line">        <span class="variable language_">self</span>.redis.expire(user_sessions_key, ttl)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> session_key</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">validate_session</span>(<span class="params">self, session_id: <span class="built_in">str</span>, ip_address: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                        user_agent: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Validate session with security checks&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        session_key = <span class="string">f&quot;session:<span class="subst">&#123;hashlib.sha256(session_id.encode()).hexdigest()&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        session_data_str = <span class="variable language_">self</span>.get_encrypted(session_key)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> session_data_str:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            session_data = json.loads(session_data_str)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Security validations</span></span><br><span class="line">            user_agent_hash = hashlib.sha256(user_agent.encode()).hexdigest()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> session_data.get(<span class="string">&#x27;user_agent_hash&#x27;</span>) != user_agent_hash:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Session validation failed: User agent mismatch&quot;</span>)</span><br><span class="line">                <span class="variable language_">self</span>.invalidate_session(session_id)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Optional: IP address validation (be careful with load balancers)</span></span><br><span class="line">            <span class="keyword">if</span> session_data.get(<span class="string">&#x27;ip_address&#x27;</span>) != ip_address:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Session validation failed: IP address changed&quot;</span>)</span><br><span class="line">                <span class="comment"># You might want to require re-authentication instead of invalidating</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> session_data</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Session validation error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">invalidate_session</span>(<span class="params">self, session_id: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Securely invalidate a session&quot;&quot;&quot;</span></span><br><span class="line">        session_key = <span class="string">f&quot;session:<span class="subst">&#123;hashlib.sha256(session_id.encode()).hexdigest()&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Get user ID before deleting session</span></span><br><span class="line">        session_data_str = <span class="variable language_">self</span>.get_encrypted(session_key)</span><br><span class="line">        <span class="keyword">if</span> session_data_str:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                session_data = json.loads(session_data_str)</span><br><span class="line">                user_id = session_data.get(<span class="string">&#x27;user_id&#x27;</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># Remove from user&#x27;s active sessions</span></span><br><span class="line">                <span class="keyword">if</span> user_id:</span><br><span class="line">                    user_sessions_key = <span class="string">f&quot;user_sessions:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">                    <span class="variable language_">self</span>.redis.srem(user_sessions_key, session_key)</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Error during session cleanup: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Delete the session</span></span><br><span class="line">        <span class="variable language_">self</span>.redis.delete(session_key)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RateLimiter</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis_client</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_allowed</span>(<span class="params">self, identifier: <span class="built_in">str</span>, limit: <span class="built_in">int</span>, window: <span class="built_in">int</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Sliding window rate limiter&quot;&quot;&quot;</span></span><br><span class="line">        current_time = <span class="built_in">int</span>(time.time())</span><br><span class="line">        window_start = current_time - window</span><br><span class="line">        </span><br><span class="line">        key = <span class="string">f&quot;rate_limit:<span class="subst">&#123;identifier&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Remove old entries</span></span><br><span class="line">        <span class="variable language_">self</span>.redis.zremrangebyscore(key, <span class="number">0</span>, window_start)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Count current requests</span></span><br><span class="line">        current_requests = <span class="variable language_">self</span>.redis.zcard(key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> current_requests &gt;= limit:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Add current request</span></span><br><span class="line">        <span class="variable language_">self</span>.redis.zadd(key, &#123;<span class="built_in">str</span>(current_time): current_time&#125;)</span><br><span class="line">        <span class="variable language_">self</span>.redis.expire(key, window)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>

<p><strong>🎯 Interview Insight</strong>: <em>Security questions often cover data encryption, session management, and rate limiting. Discuss the balance between security and performance, and mention compliance requirements (GDPR, HIPAA) that might affect caching strategies.</em></p>
<h3 id="3-Operational-Excellence"><a href="#3-Operational-Excellence" class="headerlink" title="3. Operational Excellence"></a>3. Operational Excellence</h3><pre><code class="language-python">class RedisOperationalExcellence:
    def __init__(self):
        self.redis = Redis(host=&#39;localhost&#39;, port=6379, db=0)
        self.backup_location = &#39;/var/backups/redis&#39;
        
    def automated_backup(self):
        &quot;&quot;&quot;Automated backup with rotation&quot;&quot;&quot;
        import subprocess
        from datetime import datetime
        
        timestamp = datetime.now().strftime(&#39;%Y%m%d_%H%M%S&#39;)
        backup_file = f&quot;&#123;self.backup_location&#125;/redis_backup_&#123;timestamp&#125;.rdb&quot;
        
        try:
            # Trigger background save
            self.redis.bgsave()
            
            # Wait for background save to complete
            while self.redis.lastsave() == self.redis.lastsave():
                time.sleep(1)
            
            # Copy RDB file
            subprocess.run([
                &#39;cp&#39;, &#39;/var/lib/redis/dump.rdb&#39;, backup_file
            ], check=True)
            
            # Compress backup
            subprocess.run([
                &#39;gzip&#39;, backup_file
            ], check=True)
            
            # Cleanup old backups (keep last 7 days)
            self._cleanup_old_backups()
            
            print(f&quot;Backup completed: &#123;backup_file&#125;.gz&quot;)
            
        except Exception as e:
            print(f&quot;Backup failed: &#123;e&#125;&quot;)
            # Send alert to monitoring system
            self._send_alert(&quot;Redis backup failed&quot;, str(e))
    
    def _cleanup_old_backups(self):
        &quot;&quot;&quot;Remove backups older than 7 days&quot;&quot;&quot;
        import os
        import glob
        from datetime import datetime, timedelta
        
        cutoff_date = datetime.now() - timedelta(days=7)
        pattern = f&quot;&#123;self.backup_location&#125;/redis_backup_*.rdb.gz&quot;
        
        for backup_file in glob.glob(pattern):
            file_time = datetime.fromtimestamp(os.path.getctime(backup_file))
            if file_time &lt; cutoff_date:
                os.remove(backup_file)
                print(f&quot;Removed old backup: &#123;backup_file&#125;&quot;)
    
    def capacity_planning_analysis(self) -&gt; Dict:
        &quot;&quot;&quot;Analyze Redis usage for capacity planning&quot;&quot;&quot;
        info = self.redis.info()
        
        # Memory analysis
        used_memory = info[&#39;used_memory&#39;]
        used_memory_peak = info[&#39;used_memory_peak&#39;]
        max_memory = info.get(&#39;maxmemory&#39;, 0)
        
        # Connection analysis
        connected_clients = info[&#39;connected_clients&#39;]
        
        # Key analysis
        total_keys = sum(info.get(f&#39;db&#123;i&#125;&#39;, &#123;&#125;).get(&#39;keys&#39;, 0) for i in range(16))
        
        # Performance metrics
        ops_per_sec = info.get(&#39;instantaneous_ops_per_sec&#39;, 0)
        
        # Calculate trends (simplified - in production, use time series data)
        memory_growth_rate = self._calculate_memory_growth_rate()
        
        recommendations = []
        
        # Memory recommendations
        if max_memory &gt; 0:
            memory_usage_pct = (used_memory / max_memory) * 100
            if memory_usage_pct &gt; 80:
                recommendations.append(&quot;Memory usage is high - consider scaling up&quot;)
        
        # Connection recommendations
        if connected_clients &gt; 1000:
            recommendations.append(&quot;High connection count - review connection pooling&quot;)
        
        # Performance recommendations
        if ops_per_sec &gt; 100000:
            recommendations.append(&quot;High operation rate - consider read replicas&quot;)
        
        return &#123;
            &#39;memory&#39;: &#123;
                &#39;used_bytes&#39;: used_memory,
                &#39;used_human&#39;: info[&#39;used_memory_human&#39;],
                &#39;peak_bytes&#39;: used_memory_peak,
                &#39;peak_human&#39;: info[&#39;used_memory_peak_human&#39;],
                &#39;max_bytes&#39;: max_memory,
                &#39;usage_percentage&#39;: (used_memory / max_memory * 100) if max_memory &gt; 0 else 0,
                &#39;growth_rate_mb_per_day&#39;: memory_growth_rate
            &#125;,
            &#39;connections&#39;: &#123;
                &#39;current&#39;: connected_clients,
                &#39;max_input&#39;: info.get(&#39;maxclients&#39;, &#39;unlimited&#39;)
            &#125;,
            &#39;keys&#39;: &#123;
                &#39;total&#39;: total_keys,
                &#39;expired&#39;: info.get(&#39;expired_keys&#39;, 0),
                &#39;evicted&#39;: info.get(&#39;evicted_keys&#39;, 0)
            &#125;,
            &#39;performance&#39;: &#123;
                &#39;ops_per_second&#39;: ops_per_sec,
                &#39;keyspace_hits&#39;: info.get(&#39;keyspace_hits&#39;, 0),
                &#39;keyspace_misses&#39;: info.get(&#39;keyspace_misses&#39;, 0),
                &#39;hit_rate&#39;: self._calculate_hit_rate(info)
            &#125;,
            &#39;recommendations&#39;: recommendations
        &#125;
    
    def _calculate_memory_growth_rate(self) -&gt; float:
        &quot;&quot;&quot;Calculate memory growth rate (simplified)&quot;&quot;&quot;
        # In production, this would analyze historical data
        # For demo purposes, return a placeholder
        return 50.0
</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/10/Redis-Cache-Problems-Penetration-Breakdown-and-Avalanche/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/10/Redis-Cache-Problems-Penetration-Breakdown-and-Avalanche/" class="post-title-link" itemprop="url">Redis Cache Problems:Penetration,Breakdown and Avalanche</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-10 18:43:56" itemprop="dateCreated datePublished" datetime="2025-06-10T18:43:56+08:00">2025-06-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-12 13:47:15" itemprop="dateModified" datetime="2025-06-12T13:47:15+08:00">2025-06-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Redis-Cache-Problems-Penetration-Breakdown-Avalanche"><a href="#Redis-Cache-Problems-Penetration-Breakdown-Avalanche" class="headerlink" title="Redis Cache Problems: Penetration, Breakdown &amp; Avalanche"></a>Redis Cache Problems: Penetration, Breakdown &amp; Avalanche</h1><h2 id="Table-of-Contents"><a href="#Table-of-Contents" class="headerlink" title="Table of Contents"></a>Table of Contents</h2><ol>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#cache-penetration">Cache Penetration</a></li>
<li><a href="#cache-breakdown">Cache Breakdown</a></li>
<li><a href="#cache-avalanche">Cache Avalanche</a></li>
<li><a href="#monitoring-and-alerting">Monitoring and Alerting</a></li>
<li><a href="#best-practices-summary">Best Practices Summary</a></li>
</ol>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Cache problems are among the most critical challenges in distributed systems, capable of bringing down entire applications within seconds. Understanding these problems isn’t just about knowing Redis commands—it’s about system design, failure modes, and building resilient architectures that can handle millions of requests per second.<br>This guide explores three fundamental cache problems through the lens of Redis, the most widely-used in-memory data structure store. We’ll cover not just the “what” and “how,” but the “why” behind each solution, helping you make informed architectural decisions.<br><strong>Interview Reality Check</strong>: <em>Senior engineers are expected to know these problems intimately. You’ll likely face questions like “Walk me through what happens when 1 million users hit your cache simultaneously and it fails” or “How would you design a cache system for Black Friday traffic?” This guide prepares you for those conversations.</em></p>
<h2 id="Cache-Penetration"><a href="#Cache-Penetration" class="headerlink" title="Cache Penetration"></a>Cache Penetration</h2><h3 id="What-is-Cache-Penetration"><a href="#What-is-Cache-Penetration" class="headerlink" title="What is Cache Penetration?"></a>What is Cache Penetration?</h3><p>Cache penetration(&#x2F;ˌpenəˈtreɪʃn&#x2F;) occurs when queries for non-existent data repeatedly bypass the cache and hit the database directly. This happens because the cache doesn’t store null or empty results, allowing malicious or accidental queries to overwhelm the database.</p>
<pre>
<code class="mermaid">
sequenceDiagram
participant Attacker
participant LoadBalancer
participant AppServer
participant Redis
participant Database
participant Monitor

Note over Attacker: Launches penetration attack

loop Every 10ms for 1000 requests
    Attacker-&gt;&gt;LoadBalancer: GET &#x2F;user&#x2F;999999999
    LoadBalancer-&gt;&gt;AppServer: Route request
    AppServer-&gt;&gt;Redis: GET user:999999999
    Redis--&gt;&gt;AppServer: null (cache miss)
    AppServer-&gt;&gt;Database: SELECT * FROM users WHERE id&#x3D;999999999
    Database--&gt;&gt;AppServer: Empty result
    AppServer--&gt;&gt;LoadBalancer: 404 Not Found
    LoadBalancer--&gt;&gt;Attacker: 404 Not Found
end

Database-&gt;&gt;Monitor: High CPU&#x2F;Memory Alert
Monitor-&gt;&gt;AppServer: Database overload detected

Note over Database: Database performance degrades
Note over AppServer: Legitimate requests start failing
</code>
</pre>

<h3 id="Common-Scenarios"><a href="#Common-Scenarios" class="headerlink" title="Common Scenarios"></a>Common Scenarios</h3><ol>
<li><strong>Malicious Attacks</strong>: Attackers deliberately query non-existent data</li>
<li><strong>Client Bugs</strong>: Application bugs causing queries for invalid IDs</li>
<li><strong>Data Inconsistency</strong>: Race conditions where data is deleted but cache isn’t updated</li>
</ol>
<h3 id="Solution-1-Null-Value-Caching"><a href="#Solution-1-Null-Value-Caching" class="headerlink" title="Solution 1: Null Value Caching"></a>Solution 1: Null Value Caching</h3><p>Cache null results with a shorter TTL to prevent repeated database queries.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.null_cache_ttl = <span class="number">60</span>  <span class="comment"># 1 minute for null values</span></span><br><span class="line">        <span class="variable language_">self</span>.normal_cache_ttl = <span class="number">3600</span>  <span class="comment"># 1 hour for normal data</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">self, user_id: <span class="built_in">int</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        cache_key = <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Check cache first</span></span><br><span class="line">        cached_result = <span class="variable language_">self</span>.redis_client.get(cache_key)</span><br><span class="line">        <span class="keyword">if</span> cached_result <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">if</span> cached_result == <span class="string">b&quot;NULL&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">            <span class="keyword">return</span> json.loads(cached_result)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Query database</span></span><br><span class="line">        user = <span class="variable language_">self</span>.query_database(user_id)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># Cache null result with shorter TTL</span></span><br><span class="line">            <span class="variable language_">self</span>.redis_client.setex(cache_key, <span class="variable language_">self</span>.null_cache_ttl, <span class="string">&quot;NULL&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># Cache normal result</span></span><br><span class="line">            <span class="variable language_">self</span>.redis_client.setex(cache_key, <span class="variable language_">self</span>.normal_cache_ttl, json.dumps(user))</span><br><span class="line">            <span class="keyword">return</span> user</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">query_database</span>(<span class="params">self, user_id: <span class="built_in">int</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="comment"># Simulate database query</span></span><br><span class="line">        <span class="comment"># In real implementation, this would be your database call</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>  <span class="comment"># Simulating user not found</span></span><br></pre></td></tr></table></figure>

<h3 id="Solution-2-Bloom-Filter"><a href="#Solution-2-Bloom-Filter" class="headerlink" title="Solution 2: Bloom Filter"></a>Solution 2: Bloom Filter</h3><p>Use Bloom filters to quickly check if data might exist before querying the cache or database.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> mmh3</span><br><span class="line"><span class="keyword">from</span> bitarray <span class="keyword">import</span> bitarray</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BloomFilter</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, capacity: <span class="built_in">int</span>, error_rate: <span class="built_in">float</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.capacity = capacity</span><br><span class="line">        <span class="variable language_">self</span>.error_rate = error_rate</span><br><span class="line">        <span class="variable language_">self</span>.bit_array_size = <span class="variable language_">self</span>._get_size(capacity, error_rate)</span><br><span class="line">        <span class="variable language_">self</span>.hash_count = <span class="variable language_">self</span>._get_hash_count(<span class="variable language_">self</span>.bit_array_size, capacity)</span><br><span class="line">        <span class="variable language_">self</span>.bit_array = bitarray(<span class="variable language_">self</span>.bit_array_size)</span><br><span class="line">        <span class="variable language_">self</span>.bit_array.setall(<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_size</span>(<span class="params">self, n: <span class="built_in">int</span>, p: <span class="built_in">float</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="keyword">import</span> math</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>(-(n * math.log(p)) / (math.log(<span class="number">2</span>) ** <span class="number">2</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_hash_count</span>(<span class="params">self, m: <span class="built_in">int</span>, n: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="keyword">import</span> math</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>((m / n) * math.log(<span class="number">2</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">self, item: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="variable language_">self</span>.hash_count):</span><br><span class="line">            index = mmh3.<span class="built_in">hash</span>(item, i) % <span class="variable language_">self</span>.bit_array_size</span><br><span class="line">            <span class="variable language_">self</span>.bit_array[index] = <span class="number">1</span></span><br><span class="line">        <span class="comment"># Also store in Redis for persistence</span></span><br><span class="line">        <span class="variable language_">self</span>.redis_client.setbit(<span class="string">f&quot;bloom_filter&quot;</span>, index, <span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">contains</span>(<span class="params">self, item: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="variable language_">self</span>.hash_count):</span><br><span class="line">            index = mmh3.<span class="built_in">hash</span>(item, i) % <span class="variable language_">self</span>.bit_array_size</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.redis_client.getbit(<span class="string">f&quot;bloom_filter&quot;</span>, index):</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserServiceWithBloom</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.bloom_filter = BloomFilter(capacity=<span class="number">1000000</span>, error_rate=<span class="number">0.01</span>)</span><br><span class="line">        <span class="variable language_">self</span>.initialize_bloom_filter()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">initialize_bloom_filter</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Populate bloom filter with existing user IDs</span></span><br><span class="line">        existing_user_ids = <span class="variable language_">self</span>.get_all_user_ids_from_db()</span><br><span class="line">        <span class="keyword">for</span> user_id <span class="keyword">in</span> existing_user_ids:</span><br><span class="line">            <span class="variable language_">self</span>.bloom_filter.add(<span class="built_in">str</span>(user_id))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">self, user_id: <span class="built_in">int</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="comment"># Check bloom filter first</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.bloom_filter.contains(<span class="built_in">str</span>(user_id)):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span>  <span class="comment"># Definitely doesn&#x27;t exist</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Proceed with normal cache logic</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._get_user_from_cache_or_db(user_id)</span><br></pre></td></tr></table></figure>

<h3 id="Solution-3-Request-Validation"><a href="#Solution-3-Request-Validation" class="headerlink" title="Solution 3: Request Validation"></a>Solution 3: Request Validation</h3><p>Implement strict input validation to prevent invalid queries.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RequestValidator</span>:</span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">validate_user_id</span>(<span class="params">user_id: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="comment"># Validate user ID format</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user_id.isdigit():</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        user_id_int = <span class="built_in">int</span>(user_id)</span><br><span class="line">        <span class="comment"># Check reasonable range</span></span><br><span class="line">        <span class="keyword">if</span> user_id_int &lt;= <span class="number">0</span> <span class="keyword">or</span> user_id_int &gt; <span class="number">999999999</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">validate_email</span>(<span class="params">email: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        pattern = <span class="string">r&#x27;^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]&#123;2,&#125;$&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> re.<span class="keyword">match</span>(pattern, email) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SecureUserService</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">self, user_id: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="comment"># Validate input first</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> RequestValidator.validate_user_id(user_id):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;Invalid user ID format&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Proceed with normal logic</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._get_user_internal(<span class="built_in">int</span>(user_id))</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>When discussing cache penetration, mention the trade-offs: Null caching uses memory but reduces DB load, Bloom filters are memory-efficient but have false positives, and input validation prevents attacks but requires careful implementation.</em></p>
<h2 id="Cache-Breakdown"><a href="#Cache-Breakdown" class="headerlink" title="Cache Breakdown"></a>Cache Breakdown</h2><h3 id="What-is-Cache-Breakdown"><a href="#What-is-Cache-Breakdown" class="headerlink" title="What is Cache Breakdown?"></a>What is Cache Breakdown?</h3><p>Cache breakdown occurs when a popular cache key expires and multiple concurrent requests simultaneously try to rebuild the cache, causing a “thundering herd” effect on the database.</p>
<pre>
<code class="mermaid">
graph
A[Popular Cache Key Expires] --&gt; B[Multiple Concurrent Requests]
B --&gt; C[All Requests Miss Cache]
C --&gt; D[All Requests Hit Database]
D --&gt; E[Database Overload]
E --&gt; F[Performance Degradation]

style A fill:#ff6b6b
style E fill:#ff6b6b
style F fill:#ff6b6b
</code>
</pre>

<h3 id="Solution-1-Distributed-Locking"><a href="#Solution-1-Distributed-Locking" class="headerlink" title="Solution 1: Distributed Locking"></a>Solution 1: Distributed Locking</h3><p>Use Redis distributed locks to ensure only one process rebuilds the cache.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Callable</span></span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DistributedLock</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client: redis.Redis, key: <span class="built_in">str</span>, timeout: <span class="built_in">int</span> = <span class="number">10</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis_client</span><br><span class="line">        <span class="variable language_">self</span>.key = <span class="string">f&quot;lock:<span class="subst">&#123;key&#125;</span>&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.timeout = timeout</span><br><span class="line">        <span class="variable language_">self</span>.identifier = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">acquire</span>(<span class="params">self</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        end = time.time() + <span class="variable language_">self</span>.timeout</span><br><span class="line">        <span class="keyword">while</span> time.time() &lt; end:</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.redis.<span class="built_in">set</span>(<span class="variable language_">self</span>.key, <span class="variable language_">self</span>.identifier, nx=<span class="literal">True</span>, ex=<span class="variable language_">self</span>.timeout):</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            time.sleep(<span class="number">0.001</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">release</span>(<span class="params">self</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        pipe = <span class="variable language_">self</span>.redis.pipeline(<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                pipe.watch(<span class="variable language_">self</span>.key)</span><br><span class="line">                <span class="keyword">if</span> pipe.get(<span class="variable language_">self</span>.key) == <span class="variable language_">self</span>.identifier.encode():</span><br><span class="line">                    pipe.multi()</span><br><span class="line">                    pipe.delete(<span class="variable language_">self</span>.key)</span><br><span class="line">                    pipe.execute()</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">                pipe.unwatch()</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span> redis.WatchError:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CacheService</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.cache_ttl = <span class="number">3600</span></span><br><span class="line">        <span class="variable language_">self</span>.lock_timeout = <span class="number">10</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_with_lock</span>(<span class="params">self, key: <span class="built_in">str</span>, data_loader: <span class="type">Callable</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="comment"># Try to get from cache first</span></span><br><span class="line">        cached_data = <span class="variable language_">self</span>.redis_client.get(key)</span><br><span class="line">        <span class="keyword">if</span> cached_data:</span><br><span class="line">            <span class="keyword">return</span> json.loads(cached_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Cache miss - try to acquire lock</span></span><br><span class="line">        lock = DistributedLock(<span class="variable language_">self</span>.redis_client, key, <span class="variable language_">self</span>.lock_timeout)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> lock.acquire():</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># Double-check cache after acquiring lock</span></span><br><span class="line">                cached_data = <span class="variable language_">self</span>.redis_client.get(key)</span><br><span class="line">                <span class="keyword">if</span> cached_data:</span><br><span class="line">                    <span class="keyword">return</span> json.loads(cached_data)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># Load data from source</span></span><br><span class="line">                data = data_loader()</span><br><span class="line">                <span class="keyword">if</span> data:</span><br><span class="line">                    <span class="comment"># Cache the result</span></span><br><span class="line">                    <span class="variable language_">self</span>.redis_client.setex(key, <span class="variable language_">self</span>.cache_ttl, json.dumps(data))</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> data</span><br><span class="line">            <span class="keyword">finally</span>:</span><br><span class="line">                lock.release()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># Couldn&#x27;t acquire lock, return stale data or wait</span></span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>._handle_lock_failure(key, data_loader)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_handle_lock_failure</span>(<span class="params">self, key: <span class="built_in">str</span>, data_loader: <span class="type">Callable</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="comment"># Strategy 1: Return stale data if available</span></span><br><span class="line">        stale_data = <span class="variable language_">self</span>.redis_client.get(<span class="string">f&quot;stale:<span class="subst">&#123;key&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> stale_data:</span><br><span class="line">            <span class="keyword">return</span> json.loads(stale_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Strategy 2: Wait briefly and retry</span></span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        cached_data = <span class="variable language_">self</span>.redis_client.get(key)</span><br><span class="line">        <span class="keyword">if</span> cached_data:</span><br><span class="line">            <span class="keyword">return</span> json.loads(cached_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Strategy 3: Load from source as fallback</span></span><br><span class="line">        <span class="keyword">return</span> data_loader()</span><br></pre></td></tr></table></figure>

<h3 id="Solution-2-Logical-Expiration"><a href="#Solution-2-Logical-Expiration" class="headerlink" title="Solution 2: Logical Expiration"></a>Solution 2: Logical Expiration</h3><p>Use logical expiration to refresh cache asynchronously while serving stale data.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Callable</span>, <span class="type">Any</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CacheEntry</span>:</span><br><span class="line">    data: <span class="type">Any</span></span><br><span class="line">    logical_expire_time: <span class="built_in">float</span></span><br><span class="line">    is_refreshing: <span class="built_in">bool</span> = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LogicalExpirationCache</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.cache_ttl = <span class="number">3600</span>  <span class="comment"># 1 hour</span></span><br><span class="line">        <span class="variable language_">self</span>.logical_ttl = <span class="number">1800</span>  <span class="comment"># 30 minutes</span></span><br><span class="line">        <span class="variable language_">self</span>.refresh_locks = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.lock = threading.Lock()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, key: <span class="built_in">str</span>, data_loader: <span class="type">Callable</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        cached_value = <span class="variable language_">self</span>.redis_client.get(key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> cached_value:</span><br><span class="line">            <span class="comment"># Cache miss - load and cache data</span></span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>._load_and_cache(key, data_loader)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cache_entry = json.loads(cached_value)</span><br><span class="line">            current_time = time.time()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Check if logically expired</span></span><br><span class="line">            <span class="keyword">if</span> current_time &gt; cache_entry[<span class="string">&#x27;logical_expire_time&#x27;</span>]:</span><br><span class="line">                <span class="comment"># Start async refresh if not already refreshing</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> cache_entry.get(<span class="string">&#x27;is_refreshing&#x27;</span>, <span class="literal">False</span>):</span><br><span class="line">                    <span class="variable language_">self</span>._async_refresh(key, data_loader)</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># Mark as refreshing</span></span><br><span class="line">                    cache_entry[<span class="string">&#x27;is_refreshing&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">                    <span class="variable language_">self</span>.redis_client.setex(key, <span class="variable language_">self</span>.cache_ttl, json.dumps(cache_entry))</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> cache_entry[<span class="string">&#x27;data&#x27;</span>]</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> (json.JSONDecodeError, KeyError):</span><br><span class="line">            <span class="comment"># Corrupted cache entry</span></span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>._load_and_cache(key, data_loader)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_load_and_cache</span>(<span class="params">self, key: <span class="built_in">str</span>, data_loader: <span class="type">Callable</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        data = data_loader()</span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            cache_entry = &#123;</span><br><span class="line">                <span class="string">&#x27;data&#x27;</span>: data,</span><br><span class="line">                <span class="string">&#x27;logical_expire_time&#x27;</span>: time.time() + <span class="variable language_">self</span>.logical_ttl,</span><br><span class="line">                <span class="string">&#x27;is_refreshing&#x27;</span>: <span class="literal">False</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">self</span>.redis_client.setex(key, <span class="variable language_">self</span>.cache_ttl, json.dumps(cache_entry))</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_async_refresh</span>(<span class="params">self, key: <span class="built_in">str</span>, data_loader: <span class="type">Callable</span></span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">refresh_task</span>():</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># Load fresh data</span></span><br><span class="line">                fresh_data = data_loader()</span><br><span class="line">                <span class="keyword">if</span> fresh_data:</span><br><span class="line">                    cache_entry = &#123;</span><br><span class="line">                        <span class="string">&#x27;data&#x27;</span>: fresh_data,</span><br><span class="line">                        <span class="string">&#x27;logical_expire_time&#x27;</span>: time.time() + <span class="variable language_">self</span>.logical_ttl,</span><br><span class="line">                        <span class="string">&#x27;is_refreshing&#x27;</span>: <span class="literal">False</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="variable language_">self</span>.redis_client.setex(key, <span class="variable language_">self</span>.cache_ttl, json.dumps(cache_entry))</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Error refreshing cache for key <span class="subst">&#123;key&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="comment"># Reset refreshing flag on error</span></span><br><span class="line">                cached_value = <span class="variable language_">self</span>.redis_client.get(key)</span><br><span class="line">                <span class="keyword">if</span> cached_value:</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        cache_entry = json.loads(cached_value)</span><br><span class="line">                        cache_entry[<span class="string">&#x27;is_refreshing&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">                        <span class="variable language_">self</span>.redis_client.setex(key, <span class="variable language_">self</span>.cache_ttl, json.dumps(cache_entry))</span><br><span class="line">                    <span class="keyword">except</span>:</span><br><span class="line">                        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Start refresh in background thread</span></span><br><span class="line">        refresh_thread = threading.Thread(target=refresh_task)</span><br><span class="line">        refresh_thread.daemon = <span class="literal">True</span></span><br><span class="line">        refresh_thread.start()</span><br></pre></td></tr></table></figure>

<h3 id="Solution-3-Semaphore-based-Approach"><a href="#Solution-3-Semaphore-based-Approach" class="headerlink" title="Solution 3: Semaphore-based Approach"></a>Solution 3: Semaphore-based Approach</h3><p>Limit the number of concurrent cache rebuilds using semaphores.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Callable</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SemaphoreCache</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, max_concurrent_rebuilds: <span class="built_in">int</span> = <span class="number">3</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.semaphore = threading.Semaphore(max_concurrent_rebuilds)</span><br><span class="line">        <span class="variable language_">self</span>.cache_ttl = <span class="number">3600</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, key: <span class="built_in">str</span>, data_loader: <span class="type">Callable</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="comment"># Try cache first</span></span><br><span class="line">        cached_data = <span class="variable language_">self</span>.redis_client.get(key)</span><br><span class="line">        <span class="keyword">if</span> cached_data:</span><br><span class="line">            <span class="keyword">return</span> json.loads(cached_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Try to acquire semaphore for rebuild</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.semaphore.acquire(blocking=<span class="literal">False</span>):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># Double-check cache</span></span><br><span class="line">                cached_data = <span class="variable language_">self</span>.redis_client.get(key)</span><br><span class="line">                <span class="keyword">if</span> cached_data:</span><br><span class="line">                    <span class="keyword">return</span> json.loads(cached_data)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># Load and cache data</span></span><br><span class="line">                data = data_loader()</span><br><span class="line">                <span class="keyword">if</span> data:</span><br><span class="line">                    <span class="variable language_">self</span>.redis_client.setex(key, <span class="variable language_">self</span>.cache_ttl, json.dumps(data))</span><br><span class="line">                <span class="keyword">return</span> data</span><br><span class="line">            <span class="keyword">finally</span>:</span><br><span class="line">                <span class="variable language_">self</span>.semaphore.release()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># Semaphore not available, try alternatives</span></span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>._handle_semaphore_unavailable(key, data_loader)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_handle_semaphore_unavailable</span>(<span class="params">self, key: <span class="built_in">str</span>, data_loader: <span class="type">Callable</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="comment"># Wait briefly for other threads to complete</span></span><br><span class="line">        time.sleep(<span class="number">0.05</span>)</span><br><span class="line">        cached_data = <span class="variable language_">self</span>.redis_client.get(key)</span><br><span class="line">        <span class="keyword">if</span> cached_data:</span><br><span class="line">            <span class="keyword">return</span> json.loads(cached_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Fallback to direct database query</span></span><br><span class="line">        <span class="keyword">return</span> data_loader()</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Cache breakdown solutions have different trade-offs. Distributed locking ensures consistency but can create bottlenecks. Logical expiration provides better availability but serves stale data. Semaphores balance both but are more complex to implement correctly.</em></p>
<h2 id="Cache-Avalanche"><a href="#Cache-Avalanche" class="headerlink" title="Cache Avalanche"></a>Cache Avalanche</h2><h3 id="What-is-Cache-Avalanche"><a href="#What-is-Cache-Avalanche" class="headerlink" title="What is Cache Avalanche?"></a>What is Cache Avalanche?</h3><p>Cache avalanche(&#x2F;ˈævəlæntʃ&#x2F;) occurs when a large number of cache entries expire simultaneously, causing massive database load. This can happen due to synchronized expiration times or cache server failures.</p>
<pre>
<code class="mermaid">
flowchart
A[Cache Avalanche Triggers] --&gt; B[Mass Expiration]
A --&gt; C[Cache Server Failure]

B --&gt; D[Synchronized TTL]
B --&gt; E[Batch Operations]

C --&gt; F[Hardware Failure]
C --&gt; G[Network Issues]
C --&gt; H[Memory Exhaustion]

D --&gt; I[Database Overload]
E --&gt; I
F --&gt; I
G --&gt; I
H --&gt; I

I --&gt; J[Service Degradation]
I --&gt; K[Cascade Failures]

style A fill:#ff6b6b
style I fill:#ff6b6b
style J fill:#ff6b6b
style K fill:#ff6b6b
</code>
</pre>

<h3 id="Solution-1-Randomized-TTL"><a href="#Solution-1-Randomized-TTL" class="headerlink" title="Solution 1: Randomized TTL"></a>Solution 1: Randomized TTL</h3><p>Add randomization to cache expiration times to prevent synchronized expiration.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Union</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RandomizedTTLCache</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.base_ttl = <span class="number">3600</span>  <span class="comment"># 1 hour</span></span><br><span class="line">        <span class="variable language_">self</span>.jitter_range = <span class="number">0.2</span>  <span class="comment"># ±20% randomization</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_with_jitter</span>(<span class="params">self, key: <span class="built_in">str</span>, value: <span class="built_in">dict</span>, base_ttl: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Set cache value with randomized TTL to prevent avalanche&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> base_ttl <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            base_ttl = <span class="variable language_">self</span>.base_ttl</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Add random jitter to TTL</span></span><br><span class="line">        jitter = random.uniform(-<span class="variable language_">self</span>.jitter_range, <span class="variable language_">self</span>.jitter_range)</span><br><span class="line">        actual_ttl = <span class="built_in">int</span>(base_ttl * (<span class="number">1</span> + jitter))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Ensure TTL is not negative</span></span><br><span class="line">        actual_ttl = <span class="built_in">max</span>(actual_ttl, <span class="number">60</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.redis_client.setex(key, actual_ttl, json.dumps(value))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_or_set</span>(<span class="params">self, key: <span class="built_in">str</span>, data_loader, ttl: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get from cache or set with randomized TTL&quot;&quot;&quot;</span></span><br><span class="line">        cached_data = <span class="variable language_">self</span>.redis_client.get(key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> cached_data:</span><br><span class="line">            <span class="keyword">return</span> json.loads(cached_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Load data and cache with jitter</span></span><br><span class="line">        data = data_loader()</span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            <span class="variable language_">self</span>.set_with_jitter(key, data, ttl)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage example</span></span><br><span class="line">cache = RandomizedTTLCache()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_user_data</span>(<span class="params">user_id: <span class="built_in">int</span></span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">    <span class="comment"># Simulate database query</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;id&quot;</span>: user_id, <span class="string">&quot;name&quot;</span>: <span class="string">f&quot;User <span class="subst">&#123;user_id&#125;</span>&quot;</span>, <span class="string">&quot;email&quot;</span>: <span class="string">f&quot;user<span class="subst">&#123;user_id&#125;</span>@example.com&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Cache multiple users with randomized TTL</span></span><br><span class="line"><span class="keyword">for</span> user_id <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>, <span class="number">2000</span>):</span><br><span class="line">    cache.get_or_set(<span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span>, <span class="keyword">lambda</span> uid=user_id: load_user_data(uid))</span><br></pre></td></tr></table></figure>

<h3 id="Solution-2-Multi-level-Caching"><a href="#Solution-2-Multi-level-Caching" class="headerlink" title="Solution 2: Multi-level Caching"></a>Solution 2: Multi-level Caching</h3><p>Implement multiple cache layers to provide fallback options.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Dict</span>, <span class="type">Any</span>, <span class="type">List</span></span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CacheLevel</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    L1_MEMORY = <span class="string">&quot;l1_memory&quot;</span></span><br><span class="line">    L2_REDIS = <span class="string">&quot;l2_redis&quot;</span></span><br><span class="line">    L3_REDIS_CLUSTER = <span class="string">&quot;l3_redis_cluster&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MultiLevelCache</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># L1: In-memory cache (fastest, smallest)</span></span><br><span class="line">        <span class="variable language_">self</span>.l1_cache: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]] = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.l1_max_size = <span class="number">1000</span></span><br><span class="line">        <span class="variable language_">self</span>.l1_ttl = <span class="number">300</span>  <span class="comment"># 5 minutes</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># L2: Single Redis instance</span></span><br><span class="line">        <span class="variable language_">self</span>.l2_redis = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.l2_ttl = <span class="number">1800</span>  <span class="comment"># 30 minutes</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># L3: Redis cluster/backup</span></span><br><span class="line">        <span class="variable language_">self</span>.l3_redis = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6380</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.l3_ttl = <span class="number">3600</span>  <span class="comment"># 1 hour</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, key: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get value from cache levels in order&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Try L1 first</span></span><br><span class="line">        value = <span class="variable language_">self</span>._get_from_l1(key)</span><br><span class="line">        <span class="keyword">if</span> value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># Try L2</span></span><br><span class="line">        value = <span class="variable language_">self</span>._get_from_l2(key)</span><br><span class="line">        <span class="keyword">if</span> value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># Backfill L1</span></span><br><span class="line">            <span class="variable language_">self</span>._set_to_l1(key, value)</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># Try L3</span></span><br><span class="line">        value = <span class="variable language_">self</span>._get_from_l3(key)</span><br><span class="line">        <span class="keyword">if</span> value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># Backfill L1 and L2</span></span><br><span class="line">            <span class="variable language_">self</span>._set_to_l1(key, value)</span><br><span class="line">            <span class="variable language_">self</span>._set_to_l2(key, value)</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set</span>(<span class="params">self, key: <span class="built_in">str</span>, value: <span class="built_in">dict</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Set value to all cache levels&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>._set_to_l1(key, value)</span><br><span class="line">        <span class="variable language_">self</span>._set_to_l2(key, value)</span><br><span class="line">        <span class="variable language_">self</span>._set_to_l3(key, value)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_from_l1</span>(<span class="params">self, key: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        entry = <span class="variable language_">self</span>.l1_cache.get(key)</span><br><span class="line">        <span class="keyword">if</span> entry:</span><br><span class="line">            <span class="comment"># Check expiration</span></span><br><span class="line">            <span class="keyword">if</span> time.time() &lt; entry[<span class="string">&#x27;expires_at&#x27;</span>]:</span><br><span class="line">                <span class="keyword">return</span> entry[<span class="string">&#x27;data&#x27;</span>]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># Expired, remove from L1</span></span><br><span class="line">                <span class="keyword">del</span> <span class="variable language_">self</span>.l1_cache[key]</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_set_to_l1</span>(<span class="params">self, key: <span class="built_in">str</span>, value: <span class="built_in">dict</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># Implement LRU eviction if needed</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(<span class="variable language_">self</span>.l1_cache) &gt;= <span class="variable language_">self</span>.l1_max_size:</span><br><span class="line">            <span class="comment"># Remove oldest entry</span></span><br><span class="line">            oldest_key = <span class="built_in">min</span>(<span class="variable language_">self</span>.l1_cache.keys(), </span><br><span class="line">                           key=<span class="keyword">lambda</span> k: <span class="variable language_">self</span>.l1_cache[k][<span class="string">&#x27;created_at&#x27;</span>])</span><br><span class="line">            <span class="keyword">del</span> <span class="variable language_">self</span>.l1_cache[oldest_key]</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.l1_cache[key] = &#123;</span><br><span class="line">            <span class="string">&#x27;data&#x27;</span>: value,</span><br><span class="line">            <span class="string">&#x27;created_at&#x27;</span>: time.time(),</span><br><span class="line">            <span class="string">&#x27;expires_at&#x27;</span>: time.time() + <span class="variable language_">self</span>.l1_ttl</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_from_l2</span>(<span class="params">self, key: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cached_data = <span class="variable language_">self</span>.l2_redis.get(key)</span><br><span class="line">            <span class="keyword">return</span> json.loads(cached_data) <span class="keyword">if</span> cached_data <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_set_to_l2</span>(<span class="params">self, key: <span class="built_in">str</span>, value: <span class="built_in">dict</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>.l2_redis.setex(key, <span class="variable language_">self</span>.l2_ttl, json.dumps(value))</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span>  <span class="comment"># Fail silently, other levels available</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_from_l3</span>(<span class="params">self, key: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cached_data = <span class="variable language_">self</span>.l3_redis.get(key)</span><br><span class="line">            <span class="keyword">return</span> json.loads(cached_data) <span class="keyword">if</span> cached_data <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_set_to_l3</span>(<span class="params">self, key: <span class="built_in">str</span>, value: <span class="built_in">dict</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>.l3_redis.setex(key, <span class="variable language_">self</span>.l3_ttl, json.dumps(value))</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span>  <span class="comment"># Fail silently</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_cache_stats</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get statistics about cache performance&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;l1_size&#x27;</span>: <span class="built_in">len</span>(<span class="variable language_">self</span>.l1_cache),</span><br><span class="line">            <span class="string">&#x27;l1_max_size&#x27;</span>: <span class="variable language_">self</span>.l1_max_size,</span><br><span class="line">            <span class="string">&#x27;l2_available&#x27;</span>: <span class="variable language_">self</span>._is_redis_available(<span class="variable language_">self</span>.l2_redis),</span><br><span class="line">            <span class="string">&#x27;l3_available&#x27;</span>: <span class="variable language_">self</span>._is_redis_available(<span class="variable language_">self</span>.l3_redis)</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_is_redis_available</span>(<span class="params">self, redis_client</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            redis_client.ping()</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<h3 id="Solution-3-Circuit-Breaker-Pattern"><a href="#Solution-3-Circuit-Breaker-Pattern" class="headerlink" title="Solution 3: Circuit Breaker Pattern"></a>Solution 3: Circuit Breaker Pattern</h3><p>Implement circuit breaker to prevent cascade failures when cache is unavailable.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Callable</span>, <span class="type">Any</span></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CircuitState</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    CLOSED = <span class="string">&quot;closed&quot;</span>      <span class="comment"># Normal operation</span></span><br><span class="line">    OPEN = <span class="string">&quot;open&quot;</span>         <span class="comment"># Circuit tripped, fail fast</span></span><br><span class="line">    HALF_OPEN = <span class="string">&quot;half_open&quot;</span>  <span class="comment"># Testing if service recovered</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CircuitBreakerConfig</span>:</span><br><span class="line">    failure_threshold: <span class="built_in">int</span> = <span class="number">5</span></span><br><span class="line">    recovery_timeout: <span class="built_in">int</span> = <span class="number">60</span></span><br><span class="line">    success_threshold: <span class="built_in">int</span> = <span class="number">3</span></span><br><span class="line">    timeout: <span class="built_in">int</span> = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CircuitBreaker</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config: CircuitBreakerConfig</span>):</span><br><span class="line">        <span class="variable language_">self</span>.config = config</span><br><span class="line">        <span class="variable language_">self</span>.state = CircuitState.CLOSED</span><br><span class="line">        <span class="variable language_">self</span>.failure_count = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.success_count = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.last_failure_time = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.lock = threading.Lock()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">call</span>(<span class="params">self, func: <span class="type">Callable</span>, *args, **kwargs</span>) -&gt; <span class="type">Any</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="variable language_">self</span>.lock:</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.state == CircuitState.OPEN:</span><br><span class="line">                <span class="keyword">if</span> <span class="variable language_">self</span>._should_attempt_reset():</span><br><span class="line">                    <span class="variable language_">self</span>.state = CircuitState.HALF_OPEN</span><br><span class="line">                    <span class="variable language_">self</span>.success_count = <span class="number">0</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">raise</span> Exception(<span class="string">&quot;Circuit breaker is OPEN&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                result = func(*args, **kwargs)</span><br><span class="line">                <span class="variable language_">self</span>._on_success()</span><br><span class="line">                <span class="keyword">return</span> result</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="variable language_">self</span>._on_failure()</span><br><span class="line">                <span class="keyword">raise</span> e</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_should_attempt_reset</span>(<span class="params">self</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="keyword">return</span> time.time() - <span class="variable language_">self</span>.last_failure_time &gt;= <span class="variable language_">self</span>.config.recovery_timeout</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_on_success</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.state == CircuitState.HALF_OPEN:</span><br><span class="line">            <span class="variable language_">self</span>.success_count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.success_count &gt;= <span class="variable language_">self</span>.config.success_threshold:</span><br><span class="line">                <span class="variable language_">self</span>.state = CircuitState.CLOSED</span><br><span class="line">                <span class="variable language_">self</span>.failure_count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.failure_count = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_on_failure</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.failure_count += <span class="number">1</span></span><br><span class="line">        <span class="variable language_">self</span>.last_failure_time = time.time()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.failure_count &gt;= <span class="variable language_">self</span>.config.failure_threshold:</span><br><span class="line">            <span class="variable language_">self</span>.state = CircuitState.OPEN</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResilientCacheService</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.circuit_breaker = CircuitBreaker(CircuitBreakerConfig())</span><br><span class="line">        <span class="variable language_">self</span>.fallback_cache = &#123;&#125;  <span class="comment"># In-memory fallback</span></span><br><span class="line">        <span class="variable language_">self</span>.cache_ttl = <span class="number">3600</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, key: <span class="built_in">str</span>, data_loader: <span class="type">Callable</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># Try to get from Redis through circuit breaker</span></span><br><span class="line">            cached_data = <span class="variable language_">self</span>.circuit_breaker.call(<span class="variable language_">self</span>._redis_get, key)</span><br><span class="line">            <span class="keyword">if</span> cached_data:</span><br><span class="line">                <span class="comment"># Update fallback cache</span></span><br><span class="line">                <span class="variable language_">self</span>.fallback_cache[key] = &#123;</span><br><span class="line">                    <span class="string">&#x27;data&#x27;</span>: json.loads(cached_data),</span><br><span class="line">                    <span class="string">&#x27;timestamp&#x27;</span>: time.time()</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> json.loads(cached_data)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Redis unavailable: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Try fallback cache</span></span><br><span class="line">            fallback_entry = <span class="variable language_">self</span>.fallback_cache.get(key)</span><br><span class="line">            <span class="keyword">if</span> fallback_entry:</span><br><span class="line">                <span class="comment"># Check if fallback data is not too old</span></span><br><span class="line">                <span class="keyword">if</span> time.time() - fallback_entry[<span class="string">&#x27;timestamp&#x27;</span>] &lt; <span class="variable language_">self</span>.cache_ttl:</span><br><span class="line">                    <span class="keyword">return</span> fallback_entry[<span class="string">&#x27;data&#x27;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Load from data source</span></span><br><span class="line">        data = data_loader()</span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            <span class="comment"># Try to cache in Redis</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="variable language_">self</span>.circuit_breaker.call(<span class="variable language_">self</span>._redis_set, key, json.dumps(data))</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">pass</span>  <span class="comment"># Fail silently</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Always cache in fallback</span></span><br><span class="line">            <span class="variable language_">self</span>.fallback_cache[key] = &#123;</span><br><span class="line">                <span class="string">&#x27;data&#x27;</span>: data,</span><br><span class="line">                <span class="string">&#x27;timestamp&#x27;</span>: time.time()</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_redis_get</span>(<span class="params">self, key: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">bytes</span>]:</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.redis_client.get(key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_redis_set</span>(<span class="params">self, key: <span class="built_in">str</span>, value: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.redis_client.setex(key, <span class="variable language_">self</span>.cache_ttl, value)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_circuit_status</span>(<span class="params">self</span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;state&#x27;</span>: <span class="variable language_">self</span>.circuit_breaker.state.value,</span><br><span class="line">            <span class="string">&#x27;failure_count&#x27;</span>: <span class="variable language_">self</span>.circuit_breaker.failure_count,</span><br><span class="line">            <span class="string">&#x27;success_count&#x27;</span>: <span class="variable language_">self</span>.circuit_breaker.success_count</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>When discussing cache avalanche, emphasize that prevention is better than reaction. Randomized TTL is simple but effective, multi-level caching provides resilience, and circuit breakers prevent cascade failures. The key is having multiple strategies working together.</em></p>
<h2 id="Monitoring-and-Alerting"><a href="#Monitoring-and-Alerting" class="headerlink" title="Monitoring and Alerting"></a>Monitoring and Alerting</h2><p>Effective monitoring is crucial for detecting and responding to cache problems before they impact users.</p>
<h3 id="Key-Metrics-to-Monitor"><a href="#Key-Metrics-to-Monitor" class="headerlink" title="Key Metrics to Monitor"></a>Key Metrics to Monitor</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict, deque</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CacheMetrics</span>:</span><br><span class="line">    hits: <span class="built_in">int</span> = <span class="number">0</span></span><br><span class="line">    misses: <span class="built_in">int</span> = <span class="number">0</span></span><br><span class="line">    errors: <span class="built_in">int</span> = <span class="number">0</span></span><br><span class="line">    avg_response_time: <span class="built_in">float</span> = <span class="number">0.0</span></span><br><span class="line">    p95_response_time: <span class="built_in">float</span> = <span class="number">0.0</span></span><br><span class="line">    p99_response_time: <span class="built_in">float</span> = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CacheMonitor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, window_size: <span class="built_in">int</span> = <span class="number">300</span></span>):  <span class="comment"># 5 minute window</span></span><br><span class="line">        <span class="variable language_">self</span>.window_size = window_size</span><br><span class="line">        <span class="variable language_">self</span>.metrics = defaultdict(<span class="keyword">lambda</span>: CacheMetrics())</span><br><span class="line">        <span class="variable language_">self</span>.response_times = defaultdict(<span class="keyword">lambda</span>: deque(maxlen=<span class="number">1000</span>))</span><br><span class="line">        <span class="variable language_">self</span>.error_counts = defaultdict(<span class="built_in">int</span>)</span><br><span class="line">        <span class="variable language_">self</span>.lock = threading.Lock()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Start background thread for cleanup</span></span><br><span class="line">        <span class="variable language_">self</span>.cleanup_thread = threading.Thread(target=<span class="variable language_">self</span>._cleanup_old_metrics, daemon=<span class="literal">True</span>)</span><br><span class="line">        <span class="variable language_">self</span>.cleanup_thread.start()</span><br><span class="line">    </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserService</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">record_hit</span>(<span class="params">self, cache_key: <span class="built_in">str</span>, response_time: <span class="built_in">float</span></span>):</span><br><span class="line">        <span class="keyword">with</span> <span class="variable language_">self</span>.lock:</span><br><span class="line">            <span class="variable language_">self</span>.metrics[cache_key].hits += <span class="number">1</span></span><br><span class="line">            <span class="variable language_">self</span>.response_times[cache_key].append(response_time)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">record_miss</span>(<span class="params">self, cache_key: <span class="built_in">str</span>, response_time: <span class="built_in">float</span></span>):</span><br><span class="line">        <span class="keyword">with</span> <span class="variable language_">self</span>.lock:</span><br><span class="line">            <span class="variable language_">self</span>.metrics[cache_key].misses += <span class="number">1</span></span><br><span class="line">            <span class="variable language_">self</span>.response_times[cache_key].append(response_time)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">record_error</span>(<span class="params">self, cache_key: <span class="built_in">str</span>, error_type: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="keyword">with</span> <span class="variable language_">self</span>.lock:</span><br><span class="line">            <span class="variable language_">self</span>.metrics[cache_key].errors += <span class="number">1</span></span><br><span class="line">            <span class="variable language_">self</span>.error_counts[<span class="string">f&quot;<span class="subst">&#123;cache_key&#125;</span>:<span class="subst">&#123;error_type&#125;</span>&quot;</span>] += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_cache_hit_rate</span>(<span class="params">self, cache_key: <span class="built_in">str</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        metrics = <span class="variable language_">self</span>.metrics[cache_key]</span><br><span class="line">        total_requests = metrics.hits + metrics.misses</span><br><span class="line">        <span class="keyword">return</span> metrics.hits / total_requests <span class="keyword">if</span> total_requests &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0.0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_response_time_percentiles</span>(<span class="params">self, cache_key: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">float</span>]:</span><br><span class="line">        times = <span class="built_in">list</span>(<span class="variable language_">self</span>.response_times[cache_key])</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> times:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;p50&quot;</span>: <span class="number">0.0</span>, <span class="string">&quot;p95&quot;</span>: <span class="number">0.0</span>, <span class="string">&quot;p99&quot;</span>: <span class="number">0.0</span>&#125;</span><br><span class="line">        </span><br><span class="line">        times.sort()</span><br><span class="line">        n = <span class="built_in">len</span>(times)</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;p50&quot;</span>: times[<span class="built_in">int</span>(n * <span class="number">0.5</span>)] <span class="keyword">if</span> n &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0.0</span>,</span><br><span class="line">            <span class="string">&quot;p95&quot;</span>: times[<span class="built_in">int</span>(n * <span class="number">0.95</span>)] <span class="keyword">if</span> n &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0.0</span>,</span><br><span class="line">            <span class="string">&quot;p99&quot;</span>: times[<span class="built_in">int</span>(n * <span class="number">0.99</span>)] <span class="keyword">if</span> n &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0.0</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_alert_conditions</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        alerts = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> cache_key, metrics <span class="keyword">in</span> <span class="variable language_">self</span>.metrics.items():</span><br><span class="line">            hit_rate = <span class="variable language_">self</span>.get_cache_hit_rate(cache_key)</span><br><span class="line">            percentiles = <span class="variable language_">self</span>.get_response_time_percentiles(cache_key)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Low hit rate alert</span></span><br><span class="line">            <span class="keyword">if</span> hit_rate &lt; <span class="number">0.8</span> <span class="keyword">and</span> (metrics.hits + metrics.misses) &gt; <span class="number">100</span>:</span><br><span class="line">                alerts.append(&#123;</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;low_hit_rate&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;cache_key&quot;</span>: cache_key,</span><br><span class="line">                    <span class="string">&quot;hit_rate&quot;</span>: hit_rate,</span><br><span class="line">                    <span class="string">&quot;severity&quot;</span>: <span class="string">&quot;warning&quot;</span> <span class="keyword">if</span> hit_rate &gt; <span class="number">0.5</span> <span class="keyword">else</span> <span class="string">&quot;critical&quot;</span></span><br><span class="line">                &#125;)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># High error rate alert</span></span><br><span class="line">            total_ops = metrics.hits + metrics.misses + metrics.errors</span><br><span class="line">            error_rate = metrics.errors / total_ops <span class="keyword">if</span> total_ops &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> error_rate &gt; <span class="number">0.05</span>:  <span class="comment"># 5% error rate</span></span><br><span class="line">                alerts.append(&#123;</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;high_error_rate&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;cache_key&quot;</span>: cache_key,</span><br><span class="line">                    <span class="string">&quot;error_rate&quot;</span>: error_rate,</span><br><span class="line">                    <span class="string">&quot;severity&quot;</span>: <span class="string">&quot;critical&quot;</span></span><br><span class="line">                &#125;)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># High response time alert</span></span><br><span class="line">            <span class="keyword">if</span> percentiles[<span class="string">&quot;p95&quot;</span>] &gt; <span class="number">100</span>:  <span class="comment"># 100ms</span></span><br><span class="line">                alerts.append(&#123;</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;high_response_time&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;cache_key&quot;</span>: cache_key,</span><br><span class="line">                    <span class="string">&quot;p95_time&quot;</span>: percentiles[<span class="string">&quot;p95&quot;</span>],</span><br><span class="line">                    <span class="string">&quot;severity&quot;</span>: <span class="string">&quot;warning&quot;</span> <span class="keyword">if</span> percentiles[<span class="string">&quot;p95&quot;</span>] &lt; <span class="number">500</span> <span class="keyword">else</span> <span class="string">&quot;critical&quot;</span></span><br><span class="line">                &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> alerts</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_cleanup_old_metrics</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            time.sleep(<span class="number">60</span>)  <span class="comment"># Cleanup every minute</span></span><br><span class="line">            current_time = time.time()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">with</span> <span class="variable language_">self</span>.lock:</span><br><span class="line">                <span class="comment"># Remove old response times</span></span><br><span class="line">                <span class="keyword">for</span> key <span class="keyword">in</span> <span class="built_in">list</span>(<span class="variable language_">self</span>.response_times.keys()):</span><br><span class="line">                    times = <span class="variable language_">self</span>.response_times[key]</span><br><span class="line">                    <span class="comment"># Keep only recent times (implement time-based cleanup if needed)</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">len</span>(times) == <span class="number">0</span>:</span><br><span class="line">                        <span class="keyword">del</span> <span class="variable language_">self</span>.response_times[key]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Instrumented Cache Service</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MonitoredCacheService</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.monitor = CacheMonitor()</span><br><span class="line">        <span class="variable language_">self</span>.cache_ttl = <span class="number">3600</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, key: <span class="built_in">str</span>, data_loader: <span class="type">Callable</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        start_time = time.time()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># Try cache first</span></span><br><span class="line">            cached_data = <span class="variable language_">self</span>.redis_client.get(key)</span><br><span class="line">            response_time = (time.time() - start_time) * <span class="number">1000</span>  <span class="comment"># Convert to ms</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> cached_data:</span><br><span class="line">                <span class="variable language_">self</span>.monitor.record_hit(key, response_time)</span><br><span class="line">                <span class="keyword">return</span> json.loads(cached_data)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># Cache miss - load data</span></span><br><span class="line">                data = data_loader()</span><br><span class="line">                total_response_time = (time.time() - start_time) * <span class="number">1000</span></span><br><span class="line">                <span class="variable language_">self</span>.monitor.record_miss(key, total_response_time)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> data:</span><br><span class="line">                    <span class="comment"># Cache the result</span></span><br><span class="line">                    <span class="variable language_">self</span>.redis_client.setex(key, <span class="variable language_">self</span>.cache_ttl, json.dumps(data))</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> data</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            response_time = (time.time() - start_time) * <span class="number">1000</span></span><br><span class="line">            <span class="variable language_">self</span>.monitor.record_error(key, <span class="built_in">type</span>(e).__name__)</span><br><span class="line">            <span class="keyword">raise</span> e</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_monitoring_dashboard</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        alerts = <span class="variable language_">self</span>.monitor.get_alert_conditions()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Get top cache keys by usage</span></span><br><span class="line">        top_keys = []</span><br><span class="line">        <span class="keyword">for</span> cache_key, metrics <span class="keyword">in</span> <span class="variable language_">self</span>.monitor.metrics.items():</span><br><span class="line">            total_ops = metrics.hits + metrics.misses</span><br><span class="line">            <span class="keyword">if</span> total_ops &gt; <span class="number">0</span>:</span><br><span class="line">                top_keys.append(&#123;</span><br><span class="line">                    <span class="string">&quot;key&quot;</span>: cache_key,</span><br><span class="line">                    <span class="string">&quot;hit_rate&quot;</span>: <span class="variable language_">self</span>.monitor.get_cache_hit_rate(cache_key),</span><br><span class="line">                    <span class="string">&quot;total_operations&quot;</span>: total_ops,</span><br><span class="line">                    <span class="string">&quot;error_count&quot;</span>: metrics.errors,</span><br><span class="line">                    <span class="string">&quot;response_times&quot;</span>: <span class="variable language_">self</span>.monitor.get_response_time_percentiles(cache_key)</span><br><span class="line">                &#125;)</span><br><span class="line">        </span><br><span class="line">        top_keys.sort(key=<span class="keyword">lambda</span> x: x[<span class="string">&quot;total_operations&quot;</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;alerts&quot;</span>: alerts,</span><br><span class="line">            <span class="string">&quot;top_cache_keys&quot;</span>: top_keys[:<span class="number">10</span>],</span><br><span class="line">            <span class="string">&quot;total_alerts&quot;</span>: <span class="built_in">len</span>(alerts),</span><br><span class="line">            <span class="string">&quot;critical_alerts&quot;</span>: <span class="built_in">len</span>([a <span class="keyword">for</span> a <span class="keyword">in</span> alerts <span class="keyword">if</span> a[<span class="string">&quot;severity&quot;</span>] == <span class="string">&quot;critical&quot;</span>])</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Redis-Specific-Monitoring"><a href="#Redis-Specific-Monitoring" class="headerlink" title="Redis-Specific Monitoring"></a>Redis-Specific Monitoring</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">Any</span>, <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RedisMonitor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client: redis.Redis</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis_client</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_redis_info</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get comprehensive Redis information&quot;&quot;&quot;</span></span><br><span class="line">        info = <span class="variable language_">self</span>.redis.info()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;memory&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;used_memory&quot;</span>: info.get(<span class="string">&quot;used_memory&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;used_memory_human&quot;</span>: info.get(<span class="string">&quot;used_memory_human&quot;</span>, <span class="string">&quot;0B&quot;</span>),</span><br><span class="line">                <span class="string">&quot;used_memory_peak&quot;</span>: info.get(<span class="string">&quot;used_memory_peak&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;used_memory_peak_human&quot;</span>: info.get(<span class="string">&quot;used_memory_peak_human&quot;</span>, <span class="string">&quot;0B&quot;</span>),</span><br><span class="line">                <span class="string">&quot;memory_fragmentation_ratio&quot;</span>: info.get(<span class="string">&quot;mem_fragmentation_ratio&quot;</span>, <span class="number">0</span>),</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;performance&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;instantaneous_ops_per_sec&quot;</span>: info.get(<span class="string">&quot;instantaneous_ops_per_sec&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;total_commands_processed&quot;</span>: info.get(<span class="string">&quot;total_commands_processed&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;expired_keys&quot;</span>: info.get(<span class="string">&quot;expired_keys&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;evicted_keys&quot;</span>: info.get(<span class="string">&quot;evicted_keys&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;keyspace_hits&quot;</span>: info.get(<span class="string">&quot;keyspace_hits&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;keyspace_misses&quot;</span>: info.get(<span class="string">&quot;keyspace_misses&quot;</span>, <span class="number">0</span>),</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;connections&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;connected_clients&quot;</span>: info.get(<span class="string">&quot;connected_clients&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;client_longest_output_list&quot;</span>: info.get(<span class="string">&quot;client_longest_output_list&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;client_biggest_input_buf&quot;</span>: info.get(<span class="string">&quot;client_biggest_input_buf&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;blocked_clients&quot;</span>: info.get(<span class="string">&quot;blocked_clients&quot;</span>, <span class="number">0</span>),</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;persistence&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;rdb_changes_since_last_save&quot;</span>: info.get(<span class="string">&quot;rdb_changes_since_last_save&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;rdb_last_save_time&quot;</span>: info.get(<span class="string">&quot;rdb_last_save_time&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;rdb_last_bgsave_status&quot;</span>: info.get(<span class="string">&quot;rdb_last_bgsave_status&quot;</span>, <span class="string">&quot;unknown&quot;</span>),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_cache_hit_ratio</span>(<span class="params">self</span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Calculate overall cache hit ratio&quot;&quot;&quot;</span></span><br><span class="line">        info = <span class="variable language_">self</span>.redis.info()</span><br><span class="line">        hits = info.get(<span class="string">&quot;keyspace_hits&quot;</span>, <span class="number">0</span>)</span><br><span class="line">        misses = info.get(<span class="string">&quot;keyspace_misses&quot;</span>, <span class="number">0</span>)</span><br><span class="line">        total = hits + misses</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> hits / total <span class="keyword">if</span> total &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0.0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_memory_usage_alerts</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Check for memory-related issues&quot;&quot;&quot;</span></span><br><span class="line">        info = <span class="variable language_">self</span>.get_redis_info()</span><br><span class="line">        alerts = []</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Memory fragmentation alert</span></span><br><span class="line">        frag_ratio = info[<span class="string">&quot;memory&quot;</span>][<span class="string">&quot;memory_fragmentation_ratio&quot;</span>]</span><br><span class="line">        <span class="keyword">if</span> frag_ratio &gt; <span class="number">1.5</span>:</span><br><span class="line">            alerts.append(&#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;high_memory_fragmentation&quot;</span>,</span><br><span class="line">                <span class="string">&quot;value&quot;</span>: frag_ratio,</span><br><span class="line">                <span class="string">&quot;severity&quot;</span>: <span class="string">&quot;warning&quot;</span> <span class="keyword">if</span> frag_ratio &lt; <span class="number">2.0</span> <span class="keyword">else</span> <span class="string">&quot;critical&quot;</span>,</span><br><span class="line">                <span class="string">&quot;message&quot;</span>: <span class="string">f&quot;Memory fragmentation ratio is <span class="subst">&#123;frag_ratio:<span class="number">.2</span>f&#125;</span>&quot;</span></span><br><span class="line">            &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># High memory usage alert</span></span><br><span class="line">        used_memory = info[<span class="string">&quot;memory&quot;</span>][<span class="string">&quot;used_memory&quot;</span>]</span><br><span class="line">        <span class="comment"># Assuming max memory is configured</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            max_memory = <span class="variable language_">self</span>.redis.config_get(<span class="string">&quot;maxmemory&quot;</span>)[<span class="string">&quot;maxmemory&quot;</span>]</span><br><span class="line">            <span class="keyword">if</span> max_memory <span class="keyword">and</span> <span class="built_in">int</span>(max_memory) &gt; <span class="number">0</span>:</span><br><span class="line">                usage_ratio = used_memory / <span class="built_in">int</span>(max_memory)</span><br><span class="line">                <span class="keyword">if</span> usage_ratio &gt; <span class="number">0.8</span>:</span><br><span class="line">                    alerts.append(&#123;</span><br><span class="line">                        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;high_memory_usage&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;value&quot;</span>: usage_ratio,</span><br><span class="line">                        <span class="string">&quot;severity&quot;</span>: <span class="string">&quot;warning&quot;</span> <span class="keyword">if</span> usage_ratio &lt; <span class="number">0.9</span> <span class="keyword">else</span> <span class="string">&quot;critical&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;message&quot;</span>: <span class="string">f&quot;Memory usage is <span class="subst">&#123;usage_ratio:<span class="number">.1</span>%&#125;</span>&quot;</span></span><br><span class="line">                    &#125;)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Eviction alert</span></span><br><span class="line">        evicted_keys = info[<span class="string">&quot;performance&quot;</span>][<span class="string">&quot;evicted_keys&quot;</span>]</span><br><span class="line">        <span class="keyword">if</span> evicted_keys &gt; <span class="number">0</span>:</span><br><span class="line">            alerts.append(&#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;key_eviction&quot;</span>,</span><br><span class="line">                <span class="string">&quot;value&quot;</span>: evicted_keys,</span><br><span class="line">                <span class="string">&quot;severity&quot;</span>: <span class="string">&quot;warning&quot;</span>,</span><br><span class="line">                <span class="string">&quot;message&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;evicted_keys&#125;</span> keys have been evicted&quot;</span></span><br><span class="line">            &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> alerts</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_performance_metrics</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">float</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get key performance metrics&quot;&quot;&quot;</span></span><br><span class="line">        info = <span class="variable language_">self</span>.get_redis_info()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;ops_per_second&quot;</span>: info[<span class="string">&quot;performance&quot;</span>][<span class="string">&quot;instantaneous_ops_per_sec&quot;</span>],</span><br><span class="line">            <span class="string">&quot;cache_hit_ratio&quot;</span>: <span class="variable language_">self</span>.get_cache_hit_ratio(),</span><br><span class="line">            <span class="string">&quot;memory_fragmentation_ratio&quot;</span>: info[<span class="string">&quot;memory&quot;</span>][<span class="string">&quot;memory_fragmentation_ratio&quot;</span>],</span><br><span class="line">            <span class="string">&quot;connected_clients&quot;</span>: info[<span class="string">&quot;connections&quot;</span>][<span class="string">&quot;connected_clients&quot;</span>],</span><br><span class="line">            <span class="string">&quot;memory_usage_mb&quot;</span>: info[<span class="string">&quot;memory&quot;</span>][<span class="string">&quot;used_memory&quot;</span>] / (<span class="number">1024</span> * <span class="number">1024</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage Example</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setup_comprehensive_monitoring</span>():</span><br><span class="line">    redis_client = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">    cache_service = MonitoredCacheService()</span><br><span class="line">    redis_monitor = RedisMonitor(redis_client)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Simulate some cache operations</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_user_data</span>(<span class="params">user_id: <span class="built_in">int</span></span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">        time.sleep(<span class="number">0.01</span>)  <span class="comment"># Simulate DB query time</span></span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;id&quot;</span>: user_id, <span class="string">&quot;name&quot;</span>: <span class="string">f&quot;User <span class="subst">&#123;user_id&#125;</span>&quot;</span>&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Generate some metrics</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">        cache_service.get(<span class="string">f&quot;user:<span class="subst">&#123;i&#125;</span>&quot;</span>, <span class="keyword">lambda</span> uid=i: load_user_data(uid))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Get monitoring dashboard</span></span><br><span class="line">    dashboard = cache_service.get_monitoring_dashboard()</span><br><span class="line">    redis_metrics = redis_monitor.get_performance_metrics()</span><br><span class="line">    redis_alerts = redis_monitor.get_memory_usage_alerts()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;application_metrics&quot;</span>: dashboard,</span><br><span class="line">        <span class="string">&quot;redis_metrics&quot;</span>: redis_metrics,</span><br><span class="line">        <span class="string">&quot;redis_alerts&quot;</span>: redis_alerts</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Monitoring is often overlooked but critical. Mention specific metrics like hit rate, response time percentiles, error rates, and memory usage. Explain how you’d set up alerts and what thresholds you’d use. Show understanding of both application-level and Redis-specific monitoring.</em></p>
<h2 id="Best-Practices-Summary"><a href="#Best-Practices-Summary" class="headerlink" title="Best Practices Summary"></a>Best Practices Summary</h2><h3 id="1-Prevention-Strategies"><a href="#1-Prevention-Strategies" class="headerlink" title="1. Prevention Strategies"></a>1. Prevention Strategies</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Configuration best practices</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CacheConfig</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># TTL strategies</span></span><br><span class="line">        <span class="variable language_">self</span>.base_ttl = <span class="number">3600</span></span><br><span class="line">        <span class="variable language_">self</span>.jitter_percentage = <span class="number">0.2</span></span><br><span class="line">        <span class="variable language_">self</span>.short_ttl_for_nulls = <span class="number">60</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Capacity planning</span></span><br><span class="line">        <span class="variable language_">self</span>.max_memory_policy = <span class="string">&quot;allkeys-lru&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.memory_usage_threshold = <span class="number">0.8</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Performance tuning</span></span><br><span class="line">        <span class="variable language_">self</span>.connection_pool_size = <span class="number">50</span></span><br><span class="line">        <span class="variable language_">self</span>.socket_timeout = <span class="number">5</span></span><br><span class="line">        <span class="variable language_">self</span>.retry_attempts = <span class="number">3</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Security</span></span><br><span class="line">        <span class="variable language_">self</span>.enable_auth = <span class="literal">True</span></span><br><span class="line">        <span class="variable language_">self</span>.use_ssl = <span class="literal">True</span></span><br><span class="line">        <span class="variable language_">self</span>.bind_to_localhost = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Implementation of best practices</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProductionCacheService</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.config = CacheConfig()</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = <span class="variable language_">self</span>._create_redis_client()</span><br><span class="line">        <span class="variable language_">self</span>.monitor = CacheMonitor()</span><br><span class="line">        <span class="variable language_">self</span>.bloom_filter = BloomFilter(capacity=<span class="number">1000000</span>, error_rate=<span class="number">0.01</span>)</span><br><span class="line">        <span class="variable language_">self</span>.circuit_breaker = CircuitBreaker(CircuitBreakerConfig())</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_create_redis_client</span>(<span class="params">self</span>) -&gt; redis.Redis:</span><br><span class="line">        <span class="keyword">return</span> redis.Redis(</span><br><span class="line">            host=<span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">            port=<span class="number">6379</span>,</span><br><span class="line">            db=<span class="number">0</span>,</span><br><span class="line">            socket_timeout=<span class="variable language_">self</span>.config.socket_timeout,</span><br><span class="line">            retry_on_timeout=<span class="literal">True</span>,</span><br><span class="line">            health_check_interval=<span class="number">30</span>,</span><br><span class="line">            connection_pool=redis.ConnectionPool(</span><br><span class="line">                max_connections=<span class="variable language_">self</span>.config.connection_pool_size</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_with_all_protections</span>(<span class="params">self, key: <span class="built_in">str</span>, data_loader: <span class="type">Callable</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get with all cache problem protections enabled&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 1. Input validation</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>._validate_cache_key(key):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;Invalid cache key&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. Bloom filter check (prevents penetration)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.bloom_filter.contains(key):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. Circuit breaker protection (prevents avalanche)</span></span><br><span class="line">        start_time = time.time()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = <span class="variable language_">self</span>.circuit_breaker.call(<span class="variable language_">self</span>._get_with_breakdown_protection, key, data_loader)</span><br><span class="line">            response_time = (time.time() - start_time) * <span class="number">1000</span></span><br><span class="line">            <span class="variable language_">self</span>.monitor.record_hit(key, response_time)</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            response_time = (time.time() - start_time) * <span class="number">1000</span></span><br><span class="line">            <span class="variable language_">self</span>.monitor.record_error(key, <span class="built_in">type</span>(e).__name__)</span><br><span class="line">            <span class="keyword">raise</span> e</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_with_breakdown_protection</span>(<span class="params">self, key: <span class="built_in">str</span>, data_loader: <span class="type">Callable</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get with cache breakdown protection (distributed locking)&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Try cache first</span></span><br><span class="line">        cached_data = <span class="variable language_">self</span>.redis_client.get(key)</span><br><span class="line">        <span class="keyword">if</span> cached_data:</span><br><span class="line">            <span class="keyword">return</span> json.loads(cached_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Use distributed lock to prevent breakdown</span></span><br><span class="line">        lock = DistributedLock(<span class="variable language_">self</span>.redis_client, key, timeout=<span class="number">10</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> lock.acquire():</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># Double-check cache</span></span><br><span class="line">                cached_data = <span class="variable language_">self</span>.redis_client.get(key)</span><br><span class="line">                <span class="keyword">if</span> cached_data:</span><br><span class="line">                    <span class="keyword">return</span> json.loads(cached_data)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># Load data</span></span><br><span class="line">                data = data_loader()</span><br><span class="line">                <span class="keyword">if</span> data:</span><br><span class="line">                    <span class="comment"># Cache with randomized TTL (prevents avalanche)</span></span><br><span class="line">                    jitter = random.uniform(-<span class="variable language_">self</span>.config.jitter_percentage, <span class="variable language_">self</span>.config.jitter_percentage)</span><br><span class="line">                    ttl = <span class="built_in">int</span>(<span class="variable language_">self</span>.config.base_ttl * (<span class="number">1</span> + jitter))</span><br><span class="line">                    <span class="variable language_">self</span>.redis_client.setex(key, ttl, json.dumps(data))</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># Update bloom filter</span></span><br><span class="line">                    <span class="variable language_">self</span>.bloom_filter.add(key)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="comment"># Cache null result with short TTL (prevents penetration)</span></span><br><span class="line">                    <span class="variable language_">self</span>.redis_client.setex(key, <span class="variable language_">self</span>.config.short_ttl_for_nulls, <span class="string">&quot;NULL&quot;</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> data</span><br><span class="line">            <span class="keyword">finally</span>:</span><br><span class="line">                lock.release()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># Couldn&#x27;t acquire lock, try stale data or fallback</span></span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>._handle_lock_failure(key, data_loader)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_validate_cache_key</span>(<span class="params">self, key: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Validate cache key format and content&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> key <span class="keyword">or</span> <span class="built_in">len</span>(key) &gt; <span class="number">250</span>:  <span class="comment"># Redis key length limit</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Check for suspicious patterns</span></span><br><span class="line">        suspicious_patterns = [<span class="string">&#x27;..&#x27;</span>, <span class="string">&#x27;//&#x27;</span>, <span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;&lt;script&#x27;</span>, <span class="string">&#x27;javascript:&#x27;</span>]</span><br><span class="line">        <span class="keyword">for</span> pattern <span class="keyword">in</span> suspicious_patterns:</span><br><span class="line">            <span class="keyword">if</span> pattern <span class="keyword">in</span> key.lower():</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_handle_lock_failure</span>(<span class="params">self, key: <span class="built_in">str</span>, data_loader: <span class="type">Callable</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Handle case when distributed lock cannot be acquired&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Wait briefly and retry cache</span></span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        cached_data = <span class="variable language_">self</span>.redis_client.get(key)</span><br><span class="line">        <span class="keyword">if</span> cached_data <span class="keyword">and</span> cached_data != <span class="string">b&quot;NULL&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> json.loads(cached_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Fallback to direct database query</span></span><br><span class="line">        <span class="keyword">return</span> data_loader()</span><br></pre></td></tr></table></figure>

<h3 id="2-Operational-Excellence"><a href="#2-Operational-Excellence" class="headerlink" title="2. Operational Excellence"></a>2. Operational Excellence</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CacheOperations</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, cache_service: ProductionCacheService</span>):</span><br><span class="line">        <span class="variable language_">self</span>.cache_service = cache_service</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = cache_service.redis_client</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">warm_up_cache</span>(<span class="params">self, keys_to_warm: <span class="type">List</span>[<span class="built_in">str</span>], data_loader_map: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Callable</span>]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Warm up cache with critical data&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Warming up cache for <span class="subst">&#123;<span class="built_in">len</span>(keys_to_warm)&#125;</span> keys...&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> keys_to_warm:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> key <span class="keyword">in</span> data_loader_map:</span><br><span class="line">                    data = data_loader_map[key]()</span><br><span class="line">                    <span class="keyword">if</span> data:</span><br><span class="line">                        <span class="variable language_">self</span>.cache_service.set_with_jitter(key, data)</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f&quot;Warmed up: <span class="subst">&#123;key&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Failed to warm up <span class="subst">&#123;key&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">invalidate_pattern</span>(<span class="params">self, pattern: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Safely invalidate cache keys matching a pattern&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            keys = <span class="variable language_">self</span>.redis_client.keys(pattern)</span><br><span class="line">            <span class="keyword">if</span> keys:</span><br><span class="line">                pipeline = <span class="variable language_">self</span>.redis_client.pipeline()</span><br><span class="line">                <span class="keyword">for</span> key <span class="keyword">in</span> keys:</span><br><span class="line">                    pipeline.delete(key)</span><br><span class="line">                pipeline.execute()</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Invalidated <span class="subst">&#123;<span class="built_in">len</span>(keys)&#125;</span> keys matching pattern: <span class="subst">&#123;pattern&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Failed to invalidate pattern <span class="subst">&#123;pattern&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">export_cache_analytics</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Export cache analytics for analysis&quot;&quot;&quot;</span></span><br><span class="line">        info = <span class="variable language_">self</span>.redis_client.info()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;timestamp&quot;</span>: time.time(),</span><br><span class="line">            <span class="string">&quot;memory_usage&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;used_memory_mb&quot;</span>: info.get(<span class="string">&quot;used_memory&quot;</span>, <span class="number">0</span>) / (<span class="number">1024</span> * <span class="number">1024</span>),</span><br><span class="line">                <span class="string">&quot;peak_memory_mb&quot;</span>: info.get(<span class="string">&quot;used_memory_peak&quot;</span>, <span class="number">0</span>) / (<span class="number">1024</span> * <span class="number">1024</span>),</span><br><span class="line">                <span class="string">&quot;fragmentation_ratio&quot;</span>: info.get(<span class="string">&quot;mem_fragmentation_ratio&quot;</span>, <span class="number">0</span>)</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;performance&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;hit_rate&quot;</span>: <span class="variable language_">self</span>._calculate_hit_rate(info),</span><br><span class="line">                <span class="string">&quot;ops_per_second&quot;</span>: info.get(<span class="string">&quot;instantaneous_ops_per_sec&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;total_commands&quot;</span>: info.get(<span class="string">&quot;total_commands_processed&quot;</span>, <span class="number">0</span>)</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;issues&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;evicted_keys&quot;</span>: info.get(<span class="string">&quot;evicted_keys&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;expired_keys&quot;</span>: info.get(<span class="string">&quot;expired_keys&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;rejected_connections&quot;</span>: info.get(<span class="string">&quot;rejected_connections&quot;</span>, <span class="number">0</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_calculate_hit_rate</span>(<span class="params">self, info: <span class="type">Dict</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        hits = info.get(<span class="string">&quot;keyspace_hits&quot;</span>, <span class="number">0</span>)</span><br><span class="line">        misses = info.get(<span class="string">&quot;keyspace_misses&quot;</span>, <span class="number">0</span>)</span><br><span class="line">        total = hits + misses</span><br><span class="line">        <span class="keyword">return</span> hits / total <span class="keyword">if</span> total &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0.0</span></span><br></pre></td></tr></table></figure>

<h3 id="3-Interview-Questions-and-Answers"><a href="#3-Interview-Questions-and-Answers" class="headerlink" title="3. Interview Questions and Answers"></a>3. Interview Questions and Answers</h3><p><strong>Q: How would you handle a situation where your Redis instance is down?</strong></p>
<p><strong>A:</strong> I’d implement a multi-layered approach:</p>
<ol>
<li><strong>Circuit Breaker</strong>: Detect failures quickly and fail fast to prevent cascade failures</li>
<li><strong>Fallback Cache</strong>: Use in-memory cache or secondary Redis instance</li>
<li><strong>Graceful Degradation</strong>: Serve stale data when possible, direct database queries when necessary</li>
<li><strong>Health Checks</strong>: Implement proper health checks and automatic failover</li>
<li><strong>Monitoring</strong>: Set up alerts for Redis availability and performance metrics</li>
</ol>
<p><strong>Q: Explain the difference between cache penetration and cache breakdown.</strong></p>
<p><strong>A:</strong> </p>
<ul>
<li><strong>Cache Penetration</strong>: Queries for non-existent data bypass cache and hit database repeatedly. Solved by caching null values, bloom filters, or input validation.</li>
<li><strong>Cache Breakdown</strong>: Multiple concurrent requests try to rebuild the same expired cache entry simultaneously. Solved by distributed locking, logical expiration, or semaphores.</li>
</ul>
<p><strong>Q: How do you prevent cache avalanche in a high-traffic system?</strong></p>
<p><strong>A:</strong> Multiple strategies:</p>
<ol>
<li><strong>Randomized TTL</strong>: Add jitter to expiration times to prevent synchronized expiration</li>
<li><strong>Multi-level Caching</strong>: Use L1 (memory), L2 (Redis), L3 (backup) cache layers</li>
<li><strong>Circuit Breakers</strong>: Prevent cascade failures when cache is unavailable</li>
<li><strong>Gradual Rollouts</strong>: Stagger cache warming and deployments</li>
<li><strong>Monitoring</strong>: Proactive monitoring to detect issues early</li>
</ol>
<p><strong>Q: What metrics would you monitor for a Redis cache system?</strong></p>
<p><strong>A:</strong> Key metrics include:</p>
<ul>
<li><strong>Performance</strong>: Hit rate, miss rate, response time percentiles (p95, p99)</li>
<li><strong>Memory</strong>: Usage, fragmentation ratio, evicted keys</li>
<li><strong>Operations</strong>: Ops&#x2F;second, command distribution, slow queries</li>
<li><strong>Connectivity</strong>: Connected clients, rejected connections, network I&#x2F;O</li>
<li><strong>Persistence</strong>: RDB save status, AOF rewrite status</li>
<li><strong>Application</strong>: Error rates, cache penetration attempts, lock contention</li>
</ul>
<p><strong>Q: How would you design a cache system for a globally distributed application?</strong></p>
<p><strong>A:</strong> I’d consider:</p>
<ol>
<li><strong>Regional Clusters</strong>: Deploy Redis clusters in each region</li>
<li><strong>Consistency Strategy</strong>: Choose between strong consistency (slower) or eventual consistency (faster)</li>
<li><strong>Data Locality</strong>: Cache data close to where it’s consumed</li>
<li><strong>Cross-Region Replication</strong>: For critical shared data</li>
<li><strong>Intelligent Routing</strong>: Route requests to nearest available cache</li>
<li><strong>Conflict Resolution</strong>: Handle conflicts in distributed writes</li>
<li><strong>Monitoring</strong>: Global monitoring with regional dashboards</li>
</ol>
<p>This comprehensive approach demonstrates deep understanding of cache problems, practical solutions, and operational considerations that interviewers look for in senior engineers.</p>
<hr>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Cache problems like penetration, breakdown, and avalanche can severely impact system performance, but with proper understanding and implementation of solutions, they can be effectively mitigated. The key is to:</p>
<ol>
<li><strong>Understand the Problems</strong>: Know when and why each problem occurs</li>
<li><strong>Implement Multiple Solutions</strong>: Use layered approaches for robust protection</li>
<li><strong>Monitor Proactively</strong>: Set up comprehensive monitoring and alerting</li>
<li><strong>Plan for Failures</strong>: Design systems that gracefully handle cache failures</li>
<li><strong>Test Thoroughly</strong>: Validate your solutions under realistic load conditions</li>
</ol>
<p>Remember that cache optimization is an ongoing process that requires continuous monitoring, analysis, and improvement based on actual usage patterns and system behavior.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Charlie Feng</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
