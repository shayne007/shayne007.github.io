<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"shayne007.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="This place is for thinking and sharing.">
<meta property="og:type" content="website">
<meta property="og:title" content="Charlie Feng&#39;s Tech Space">
<meta property="og:url" content="https://shayne007.github.io/page/2/index.html">
<meta property="og:site_name" content="Charlie Feng&#39;s Tech Space">
<meta property="og:description" content="This place is for thinking and sharing.">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Charlie Feng">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://shayne007.github.io/page/2/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Charlie Feng's Tech Space</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"cdn":false,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.5.0/mermaid.min.js","integrity":"sha256-2obLuIPcceEhkE3G09G33hBdmE55ivVcZUlcKcGNHjU="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>





  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Charlie Feng's Tech Space</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">You will survive with skills</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Charlie Feng</p>
  <div class="site-description" itemprop="description">This place is for thinking and sharing.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/17/Redis-Data-Persistence-Mechanism/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/17/Redis-Data-Persistence-Mechanism/" class="post-title-link" itemprop="url">Redis Data Persistence Mechanism</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-17 20:36:04" itemprop="dateCreated datePublished" datetime="2025-06-17T20:36:04+08:00">2025-06-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-18 16:47:04" itemprop="dateModified" datetime="2025-06-18T16:47:04+08:00">2025-06-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Redis is an in-memory data structure store that provides multiple persistence mechanisms to ensure data durability. Understanding these mechanisms is crucial for building robust, production-ready applications.</p>
<h2 id="Core-Persistence-Mechanisms-Overview"><a href="#Core-Persistence-Mechanisms-Overview" class="headerlink" title="Core Persistence Mechanisms Overview"></a>Core Persistence Mechanisms Overview</h2><p>Redis offers three primary persistence strategies:</p>
<ul>
<li><strong>RDB (Redis Database)</strong>: Point-in-time snapshots</li>
<li><strong>AOF (Append Only File)</strong>: Command logging approach  </li>
<li><strong>Hybrid Mode</strong>: Combination of RDB and AOF for optimal performance and durability</li>
</ul>
<pre>
<code class="mermaid">

A[Redis Memory] --&gt; B{Persistence Strategy}
B --&gt; C[RDB Snapshots]
B --&gt; D[AOF Command Log]
B --&gt; E[Hybrid Mode]

C --&gt; F[Binary Snapshot Files]
D --&gt; G[Command History Files]
E --&gt; H[RDB + AOF Combined]

F --&gt; I[Fast Recovery&lt;br&#x2F;&gt;Larger Data Loss Window]
G --&gt; J[Minimal Data Loss&lt;br&#x2F;&gt;Slower Recovery]
H --&gt; K[Best of Both Worlds]
</code>
</pre>

<h2 id="RDB-Redis-Database-Snapshots"><a href="#RDB-Redis-Database-Snapshots" class="headerlink" title="RDB (Redis Database) Snapshots"></a>RDB (Redis Database) Snapshots</h2><h3 id="Mechanism-Deep-Dive"><a href="#Mechanism-Deep-Dive" class="headerlink" title="Mechanism Deep Dive"></a>Mechanism Deep Dive</h3><p>RDB creates point-in-time snapshots of your dataset at specified intervals. The process involves:</p>
<ol>
<li><strong>Fork Process</strong>: Redis forks a child process to handle snapshot creation</li>
<li><strong>Copy-on-Write</strong>: Leverages OS copy-on-write semantics for memory efficiency</li>
<li><strong>Binary Format</strong>: Creates compact binary files for fast loading</li>
<li><strong>Non-blocking</strong>: Main Redis process continues serving requests</li>
</ol>
<pre>
<code class="mermaid">

participant Client
participant Redis Main
participant Child Process
participant Disk

Client-&gt;&gt;Redis Main: Write Operations
Redis Main-&gt;&gt;Child Process: fork() for BGSAVE
Child Process-&gt;&gt;Disk: Write RDB snapshot
Redis Main-&gt;&gt;Client: Continue serving requests
Child Process-&gt;&gt;Redis Main: Snapshot complete
</code>
</pre>

<h3 id="Configuration-Examples"><a href="#Configuration-Examples" class="headerlink" title="Configuration Examples"></a>Configuration Examples</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Basic RDB configuration in redis.conf</span></span><br><span class="line">save 900 1      <span class="comment"># Save after 900 seconds if at least 1 key changed</span></span><br><span class="line">save 300 10     <span class="comment"># Save after 300 seconds if at least 10 keys changed  </span></span><br><span class="line">save 60 10000   <span class="comment"># Save after 60 seconds if at least 10000 keys changed</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># RDB file settings</span></span><br><span class="line">dbfilename dump.rdb</span><br><span class="line"><span class="built_in">dir</span> /var/lib/redis/</span><br><span class="line"></span><br><span class="line"><span class="comment"># Compression (recommended for production)</span></span><br><span class="line">rdbcompression <span class="built_in">yes</span></span><br><span class="line">rdbchecksum <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>

<h3 id="Manual-Snapshot-Commands"><a href="#Manual-Snapshot-Commands" class="headerlink" title="Manual Snapshot Commands"></a>Manual Snapshot Commands</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Synchronous save (blocks Redis)</span></span><br><span class="line">SAVE</span><br><span class="line"></span><br><span class="line"><span class="comment"># Background save (non-blocking, recommended)</span></span><br><span class="line">BGSAVE</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get last save timestamp</span></span><br><span class="line">LASTSAVE</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check if background save is in progress</span></span><br><span class="line">LASTSAVE</span><br></pre></td></tr></table></figure>

<h3 id="Production-Best-Practices"><a href="#Production-Best-Practices" class="headerlink" title="Production Best Practices"></a>Production Best Practices</h3><p><strong>Scheduling Strategy:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># High-frequency writes: More frequent snapshots</span></span><br><span class="line">save 300 10     <span class="comment"># 5 minutes if 10+ changes</span></span><br><span class="line">save 120 100    <span class="comment"># 2 minutes if 100+ changes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Low-frequency writes: Less frequent snapshots  </span></span><br><span class="line">save 900 1      <span class="comment"># 15 minutes if 1+ change</span></span><br><span class="line">save 1800 10    <span class="comment"># 30 minutes if 10+ changes</span></span><br></pre></td></tr></table></figure>

<p><strong>Real-world Use Case: E-commerce Session Store</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Session data with RDB configuration</span></span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line">r = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Store user session (will be included in next RDB snapshot)</span></span><br><span class="line">session_data = &#123;</span><br><span class="line">    <span class="string">&#x27;user_id&#x27;</span>: <span class="string">&#x27;12345&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;cart_items&#x27;</span>: [<span class="string">&#x27;item1&#x27;</span>, <span class="string">&#x27;item2&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;last_activity&#x27;</span>: <span class="string">&#x27;2024-01-15T10:30:00Z&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r.hset(<span class="string">&#x27;session:user:12345&#x27;</span>, mapping=session_data)</span><br><span class="line">r.expire(<span class="string">&#x27;session:user:12345&#x27;</span>, <span class="number">3600</span>)  <span class="comment"># 1 hour TTL</span></span><br></pre></td></tr></table></figure>

<h3 id="RDB-Advantages-and-Limitations"><a href="#RDB-Advantages-and-Limitations" class="headerlink" title="RDB Advantages and Limitations"></a>RDB Advantages and Limitations</h3><p><strong>Advantages:</strong></p>
<ul>
<li>Compact single-file backups</li>
<li>Fast Redis restart times</li>
<li>Good for disaster recovery</li>
<li>Minimal impact on performance</li>
<li>Perfect for backup strategies</li>
</ul>
<p><strong>Limitations:</strong></p>
<ul>
<li>Data loss potential between snapshots</li>
<li>Fork can be expensive with large datasets</li>
<li>Not suitable for minimal data loss requirements</li>
</ul>
<p><strong>💡 Interview Insight:</strong> “What happens if Redis crashes between RDB snapshots?”<br><em>Answer: All data written since the last snapshot is lost. This is why RDB alone isn’t suitable for applications requiring minimal data loss.</em></p>
<h2 id="AOF-Append-Only-File-Persistence"><a href="#AOF-Append-Only-File-Persistence" class="headerlink" title="AOF (Append Only File) Persistence"></a>AOF (Append Only File) Persistence</h2><h3 id="Mechanism-Deep-Dive-1"><a href="#Mechanism-Deep-Dive-1" class="headerlink" title="Mechanism Deep Dive"></a>Mechanism Deep Dive</h3><p>AOF logs every write operation received by the server, creating a reconstruction log of dataset operations.</p>
<pre>
<code class="mermaid">

A[Client Write] --&gt; B[Redis Memory]
B --&gt; C[AOF Buffer]
C --&gt; D{Sync Policy}
D --&gt; E[OS Buffer]
E --&gt; F[Disk Write]

D --&gt; G[always: Every Command]
D --&gt; H[everysec: Every Second]  
D --&gt; I[no: OS Decides]
</code>
</pre>

<h3 id="AOF-Configuration-Options"><a href="#AOF-Configuration-Options" class="headerlink" title="AOF Configuration Options"></a>AOF Configuration Options</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Enable AOF</span></span><br><span class="line">appendonly <span class="built_in">yes</span></span><br><span class="line">appendfilename <span class="string">&quot;appendonly.aof&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Sync policies</span></span><br><span class="line">appendfsync everysec    <span class="comment"># Recommended for most cases</span></span><br><span class="line"><span class="comment"># appendfsync always    # Maximum durability, slower performance</span></span><br><span class="line"><span class="comment"># appendfsync no        # Best performance, less durability</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># AOF rewrite configuration</span></span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line"></span><br><span class="line"><span class="comment"># Handle AOF corruption</span></span><br><span class="line">aof-load-truncated <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>

<h3 id="Sync-Policies-Comparison"><a href="#Sync-Policies-Comparison" class="headerlink" title="Sync Policies Comparison"></a>Sync Policies Comparison</h3><table>
<thead>
<tr>
<th>Policy</th>
<th>Durability</th>
<th>Performance</th>
<th>Data Loss Risk</th>
</tr>
</thead>
<tbody><tr>
<td><code>always</code></td>
<td>Highest</td>
<td>Slowest</td>
<td>~0 commands</td>
</tr>
<tr>
<td><code>everysec</code></td>
<td>Good</td>
<td>Balanced</td>
<td>~1 second</td>
</tr>
<tr>
<td><code>no</code></td>
<td>Lowest</td>
<td>Fastest</td>
<td>OS buffer size</td>
</tr>
</tbody></table>
<h3 id="AOF-Rewrite-Process"><a href="#AOF-Rewrite-Process" class="headerlink" title="AOF Rewrite Process"></a>AOF Rewrite Process</h3><p>AOF files grow over time, so Redis provides rewrite functionality to optimize file size:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Manual AOF rewrite</span></span><br><span class="line">BGREWRITEAOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check rewrite status</span></span><br><span class="line">INFO persistence</span><br></pre></td></tr></table></figure>

<p><strong>Rewrite Example:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Original AOF commands</span></span><br><span class="line">SET counter 1</span><br><span class="line">INCR counter    <span class="comment"># counter = 2</span></span><br><span class="line">INCR counter    <span class="comment"># counter = 3</span></span><br><span class="line">INCR counter    <span class="comment"># counter = 4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># After rewrite, simplified to:</span></span><br><span class="line">SET counter 4</span><br></pre></td></tr></table></figure>

<h3 id="Production-Configuration-Example"><a href="#Production-Configuration-Example" class="headerlink" title="Production Configuration Example"></a>Production Configuration Example</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Production AOF settings</span></span><br><span class="line">appendonly <span class="built_in">yes</span></span><br><span class="line">appendfilename <span class="string">&quot;appendonly.aof&quot;</span></span><br><span class="line">appendfsync everysec</span><br><span class="line"></span><br><span class="line"><span class="comment"># Automatic rewrite triggers</span></span><br><span class="line">auto-aof-rewrite-percentage 100    <span class="comment"># Rewrite when file doubles in size</span></span><br><span class="line">auto-aof-rewrite-min-size 64mb     <span class="comment"># Minimum size before considering rewrite</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Rewrite process settings</span></span><br><span class="line">no-appendfsync-on-rewrite no       <span class="comment"># Continue syncing during rewrite</span></span><br><span class="line">aof-rewrite-incremental-fsync <span class="built_in">yes</span>  <span class="comment"># Incremental fsync during rewrite</span></span><br></pre></td></tr></table></figure>

<h3 id="Real-world-Use-Case-Financial-Transaction-Log"><a href="#Real-world-Use-Case-Financial-Transaction-Log" class="headerlink" title="Real-world Use Case: Financial Transaction Log"></a>Real-world Use Case: Financial Transaction Log</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">r = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">log_transaction</span>(<span class="params">user_id, amount, transaction_type</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Log financial transaction with AOF persistence&quot;&quot;&quot;</span></span><br><span class="line">    transaction = &#123;</span><br><span class="line">        <span class="string">&#x27;user_id&#x27;</span>: user_id,</span><br><span class="line">        <span class="string">&#x27;amount&#x27;</span>: amount,</span><br><span class="line">        <span class="string">&#x27;type&#x27;</span>: transaction_type,</span><br><span class="line">        <span class="string">&#x27;timestamp&#x27;</span>: datetime.now().isoformat(),</span><br><span class="line">        <span class="string">&#x27;transaction_id&#x27;</span>: <span class="string">f&quot;txn_<span class="subst">&#123;user_id&#125;</span>_<span class="subst">&#123;<span class="built_in">int</span>(datetime.now().timestamp())&#125;</span>&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># This command will be logged in AOF</span></span><br><span class="line">    pipe = r.pipeline()</span><br><span class="line">    pipe.lpush(<span class="string">f&#x27;transactions:<span class="subst">&#123;user_id&#125;</span>&#x27;</span>, json.dumps(transaction))</span><br><span class="line">    pipe.incr(<span class="string">f&#x27;balance:<span class="subst">&#123;user_id&#125;</span>&#x27;</span>, amount <span class="keyword">if</span> transaction_type == <span class="string">&#x27;credit&#x27;</span> <span class="keyword">else</span> -amount)</span><br><span class="line">    pipe.execute()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> transaction</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage</span></span><br><span class="line">transaction = log_transaction(<span class="string">&#x27;user123&#x27;</span>, <span class="number">100.00</span>, <span class="string">&#x27;credit&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Transaction logged: <span class="subst">&#123;transaction&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>💡 Interview Insight:</strong> “How does AOF handle partial writes or corruption?”<br><em>Answer: Redis can handle truncated AOF files with <code>aof-load-truncated yes</code>. For corruption in the middle, tools like <code>redis-check-aof --fix</code> can repair the file.</em></p>
<h2 id="Hybrid-Persistence-Mode"><a href="#Hybrid-Persistence-Mode" class="headerlink" title="Hybrid Persistence Mode"></a>Hybrid Persistence Mode</h2><p>Hybrid mode combines RDB and AOF to leverage the benefits of both approaches.</p>
<h3 id="How-Hybrid-Mode-Works"><a href="#How-Hybrid-Mode-Works" class="headerlink" title="How Hybrid Mode Works"></a>How Hybrid Mode Works</h3><pre>
<code class="mermaid">

A[Redis Start] --&gt; B{Check for AOF}
B --&gt;|AOF exists| C[Load AOF file]
B --&gt;|No AOF| D[Load RDB file]

C --&gt; E[Runtime Operations]
D --&gt; E

E --&gt; F[RDB Snapshots]
E --&gt; G[AOF Command Logging]

F --&gt; H[Background Snapshots]
G --&gt; I[Continuous Command Log]

H --&gt; J[Fast Recovery Base]
I --&gt; K[Recent Changes]
</code>
</pre>

<h3 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Enable hybrid mode</span></span><br><span class="line">appendonly <span class="built_in">yes</span></span><br><span class="line">aof-use-rdb-preamble <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This creates AOF files with RDB preamble</span></span><br><span class="line"><span class="comment"># Format: [RDB snapshot][AOF commands since snapshot]</span></span><br></pre></td></tr></table></figure>

<h3 id="Hybrid-Mode-Benefits"><a href="#Hybrid-Mode-Benefits" class="headerlink" title="Hybrid Mode Benefits"></a>Hybrid Mode Benefits</h3><ol>
<li><strong>Fast Recovery</strong>: RDB portion loads quickly</li>
<li><strong>Minimal Data Loss</strong>: AOF portion captures recent changes</li>
<li><strong>Optimal File Size</strong>: RDB compression + incremental AOF</li>
<li><strong>Best of Both</strong>: Performance + durability</li>
</ol>
<h2 id="RDB-vs-AOF-vs-Hybrid-Comparison"><a href="#RDB-vs-AOF-vs-Hybrid-Comparison" class="headerlink" title="RDB vs AOF vs Hybrid Comparison"></a>RDB vs AOF vs Hybrid Comparison</h2><pre>
<code class="mermaid">

A[Persistence Requirements] --&gt; B{Priority?}

B --&gt;|Performance| C[RDB Only]
B --&gt;|Durability| D[AOF Only]
B --&gt;|Balanced| E[Hybrid Mode]

C --&gt; F[Fast restarts&lt;br&#x2F;&gt;Larger data loss window&lt;br&#x2F;&gt;Smaller files]
D --&gt; G[Minimal data loss&lt;br&#x2F;&gt;Slower restarts&lt;br&#x2F;&gt;Larger files]
E --&gt; H[Fast restarts&lt;br&#x2F;&gt;Minimal data loss&lt;br&#x2F;&gt;Optimal file size]
</code>
</pre>

<table>
<thead>
<tr>
<th>Aspect</th>
<th>RDB</th>
<th>AOF</th>
<th>Hybrid</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Recovery Speed</strong></td>
<td>Fast</td>
<td>Slow</td>
<td>Fast</td>
</tr>
<tr>
<td><strong>Data Loss Risk</strong></td>
<td>Higher</td>
<td>Lower</td>
<td>Lower</td>
</tr>
<tr>
<td><strong>File Size</strong></td>
<td>Smaller</td>
<td>Larger</td>
<td>Optimal</td>
</tr>
<tr>
<td><strong>CPU Impact</strong></td>
<td>Lower</td>
<td>Higher</td>
<td>Balanced</td>
</tr>
<tr>
<td><strong>Disk I&#x2F;O</strong></td>
<td>Periodic</td>
<td>Continuous</td>
<td>Balanced</td>
</tr>
<tr>
<td><strong>Backup Strategy</strong></td>
<td>Excellent</td>
<td>Good</td>
<td>Excellent</td>
</tr>
</tbody></table>
<h2 id="Production-Deployment-Strategies"><a href="#Production-Deployment-Strategies" class="headerlink" title="Production Deployment Strategies"></a>Production Deployment Strategies</h2><h3 id="High-Availability-Setup"><a href="#High-Availability-Setup" class="headerlink" title="High Availability Setup"></a>High Availability Setup</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Master node configuration</span></span><br><span class="line">appendonly <span class="built_in">yes</span></span><br><span class="line">aof-use-rdb-preamble <span class="built_in">yes</span></span><br><span class="line">appendfsync everysec</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line"></span><br><span class="line"><span class="comment"># Replica node configuration  </span></span><br><span class="line">replica-read-only <span class="built_in">yes</span></span><br><span class="line"><span class="comment"># Replicas automatically inherit persistence settings</span></span><br></pre></td></tr></table></figure>

<h3 id="Monitoring-and-Alerting"><a href="#Monitoring-and-Alerting" class="headerlink" title="Monitoring and Alerting"></a>Monitoring and Alerting</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_persistence_health</span>(<span class="params">redis_client</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Monitor Redis persistence health&quot;&quot;&quot;</span></span><br><span class="line">    info = redis_client.info(<span class="string">&#x27;persistence&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    checks = &#123;</span><br><span class="line">        <span class="string">&#x27;rdb_last_save_age&#x27;</span>: info.get(<span class="string">&#x27;rdb_changes_since_last_save&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">        <span class="string">&#x27;aof_enabled&#x27;</span>: info.get(<span class="string">&#x27;aof_enabled&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">        <span class="string">&#x27;aof_rewrite_in_progress&#x27;</span>: info.get(<span class="string">&#x27;aof_rewrite_in_progress&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">        <span class="string">&#x27;rdb_bgsave_in_progress&#x27;</span>: info.get(<span class="string">&#x27;rdb_bgsave_in_progress&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Alert if no save in 30 minutes and changes exist</span></span><br><span class="line">    <span class="keyword">if</span> checks[<span class="string">&#x27;rdb_last_save_age&#x27;</span>] &gt; <span class="number">0</span>:</span><br><span class="line">        last_save_time = info.get(<span class="string">&#x27;rdb_last_save_time&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">if</span> (time.time() - last_save_time) &gt; <span class="number">1800</span>:  <span class="comment"># 30 minutes</span></span><br><span class="line">            alert(<span class="string">&quot;RDB: No recent backup with pending changes&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> checks</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage</span></span><br><span class="line">r = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>)</span><br><span class="line">health = check_persistence_health(r)</span><br></pre></td></tr></table></figure>

<h3 id="Backup-Strategy-Implementation"><a href="#Backup-Strategy-Implementation" class="headerlink" title="Backup Strategy Implementation"></a>Backup Strategy Implementation</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Production backup script</span></span><br><span class="line"></span><br><span class="line">REDIS_CLI=<span class="string">&quot;/usr/bin/redis-cli&quot;</span></span><br><span class="line">BACKUP_DIR=<span class="string">&quot;/backup/redis&quot;</span></span><br><span class="line">DATE=$(<span class="built_in">date</span> +%Y%m%d_%H%M%S)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create backup directory</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$BACKUP_DIR</span>/<span class="variable">$DATE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Trigger background save</span></span><br><span class="line"><span class="variable">$REDIS_CLI</span> BGSAVE</span><br><span class="line"></span><br><span class="line"><span class="comment"># Wait for save to complete</span></span><br><span class="line"><span class="keyword">while</span> [ $(<span class="variable">$REDIS_CLI</span> LASTSAVE) -eq <span class="variable">$PREV_SAVE</span> ]; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">sleep</span> 1</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy files</span></span><br><span class="line"><span class="built_in">cp</span> /var/lib/redis/dump.rdb <span class="variable">$BACKUP_DIR</span>/<span class="variable">$DATE</span>/</span><br><span class="line"><span class="built_in">cp</span> /var/lib/redis/appendonly.aof <span class="variable">$BACKUP_DIR</span>/<span class="variable">$DATE</span>/</span><br><span class="line"></span><br><span class="line"><span class="comment"># Compress backup</span></span><br><span class="line">tar -czf <span class="variable">$BACKUP_DIR</span>/redis_backup_<span class="variable">$DATE</span>.tar.gz -C <span class="variable">$BACKUP_DIR</span>/<span class="variable">$DATE</span> .</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Backup completed: redis_backup_<span class="variable">$DATE</span>.tar.gz&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Disaster-Recovery-Procedures"><a href="#Disaster-Recovery-Procedures" class="headerlink" title="Disaster Recovery Procedures"></a>Disaster Recovery Procedures</h2><h3 id="Recovery-from-RDB"><a href="#Recovery-from-RDB" class="headerlink" title="Recovery from RDB"></a>Recovery from RDB</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. Stop Redis service</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl stop redis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Replace dump.rdb file</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> /backup/dump.rdb /var/lib/redis/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Set proper permissions</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span> redis:redis /var/lib/redis/dump.rdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. Start Redis service</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl start redis</span><br></pre></td></tr></table></figure>

<h3 id="Recovery-from-AOF"><a href="#Recovery-from-AOF" class="headerlink" title="Recovery from AOF"></a>Recovery from AOF</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. Check AOF integrity</span></span><br><span class="line">redis-check-aof appendonly.aof</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Fix if corrupted</span></span><br><span class="line">redis-check-aof --fix appendonly.aof</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Replace AOF file and restart Redis</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> /backup/appendonly.aof /var/lib/redis/</span><br><span class="line"><span class="built_in">sudo</span> systemctl restart redis</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Optimization"><a href="#Performance-Optimization" class="headerlink" title="Performance Optimization"></a>Performance Optimization</h2><h3 id="Memory-Optimization"><a href="#Memory-Optimization" class="headerlink" title="Memory Optimization"></a>Memory Optimization</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Optimize for memory usage</span></span><br><span class="line">rdbcompression <span class="built_in">yes</span></span><br><span class="line">rdbchecksum <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># AOF optimization</span></span><br><span class="line">aof-rewrite-incremental-fsync <span class="built_in">yes</span></span><br><span class="line">aof-load-truncated <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>

<h3 id="I-O-Optimization"><a href="#I-O-Optimization" class="headerlink" title="I&#x2F;O Optimization"></a>I&#x2F;O Optimization</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Separate data and AOF on different disks</span></span><br><span class="line"><span class="built_in">dir</span> /data/redis/snapshots/</span><br><span class="line">appenddirname /logs/redis/aof/</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use faster storage for AOF</span></span><br><span class="line"><span class="comment"># SSD recommended for AOF files</span></span><br></pre></td></tr></table></figure>

<h2 id="Common-Issues-and-Troubleshooting"><a href="#Common-Issues-and-Troubleshooting" class="headerlink" title="Common Issues and Troubleshooting"></a>Common Issues and Troubleshooting</h2><h3 id="Fork-Failures"><a href="#Fork-Failures" class="headerlink" title="Fork Failures"></a>Fork Failures</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Monitor fork issues</span></span><br><span class="line">INFO stats | grep fork</span><br><span class="line"></span><br><span class="line"><span class="comment"># Common solutions:</span></span><br><span class="line"><span class="comment"># 1. Increase vm.overcommit_memory</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;vm.overcommit_memory = 1&#x27;</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Monitor memory usage</span></span><br><span class="line"><span class="comment"># 3. Consider using smaller save intervals</span></span><br></pre></td></tr></table></figure>

<h3 id="AOF-Growing-Too-Large"><a href="#AOF-Growing-Too-Large" class="headerlink" title="AOF Growing Too Large"></a>AOF Growing Too Large</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Monitor AOF size</span></span><br><span class="line">INFO persistence | grep aof_current_size</span><br><span class="line"></span><br><span class="line"><span class="comment"># Solutions:</span></span><br><span class="line"><span class="comment"># 1. Adjust rewrite thresholds</span></span><br><span class="line">auto-aof-rewrite-percentage 50</span><br><span class="line">auto-aof-rewrite-min-size 32mb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Manual rewrite during low traffic</span></span><br><span class="line">BGREWRITEAOF</span><br></pre></td></tr></table></figure>

<h2 id="Key-Interview-Questions-and-Answers"><a href="#Key-Interview-Questions-and-Answers" class="headerlink" title="Key Interview Questions and Answers"></a>Key Interview Questions and Answers</h2><p><strong>Q: When would you choose RDB over AOF?</strong><br>A: Choose RDB when you can tolerate some data loss (5-15 minutes) in exchange for better performance, smaller backup files, and faster Redis restarts. Ideal for caching scenarios, analytics data, or when you have other data durability mechanisms.</p>
<p><strong>Q: Explain the AOF rewrite process and why it’s needed.</strong><br>A: AOF files grow indefinitely as they log every write command. Rewrite compacts the file by analyzing the current dataset state and generating the minimum set of commands needed to recreate it. This happens in a child process to avoid blocking the main Redis instance.</p>
<p><strong>Q: What’s the risk of using <code>appendfsync always</code>?</strong><br>A: While it provides maximum durability (virtually zero data loss), it significantly impacts performance as Redis must wait for each write to be committed to disk before acknowledging the client. This can reduce throughput by 100x compared to <code>everysec</code>.</p>
<p><strong>Q: How does hybrid persistence work during recovery?</strong><br>A: Redis first loads the RDB portion (fast bulk recovery), then replays the AOF commands that occurred after the RDB snapshot (recent changes). This provides both fast startup and minimal data loss.</p>
<p><strong>Q: What happens if both RDB and AOF are corrupted?</strong><br>A: Redis will fail to start. You’d need to either fix the files using <code>redis-check-rdb</code> and <code>redis-check-aof</code>, restore from backups, or start with an empty dataset. This highlights the importance of having multiple backup strategies and monitoring persistence health.</p>
<h2 id="Best-Practices-Summary"><a href="#Best-Practices-Summary" class="headerlink" title="Best Practices Summary"></a>Best Practices Summary</h2><ol>
<li><strong>Use Hybrid Mode</strong> for production systems requiring both performance and durability</li>
<li><strong>Monitor Persistence Health</strong> with automated alerts for failed saves or growing files</li>
<li><strong>Implement Regular Backups</strong> with both local and remote storage</li>
<li><strong>Test Recovery Procedures</strong> regularly in non-production environments</li>
<li><strong>Size Your Infrastructure</strong> appropriately for fork operations and I&#x2F;O requirements</li>
<li><strong>Separate Storage</strong> for RDB snapshots and AOF files when possible</li>
<li><strong>Tune Based on Use Case</strong>: More frequent saves for critical data, less frequent for cache-only scenarios</li>
</ol>
<p>Understanding Redis persistence mechanisms is crucial for building reliable systems. The choice between RDB, AOF, or hybrid mode should align with your application’s durability requirements, performance constraints, and operational capabilities.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/17/Java-Virtual-Machine-Memory-Structure-Complete-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/17/Java-Virtual-Machine-Memory-Structure-Complete-Guide/" class="post-title-link" itemprop="url">Java Virtual Machine Memory Structure - Complete Guide</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-17 18:56:24 / Modified: 20:26:28" itemprop="dateCreated datePublished" datetime="2025-06-17T18:56:24+08:00">2025-06-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="JVM-Architecture-Overview"><a href="#JVM-Architecture-Overview" class="headerlink" title="JVM Architecture Overview"></a>JVM Architecture Overview</h2><p>The Java Virtual Machine (JVM) is a runtime environment that executes Java bytecode. Understanding its memory structure is crucial for writing efficient, scalable applications and troubleshooting performance issues in production environments.</p>
<pre>
<code class="mermaid">
graph TB
A[Java Source Code] --&gt; B[javac Compiler]
B --&gt; C[Bytecode .class files]
C --&gt; D[Class Loader Subsystem]
D --&gt; E[Runtime Data Areas]
D --&gt; F[Execution Engine]
E --&gt; G[Method Area]
E --&gt; H[Heap Memory]
E --&gt; I[Stack Memory]
E --&gt; J[PC Registers]
E --&gt; K[Native Method Stacks]
F --&gt; L[Interpreter]
F --&gt; M[JIT Compiler]
F --&gt; N[Garbage Collector]
</code>
</pre>

<h3 id="Core-JVM-Components"><a href="#Core-JVM-Components" class="headerlink" title="Core JVM Components"></a>Core JVM Components</h3><p>The JVM consists of three main subsystems that work together:</p>
<p><strong>Class Loader Subsystem</strong>: Responsible for loading, linking, and initializing classes dynamically at runtime. This subsystem implements the crucial parent delegation model that ensures class uniqueness and security.</p>
<p><strong>Runtime Data Areas</strong>: Memory regions where the JVM stores various types of data during program execution. These include heap memory for objects, method area for class metadata, stack memory for method calls, and other specialized regions.</p>
<p><strong>Execution Engine</strong>: Converts bytecode into machine code through interpretation and Just-In-Time (JIT) compilation. It also manages garbage collection to reclaim unused memory.</p>
<p><strong>Interview Insight</strong>: <em>A common question is “Explain how JVM components interact when executing a Java program.” Be prepared to walk through the complete flow from source code to execution.</em></p>
<hr>
<h2 id="Class-Loader-Subsystem-Deep-Dive"><a href="#Class-Loader-Subsystem-Deep-Dive" class="headerlink" title="Class Loader Subsystem Deep Dive"></a>Class Loader Subsystem Deep Dive</h2><h3 id="Class-Loader-Hierarchy-and-Types"><a href="#Class-Loader-Hierarchy-and-Types" class="headerlink" title="Class Loader Hierarchy and Types"></a>Class Loader Hierarchy and Types</h3><p>The class loading mechanism follows a hierarchical structure with three built-in class loaders:</p>
<pre>
<code class="mermaid">
graph TD
A[Bootstrap Class Loader] --&gt; B[Extension Class Loader]
B --&gt; C[Application Class Loader]
C --&gt; D[Custom Class Loaders]

A1[rt.jar, core JDK classes] --&gt; A
B1[ext directory, JAVA_HOME&#x2F;lib&#x2F;ext] --&gt; B
C1[Classpath, application classes] --&gt; C
D1[Web apps, plugins, frameworks] --&gt; D
</code>
</pre>

<p><strong>Bootstrap Class Loader (Primordial)</strong>:</p>
<ul>
<li>Written in native code (C&#x2F;C++)</li>
<li>Loads core Java classes from <code>rt.jar</code> and other core JDK libraries</li>
<li>Parent of all other class loaders</li>
<li>Cannot be instantiated in Java code</li>
</ul>
<p><strong>Extension Class Loader (Platform)</strong>:</p>
<ul>
<li>Loads classes from extension directories (<code>JAVA_HOME/lib/ext</code>)</li>
<li>Implements standard extensions to the Java platform</li>
<li>Child of Bootstrap Class Loader</li>
</ul>
<p><strong>Application Class Loader (System)</strong>:</p>
<ul>
<li>Loads classes from the application classpath</li>
<li>Most commonly used class loader</li>
<li>Child of Extension Class Loader</li>
</ul>
<h3 id="Parent-Delegation-Model"><a href="#Parent-Delegation-Model" class="headerlink" title="Parent Delegation Model"></a>Parent Delegation Model</h3><p>The parent delegation model is a security and consistency mechanism that ensures classes are loaded predictably.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Simplified implementation of parent delegation</span></span><br><span class="line"><span class="keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// First, check if the class has already been loaded</span></span><br><span class="line">    Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (parent != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Delegate to parent class loader</span></span><br><span class="line">                c = parent.loadClass(name);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Use bootstrap class loader</span></span><br><span class="line">                c = findBootstrapClassOrNull(name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="comment">// Parent failed to load class</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (c == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Find the class ourselves</span></span><br><span class="line">            c = findClass(name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Key Benefits of Parent Delegation</strong>:</p>
<ol>
<li><strong>Security</strong>: Prevents malicious code from replacing core Java classes</li>
<li><strong>Consistency</strong>: Ensures the same class is not loaded multiple times</li>
<li><strong>Namespace Isolation</strong>: Different class loaders can load classes with the same name</li>
</ol>
<p><strong>Interview Insight</strong>: <em>Understand why <code>java.lang.String</code> cannot be overridden even if you create your own String class in the default package.</em></p>
<h3 id="Class-Loading-Process-The-Five-Phases"><a href="#Class-Loading-Process-The-Five-Phases" class="headerlink" title="Class Loading Process - The Five Phases"></a>Class Loading Process - The Five Phases</h3><pre>
<code class="mermaid">
flowchart LR
A[Loading] --&gt; B[Verification]
B --&gt; C[Preparation]
C --&gt; D[Resolution]
D --&gt; E[Initialization]

A1[Find and load .class file] --&gt; A
B1[Verify bytecode integrity] --&gt; B
C1[Allocate memory for static variables] --&gt; C
D1[Resolve symbolic references] --&gt; D
E1[Execute static initializers] --&gt; E
</code>
</pre>

<h4 id="Loading-Phase"><a href="#Loading-Phase" class="headerlink" title="Loading Phase"></a>Loading Phase</h4><p>The JVM locates and reads the <code>.class</code> file, creating a binary representation in memory.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassLoadingExample</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Class is being loaded and initialized&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONSTANT</span> <span class="operator">=</span> <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">incrementCounter</span><span class="params">()</span> &#123;</span><br><span class="line">        counter++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Verification-Phase"><a href="#Verification-Phase" class="headerlink" title="Verification Phase"></a>Verification Phase</h4><p>The JVM verifies that the bytecode is valid and doesn’t violate security constraints:</p>
<ul>
<li><strong>File format verification</strong>: Ensures proper <code>.class</code> file structure</li>
<li><strong>Metadata verification</strong>: Validates class hierarchy and access modifiers</li>
<li><strong>Bytecode verification</strong>: Ensures operations are type-safe</li>
<li><strong>Symbolic reference verification</strong>: Validates method and field references</li>
</ul>
<h4 id="Preparation-Phase"><a href="#Preparation-Phase" class="headerlink" title="Preparation Phase"></a>Preparation Phase</h4><p>Memory is allocated for class-level (static) variables and initialized with default values:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PreparationExample</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> number;        <span class="comment">// Initialized to 0</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> flag;      <span class="comment">// Initialized to false</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String text;       <span class="comment">// Initialized to null</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CONSTANT</span> <span class="operator">=</span> <span class="number">100</span>; <span class="comment">// Initialized to 100 (final)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Resolution-Phase"><a href="#Resolution-Phase" class="headerlink" title="Resolution Phase"></a>Resolution Phase</h4><p>Symbolic references in the constant pool are replaced with direct references:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResolutionExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">methodA</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Symbolic reference to methodB is resolved to a direct reference</span></span><br><span class="line">        methodB();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">methodB</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Method B executed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Initialization-Phase"><a href="#Initialization-Phase" class="headerlink" title="Initialization Phase"></a>Initialization Phase</h4><p>Static initializers and static variable assignments are executed:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InitializationExample</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> initializeValue(); <span class="comment">// Called during initialization</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Static block executed&quot;</span>);</span><br><span class="line">        value += <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">initializeValue</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Static method called&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Be able to explain the difference between class loading and class initialization, and when each phase occurs.</em></p>
<hr>
<h2 id="Runtime-Data-Areas"><a href="#Runtime-Data-Areas" class="headerlink" title="Runtime Data Areas"></a>Runtime Data Areas</h2><p>The JVM organizes memory into distinct regions, each serving specific purposes during program execution.</p>
<pre>
<code class="mermaid">
graph TB
subgraph &quot;JVM Memory Structure&quot;
    subgraph &quot;Shared Among All Threads&quot;
        A[Method Area]
        B[Heap Memory]
        A1[Class metadata, Constants, Static variables] --&gt; A
        B1[Objects, Instance variables, Arrays] --&gt; B
    end
    
    subgraph &quot;Per Thread&quot;
        C[JVM Stack]
        D[PC Register]
        E[Native Method Stack]
        C1[Method frames, Local variables, Operand stack] --&gt; C
        D1[Current executing instruction address] --&gt; D
        E1[Native method calls] --&gt; E
    end
end
</code>
</pre>

<h3 id="Method-Area-Metaspace-in-Java-8"><a href="#Method-Area-Metaspace-in-Java-8" class="headerlink" title="Method Area (Metaspace in Java 8+)"></a>Method Area (Metaspace in Java 8+)</h3><p>The Method Area stores class-level information shared across all threads:</p>
<p><strong>Contents</strong>:</p>
<ul>
<li>Class metadata and structure information</li>
<li>Method bytecode</li>
<li>Constant pool</li>
<li>Static variables</li>
<li>Runtime constant pool</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MethodAreaExample</span> &#123;</span><br><span class="line">    <span class="comment">// Stored in Method Area</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONSTANT</span> <span class="operator">=</span> <span class="string">&quot;Stored in constant pool&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">staticVariable</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Method bytecode stored in Method Area</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">instanceMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Method implementation</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">staticMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Static method implementation</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Production Best Practice</strong>: Monitor Metaspace usage in Java 8+ applications, as it can lead to <code>OutOfMemoryError: Metaspace</code> if too many classes are loaded dynamically.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># JVM flags for Metaspace tuning</span></span><br><span class="line">-XX:MetaspaceSize=256m</span><br><span class="line">-XX:MaxMetaspaceSize=512m</span><br><span class="line">-XX:+UseCompressedOops</span><br></pre></td></tr></table></figure>

<h3 id="Heap-Memory-Structure"><a href="#Heap-Memory-Structure" class="headerlink" title="Heap Memory Structure"></a>Heap Memory Structure</h3><p>The heap is where all objects and instance variables are stored. Modern JVMs typically implement generational garbage collection.</p>
<pre>
<code class="mermaid">
graph TB
subgraph &quot;Heap Memory&quot;
    subgraph &quot;Young Generation&quot;
        A[Eden Space]
        B[Survivor Space 0]
        C[Survivor Space 1]
    end
    
    subgraph &quot;Old Generation&quot;
        D[Tenured Space]
    end
    
    E[Permanent Generation &#x2F; Metaspace]
end

F[New Objects] --&gt; A
A --&gt; |GC| B
B --&gt; |GC| C
C --&gt; |Long-lived objects| D
</code>
</pre>

<p><strong>Object Lifecycle Example</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HeapMemoryExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// Objects created in Eden space</span></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// These objects may survive minor GC and move to Survivor space</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            list.add(<span class="string">&quot;String &quot;</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Long-lived objects eventually move to Old Generation</span></span><br><span class="line">        staticReference = list; <span class="comment">// This reference keeps the list alive</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; staticReference;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Production Tuning Example</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Heap size configuration</span></span><br><span class="line">-Xms2g -Xmx4g</span><br><span class="line"><span class="comment"># Young generation sizing</span></span><br><span class="line">-XX:NewRatio=3</span><br><span class="line">-XX:SurvivorRatio=8</span><br><span class="line"><span class="comment"># GC algorithm selection</span></span><br><span class="line">-XX:+UseG1GC</span><br><span class="line">-XX:MaxGCPauseMillis=200</span><br></pre></td></tr></table></figure>

<h3 id="JVM-Stack-Thread-Stack"><a href="#JVM-Stack-Thread-Stack" class="headerlink" title="JVM Stack (Thread Stack)"></a>JVM Stack (Thread Stack)</h3><p>Each thread has its own stack containing method call frames.</p>
<pre>
<code class="mermaid">
graph TB
subgraph &quot;Thread Stack&quot;
    A[Method Frame 3 - currentMethod]
    B[Method Frame 2 - callerMethod]
    C[Method Frame 1 - main]
end

subgraph &quot;Method Frame Structure&quot;
    D[Local Variables Array]
    E[Operand Stack]
    F[Frame Data]
end

A --&gt; D
A --&gt; E
A --&gt; F
</code>
</pre>

<p><strong>Stack Frame Components</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StackExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123; <span class="comment">// Frame 1</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">mainVar</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">        methodA(mainVar);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">methodA</span><span class="params">(<span class="type">int</span> param)</span> &#123; <span class="comment">// Frame 2</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">localVar</span> <span class="operator">=</span> param * <span class="number">2</span>;</span><br><span class="line">        methodB(localVar);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">methodB</span><span class="params">(<span class="type">int</span> value)</span> &#123; <span class="comment">// Frame 3</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Value: &quot;</span> + value);</span><br><span class="line">        <span class="comment">// Stack trace shows: methodB -&gt; methodA -&gt; main</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Understand how method calls create stack frames and how local variables are stored versus instance variables in the heap.</em></p>
<hr>
<h2 id="Breaking-Parent-Delegation-Advanced-Scenarios"><a href="#Breaking-Parent-Delegation-Advanced-Scenarios" class="headerlink" title="Breaking Parent Delegation - Advanced Scenarios"></a>Breaking Parent Delegation - Advanced Scenarios</h2><h3 id="When-and-Why-to-Break-Parent-Delegation"><a href="#When-and-Why-to-Break-Parent-Delegation" class="headerlink" title="When and Why to Break Parent Delegation"></a>When and Why to Break Parent Delegation</h3><p>While parent delegation is generally beneficial, certain scenarios require custom class loading strategies:</p>
<ol>
<li><strong>Web Application Containers</strong> (Tomcat, Jetty)</li>
<li><strong>Plugin Architectures</strong> </li>
<li><strong>Hot Deployment</strong> scenarios</li>
<li><strong>Framework Isolation</strong> requirements</li>
</ol>
<h3 id="Tomcat’s-Class-Loading-Architecture"><a href="#Tomcat’s-Class-Loading-Architecture" class="headerlink" title="Tomcat’s Class Loading Architecture"></a>Tomcat’s Class Loading Architecture</h3><p>Tomcat implements a sophisticated class loading hierarchy to support multiple web applications with potentially conflicting dependencies.</p>
<pre>
<code class="mermaid">
graph TB
A[Bootstrap] --&gt; B[System]
B --&gt; C[Common]
C --&gt; D[Catalina]
C --&gt; E[Shared]
E --&gt; F[WebApp1]
E --&gt; G[WebApp2]

A1[JDK core classes] --&gt; A
B1[JVM system classes] --&gt; B
C1[Tomcat common classes] --&gt; C
D1[Tomcat internal classes] --&gt; D
E1[Shared libraries] --&gt; E
F1[Application 1 classes] --&gt; F
G1[Application 2 classes] --&gt; G
</code>
</pre>

<p><strong>Tomcat’s Modified Delegation Model</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebappClassLoader</span> <span class="keyword">extends</span> <span class="title class_">URLClassLoader</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">return</span> loadClass(name, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; loadClass(String name, <span class="type">boolean</span> resolve) </span><br><span class="line">            <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        </span><br><span class="line">        Class&lt;?&gt; clazz = <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. Check the local cache first</span></span><br><span class="line">        clazz = findLoadedClass(name);</span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. Check if the class should be loaded by the parent (system classes)</span></span><br><span class="line">        <span class="keyword">if</span> (isSystemClass(name)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.loadClass(name, resolve);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. Try to load from the web application first (breaking delegation!)</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clazz = findClass(name);</span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="comment">// Fall through to parent delegation</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. Delegate to the parent as a last resort</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.loadClass(name, resolve);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Custom-Class-Loader-Implementation"><a href="#Custom-Class-Loader-Implementation" class="headerlink" title="Custom Class Loader Implementation"></a>Custom Class Loader Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomClassLoader</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String classPath;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomClassLoader</span><span class="params">(String classPath, ClassLoader parent)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(parent);</span><br><span class="line">        <span class="built_in">this</span>.classPath = classPath;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[] classData = loadClassData(name);</span><br><span class="line">            <span class="keyword">return</span> defineClass(name, classData, <span class="number">0</span>, classData.length);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(<span class="string">&quot;Could not load class &quot;</span> + name, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>[] loadClassData(String className) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> className.replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>) + <span class="string">&quot;.class&quot;</span>;</span><br><span class="line">        <span class="type">Path</span> <span class="variable">filePath</span> <span class="operator">=</span> Paths.get(classPath, fileName);</span><br><span class="line">        <span class="keyword">return</span> Files.readAllBytes(filePath);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Usage example</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomClassLoaderExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">CustomClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomClassLoader</span>(<span class="string">&quot;/custom/classes&quot;</span>, </span><br><span class="line">            ClassLoader.getSystemClassLoader());</span><br><span class="line">        </span><br><span class="line">        Class&lt;?&gt; customClass = loader.loadClass(<span class="string">&quot;com.example.CustomPlugin&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> customClass.getDeclaredConstructor().newInstance();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Use reflection to invoke methods</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> customClass.getMethod(<span class="string">&quot;execute&quot;</span>);</span><br><span class="line">        method.invoke(instance);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Hot-Deployment-Implementation"><a href="#Hot-Deployment-Implementation" class="headerlink" title="Hot Deployment Implementation"></a>Hot Deployment Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HotDeploymentManager</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, CustomClassLoader&gt; classLoaders = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileWatcher fileWatcher;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HotDeploymentManager</span><span class="params">(String watchDirectory)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.fileWatcher = <span class="keyword">new</span> <span class="title class_">FileWatcher</span>(watchDirectory, <span class="built_in">this</span>::onFileChanged);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">onFileChanged</span><span class="params">(Path changedFile)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> extractClassName(changedFile);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Create a new class loader for the updated class</span></span><br><span class="line">        <span class="type">CustomClassLoader</span> <span class="variable">newLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomClassLoader</span>(</span><br><span class="line">            changedFile.getParent().toString(),</span><br><span class="line">            getClass().getClassLoader()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Replace old class loader</span></span><br><span class="line">        <span class="type">CustomClassLoader</span> <span class="variable">oldLoader</span> <span class="operator">=</span> classLoaders.put(className, newLoader);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Cleanup old loader (if possible)</span></span><br><span class="line">        <span class="keyword">if</span> (oldLoader != <span class="literal">null</span>) &#123;</span><br><span class="line">            cleanup(oldLoader);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;Reloaded class: &quot;</span> + className);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">createInstance</span><span class="params">(String className)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">CustomClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> classLoaders.get(className);</span><br><span class="line">        <span class="keyword">if</span> (loader == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(<span class="string">&quot;Class not found: &quot;</span> + className);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        Class&lt;?&gt; clazz = loader.loadClass(className);</span><br><span class="line">        <span class="keyword">return</span> clazz.getDeclaredConstructor().newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Be prepared to explain why Tomcat needs to break parent delegation and how it maintains isolation between web applications.</em></p>
<hr>
<h2 id="Memory-Management-Best-Practices"><a href="#Memory-Management-Best-Practices" class="headerlink" title="Memory Management Best Practices"></a>Memory Management Best Practices</h2><h3 id="Monitoring-and-Tuning"><a href="#Monitoring-and-Tuning" class="headerlink" title="Monitoring and Tuning"></a>Monitoring and Tuning</h3><p><strong>Essential JVM Flags for Production</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Memory sizing</span></span><br><span class="line">-Xms4g -Xmx4g                    <span class="comment"># Set initial and maximum heap size</span></span><br><span class="line">-XX:NewRatio=3                   <span class="comment"># Old:Young generation ratio</span></span><br><span class="line">-XX:SurvivorRatio=8              <span class="comment"># Eden:Survivor ratio</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Garbage Collection</span></span><br><span class="line">-XX:+UseG1GC                     <span class="comment"># Use G1 garbage collector</span></span><br><span class="line">-XX:MaxGCPauseMillis=200         <span class="comment"># Target max GC pause time</span></span><br><span class="line">-XX:G1HeapRegionSize=16m         <span class="comment"># G1 region size</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Metaspace (Java 8+)</span></span><br><span class="line">-XX:MetaspaceSize=256m           <span class="comment"># Initial metaspace size</span></span><br><span class="line">-XX:MaxMetaspaceSize=512m        <span class="comment"># Maximum metaspace size</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Monitoring and Debugging</span></span><br><span class="line">-XX:+PrintGC                     <span class="comment"># Print GC information</span></span><br><span class="line">-XX:+PrintGCDetails              <span class="comment"># Detailed GC information</span></span><br><span class="line">-XX:+PrintGCTimeStamps           <span class="comment"># GC timestamps</span></span><br><span class="line">-XX:+HeapDumpOnOutOfMemoryError  <span class="comment"># Generate heap dump on OOM</span></span><br><span class="line">-XX:HeapDumpPath=/path/to/dumps  <span class="comment"># Heap dump location</span></span><br></pre></td></tr></table></figure>

<h3 id="Memory-Leak-Detection"><a href="#Memory-Leak-Detection" class="headerlink" title="Memory Leak Detection"></a>Memory Leak Detection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemoryLeakExample</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;Object&gt; STATIC_LIST = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Memory leak: objects added to static collection never removed</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addToStaticCollection</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">        STATIC_LIST.add(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Proper implementation with cleanup</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; cache = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addToCache</span><span class="params">(String key, Object value)</span> &#123;</span><br><span class="line">        cache.put(key, value);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Implement cache eviction policy</span></span><br><span class="line">        <span class="keyword">if</span> (cache.size() &gt; MAX_CACHE_SIZE) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">oldestKey</span> <span class="operator">=</span> findOldestKey();</span><br><span class="line">            cache.remove(oldestKey);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Thread-Safety-in-Class-Loading"><a href="#Thread-Safety-in-Class-Loading" class="headerlink" title="Thread Safety in Class Loading"></a>Thread Safety in Class Loading</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadSafeClassLoader</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, Class&lt;?&gt;&gt; classCache = </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="type">boolean</span> resolve) </span><br><span class="line">            <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Thread-safe class loading with double-checked locking</span></span><br><span class="line">        Class&lt;?&gt; clazz = classCache.get(name);</span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class="line">                clazz = classCache.get(name);</span><br><span class="line">                <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">                    clazz = <span class="built_in">super</span>.loadClass(name, resolve);</span><br><span class="line">                    classCache.put(name, clazz);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Common-Interview-Questions-and-Answers"><a href="#Common-Interview-Questions-and-Answers" class="headerlink" title="Common Interview Questions and Answers"></a>Common Interview Questions and Answers</h2><h3 id="Memory-Related-Questions"><a href="#Memory-Related-Questions" class="headerlink" title="Memory-Related Questions"></a>Memory-Related Questions</h3><p><strong>Q: Explain the difference between stack and heap memory.</strong></p>
<p>A: Stack memory is thread-specific and stores method call frames with local variables and partial results. It follows the LIFO principle and has fast allocation&#x2F;deallocation. Heap memory is shared among all threads and stores objects and instance variables. It’s managed by garbage collection and has slower allocation, but supports dynamic sizing.</p>
<p><strong>Q: What happens when you get OutOfMemoryError?</strong></p>
<p>A: An OutOfMemoryError can occur in different memory areas:</p>
<ul>
<li><strong>Heap</strong>: Too many objects, increase <code>-Xmx</code> or optimize object lifecycle</li>
<li><strong>Metaspace</strong>: Too many classes loaded, increase <code>-XX:MaxMetaspaceSize</code></li>
<li><strong>Stack</strong>: Deep recursion, increase <code>-Xss</code> or fix recursive logic</li>
<li><strong>Direct Memory</strong>: NIO operations, tune <code>-XX:MaxDirectMemorySize</code></li>
</ul>
<h3 id="Class-Loading-Questions"><a href="#Class-Loading-Questions" class="headerlink" title="Class Loading Questions"></a>Class Loading Questions</h3><p><strong>Q: Can you override java.lang.String class?</strong></p>
<p>A: No, due to the parent delegation model. The Bootstrap class loader always loads <code>java.lang.String</code> from <code>rt.jar</code> first, preventing any custom String class from being loaded.</p>
<p><strong>Q: How does Tomcat isolate different web applications?</strong></p>
<p>A: Tomcat uses separate WebAppClassLoader instances for each web application and modifies the parent delegation model to load application-specific classes first, enabling different versions of the same library in different applications.</p>
<hr>
<h2 id="Advanced-Topics-and-Production-Insights"><a href="#Advanced-Topics-and-Production-Insights" class="headerlink" title="Advanced Topics and Production Insights"></a>Advanced Topics and Production Insights</h2><h3 id="Class-Unloading"><a href="#Class-Unloading" class="headerlink" title="Class Unloading"></a>Class Unloading</h3><p>Classes can be unloaded when their class loader becomes unreachable and eligible for garbage collection:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassUnloadingExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">demonstrateClassUnloading</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// Create custom class loader</span></span><br><span class="line">        <span class="type">URLClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URLClassLoader</span>(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">URL</span>[]&#123;<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;custom-classes/&quot;</span>).toURI().toURL()&#125;</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Load class using custom loader</span></span><br><span class="line">        Class&lt;?&gt; clazz = loader.loadClass(<span class="string">&quot;com.example.CustomClass&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> clazz.getDeclaredConstructor().newInstance();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Use the instance</span></span><br><span class="line">        clazz.getMethod(<span class="string">&quot;doSomething&quot;</span>).invoke(instance);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Clear references</span></span><br><span class="line">        instance = <span class="literal">null</span>;</span><br><span class="line">        clazz = <span class="literal">null</span>;</span><br><span class="line">        loader.close();</span><br><span class="line">        loader = <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Force garbage collection</span></span><br><span class="line">        System.gc();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Class may be unloaded if no other references exist</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Performance-Optimization-Tips"><a href="#Performance-Optimization-Tips" class="headerlink" title="Performance Optimization Tips"></a>Performance Optimization Tips</h3><ol>
<li><strong>Minimize Class Loading</strong>: Reduce the number of classes loaded at startup</li>
<li><strong>Optimize Class Path</strong>: Keep class path short and organized</li>
<li><strong>Use Appropriate GC</strong>: Choose GC algorithm based on application needs</li>
<li><strong>Monitor Memory Usage</strong>: Use tools like JVisualVM, JProfiler, or APM solutions</li>
<li><strong>Implement Proper Caching</strong>: Cache frequently used objects appropriately</li>
</ol>
<h3 id="Production-Monitoring"><a href="#Production-Monitoring" class="headerlink" title="Production Monitoring"></a>Production Monitoring</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JMX bean for monitoring class loading</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassLoadingMonitor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClassLoadingMXBean classLoadingBean;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MemoryMXBean memoryBean;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ClassLoadingMonitor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.classLoadingBean = ManagementFactory.getClassLoadingMXBean();</span><br><span class="line">        <span class="built_in">this</span>.memoryBean = ManagementFactory.getMemoryMXBean();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">printClassLoadingStats</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Loaded Classes: &quot;</span> + classLoadingBean.getLoadedClassCount());</span><br><span class="line">        System.out.println(<span class="string">&quot;Total Loaded: &quot;</span> + classLoadingBean.getTotalLoadedClassCount());</span><br><span class="line">        System.out.println(<span class="string">&quot;Unloaded Classes: &quot;</span> + classLoadingBean.getUnloadedClassCount());</span><br><span class="line">        </span><br><span class="line">        <span class="type">MemoryUsage</span> <span class="variable">heapUsage</span> <span class="operator">=</span> memoryBean.getHeapMemoryUsage();</span><br><span class="line">        System.out.println(<span class="string">&quot;Heap Used: &quot;</span> + heapUsage.getUsed() / (<span class="number">1024</span> * <span class="number">1024</span>) + <span class="string">&quot; MB&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Heap Max: &quot;</span> + heapUsage.getMax() / (<span class="number">1024</span> * <span class="number">1024</span>) + <span class="string">&quot; MB&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This comprehensive guide covers the essential aspects of JVM memory structure, from basic concepts to advanced production scenarios. Understanding these concepts is crucial for developing efficient Java applications and troubleshooting performance issues in production environments.</p>
<h2 id="Essential-Tools-and-Commands"><a href="#Essential-Tools-and-Commands" class="headerlink" title="Essential Tools and Commands"></a>Essential Tools and Commands</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Memory analysis tools</span></span><br><span class="line">jmap -dump:live,format=b,file=heap.hprof &lt;pid&gt;</span><br><span class="line">jhat heap.hprof  <span class="comment"># Heap analysis tool</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Class loading monitoring</span></span><br><span class="line">jstat -class &lt;pid&gt; 1s  <span class="comment"># Monitor class loading every second</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Garbage collection monitoring</span></span><br><span class="line">jstat -gc &lt;pid&gt; 1s     <span class="comment"># Monitor GC activity</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># JVM process information</span></span><br><span class="line">jps -v                 <span class="comment"># List JVM processes with arguments</span></span><br><span class="line">jinfo &lt;pid&gt;           <span class="comment"># Print JVM configuration</span></span><br></pre></td></tr></table></figure>

<h2 id="References-and-Further-Reading"><a href="#References-and-Further-Reading" class="headerlink" title="References and Further Reading"></a>References and Further Reading</h2><ul>
<li><strong>Oracle JVM Specification</strong>: Comprehensive technical documentation</li>
<li><strong>Java Performance: The Definitive Guide</strong> by Scott Oaks</li>
<li><strong>Effective Java</strong> by Joshua Bloch - Best practices for memory management</li>
<li><strong>G1GC Documentation</strong>: For modern garbage collection strategies</li>
<li><strong>JProfiler&#x2F;VisualVM</strong>: Professional memory profiling tools</li>
</ul>
<p>Understanding JVM memory structure is fundamental for Java developers, especially for performance tuning, debugging memory issues, and building scalable applications. Regular monitoring and profiling should be part of your development workflow to ensure optimal application performance.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/17/Elasticsearch-Query-Performance-Optimization-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/17/Elasticsearch-Query-Performance-Optimization-Guide/" class="post-title-link" itemprop="url">Elasticsearch Query Performance Optimization Guide</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-17 17:10:10 / Modified: 17:11:28" itemprop="dateCreated datePublished" datetime="2025-06-17T17:10:10+08:00">2025-06-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/elasticsearch/" itemprop="url" rel="index"><span itemprop="name">elasticsearch</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="System-Level-Optimizations"><a href="#System-Level-Optimizations" class="headerlink" title="System-Level Optimizations"></a>System-Level Optimizations</h2><h3 id="Garbage-Collection-GC-Tuning"><a href="#Garbage-Collection-GC-Tuning" class="headerlink" title="Garbage Collection (GC) Tuning"></a>Garbage Collection (GC) Tuning</h3><p>Elasticsearch relies heavily on the JVM, making GC performance critical for query response times. Poor GC configuration can lead to query timeouts and cluster instability.</p>
<p><strong>Production Best Practices:</strong></p>
<ul>
<li>Use G1GC for heaps larger than 6GB: <code>-XX:+UseG1GC</code></li>
<li>Set heap size to 50% of available RAM, but never exceed 32GB</li>
<li>Configure GC logging for monitoring: <code>-Xloggc:gc.log -XX:+PrintGCDetails</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Optimal JVM settings for production</span></span><br><span class="line">ES_JAVA_OPTS=<span class="string">&quot;-Xms16g -Xmx16g -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+PrintGC -XX:+PrintGCTimeStamps&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight:</strong> <em>“Why is 32GB the heap size limit?”</em> - Beyond 32GB, the JVM loses compressed OOPs (Ordinary Object Pointers), effectively doubling pointer sizes and reducing cache efficiency.</p>
<h3 id="Memory-Management-and-Swappiness"><a href="#Memory-Management-and-Swappiness" class="headerlink" title="Memory Management and Swappiness"></a>Memory Management and Swappiness</h3><p>Swapping to disk can destroy Elasticsearch performance, turning millisecond operations into second-long delays.</p>
<p><strong>Configuration Steps:</strong></p>
<ol>
<li>Disable swap entirely: <code>sudo swapoff -a</code></li>
<li>Configure swappiness: <code>vm.swappiness=1</code></li>
<li>Enable memory locking in Elasticsearch:</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># elasticsearch.yml</span></span><br><span class="line"><span class="attr">bootstrap.memory_lock:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p><strong>Production Example:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/sysctl.conf</span></span><br><span class="line">vm.swappiness=1</span><br><span class="line">vm.max_map_count=262144</span><br><span class="line"></span><br><span class="line"><span class="comment"># Verify settings</span></span><br><span class="line">sysctl vm.swappiness</span><br><span class="line">sysctl vm.max_map_count</span><br></pre></td></tr></table></figure>

<h3 id="File-Descriptors-Optimization"><a href="#File-Descriptors-Optimization" class="headerlink" title="File Descriptors Optimization"></a>File Descriptors Optimization</h3><p>Elasticsearch requires numerous file descriptors for index files, network connections, and internal operations.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/security/limits.conf</span></span><br><span class="line">elasticsearch soft nofile 65536</span><br><span class="line">elasticsearch hard nofile 65536</span><br><span class="line">elasticsearch soft <span class="built_in">nproc</span> 4096</span><br><span class="line">elasticsearch hard <span class="built_in">nproc</span> 4096</span><br><span class="line"></span><br><span class="line"><span class="comment"># Verify current limits</span></span><br><span class="line"><span class="built_in">ulimit</span> -n</span><br><span class="line"><span class="built_in">ulimit</span> -u</span><br></pre></td></tr></table></figure>

<p><strong>Monitoring Script:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Check file descriptor usage</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Current FD usage: <span class="subst">$(lsof -u elasticsearch | wc -l)</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;FD limit: <span class="subst">$(ulimit -n)</span>&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Query-Optimization-Strategies"><a href="#Query-Optimization-Strategies" class="headerlink" title="Query Optimization Strategies"></a>Query Optimization Strategies</h2><h3 id="Pagination-Performance"><a href="#Pagination-Performance" class="headerlink" title="Pagination Performance"></a>Pagination Performance</h3><p>Deep pagination is one of the most common performance bottlenecks in Elasticsearch applications.</p>
<h4 id="Problem-with-Traditional-Pagination"><a href="#Problem-with-Traditional-Pagination" class="headerlink" title="Problem with Traditional Pagination"></a>Problem with Traditional Pagination</h4><pre>
<code class="mermaid">
graph
A[Client Request: from&#x3D;10000, size&#x3D;10] --&gt; B[Elasticsearch Coordinator]
B --&gt; C[Shard 1: Fetch 10010 docs]
B --&gt; D[Shard 2: Fetch 10010 docs]
B --&gt; E[Shard 3: Fetch 10010 docs]
C --&gt; F[Coordinator: Sort 30030 docs]
D --&gt; F
E --&gt; F
F --&gt; G[Return 10 docs to client]
</code>
</pre>

<h4 id="Solution-1-Scroll-API"><a href="#Solution-1-Scroll-API" class="headerlink" title="Solution 1: Scroll API"></a>Solution 1: Scroll API</h4><p>Best for processing large datasets sequentially:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># Initial scroll request</span><br><span class="line">POST /my_index/_search?scroll=<span class="number">1</span>m</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"># Subsequent scroll requests</span><br><span class="line">POST /_search/scroll</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;scroll&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1m&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;scroll_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your_scroll_id_here&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Production Use Case:</strong> Log processing pipeline handling millions of documents daily.</p>
<h4 id="Solution-2-Search-After-API"><a href="#Solution-2-Search-After-API" class="headerlink" title="Solution 2: Search After API"></a>Solution 2: Search After API</h4><p>Ideal for real-time pagination with live data:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># First request</span><br><span class="line">GET /my_index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;elasticsearch&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"># Next page using search_after</span><br><span class="line">GET /my_index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;elasticsearch&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;search_after&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;2023-10-01T10:00:00Z&quot;</span><span class="punctuation">,</span> <span class="string">&quot;doc_id_123&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight:</strong> <em>“When would you choose search_after over scroll?”</em> - Search_after is stateless and handles live data changes better, while scroll is more efficient for complete dataset processing.</p>
<h3 id="Bulk-Operations-Optimization"><a href="#Bulk-Operations-Optimization" class="headerlink" title="Bulk Operations Optimization"></a>Bulk Operations Optimization</h3><p>The <code>_bulk</code> API significantly reduces network overhead and improves indexing performance.</p>
<h4 id="Bulk-API-Best-Practices"><a href="#Bulk-API-Best-Practices" class="headerlink" title="Bulk API Best Practices"></a>Bulk API Best Practices</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_index&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Document 1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Content here&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_index&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Document 2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;More content&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;update&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_index&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;doc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;updated&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;delete&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_index&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Production Implementation:</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> elasticsearch <span class="keyword">import</span> Elasticsearch</span><br><span class="line"><span class="keyword">from</span> elasticsearch.helpers <span class="keyword">import</span> bulk</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bulk_index_documents</span>(<span class="params">es_client, documents, index_name</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Efficiently bulk index documents with error handling</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    actions = []</span><br><span class="line">    <span class="keyword">for</span> doc <span class="keyword">in</span> documents:</span><br><span class="line">        actions.append(&#123;</span><br><span class="line">            <span class="string">&quot;_index&quot;</span>: index_name,</span><br><span class="line">            <span class="string">&quot;_source&quot;</span>: doc</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Process in batches of 1000</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(actions) &gt;= <span class="number">1000</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                bulk(es_client, actions)</span><br><span class="line">                actions = []</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Bulk indexing error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                </span><br><span class="line">    <span class="comment"># Process remaining documents</span></span><br><span class="line">    <span class="keyword">if</span> actions:</span><br><span class="line">        bulk(es_client, actions)</span><br></pre></td></tr></table></figure>

<p><strong>Performance Tuning:</strong></p>
<ul>
<li>Optimal batch size: 1000-5000 documents or 5-15MB</li>
<li>Use multiple threads for parallel bulk requests</li>
<li>Monitor queue sizes and adjust accordingly</li>
</ul>
<h2 id="Index-Level-Optimizations"><a href="#Index-Level-Optimizations" class="headerlink" title="Index-Level Optimizations"></a>Index-Level Optimizations</h2><h3 id="Refresh-Frequency-Optimization"><a href="#Refresh-Frequency-Optimization" class="headerlink" title="Refresh Frequency Optimization"></a>Refresh Frequency Optimization</h3><p>The refresh operation makes documents searchable but consumes significant resources.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># elasticsearch.yml - Global setting</span></span><br><span class="line"><span class="attr">index.refresh_interval:</span> <span class="string">30s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Index-specific setting</span></span><br><span class="line"><span class="string">PUT</span> <span class="string">/my_index/_settings</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;refresh_interval&quot;:</span> <span class="string">&quot;30s&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Disable refresh for write-heavy workloads</span></span><br><span class="line"><span class="string">PUT</span> <span class="string">/my_index/_settings</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;refresh_interval&quot;:</span> <span class="number">-1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Use Case Example:</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># High-volume logging scenario</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setup_logging_index</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Configure index for write-heavy logging workload</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    index_settings = &#123;</span><br><span class="line">        <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;refresh_interval&quot;</span>: <span class="string">&quot;60s&quot;</span>,  <span class="comment"># Reduce refresh frequency</span></span><br><span class="line">            <span class="string">&quot;number_of_replicas&quot;</span>: <span class="number">0</span>,    <span class="comment"># Disable replicas during bulk load</span></span><br><span class="line">            <span class="string">&quot;translog.durability&quot;</span>: <span class="string">&quot;async&quot;</span>,  <span class="comment"># Async translog for speed</span></span><br><span class="line">            <span class="string">&quot;index.merge.policy.max_merge_at_once&quot;</span>: <span class="number">30</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> index_settings</span><br></pre></td></tr></table></figure>

<h3 id="Field-Optimization-Strategies"><a href="#Field-Optimization-Strategies" class="headerlink" title="Field Optimization Strategies"></a>Field Optimization Strategies</h3><p>Disable unnecessary features to reduce index size and improve query performance.</p>
<h4 id="Source-Field-Optimization"><a href="#Source-Field-Optimization" class="headerlink" title="Source Field Optimization"></a>Source Field Optimization</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># Disable _source for analytics-only indices</span><br><span class="line">PUT /analytics_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;metric_value&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;double&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"># Selective source inclusion</span><br><span class="line">PUT /selective_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;includes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;title&quot;</span><span class="punctuation">,</span> <span class="string">&quot;summary&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;excludes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;large_content&quot;</span><span class="punctuation">,</span> <span class="string">&quot;binary_data&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="Doc-Values-Optimization"><a href="#Doc-Values-Optimization" class="headerlink" title="Doc Values Optimization"></a>Doc Values Optimization</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># Disable doc_values for fields that don&#x27;t need aggregations/sorting</span><br><span class="line">PUT /my_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;searchable_text&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;doc_values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;aggregatable_field&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;doc_values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight:</strong> <em>“What are doc_values and when should you disable them?”</em> - Doc_values enable aggregations, sorting, and scripting but consume disk space. Disable for fields used only in queries, not aggregations.</p>
<h3 id="Data-Lifecycle-Management"><a href="#Data-Lifecycle-Management" class="headerlink" title="Data Lifecycle Management"></a>Data Lifecycle Management</h3><p>Separate hot and cold data for optimal resource utilization.</p>
<pre>
<code class="mermaid">
graph
A[Hot Data&lt;br&#x2F;&gt;SSD Storage&lt;br&#x2F;&gt;Frequent Access] --&gt; B[Warm Data&lt;br&#x2F;&gt;HDD Storage&lt;br&#x2F;&gt;Occasional Access]
B --&gt; C[Cold Data&lt;br&#x2F;&gt;Archive Storage&lt;br&#x2F;&gt;Rare Access]

A --&gt; D[High Resources&lt;br&#x2F;&gt;More Replicas]
B --&gt; E[Medium Resources&lt;br&#x2F;&gt;Fewer Replicas]
C --&gt; F[Minimal Resources&lt;br&#x2F;&gt;Compressed Storage]
</code>
</pre>

<p><strong>ILM Policy Example:</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">PUT _ilm/policy/logs_policy</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;policy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;phases&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;hot&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;rollover&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;max_size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1GB&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;max_age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1d&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;warm&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;min_age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7d&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;allocate&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;cold&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;min_age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30d&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;allocate&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Memory-and-Storage-Optimization"><a href="#Memory-and-Storage-Optimization" class="headerlink" title="Memory and Storage Optimization"></a>Memory and Storage Optimization</h2><h3 id="Off-Heap-Memory-Optimization"><a href="#Off-Heap-Memory-Optimization" class="headerlink" title="Off-Heap Memory Optimization"></a>Off-Heap Memory Optimization</h3><p>Elasticsearch uses off-heap memory for various caches and operations.</p>
<p><strong>Circuit Breaker Configuration:</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># elasticsearch.yml</span></span><br><span class="line"><span class="attr">indices.breaker.total.limit:</span> <span class="number">70</span><span class="string">%</span></span><br><span class="line"><span class="attr">indices.breaker.fielddata.limit:</span> <span class="number">40</span><span class="string">%</span></span><br><span class="line"><span class="attr">indices.breaker.request.limit:</span> <span class="number">60</span><span class="string">%</span></span><br></pre></td></tr></table></figure>

<p><strong>Field Data Cache Management:</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># Monitor field data usage</span><br><span class="line">GET /_nodes/stats/indices/fielddata</span><br><span class="line"></span><br><span class="line"># Clear field data cache</span><br><span class="line">POST /_cache/clear?fielddata=<span class="literal"><span class="keyword">true</span></span></span><br><span class="line"></span><br><span class="line"># Limit field data cache size</span><br><span class="line">PUT /_cluster/settings</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;persistent&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;indices.fielddata.cache.size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30%&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Production Monitoring Script:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Monitor memory usage</span></span><br><span class="line">curl -s <span class="string">&quot;localhost:9200/_cat/nodes?v&amp;h=name,heap.percent,ram.percent,fielddata.memory_size,query_cache.memory_size&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Shard-Optimization"><a href="#Shard-Optimization" class="headerlink" title="Shard Optimization"></a>Shard Optimization</h3><p>Proper shard sizing is crucial for performance and cluster stability.</p>
<h4 id="Shard-Count-and-Size-Guidelines"><a href="#Shard-Count-and-Size-Guidelines" class="headerlink" title="Shard Count and Size Guidelines"></a>Shard Count and Size Guidelines</h4><pre>
<code class="mermaid">
graph
A[Determine Shard Strategy] --&gt; B{Index Size}
B --&gt;|&lt; 1GB| C[1 Primary Shard]
B --&gt;|1-50GB| D[1-5 Primary Shards]
B --&gt;|&gt; 50GB| E[Calculate: Size&#x2F;50GB]

C --&gt; F[Small Index Strategy]
D --&gt; G[Medium Index Strategy]
E --&gt; H[Large Index Strategy]

F --&gt; I[Minimize Overhead]
G --&gt; J[Balance Performance]
H --&gt; K[Distribute Load]
</code>
</pre>

<p><strong>Shard Calculation Formula:</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_optimal_shards</span>(<span class="params">index_size_gb, node_count</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Calculate optimal shard count based on index size and cluster size</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># Target shard size: 20-50GB</span></span><br><span class="line">    target_shard_size_gb = <span class="number">30</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Calculate based on size</span></span><br><span class="line">    size_based_shards = <span class="built_in">max</span>(<span class="number">1</span>, index_size_gb // target_shard_size_gb)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Don&#x27;t exceed node count (for primary shards)</span></span><br><span class="line">    optimal_shards = <span class="built_in">min</span>(size_based_shards, node_count)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> optimal_shards</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example usage</span></span><br><span class="line">index_size = <span class="number">150</span>  <span class="comment"># GB</span></span><br><span class="line">nodes = <span class="number">5</span></span><br><span class="line">shards = calculate_optimal_shards(index_size, nodes)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Recommended shards: <span class="subst">&#123;shards&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>Production Shard Settings:</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT /optimized_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.routing.allocation.total_shards_per_node&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Query-Performance-Patterns"><a href="#Query-Performance-Patterns" class="headerlink" title="Query Performance Patterns"></a>Query Performance Patterns</h3><h4 id="Efficient-Query-Patterns"><a href="#Efficient-Query-Patterns" class="headerlink" title="Efficient Query Patterns"></a>Efficient Query Patterns</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># Use filter context for exact matches (cacheable)</span><br><span class="line">GET /my_index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;elasticsearch&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;published&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;date&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2023-01-01&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"># Avoid wildcard queries on large datasets</span><br><span class="line"># BAD<span class="punctuation">:</span></span><br><span class="line"># <span class="punctuation">&#123;</span><span class="attr">&quot;wildcard&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*elasticsearch*&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"># GOOD<span class="punctuation">:</span> Use match_phrase_prefix for autocomplete</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;match_phrase_prefix&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;elasticsearch&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="Aggregation-Optimization"><a href="#Aggregation-Optimization" class="headerlink" title="Aggregation Optimization"></a>Aggregation Optimization</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># Use composite aggregations for large cardinality</span><br><span class="line">GET /my_index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;my_composite&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;composite&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sources&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span><span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;category.keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span><span class="attr">&quot;date&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;date_histogram&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;timestamp&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1d&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Monitoring-and-Troubleshooting"><a href="#Monitoring-and-Troubleshooting" class="headerlink" title="Monitoring and Troubleshooting"></a>Monitoring and Troubleshooting</h2><h3 id="Performance-Metrics"><a href="#Performance-Metrics" class="headerlink" title="Performance Metrics"></a>Performance Metrics</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Key performance APIs</span></span><br><span class="line">curl <span class="string">&quot;localhost:9200/_cat/nodes?v&amp;h=name,heap.percent,cpu,load_1m&quot;</span></span><br><span class="line">curl <span class="string">&quot;localhost:9200/_cat/indices?v&amp;h=index,docs.count,store.size,pri,rep&quot;</span></span><br><span class="line">curl <span class="string">&quot;localhost:9200/_nodes/stats/indices/search,indices/indexing&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>Slow Query Analysis:</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># Enable slow query logging</span><br><span class="line">PUT /my_index/_settings</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;index.search.slowlog.threshold.query.warn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10s&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;index.search.slowlog.threshold.query.info&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5s&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;index.search.slowlog.threshold.fetch.warn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1s&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Common-Performance-Anti-Patterns"><a href="#Common-Performance-Anti-Patterns" class="headerlink" title="Common Performance Anti-Patterns"></a>Common Performance Anti-Patterns</h3><p><strong>Interview Questions &amp; Solutions:</strong></p>
<ol>
<li><p><strong>“Why are my deep pagination queries slow?”</strong></p>
<ul>
<li>Use scroll API for sequential processing</li>
<li>Use search_after for real-time pagination</li>
<li>Implement caching for frequently accessed pages</li>
</ul>
</li>
<li><p><strong>“How do you handle high cardinality aggregations?”</strong></p>
<ul>
<li>Use composite aggregations with pagination</li>
<li>Implement pre-aggregated indices for common queries</li>
<li>Consider using terms aggregation with execution_hint</li>
</ul>
</li>
<li><p><strong>“What causes high memory usage in Elasticsearch?”</strong></p>
<ul>
<li>Large field data caches from aggregations</li>
<li>Too many shards causing overhead</li>
<li>Inefficient query patterns causing cache thrashing</li>
</ul>
</li>
</ol>
<h2 id="Advanced-Optimization-Techniques"><a href="#Advanced-Optimization-Techniques" class="headerlink" title="Advanced Optimization Techniques"></a>Advanced Optimization Techniques</h2><h3 id="Index-Templates-and-Aliases"><a href="#Index-Templates-and-Aliases" class="headerlink" title="Index Templates and Aliases"></a>Index Templates and Aliases</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># Optimized index template</span><br><span class="line">PUT /_index_template/logs_template</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;index_patterns&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;logs-*&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;template&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30s&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;codec&quot;</span><span class="punctuation">:</span> <span class="string">&quot;best_compression&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;dynamic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;strict&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;norms&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;service&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Machine-Learning-and-Anomaly-Detection"><a href="#Machine-Learning-and-Anomaly-Detection" class="headerlink" title="Machine Learning and Anomaly Detection"></a>Machine Learning and Anomaly Detection</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># Use ML for capacity planning</span><br><span class="line">PUT _ml/anomaly_detectors/high_search_rate</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;job_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;high_search_rate&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;analysis_config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bucket_span&quot;</span><span class="punctuation">:</span> <span class="string">&quot;15m&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;detectors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;function&quot;</span><span class="punctuation">:</span> <span class="string">&quot;high_mean&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;field_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;search_rate&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data_description&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;time_field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;timestamp&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Elasticsearch query performance optimization requires a holistic approach combining system-level tuning, query optimization, and proper index design. The key is to:</p>
<ol>
<li><strong>Monitor continuously</strong> - Use built-in monitoring and custom metrics</li>
<li><strong>Test systematically</strong> - Benchmark changes in isolated environments</li>
<li><strong>Scale progressively</strong> - Start with simple optimizations before complex ones</li>
<li><strong>Plan for growth</strong> - Design with future data volumes in mind</li>
</ol>
<p><strong>Critical Interview Insight:</strong> <em>“Performance optimization is not a one-time task but an ongoing process that requires understanding your data patterns, query characteristics, and growth projections.”</em></p>
<h2 id="External-Resources"><a href="#External-Resources" class="headerlink" title="External Resources"></a>External Resources</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/tune-for-search-speed.html">Elasticsearch Official Performance Tuning Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html">Elasticsearch Heap Sizing Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html">Query Performance Best Practices</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index-lifecycle-management.html">Index Lifecycle Management Documentation</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/17/Elasticsearch-High-Availability-Deep-Dive-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/17/Elasticsearch-High-Availability-Deep-Dive-Guide/" class="post-title-link" itemprop="url">Elasticsearch High Availability: Deep Dive Guide</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-17 17:08:58 / Modified: 17:10:45" itemprop="dateCreated datePublished" datetime="2025-06-17T17:08:58+08:00">2025-06-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/elasticsearch/" itemprop="url" rel="index"><span itemprop="name">elasticsearch</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Shards-and-Replicas-The-Foundation-of-Elasticsearch-HA"><a href="#Shards-and-Replicas-The-Foundation-of-Elasticsearch-HA" class="headerlink" title="Shards and Replicas: The Foundation of Elasticsearch HA"></a>Shards and Replicas: The Foundation of Elasticsearch HA</h2><h3 id="Understanding-Shards"><a href="#Understanding-Shards" class="headerlink" title="Understanding Shards"></a>Understanding Shards</h3><p>Shards are the fundamental building blocks of Elasticsearch’s distributed architecture. Each index is divided into multiple shards, which are essentially independent Lucene indices that can be distributed across different nodes in a cluster.</p>
<p><strong>Primary Shards:</strong></p>
<ul>
<li>Store the original data</li>
<li>Handle write operations</li>
<li>Number is fixed at index creation time</li>
<li>Cannot be changed without reindexing</li>
</ul>
<p><strong>Shard Sizing Best Practices:</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.routing.allocation.total_shards_per_node&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Replica-Strategy-for-High-Availability"><a href="#Replica-Strategy-for-High-Availability" class="headerlink" title="Replica Strategy for High Availability"></a>Replica Strategy for High Availability</h3><p>Replicas are exact copies of primary shards that provide both redundancy and increased read throughput.</p>
<p><strong>Production Replica Configuration:</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /production_logs</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30s&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.translog.durability&quot;</span><span class="punctuation">:</span> <span class="string">&quot;request&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Real-World-Example-E-commerce-Platform"><a href="#Real-World-Example-E-commerce-Platform" class="headerlink" title="Real-World Example: E-commerce Platform"></a>Real-World Example: E-commerce Platform</h3><p>Consider an e-commerce platform handling 1TB of product data:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PUT /products</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.routing.allocation.require.box_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hot&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;product_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;double&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<pre>
<code class="mermaid">
graph TB
subgraph &quot;Node 1&quot;
    P1[Primary Shard 1]
    R2[Replica Shard 2]
    R3[Replica Shard 3]
end

subgraph &quot;Node 2&quot;
    P2[Primary Shard 2]
    R1[Replica Shard 1]
    R4[Replica Shard 4]
end

subgraph &quot;Node 3&quot;
    P3[Primary Shard 3]
    P4[Primary Shard 4]
    R5[Replica Shard 5]
end

P1 -.-&gt;|Replicates to| R1
P2 -.-&gt;|Replicates to| R2
P3 -.-&gt;|Replicates to| R3
P4 -.-&gt;|Replicates to| R4
</code>
</pre>

<p><strong>Interview Insight:</strong> <em>“How would you determine the optimal number of shards for a 500GB index with expected 50% growth annually?”</em></p>
<p><strong>Answer:</strong> Calculate based on shard size (aim for 10-50GB per shard), consider node capacity, and factor in growth. For 500GB growing to 750GB: 15-75 shards initially, typically 20-30 shards with 1-2 replicas.</p>
<h2 id="TransLog-Ensuring-Write-Durability"><a href="#TransLog-Ensuring-Write-Durability" class="headerlink" title="TransLog: Ensuring Write Durability"></a>TransLog: Ensuring Write Durability</h2><h3 id="TransLog-Mechanism"><a href="#TransLog-Mechanism" class="headerlink" title="TransLog Mechanism"></a>TransLog Mechanism</h3><p>The Transaction Log (TransLog) is Elasticsearch’s write-ahead log that ensures data durability during unexpected shutdowns or power failures.</p>
<p><strong>How TransLog Works:</strong></p>
<ol>
<li>Write operation received</li>
<li>Data written to in-memory buffer</li>
<li>Operation logged to TransLog</li>
<li>Acknowledgment sent to client</li>
<li>Periodic flush to Lucene segments</li>
</ol>
<h3 id="TransLog-Configuration-for-High-Availability"><a href="#TransLog-Configuration-for-High-Availability" class="headerlink" title="TransLog Configuration for High Availability"></a>TransLog Configuration for High Availability</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /critical_data</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;index.translog.durability&quot;</span><span class="punctuation">:</span> <span class="string">&quot;request&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.translog.sync_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5s&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.translog.flush_threshold_size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;512mb&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1s&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>TransLog Durability Options:</strong></p>
<ul>
<li><code>request</code>: Fsync after each request (highest durability, lower performance)</li>
<li><code>async</code>: Fsync every sync_interval (better performance, slight risk)</li>
</ul>
<h3 id="Production-Example-Financial-Trading-System"><a href="#Production-Example-Financial-Trading-System" class="headerlink" title="Production Example: Financial Trading System"></a>Production Example: Financial Trading System</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PUT /trading_transactions</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.translog.durability&quot;</span><span class="punctuation">:</span> <span class="string">&quot;request&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.translog.sync_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1s&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1s&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.translog.retention.size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1gb&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.translog.retention.age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;12h&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<pre>
<code class="mermaid">
sequenceDiagram
participant Client
participant ES_Node
participant TransLog
participant Lucene

Client-&gt;&gt;ES_Node: Index Document
ES_Node-&gt;&gt;TransLog: Write to TransLog
TransLog--&gt;&gt;ES_Node: Confirm Write
ES_Node-&gt;&gt;Lucene: Add to In-Memory Buffer
ES_Node--&gt;&gt;Client: Acknowledge Request

Note over ES_Node: Periodic Refresh
ES_Node-&gt;&gt;Lucene: Flush Buffer to Segment
ES_Node-&gt;&gt;TransLog: Clear TransLog Entries
</code>
</pre>

<p><strong>Interview Insight:</strong> <em>“What happens if a node crashes between TransLog write and Lucene flush?”</em></p>
<p><strong>Answer:</strong> On restart, Elasticsearch replays TransLog entries to recover uncommitted operations. The TransLog ensures no acknowledged writes are lost, maintaining data consistency.</p>
<h2 id="Production-HA-Challenges-and-Solutions"><a href="#Production-HA-Challenges-and-Solutions" class="headerlink" title="Production HA Challenges and Solutions"></a>Production HA Challenges and Solutions</h2><h3 id="Common-Production-Issues"><a href="#Common-Production-Issues" class="headerlink" title="Common Production Issues"></a>Common Production Issues</h3><h4 id="Split-Brain-Syndrome"><a href="#Split-Brain-Syndrome" class="headerlink" title="Split-Brain Syndrome"></a>Split-Brain Syndrome</h4><p><strong>Problem:</strong> Network partitions causing multiple master nodes</p>
<p><strong>Solution:</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># elasticsearch.yml</span></span><br><span class="line"><span class="attr">discovery.zen.minimum_master_nodes:</span> <span class="number">2</span>  <span class="comment"># (total_masters / 2) + 1</span></span><br><span class="line"><span class="attr">cluster.initial_master_nodes:</span> [<span class="string">&quot;node-1&quot;</span>, <span class="string">&quot;node-2&quot;</span>, <span class="string">&quot;node-3&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="Memory-Pressure-and-GC-Issues"><a href="#Memory-Pressure-and-GC-Issues" class="headerlink" title="Memory Pressure and GC Issues"></a>Memory Pressure and GC Issues</h4><p><strong>Problem:</strong> Large heaps causing long GC pauses</p>
<p><strong>Solution:</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># jvm.options</span></span><br><span class="line"><span class="string">-Xms16g</span></span><br><span class="line"><span class="string">-Xmx16g</span></span><br><span class="line"><span class="string">-XX:+UseG1GC</span></span><br><span class="line"><span class="string">-XX:MaxGCPauseMillis=200</span></span><br></pre></td></tr></table></figure>

<h4 id="Uneven-Shard-Distribution"><a href="#Uneven-Shard-Distribution" class="headerlink" title="Uneven Shard Distribution"></a>Uneven Shard Distribution</h4><p><strong>Problem:</strong> Hot spots on specific nodes</p>
<p><strong>Solution:</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT /_cluster/settings</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;transient&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;cluster.routing.allocation.balance.shard&quot;</span><span class="punctuation">:</span> <span class="number">0.45</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cluster.routing.allocation.balance.index&quot;</span><span class="punctuation">:</span> <span class="number">0.55</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cluster.routing.allocation.balance.threshold&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Real-Production-Case-Study-Log-Analytics-Platform"><a href="#Real-Production-Case-Study-Log-Analytics-Platform" class="headerlink" title="Real Production Case Study: Log Analytics Platform"></a>Real Production Case Study: Log Analytics Platform</h3><p><strong>Challenge:</strong> Processing 100GB&#x2F;day of application logs with strict SLA requirements</p>
<p><strong>Architecture:</strong></p>
<pre>
<code class="mermaid">
graph LR
subgraph &quot;Hot Tier&quot;
    H1[Hot Node 1]
    H2[Hot Node 2]
    H3[Hot Node 3]
end

subgraph &quot;Warm Tier&quot;
    W1[Warm Node 1]
    W2[Warm Node 2]
end

subgraph &quot;Cold Tier&quot;
    C1[Cold Node 1]
end

Apps[Applications] --&gt; LB[Load Balancer]
LB --&gt; H1
LB --&gt; H2
LB --&gt; H3

H1 -.-&gt;|Age-based| W1
H2 -.-&gt;|Migration| W2
W1 -.-&gt;|Archive| C1
W2 -.-&gt;|Archive| C1
</code>
</pre>

<p><strong>Index Template Configuration:</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PUT /_index_template/logs_template</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;index_patterns&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;logs-*&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;template&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;index.lifecycle.name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;logs_policy&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;index.routing.allocation.require.box_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hot&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight:</strong> <em>“How would you handle a scenario where your Elasticsearch cluster is experiencing high write latency?”</em></p>
<p><strong>Answer:</strong> </p>
<ol>
<li>Check TransLog settings (reduce durability if acceptable)</li>
<li>Optimize refresh intervals</li>
<li>Implement bulk indexing</li>
<li>Scale horizontally by adding nodes</li>
<li>Consider index lifecycle management</li>
</ol>
<h2 id="Optimization-Strategies-for-Production-HA"><a href="#Optimization-Strategies-for-Production-HA" class="headerlink" title="Optimization Strategies for Production HA"></a>Optimization Strategies for Production HA</h2><h3 id="Rate-Limiting-Implementation"><a href="#Rate-Limiting-Implementation" class="headerlink" title="Rate Limiting Implementation"></a>Rate Limiting Implementation</h3><p><strong>Circuit Breaker Pattern:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticsearchCircuitBreaker</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CircuitBreaker circuitBreaker;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ElasticsearchClient client;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;IndexResponse&gt; <span class="title function_">indexWithRateLimit</span><span class="params">(</span></span><br><span class="line"><span class="params">            IndexRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> circuitBreaker.executeSupplier(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> client.index(request);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Cluster-level Rate Limiting:</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT /_cluster/settings</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;transient&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;indices.memory.index_buffer_size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;20%&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;indices.memory.min_index_buffer_size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;96mb&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;thread_pool.write.queue_size&quot;</span><span class="punctuation">:</span> <span class="number">1000</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Message-Queue-Peak-Shaving"><a href="#Message-Queue-Peak-Shaving" class="headerlink" title="Message Queue Peak Shaving"></a>Message Queue Peak Shaving</h3><p><strong>Kafka Integration Example:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticsearchBulkProcessor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@KafkaListener(topics = &quot;elasticsearch-queue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processBulkData</span><span class="params">(List&lt;String&gt; documents)</span> &#123;</span><br><span class="line">        <span class="type">BulkRequest</span> <span class="variable">bulkRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BulkRequest</span>();</span><br><span class="line">        </span><br><span class="line">        documents.forEach(doc -&gt; &#123;</span><br><span class="line">            bulkRequest.add(<span class="keyword">new</span> <span class="title class_">IndexRequest</span>(<span class="string">&quot;logs&quot;</span>)</span><br><span class="line">                .source(doc, XContentType.JSON));</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="type">BulkResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.bulk(bulkRequest, RequestOptions.DEFAULT);</span><br><span class="line">        handleBulkResponse(response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>MQ Configuration for Peak Shaving:</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">kafka:</span></span><br><span class="line">    <span class="attr">consumer:</span></span><br><span class="line">      <span class="attr">max-poll-records:</span> <span class="number">500</span></span><br><span class="line">      <span class="attr">fetch-max-wait:</span> <span class="string">1000ms</span></span><br><span class="line">    <span class="attr">producer:</span></span><br><span class="line">      <span class="attr">batch-size:</span> <span class="number">65536</span></span><br><span class="line">      <span class="attr">linger-ms:</span> <span class="number">100</span></span><br></pre></td></tr></table></figure>

<h3 id="Single-Role-Node-Architecture"><a href="#Single-Role-Node-Architecture" class="headerlink" title="Single Role Node Architecture"></a>Single Role Node Architecture</h3><p><strong>Dedicated Master Nodes:</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># master.yml</span></span><br><span class="line"><span class="attr">node.roles:</span> [<span class="string">master</span>]</span><br><span class="line"><span class="attr">discovery.seed_hosts:</span> [<span class="string">&quot;master-1&quot;</span>, <span class="string">&quot;master-2&quot;</span>, <span class="string">&quot;master-3&quot;</span>]</span><br><span class="line"><span class="attr">cluster.initial_master_nodes:</span> [<span class="string">&quot;master-1&quot;</span>, <span class="string">&quot;master-2&quot;</span>, <span class="string">&quot;master-3&quot;</span>]</span><br></pre></td></tr></table></figure>

<p><strong>Data Nodes Configuration:</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># data.yml</span></span><br><span class="line"><span class="attr">node.roles:</span> [<span class="string">data</span>, <span class="string">data_content</span>, <span class="string">data_hot</span>, <span class="string">data_warm</span>]</span><br><span class="line"><span class="attr">path.data:</span> [<span class="string">&quot;/data1&quot;</span>, <span class="string">&quot;/data2&quot;</span>, <span class="string">&quot;/data3&quot;</span>]</span><br></pre></td></tr></table></figure>

<p><strong>Coordinating Nodes:</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coordinator.yml</span></span><br><span class="line"><span class="attr">node.roles:</span> []</span><br><span class="line"><span class="attr">http.port:</span> <span class="number">9200</span></span><br></pre></td></tr></table></figure>

<h3 id="Dual-Cluster-Deployment-Strategy"><a href="#Dual-Cluster-Deployment-Strategy" class="headerlink" title="Dual Cluster Deployment Strategy"></a>Dual Cluster Deployment Strategy</h3><p><strong>Active-Passive Setup:</strong></p>
<pre>
<code class="mermaid">
graph TB
subgraph &quot;Primary DC&quot;
    P_LB[Load Balancer]
    P_C1[Cluster 1 Node 1]
    P_C2[Cluster 1 Node 2]
    P_C3[Cluster 1 Node 3]
    
    P_LB --&gt; P_C1
    P_LB --&gt; P_C2
    P_LB --&gt; P_C3
end

subgraph &quot;Secondary DC&quot;
    S_C1[Cluster 2 Node 1]
    S_C2[Cluster 2 Node 2]
    S_C3[Cluster 2 Node 3]
end

P_C1 -.-&gt;|Cross Cluster Replication| S_C1
P_C2 -.-&gt;|CCR| S_C2
P_C3 -.-&gt;|CCR| S_C3

Apps[Applications] --&gt; P_LB
</code>
</pre>

<p><strong>Cross-Cluster Replication Setup:</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PUT /_cluster/settings</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;persistent&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;cluster.remote.secondary&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;seeds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;secondary-cluster:9300&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;transport.compress&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">PUT /primary_index/_ccr/follow</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;remote_cluster&quot;</span><span class="punctuation">:</span> <span class="string">&quot;secondary&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;leader_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;primary_index&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Advanced-HA-Monitoring-and-Alerting"><a href="#Advanced-HA-Monitoring-and-Alerting" class="headerlink" title="Advanced HA Monitoring and Alerting"></a>Advanced HA Monitoring and Alerting</h2><h3 id="Key-Metrics-to-Monitor"><a href="#Key-Metrics-to-Monitor" class="headerlink" title="Key Metrics to Monitor"></a>Key Metrics to Monitor</h3><p><strong>Cluster Health Script:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">CLUSTER_HEALTH=$(curl -s <span class="string">&quot;localhost:9200/_cluster/health&quot;</span>)</span><br><span class="line">STATUS=$(<span class="built_in">echo</span> <span class="variable">$CLUSTER_HEALTH</span> | jq -r <span class="string">&#x27;.status&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$STATUS</span>&quot;</span> != <span class="string">&quot;green&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;ALERT: Cluster status is <span class="variable">$STATUS</span>&quot;</span></span><br><span class="line">    <span class="comment"># Send notification</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p><strong>Critical Metrics:</strong></p>
<ul>
<li>Cluster status (green&#x2F;yellow&#x2F;red)</li>
<li>Node availability</li>
<li>Shard allocation status</li>
<li>Memory usage and GC frequency</li>
<li>Search and indexing latency</li>
<li>TransLog size and flush frequency</li>
</ul>
<h3 id="Alerting-Configuration-Example"><a href="#Alerting-Configuration-Example" class="headerlink" title="Alerting Configuration Example"></a>Alerting Configuration Example</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># alertmanager.yml</span></span><br><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">elasticsearch</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">ElasticsearchClusterNotHealthy</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">elasticsearch_cluster_health_status&#123;color=&quot;red&quot;&#125;</span> <span class="string">==</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">0m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;Elasticsearch cluster health is RED&quot;</span></span><br><span class="line">      </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">ElasticsearchNodeDown</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">up&#123;job=&quot;elasticsearch&quot;&#125;</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br></pre></td></tr></table></figure>

<h2 id="Performance-Tuning-for-HA"><a href="#Performance-Tuning-for-HA" class="headerlink" title="Performance Tuning for HA"></a>Performance Tuning for HA</h2><h3 id="Index-Lifecycle-Management"><a href="#Index-Lifecycle-Management" class="headerlink" title="Index Lifecycle Management"></a>Index Lifecycle Management</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">PUT /_ilm/policy/production_policy</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;policy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;phases&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;hot&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;rollover&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;max_size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10gb&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;max_age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1d&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;warm&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;min_age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7d&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;allocate&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;require&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;box_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;warm&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;forcemerge&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;max_num_segments&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;cold&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;min_age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30d&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;allocate&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;require&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;box_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cold&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Hardware-Recommendations"><a href="#Hardware-Recommendations" class="headerlink" title="Hardware Recommendations"></a>Hardware Recommendations</h3><p><strong>Production Hardware Specs:</strong></p>
<ul>
<li><strong>CPU:</strong> 16+ cores for data nodes</li>
<li><strong>Memory:</strong> 64GB+ RAM (50% for heap, 50% for filesystem cache)</li>
<li><strong>Storage:</strong> NVMe SSDs for hot data, SATA SSDs for warm&#x2F;cold</li>
<li><strong>Network:</strong> 10Gbps+ for inter-node communication</li>
</ul>
<h2 id="Interview-Questions-and-Expert-Answers"><a href="#Interview-Questions-and-Expert-Answers" class="headerlink" title="Interview Questions and Expert Answers"></a>Interview Questions and Expert Answers</h2><p><strong>Q: “How would you recover from a complete cluster failure?”</strong></p>
<p><strong>A:</strong> </p>
<ol>
<li>Restore from snapshot if available</li>
<li>If no snapshots, recover using <code>elasticsearch-node</code> tool</li>
<li>Implement proper backup strategy going forward</li>
<li>Consider cross-cluster replication for future disasters</li>
</ol>
<p><strong>Q: “Explain the difference between <code>index.refresh_interval</code> and TransLog flush.”</strong></p>
<p><strong>A:</strong> </p>
<ul>
<li><code>refresh_interval</code> controls when in-memory documents become searchable</li>
<li>TransLog flush persists data to disk for durability</li>
<li>Refresh affects search visibility, flush affects data safety</li>
</ul>
<p><strong>Q: “How do you handle version conflicts in a distributed environment?”</strong></p>
<p><strong>A:</strong> </p>
<ul>
<li>Use optimistic concurrency control with version numbers</li>
<li>Implement retry logic with exponential backoff</li>
<li>Consider using <code>_seq_no</code> and <code>_primary_term</code> for more granular control</li>
</ul>
<h2 id="Security-Considerations-for-HA"><a href="#Security-Considerations-for-HA" class="headerlink" title="Security Considerations for HA"></a>Security Considerations for HA</h2><h3 id="Authentication-and-Authorization"><a href="#Authentication-and-Authorization" class="headerlink" title="Authentication and Authorization"></a>Authentication and Authorization</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># elasticsearch.yml</span></span><br><span class="line"><span class="attr">xpack.security.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.http.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">xpack.security.authc.realms.native.native1:</span></span><br><span class="line">  <span class="attr">order:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><strong>Role-Based Access Control:</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /_security/role/log_reader</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;indices&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;names&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;logs-*&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;privileges&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;read&quot;</span><span class="punctuation">,</span> <span class="string">&quot;view_index_metadata&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Best-Practices-Summary"><a href="#Best-Practices-Summary" class="headerlink" title="Best Practices Summary"></a>Best Practices Summary</h2><h3 id="Do’s"><a href="#Do’s" class="headerlink" title="Do’s"></a>Do’s</h3><ul>
<li>Always use odd number of master-eligible nodes (3, 5, 7)</li>
<li>Implement proper monitoring and alerting</li>
<li>Use index templates for consistent settings</li>
<li>Regularly test disaster recovery procedures</li>
<li>Implement proper backup strategies</li>
</ul>
<h3 id="Don’ts"><a href="#Don’ts" class="headerlink" title="Don’ts"></a>Don’ts</h3><ul>
<li>Don’t set heap size above 32GB</li>
<li>Don’t disable swap without proper configuration</li>
<li>Don’t ignore yellow cluster status</li>
<li>Don’t use default settings in production</li>
<li>Don’t forget to monitor disk space</li>
</ul>
<h2 id="References-and-Additional-Resources"><a href="#References-and-Additional-Resources" class="headerlink" title="References and Additional Resources"></a>References and Additional Resources</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">Elasticsearch Official Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/tune-for-search-speed.html">Elasticsearch Performance Tuning Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/cloud/current/ec-getting-started.html">Elastic Cloud Architecture Best Practices</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/system-config.html">Production Deployment Considerations</a></li>
</ul>
<hr>
<p><em>This guide provides a comprehensive foundation for implementing and maintaining highly available Elasticsearch clusters in production environments. Regular updates and testing of these configurations are essential for maintaining optimal performance and reliability.</em></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/16/Design-Video-Image-Structure-Analysis-Platform/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/16/Design-Video-Image-Structure-Analysis-Platform/" class="post-title-link" itemprop="url">Design Video Image Structure Analysis Platform</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-16 19:28:03" itemprop="dateCreated datePublished" datetime="2025-06-16T19:28:03+08:00">2025-06-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-26 21:04:39" itemprop="dateModified" datetime="2025-06-26T21:04:39+08:00">2025-06-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system-design/" itemprop="url" rel="index"><span itemprop="name">system-design</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="System-Overview"><a href="#System-Overview" class="headerlink" title="System Overview"></a>System Overview</h2><p>The Video Image AI Structured Analysis Platform is a comprehensive solution designed to analyze video files, images, and real-time camera streams using advanced computer vision and machine learning algorithms. The platform extracts structured data about detected objects (persons, vehicles, bikes, motorbikes) and provides powerful search capabilities through multiple interfaces.</p>
<h3 id="Key-Capabilities"><a href="#Key-Capabilities" class="headerlink" title="Key Capabilities"></a>Key Capabilities</h3><ul>
<li>Real-time video stream processing from multiple cameras</li>
<li>Batch video file and image analysis</li>
<li>Object detection and attribute extraction</li>
<li>Distributed storage with similarity search</li>
<li>Scalable microservice architecture</li>
<li>Interactive web-based management interface</li>
</ul>
<h2 id="Architecture-Overview"><a href="#Architecture-Overview" class="headerlink" title="Architecture Overview"></a>Architecture Overview</h2><pre>
<code class="mermaid">
graph TB
subgraph &quot;Client Layer&quot;
    UI[Analysis Platform UI]
    API[REST APIs]
end

subgraph &quot;Application Services&quot;
    APS[Analysis Platform Service]
    TMS[Task Manager Service]
    SAS[Streaming Access Service]
    SAPS[Structure App Service]
    SSS[Storage And Search Service]
end

subgraph &quot;Message Queue&quot;
    KAFKA[Kafka Cluster]
end

subgraph &quot;Storage Layer&quot;
    REDIS[Redis Cache]
    ES[ElasticSearch]
    FASTDFS[FastDFS]
    VECTOR[Vector Database]
    ZK[Zookeeper]
end

subgraph &quot;External&quot;
    CAMERAS[IP Cameras]
    FILES[Video&#x2F;Image Files]
end

UI --&gt; APS
API --&gt; APS
APS --&gt; TMS
APS --&gt; SSS
TMS --&gt; ZK
SAS --&gt; CAMERAS
SAS --&gt; FILES
SAS --&gt; SAPS
SAPS --&gt; KAFKA
KAFKA --&gt; SSS
SSS --&gt; ES
SSS --&gt; FASTDFS
SSS --&gt; VECTOR
APS --&gt; REDIS
</code>
</pre>

<h2 id="Core-Services-Design"><a href="#Core-Services-Design" class="headerlink" title="Core Services Design"></a>Core Services Design</h2><h3 id="StreamingAccessService"><a href="#StreamingAccessService" class="headerlink" title="StreamingAccessService"></a>StreamingAccessService</h3><p>The StreamingAccessService manages real-time video streams from distributed cameras and handles video file processing.</p>
<h4 id="Key-Features"><a href="#Key-Features" class="headerlink" title="Key Features:"></a>Key Features:</h4><ul>
<li>Multi-protocol camera support (RTSP, HTTP, WebRTC)</li>
<li>Video transcoding for format compatibility</li>
<li>Geographic camera distribution tracking</li>
<li>Load balancing across processing nodes</li>
</ul>
<h4 id="Implementation-Example"><a href="#Implementation-Example" class="headerlink" title="Implementation Example:"></a>Implementation Example:</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StreamingAccessService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CameraRepository cameraRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> VideoTranscodingService transcodingService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startCameraStream</span><span class="params">(String cameraId)</span> &#123;</span><br><span class="line">        <span class="type">Camera</span> <span class="variable">camera</span> <span class="operator">=</span> cameraRepository.findById(cameraId);</span><br><span class="line">        </span><br><span class="line">        <span class="type">StreamConfig</span> <span class="variable">config</span> <span class="operator">=</span> StreamConfig.builder()</span><br><span class="line">            .url(camera.getRtspUrl())</span><br><span class="line">            .resolution(camera.getResolution())</span><br><span class="line">            .frameRate(camera.getFrameRate())</span><br><span class="line">            .build();</span><br><span class="line">            </span><br><span class="line">        <span class="type">StreamProcessor</span> <span class="variable">processor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StreamProcessor</span>(config);</span><br><span class="line">        processor.onFrameReceived(frame -&gt; &#123;</span><br><span class="line">            <span class="comment">// Send frame to StructureAppService</span></span><br><span class="line">            structureAppService.analyzeFrame(frame, camera.getLocation());</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        processor.start();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> List&lt;CameraInfo&gt; <span class="title function_">getCamerasInRegion</span><span class="params">(GeoLocation center, <span class="type">double</span> radius)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cameraRepository.findWithinRadius(center, radius)</span><br><span class="line">            .stream()</span><br><span class="line">            .map(<span class="built_in">this</span>::toCameraInfo)</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Question</strong>: <em>How would you handle camera connection failures and ensure high availability?</em></p>
<p><strong>Answer</strong>: Implement circuit breaker patterns, retry mechanisms with exponential backoff, health check endpoints, and failover to backup cameras. Use connection pooling and maintain camera status in Redis for quick status checks.</p>
<h3 id="StructureAppService"><a href="#StructureAppService" class="headerlink" title="StructureAppService"></a>StructureAppService</h3><p>This service performs the core AI analysis using computer vision models deployed on GPU-enabled infrastructure.</p>
<h4 id="Object-Detection-Pipeline"><a href="#Object-Detection-Pipeline" class="headerlink" title="Object Detection Pipeline:"></a>Object Detection Pipeline:</h4><pre>
<code class="mermaid">
flowchart LR
A[Input Frame] --&gt; B[Preprocessing]
B --&gt; C[Object Detection]
C --&gt; D[Attribute Extraction]
D --&gt; E[Structured Output]
E --&gt; F[Kafka Publisher]

subgraph &quot;AI Models&quot;
    G[YOLO V8 Detection]
    H[Age&#x2F;Gender Classification]
    I[Vehicle Recognition]
    J[Attribute Extraction]
end

C --&gt; G
D --&gt; H
D --&gt; I
D --&gt; J
</code>
</pre>
<p><strong>Object Analysis Specifications:</strong></p>
<p><em>Person Attributes:</em></p>
<ul>
<li>Age estimation (age ranges: 0-12, 13-17, 18-30, 31-50, 51-70, 70+)</li>
<li>Gender classification (male, female, unknown)</li>
<li>Height estimation using reference objects</li>
<li>Clothing color detection (top, bottom)</li>
<li>Body size estimation (small, medium, large)</li>
<li>Pose estimation for activity recognition</li>
</ul>
<p><em>Vehicle Attributes:</em></p>
<ul>
<li>License plate recognition using OCR</li>
<li>Vehicle type classification (sedan, SUV, truck, bus)</li>
<li>Color detection using color histograms</li>
<li>Brand recognition using CNN models</li>
<li>Seatbelt detection for driver safety compliance</li>
</ul>
<h4 id="Service-Implementation"><a href="#Service-Implementation" class="headerlink" title="Service Implementation:"></a>Service Implementation:</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StructureAppService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectDetectionModel objectDetectionModel;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AttributeExtractionService attributeService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> KafkaProducer&lt;String, AnalysisResult&gt; kafkaProducer;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">analyzeFrame</span><span class="params">(VideoFrame frame, GeoLocation location)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Preprocess frame</span></span><br><span class="line">            <span class="type">ProcessedFrame</span> <span class="variable">processed</span> <span class="operator">=</span> preprocessFrame(frame);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Detect objects</span></span><br><span class="line">            List&lt;DetectedObject&gt; objects = objectDetectionModel.detect(processed);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Extract attributes for each object</span></span><br><span class="line">            List&lt;StructuredObject&gt; structuredObjects = objects.stream()</span><br><span class="line">                .map(obj -&gt; extractAttributes(obj, processed))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Create analysis result</span></span><br><span class="line">            <span class="type">AnalysisResult</span> <span class="variable">result</span> <span class="operator">=</span> AnalysisResult.builder()</span><br><span class="line">                .timestamp(Instant.now())</span><br><span class="line">                .location(location)</span><br><span class="line">                .objects(structuredObjects)</span><br><span class="line">                .frameId(frame.getId())</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Send to Kafka</span></span><br><span class="line">            kafkaProducer.send(<span class="string">&quot;analysis-results&quot;</span>, result);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Analysis failed for frame: &#123;&#125;&quot;</span>, frame.getId(), e);</span><br><span class="line">            <span class="comment">// Send to dead letter queue</span></span><br><span class="line">            handleAnalysisFailure(frame, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> StructuredObject <span class="title function_">extractAttributes</span><span class="params">(DetectedObject object, ProcessedFrame frame)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (object.getType()) &#123;</span><br><span class="line">            <span class="keyword">case</span> PERSON:</span><br><span class="line">                <span class="keyword">return</span> extractPersonAttributes(object, frame);</span><br><span class="line">            <span class="keyword">case</span> VEHICLE:</span><br><span class="line">                <span class="keyword">return</span> extractVehicleAttributes(object, frame);</span><br><span class="line">            <span class="keyword">case</span> BIKE:</span><br><span class="line">            <span class="keyword">case</span> MOTORBIKE:</span><br><span class="line">                <span class="keyword">return</span> extractBikeAttributes(object, frame);</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> createBasicStructuredObject(object);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> PersonObject <span class="title function_">extractPersonAttributes</span><span class="params">(DetectedObject object, ProcessedFrame frame)</span> &#123;</span><br><span class="line">        <span class="type">Rectangle</span> <span class="variable">bbox</span> <span class="operator">=</span> object.getBoundingBox();</span><br><span class="line">        <span class="type">BufferedImage</span> <span class="variable">personImage</span> <span class="operator">=</span> frame.getSubImage(bbox);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> PersonObject.builder()</span><br><span class="line">            .id(UUID.randomUUID().toString())</span><br><span class="line">            .age(ageClassifier.predict(personImage))</span><br><span class="line">            .gender(genderClassifier.predict(personImage))</span><br><span class="line">            .height(estimateHeight(bbox, frame.getDepthInfo()))</span><br><span class="line">            .clothingColor(colorExtractor.extractClothingColor(personImage))</span><br><span class="line">            .trouserColor(colorExtractor.extractTrouserColor(personImage))</span><br><span class="line">            .size(estimateBodySize(bbox))</span><br><span class="line">            .confidence(object.getConfidence())</span><br><span class="line">            .bbox(bbox)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="GPU-Resource-Management"><a href="#GPU-Resource-Management" class="headerlink" title="GPU Resource Management:"></a>GPU Resource Management:</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GPUResourceManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Queue&lt;GPUTask&gt; taskQueue = <span class="keyword">new</span> <span class="title class_">ConcurrentLinkedQueue</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;GPUWorker&gt; workers;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initializeWorkers</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">gpuCount</span> <span class="operator">=</span> getAvailableGPUs();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; gpuCount; i++) &#123;</span><br><span class="line">            workers.add(<span class="keyword">new</span> <span class="title class_">GPUWorker</span>(i, taskQueue));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;AnalysisResult&gt; <span class="title function_">submitTask</span><span class="params">(VideoFrame frame)</span> &#123;</span><br><span class="line">        <span class="type">GPUTask</span> <span class="variable">task</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GPUTask</span>(frame);</span><br><span class="line">        taskQueue.offer(task);</span><br><span class="line">        <span class="keyword">return</span> task.getFuture();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Question</strong>: <em>How do you optimize GPU utilization for real-time video analysis?</em></p>
<p><strong>Answer</strong>: Use batch processing to maximize GPU throughput, implement dynamic batching based on queue depth, utilize GPU memory pooling, and employ model quantization. Monitor GPU metrics and auto-scale workers based on load.</p>
<h3 id="StorageAndSearchService"><a href="#StorageAndSearchService" class="headerlink" title="StorageAndSearchService"></a>StorageAndSearchService</h3><p>Manages distributed storage across ElasticSearch, FastDFS, and vector databases.</p>
<h4 id="ElasticSearch-Index-Mappings"><a href="#ElasticSearch-Index-Mappings" class="headerlink" title="ElasticSearch Index Mappings:"></a>ElasticSearch Index Mappings:</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;person_index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;geo_point&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;height&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;float&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;clothing_color&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;trouser_color&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;confidence&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;float&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;image_path&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;vector_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;bbox&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;width&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;height&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;vehicle_index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;geo_point&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;plate_number&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;brand&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;model&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;driver_seatbelt&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;boolean&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;vehicle_type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;confidence&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;float&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;image_path&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;vector_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;bike_index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;geo_point&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;rider_helmet&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;boolean&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;rider_count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;confidence&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;float&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;image_path&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;vector_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="Service-Implementation-1"><a href="#Service-Implementation-1" class="headerlink" title="Service Implementation:"></a>Service Implementation:</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StorageAndSearchService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ElasticsearchClient elasticsearchClient;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> FastDFSClient fastDFSClient;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> VectorDatabaseClient vectorClient;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@KafkaListener(topics = &quot;analysis-results&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processAnalysisResult</span><span class="params">(AnalysisResult result)</span> &#123;</span><br><span class="line">        result.getObjects().forEach(<span class="built_in">this</span>::storeObject);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">storeObject</span><span class="params">(StructuredObject object)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Store image in FastDFS</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">imagePath</span> <span class="operator">=</span> storeImage(object.getImage());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Store vector representation</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">vectorId</span> <span class="operator">=</span> storeVector(object.getImageVector());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Store structured data in ElasticSearch</span></span><br><span class="line">            storeInElasticSearch(object, imagePath, vectorId);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Failed to store object: &#123;&#125;&quot;</span>, object.getId(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">storeImage</span><span class="params">(BufferedImage image)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] imageBytes = convertToBytes(image);</span><br><span class="line">        <span class="keyword">return</span> fastDFSClient.uploadFile(imageBytes, <span class="string">&quot;jpg&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">storeVector</span><span class="params">(<span class="type">float</span>[] vector)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> vectorClient.store(vector, Map.of(</span><br><span class="line">            <span class="string">&quot;timestamp&quot;</span>, Instant.now().toString(),</span><br><span class="line">            <span class="string">&quot;type&quot;</span>, <span class="string">&quot;image_embedding&quot;</span></span><br><span class="line">        ));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> SearchResult&lt;PersonObject&gt; <span class="title function_">searchPersons</span><span class="params">(PersonSearchQuery query)</span> &#123;</span><br><span class="line">        BoolQuery.<span class="type">Builder</span> <span class="variable">boolQuery</span> <span class="operator">=</span> QueryBuilders.bool();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (query.getAge() != <span class="literal">null</span>) &#123;</span><br><span class="line">            boolQuery.must(QueryBuilders.range(r -&gt; r</span><br><span class="line">                .field(<span class="string">&quot;age&quot;</span>)</span><br><span class="line">                .gte(JsonData.of(query.getAge() - <span class="number">5</span>))</span><br><span class="line">                .lte(JsonData.of(query.getAge() + <span class="number">5</span>))));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (query.getGender() != <span class="literal">null</span>) &#123;</span><br><span class="line">            boolQuery.must(QueryBuilders.term(t -&gt; t</span><br><span class="line">                .field(<span class="string">&quot;gender&quot;</span>)</span><br><span class="line">                .value(query.getGender())));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (query.getLocation() != <span class="literal">null</span>) &#123;</span><br><span class="line">            boolQuery.must(QueryBuilders.geoDistance(g -&gt; g</span><br><span class="line">                .field(<span class="string">&quot;location&quot;</span>)</span><br><span class="line">                .location(l -&gt; l.latlon(query.getLocation()))</span><br><span class="line">                .distance(query.getRadius() + <span class="string">&quot;km&quot;</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> SearchRequest.of(s -&gt; s</span><br><span class="line">            .index(<span class="string">&quot;person_index&quot;</span>)</span><br><span class="line">            .query(boolQuery.build()._toQuery())</span><br><span class="line">            .size(query.getLimit())</span><br><span class="line">            .from(query.getOffset()));</span><br><span class="line">            </span><br><span class="line">        SearchResponse&lt;PersonObject&gt; response = elasticsearchClient.search(request, PersonObject.class);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> convertToSearchResult(response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> List&lt;SimilarObject&gt; <span class="title function_">findSimilarImages</span><span class="params">(BufferedImage queryImage, <span class="type">int</span> limit)</span> &#123;</span><br><span class="line">        <span class="type">float</span>[] queryVector = imageEncoder.encode(queryImage);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> vectorClient.similaritySearch(queryVector, limit)</span><br><span class="line">            .stream()</span><br><span class="line">            .map(<span class="built_in">this</span>::enrichWithMetadata)</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Question</strong>: <em>How do you ensure data consistency across multiple storage systems?</em></p>
<p><strong>Answer</strong>: Implement saga pattern for distributed transactions, use event sourcing with Kafka for eventual consistency, implement compensation actions for rollback scenarios, and maintain idempotency keys for retry safety.</p>
<h3 id="TaskManagerService"><a href="#TaskManagerService" class="headerlink" title="TaskManagerService"></a>TaskManagerService</h3><p>Coordinates task execution across distributed nodes using Zookeeper for coordination.</p>
<h4 id="Task-Management"><a href="#Task-Management" class="headerlink" title="Task Management:"></a>Task Management:</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TaskManagerService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CuratorFramework zookeeperClient;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> NodeResourceMonitor resourceMonitor;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TASKS_PATH</span> <span class="operator">=</span> <span class="string">&quot;/video-analysis/tasks&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NODES_PATH</span> <span class="operator">=</span> <span class="string">&quot;/video-analysis/nodes&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">createTask</span><span class="params">(AnalysisTask task)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">taskId</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">            <span class="type">String</span> <span class="variable">taskPath</span> <span class="operator">=</span> TASKS_PATH + <span class="string">&quot;/&quot;</span> + taskId;</span><br><span class="line">            </span><br><span class="line">            <span class="type">TaskInfo</span> <span class="variable">taskInfo</span> <span class="operator">=</span> TaskInfo.builder()</span><br><span class="line">                .id(taskId)</span><br><span class="line">                .type(task.getType())</span><br><span class="line">                .input(task.getInput())</span><br><span class="line">                .location(task.getLocation())</span><br><span class="line">                .status(TaskStatus.PENDING)</span><br><span class="line">                .createdAt(Instant.now())</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">            zookeeperClient.create()</span><br><span class="line">                .creatingParentsIfNeeded()</span><br><span class="line">                .withMode(CreateMode.PERSISTENT)</span><br><span class="line">                .forPath(taskPath, SerializationUtils.serialize(taskInfo));</span><br><span class="line">            </span><br><span class="line">            scheduleTask(taskId);</span><br><span class="line">            <span class="keyword">return</span> taskId;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TaskCreationException</span>(<span class="string">&quot;Failed to create task&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">scheduleTask</span><span class="params">(String taskId)</span> &#123;</span><br><span class="line">        <span class="comment">// Find best node based on resource availability</span></span><br><span class="line">        Optional&lt;NodeInfo&gt; bestNode = findBestAvailableNode();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (bestNode.isPresent()) &#123;</span><br><span class="line">            <span class="comment">// Create a distributed lock for task assignment</span></span><br><span class="line">            <span class="type">InterProcessMutex</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InterProcessMutex</span>(zookeeperClient, </span><br><span class="line">                <span class="string">&quot;/tasks/locks/&quot;</span> + task.getId());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                lock.acquire();</span><br><span class="line">                assignTaskToNode(taskId, bestNode.get());</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.release();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Queue task for later execution</span></span><br><span class="line">            queueTask(taskId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Optional&lt;NodeInfo&gt; <span class="title function_">findBestAvailableNode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;String&gt; nodes = zookeeperClient.getChildren().forPath(NODES_PATH);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> nodes.stream()</span><br><span class="line">                .map(<span class="built_in">this</span>::getNodeInfo)</span><br><span class="line">                .filter(Objects::nonNull)</span><br><span class="line">                .filter(node -&gt; node.getGpuUsage() &lt; <span class="number">0.8</span>) <span class="comment">// Less than 80% GPU usage</span></span><br><span class="line">                .max(Comparator.comparing(node -&gt; </span><br><span class="line">                    node.getAvailableGpuMemory() + node.getAvailableCpuCores()));</span><br><span class="line">                    </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Failed to find available node&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> Optional.empty();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleTaskCompletion</span><span class="params">(TaskCompletedEvent event)</span> &#123;</span><br><span class="line">        updateTaskStatus(event.getTaskId(), TaskStatus.COMPLETED);</span><br><span class="line">        releaseNodeResources(event.getNodeId());</span><br><span class="line">        scheduleQueuedTasks();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Node-Resource-Monitoring"><a href="#Node-Resource-Monitoring" class="headerlink" title="Node Resource Monitoring:"></a>Node Resource Monitoring:</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NodeResourceMonitor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 5000)</span> <span class="comment">// Every 5 seconds</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateNodeResources</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">NodeInfo</span> <span class="variable">nodeInfo</span> <span class="operator">=</span> getCurrentNodeInfo();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">nodePath</span> <span class="operator">=</span> NODES_PATH + <span class="string">&quot;/&quot;</span> + getNodeId();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (zookeeperClient.checkExists().forPath(nodePath) == <span class="literal">null</span>) &#123;</span><br><span class="line">                zookeeperClient.create()</span><br><span class="line">                    .creatingParentsIfNeeded()</span><br><span class="line">                    .withMode(CreateMode.EPHEMERAL)</span><br><span class="line">                    .forPath(nodePath, SerializationUtils.serialize(nodeInfo));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                zookeeperClient.setData()</span><br><span class="line">                    .forPath(nodePath, SerializationUtils.serialize(nodeInfo));</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Failed to update node resources&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> NodeInfo <span class="title function_">getCurrentNodeInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> NodeInfo.builder()</span><br><span class="line">            .id(getNodeId())</span><br><span class="line">            .cpuUsage(getCpuUsage())</span><br><span class="line">            .memoryUsage(getMemoryUsage())</span><br><span class="line">            .gpuUsage(getGpuUsage())</span><br><span class="line">            .availableGpuMemory(getAvailableGpuMemory())</span><br><span class="line">            .availableCpuCores(getAvailableCpuCores())</span><br><span class="line">            .lastHeartbeat(Instant.now())</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="AnalysisPlatformService"><a href="#AnalysisPlatformService" class="headerlink" title="AnalysisPlatformService"></a>AnalysisPlatformService</h3><p>Provides REST APIs for the frontend application with comprehensive caching strategies.</p>
<h4 id="API-Design"><a href="#API-Design" class="headerlink" title="API Design:"></a>API Design:</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/v1&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnalysisPlatformController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TaskManagerService taskManagerService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StorageAndSearchService searchService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Task Management APIs</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/tasks&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;TaskResponse&gt; <span class="title function_">createTask</span><span class="params">(<span class="meta">@RequestBody</span> CreateTaskRequest request)</span> &#123;</span><br><span class="line">        <span class="type">AnalysisTask</span> <span class="variable">task</span> <span class="operator">=</span> convertToTask(request);</span><br><span class="line">        <span class="type">String</span> <span class="variable">taskId</span> <span class="operator">=</span> taskManagerService.createTask(task);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(TaskResponse.builder()</span><br><span class="line">            .taskId(taskId)</span><br><span class="line">            .status(<span class="string">&quot;CREATED&quot;</span>)</span><br><span class="line">            .build());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/tasks/&#123;taskId&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@Cacheable(value = &quot;tasks&quot;, key = &quot;#taskId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;TaskInfo&gt; <span class="title function_">getTask</span><span class="params">(<span class="meta">@PathVariable</span> String taskId)</span> &#123;</span><br><span class="line">        <span class="type">TaskInfo</span> <span class="variable">task</span> <span class="operator">=</span> taskManagerService.getTask(taskId);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(task);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/tasks&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;PagedResult&lt;TaskInfo&gt;&gt; <span class="title function_">getTasks</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(defaultValue = &quot;0&quot;)</span> <span class="type">int</span> page,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(defaultValue = &quot;20&quot;)</span> <span class="type">int</span> size,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(required = false)</span> String status)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">TaskQuery</span> <span class="variable">query</span> <span class="operator">=</span> TaskQuery.builder()</span><br><span class="line">            .page(page)</span><br><span class="line">            .size(size)</span><br><span class="line">            .status(status)</span><br><span class="line">            .build();</span><br><span class="line">            </span><br><span class="line">        PagedResult&lt;TaskInfo&gt; tasks = taskManagerService.getTasks(query);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(tasks);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Camera Management APIs</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/cameras&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;CameraInfo&gt; <span class="title function_">createCamera</span><span class="params">(<span class="meta">@RequestBody</span> CreateCameraRequest request)</span> &#123;</span><br><span class="line">        <span class="type">CameraInfo</span> <span class="variable">camera</span> <span class="operator">=</span> cameraService.createCamera(request);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(camera);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/cameras/map&quot;)</span></span><br><span class="line">    <span class="meta">@Cacheable(value = &quot;camera-map&quot;, key = &quot;#center + &#x27;-&#x27; + #zoom&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;List&lt;CameraMapInfo&gt;&gt; <span class="title function_">getCamerasForMap</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam</span> String center,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam</span> <span class="type">int</span> zoom)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">GeoLocation</span> <span class="variable">centerPoint</span> <span class="operator">=</span> parseGeoLocation(center);</span><br><span class="line">        <span class="type">double</span> <span class="variable">radius</span> <span class="operator">=</span> calculateRadius(zoom);</span><br><span class="line">        </span><br><span class="line">        List&lt;CameraMapInfo&gt; cameras = cameraService.getCamerasInRegion(centerPoint, radius);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(cameras);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Search APIs</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/search/persons&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;SearchResult&lt;PersonObject&gt;&gt; <span class="title function_">searchPersons</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestBody</span> PersonSearchQuery query)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">cacheKey</span> <span class="operator">=</span> generateCacheKey(<span class="string">&quot;person-search&quot;</span>, query);</span><br><span class="line">        SearchResult&lt;PersonObject&gt; cached = getCachedResult(cacheKey);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (cached != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.ok(cached);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        SearchResult&lt;PersonObject&gt; result = searchService.searchPersons(query);</span><br><span class="line">        cacheResult(cacheKey, result, Duration.ofMinutes(<span class="number">5</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(result);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/search/vehicles&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;SearchResult&lt;VehicleObject&gt;&gt; <span class="title function_">searchVehicles</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestBody</span> VehicleSearchQuery query)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        SearchResult&lt;VehicleObject&gt; result = searchService.searchVehicles(query);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(result);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/search/similarity&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;List&lt;SimilarObject&gt;&gt; <span class="title function_">searchSimilar</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;image&quot;)</span> MultipartFile imageFile,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(defaultValue = &quot;10&quot;)</span> <span class="type">int</span> limit)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">BufferedImage</span> <span class="variable">image</span> <span class="operator">=</span> ImageIO.read(imageFile.getInputStream());</span><br><span class="line">            List&lt;SimilarObject&gt; similar = searchService.findSimilarImages(image, limit);</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.ok(similar);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.badRequest().build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Statistics APIs</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/stats/objects&quot;)</span></span><br><span class="line">    <span class="meta">@Cacheable(value = &quot;object-stats&quot;, key = &quot;#timeRange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;ObjectStatistics&gt; <span class="title function_">getObjectStatistics</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam</span> String timeRange)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">ObjectStatistics</span> <span class="variable">stats</span> <span class="operator">=</span> analyticsService.getObjectStatistics(timeRange);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(stats);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Complete-API-Specification"><a href="#Complete-API-Specification" class="headerlink" title="Complete API Specification:"></a>Complete API Specification:</h3><table>
<thead>
<tr>
<th>Endpoint</th>
<th>Method</th>
<th>Description</th>
<th>Cache TTL</th>
</tr>
</thead>
<tbody><tr>
<td><code>/api/v1/tasks</code></td>
<td>POST</td>
<td>Create analysis task</td>
<td>-</td>
</tr>
<tr>
<td><code>/api/v1/tasks/&#123;id&#125;</code></td>
<td>GET</td>
<td>Get task details</td>
<td>1 min</td>
</tr>
<tr>
<td><code>/api/v1/tasks</code></td>
<td>GET</td>
<td>List tasks with pagination</td>
<td>30 sec</td>
</tr>
<tr>
<td><code>/api/v1/cameras</code></td>
<td>POST</td>
<td>Register new camera</td>
<td>-</td>
</tr>
<tr>
<td><code>/api/v1/cameras/&#123;id&#125;</code></td>
<td>PUT</td>
<td>Update camera config</td>
<td>-</td>
</tr>
<tr>
<td><code>/api/v1/cameras/map</code></td>
<td>GET</td>
<td>Get cameras for map view</td>
<td>5 min</td>
</tr>
<tr>
<td><code>/api/v1/search/persons</code></td>
<td>POST</td>
<td>Search persons by attributes</td>
<td>5 min</td>
</tr>
<tr>
<td><code>/api/v1/search/vehicles</code></td>
<td>POST</td>
<td>Search vehicles by attributes</td>
<td>5 min</td>
</tr>
<tr>
<td><code>/api/v1/search/similarity</code></td>
<td>POST</td>
<td>Image similarity search</td>
<td>1 min</td>
</tr>
<tr>
<td><code>/api/v1/stats/objects</code></td>
<td>GET</td>
<td>Object detection statistics</td>
<td>10 min</td>
</tr>
</tbody></table>
<p><strong>Interview Question</strong>: <em>How do you handle API rate limiting and prevent abuse?</em></p>
<p><strong>Answer</strong>: Implement token bucket algorithm with Redis, use sliding window counters, apply different limits per user tier, implement circuit breakers for downstream services, and use API gateways for centralized rate limiting.</p>
<h2 id="Microservice-Architecture-with-Spring-Cloud-Alibaba"><a href="#Microservice-Architecture-with-Spring-Cloud-Alibaba" class="headerlink" title="Microservice Architecture with Spring Cloud Alibaba"></a>Microservice Architecture with Spring Cloud Alibaba</h2><h3 id="Service-Discovery-and-Configuration"><a href="#Service-Discovery-and-Configuration" class="headerlink" title="Service Discovery and Configuration:"></a>Service Discovery and Configuration:</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.yml for each service</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">analysis-platform-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">$&#123;NACOS_SERVER:localhost:8848&#125;</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">$&#123;NACOS_NAMESPACE:dev&#125;</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">$&#123;NACOS_SERVER:localhost:8848&#125;</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">$&#123;NACOS_NAMESPACE:dev&#125;</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">$&#123;SENTINEL_DASHBOARD:localhost:8080&#125;</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">$&#123;SPRING_PROFILES_ACTIVE:dev&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Circuit-Breaker-Configuration"><a href="#Circuit-Breaker-Configuration" class="headerlink" title="Circuit Breaker Configuration:"></a>Circuit Breaker Configuration:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VideoAnalysisServiceFallback</span> <span class="keyword">implements</span> <span class="title class_">VideoAnalysisService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AnalysisResult <span class="title function_">analyzeVideo</span><span class="params">(VideoRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> AnalysisResult.builder()</span><br><span class="line">            .status(<span class="string">&quot;FALLBACK&quot;</span>)</span><br><span class="line">            .message(<span class="string">&quot;Video analysis service temporarily unavailable&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient(</span></span><br><span class="line"><span class="meta">    name = &quot;structure-app-service&quot;, </span></span><br><span class="line"><span class="meta">    fallback = VideoAnalysisServiceFallback.class</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">VideoAnalysisService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/analyze&quot;)</span></span><br><span class="line">    AnalysisResult <span class="title function_">analyzeVideo</span><span class="params">(<span class="meta">@RequestBody</span> VideoRequest request)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Scalability-and-Performance-Optimization"><a href="#Scalability-and-Performance-Optimization" class="headerlink" title="Scalability and Performance Optimization"></a>Scalability and Performance Optimization</h2><h3 id="Horizontal-Scaling-Strategy"><a href="#Horizontal-Scaling-Strategy" class="headerlink" title="Horizontal Scaling Strategy:"></a>Horizontal Scaling Strategy:</h3><pre>
<code class="mermaid">
graph LR
subgraph &quot;Load Balancer&quot;
    LB[Nginx&#x2F;HAProxy]
end

subgraph &quot;API Gateway&quot;
    GW1[Gateway 1]
    GW2[Gateway 2]
    GW3[Gateway 3]
end

subgraph &quot;Analysis Platform Services&quot;
    APS1[Service 1]
    APS2[Service 2]
    APS3[Service 3]
end

subgraph &quot;Structure App Services&quot;
    SAS1[GPU Node 1]
    SAS2[GPU Node 2]
    SAS3[GPU Node 3]
end

LB --&gt; GW1
LB --&gt; GW2
LB --&gt; GW3

GW1 --&gt; APS1
GW2 --&gt; APS2
GW3 --&gt; APS3

APS1 --&gt; SAS1
APS2 --&gt; SAS2
APS3 --&gt; SAS3
</code>
</pre>

<h3 id="Auto-scaling-Configuration"><a href="#Auto-scaling-Configuration" class="headerlink" title="Auto-scaling Configuration:"></a>Auto-scaling Configuration:</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Kubernetes HPA configuration</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">analysis-platform-hpa</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">analysis-platform-service</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">20</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cpu</span></span><br><span class="line">      <span class="attr">target:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">Utilization</span></span><br><span class="line">        <span class="attr">averageUtilization:</span> <span class="number">70</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">memory</span></span><br><span class="line">      <span class="attr">target:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">Utilization</span></span><br><span class="line">        <span class="attr">averageUtilization:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h3 id="Caching-Strategy"><a href="#Caching-Strategy" class="headerlink" title="Caching Strategy:"></a>Caching Strategy:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheConfiguration</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CacheManager <span class="title function_">cacheManager</span><span class="params">()</span> &#123;</span><br><span class="line">        RedisCacheManager.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> RedisCacheManager</span><br><span class="line">            .RedisCacheManagerBuilder</span><br><span class="line">            .fromConnectionFactory(redisConnectionFactory())</span><br><span class="line">            .cacheDefaults(cacheConfiguration());</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> RedisCacheConfiguration <span class="title function_">cacheConfiguration</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> RedisCacheConfiguration.defaultCacheConfig()</span><br><span class="line">            .entryTtl(Duration.ofMinutes(<span class="number">10</span>))</span><br><span class="line">            .serializeKeysWith(RedisSerializationContext.SerializationPair</span><br><span class="line">                .fromSerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>()))</span><br><span class="line">            .serializeValuesWith(RedisSerializationContext.SerializationPair</span><br><span class="line">                .fromSerializer(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Frontend-Implementation"><a href="#Frontend-Implementation" class="headerlink" title="Frontend Implementation"></a>Frontend Implementation</h2><h3 id="Camera-Map-Integration"><a href="#Camera-Map-Integration" class="headerlink" title="Camera Map Integration:"></a>Camera Map Integration:</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// React component for camera map</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; useState, useEffect &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MapContainer</span>, <span class="title class_">TileLayer</span>, <span class="title class_">Marker</span>, <span class="title class_">Popup</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react-leaflet&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">CameraMap</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> [cameras, setCameras] = <span class="title function_">useState</span>([]);</span><br><span class="line">  <span class="keyword">const</span> [loading, setLoading] = <span class="title function_">useState</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">fetchCameras</span>();</span><br><span class="line">  &#125;, []);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">fetchCameras</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;/api/v1/cameras/map?center=39.9042,116.4074&amp;zoom=10&#x27;</span>);</span><br><span class="line">      <span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">      <span class="title function_">setCameras</span>(data);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Failed to fetch cameras:&#x27;</span>, error);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="title function_">setLoading</span>(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">MapContainer</span> <span class="attr">center</span>=<span class="string">&#123;[39.9042,</span> <span class="attr">116.4074</span>]&#125; <span class="attr">zoom</span>=<span class="string">&#123;10&#125;</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">height:</span> &#x27;<span class="attr">600px</span>&#x27; &#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">TileLayer</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">url</span>=<span class="string">&quot;https://&#123;s&#125;.tile.openstreetmap.org/&#123;z&#125;/&#123;x&#125;/&#123;y&#125;.png&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">attribution</span>=<span class="string">&#x27;<span class="symbol">&amp;copy;</span> OpenStreetMap contributors&#x27;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      /&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;cameras.map(camera =&gt; (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Marker</span> <span class="attr">key</span>=<span class="string">&#123;camera.id&#125;</span> <span class="attr">position</span>=<span class="string">&#123;[camera.latitude,</span> <span class="attr">camera.longitude</span>]&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Popup</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">h4</span>&gt;</span>&#123;camera.name&#125;<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">p</span>&gt;</span>Status: &#123;camera.status&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">p</span>&gt;</span>Location: &#123;camera.address&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> startAnalysis(camera.id)&#125;&gt;</span></span><br><span class="line"><span class="language-xml">                Start Analysis</span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">Popup</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Marker</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      ))&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">MapContainer</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="Search-Interface"><a href="#Search-Interface" class="headerlink" title="Search Interface:"></a>Search Interface:</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">SearchInterface</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> [searchType, setSearchType] = <span class="title function_">useState</span>(<span class="string">&#x27;person&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> [searchQuery, setSearchQuery] = <span class="title function_">useState</span>(&#123;&#125;);</span><br><span class="line">  <span class="keyword">const</span> [results, setResults] = <span class="title function_">useState</span>([]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleSearch</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> endpoint = <span class="string">`/api/v1/search/<span class="subst">$&#123;searchType&#125;</span>s`</span>;</span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(endpoint, &#123;</span><br><span class="line">      <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">      <span class="attr">headers</span>: &#123; <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span> &#125;,</span><br><span class="line">      <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(searchQuery)</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">    <span class="title function_">setResults</span>(data.<span class="property">items</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;search-interface&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;search-controls&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">select</span> <span class="attr">value</span>=<span class="string">&#123;searchType&#125;</span> <span class="attr">onChange</span>=<span class="string">&#123;(e)</span> =&gt;</span> setSearchType(e.target.value)&#125;&gt;</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;person&quot;</span>&gt;</span>Person<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;vehicle&quot;</span>&gt;</span>Vehicle<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;bike&quot;</span>&gt;</span>Bike<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        </span></span><br><span class="line"><span class="language-xml">        &#123;searchType === &#x27;person&#x27; &amp;&amp; (</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">PersonSearchForm</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">query</span>=<span class="string">&#123;searchQuery&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">onChange</span>=<span class="string">&#123;setSearchQuery&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          /&gt;</span></span></span><br><span class="line"><span class="language-xml">        )&#125;</span></span><br><span class="line"><span class="language-xml">        </span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleSearch&#125;</span>&gt;</span>Search<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      </span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">SearchResults</span> <span class="attr">results</span>=<span class="string">&#123;results&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Docker-Deployment-Configuration"><a href="#Docker-Deployment-Configuration" class="headerlink" title="Docker Deployment Configuration"></a>Docker Deployment Configuration</h2><h3 id="Multi-stage-Dockerfile"><a href="#Multi-stage-Dockerfile" class="headerlink" title="Multi-stage Dockerfile:"></a>Multi-stage Dockerfile:</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Analysis Platform Service</span></span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">17</span>-jdk-slim as builder</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> pom.xml .</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> src ./src</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> mvn clean package -DskipTests</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">17</span>-jre-slim</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y curl &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/target/analysis-platform-service.jar app.jar</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"><span class="keyword">HEALTHCHECK</span><span class="language-bash"> --interval=30s --<span class="built_in">timeout</span>=3s --start-period=5s --retries=3 \</span></span><br><span class="line"><span class="language-bash">    CMD curl -f http://localhost:8080/actuator/health || <span class="built_in">exit</span> 1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-jar&quot;</span>, <span class="string">&quot;app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h3 id="Structure-App-Service-GPU-enabled"><a href="#Structure-App-Service-GPU-enabled" class="headerlink" title="Structure App Service (GPU-enabled):"></a>Structure App Service (GPU-enabled):</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Structure App Service with GPU support</span></span><br><span class="line"><span class="keyword">FROM</span> nvidia/cuda:<span class="number">11.8</span>-devel-ubuntu20.<span class="number">04</span> as base</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install Python and dependencies</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y \</span></span><br><span class="line"><span class="language-bash">    python3.9 \</span></span><br><span class="line"><span class="language-bash">    python3-pip \</span></span><br><span class="line"><span class="language-bash">    python3-dev \</span></span><br><span class="line"><span class="language-bash">    build-essential \</span></span><br><span class="line"><span class="language-bash">    cmake \</span></span><br><span class="line"><span class="language-bash">    libopencv-dev \</span></span><br><span class="line"><span class="language-bash">    libglib2.0-0 \</span></span><br><span class="line"><span class="language-bash">    libsm6 \</span></span><br><span class="line"><span class="language-bash">    libxext6 \</span></span><br><span class="line"><span class="language-bash">    libxrender-dev \</span></span><br><span class="line"><span class="language-bash">    libgomp1 \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Install Python packages</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> requirements.txt .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip3 install --no-cache-dir -r requirements.txt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Install PyTorch with CUDA support</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy application code</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Download pre-trained models</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> python3 download_models.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8081</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;python3&quot;</span>, <span class="string">&quot;app.py&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h3 id="Docker-Compose-for-Development"><a href="#Docker-Compose-for-Development" class="headerlink" title="Docker Compose for Development:"></a>Docker Compose for Development:</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">zookeeper:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">confluentinc/cp-zookeeper:7.4.0</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">ZOOKEEPER_CLIENT_PORT:</span> <span class="number">2181</span></span><br><span class="line">      <span class="attr">ZOOKEEPER_TICK_TIME:</span> <span class="number">2000</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;2181:2181&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">zookeeper-data:/var/lib/zookeeper/data</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">kafka:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">confluentinc/cp-kafka:7.4.0</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">zookeeper</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9092:9092&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">KAFKA_BROKER_ID:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">KAFKA_ZOOKEEPER_CONNECT:</span> <span class="string">zookeeper:2181</span></span><br><span class="line">      <span class="attr">KAFKA_ADVERTISED_LISTENERS:</span> <span class="string">PLAINTEXT://localhost:9092</span></span><br><span class="line">      <span class="attr">KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">kafka-data:/var/lib/kafka/data</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">elasticsearch:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.elastic.co/elasticsearch/elasticsearch:8.9.0</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">discovery.type=single-node</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;ES_JAVA_OPTS=-Xms2g -Xmx2g&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.enabled=false</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9200:9200&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">elasticsearch-data:/usr/share/elasticsearch/data</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:7-alpine</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-data:/data</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">--appendonly</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">fastdfs-tracker:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">delron/fastdfs</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;22122:22122&quot;</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">tracker</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">fastdfs-tracker:/var/fdfs</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">fastdfs-storage:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">delron/fastdfs</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8888:8888&quot;</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">storage</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TRACKER_SERVER:</span> <span class="string">fastdfs-tracker:22122</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">fastdfs-storage:/var/fdfs</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">fastdfs-tracker</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">vector-db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">milvusdb/milvus:v2.3.0</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;19530:19530&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">ETCD_ENDPOINTS:</span> <span class="string">etcd:2379</span></span><br><span class="line">      <span class="attr">MINIO_ADDRESS:</span> <span class="string">minio:9000</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">etcd</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">minio</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">analysis-platform-service:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">./analysis-platform-service</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">SPRING_PROFILES_ACTIVE:</span> <span class="string">docker</span></span><br><span class="line">      <span class="attr">KAFKA_BOOTSTRAP_SERVERS:</span> <span class="string">kafka:9092</span></span><br><span class="line">      <span class="attr">REDIS_HOST:</span> <span class="string">redis</span></span><br><span class="line">      <span class="attr">ELASTICSEARCH_HOST:</span> <span class="string">elasticsearch</span></span><br><span class="line">      <span class="attr">ZOOKEEPER_CONNECT:</span> <span class="string">zookeeper:2181</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">kafka</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">elasticsearch</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">zookeeper</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">structure-app-service:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">./structure-app-service</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8081:8081&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">KAFKA_BOOTSTRAP_SERVERS:</span> <span class="string">kafka:9092</span></span><br><span class="line">      <span class="attr">REDIS_HOST:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">kafka</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">reservations:</span></span><br><span class="line">          <span class="attr">devices:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">driver:</span> <span class="string">nvidia</span></span><br><span class="line">              <span class="attr">count:</span> <span class="number">1</span></span><br><span class="line">              <span class="attr">capabilities:</span> [<span class="string">gpu</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">zookeeper-data:</span></span><br><span class="line">  <span class="attr">kafka-data:</span></span><br><span class="line">  <span class="attr">elasticsearch-data:</span></span><br><span class="line">  <span class="attr">redis-data:</span></span><br><span class="line">  <span class="attr">fastdfs-tracker:</span></span><br><span class="line">  <span class="attr">fastdfs-storage:</span></span><br></pre></td></tr></table></figure>

<h2 id="Performance-Optimization-Strategies"><a href="#Performance-Optimization-Strategies" class="headerlink" title="Performance Optimization Strategies"></a>Performance Optimization Strategies</h2><h3 id="Database-Query-Optimization"><a href="#Database-Query-Optimization" class="headerlink" title="Database Query Optimization:"></a>Database Query Optimization:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OptimizedPersonRepository</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ElasticsearchClient client;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> SearchResult&lt;PersonObject&gt; <span class="title function_">searchWithAggregations</span><span class="params">(PersonSearchQuery query)</span> &#123;</span><br><span class="line">        <span class="comment">// Use composite aggregations for better performance</span></span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> SearchRequest.of(s -&gt; s</span><br><span class="line">            .index(<span class="string">&quot;person_index&quot;</span>)</span><br><span class="line">            .query(buildQuery(query))</span><br><span class="line">            .aggregations(<span class="string">&quot;age_groups&quot;</span>, a -&gt; a</span><br><span class="line">                .histogram(h -&gt; h</span><br><span class="line">                    .field(<span class="string">&quot;age&quot;</span>)</span><br><span class="line">                    .interval(<span class="number">10.0</span>)))</span><br><span class="line">            .aggregations(<span class="string">&quot;gender_distribution&quot;</span>, a -&gt; a</span><br><span class="line">                .terms(t -&gt; t</span><br><span class="line">                    .field(<span class="string">&quot;gender&quot;</span>)</span><br><span class="line">                    .size(<span class="number">10</span>)))</span><br><span class="line">            .aggregations(<span class="string">&quot;location_clusters&quot;</span>, a -&gt; a</span><br><span class="line">                .geohashGrid(g -&gt; g</span><br><span class="line">                    .field(<span class="string">&quot;location&quot;</span>)</span><br><span class="line">                    .precision(<span class="number">5</span>)))</span><br><span class="line">            .size(query.getLimit())</span><br><span class="line">            .from(query.getOffset())</span><br><span class="line">            .sort(SortOptions.of(so -&gt; so</span><br><span class="line">                .field(f -&gt; f</span><br><span class="line">                    .field(<span class="string">&quot;timestamp&quot;</span>)</span><br><span class="line">                    .order(SortOrder.Desc)))));</span><br><span class="line">        </span><br><span class="line">        SearchResponse&lt;PersonObject&gt; response = client.search(request, PersonObject.class);</span><br><span class="line">        <span class="keyword">return</span> convertToSearchResult(response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Batch processing for bulk operations</span></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;Void&gt; <span class="title function_">bulkIndexPersons</span><span class="params">(List&lt;PersonObject&gt; persons)</span> &#123;</span><br><span class="line">        BulkRequest.<span class="type">Builder</span> <span class="variable">bulkBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BulkRequest</span>.Builder();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (PersonObject person : persons) &#123;</span><br><span class="line">            bulkBuilder.operations(op -&gt; op</span><br><span class="line">                .index(idx -&gt; idx</span><br><span class="line">                    .index(<span class="string">&quot;person_index&quot;</span>)</span><br><span class="line">                    .id(person.getId())</span><br><span class="line">                    .document(person)));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">BulkResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.bulk(bulkBuilder.build());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (response.errors()) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Bulk indexing errors: &#123;&#125;&quot;</span>, response.items().size());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.completedFuture(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Memory-and-CPU-Optimization"><a href="#Memory-and-CPU-Optimization" class="headerlink" title="Memory and CPU Optimization:"></a>Memory and CPU Optimization:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OptimizedImageProcessor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutorService imageProcessingPool;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectPool&lt;BufferedImage&gt; imagePool;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OptimizedImageProcessor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Create bounded thread pool for image processing</span></span><br><span class="line">        <span class="built_in">this</span>.imageProcessingPool = <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">            <span class="number">4</span>, <span class="comment">// core threads</span></span><br><span class="line">            Runtime.getRuntime().availableProcessors() * <span class="number">2</span>, <span class="comment">// max threads</span></span><br><span class="line">            <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">1000</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ThreadFactoryBuilder</span>()</span><br><span class="line">                .setNameFormat(<span class="string">&quot;image-processor-%d&quot;</span>)</span><br><span class="line">                .setDaemon(<span class="literal">true</span>)</span><br><span class="line">                .build(),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Object pool for reusing BufferedImage objects</span></span><br><span class="line">        <span class="built_in">this</span>.imagePool = <span class="keyword">new</span> <span class="title class_">GenericObjectPool</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">BufferedImageFactory</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;ProcessedImage&gt; <span class="title function_">processImageAsync</span><span class="params">(<span class="type">byte</span>[] imageData)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="type">BufferedImage</span> <span class="variable">image</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                image = imagePool.borrowObject();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Resize image to standard dimensions</span></span><br><span class="line">                <span class="type">BufferedImage</span> <span class="variable">resized</span> <span class="operator">=</span> resizeImage(imageData, <span class="number">640</span>, <span class="number">480</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Apply optimizations</span></span><br><span class="line">                <span class="keyword">return</span> ProcessedImage.builder()</span><br><span class="line">                    .image(resized)</span><br><span class="line">                    .metadata(extractMetadata(resized))</span><br><span class="line">                    .build();</span><br><span class="line">                    </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ImageProcessingException</span>(<span class="string">&quot;Failed to process image&quot;</span>, e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (image != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        imagePool.returnObject(image);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        log.warn(<span class="string">&quot;Failed to return image to pool&quot;</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, imageProcessingPool);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> BufferedImage <span class="title function_">resizeImage</span><span class="params">(<span class="type">byte</span>[] imageData, <span class="type">int</span> width, <span class="type">int</span> height)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(imageData)) &#123;</span><br><span class="line">            <span class="type">BufferedImage</span> <span class="variable">original</span> <span class="operator">=</span> ImageIO.read(is);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Use high-quality scaling</span></span><br><span class="line">            <span class="type">BufferedImage</span> <span class="variable">resized</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedImage</span>(width, height, BufferedImage.TYPE_INT_RGB);</span><br><span class="line">            <span class="type">Graphics2D</span> <span class="variable">g2d</span> <span class="operator">=</span> resized.createGraphics();</span><br><span class="line">            </span><br><span class="line">            g2d.setRenderingHint(RenderingHints.KEY_INTERPOLATION, </span><br><span class="line">                RenderingHints.VALUE_INTERPOLATION_BILINEAR);</span><br><span class="line">            g2d.setRenderingHint(RenderingHints.KEY_RENDERING, </span><br><span class="line">                RenderingHints.VALUE_RENDER_QUALITY);</span><br><span class="line">            </span><br><span class="line">            g2d.drawImage(original, <span class="number">0</span>, <span class="number">0</span>, width, height, <span class="literal">null</span>);</span><br><span class="line">            g2d.dispose();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> resized;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ImageProcessingException</span>(<span class="string">&quot;Failed to resize image&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Monitoring-and-Observability"><a href="#Monitoring-and-Observability" class="headerlink" title="Monitoring and Observability"></a>Monitoring and Observability</h2><h3 id="Comprehensive-Monitoring-Setup"><a href="#Comprehensive-Monitoring-Setup" class="headerlink" title="Comprehensive Monitoring Setup:"></a>Comprehensive Monitoring Setup:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SystemMetrics</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter videoAnalysisCounter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Timer analysisTimer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Gauge activeTasksGauge;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SystemMetrics</span><span class="params">(MeterRegistry meterRegistry)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.meterRegistry = meterRegistry;</span><br><span class="line">        <span class="built_in">this</span>.videoAnalysisCounter = Counter.builder(<span class="string">&quot;video.analysis.total&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Total number of video analysis requests&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;service&quot;</span>, <span class="string">&quot;structure-app&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.analysisTimer = Timer.builder(<span class="string">&quot;video.analysis.duration&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Video analysis processing time&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.activeTasksGauge = Gauge.builder(<span class="string">&quot;tasks.active&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Number of active analysis tasks&quot;</span>)</span><br><span class="line">            .register(meterRegistry, <span class="built_in">this</span>, SystemMetrics::getActiveTaskCount);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordAnalysis</span><span class="params">(String objectType, Duration duration, String result)</span> &#123;</span><br><span class="line">        videoAnalysisCounter.increment(</span><br><span class="line">            Tags.of(</span><br><span class="line">                <span class="string">&quot;object.type&quot;</span>, objectType,</span><br><span class="line">                <span class="string">&quot;result&quot;</span>, result</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        analysisTimer.record(duration);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> <span class="title function_">getActiveTaskCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> taskManagerService.getActiveTaskCount();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Distributed-Tracing"><a href="#Distributed-Tracing" class="headerlink" title="Distributed Tracing:"></a>Distributed Tracing:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TracedAnalysisController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Tracer tracer;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/analyze&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;AnalysisResult&gt; <span class="title function_">analyzeVideo</span><span class="params">(<span class="meta">@RequestBody</span> VideoRequest request)</span> &#123;</span><br><span class="line">        <span class="type">Span</span> <span class="variable">span</span> <span class="operator">=</span> tracer.nextSpan()</span><br><span class="line">            .name(<span class="string">&quot;video-analysis&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;video.size&quot;</span>, String.valueOf(request.getSize()))</span><br><span class="line">            .tag(<span class="string">&quot;video.format&quot;</span>, request.getFormat())</span><br><span class="line">            .start();</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">try</span> (Tracer.<span class="type">SpanInScope</span> <span class="variable">ws</span> <span class="operator">=</span> tracer.withSpanInScope(span)) &#123;</span><br><span class="line">            <span class="type">AnalysisResult</span> <span class="variable">result</span> <span class="operator">=</span> performAnalysis(request);</span><br><span class="line">            </span><br><span class="line">            span.tag(<span class="string">&quot;objects.detected&quot;</span>, String.valueOf(result.getObjectCount()));</span><br><span class="line">            span.tag(<span class="string">&quot;analysis.status&quot;</span>, result.getStatus());</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.ok(result);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            span.tag(<span class="string">&quot;error&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            span.end();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Health-Checks-and-Alerting"><a href="#Health-Checks-and-Alerting" class="headerlink" title="Health Checks and Alerting:"></a>Health Checks and Alerting:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomHealthIndicator</span> <span class="keyword">implements</span> <span class="title class_">HealthIndicator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GPUResourceMonitor gpuMonitor;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> KafkaHealthIndicator kafkaHealth;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Health <span class="title function_">health</span><span class="params">()</span> &#123;</span><br><span class="line">        Health.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Health</span>.Builder();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check GPU availability</span></span><br><span class="line">        <span class="keyword">if</span> (gpuMonitor.getAvailableGPUs() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> builder.down()</span><br><span class="line">                .withDetail(<span class="string">&quot;gpu&quot;</span>, <span class="string">&quot;No GPUs available&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check Kafka connectivity</span></span><br><span class="line">        <span class="keyword">if</span> (!kafkaHealth.isHealthy()) &#123;</span><br><span class="line">            <span class="keyword">return</span> builder.down()</span><br><span class="line">                .withDetail(<span class="string">&quot;kafka&quot;</span>, <span class="string">&quot;Kafka connection failed&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check memory usage</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">memoryUsage</span> <span class="operator">=</span> getMemoryUsage();</span><br><span class="line">        <span class="keyword">if</span> (memoryUsage &gt; <span class="number">0.9</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> builder.down()</span><br><span class="line">                .withDetail(<span class="string">&quot;memory&quot;</span>, <span class="string">&quot;Memory usage critical: &quot;</span> + memoryUsage)</span><br><span class="line">                .build();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> builder.up()</span><br><span class="line">            .withDetail(<span class="string">&quot;gpu.count&quot;</span>, gpuMonitor.getAvailableGPUs())</span><br><span class="line">            .withDetail(<span class="string">&quot;memory.usage&quot;</span>, memoryUsage)</span><br><span class="line">            .withDetail(<span class="string">&quot;kafka.status&quot;</span>, <span class="string">&quot;healthy&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Security-Implementation"><a href="#Security-Implementation" class="headerlink" title="Security Implementation"></a>Security Implementation</h2><h3 id="Authentication-and-Authorization"><a href="#Authentication-and-Authorization" class="headerlink" title="Authentication and Authorization:"></a>Authentication and Authorization:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityFilterChain <span class="title function_">filterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> http</span><br><span class="line">            .csrf().disable()</span><br><span class="line">            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span><br><span class="line">            .and()</span><br><span class="line">            .authorizeHttpRequests(auth -&gt; auth</span><br><span class="line">                .requestMatchers(<span class="string">&quot;/api/v1/public/**&quot;</span>).permitAll()</span><br><span class="line">                .requestMatchers(<span class="string">&quot;/actuator/health&quot;</span>).permitAll()</span><br><span class="line">                .requestMatchers(HttpMethod.POST, <span class="string">&quot;/api/v1/tasks&quot;</span>).hasRole(<span class="string">&quot;OPERATOR&quot;</span>)</span><br><span class="line">                .requestMatchers(HttpMethod.GET, <span class="string">&quot;/api/v1/search/**&quot;</span>).hasRole(<span class="string">&quot;VIEWER&quot;</span>)</span><br><span class="line">                .requestMatchers(<span class="string">&quot;/api/v1/admin/**&quot;</span>).hasRole(<span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">            )</span><br><span class="line">            .oauth2ResourceServer(oauth2 -&gt; oauth2</span><br><span class="line">                .jwt(jwt -&gt; jwt</span><br><span class="line">                    .jwtAuthenticationConverter(jwtAuthenticationConverter())</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JwtAuthenticationConverter <span class="title function_">jwtAuthenticationConverter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">JwtGrantedAuthoritiesConverter</span> <span class="variable">authoritiesConverter</span> <span class="operator">=</span> </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">JwtGrantedAuthoritiesConverter</span>();</span><br><span class="line">        authoritiesConverter.setAuthorityPrefix(<span class="string">&quot;ROLE_&quot;</span>);</span><br><span class="line">        authoritiesConverter.setAuthoritiesClaimName(<span class="string">&quot;authorities&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">JwtAuthenticationConverter</span> <span class="variable">converter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JwtAuthenticationConverter</span>();</span><br><span class="line">        converter.setJwtGrantedAuthoritiesConverter(authoritiesConverter);</span><br><span class="line">        <span class="keyword">return</span> converter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="API-Rate-Limiting"><a href="#API-Rate-Limiting" class="headerlink" title="API Rate Limiting:"></a>API Rate Limiting:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RateLimitingFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, RateLimitConfig&gt; rateLimitConfigs = Map.of(</span><br><span class="line">        <span class="string">&quot;/api/v1/search&quot;</span>, <span class="keyword">new</span> <span class="title class_">RateLimitConfig</span>(<span class="number">100</span>, Duration.ofMinutes(<span class="number">1</span>)),</span><br><span class="line">        <span class="string">&quot;/api/v1/tasks&quot;</span>, <span class="keyword">new</span> <span class="title class_">RateLimitConfig</span>(<span class="number">50</span>, Duration.ofMinutes(<span class="number">1</span>)),</span><br><span class="line">        <span class="string">&quot;/api/v1/similarity&quot;</span>, <span class="keyword">new</span> <span class="title class_">RateLimitConfig</span>(<span class="number">20</span>, Duration.ofMinutes(<span class="number">1</span>))</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, </span></span><br><span class="line"><span class="params">                        FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">httpRequest</span> <span class="operator">=</span> (HttpServletRequest) request;</span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">httpResponse</span> <span class="operator">=</span> (HttpServletResponse) response;</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">clientId</span> <span class="operator">=</span> extractClientId(httpRequest);</span><br><span class="line">        <span class="type">String</span> <span class="variable">endpoint</span> <span class="operator">=</span> httpRequest.getRequestURI();</span><br><span class="line">        </span><br><span class="line">        <span class="type">RateLimitConfig</span> <span class="variable">config</span> <span class="operator">=</span> getRateLimitConfig(endpoint);</span><br><span class="line">        <span class="keyword">if</span> (config != <span class="literal">null</span> &amp;&amp; !isRequestAllowed(clientId, endpoint, config)) &#123;</span><br><span class="line">            httpResponse.setStatus(HttpStatus.TOO_MANY_REQUESTS.value());</span><br><span class="line">            httpResponse.getWriter().write(<span class="string">&quot;Rate limit exceeded&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isRequestAllowed</span><span class="params">(String clientId, String endpoint, RateLimitConfig config)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;rate_limit:&quot;</span> + clientId + <span class="string">&quot;:&quot;</span> + endpoint;</span><br><span class="line">        <span class="type">String</span> <span class="variable">currentCount</span> <span class="operator">=</span> redisTemplate.opsForValue().get(key);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (currentCount == <span class="literal">null</span>) &#123;</span><br><span class="line">            redisTemplate.opsForValue().set(key, <span class="string">&quot;1&quot;</span>, config.getWindow());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> Integer.parseInt(currentCount);</span><br><span class="line">        <span class="keyword">if</span> (count &gt;= config.getLimit()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        redisTemplate.opsForValue().increment(key);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Advanced-Use-Cases-and-Examples"><a href="#Advanced-Use-Cases-and-Examples" class="headerlink" title="Advanced Use Cases and Examples"></a>Advanced Use Cases and Examples</h2><h3 id="Real-time-Traffic-Monitoring"><a href="#Real-time-Traffic-Monitoring" class="headerlink" title="Real-time Traffic Monitoring:"></a>Real-time Traffic Monitoring:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TrafficMonitoringService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleVehicleDetection</span><span class="params">(VehicleDetectedEvent event)</span> &#123;</span><br><span class="line">        <span class="type">VehicleObject</span> <span class="variable">vehicle</span> <span class="operator">=</span> event.getVehicle();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check for traffic violations</span></span><br><span class="line">        <span class="keyword">if</span> (isSpeedViolation(vehicle)) &#123;</span><br><span class="line">            publishSpeedViolationAlert(vehicle);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Update traffic flow statistics</span></span><br><span class="line">        updateTrafficFlow(vehicle.getLocation(), vehicle.getTimestamp());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check for congestion patterns</span></span><br><span class="line">        <span class="keyword">if</span> (detectTrafficCongestion(vehicle.getLocation())) &#123;</span><br><span class="line">            publishTrafficAlert(vehicle.getLocation());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isSpeedViolation</span><span class="params">(VehicleObject vehicle)</span> &#123;</span><br><span class="line">        <span class="type">SpeedLimit</span> <span class="variable">speedLimit</span> <span class="operator">=</span> getSpeedLimit(vehicle.getLocation());</span><br><span class="line">        <span class="type">double</span> <span class="variable">estimatedSpeed</span> <span class="operator">=</span> calculateSpeed(vehicle);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> estimatedSpeed &gt; speedLimit.getLimit() * <span class="number">1.1</span>; <span class="comment">// 10% tolerance</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">publishSpeedViolationAlert</span><span class="params">(VehicleObject vehicle)</span> &#123;</span><br><span class="line">        <span class="type">SpeedViolationAlert</span> <span class="variable">alert</span> <span class="operator">=</span> SpeedViolationAlert.builder()</span><br><span class="line">            .vehicleId(vehicle.getId())</span><br><span class="line">            .plateNumber(vehicle.getPlateNumber())</span><br><span class="line">            .location(vehicle.getLocation())</span><br><span class="line">            .timestamp(vehicle.getTimestamp())</span><br><span class="line">            .estimatedSpeed(calculateSpeed(vehicle))</span><br><span class="line">            .build();</span><br><span class="line">            </span><br><span class="line">        kafkaTemplate.send(<span class="string">&quot;speed-violations&quot;</span>, alert);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Crowd-Density-Analysis"><a href="#Crowd-Density-Analysis" class="headerlink" title="Crowd Density Analysis:"></a>Crowd Density Analysis:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CrowdAnalysisProcessor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CROWD_DENSITY_THRESHOLD</span> <span class="operator">=</span> <span class="number">10</span>; <span class="comment">// persons per square meter</span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 30000)</span> <span class="comment">// Every 30 seconds</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">analyzeCrowdDensity</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;CameraLocation&gt; locations = cameraService.getAllActiveLocations();</span><br><span class="line">        </span><br><span class="line">        locations.parallelStream().forEach(location -&gt; &#123;</span><br><span class="line">            List&lt;PersonObject&gt; recentDetections = getRecentPersonDetections(</span><br><span class="line">                location, Duration.ofMinutes(<span class="number">1</span>));</span><br><span class="line">            </span><br><span class="line">            <span class="type">double</span> <span class="variable">density</span> <span class="operator">=</span> calculateCrowdDensity(recentDetections, location.getArea());</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (density &gt; CROWD_DENSITY_THRESHOLD) &#123;</span><br><span class="line">                <span class="type">CrowdDensityAlert</span> <span class="variable">alert</span> <span class="operator">=</span> CrowdDensityAlert.builder()</span><br><span class="line">                    .location(location)</span><br><span class="line">                    .density(density)</span><br><span class="line">                    .personCount(recentDetections.size())</span><br><span class="line">                    .timestamp(Instant.now())</span><br><span class="line">                    .severity(determineSeverity(density))</span><br><span class="line">                    .build();</span><br><span class="line">                </span><br><span class="line">                alertService.publishAlert(alert);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Store density metrics</span></span><br><span class="line">            metricsService.recordCrowdDensity(location, density);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> <span class="title function_">calculateCrowdDensity</span><span class="params">(List&lt;PersonObject&gt; persons, <span class="type">double</span> area)</span> &#123;</span><br><span class="line">        <span class="comment">// Remove duplicates based on spatial proximity</span></span><br><span class="line">        List&lt;PersonObject&gt; uniquePersons = removeDuplicateDetections(persons);</span><br><span class="line">        <span class="keyword">return</span> uniquePersons.size() / area;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> List&lt;PersonObject&gt; <span class="title function_">removeDuplicateDetections</span><span class="params">(List&lt;PersonObject&gt; persons)</span> &#123;</span><br><span class="line">        List&lt;PersonObject&gt; unique = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (PersonObject person : persons) &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isDuplicate</span> <span class="operator">=</span> unique.stream()</span><br><span class="line">                .anyMatch(p -&gt; calculateDistance(p.getBbox(), person.getBbox()) &lt; <span class="number">50</span>);</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span> (!isDuplicate) &#123;</span><br><span class="line">                unique.add(person);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> unique;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Behavioral-Pattern-Recognition"><a href="#Behavioral-Pattern-Recognition" class="headerlink" title="Behavioral Pattern Recognition:"></a>Behavioral Pattern Recognition:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BehaviorAnalysisService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PersonTrackingService trackingService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">analyzePersonBehavior</span><span class="params">(List&lt;PersonObject&gt; personHistory)</span> &#123;</span><br><span class="line">        <span class="type">PersonTrajectory</span> <span class="variable">trajectory</span> <span class="operator">=</span> trackingService.buildTrajectory(personHistory);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Detect loitering behavior</span></span><br><span class="line">        <span class="keyword">if</span> (detectLoitering(trajectory)) &#123;</span><br><span class="line">            <span class="type">BehaviorAlert</span> <span class="variable">alert</span> <span class="operator">=</span> BehaviorAlert.builder()</span><br><span class="line">                .personId(trajectory.getPersonId())</span><br><span class="line">                .behaviorType(BehaviorType.LOITERING)</span><br><span class="line">                .location(trajectory.getCurrentLocation())</span><br><span class="line">                .duration(trajectory.getDuration())</span><br><span class="line">                .confidence(<span class="number">0.85</span>)</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">            alertService.publishBehaviorAlert(alert);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Detect suspicious movement patterns</span></span><br><span class="line">        <span class="keyword">if</span> (detectSuspiciousMovement(trajectory)) &#123;</span><br><span class="line">            <span class="type">BehaviorAlert</span> <span class="variable">alert</span> <span class="operator">=</span> BehaviorAlert.builder()</span><br><span class="line">                .personId(trajectory.getPersonId())</span><br><span class="line">                .behaviorType(BehaviorType.SUSPICIOUS_MOVEMENT)</span><br><span class="line">                .movementPattern(trajectory.getMovementPattern())</span><br><span class="line">                .confidence(calculateConfidence(trajectory))</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">            alertService.publishBehaviorAlert(alert);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">detectLoitering</span><span class="params">(PersonTrajectory trajectory)</span> &#123;</span><br><span class="line">        <span class="comment">// Check if person stayed in same area for extended period</span></span><br><span class="line">        <span class="type">Duration</span> <span class="variable">stationaryTime</span> <span class="operator">=</span> trajectory.getStationaryTime();</span><br><span class="line">        <span class="type">double</span> <span class="variable">movementRadius</span> <span class="operator">=</span> trajectory.getMovementRadius();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> stationaryTime.toMinutes() &gt; <span class="number">10</span> &amp;&amp; movementRadius &lt; <span class="number">5.0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">detectSuspiciousMovement</span><span class="params">(PersonTrajectory trajectory)</span> &#123;</span><br><span class="line">        <span class="comment">// Analyze movement patterns for suspicious behavior</span></span><br><span class="line">        <span class="type">MovementPattern</span> <span class="variable">pattern</span> <span class="operator">=</span> trajectory.getMovementPattern();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> pattern.hasErraticMovement() || </span><br><span class="line">               pattern.hasUnusualDirectionChanges() ||</span><br><span class="line">               pattern.isCounterFlow();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Interview-Questions-and-Insights"><a href="#Interview-Questions-and-Insights" class="headerlink" title="Interview Questions and Insights"></a>Interview Questions and Insights</h2><h3 id="Technical-Architecture-Questions"><a href="#Technical-Architecture-Questions" class="headerlink" title="Technical Architecture Questions:"></a>Technical Architecture Questions:</h3><p><strong>Q: How do you ensure data consistency when processing high-volume video streams?</strong></p>
<p><strong>A:</strong> Implement event sourcing with Kafka as the source of truth, use idempotent message processing with unique frame IDs, implement exactly-once semantics in Kafka consumers, and use distributed locking for critical sections. Apply the saga pattern for complex workflows and maintain event ordering through partitioning strategies.</p>
<p><strong>Q: How would you optimize GPU utilization across multiple analysis nodes?</strong></p>
<p><strong>A:</strong> Implement dynamic batching to maximize GPU throughput, use GPU memory pooling to reduce allocation overhead, implement model quantization for faster inference, use multiple streams per GPU for concurrent processing, and implement intelligent load balancing based on GPU memory and compute utilization.</p>
<p><strong>Q: How do you handle camera failures and ensure continuous monitoring?</strong></p>
<p><strong>A:</strong> Implement health checks with circuit breakers, maintain redundant camera coverage for critical areas, use automatic failover mechanisms, implement camera status monitoring with alerting, and maintain a hot standby system for critical infrastructure.</p>
<h3 id="Scalability-and-Performance-Questions"><a href="#Scalability-and-Performance-Questions" class="headerlink" title="Scalability and Performance Questions:"></a>Scalability and Performance Questions:</h3><p><strong>Q: How would you scale this system to handle 10,000 concurrent camera streams?</strong></p>
<p><strong>A:</strong> Implement horizontal scaling with container orchestration (Kubernetes), use streaming data processing frameworks (Apache Flink&#x2F;Storm), implement distributed caching strategies, use database sharding and read replicas, implement edge computing for preprocessing, and use CDN for static content delivery.</p>
<p><strong>Q: How do you optimize search performance for billions of detection records?</strong></p>
<p><strong>A:</strong> Implement data partitioning by time and location, use Elasticsearch with proper index management, implement caching layers with Redis, use approximate algorithms for similarity search, implement data archiving strategies, and use search result pagination with cursor-based pagination.</p>
<h3 id="Data-Management-Questions"><a href="#Data-Management-Questions" class="headerlink" title="Data Management Questions:"></a>Data Management Questions:</h3><p><strong>Q: How do you handle privacy and data retention in video analytics?</strong></p>
<p><strong>A:</strong> Implement data anonymization techniques, use automatic data expiration policies, implement role-based access controls, use encryption for data at rest and in transit, implement audit logging for data access, and ensure compliance with privacy regulations (GDPR, CCPA).</p>
<p><strong>Q: How would you implement real-time similarity search for millions of face vectors?</strong></p>
<p><strong>A:</strong> Use approximate nearest neighbor algorithms (LSH, FAISS), implement hierarchical indexing, use vector quantization techniques, implement distributed vector databases (Milvus, Pinecone), use GPU acceleration for vector operations, and implement caching for frequently accessed vectors.</p>
<h2 id="External-Resources-and-References"><a href="#External-Resources-and-References" class="headerlink" title="External Resources and References"></a>External Resources and References</h2><h3 id="Technical-Documentation"><a href="#Technical-Documentation" class="headerlink" title="Technical Documentation:"></a>Technical Documentation:</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">Elasticsearch Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://kafka.apache.org/documentation/">Kafka Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html">Spring Cloud Alibaba</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/happyfish100/fastdfs">FastDFS Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://milvus.io/docs">Milvus Vector Database</a></li>
</ul>
<h3 id="AI-ML-Resources"><a href="#AI-ML-Resources" class="headerlink" title="AI&#x2F;ML Resources:"></a>AI&#x2F;ML Resources:</h3><ul>
<li><a target="_blank" rel="noopener" href="https://docs.ultralytics.com/">YOLOv8 Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.opencv.org/">OpenCV Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://pytorch.org/docs/stable/index.html">PyTorch Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/tensorflow/models">TensorFlow Model Garden</a></li>
</ul>
<h3 id="Monitoring-and-Observability-1"><a href="#Monitoring-and-Observability-1" class="headerlink" title="Monitoring and Observability:"></a>Monitoring and Observability:</h3><ul>
<li><a target="_blank" rel="noopener" href="https://prometheus.io/docs/">Prometheus Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://grafana.com/docs/">Grafana Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jaegertracing.io/docs/">Jaeger Tracing</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html">Spring Boot Actuator</a></li>
</ul>
<h3 id="Container-Orchestration"><a href="#Container-Orchestration" class="headerlink" title="Container Orchestration:"></a>Container Orchestration:</h3><ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/">Kubernetes Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/">Docker Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://helm.sh/docs/">Helm Charts</a></li>
</ul>
<p>This comprehensive platform design provides a production-ready solution for video analytics with proper scalability, performance optimization, and maintainability considerations. The architecture supports both small-scale deployments and large-scale enterprise installations through its modular design and containerized deployment strategy.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/16/Elasticsearch-Underlying-Principles-Deep-Dive/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/16/Elasticsearch-Underlying-Principles-Deep-Dive/" class="post-title-link" itemprop="url">Elasticsearch Underlying Principles Deep Dive</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-16 16:35:40 / Modified: 16:36:36" itemprop="dateCreated datePublished" datetime="2025-06-16T16:35:40+08:00">2025-06-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/elasticsearch/" itemprop="url" rel="index"><span itemprop="name">elasticsearch</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Understanding-Inverted-Index-The-Heart-of-Search"><a href="#Understanding-Inverted-Index-The-Heart-of-Search" class="headerlink" title="Understanding Inverted Index: The Heart of Search"></a>Understanding Inverted Index: The Heart of Search</h2><p>The inverted index is Elasticsearch’s fundamental data structure that enables lightning-fast full-text search. Unlike a traditional database index that maps record IDs to field values, an inverted index maps each unique term to a list of documents containing that term.</p>
<h3 id="How-Inverted-Index-Works"><a href="#How-Inverted-Index-Works" class="headerlink" title="How Inverted Index Works"></a>How Inverted Index Works</h3><p>Consider a simple example with three documents:</p>
<ul>
<li>Document 1: “The quick brown fox”</li>
<li>Document 2: “The brown dog”</li>
<li>Document 3: “A quick fox jumps”</li>
</ul>
<p>The inverted index would look like:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Term     | Document IDs | Positions</span><br><span class="line">---------|-------------|----------</span><br><span class="line">the      | [1, 2]      | [1:0, 2:0]</span><br><span class="line">quick    | [1, 3]      | [1:1, 3:1]</span><br><span class="line">brown    | [1, 2]      | [1:2, 2:1]</span><br><span class="line">fox      | [1, 3]      | [1:3, 3:2]</span><br><span class="line">dog      | [2]         | [2:2]</span><br><span class="line">a        | [3]         | [3:0]</span><br><span class="line">jumps    | [3]         | [3:3]</span><br></pre></td></tr></table></figure>

<h3 id="Implementation-Details"><a href="#Implementation-Details" class="headerlink" title="Implementation Details"></a>Implementation Details</h3><p>Elasticsearch implements inverted indexes using several sophisticated techniques:</p>
<p><strong>Term Dictionary</strong>: Stores all unique terms in sorted order<br><strong>Posting Lists</strong>: For each term, maintains a list of documents containing that term<br><strong>Term Frequencies</strong>: Tracks how often each term appears in each document<br><strong>Positional Information</strong>: Stores exact positions for phrase queries</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index_options&quot;</span><span class="punctuation">:</span> <span class="string">&quot;positions&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“Can you explain why Elasticsearch is faster than traditional SQL databases for text search?”</em> The answer lies in the inverted index structure - instead of scanning entire documents, Elasticsearch directly maps search terms to relevant documents.</p>
<h2 id="Text-vs-Keyword-Understanding-Field-Types"><a href="#Text-vs-Keyword-Understanding-Field-Types" class="headerlink" title="Text vs Keyword: Understanding Field Types"></a>Text vs Keyword: Understanding Field Types</h2><p>The distinction between Text and Keyword fields is crucial for proper data modeling and search behavior.</p>
<h3 id="Text-Fields"><a href="#Text-Fields" class="headerlink" title="Text Fields"></a>Text Fields</h3><p>Text fields are analyzed - they go through tokenization, normalization, and other transformations:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;product_description&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;keyword&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ignore_above&quot;</span><span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Analysis Process for Text Fields</strong>:</p>
<ol>
<li><strong>Tokenization</strong>: “iPhone 13 Pro Max” → [“iPhone”, “13”, “Pro”, “Max”]</li>
<li><strong>Lowercase Filter</strong>: [“iphone”, “13”, “pro”, “max”]</li>
<li><strong>Stop Words Removal</strong>: (if configured)</li>
<li><strong>Stemming</strong>: (if configured) [“iphon”, “13”, “pro”, “max”]</li>
</ol>
<h3 id="Keyword-Fields"><a href="#Keyword-Fields" class="headerlink" title="Keyword Fields"></a>Keyword Fields</h3><p>Keyword fields are stored as-is, without analysis:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;product_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Use-Cases-Comparison"><a href="#Use-Cases-Comparison" class="headerlink" title="Use Cases Comparison"></a>Use Cases Comparison</h3><table>
<thead>
<tr>
<th>Scenario</th>
<th>Text Field</th>
<th>Keyword Field</th>
</tr>
</thead>
<tbody><tr>
<td>Full-text search</td>
<td>✅ “search iPhone” matches “iPhone 13”</td>
<td>❌ Exact match only</td>
</tr>
<tr>
<td>Aggregations</td>
<td>❌ Analyzed terms cause issues</td>
<td>✅ Perfect for grouping</td>
</tr>
<tr>
<td>Sorting</td>
<td>❌ Unreliable due to analysis</td>
<td>✅ Lexicographic sorting</td>
</tr>
<tr>
<td>Exact matching</td>
<td>❌ “iPhone-13” ≠ “iPhone 13”</td>
<td>✅ “iPhone-13” &#x3D; “iPhone-13”</td>
</tr>
</tbody></table>
<p><strong>Interview Insight</strong>: <em>“When would you use multi-fields?”</em> Multi-fields allow the same data to be indexed in multiple ways - as both text (for search) and keyword (for aggregations and sorting).</p>
<h2 id="Posting-Lists-Trie-Trees-and-FST"><a href="#Posting-Lists-Trie-Trees-and-FST" class="headerlink" title="Posting Lists, Trie Trees, and FST"></a>Posting Lists, Trie Trees, and FST</h2><h3 id="Posting-Lists"><a href="#Posting-Lists" class="headerlink" title="Posting Lists"></a>Posting Lists</h3><p>Posting lists are the core data structure that stores document IDs for each term. Elasticsearch optimizes these lists using several techniques:</p>
<p><strong>Delta Compression</strong>: Instead of storing absolute document IDs, store differences:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Original: [1, 5, 8, 12, 15]</span><br><span class="line">Compressed: [1, +4, +3, +4, +3]</span><br></pre></td></tr></table></figure>

<p><strong>Variable Byte Encoding</strong>: Uses fewer bytes for smaller numbers<br><strong>Skip Lists</strong>: Enable faster intersection operations for AND queries</p>
<h3 id="Trie-Trees-Prefix-Trees"><a href="#Trie-Trees-Prefix-Trees" class="headerlink" title="Trie Trees (Prefix Trees)"></a>Trie Trees (Prefix Trees)</h3><p>Trie trees optimize prefix-based operations and are used in Elasticsearch for:</p>
<ul>
<li>Autocomplete functionality</li>
<li>Wildcard queries</li>
<li>Range queries on terms</li>
</ul>
<pre>
<code class="mermaid">
graph TD
A[Root] --&gt; B[c]
A --&gt; C[s]
B --&gt; D[a]
B --&gt; E[o]
D --&gt; F[r]
D --&gt; G[t]
F --&gt; H[car]
G --&gt; I[cat]
E --&gt; J[o]
J --&gt; K[cool]
C --&gt; L[u]
L --&gt; M[n]
M --&gt; N[sun]
</code>
</pre>

<h3 id="Finite-State-Transducers-FST"><a href="#Finite-State-Transducers-FST" class="headerlink" title="Finite State Transducers (FST)"></a>Finite State Transducers (FST)</h3><p>FST is Elasticsearch’s secret weapon for memory-efficient term dictionaries. It combines the benefits of tries with minimal memory usage.</p>
<p><strong>Benefits of FST</strong>:</p>
<ul>
<li><strong>Memory Efficient</strong>: Shares common prefixes and suffixes</li>
<li><strong>Fast Lookups</strong>: O(k) complexity where k is key length</li>
<li><strong>Ordered Iteration</strong>: Maintains lexicographic order</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;prefix&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;elastics&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“How does Elasticsearch handle memory efficiency for large vocabularies?”</em> FST allows Elasticsearch to store millions of terms using minimal memory by sharing common character sequences.</p>
<h2 id="Data-Writing-Process-in-Elasticsearch-Cluster"><a href="#Data-Writing-Process-in-Elasticsearch-Cluster" class="headerlink" title="Data Writing Process in Elasticsearch Cluster"></a>Data Writing Process in Elasticsearch Cluster</h2><p>Understanding the write path is crucial for optimizing indexing performance and ensuring data durability.</p>
<h3 id="Write-Process-Overview"><a href="#Write-Process-Overview" class="headerlink" title="Write Process Overview"></a>Write Process Overview</h3><pre>
<code class="mermaid">
sequenceDiagram
participant Client
participant Coordinating Node
participant Primary Shard
participant Replica Shard
participant Translog
participant Lucene

Client-&gt;&gt;Coordinating Node: Index Request
Coordinating Node-&gt;&gt;Primary Shard: Route to Primary
Primary Shard-&gt;&gt;Translog: Write to Translog
Primary Shard-&gt;&gt;Lucene: Add to In-Memory Buffer
Primary Shard-&gt;&gt;Replica Shard: Replicate to Replicas
Replica Shard-&gt;&gt;Translog: Write to Translog
Replica Shard-&gt;&gt;Lucene: Add to In-Memory Buffer
Primary Shard-&gt;&gt;Coordinating Node: Success Response
Coordinating Node-&gt;&gt;Client: Acknowledge
</code>
</pre>

<h3 id="Detailed-Write-Steps"><a href="#Detailed-Write-Steps" class="headerlink" title="Detailed Write Steps"></a>Detailed Write Steps</h3><p><strong>Step 1: Document Routing</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shard_id = <span class="built_in">hash</span>(routing_value) % number_of_primary_shards</span><br><span class="line"><span class="comment"># Default routing_value is document _id</span></span><br></pre></td></tr></table></figure>

<p><strong>Step 2: Primary Shard Processing</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;products&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_routing&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user123&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;iPhone 13&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">999</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;electronics&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Step 3: Translog Write</strong><br>The transaction log ensures durability before data reaches disk:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Translog configuration</span></span><br><span class="line">PUT /my_index/_settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;translog&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;sync_interval&quot;</span>: <span class="string">&quot;5s&quot;</span>,</span><br><span class="line">    <span class="string">&quot;durability&quot;</span>: <span class="string">&quot;request&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Step 4: Replication</strong><br>Documents are replicated to replica shards for high availability:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.write.wait_for_active_shards&quot;</span><span class="punctuation">:</span> <span class="string">&quot;all&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Write-Performance-Optimization"><a href="#Write-Performance-Optimization" class="headerlink" title="Write Performance Optimization"></a>Write Performance Optimization</h3><p><strong>Bulk Indexing Best Practices</strong>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;products&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Product 1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;products&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Product 2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Optimal Bulk Size</strong>: 5-15 MB per bulk request<br><strong>Thread Pool Tuning</strong>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">thread_pool:</span></span><br><span class="line">  <span class="attr">write:</span></span><br><span class="line">    <span class="attr">size:</span> <span class="number">8</span></span><br><span class="line">    <span class="attr">queue_size:</span> <span class="number">200</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“How would you optimize Elasticsearch for high write throughput?”</em> Key strategies include bulk indexing, increasing refresh intervals, using appropriate replica counts, and tuning thread pools.</p>
<h2 id="Refresh-Flush-and-Fsync-Operations"><a href="#Refresh-Flush-and-Fsync-Operations" class="headerlink" title="Refresh, Flush, and Fsync Operations"></a>Refresh, Flush, and Fsync Operations</h2><p>These operations manage the transition of data from memory to disk and control search visibility.</p>
<h3 id="Refresh-Operation"><a href="#Refresh-Operation" class="headerlink" title="Refresh Operation"></a>Refresh Operation</h3><p>Refresh makes documents searchable by moving them from the in-memory buffer to the filesystem cache.</p>
<pre>
<code class="mermaid">
graph LR
A[In-Memory Buffer] --&gt;|Refresh| B[Filesystem Cache]
B --&gt;|Flush| C[Disk Segments]
D[Translog] --&gt;|Flush| E[Disk]

subgraph &quot;Search Visible&quot;
    B
    C
end
</code>
</pre>

<p><strong>Refresh Configuration</strong>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30s&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.max_refresh_listeners&quot;</span><span class="punctuation">:</span> <span class="number">1000</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Manual Refresh</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /my_index/_refresh</span><br></pre></td></tr></table></figure>

<p><strong>Real-time Use Case</strong>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /logs/_doc/<span class="number">1</span>?refresh=<span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-01-15T10:30:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ERROR&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Database connection failed&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Flush-Operation"><a href="#Flush-Operation" class="headerlink" title="Flush Operation"></a>Flush Operation</h3><p>Flush persists the translog to disk and creates new Lucene segments.</p>
<p><strong>Flush Triggers</strong>:</p>
<ul>
<li>Translog size exceeds threshold (default: 512MB)</li>
<li>Translog age exceeds threshold (default: 30 minutes)</li>
<li>Manual flush operation</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;translog.flush_threshold_size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1gb&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;translog.sync_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5s&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;translog.durability&quot;</span><span class="punctuation">:</span> <span class="string">&quot;request&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Manual Flush</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /my_index/_flush</span><br><span class="line">POST /_flush?wait_if_ongoing=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="Fsync-Operation"><a href="#Fsync-Operation" class="headerlink" title="Fsync Operation"></a>Fsync Operation</h3><p>Fsync ensures data is physically written to disk storage.</p>
<p><strong>Fsync Configuration</strong>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;translog.durability&quot;</span><span class="punctuation">:</span> <span class="string">&quot;async&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;translog.sync_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5s&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Performance-Impact-Analysis"><a href="#Performance-Impact-Analysis" class="headerlink" title="Performance Impact Analysis"></a>Performance Impact Analysis</h3><table>
<thead>
<tr>
<th>Operation</th>
<th>Frequency</th>
<th>Performance Impact</th>
<th>Data Safety</th>
</tr>
</thead>
<tbody><tr>
<td>Refresh</td>
<td>High (1s default)</td>
<td>Medium</td>
<td>No durability</td>
</tr>
<tr>
<td>Flush</td>
<td>Low (30m or 512MB)</td>
<td>High</td>
<td>Full durability</td>
</tr>
<tr>
<td>Fsync</td>
<td>Configurable</td>
<td>High</td>
<td>Hardware dependent</td>
</tr>
</tbody></table>
<h3 id="Production-Best-Practices"><a href="#Production-Best-Practices" class="headerlink" title="Production Best Practices"></a>Production Best Practices</h3><p><strong>High Throughput Indexing</strong>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;60s&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;translog.durability&quot;</span><span class="punctuation">:</span> <span class="string">&quot;async&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;translog.sync_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30s&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Near Real-time Search</strong>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1s&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;translog.durability&quot;</span><span class="punctuation">:</span> <span class="string">&quot;request&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“Explain the trade-offs between search latency and indexing performance.”</em> Frequent refreshes provide near real-time search but impact indexing throughput. Adjust refresh_interval based on your use case - use longer intervals for high-volume indexing and shorter for real-time requirements.</p>
<h2 id="Advanced-Concepts-and-Optimizations"><a href="#Advanced-Concepts-and-Optimizations" class="headerlink" title="Advanced Concepts and Optimizations"></a>Advanced Concepts and Optimizations</h2><h3 id="Segment-Merging"><a href="#Segment-Merging" class="headerlink" title="Segment Merging"></a>Segment Merging</h3><p>Elasticsearch continuously merges smaller segments into larger ones:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;index.merge.policy.max_merge_at_once&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.merge.policy.segments_per_tier&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.merge.scheduler.max_thread_count&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Force-Merge-for-Read-Only-Indices"><a href="#Force-Merge-for-Read-Only-Indices" class="headerlink" title="Force Merge for Read-Only Indices"></a>Force Merge for Read-Only Indices</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /old_logs/_forcemerge?max_num_segments=1</span><br></pre></td></tr></table></figure>

<h3 id="Circuit-Breakers"><a href="#Circuit-Breakers" class="headerlink" title="Circuit Breakers"></a>Circuit Breakers</h3><p>Prevent OutOfMemory errors during operations:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;persistent&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;indices.breaker.total.limit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;70%&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;indices.breaker.fielddata.limit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;40%&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;indices.breaker.request.limit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30%&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Monitoring-and-Troubleshooting"><a href="#Monitoring-and-Troubleshooting" class="headerlink" title="Monitoring and Troubleshooting"></a>Monitoring and Troubleshooting</h2><h3 id="Key-Metrics-to-Monitor"><a href="#Key-Metrics-to-Monitor" class="headerlink" title="Key Metrics to Monitor"></a>Key Metrics to Monitor</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Index stats</span></span><br><span class="line">GET /_stats/indexing,search,merge,refresh,flush</span><br><span class="line"></span><br><span class="line"><span class="comment"># Segment information</span></span><br><span class="line">GET /my_index/_segments</span><br><span class="line"></span><br><span class="line"><span class="comment"># Translog stats</span></span><br><span class="line">GET /_stats/translog</span><br></pre></td></tr></table></figure>

<h3 id="Common-Issues-and-Solutions"><a href="#Common-Issues-and-Solutions" class="headerlink" title="Common Issues and Solutions"></a>Common Issues and Solutions</h3><p><strong>Slow Indexing</strong>:</p>
<ul>
<li>Check bulk request size</li>
<li>Monitor merge operations</li>
<li>Verify disk I&#x2F;O capacity</li>
</ul>
<p><strong>Memory Issues</strong>:</p>
<ul>
<li>Implement proper mapping</li>
<li>Use appropriate field types</li>
<li>Monitor fielddata usage</li>
</ul>
<p><strong>Search Latency</strong>:</p>
<ul>
<li>Optimize queries</li>
<li>Check segment count</li>
<li>Monitor cache hit rates</li>
</ul>
<h2 id="Interview-Questions-Deep-Dive"><a href="#Interview-Questions-Deep-Dive" class="headerlink" title="Interview Questions Deep Dive"></a>Interview Questions Deep Dive</h2><p><strong>Q: “How does Elasticsearch achieve near real-time search?”</strong><br>A: Through the refresh operation that moves documents from in-memory buffers to searchable filesystem cache, typically every 1 second by default.</p>
<p><strong>Q: “What happens when a primary shard fails during indexing?”</strong><br>A: Elasticsearch promotes a replica shard to primary, replays the translog, and continues operations. The cluster remains functional with potential brief unavailability.</p>
<p><strong>Q: “How would you design an Elasticsearch cluster for a high-write, low-latency application?”</strong><br>A: Focus on horizontal scaling, optimize bulk operations, increase refresh intervals during high-write periods, use appropriate replica counts, and implement proper monitoring.</p>
<p><strong>Q: “Explain the memory implications of text vs keyword fields.”</strong><br>A: Text fields consume more memory during analysis and create larger inverted indexes. Keyword fields are more memory-efficient for exact-match scenarios and aggregations.</p>
<h2 id="External-References"><a href="#External-References" class="headerlink" title="External References"></a>External References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/">Elasticsearch Official Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://lucene.apache.org/core/8_11_0/core/org/apache/lucene/search/similarities/TFIDFSimilarity.html">Lucene Scoring Algorithm</a></li>
<li><a target="_blank" rel="noopener" href="https://citeseerx.ist.psu.edu/document?repid=rep1&type=pdf&doi=10.1.1.24.3698">Finite State Transducers Research Paper</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/tune-for-indexing-speed.html">Elasticsearch Performance Tuning Guide</a></li>
</ul>
<hr>
<p><em>This deep dive covers the fundamental concepts that power Elasticsearch’s search capabilities. Understanding these principles is essential for building scalable, performant search applications and succeeding in technical interviews.</em></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/14/Java-Thread-Pool-Deep-Dive-Production-Best-Practices/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/14/Java-Thread-Pool-Deep-Dive-Production-Best-Practices/" class="post-title-link" itemprop="url">Java Thread Pool Deep Dive: Production Best Practices</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-14 19:23:07 / Modified: 19:24:50" itemprop="dateCreated datePublished" datetime="2025-06-14T19:23:07+08:00">2025-06-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Understanding-Thread-Pools-in-Java"><a href="#Understanding-Thread-Pools-in-Java" class="headerlink" title="Understanding Thread Pools in Java"></a>Understanding Thread Pools in Java</h2><p>A thread pool is a collection of pre-created threads that can be reused to execute multiple tasks, eliminating the overhead of creating and destroying threads for each task. The Java Concurrency API provides robust thread pool implementations through the <code>ExecutorService</code> interface and <code>ThreadPoolExecutor</code> class.</p>
<h3 id="Why-Thread-Pools-Matter"><a href="#Why-Thread-Pools-Matter" class="headerlink" title="Why Thread Pools Matter"></a>Why Thread Pools Matter</h3><p>Thread creation and destruction are expensive operations that can significantly impact application performance. Thread pools solve this by:</p>
<ul>
<li><strong>Resource Management</strong>: Limiting the number of concurrent threads to prevent resource exhaustion</li>
<li><strong>Performance Optimization</strong>: Reusing threads reduces creation&#x2F;destruction overhead</li>
<li><strong>Task Queue Management</strong>: Providing controlled task execution with proper queuing mechanisms</li>
<li><strong>System Stability</strong>: Preventing thread explosion that could crash the application</li>
</ul>
<h2 id="Production-Level-Scenarios-and-Use-Cases"><a href="#Production-Level-Scenarios-and-Use-Cases" class="headerlink" title="Production-Level Scenarios and Use Cases"></a>Production-Level Scenarios and Use Cases</h2><h3 id="High-Volume-Web-Applications"><a href="#High-Volume-Web-Applications" class="headerlink" title="High-Volume Web Applications"></a>High-Volume Web Applications</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// E-commerce order processing system</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderProcessingService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor orderProcessor;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OrderProcessingService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.orderProcessor = <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">            <span class="number">10</span>,  <span class="comment">// corePoolSize: handle normal load</span></span><br><span class="line">            <span class="number">50</span>,  <span class="comment">// maximumPoolSize: handle peak traffic</span></span><br><span class="line">            <span class="number">60L</span>, TimeUnit.SECONDS, <span class="comment">// keepAliveTime</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="number">1000</span>), <span class="comment">// bounded queue</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ThreadFactory</span>() &#123;</span><br><span class="line">                <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">1</span>);</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(Runnable r)</span> &#123;</span><br><span class="line">                    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r, <span class="string">&quot;OrderProcessor-&quot;</span> + counter.getAndIncrement());</span><br><span class="line">                    t.setDaemon(<span class="literal">false</span>); <span class="comment">// Ensure proper shutdown</span></span><br><span class="line">                    <span class="keyword">return</span> t;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy() <span class="comment">// backpressure handling</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;OrderResult&gt; <span class="title function_">processOrder</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// Validate order</span></span><br><span class="line">            validateOrder(order);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Process payment</span></span><br><span class="line">            <span class="type">PaymentResult</span> <span class="variable">paymentResult</span> <span class="operator">=</span> paymentService.processPayment(order);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Update inventory</span></span><br><span class="line">            inventoryService.updateStock(order.getItems());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Send notification</span></span><br><span class="line">            notificationService.sendOrderConfirmation(order);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OrderResult</span>(order.getId(), paymentResult);</span><br><span class="line">        &#125;, orderProcessor);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Batch-Processing-Systems"><a href="#Batch-Processing-Systems" class="headerlink" title="Batch Processing Systems"></a>Batch Processing Systems</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Log analysis system processing millions of log entries</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogAnalysisService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ForkJoinPool forkJoinPool;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor ioThreadPool;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LogAnalysisService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// CPU-intensive tasks: use ForkJoinPool</span></span><br><span class="line">        <span class="built_in">this</span>.forkJoinPool = <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>(</span><br><span class="line">            Runtime.getRuntime().availableProcessors()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// I/O intensive tasks: higher thread count</span></span><br><span class="line">        <span class="built_in">this</span>.ioThreadPool = <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">            <span class="number">20</span>, <span class="comment">// corePoolSize</span></span><br><span class="line">            <span class="number">100</span>, <span class="comment">// maximumPoolSize  </span></span><br><span class="line">            <span class="number">30L</span>, TimeUnit.SECONDS,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">500</span>),</span><br><span class="line">            r -&gt; &#123;</span><br><span class="line">                <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r, <span class="string">&quot;LogIO-Thread&quot;</span>);</span><br><span class="line">                t.setDaemon(<span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processLogFiles</span><span class="params">(List&lt;File&gt; logFiles)</span> &#123;</span><br><span class="line">        <span class="comment">// Parallel processing of log files</span></span><br><span class="line">        logFiles.parallelStream()</span><br><span class="line">            .forEach(file -&gt; &#123;</span><br><span class="line">                CompletableFuture</span><br><span class="line">                    .supplyAsync(() -&gt; readLogFile(file), ioThreadPool)</span><br><span class="line">                    .thenCompose(content -&gt; </span><br><span class="line">                        CompletableFuture.supplyAsync(() -&gt; </span><br><span class="line">                            analyzeContent(content), forkJoinPool))</span><br><span class="line">                    .thenAccept(<span class="built_in">this</span>::storeResults)</span><br><span class="line">                    .exceptionally(throwable -&gt; &#123;</span><br><span class="line">                        logger.error(<span class="string">&quot;Failed to process file: &quot;</span> + file.getName(), throwable);</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Microservices-Communication"><a href="#Microservices-Communication" class="headerlink" title="Microservices Communication"></a>Microservices Communication</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Service-to-service communication with circuit breaker pattern</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExternalServiceClient</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor httpClientPool;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CircuitBreaker circuitBreaker;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ExternalServiceClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.httpClientPool = <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">            <span class="number">5</span>,   <span class="comment">// corePoolSize: minimum connections</span></span><br><span class="line">            <span class="number">20</span>,  <span class="comment">// maximumPoolSize: peak load handling</span></span><br><span class="line">            <span class="number">120L</span>, TimeUnit.SECONDS, <span class="comment">// longer keepAlive for HTTP connections</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;&gt;(), <span class="comment">// direct handoff</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">CustomThreadFactory</span>(<span class="string">&quot;HttpClient&quot;</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.AbortPolicy() <span class="comment">// fail fast on overload</span></span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">this</span>.circuitBreaker = CircuitBreaker.ofDefaults(<span class="string">&quot;externalService&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;ApiResponse&gt; <span class="title function_">callExternalService</span><span class="params">(ApiRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.supplyAsync(() -&gt; </span><br><span class="line">            circuitBreaker.executeSupplier(() -&gt; &#123;</span><br><span class="line">                <span class="comment">// HTTP call with timeout</span></span><br><span class="line">                <span class="keyword">return</span> httpClient.call(request);</span><br><span class="line">            &#125;), httpClientPool</span><br><span class="line">        ).orTimeout(<span class="number">5</span>, TimeUnit.SECONDS)</span><br><span class="line">         .exceptionally(throwable -&gt; &#123;</span><br><span class="line">             <span class="comment">// Fallback mechanism</span></span><br><span class="line">             <span class="keyword">return</span> handleServiceFailure(request, throwable);</span><br><span class="line">         &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Core-ThreadPoolExecutor-Parameters"><a href="#Core-ThreadPoolExecutor-Parameters" class="headerlink" title="Core ThreadPoolExecutor Parameters"></a>Core ThreadPoolExecutor Parameters</h2><p>Understanding these parameters is crucial for optimal thread pool configuration:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ThreadPoolExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">    <span class="type">int</span> corePoolSize,           <span class="comment">// Core threads always alive</span></span><br><span class="line">    <span class="type">int</span> maximumPoolSize,        <span class="comment">// Maximum threads allowed</span></span><br><span class="line">    <span class="type">long</span> keepAliveTime,         <span class="comment">// Idle thread timeout</span></span><br><span class="line">    TimeUnit unit,              <span class="comment">// Time unit for keepAliveTime</span></span><br><span class="line">    BlockingQueue&lt;Runnable&gt; workQueue,  <span class="comment">// Task queue</span></span><br><span class="line">    ThreadFactory threadFactory,        <span class="comment">// Thread creation</span></span><br><span class="line">    RejectedExecutionHandler handler    <span class="comment">// Rejection policy</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="Parameter-Deep-Dive"><a href="#Parameter-Deep-Dive" class="headerlink" title="Parameter Deep Dive"></a>Parameter Deep Dive</h3><p><strong>corePoolSize</strong>: The number of threads that remain alive even when idle. These threads are created on-demand as tasks arrive.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Example: Web server handling typical load</span></span><br><span class="line"><span class="type">int</span> <span class="variable">corePoolSize</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors() * <span class="number">2</span>;</span><br><span class="line"><span class="comment">// For CPU-bound: cores * 1</span></span><br><span class="line"><span class="comment">// For I/O-bound: cores * 2-4</span></span><br><span class="line"><span class="comment">// For mixed workload: cores * 1.5-2</span></span><br></pre></td></tr></table></figure>

<p><strong>maximumPoolSize</strong>: Maximum number of threads. Additional threads are created when the queue is full and more tasks arrive.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Calculate based on memory constraints</span></span><br><span class="line"><span class="type">long</span> <span class="variable">maxMemory</span> <span class="operator">=</span> Runtime.getRuntime().maxMemory();</span><br><span class="line"><span class="type">long</span> <span class="variable">threadStackSize</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">1024</span>; <span class="comment">// 1MB per thread (typical)</span></span><br><span class="line"><span class="type">int</span> <span class="variable">maxThreadsByMemory</span> <span class="operator">=</span> (<span class="type">int</span>) (maxMemory * <span class="number">0.1</span> / threadStackSize);</span><br><span class="line"><span class="type">int</span> <span class="variable">maximumPoolSize</span> <span class="operator">=</span> Math.min(maxThreadsByMemory, <span class="number">200</span>); <span class="comment">// Cap at 200</span></span><br></pre></td></tr></table></figure>

<p><strong>keepAliveTime</strong>: How long excess threads (above core size) remain idle before termination.</p>
<p><strong>workQueue</strong>: The queue implementation significantly impacts behavior:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Different queue types for different scenarios</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. Direct handoff - no queuing, immediate thread creation</span></span><br><span class="line">BlockingQueue&lt;Runnable&gt; directQueue = <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. Bounded queue - prevents memory exhaustion</span></span><br><span class="line">BlockingQueue&lt;Runnable&gt; boundedQueue = <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. Unbounded queue - unlimited queuing (risk of OutOfMemoryError)</span></span><br><span class="line">BlockingQueue&lt;Runnable&gt; unboundedQueue = <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. Priority queue - task prioritization</span></span><br><span class="line">BlockingQueue&lt;Runnable&gt; priorityQueue = <span class="keyword">new</span> <span class="title class_">PriorityBlockingQueue</span>&lt;&gt;(<span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<h2 id="Thread-Pool-Execution-Workflow"><a href="#Thread-Pool-Execution-Workflow" class="headerlink" title="Thread Pool Execution Workflow"></a>Thread Pool Execution Workflow</h2><pre>
<code class="mermaid">
flowchart
A[Task Submitted] --&gt; B{Core Pool Full?}
B --&gt;|No| C[Create New Core Thread]
C --&gt; D[Execute Task]
B --&gt;|Yes| E{Queue Full?}
E --&gt;|No| F[Add Task to Queue]
F --&gt; G[Core Thread Picks Task]
G --&gt; D
E --&gt;|Yes| H{Max Pool Reached?}
H --&gt;|No| I[Create Non-Core Thread]
I --&gt; D
H --&gt;|Yes| J[Apply Rejection Policy]
J --&gt; K[Reject&#x2F;Execute&#x2F;Discard&#x2F;Caller Runs]

D --&gt; L{More Tasks in Queue?}
L --&gt;|Yes| M[Pick Next Task]
M --&gt; D
L --&gt;|No| N{Non-Core Thread?}
N --&gt;|Yes| O{Keep Alive Expired?}
O --&gt;|Yes| P[Terminate Thread]
O --&gt;|No| Q[Wait for Task]
Q --&gt; L
N --&gt;|No| Q
</code>
</pre>

<h3 id="Internal-Mechanism-Details"><a href="#Internal-Mechanism-Details" class="headerlink" title="Internal Mechanism Details"></a>Internal Mechanism Details</h3><p>The <code>ThreadPoolExecutor</code> maintains several internal data structures:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolExecutorInternals</span> &#123;</span><br><span class="line">    <span class="comment">// Simplified view of internal state</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">ctl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(ctlOf(RUNNING, <span class="number">0</span>));</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; workQueue;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;Worker&gt; workers = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Worker&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">termination</span> <span class="operator">=</span> mainLock.newCondition();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Worker thread wrapper</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Worker</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueuedSynchronizer</span> </span><br><span class="line">                                <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Thread thread;</span><br><span class="line">        Runnable firstTask;</span><br><span class="line">        <span class="keyword">volatile</span> <span class="type">long</span> completedTasks;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            runWorker(<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Main worker loop</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">runWorker</span><span class="params">(Worker w)</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">wt</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> w.firstTask;</span><br><span class="line">        w.firstTask = <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (task != <span class="literal">null</span> || (task = getTask()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                w.lock();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    beforeExecute(wt, task);</span><br><span class="line">                    task.run();</span><br><span class="line">                    afterExecute(task, <span class="literal">null</span>);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    task = <span class="literal">null</span>;</span><br><span class="line">                    w.completedTasks++;</span><br><span class="line">                    w.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            processWorkerExit(w, completedAbruptly);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Thread-Pool-Optimization-Strategies"><a href="#Thread-Pool-Optimization-Strategies" class="headerlink" title="Thread Pool Optimization Strategies"></a>Thread Pool Optimization Strategies</h2><h3 id="Determining-Optimal-Core-Thread-Count"><a href="#Determining-Optimal-Core-Thread-Count" class="headerlink" title="Determining Optimal Core Thread Count"></a>Determining Optimal Core Thread Count</h3><p>The optimal thread count depends on workload characteristics:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolOptimizer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">calculateOptimalCoreSize</span><span class="params">(WorkloadType workloadType)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">availableProcessors</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span> (workloadType) &#123;</span><br><span class="line">            <span class="keyword">case</span> CPU_BOUND:</span><br><span class="line">                <span class="comment">// CPU-bound: cores + 1 (to handle occasional I/O)</span></span><br><span class="line">                <span class="keyword">return</span> availableProcessors + <span class="number">1</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> IO_BOUND:</span><br><span class="line">                <span class="comment">// I/O-bound: cores * target utilization / (1 - blocking factor)</span></span><br><span class="line">                <span class="comment">// blocking factor: 0.9 (90% waiting), utilization: 0.8</span></span><br><span class="line">                <span class="keyword">return</span> (<span class="type">int</span>) (availableProcessors * <span class="number">0.8</span> / (<span class="number">1</span> - <span class="number">0.9</span>));</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> MIXED:</span><br><span class="line">                <span class="comment">// Mixed workload: balanced approach</span></span><br><span class="line">                <span class="keyword">return</span> availableProcessors * <span class="number">2</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> DATABASE_OPERATIONS:</span><br><span class="line">                <span class="comment">// Database connection pool size consideration</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">dbConnectionPoolSize</span> <span class="operator">=</span> getDbConnectionPoolSize();</span><br><span class="line">                <span class="keyword">return</span> Math.min(availableProcessors * <span class="number">4</span>, dbConnectionPoolSize);</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> availableProcessors;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Dynamic sizing based on system metrics</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">adjustThreadPoolSize</span><span class="params">(ThreadPoolExecutor executor)</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolStats</span> <span class="variable">stats</span> <span class="operator">=</span> getThreadPoolStats(executor);</span><br><span class="line">        <span class="type">SystemMetrics</span> <span class="variable">systemMetrics</span> <span class="operator">=</span> getSystemMetrics();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (stats.getAverageQueueSize() &gt; <span class="number">100</span> &amp;&amp; </span><br><span class="line">            systemMetrics.getCpuUsage() &lt; <span class="number">0.7</span> &amp;&amp;</span><br><span class="line">            systemMetrics.getMemoryUsage() &lt; <span class="number">0.8</span>) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Increase core size if queue is growing and resources available</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">newCoreSize</span> <span class="operator">=</span> Math.min(</span><br><span class="line">                executor.getCorePoolSize() + <span class="number">2</span>,</span><br><span class="line">                executor.getMaximumPoolSize()</span><br><span class="line">            );</span><br><span class="line">            executor.setCorePoolSize(newCoreSize);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (stats.getAverageActiveThreads() &lt; executor.getCorePoolSize() * <span class="number">0.5</span>) &#123;</span><br><span class="line">            <span class="comment">// Decrease core size if consistently underutilized</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">newCoreSize</span> <span class="operator">=</span> Math.max(</span><br><span class="line">                executor.getCorePoolSize() - <span class="number">1</span>,</span><br><span class="line">                <span class="number">1</span> <span class="comment">// Minimum one thread</span></span><br><span class="line">            );</span><br><span class="line">            executor.setCorePoolSize(newCoreSize);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Performance-Monitoring-and-Tuning"><a href="#Performance-Monitoring-and-Tuning" class="headerlink" title="Performance Monitoring and Tuning"></a>Performance Monitoring and Tuning</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolMonitor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">monitorThreadPool</span><span class="params">(String poolName, ThreadPoolExecutor executor)</span> &#123;</span><br><span class="line">        <span class="comment">// Register metrics</span></span><br><span class="line">        Gauge.builder(<span class="string">&quot;threadpool.core.size&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;pool&quot;</span>, poolName)</span><br><span class="line">            .register(meterRegistry, executor, ThreadPoolExecutor::getCorePoolSize);</span><br><span class="line">            </span><br><span class="line">        Gauge.builder(<span class="string">&quot;threadpool.active.threads&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;pool&quot;</span>, poolName)</span><br><span class="line">            .register(meterRegistry, executor, ThreadPoolExecutor::getActiveCount);</span><br><span class="line">            </span><br><span class="line">        Gauge.builder(<span class="string">&quot;threadpool.queue.size&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;pool&quot;</span>, poolName)</span><br><span class="line">            .register(meterRegistry, executor, e -&gt; e.getQueue().size());</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// Custom monitoring</span></span><br><span class="line">        <span class="type">ScheduledExecutorService</span> <span class="variable">monitor</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line">        monitor.scheduleAtFixedRate(() -&gt; &#123;</span><br><span class="line">            logThreadPoolStats(poolName, executor);</span><br><span class="line">            checkForBottlenecks(executor);</span><br><span class="line">        &#125;, <span class="number">0</span>, <span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkForBottlenecks</span><span class="params">(ThreadPoolExecutor executor)</span> &#123;</span><br><span class="line">        <span class="type">double</span> <span class="variable">queueUtilization</span> <span class="operator">=</span> (<span class="type">double</span>) executor.getQueue().size() / <span class="number">1000</span>; <span class="comment">// assume capacity 1000</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">threadUtilization</span> <span class="operator">=</span> (<span class="type">double</span>) executor.getActiveCount() / executor.getMaximumPoolSize();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (queueUtilization &gt; <span class="number">0.8</span>) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;Thread pool queue utilization high: &#123;&#125;%&quot;</span>, queueUtilization * <span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (threadUtilization &gt; <span class="number">0.9</span>) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;Thread pool utilization high: &#123;&#125;%&quot;</span>, threadUtilization * <span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check for thread starvation</span></span><br><span class="line">        <span class="keyword">if</span> (executor.getActiveCount() == executor.getMaximumPoolSize() &amp;&amp; </span><br><span class="line">            executor.getQueue().size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;Potential thread starvation detected!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Production-Best-Practices"><a href="#Production-Best-Practices" class="headerlink" title="Production Best Practices"></a>Production Best Practices</h2><h3 id="Proper-Thread-Pool-Configuration"><a href="#Proper-Thread-Pool-Configuration" class="headerlink" title="Proper Thread Pool Configuration"></a>Proper Thread Pool Configuration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolConfiguration</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean(name = &quot;taskExecutor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title function_">taskExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Core configuration</span></span><br><span class="line">        executor.setCorePoolSize(<span class="number">10</span>);</span><br><span class="line">        executor.setMaxPoolSize(<span class="number">50</span>);</span><br><span class="line">        executor.setQueueCapacity(<span class="number">1000</span>);</span><br><span class="line">        executor.setKeepAliveSeconds(<span class="number">60</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Thread naming for debugging</span></span><br><span class="line">        executor.setThreadNamePrefix(<span class="string">&quot;AsyncTask-&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Graceful shutdown</span></span><br><span class="line">        executor.setWaitForTasksToCompleteOnShutdown(<span class="literal">true</span>);</span><br><span class="line">        executor.setAwaitTerminationSeconds(<span class="number">30</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Rejection policy</span></span><br><span class="line">        executor.setRejectedExecutionHandler(<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());</span><br><span class="line">        </span><br><span class="line">        executor.initialize();</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="keyword">public</span> ThreadPoolExecutor <span class="title function_">customThreadPool</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">            calculateCorePoolSize(),</span><br><span class="line">            calculateMaxPoolSize(),</span><br><span class="line">            <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="number">2000</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">CustomThreadFactory</span>(<span class="string">&quot;CustomPool&quot;</span>),</span><br><span class="line">            (r, executor) -&gt; &#123;</span><br><span class="line">                <span class="comment">// Custom rejection handling with metrics</span></span><br><span class="line">                rejectionCounter.increment();</span><br><span class="line">                logger.warn(<span class="string">&quot;Task rejected, queue size: &#123;&#125;, active threads: &#123;&#125;&quot;</span>, </span><br><span class="line">                    executor.getQueue().size(), executor.getActiveCount());</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Fallback: try to execute in caller thread</span></span><br><span class="line">                <span class="keyword">if</span> (!executor.isShutdown()) &#123;</span><br><span class="line">                    r.run();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Error-Handling-and-Recovery"><a href="#Error-Handling-and-Recovery" class="headerlink" title="Error Handling and Recovery"></a>Error Handling and Recovery</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RobustTaskExecution</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; CompletableFuture&lt;T&gt; <span class="title function_">executeWithRetry</span><span class="params">(</span></span><br><span class="line"><span class="params">            Supplier&lt;T&gt; task, </span></span><br><span class="line"><span class="params">            ThreadPoolExecutor executor,</span></span><br><span class="line"><span class="params">            <span class="type">int</span> maxRetries)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="type">Exception</span> <span class="variable">lastException</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">attempt</span> <span class="operator">=</span> <span class="number">1</span>; attempt &lt;= maxRetries; attempt++) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> task.get();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    lastException = e;</span><br><span class="line">                    logger.warn(<span class="string">&quot;Task attempt &#123;&#125; failed&quot;</span>, attempt, e);</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (attempt &lt; maxRetries) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="comment">// Exponential backoff</span></span><br><span class="line">                            Thread.sleep(<span class="number">1000</span> * (<span class="type">long</span>) Math.pow(<span class="number">2</span>, attempt - <span class="number">1</span>));</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">                            Thread.currentThread().interrupt();</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Task interrupted&quot;</span>, ie);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Task failed after &quot;</span> + maxRetries + <span class="string">&quot; attempts&quot;</span>, lastException);</span><br><span class="line">        &#125;, executor);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleUncaughtExceptions</span><span class="params">(ThreadPoolExecutor executor)</span> &#123;</span><br><span class="line">        <span class="comment">// Override afterExecute to handle exceptions</span></span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">customExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">            executor.getCorePoolSize(),</span><br><span class="line">            executor.getMaximumPoolSize(),</span><br><span class="line">            executor.getKeepAliveTime(TimeUnit.SECONDS),</span><br><span class="line">            TimeUnit.SECONDS,</span><br><span class="line">            executor.getQueue()</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterExecute</span><span class="params">(Runnable r, Throwable t)</span> &#123;</span><br><span class="line">                <span class="built_in">super</span>.afterExecute(r, t);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (t != <span class="literal">null</span>) &#123;</span><br><span class="line">                    logger.error(<span class="string">&quot;Task execution failed&quot;</span>, t);</span><br><span class="line">                    <span class="comment">// Custom error handling - alerting, recovery, etc.</span></span><br><span class="line">                    handleTaskFailure(r, t);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Extract exception from Future if needed</span></span><br><span class="line">                <span class="keyword">if</span> (t == <span class="literal">null</span> &amp;&amp; r <span class="keyword">instanceof</span> Future&lt;?&gt;) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        ((Future&lt;?&gt;) r).get();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (ExecutionException ee) &#123;</span><br><span class="line">                        t = ee.getCause();</span><br><span class="line">                        logger.error(<span class="string">&quot;Future task failed&quot;</span>, t);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">                        Thread.currentThread().interrupt();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Graceful-Shutdown-Implementation"><a href="#Graceful-Shutdown-Implementation" class="headerlink" title="Graceful Shutdown Implementation"></a>Graceful Shutdown Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolLifecycleManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PreDestroy</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span> &#123;</span><br><span class="line">        shutdownExecutor(orderProcessingExecutor, <span class="string">&quot;OrderProcessing&quot;</span>, <span class="number">30</span>);</span><br><span class="line">        shutdownExecutor(emailExecutor, <span class="string">&quot;Email&quot;</span>, <span class="number">10</span>);</span><br><span class="line">        shutdownExecutor(backgroundTaskExecutor, <span class="string">&quot;BackgroundTask&quot;</span>, <span class="number">60</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">shutdownExecutor</span><span class="params">(ExecutorService executor, String name, <span class="type">int</span> timeoutSeconds)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;Shutting down &#123;&#125; thread pool&quot;</span>, name);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Disable new task submission</span></span><br><span class="line">        executor.shutdown();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Wait for existing tasks to complete</span></span><br><span class="line">            <span class="keyword">if</span> (!executor.awaitTermination(timeoutSeconds, TimeUnit.SECONDS)) &#123;</span><br><span class="line">                logger.warn(<span class="string">&quot;&#123;&#125; thread pool did not terminate gracefully, forcing shutdown&quot;</span>, name);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Cancel currently executing tasks</span></span><br><span class="line">                List&lt;Runnable&gt; droppedTasks = executor.shutdownNow();</span><br><span class="line">                logger.warn(<span class="string">&quot;Dropped &#123;&#125; tasks from &#123;&#125; thread pool&quot;</span>, droppedTasks.size(), name);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Wait a bit more</span></span><br><span class="line">                <span class="keyword">if</span> (!executor.awaitTermination(<span class="number">5</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">                    logger.error(<span class="string">&quot;&#123;&#125; thread pool did not terminate after forced shutdown&quot;</span>, name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;&#123;&#125; thread pool terminated gracefully&quot;</span>, name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;Shutdown interrupted for &#123;&#125; thread pool&quot;</span>, name);</span><br><span class="line">            executor.shutdownNow();</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Interview-Questions-and-Key-Insights"><a href="#Interview-Questions-and-Key-Insights" class="headerlink" title="Interview Questions and Key Insights"></a>Interview Questions and Key Insights</h2><h3 id="Core-Concepts-Questions"><a href="#Core-Concepts-Questions" class="headerlink" title="Core Concepts Questions"></a>Core Concepts Questions</h3><p><strong>Q: What happens when a ThreadPoolExecutor receives a task?</strong></p>
<p>The execution follows a specific workflow:</p>
<ol>
<li>If core threads &lt; corePoolSize, create a new core thread</li>
<li>If core pool is full, add task to queue</li>
<li>If queue is full and threads &lt; maximumPoolSize, create non-core thread</li>
<li>If max pool size reached, apply rejection policy</li>
</ol>
<p><strong>Q: Explain the difference between submit() and execute() methods.</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// execute() - fire and forget, no return value</span></span><br><span class="line">executor.execute(() -&gt; System.out.println(<span class="string">&quot;Task executed&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// submit() - returns Future for result/exception handling</span></span><br><span class="line">Future&lt;?&gt; future = executor.submit(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Task result&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">CompletableFuture&lt;String&gt; completableFuture = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Async result&quot;</span>;</span><br><span class="line">&#125;, executor);</span><br></pre></td></tr></table></figure>

<p><strong>Q: How do you handle thread pool saturation?</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. Proper sizing</span></span><br><span class="line"><span class="type">int</span> <span class="variable">optimalSize</span> <span class="operator">=</span> availableProcessors * (<span class="number">1</span> + waitTime/serviceTime);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. Bounded queues to provide backpressure</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. Appropriate rejection policies</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy(); <span class="comment">// Backpressure</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.AbortPolicy();      <span class="comment">// Fail fast</span></span><br></pre></td></tr></table></figure>

<h3 id="Advanced-Scenarios"><a href="#Advanced-Scenarios" class="headerlink" title="Advanced Scenarios"></a>Advanced Scenarios</h3><p><strong>Q: How would you implement a thread pool that can handle both CPU-intensive and I&#x2F;O-intensive tasks?</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HybridThreadPoolManager</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor cpuPool;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor ioPool;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HybridThreadPoolManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// CPU pool: cores + 1</span></span><br><span class="line">        <span class="built_in">this</span>.cpuPool = <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">            Runtime.getRuntime().availableProcessors() + <span class="number">1</span>,</span><br><span class="line">            Runtime.getRuntime().availableProcessors() + <span class="number">1</span>,</span><br><span class="line">            <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// I/O pool: higher thread count</span></span><br><span class="line">        <span class="built_in">this</span>.ioPool = <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">            <span class="number">20</span>, <span class="number">100</span>, <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">500</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; CompletableFuture&lt;T&gt; <span class="title function_">executeTask</span><span class="params">(TaskType type, Supplier&lt;T&gt; task)</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> (type == TaskType.CPU_BOUND) ? cpuPool : ioPool;</span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.supplyAsync(task, executor);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Thread-Pool-State-Diagram"><a href="#Thread-Pool-State-Diagram" class="headerlink" title="Thread Pool State Diagram"></a>Thread Pool State Diagram</h2><pre>
<code class="mermaid">
stateDiagram-v2
[*] --&gt; RUNNING: new ThreadPoolExecutor()
RUNNING --&gt; SHUTDOWN: shutdown()
RUNNING --&gt; STOP: shutdownNow()
SHUTDOWN --&gt; TIDYING: All tasks completed
STOP --&gt; TIDYING: All tasks completed
TIDYING --&gt; TERMINATED: terminated() hook completed
TERMINATED --&gt; [*]

state RUNNING {
    [*] --&gt; Accepting_Tasks
    Accepting_Tasks --&gt; Executing_Tasks: Task submitted
    Executing_Tasks --&gt; Accepting_Tasks: Task completed
}

state SHUTDOWN {
    [*] --&gt; No_New_Tasks
    No_New_Tasks --&gt; Finishing_Tasks: Complete existing
}
</code>
</pre>

<h2 id="Advanced-Patterns-and-Techniques"><a href="#Advanced-Patterns-and-Techniques" class="headerlink" title="Advanced Patterns and Techniques"></a>Advanced Patterns and Techniques</h2><h3 id="Custom-Thread-Pool-Implementation"><a href="#Custom-Thread-Pool-Implementation" class="headerlink" title="Custom Thread Pool Implementation"></a>Custom Thread Pool Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AdaptiveThreadPool</span> <span class="keyword">extends</span> <span class="title class_">ThreadPoolExecutor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">totalTasks</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">totalTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">double</span> <span class="variable">averageTaskTime</span> <span class="operator">=</span> <span class="number">0.0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AdaptiveThreadPool</span><span class="params">(<span class="type">int</span> corePoolSize, <span class="type">int</span> maximumPoolSize)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(corePoolSize, maximumPoolSize, <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">              <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;(), <span class="keyword">new</span> <span class="title class_">AdaptiveThreadFactory</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeExecute</span><span class="params">(Thread t, Runnable r)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.beforeExecute(t, r);</span><br><span class="line">        <span class="comment">// Mark start time</span></span><br><span class="line">        TASK_START_TIME.set(System.nanoTime());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterExecute</span><span class="params">(Runnable r, Throwable t)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.afterExecute(r, t);</span><br><span class="line">        </span><br><span class="line">        <span class="type">long</span> <span class="variable">duration</span> <span class="operator">=</span> System.nanoTime() - TASK_START_TIME.get();</span><br><span class="line">        totalTasks.incrementAndGet();</span><br><span class="line">        totalTime.addAndGet(duration);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Update average task time</span></span><br><span class="line">        averageTaskTime = (<span class="type">double</span>) totalTime.get() / totalTasks.get();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Adaptive sizing based on task duration and queue size</span></span><br><span class="line">        adaptPoolSize();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">adaptPoolSize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">queueSize</span> <span class="operator">=</span> getQueue().size();</span><br><span class="line">        <span class="type">int</span> <span class="variable">activeThreads</span> <span class="operator">=</span> getActiveCount();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// If queue is growing and tasks are I/O bound (long duration)</span></span><br><span class="line">        <span class="keyword">if</span> (queueSize &gt; <span class="number">10</span> &amp;&amp; averageTaskTime &gt; <span class="number">100_000_000</span>) &#123; <span class="comment">// 100ms</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">newCoreSize</span> <span class="operator">=</span> Math.min(getCorePoolSize() + <span class="number">1</span>, getMaximumPoolSize());</span><br><span class="line">            setCorePoolSize(newCoreSize);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// If threads are idle and few tasks in queue</span></span><br><span class="line">        <span class="keyword">if</span> (queueSize &lt; <span class="number">5</span> &amp;&amp; activeThreads &lt; getCorePoolSize() / <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">newCoreSize</span> <span class="operator">=</span> Math.max(getCorePoolSize() - <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">            setCorePoolSize(newCoreSize);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Long&gt; TASK_START_TIME = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Integration-with-Spring-Framework"><a href="#Integration-with-Spring-Framework" class="headerlink" title="Integration with Spring Framework"></a>Integration with Spring Framework</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncConfiguration</span> <span class="keyword">implements</span> <span class="title class_">AsyncConfigurer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Executor <span class="title function_">getAsyncExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">        executor.setCorePoolSize(<span class="number">10</span>);</span><br><span class="line">        executor.setMaxPoolSize(<span class="number">100</span>);</span><br><span class="line">        executor.setQueueCapacity(<span class="number">500</span>);</span><br><span class="line">        executor.setThreadNamePrefix(<span class="string">&quot;Async-&quot;</span>);</span><br><span class="line">        executor.setRejectedExecutionHandler(<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());</span><br><span class="line">        executor.initialize();</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AsyncUncaughtExceptionHandler <span class="title function_">getAsyncUncaughtExceptionHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (throwable, method, objects) -&gt; &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;Async method &#123;&#125; failed with args &#123;&#125;&quot;</span>, </span><br><span class="line">                method.getName(), Arrays.toString(objects), throwable);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Custom error handling - metrics, alerting, etc.</span></span><br><span class="line">            handleAsyncException(method, throwable);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TaskScheduler <span class="title function_">taskScheduler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskScheduler</span> <span class="variable">scheduler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskScheduler</span>();</span><br><span class="line">        scheduler.setPoolSize(<span class="number">5</span>);</span><br><span class="line">        scheduler.setThreadNamePrefix(<span class="string">&quot;Scheduled-&quot;</span>);</span><br><span class="line">        scheduler.setWaitForTasksToCompleteOnShutdown(<span class="literal">true</span>);</span><br><span class="line">        scheduler.setAwaitTerminationSeconds(<span class="number">30</span>);</span><br><span class="line">        <span class="keyword">return</span> scheduler;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Summary-and-Key-Takeaways"><a href="#Summary-and-Key-Takeaways" class="headerlink" title="Summary and Key Takeaways"></a>Summary and Key Takeaways</h2><p>Thread pools are fundamental to building scalable Java applications. Key principles for success:</p>
<ol>
<li><strong>Right-size your pools</strong> based on workload characteristics (CPU vs I&#x2F;O bound)</li>
<li><strong>Use bounded queues</strong> to provide backpressure and prevent memory exhaustion  </li>
<li><strong>Implement proper monitoring</strong> to understand pool behavior and performance</li>
<li><strong>Handle failures gracefully</strong> with appropriate rejection policies and error handling</li>
<li><strong>Ensure clean shutdown</strong> to prevent resource leaks and data corruption</li>
<li><strong>Monitor and tune continuously</strong> based on production metrics and load patterns</li>
</ol>
<p>The choice of thread pool configuration can make the difference between a responsive, scalable application and one that fails under load. Always test your configuration under realistic load conditions and be prepared to adjust based on observed behavior.</p>
<p>Remember that thread pools are just one part of the concurrency story - proper synchronization, lock-free data structures, and understanding of the Java Memory Model are equally important for building robust concurrent applications.</p>
<h2 id="External-References"><a href="#External-References" class="headerlink" title="External References"></a>External References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/Executor.html">Oracle Java Documentation - Executor Framework</a></li>
<li><a target="_blank" rel="noopener" href="https://www.amazon.com/Java-Concurrency-Practice-Brian-Goetz/dp/0321349601">Java Concurrency in Practice by Brian Goetz</a></li>
<li><a target="_blank" rel="noopener" href="https://spring.io/guides/gs/async-method/">Spring Framework Async Execution</a></li>
<li><a target="_blank" rel="noopener" href="https://micrometer.io/docs/concepts#_executors">Micrometer Metrics for Thread Pools</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/gctuning/">JVM Performance Tuning Guide</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/14/Java-OOM-Troubleshooting-Guide-Production-Best-Practices/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/14/Java-OOM-Troubleshooting-Guide-Production-Best-Practices/" class="post-title-link" itemprop="url">Java OOM Troubleshooting Guide - Production Best Practices</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-14 17:50:06 / Modified: 17:52:14" itemprop="dateCreated datePublished" datetime="2025-06-14T17:50:06+08:00">2025-06-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Types-of-OutOfMemoryError-in-Production-Environments"><a href="#Types-of-OutOfMemoryError-in-Production-Environments" class="headerlink" title="Types of OutOfMemoryError in Production Environments"></a>Types of OutOfMemoryError in Production Environments</h2><h3 id="Java-Heap-Space-OOM"><a href="#Java-Heap-Space-OOM" class="headerlink" title="Java Heap Space OOM"></a>Java Heap Space OOM</h3><p>The most common OOM error occurs when the JVM cannot allocate objects in the heap due to insufficient memory.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Example code that can cause heap OOM</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HeapOOMExample</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;<span class="type">byte</span>[]&gt; memoryEater = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="comment">// Continuously allocate 1MB arrays</span></span><br><span class="line">                memoryEater.add(<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span> * <span class="number">1024</span>]);</span><br><span class="line">                System.out.println(<span class="string">&quot;Allocated arrays: &quot;</span> + memoryEater.size());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (OutOfMemoryError e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;java.lang.OutOfMemoryError: Java heap space&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Production Case Study</strong>: An e-commerce application experienced heap OOM during Black Friday sales due to caching user sessions without proper expiration policies.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Problematic session cache implementation</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SessionManager</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, UserSession&gt; sessions = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createSession</span><span class="params">(String sessionId, UserSession session)</span> &#123;</span><br><span class="line">        <span class="comment">// Problem: No expiration mechanism</span></span><br><span class="line">        sessions.put(sessionId, session);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Fixed version with expiration</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, SessionWithTimestamp&gt; sessionsFixed = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createSessionFixed</span><span class="params">(String sessionId, UserSession session)</span> &#123;</span><br><span class="line">        sessionsFixed.put(sessionId, <span class="keyword">new</span> <span class="title class_">SessionWithTimestamp</span>(session, System.currentTimeMillis()));</span><br><span class="line">        cleanupExpiredSessions();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PermGen-Metaspace-OOM"><a href="#PermGen-Metaspace-OOM" class="headerlink" title="PermGen&#x2F;Metaspace OOM"></a>PermGen&#x2F;Metaspace OOM</h3><p>Occurs when the permanent generation (Java 7 and earlier) or Metaspace (Java 8+) runs out of memory.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Dynamic class generation causing Metaspace OOM</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MetaspaceOOMExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;GeneratedClass&quot;</span> + i);</span><br><span class="line">            cc.addMethod(CtNewMethod.make(<span class="string">&quot;public void test() &#123;&#125;&quot;</span>, cc));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Loading classes without proper cleanup</span></span><br><span class="line">            Class&lt;?&gt; clazz = cc.toClass();</span><br><span class="line">            System.out.println(<span class="string">&quot;Created class: &quot;</span> + clazz.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“How would you differentiate between heap OOM and Metaspace OOM in production logs?”</em></p>
<ul>
<li>Heap OOM: <code>java.lang.OutOfMemoryError: Java heap space</code></li>
<li>Metaspace OOM: <code>java.lang.OutOfMemoryError: Metaspace</code></li>
</ul>
<h3 id="Direct-Memory-OOM"><a href="#Direct-Memory-OOM" class="headerlink" title="Direct Memory OOM"></a>Direct Memory OOM</h3><p>Occurs when off-heap memory allocated by NIO or unsafe operations exceeds limits.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Direct memory allocation example</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DirectMemoryOOM</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        List&lt;ByteBuffer&gt; buffers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="comment">// Allocate 1MB direct memory buffers</span></span><br><span class="line">                <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocateDirect(<span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line">                buffers.add(buffer);</span><br><span class="line">                System.out.println(<span class="string">&quot;Allocated direct buffers: &quot;</span> + buffers.size());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (OutOfMemoryError e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;java.lang.OutOfMemoryError: Direct buffer memory&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Production Case Study: Big Data Processing</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Scenario: Apache Kafka consumer processing large messages</span><br><span class="line">Symptoms: Intermittent failures during peak message processing</span><br><span class="line">Root Cause: NIO operations consuming direct memory without proper cleanup</span><br><span class="line">Fix: Increased -XX:MaxDirectMemorySize and improved buffer management</span><br></pre></td></tr></table></figure>

<h2 id="Generating-Heap-Dumps-When-OOM-Occurs"><a href="#Generating-Heap-Dumps-When-OOM-Occurs" class="headerlink" title="Generating Heap Dumps When OOM Occurs"></a>Generating Heap Dumps When OOM Occurs</h2><h3 id="Automatic-Heap-Dump-Generation"><a href="#Automatic-Heap-Dump-Generation" class="headerlink" title="Automatic Heap Dump Generation"></a>Automatic Heap Dump Generation</h3><p>Configure JVM parameters to automatically generate heap dumps on OOM:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># JVM flags for automatic heap dump generation</span></span><br><span class="line">java -XX:+HeapDumpOnOutOfMemoryError \</span><br><span class="line">     -XX:HeapDumpPath=/opt/app/heapdumps/ \</span><br><span class="line">     -XX:+PrintGCDetails \</span><br><span class="line">     -XX:+PrintGCTimeStamps \</span><br><span class="line">     -Xloggc:/opt/app/logs/gc.log \</span><br><span class="line">     -jar your-application.jar</span><br></pre></td></tr></table></figure>

<h3 id="Manual-Heap-Dump-Generation"><a href="#Manual-Heap-Dump-Generation" class="headerlink" title="Manual Heap Dump Generation"></a>Manual Heap Dump Generation</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Using jmap (requires application PID)</span></span><br><span class="line">jmap -dump:format=b,file=heap-dump.hprof &lt;PID&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Using jcmd (Java 8+)</span></span><br><span class="line">jcmd &lt;PID&gt; GC.run_finalization</span><br><span class="line">jcmd &lt;PID&gt; VM.gc</span><br><span class="line">jcmd &lt;PID&gt; GC.heap_dump /path/to/heap-dump.hprof</span><br><span class="line"></span><br><span class="line"><span class="comment"># Using kill signal (if configured)</span></span><br><span class="line"><span class="built_in">kill</span> -3 &lt;PID&gt;  <span class="comment"># Generates thread dump, not heap dump</span></span><br></pre></td></tr></table></figure>

<h3 id="Production-Ready-Heap-Dump-Script"><a href="#Production-Ready-Heap-Dump-Script" class="headerlink" title="Production-Ready Heap Dump Script"></a>Production-Ready Heap Dump Script</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># heap-dump-collector.sh</span></span><br><span class="line"></span><br><span class="line">APP_PID=$(pgrep -f <span class="string">&quot;your-application.jar&quot;</span>)</span><br><span class="line">DUMP_DIR=<span class="string">&quot;/opt/app/heapdumps&quot;</span></span><br><span class="line">TIMESTAMP=$(<span class="built_in">date</span> +%Y%m%d_%H%M%S)</span><br><span class="line">DUMP_FILE=<span class="string">&quot;<span class="variable">$&#123;DUMP_DIR&#125;</span>/heap-dump-<span class="variable">$&#123;TIMESTAMP&#125;</span>.hprof&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$APP_PID</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Application not running&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Generating heap dump for PID: <span class="variable">$APP_PID</span>&quot;</span></span><br><span class="line">jmap -dump:format=b,file=<span class="string">&quot;<span class="variable">$DUMP_FILE</span>&quot;</span> <span class="string">&quot;<span class="variable">$APP_PID</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Heap dump generated: <span class="variable">$DUMP_FILE</span>&quot;</span></span><br><span class="line">    <span class="comment"># Compress the dump file to save space</span></span><br><span class="line">    gzip <span class="string">&quot;<span class="variable">$DUMP_FILE</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Heap dump compressed: <span class="variable">$&#123;DUMP_FILE&#125;</span>.gz&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Failed to generate heap dump&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h2 id="Analyzing-Problems-with-MAT-and-VisualVM"><a href="#Analyzing-Problems-with-MAT-and-VisualVM" class="headerlink" title="Analyzing Problems with MAT and VisualVM"></a>Analyzing Problems with MAT and VisualVM</h2><h3 id="Memory-Analyzer-Tool-MAT-Analysis"><a href="#Memory-Analyzer-Tool-MAT-Analysis" class="headerlink" title="Memory Analyzer Tool (MAT) Analysis"></a>Memory Analyzer Tool (MAT) Analysis</h3><p><strong>Step-by-step MAT Analysis Process:</strong></p>
<ol>
<li><strong>Load the heap dump</strong> into MAT</li>
<li><strong>Automatic Leak Suspects Report</strong> - MAT automatically identifies potential memory leaks</li>
<li><strong>Dominator Tree Analysis</strong> - Shows objects and their retained heap sizes</li>
<li><strong>Histogram View</strong> - Groups objects by class and shows instance counts</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Example of analyzing a suspected memory leak</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LeakyClass</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; dataList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;LeakyClass&gt; instances = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LeakyClass</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Problem: Adding to static list without removal</span></span><br><span class="line">        instances.add(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addData</span><span class="params">(String data)</span> &#123;</span><br><span class="line">        dataList.add(data);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Missing cleanup method</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cleanup</span><span class="params">()</span> &#123;</span><br><span class="line">        instances.remove(<span class="built_in">this</span>);</span><br><span class="line">        dataList.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>MAT Analysis Results Interpretation:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Leak Suspects Report:</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│ Problem Suspect 1                                           │</span><br><span class="line">│ 45,234 instances of &quot;LeakyClass&quot;                           │</span><br><span class="line">│ Accumulated objects in cluster have total size 89.2 MB     │</span><br><span class="line">│ Keywords: java.util.ArrayList                               │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="VisualVM-Analysis-Approach"><a href="#VisualVM-Analysis-Approach" class="headerlink" title="VisualVM Analysis Approach"></a>VisualVM Analysis Approach</h3><p><strong>Real-time Monitoring Setup:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Enable JMX for VisualVM connection</span></span><br><span class="line">java -Dcom.sun.management.jmxremote \</span><br><span class="line">     -Dcom.sun.management.jmxremote.port=9999 \</span><br><span class="line">     -Dcom.sun.management.jmxremote.authenticate=<span class="literal">false</span> \</span><br><span class="line">     -Dcom.sun.management.jmxremote.ssl=<span class="literal">false</span> \</span><br><span class="line">     -jar your-application.jar</span><br></pre></td></tr></table></figure>

<p><strong>VisualVM Analysis Workflow:</strong></p>
<ol>
<li><strong>Connect to running application</strong></li>
<li><strong>Monitor heap usage patterns</strong></li>
<li><strong>Perform heap dumps during high memory usage</strong></li>
<li><strong>Analyze object retention paths</strong></li>
</ol>
<h2 id="Common-Causes-of-OOM-and-Solutions"><a href="#Common-Causes-of-OOM-and-Solutions" class="headerlink" title="Common Causes of OOM and Solutions"></a>Common Causes of OOM and Solutions</h2><h3 id="Memory-Leaks"><a href="#Memory-Leaks" class="headerlink" title="Memory Leaks"></a>Memory Leaks</h3><p><strong>Listener&#x2F;Observer Pattern Leaks:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Problematic code</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventPublisher</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;EventListener&gt; listeners = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addListener</span><span class="params">(EventListener listener)</span> &#123;</span><br><span class="line">        listeners.add(listener);</span><br><span class="line">        <span class="comment">// Problem: No removal mechanism</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Fixed version</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeListener</span><span class="params">(EventListener listener)</span> &#123;</span><br><span class="line">        listeners.remove(listener);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Proper cleanup in listener implementations</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyEventListener</span> <span class="keyword">implements</span> <span class="title class_">EventListener</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> EventPublisher publisher;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyEventListener</span><span class="params">(EventPublisher publisher)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.publisher = publisher;</span><br><span class="line">        publisher.addListener(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cleanup</span><span class="params">()</span> &#123;</span><br><span class="line">        publisher.removeListener(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Question</strong>: <em>“How would you identify and fix a listener leak in production?”</em></p>
<p><strong>Answer approach</strong>: Monitor heap dumps for increasing listener collections, implement weak references, or ensure proper cleanup in lifecycle methods.</p>
<h3 id="Connection-Pool-Leaks"><a href="#Connection-Pool-Leaks" class="headerlink" title="Connection Pool Leaks"></a>Connection Pool Leaks</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Database connection leak example</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Problematic method</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">getUsers</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> dataSource.getConnection();</span><br><span class="line">        <span class="type">PreparedStatement</span> <span class="variable">stmt</span> <span class="operator">=</span> conn.prepareStatement(<span class="string">&quot;SELECT * FROM users&quot;</span>);</span><br><span class="line">        <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> stmt.executeQuery();</span><br><span class="line">        </span><br><span class="line">        List&lt;User&gt; users = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">            users.add(<span class="keyword">new</span> <span class="title class_">User</span>(rs.getString(<span class="string">&quot;name&quot;</span>), rs.getString(<span class="string">&quot;email&quot;</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Problem: Resources not closed properly</span></span><br><span class="line">        <span class="keyword">return</span> users;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Fixed version with try-with-resources</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">getUsersFixed</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> dataSource.getConnection();</span><br><span class="line">             <span class="type">PreparedStatement</span> <span class="variable">stmt</span> <span class="operator">=</span> conn.prepareStatement(<span class="string">&quot;SELECT * FROM users&quot;</span>);</span><br><span class="line">             <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> stmt.executeQuery()) &#123;</span><br><span class="line">            </span><br><span class="line">            List&lt;User&gt; users = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">                users.add(<span class="keyword">new</span> <span class="title class_">User</span>(rs.getString(<span class="string">&quot;name&quot;</span>), rs.getString(<span class="string">&quot;email&quot;</span>)));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> users;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Oversized-Objects"><a href="#Oversized-Objects" class="headerlink" title="Oversized Objects"></a>Oversized Objects</h3><p><strong>Large Collection Handling:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Problematic approach for large datasets</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataProcessor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processLargeDataset</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;String&gt; allData = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Problem: Loading entire dataset into memory</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> Files.newBufferedReader(Paths.get(<span class="string">&quot;large-file.txt&quot;</span>))) &#123;</span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                allData.add(line);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Process all data at once</span></span><br><span class="line">        processData(allData);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Streaming approach to handle large datasets</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processLargeDatasetStreaming</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> (Stream&lt;String&gt; lines = Files.lines(Paths.get(<span class="string">&quot;large-file.txt&quot;</span>))) &#123;</span><br><span class="line">            lines.parallel()</span><br><span class="line">                 .filter(line -&gt; !line.isEmpty())</span><br><span class="line">                 .map(<span class="built_in">this</span>::transformLine)</span><br><span class="line">                 .forEach(<span class="built_in">this</span>::processLine);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Large Object Example:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Memory-intensive operation</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReportGenerator</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;CustomerReport&gt; <span class="title function_">generateMonthlyReports</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;CustomerReport&gt; reports = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// Loading 100K+ customer records into memory</span></span><br><span class="line">        List&lt;Customer&gt; allCustomers = customerRepository.findAll();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (Customer customer : allCustomers) &#123;</span><br><span class="line">            reports.add(generateReport(customer)); <span class="comment">// Each report ~50KB</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> reports; <span class="comment">// Total: ~5GB in memory</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Optimized Solution:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Stream-based processing</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OptimizedReportGenerator</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomerRepository customerRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generateMonthlyReports</span><span class="params">(ReportWriter writer)</span> &#123;</span><br><span class="line">        customerRepository.findAllByStream()</span><br><span class="line">            .map(<span class="built_in">this</span>::generateReport)</span><br><span class="line">            .forEach(writer::writeReport);</span><br><span class="line">        <span class="comment">// Memory usage: ~50KB per iteration</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Container-Resource-Constraints"><a href="#Container-Resource-Constraints" class="headerlink" title="Container Resource Constraints"></a>Container Resource Constraints</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Kubernetes deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;2Gi&quot;</span>  <span class="comment"># Container limit</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;-Xmx1536m&quot;</span>  <span class="comment"># JVM heap should be ~75% of container limit</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight:</strong> <em>“How do you size JVM heap in containerized environments? What’s the relationship between container memory limits and JVM heap size?”</em></p>
<h2 id="Tuning-Object-Promotion-and-GC-Parameters"><a href="#Tuning-Object-Promotion-and-GC-Parameters" class="headerlink" title="Tuning Object Promotion and GC Parameters"></a>Tuning Object Promotion and GC Parameters</h2><h3 id="Understanding-Object-Lifecycle"><a href="#Understanding-Object-Lifecycle" class="headerlink" title="Understanding Object Lifecycle"></a>Understanding Object Lifecycle</h3><pre>
<code class="mermaid">
graph TD
A[Object Creation] --&gt; B[Eden Space]
B --&gt; C{Minor GC}
C --&gt;|Survives| D[Survivor Space S0]
D --&gt; E{Minor GC}
E --&gt;|Survives| F[Survivor Space S1]
F --&gt; G{Age Threshold?}
G --&gt;|Yes| H[Old Generation]
G --&gt;|No| I[Back to Survivor]
C --&gt;|Dies| J[Garbage Collected]
E --&gt;|Dies| J
H --&gt; K{Major GC}
K --&gt; L[Garbage Collected or Retained]
</code>
</pre>

<h3 id="GC-Tuning-Parameters"><a href="#GC-Tuning-Parameters" class="headerlink" title="GC Tuning Parameters"></a>GC Tuning Parameters</h3><p><strong>G1GC Configuration for Production:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># G1GC tuning for 8GB heap</span></span><br><span class="line">java -Xms8g -Xmx8g \</span><br><span class="line">     -XX:+UseG1GC \</span><br><span class="line">     -XX:MaxGCPauseMillis=200 \</span><br><span class="line">     -XX:G1HeapRegionSize=16m \</span><br><span class="line">     -XX:G1NewSizePercent=20 \</span><br><span class="line">     -XX:G1MaxNewSizePercent=30 \</span><br><span class="line">     -XX:InitiatingHeapOccupancyPercent=45 \</span><br><span class="line">     -XX:G1MixedGCCountTarget=8 \</span><br><span class="line">     -XX:G1MixedGCLiveThresholdPercent=85 \</span><br><span class="line">     -jar your-application.jar</span><br></pre></td></tr></table></figure>

<p><strong>Parallel GC Configuration:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ParallelGC tuning for high-throughput applications</span></span><br><span class="line">java -Xms4g -Xmx4g \</span><br><span class="line">     -XX:+UseParallelGC \</span><br><span class="line">     -XX:ParallelGCThreads=8 \</span><br><span class="line">     -XX:NewRatio=3 \</span><br><span class="line">     -XX:SurvivorRatio=8 \</span><br><span class="line">     -XX:MaxTenuringThreshold=15 \</span><br><span class="line">     -XX:PretenureSizeThreshold=1048576 \</span><br><span class="line">     -jar your-application.jar</span><br></pre></td></tr></table></figure>

<h3 id="Object-Promotion-Threshold-Tuning"><a href="#Object-Promotion-Threshold-Tuning" class="headerlink" title="Object Promotion Threshold Tuning"></a>Object Promotion Threshold Tuning</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Monitor object age distribution</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ObjectAgeMonitoring</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// JVM flag to print tenuring distribution</span></span><br><span class="line">    <span class="comment">// -XX:+PrintTenuringDistribution</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">demonstrateObjectPromotion</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;<span class="type">byte</span>[]&gt; shortLived = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        List&lt;<span class="type">byte</span>[]&gt; longLived = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            <span class="comment">// Short-lived objects (should stay in young generation)</span></span><br><span class="line">            <span class="type">byte</span>[] temp = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            shortLived.add(temp);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">10</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// Long-lived objects (will be promoted to old generation)</span></span><br><span class="line">                longLived.add(<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Clear short-lived objects periodically</span></span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">100</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                shortLived.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="GC-Performance-Monitoring"><a href="#GC-Performance-Monitoring" class="headerlink" title="GC Performance Monitoring"></a>GC Performance Monitoring</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Comprehensive GC logging (Java 11+)</span></span><br><span class="line">java -Xlog:gc*:gc.log:<span class="keyword">time</span>,tags \</span><br><span class="line">     -XX:+UnlockExperimentalVMOptions \</span><br><span class="line">     -XX:+UseEpsilonGC \  <span class="comment"># For testing only</span></span><br><span class="line">     -jar your-application.jar</span><br><span class="line"></span><br><span class="line"><span class="comment"># GC analysis script</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment"># gc-analyzer.sh</span></span><br><span class="line"></span><br><span class="line">GC_LOG_FILE=<span class="string">&quot;gc.log&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== GC Performance Analysis ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Total GC events:&quot;</span></span><br><span class="line">grep -c <span class="string">&quot;GC(&quot;</span> <span class="string">&quot;<span class="variable">$GC_LOG_FILE</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Average pause time:&quot;</span></span><br><span class="line">grep <span class="string">&quot;GC(&quot;</span> <span class="string">&quot;<span class="variable">$GC_LOG_FILE</span>&quot;</span> | awk -F<span class="string">&#x27;,&#x27;</span> <span class="string">&#x27;&#123;sum+=$2; count++&#125; END &#123;print sum/count &quot;ms&quot;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Memory before/after GC:&quot;</span></span><br><span class="line">grep -E <span class="string">&quot;-&gt;.*\(&quot;</span> <span class="string">&quot;<span class="variable">$GC_LOG_FILE</span>&quot;</span> | <span class="built_in">tail</span> -10</span><br></pre></td></tr></table></figure>

<h2 id="Advanced-OOM-Prevention-Strategies"><a href="#Advanced-OOM-Prevention-Strategies" class="headerlink" title="Advanced OOM Prevention Strategies"></a>Advanced OOM Prevention Strategies</h2><h3 id="Memory-Efficient-Data-Structures"><a href="#Memory-Efficient-Data-Structures" class="headerlink" title="Memory-Efficient Data Structures"></a>Memory-Efficient Data Structures</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Using primitive collections to reduce memory overhead</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemoryEfficientStorage</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Instead of HashMap&lt;Integer, Integer&gt;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">TIntIntHashMap</span> <span class="variable">primitiveMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TIntIntHashMap</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Instead of List&lt;Integer&gt;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">TIntArrayList</span> <span class="variable">primitiveList</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TIntArrayList</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Object pooling for frequently created objects</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectPool&lt;StringBuilder&gt; stringBuilderPool = </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">GenericObjectPool</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">StringBuilderFactory</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">processData</span><span class="params">(List&lt;String&gt; data)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            sb = stringBuilderPool.borrowObject();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (String item : data) &#123;</span><br><span class="line">                sb.append(item).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> sb.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (sb != <span class="literal">null</span>) &#123;</span><br><span class="line">                stringBuilderPool.returnObject(sb);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Circuit-Breaker-Pattern-for-Memory-Protection"><a href="#Circuit-Breaker-Pattern-for-Memory-Protection" class="headerlink" title="Circuit Breaker Pattern for Memory Protection"></a>Circuit Breaker Pattern for Memory Protection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Circuit breaker to prevent memory exhaustion</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemoryCircuitBreaker</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">MemoryMXBean</span> <span class="variable">memoryBean</span> <span class="operator">=</span> ManagementFactory.getMemoryMXBean();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">double</span> <span class="variable">memoryThreshold</span> <span class="operator">=</span> <span class="number">0.85</span>; <span class="comment">// 85% of heap</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">circuitOpen</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isMemoryAvailable</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MemoryUsage</span> <span class="variable">heapUsage</span> <span class="operator">=</span> memoryBean.getHeapMemoryUsage();</span><br><span class="line">        <span class="type">double</span> <span class="variable">usedPercentage</span> <span class="operator">=</span> (<span class="type">double</span>) heapUsage.getUsed() / heapUsage.getMax();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (usedPercentage &gt; memoryThreshold) &#123;</span><br><span class="line">            circuitOpen = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (circuitOpen &amp;&amp; usedPercentage &lt; (memoryThreshold - <span class="number">0.1</span>)) &#123;</span><br><span class="line">            circuitOpen = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> !circuitOpen;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">executeWithMemoryCheck</span><span class="params">(Supplier&lt;T&gt; operation)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isMemoryAvailable()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Circuit breaker open: Memory usage too high&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> operation.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Production-Monitoring-and-Alerting"><a href="#Production-Monitoring-and-Alerting" class="headerlink" title="Production Monitoring and Alerting"></a>Production Monitoring and Alerting</h2><h3 id="JVM-Metrics-Collection"><a href="#JVM-Metrics-Collection" class="headerlink" title="JVM Metrics Collection"></a>JVM Metrics Collection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Custom JVM metrics collector</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JVMMetricsCollector</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">MemoryMXBean</span> <span class="variable">memoryBean</span> <span class="operator">=</span> ManagementFactory.getMemoryMXBean();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;GarbageCollectorMXBean&gt; gcBeans = ManagementFactory.getGarbageCollectorMXBeans();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 30000)</span> <span class="comment">// Every 30 seconds</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">collectMetrics</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MemoryUsage</span> <span class="variable">heapUsage</span> <span class="operator">=</span> memoryBean.getHeapMemoryUsage();</span><br><span class="line">        <span class="type">MemoryUsage</span> <span class="variable">nonHeapUsage</span> <span class="operator">=</span> memoryBean.getNonHeapMemoryUsage();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Log heap metrics</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">heapUsedPercent</span> <span class="operator">=</span> (<span class="type">double</span>) heapUsage.getUsed() / heapUsage.getMax() * <span class="number">100</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (heapUsedPercent &gt; <span class="number">80</span>) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;High heap usage: &#123;&#125;%&quot;</span>, String.format(<span class="string">&quot;%.2f&quot;</span>, heapUsedPercent));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Log GC metrics</span></span><br><span class="line">        <span class="keyword">for</span> (GarbageCollectorMXBean gcBean : gcBeans) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">collections</span> <span class="operator">=</span> gcBean.getCollectionCount();</span><br><span class="line">            <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> gcBean.getCollectionTime();</span><br><span class="line">            </span><br><span class="line">            log.info(<span class="string">&quot;GC [&#123;&#125;]: Collections=&#123;&#125;, Time=&#123;&#125;ms&quot;</span>, </span><br><span class="line">                    gcBean.getName(), collections, time);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Alerting-Configuration"><a href="#Alerting-Configuration" class="headerlink" title="Alerting Configuration"></a>Alerting Configuration</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Prometheus alerting rules for OOM prevention</span></span><br><span class="line"><span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jvm-memory-alerts</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">HighHeapUsage</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">jvm_memory_used_bytes&#123;area=&quot;heap&quot;&#125;</span> <span class="string">/</span> <span class="string">jvm_memory_max_bytes&#123;area=&quot;heap&quot;&#125;</span> <span class="string">&gt;</span> <span class="number">0.85</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">2m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;High JVM heap usage detected&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;Heap usage is above 85% for more than 2 minutes&quot;</span></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">HighGCTime</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">rate(jvm_gc_collection_seconds_sum[5m])</span> <span class="string">&gt;</span> <span class="number">0.1</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;High GC time detected&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;Application spending more than 10% time in GC&quot;</span></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">FrequentGC</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">rate(jvm_gc_collection_seconds_count[5m])</span> <span class="string">&gt;</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">2m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;Frequent GC cycles&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;More than 2 GC cycles per second&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Interview-Questions-and-Expert-Insights"><a href="#Interview-Questions-and-Expert-Insights" class="headerlink" title="Interview Questions and Expert Insights"></a>Interview Questions and Expert Insights</h2><h3 id="Core-Technical-Questions"><a href="#Core-Technical-Questions" class="headerlink" title="Core Technical Questions"></a>Core Technical Questions</h3><p><strong>Q: “Explain the difference between memory leak and memory pressure in Java applications.”</strong></p>
<p><strong>Expert Answer</strong>: Memory leak refers to objects that are no longer needed but still referenced, preventing garbage collection. Memory pressure occurs when application legitimately needs more memory than available. Leaks show constant growth in heap dumps, while pressure shows high but stable memory usage with frequent GC.</p>
<p><strong>Q: “How would you troubleshoot an application that has intermittent OOM errors?”</strong></p>
<p><strong>Systematic Approach</strong>:</p>
<ol>
<li>Enable heap dump generation on OOM</li>
<li>Monitor GC logs for patterns</li>
<li>Use application performance monitoring (APM) tools</li>
<li>Implement memory circuit breakers</li>
<li>Analyze heap dumps during both normal and high-load periods</li>
</ol>
<p><strong>Q: “What’s the impact of different GC algorithms on OOM behavior?”</strong></p>
<p><strong>Comparison Table</strong>:</p>
<table>
<thead>
<tr>
<th>GC Algorithm</th>
<th>OOM Behavior</th>
<th>Best Use Case</th>
</tr>
</thead>
<tbody><tr>
<td>Serial GC</td>
<td>Quick OOM detection</td>
<td>Small applications</td>
</tr>
<tr>
<td>Parallel GC</td>
<td>High throughput before OOM</td>
<td>Batch processing</td>
</tr>
<tr>
<td>G1GC</td>
<td>Predictable pause times</td>
<td>Large heaps (&gt;4GB)</td>
</tr>
<tr>
<td>ZGC</td>
<td>Ultra-low latency</td>
<td>Real-time applications</td>
</tr>
</tbody></table>
<h3 id="Advanced-Troubleshooting-Scenarios"><a href="#Advanced-Troubleshooting-Scenarios" class="headerlink" title="Advanced Troubleshooting Scenarios"></a>Advanced Troubleshooting Scenarios</h3><p><strong>Scenario</strong>: “Application runs fine for hours, then suddenly throws OOM. Heap dump shows high memory usage but no obvious leaks.”</p>
<p><strong>Investigation Strategy</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Implement memory pressure monitoring</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemoryPressureDetector</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Queue&lt;Long&gt; memorySnapshots = <span class="keyword">new</span> <span class="title class_">ConcurrentLinkedQueue</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">maxSnapshots</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 60000)</span> <span class="comment">// Every minute</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">takeSnapshot</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">usedMemory</span> <span class="operator">=</span> Runtime.getRuntime().totalMemory() - Runtime.getRuntime().freeMemory();</span><br><span class="line">        </span><br><span class="line">        memorySnapshots.offer(usedMemory);</span><br><span class="line">        <span class="keyword">if</span> (memorySnapshots.size() &gt; maxSnapshots) &#123;</span><br><span class="line">            memorySnapshots.poll();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Detect memory pressure trends</span></span><br><span class="line">        <span class="keyword">if</span> (memorySnapshots.size() &gt;= <span class="number">10</span>) &#123;</span><br><span class="line">            List&lt;Long&gt; recent = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(memorySnapshots);</span><br><span class="line">            Collections.reverse(recent);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Check if memory is consistently increasing</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">increasingTrend</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; Math.min(<span class="number">10</span>, recent.size()); i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (recent.get(i) &lt;= recent.get(i-<span class="number">1</span>)) &#123;</span><br><span class="line">                    increasingTrend = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (increasingTrend) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;Detected increasing memory pressure trend&quot;</span>);</span><br><span class="line">                <span class="comment">// Trigger proactive measures</span></span><br><span class="line">                triggerGarbageCollection();</span><br><span class="line">                generateHeapDump();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">triggerGarbageCollection</span><span class="params">()</span> &#123;</span><br><span class="line">        System.gc(); <span class="comment">// Use with caution in production</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Best-Practices-Summary"><a href="#Best-Practices-Summary" class="headerlink" title="Best Practices Summary"></a>Best Practices Summary</h2><h3 id="Development-Phase"><a href="#Development-Phase" class="headerlink" title="Development Phase"></a>Development Phase</h3><ul>
<li>Implement proper resource management with try-with-resources</li>
<li>Use weak references for caches and listeners</li>
<li>Design with memory constraints in mind</li>
<li>Implement object pooling for frequently created objects</li>
</ul>
<h3 id="Testing-Phase"><a href="#Testing-Phase" class="headerlink" title="Testing Phase"></a>Testing Phase</h3><ul>
<li>Load test with realistic data volumes</li>
<li>Monitor memory usage patterns during extended runs</li>
<li>Test GC behavior under various loads</li>
<li>Validate heap dump analysis procedures</li>
</ul>
<h3 id="Production-Phase"><a href="#Production-Phase" class="headerlink" title="Production Phase"></a>Production Phase</h3><ul>
<li>Enable automatic heap dump generation</li>
<li>Implement comprehensive monitoring and alerting</li>
<li>Have heap dump analysis procedures documented</li>
<li>Maintain GC logs for performance analysis</li>
</ul>
<h3 id="Emergency-Response"><a href="#Emergency-Response" class="headerlink" title="Emergency Response"></a>Emergency Response</h3><ul>
<li>Automated heap dump collection on OOM</li>
<li>Circuit breaker patterns to prevent cascading failures</li>
<li>Memory pressure monitoring and proactive alerting</li>
<li>Documented escalation procedures for memory issues</li>
</ul>
<h2 id="External-References-and-Tools"><a href="#External-References-and-Tools" class="headerlink" title="External References and Tools"></a>External References and Tools</h2><h3 id="Essential-Tools"><a href="#Essential-Tools" class="headerlink" title="Essential Tools"></a>Essential Tools</h3><ul>
<li><strong>Eclipse MAT</strong>: <a target="_blank" rel="noopener" href="https://www.eclipse.org/mat/">https://www.eclipse.org/mat/</a></li>
<li><strong>VisualVM</strong>: <a target="_blank" rel="noopener" href="https://visualvm.github.io/">https://visualvm.github.io/</a></li>
<li><strong>JProfiler</strong>: <a target="_blank" rel="noopener" href="https://www.ej-technologies.com/products/jprofiler/">https://www.ej-technologies.com/products/jprofiler/</a></li>
<li><strong>Async Profiler</strong>: <a target="_blank" rel="noopener" href="https://github.com/jvm-profiling-tools/async-profiler">https://github.com/jvm-profiling-tools/async-profiler</a></li>
</ul>
<h3 id="Monitoring-Solutions"><a href="#Monitoring-Solutions" class="headerlink" title="Monitoring Solutions"></a>Monitoring Solutions</h3><ul>
<li><strong>Micrometer</strong>: <a target="_blank" rel="noopener" href="https://micrometer.io/">https://micrometer.io/</a></li>
<li><strong>Prometheus JVM Metrics</strong>: <a target="_blank" rel="noopener" href="https://github.com/prometheus/client_java">https://github.com/prometheus/client_java</a></li>
<li><strong>APM Tools</strong>: New Relic, AppDynamics, Datadog</li>
</ul>
<h3 id="Documentation"><a href="#Documentation" class="headerlink" title="Documentation"></a>Documentation</h3><ul>
<li><strong>Oracle JVM Tuning Guide</strong>: <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/">https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/</a></li>
<li><strong>G1GC Documentation</strong>: <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/G1.html">https://docs.oracle.com/javase/8/docs/technotes/guides/vm/G1.html</a></li>
<li><strong>JVM Flags Reference</strong>: <a target="_blank" rel="noopener" href="https://chriswhocodes.com/hotspot_options_jdk11.html">https://chriswhocodes.com/hotspot_options_jdk11.html</a></li>
</ul>
<h3 id="Best-Practices-Resources"><a href="#Best-Practices-Resources" class="headerlink" title="Best Practices Resources"></a>Best Practices Resources</h3><ul>
<li><strong>Java Performance Tuning</strong>: “Java Performance: The Definitive Guide” by Scott Oaks</li>
<li><strong>GC Tuning</strong>: “Optimizing Java” by Benjamin J. Evans</li>
<li><strong>Memory Management</strong>: “Java Memory Management” by Kiran Kumar</li>
</ul>
<p>Remember: OOM troubleshooting is both art and science. Combine systematic analysis with deep understanding of your application’s memory patterns. Always test memory optimizations in staging environments before production deployment.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/13/Design-Message-Notification-Service/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/13/Design-Message-Notification-Service/" class="post-title-link" itemprop="url">Design Message Notification Service</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-13 20:54:18 / Modified: 20:57:50" itemprop="dateCreated datePublished" datetime="2025-06-13T20:54:18+08:00">2025-06-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system-design/" itemprop="url" rel="index"><span itemprop="name">system-design</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="System-Overview"><a href="#System-Overview" class="headerlink" title="System Overview"></a>System Overview</h2><p>The Message Notification Service is a scalable, multi-channel notification platform designed to handle 10 million messages per day across email, SMS, and WeChat channels. The system employs event-driven architecture with message queues for decoupling, template-based messaging, and comprehensive delivery tracking.</p>
<p><strong>Interview Insight</strong>: When discussing notification systems, emphasize the trade-offs between consistency and availability. For notifications, we typically choose availability over strict consistency since delayed delivery is preferable to no delivery.</p>
<pre>
<code class="mermaid">
graph TB
A[Business Services] --&gt; B[MessageNotificationSDK]
B --&gt; C[API Gateway]
C --&gt; D[Message Service]
D --&gt; E[Message Queue]
E --&gt; F[Channel Processors]
F --&gt; G[Email Service]
F --&gt; H[SMS Service]
F --&gt; I[WeChat Service]
D --&gt; J[Template Engine]
D --&gt; K[Scheduler Service]
F --&gt; L[Delivery Tracker]
L --&gt; M[Analytics DB]
D --&gt; N[Message Store]
</code>
</pre>

<h2 id="Core-Architecture-Components"><a href="#Core-Architecture-Components" class="headerlink" title="Core Architecture Components"></a>Core Architecture Components</h2><h3 id="Message-Notification-Service-API"><a href="#Message-Notification-Service-API" class="headerlink" title="Message Notification Service API"></a>Message Notification Service API</h3><p>The central service provides RESTful APIs for immediate and scheduled notifications:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;messageId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;msg_123456&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;recipients&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;userId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user_001&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;channels&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;email&quot;</span><span class="punctuation">,</span> <span class="string">&quot;sms&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user@example.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;phone&quot;</span><span class="punctuation">:</span> <span class="string">&quot;+1234567890&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;template&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;templateId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;welcome_template&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;variables&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;userName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;John Doe&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;activationLink&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://app.com/activate/xyz&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;priority&quot;</span><span class="punctuation">:</span> <span class="string">&quot;high&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;scheduledAt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-03-15T10:00:00Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;retryPolicy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;maxRetries&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;backoffMultiplier&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: Discuss idempotency here - each message should have a unique ID to prevent duplicate sends. This is crucial for financial notifications or critical alerts.</p>
<h3 id="Message-Queue-Architecture"><a href="#Message-Queue-Architecture" class="headerlink" title="Message Queue Architecture"></a>Message Queue Architecture</h3><p>The system uses Apache Kafka for high-throughput message processing with the following topic structure:</p>
<ul>
<li><code>notification.immediate</code> - Real-time notifications</li>
<li><code>notification.scheduled</code> - Scheduled notifications  </li>
<li><code>notification.retry</code> - Failed message retries</li>
<li><code>notification.dlq</code> - Dead letter queue for permanent failures</li>
</ul>
<pre>
<code class="mermaid">
flowchart LR
A[API Gateway] --&gt; B[Message Validator]
B --&gt; C{Message Type}
C --&gt;|Immediate| D[notification.immediate]
C --&gt;|Scheduled| E[notification.scheduled]
D --&gt; F[Channel Router]
E --&gt; G[Scheduler Service]
G --&gt; F
F --&gt; H[Email Processor]
F --&gt; I[SMS Processor]
F --&gt; J[WeChat Processor]
H --&gt; K[Email Provider]
I --&gt; L[SMS Provider]
J --&gt; M[WeChat API]
</code>
</pre>

<p><strong>Interview Insight</strong>: Explain partitioning strategy - partition by user ID for ordered processing per user, or by message type for parallel processing. The choice depends on whether message ordering matters for your use case.</p>
<h3 id="Template-Engine-Design"><a href="#Template-Engine-Design" class="headerlink" title="Template Engine Design"></a>Template Engine Design</h3><p>Templates support dynamic content injection with internationalization:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">templates:</span></span><br><span class="line">  <span class="attr">welcome_email:</span></span><br><span class="line">    <span class="attr">subject:</span> <span class="string">&quot;Welcome <span class="template-variable">&#123;&#123;userName&#125;&#125;</span> - <span class="template-variable">&#123;&#123;companyName&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">body:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      &lt;html&gt;</span></span><br><span class="line"><span class="string">        &lt;body&gt;</span></span><br><span class="line"><span class="string">          &lt;h1&gt;Welcome &#123;&#123;userName&#125;&#125;!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">          &lt;p&gt;Thank you for joining &#123;&#123;companyName&#125;&#125;.&lt;/p&gt;</span></span><br><span class="line"><span class="string">          &lt;a href=&quot;&#123;&#123;activationLink&#125;&#125;&quot;&gt;Activate Account&lt;/a&gt;</span></span><br><span class="line"><span class="string">        &lt;/body&gt;</span></span><br><span class="line"><span class="string">      &lt;/html&gt;</span></span><br><span class="line"><span class="string"></span>    <span class="attr">channels:</span> [<span class="string">&quot;email&quot;</span>]</span><br><span class="line">    <span class="attr">variables:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">userName:</span> <span class="string">required</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">companyName:</span> <span class="string">required</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">activationLink:</span> <span class="string">required</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">sms_verification:</span></span><br><span class="line">    <span class="attr">body:</span> <span class="string">&quot;Your <span class="template-variable">&#123;&#123;companyName&#125;&#125;</span> verification code: <span class="template-variable">&#123;&#123;code&#125;&#125;</span>. Valid for <span class="template-variable">&#123;&#123;expiry&#125;&#125;</span> minutes.&quot;</span></span><br><span class="line">    <span class="attr">channels:</span> [<span class="string">&quot;sms&quot;</span>]</span><br><span class="line">    <span class="attr">variables:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">companyName:</span> <span class="string">required</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">code:</span> <span class="string">required</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">expiry:</span> <span class="string">required</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: Template versioning is critical for production systems. Discuss A&#x2F;B testing capabilities where different template versions can be tested simultaneously to optimize engagement rates.</p>
<h2 id="Scalability-and-Performance"><a href="#Scalability-and-Performance" class="headerlink" title="Scalability and Performance"></a>Scalability and Performance</h2><h3 id="High-Volume-Message-Processing"><a href="#High-Volume-Message-Processing" class="headerlink" title="High-Volume Message Processing"></a>High-Volume Message Processing</h3><p>To handle 10 million messages daily (approximately 116 messages&#x2F;second average, 1000+ messages&#x2F;second peak):</p>
<p><strong>Horizontal Scaling Strategy</strong>:</p>
<ul>
<li>Multiple Kafka consumer groups for parallel processing</li>
<li>Channel-specific processors with independent scaling</li>
<li>Load balancing across processor instances</li>
</ul>
<p><strong>Performance Optimizations</strong>:</p>
<ul>
<li>Connection pooling for external APIs</li>
<li>Batch processing for similar notifications</li>
<li>Asynchronous processing with circuit breakers</li>
</ul>
<pre>
<code class="mermaid">
sequenceDiagram
participant BS as Business Service
participant SDK as Notification SDK
participant API as API Gateway
participant MQ as Message Queue
participant CP as Channel Processor
participant EP as Email Provider

BS-&gt;&gt;SDK: sendNotification(request)
SDK-&gt;&gt;API: POST &#x2F;notifications
API-&gt;&gt;API: Validate &amp; Enrich
API-&gt;&gt;MQ: Publish message
API--&gt;&gt;SDK: messageId (async)
SDK--&gt;&gt;BS: messageId

MQ-&gt;&gt;CP: Consume message
CP-&gt;&gt;CP: Apply template
CP-&gt;&gt;EP: Send email
EP--&gt;&gt;CP: Delivery status
CP-&gt;&gt;MQ: Update delivery status
</code>
</pre>

<p><strong>Interview Insight</strong>: Discuss the CAP theorem application - in notification systems, we choose availability and partition tolerance over consistency. It’s better to potentially send a duplicate notification than to miss sending one entirely.</p>
<h3 id="Caching-Strategy"><a href="#Caching-Strategy" class="headerlink" title="Caching Strategy"></a>Caching Strategy</h3><p><strong>Multi-Level Caching</strong>:</p>
<ul>
<li><strong>Template Cache</strong>: Redis cluster for compiled templates</li>
<li><strong>User Preference Cache</strong>: User notification preferences and contact info</li>
<li><strong>Rate Limiting Cache</strong>: Sliding window counters for rate limiting</li>
</ul>
<h2 id="Channel-Specific-Implementations"><a href="#Channel-Specific-Implementations" class="headerlink" title="Channel-Specific Implementations"></a>Channel-Specific Implementations</h2><h3 id="Email-Service"><a href="#Email-Service" class="headerlink" title="Email Service"></a>Email Service</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmailChannelProcessor</span> <span class="keyword">implements</span> <span class="title class_">ChannelProcessor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmailProviderFactory providerFactory;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DeliveryResult <span class="title function_">process</span><span class="params">(NotificationMessage message)</span> &#123;</span><br><span class="line">        <span class="type">EmailProvider</span> <span class="variable">provider</span> <span class="operator">=</span> providerFactory.getProvider(message.getPriority());</span><br><span class="line">        </span><br><span class="line">        <span class="type">EmailContent</span> <span class="variable">content</span> <span class="operator">=</span> templateEngine.render(</span><br><span class="line">            message.getTemplateId(), </span><br><span class="line">            message.getVariables()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> provider.send(EmailRequest.builder()</span><br><span class="line">            .to(message.getRecipient().getEmail())</span><br><span class="line">            .subject(content.getSubject())</span><br><span class="line">            .htmlBody(content.getBody())</span><br><span class="line">            .priority(message.getPriority())</span><br><span class="line">            .build());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Provider Failover Strategy</strong>:</p>
<ul>
<li>Primary: AWS SES (high volume, cost-effective)</li>
<li>Secondary: SendGrid (reliability backup)</li>
<li>Tertiary: Mailgun (final fallback)</li>
</ul>
<h3 id="SMS-Service-Implementation"><a href="#SMS-Service-Implementation" class="headerlink" title="SMS Service Implementation"></a>SMS Service Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SmsChannelProcessor</span> <span class="keyword">implements</span> <span class="title class_">ChannelProcessor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DeliveryResult <span class="title function_">process</span><span class="params">(NotificationMessage message)</span> &#123;</span><br><span class="line">        <span class="comment">// Route based on country code for optimal delivery rates</span></span><br><span class="line">        <span class="type">SmsProvider</span> <span class="variable">provider</span> <span class="operator">=</span> routingService.selectProvider(</span><br><span class="line">            message.getRecipient().getPhoneNumber()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="type">SmsContent</span> <span class="variable">content</span> <span class="operator">=</span> templateEngine.render(</span><br><span class="line">            message.getTemplateId(),</span><br><span class="line">            message.getVariables()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> provider.send(SmsRequest.builder()</span><br><span class="line">            .to(message.getRecipient().getPhoneNumber())</span><br><span class="line">            .message(content.getMessage())</span><br><span class="line">            .build());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: SMS routing is geography-dependent. Different providers have better delivery rates in different regions. Discuss how you’d implement intelligent routing based on phone number analysis.</p>
<h3 id="WeChat-Integration"><a href="#WeChat-Integration" class="headerlink" title="WeChat Integration"></a>WeChat Integration</h3><p>WeChat requires special handling due to its ecosystem:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeChatChannelProcessor</span> <span class="keyword">implements</span> <span class="title class_">ChannelProcessor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DeliveryResult <span class="title function_">process</span><span class="params">(NotificationMessage message)</span> &#123;</span><br><span class="line">        <span class="comment">// WeChat template messages have strict formatting requirements</span></span><br><span class="line">        <span class="type">WeChatTemplate</span> <span class="variable">template</span> <span class="operator">=</span> weChatTemplateService.getTemplate(</span><br><span class="line">            message.getTemplateId()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="type">WeChatMessage</span> <span class="variable">weChatMessage</span> <span class="operator">=</span> WeChatMessage.builder()</span><br><span class="line">            .openId(message.getRecipient().getWeChatOpenId())</span><br><span class="line">            .templateId(template.getWeChatTemplateId())</span><br><span class="line">            .data(transformVariables(message.getVariables()))</span><br><span class="line">            .build();</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> weChatApiClient.sendTemplateMessage(weChatMessage);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Scheduling-and-Delivery-Management"><a href="#Scheduling-and-Delivery-Management" class="headerlink" title="Scheduling and Delivery Management"></a>Scheduling and Delivery Management</h2><h3 id="Scheduler-Service-Architecture"><a href="#Scheduler-Service-Architecture" class="headerlink" title="Scheduler Service Architecture"></a>Scheduler Service Architecture</h3><pre>
<code class="mermaid">
flowchart TD
A[Scheduled Messages] --&gt; B[Time-based Partitioner]
B --&gt; C[Quartz Scheduler Cluster]
C --&gt; D[Message Trigger]
D --&gt; E{Delivery Window?}
E --&gt;|Yes| F[Send to Processing Queue]
E --&gt;|No| G[Reschedule]
F --&gt; H[Channel Processors]
G --&gt; A
</code>
</pre>

<p><strong>Delivery Window Management</strong>:</p>
<ul>
<li>Timezone-aware scheduling</li>
<li>Business hours enforcement</li>
<li>Frequency capping to prevent spam</li>
</ul>
<h3 id="Retry-and-Failure-Handling"><a href="#Retry-and-Failure-Handling" class="headerlink" title="Retry and Failure Handling"></a>Retry and Failure Handling</h3><p><strong>Exponential Backoff Strategy</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RetryPolicyManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> RetryPolicy <span class="title function_">getRetryPolicy</span><span class="params">(ChannelType channel, FailureReason reason)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> RetryPolicy.builder()</span><br><span class="line">            .maxRetries(getMaxRetries(channel, reason))</span><br><span class="line">            .initialDelay(Duration.ofSeconds(<span class="number">30</span>))</span><br><span class="line">            .backoffMultiplier(<span class="number">2.0</span>)</span><br><span class="line">            .maxDelay(Duration.ofHours(<span class="number">4</span>))</span><br><span class="line">            .jitter(<span class="number">0.1</span>)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getMaxRetries</span><span class="params">(ChannelType channel, FailureReason reason)</span> &#123;</span><br><span class="line">        <span class="comment">// Email: 3 retries for transient failures, 0 for invalid addresses</span></span><br><span class="line">        <span class="comment">// SMS: 2 retries for network issues, 0 for invalid numbers  </span></span><br><span class="line">        <span class="comment">// WeChat: 3 retries for API limits, 1 for user blocks</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: Discuss the importance of classifying failures - temporary vs permanent. Retrying an invalid email address wastes resources, while network timeouts should be retried with backoff.</p>
<h2 id="MessageNotificationSDK-Design"><a href="#MessageNotificationSDK-Design" class="headerlink" title="MessageNotificationSDK Design"></a>MessageNotificationSDK Design</h2><h3 id="SDK-Architecture"><a href="#SDK-Architecture" class="headerlink" title="SDK Architecture"></a>SDK Architecture</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageNotificationSDK</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> NotificationClient notificationClient;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CircuitBreaker circuitBreaker;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;MessageResult&gt; <span class="title function_">sendNotification</span><span class="params">(NotificationRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> circuitBreaker.executeAsync(() -&gt; </span><br><span class="line">            notificationClient.sendNotification(request)</span><br><span class="line">        ).exceptionally(throwable -&gt; &#123;</span><br><span class="line">            <span class="comment">// Fallback: store in local queue for retry</span></span><br><span class="line">            localQueueService.enqueue(request);</span><br><span class="line">            <span class="keyword">return</span> MessageResult.queued(request.getMessageId());</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;MessageResult&gt; <span class="title function_">sendScheduledNotification</span><span class="params">(</span></span><br><span class="line"><span class="params">        NotificationRequest request, </span></span><br><span class="line"><span class="params">        Instant scheduledTime</span></span><br><span class="line"><span class="params">    )</span> &#123;</span><br><span class="line">        <span class="type">ScheduledNotificationRequest</span> <span class="variable">scheduledRequest</span> <span class="operator">=</span> </span><br><span class="line">            ScheduledNotificationRequest.builder()</span><br><span class="line">                .notificationRequest(request)</span><br><span class="line">                .scheduledAt(scheduledTime)</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">return</span> notificationClient.scheduleNotification(scheduledRequest);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SDK-Configuration"><a href="#SDK-Configuration" class="headerlink" title="SDK Configuration"></a>SDK Configuration</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">notification:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">baseUrl:</span> <span class="string">https://notifications.company.com</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">30s</span></span><br><span class="line">    <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">circuit-breaker:</span></span><br><span class="line">    <span class="attr">failure-threshold:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">recovery-timeout:</span> <span class="string">60s</span></span><br><span class="line">  <span class="attr">local-queue:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">max-size:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">flush-interval:</span> <span class="string">30s</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: The SDK should be resilient to service unavailability. Discuss local queuing, circuit breakers, and graceful degradation strategies.</p>
<h2 id="Monitoring-and-Observability"><a href="#Monitoring-and-Observability" class="headerlink" title="Monitoring and Observability"></a>Monitoring and Observability</h2><h3 id="Key-Metrics-Dashboard"><a href="#Key-Metrics-Dashboard" class="headerlink" title="Key Metrics Dashboard"></a>Key Metrics Dashboard</h3><p><strong>Throughput Metrics</strong>:</p>
<ul>
<li>Messages processed per second by channel</li>
<li>Queue depth and processing latency</li>
<li>Template rendering performance</li>
</ul>
<p><strong>Delivery Metrics</strong>:</p>
<ul>
<li>Delivery success rate by channel and provider</li>
<li>Bounce and failure rates</li>
<li>Time to delivery distribution</li>
</ul>
<p><strong>Business Metrics</strong>:</p>
<ul>
<li>User engagement rates</li>
<li>Opt-out rates by channel</li>
<li>Cost per notification by channel</li>
</ul>
<pre>
<code class="mermaid">
graph LR
A[Notification Service] --&gt; B[Metrics Collector]
B --&gt; C[Prometheus]
C --&gt; D[Grafana Dashboard]
B --&gt; E[Application Logs]
E --&gt; F[ELK Stack]
B --&gt; G[Distributed Tracing]
G --&gt; H[Jaeger]
</code>
</pre>

<h3 id="Alerting-Strategy"><a href="#Alerting-Strategy" class="headerlink" title="Alerting Strategy"></a>Alerting Strategy</h3><p><strong>Critical Alerts</strong>:</p>
<ul>
<li>Queue depth &gt; 10,000 messages</li>
<li>Delivery success rate &lt; 95%</li>
<li>Provider API failure rate &gt; 5%</li>
</ul>
<p><strong>Warning Alerts</strong>:</p>
<ul>
<li>Processing latency &gt; 30 seconds</li>
<li>Template rendering errors</li>
<li>Unusual bounce rate increases</li>
</ul>
<h2 id="Security-and-Compliance"><a href="#Security-and-Compliance" class="headerlink" title="Security and Compliance"></a>Security and Compliance</h2><h3 id="Data-Protection"><a href="#Data-Protection" class="headerlink" title="Data Protection"></a>Data Protection</h3><p><strong>Encryption</strong>:</p>
<ul>
<li>At-rest: AES-256 encryption for stored messages</li>
<li>In-transit: TLS 1.3 for all API communications</li>
<li>PII masking in logs and metrics</li>
</ul>
<p><strong>Access Control</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreAuthorize(&quot;hasRole(&#x27;NOTIFICATION_ADMIN&#x27;) or hasPermission(#request.userId, &#x27;SEND_NOTIFICATION&#x27;)&quot;)</span></span><br><span class="line"><span class="keyword">public</span> MessageResult <span class="title function_">sendNotification</span><span class="params">(NotificationRequest request)</span> &#123;</span><br><span class="line">    <span class="comment">// Implementation</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Compliance-Considerations"><a href="#Compliance-Considerations" class="headerlink" title="Compliance Considerations"></a>Compliance Considerations</h3><p><strong>GDPR Compliance</strong>:</p>
<ul>
<li>Right to be forgotten: Automatic message deletion after retention period</li>
<li>Consent management: Integration with preference center</li>
<li>Data minimization: Only store necessary message data</li>
</ul>
<p><strong>CAN-SPAM Act</strong>:</p>
<ul>
<li>Automatic unsubscribe link injection</li>
<li>Sender identification requirements</li>
<li>Opt-out processing within 10 business days</li>
</ul>
<p><strong>Interview Insight</strong>: Security should be built-in, not bolted-on. Discuss defense in depth - encryption, authentication, authorization, input validation, and audit logging at every layer.</p>
<h2 id="Performance-Benchmarks-and-Capacity-Planning"><a href="#Performance-Benchmarks-and-Capacity-Planning" class="headerlink" title="Performance Benchmarks and Capacity Planning"></a>Performance Benchmarks and Capacity Planning</h2><h3 id="Load-Testing-Results"><a href="#Load-Testing-Results" class="headerlink" title="Load Testing Results"></a>Load Testing Results</h3><p><strong>Target Performance</strong>:</p>
<ul>
<li>10M messages&#x2F;day &#x3D; 115 messages&#x2F;second average</li>
<li>Peak capacity: 1,000 messages&#x2F;second</li>
<li>99th percentile latency: &lt; 100ms for API calls</li>
<li>95th percentile delivery time: &lt; 30 seconds</li>
</ul>
<p><strong>Scaling Calculations</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Email Channel:</span><br><span class="line">- Provider rate limit: 1000 emails/second</span><br><span class="line">- Buffer factor: 2x for burst capacity</span><br><span class="line">- Required instances: 2 (with failover)</span><br><span class="line"></span><br><span class="line">SMS Channel:  </span><br><span class="line">- Provider rate limit: 100 SMS/second</span><br><span class="line">- Peak SMS load: ~200/second (20% of total)</span><br><span class="line">- Required instances: 4 (with geographic distribution)</span><br></pre></td></tr></table></figure>

<h3 id="Database-Sizing"><a href="#Database-Sizing" class="headerlink" title="Database Sizing"></a>Database Sizing</h3><p><strong>Message Storage Requirements</strong>:</p>
<ul>
<li>10M messages&#x2F;day × 2KB average size &#x3D; 20GB&#x2F;day</li>
<li>90-day retention &#x3D; 1.8TB storage requirement</li>
<li>With replication and indexes: 5TB total</li>
</ul>
<h2 id="Cost-Optimization-Strategies"><a href="#Cost-Optimization-Strategies" class="headerlink" title="Cost Optimization Strategies"></a>Cost Optimization Strategies</h2><h3 id="Provider-Cost-Management"><a href="#Provider-Cost-Management" class="headerlink" title="Provider Cost Management"></a>Provider Cost Management</h3><p><strong>Email Costs</strong>:</p>
<ul>
<li>AWS SES: $0.10 per 1,000 emails</li>
<li>SendGrid: $0.20 per 1,000 emails  </li>
<li>Strategy: Primary on SES, failover to SendGrid</li>
</ul>
<p><strong>SMS Costs</strong>:</p>
<ul>
<li>Twilio US: $0.0075 per SMS</li>
<li>International routing for cost optimization</li>
<li>Bulk messaging discounts negotiation</li>
</ul>
<p><strong>Infrastructure Costs</strong>:</p>
<ul>
<li>Kafka cluster: $500&#x2F;month</li>
<li>Application servers: $800&#x2F;month</li>
<li>Database: $300&#x2F;month</li>
<li>Monitoring: $200&#x2F;month</li>
<li><strong>Total</strong>: ~$1,800&#x2F;month for 10M messages</li>
</ul>
<p><strong>Interview Insight</strong>: Always discuss cost optimization in system design. Show understanding of the business impact - a 10% improvement in delivery rates might justify 50% higher costs if it drives revenue.</p>
<h2 id="Testing-Strategy"><a href="#Testing-Strategy" class="headerlink" title="Testing Strategy"></a>Testing Strategy</h2><h3 id="Integration-Testing"><a href="#Integration-Testing" class="headerlink" title="Integration Testing"></a>Integration Testing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@TestcontainersConfiguration</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NotificationServiceIntegrationTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldProcessHighVolumeNotifications</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Simulate 1000 concurrent notification requests</span></span><br><span class="line">        List&lt;CompletableFuture&lt;MessageResult&gt;&gt; futures = IntStream.range(<span class="number">0</span>, <span class="number">1000</span>)</span><br><span class="line">            .mapToObj(i -&gt; notificationService.sendNotification(createTestRequest(i)))</span><br><span class="line">            .collect(toList());</span><br><span class="line">            </span><br><span class="line">        CompletableFuture.allOf(futures.toArray(<span class="keyword">new</span> <span class="title class_">CompletableFuture</span>[<span class="number">0</span>]))</span><br><span class="line">            .join();</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// Verify all messages processed within SLA</span></span><br><span class="line">        assertThat(futures).allSatisfy(future -&gt; </span><br><span class="line">            assertThat(future.get().getStatus()).isEqualTo(DELIVERED)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Chaos-Engineering"><a href="#Chaos-Engineering" class="headerlink" title="Chaos Engineering"></a>Chaos Engineering</h3><p><strong>Failure Scenarios</strong>:</p>
<ul>
<li>Provider API timeouts and rate limiting</li>
<li>Database connection failures</li>
<li>Kafka broker failures</li>
<li>Network partitions between services</li>
</ul>
<h2 id="Future-Enhancements"><a href="#Future-Enhancements" class="headerlink" title="Future Enhancements"></a>Future Enhancements</h2><h3 id="Advanced-Features-Roadmap"><a href="#Advanced-Features-Roadmap" class="headerlink" title="Advanced Features Roadmap"></a>Advanced Features Roadmap</h3><p><strong>Machine Learning Integration</strong>:</p>
<ul>
<li>Optimal send time prediction per user</li>
<li>Template A&#x2F;B testing automation</li>
<li>Delivery success rate optimization</li>
</ul>
<p><strong>Rich Media Support</strong>:</p>
<ul>
<li>Image and video attachments</li>
<li>Interactive email templates</li>
<li>Push notification rich media</li>
</ul>
<p><strong>Advanced Analytics</strong>:</p>
<ul>
<li>User engagement scoring</li>
<li>Campaign performance analytics</li>
<li>Predictive churn analysis</li>
</ul>
<p><strong>Interview Insight</strong>: Always end system design discussions with future considerations. This shows forward thinking and understanding that systems evolve. Discuss how your current architecture would accommodate these enhancements.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>This Message Notification Service design provides a robust, scalable foundation for high-volume, multi-channel notifications. The architecture emphasizes reliability, observability, and maintainability while meeting the 10 million messages per day requirement with room for growth.</p>
<p>Key design principles applied:</p>
<ul>
<li><strong>Decoupling</strong>: Message queues separate concerns and enable independent scaling</li>
<li><strong>Reliability</strong>: Multiple failover mechanisms and retry strategies</li>
<li><strong>Observability</strong>: Comprehensive monitoring and alerting</li>
<li><strong>Security</strong>: Built-in encryption, access control, and compliance features</li>
<li><strong>Cost Efficiency</strong>: Provider optimization and resource right-sizing</li>
</ul>
<p>The system can be deployed incrementally, starting with core notification functionality and adding advanced features as business needs evolve.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/13/Design-Multi-Tenant-Database-SDK/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/13/Design-Multi-Tenant-Database-SDK/" class="post-title-link" itemprop="url">Design Multi-Tenant Database SDK</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-13 18:40:02" itemprop="dateCreated datePublished" datetime="2025-06-13T18:40:02+08:00">2025-06-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-29 13:36:32" itemprop="dateModified" datetime="2025-06-29T13:36:32+08:00">2025-06-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system-design/" itemprop="url" rel="index"><span itemprop="name">system-design</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Overview-and-Architecture"><a href="#Overview-and-Architecture" class="headerlink" title="Overview and Architecture"></a>Overview and Architecture</h2><p>A Multi-Tenant Database SDK is a critical component in modern SaaS architectures that enables applications to dynamically manage database connections and operations across multiple tenants. This SDK provides a unified interface for database operations while maintaining tenant isolation and optimizing resource utilization through connection pooling and runtime datasource switching.</p>
<h3 id="Core-Architecture-Components"><a href="#Core-Architecture-Components" class="headerlink" title="Core Architecture Components"></a>Core Architecture Components</h3><pre>
<code class="mermaid">
graph TB
A[SaaS Application] --&gt; B[Multi-Tenant SDK]
B --&gt; C[Tenant Context Manager]
B --&gt; D[Connection Pool Manager]
B --&gt; E[Database Provider Factory]

C --&gt; F[ThreadLocal Storage]
D --&gt; G[MySQL Connection Pool]
D --&gt; H[PostgreSQL Connection Pool]

E --&gt; I[MySQL Provider]
E --&gt; J[PostgreSQL Provider]

I --&gt; K[(MySQL Database)]
J --&gt; L[(PostgreSQL Database)]

B --&gt; M[SPI Registry]
M --&gt; N[Database Provider Interface]
N --&gt; I
N --&gt; J
</code>
</pre>

<p><strong>Interview Insight</strong>: <em>“How would you design a multi-tenant database architecture?”</em></p>
<p>The key is to balance tenant isolation with resource efficiency. Our SDK uses a <strong>database-per-tenant</strong> approach with dynamic datasource switching, which provides strong isolation while maintaining performance through connection pooling.</p>
<h2 id="Tenant-Context-Management"><a href="#Tenant-Context-Management" class="headerlink" title="Tenant Context Management"></a>Tenant Context Management</h2><h3 id="ThreadLocal-Implementation"><a href="#ThreadLocal-Implementation" class="headerlink" title="ThreadLocal Implementation"></a>ThreadLocal Implementation</h3><p>The tenant context is stored using ThreadLocal to ensure thread-safe tenant identification throughout the request lifecycle.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantContext</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; TENANT_ID = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; DATABASE_NAME = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setTenant</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        TENANT_ID.set(tenantId);</span><br><span class="line">        DATABASE_NAME.set(<span class="string">&quot;tenant_&quot;</span> + tenantId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getCurrentTenant</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> TENANT_ID.get();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getCurrentDatabase</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DATABASE_NAME.get();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span> &#123;</span><br><span class="line">        TENANT_ID.remove();</span><br><span class="line">        DATABASE_NAME.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Tenant-Context-Interceptor"><a href="#Tenant-Context-Interceptor" class="headerlink" title="Tenant Context Interceptor"></a>Tenant Context Interceptor</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantContextInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, </span></span><br><span class="line"><span class="params">                           HttpServletResponse response, </span></span><br><span class="line"><span class="params">                           Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> extractTenantId(request);</span><br><span class="line">        <span class="keyword">if</span> (tenantId != <span class="literal">null</span>) &#123;</span><br><span class="line">            TenantContext.setTenant(tenantId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, </span></span><br><span class="line"><span class="params">                              HttpServletResponse response, </span></span><br><span class="line"><span class="params">                              Object handler, Exception ex)</span> &#123;</span><br><span class="line">        TenantContext.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">extractTenantId</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="comment">// Extract from header, JWT token, or subdomain</span></span><br><span class="line">        <span class="keyword">return</span> request.getHeader(<span class="string">&quot;X-Tenant-ID&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“Why use ThreadLocal for tenant context?”</em></p>
<p>ThreadLocal ensures that each request thread maintains its own tenant context without interference from other concurrent requests. This is crucial in multi-threaded web applications where multiple tenants’ requests are processed simultaneously.</p>
<h2 id="Connection-Pool-Management"><a href="#Connection-Pool-Management" class="headerlink" title="Connection Pool Management"></a>Connection Pool Management</h2><h3 id="Dynamic-DataSource-Configuration"><a href="#Dynamic-DataSource-Configuration" class="headerlink" title="Dynamic DataSource Configuration"></a>Dynamic DataSource Configuration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiTenantDataSourceConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">multiTenantDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MultiTenantDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MultiTenantDataSource</span>();</span><br><span class="line">        dataSource.setDefaultTargetDataSource(createDefaultDataSource());</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ConnectionPoolManager <span class="title function_">connectionPoolManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConnectionPoolManager</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Connection-Pool-Manager-Implementation"><a href="#Connection-Pool-Manager-Implementation" class="headerlink" title="Connection Pool Manager Implementation"></a>Connection Pool Manager Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConnectionPoolManager</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, HikariDataSource&gt; dataSources = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DatabaseProviderFactory providerFactory;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ConnectionPoolManager</span><span class="params">(DatabaseProviderFactory providerFactory)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.providerFactory = providerFactory;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">getDataSource</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> dataSources.computeIfAbsent(tenantId, <span class="built_in">this</span>::createDataSource);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> HikariDataSource <span class="title function_">createDataSource</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="type">TenantConfig</span> <span class="variable">config</span> <span class="operator">=</span> getTenantConfig(tenantId);</span><br><span class="line">        <span class="type">DatabaseProvider</span> <span class="variable">provider</span> <span class="operator">=</span> providerFactory.getProvider(config.getDatabaseType());</span><br><span class="line">        </span><br><span class="line">        <span class="type">HikariConfig</span> <span class="variable">hikariConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HikariConfig</span>();</span><br><span class="line">        hikariConfig.setJdbcUrl(provider.buildJdbcUrl(config));</span><br><span class="line">        hikariConfig.setUsername(config.getUsername());</span><br><span class="line">        hikariConfig.setPassword(config.getPassword());</span><br><span class="line">        hikariConfig.setMaximumPoolSize(config.getMaxPoolSize());</span><br><span class="line">        hikariConfig.setMinimumIdle(config.getMinIdle());</span><br><span class="line">        hikariConfig.setConnectionTimeout(config.getConnectionTimeout());</span><br><span class="line">        hikariConfig.setIdleTimeout(config.getIdleTimeout());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HikariDataSource</span>(hikariConfig);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">closeTenantDataSource</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="type">HikariDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> dataSources.remove(tenantId);</span><br><span class="line">        <span class="keyword">if</span> (dataSource != <span class="literal">null</span>) &#123;</span><br><span class="line">            dataSource.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“How do you handle connection pool sizing for multiple tenants?”</em></p>
<p>We use adaptive pool sizing based on tenant usage patterns. Each tenant gets a dedicated connection pool with configurable min&#x2F;max connections. Monitor pool metrics and adjust dynamically based on tenant activity.</p>
<h2 id="Database-Provider-Implementation-via-SPI"><a href="#Database-Provider-Implementation-via-SPI" class="headerlink" title="Database Provider Implementation via SPI"></a>Database Provider Implementation via SPI</h2><h3 id="Service-Provider-Interface"><a href="#Service-Provider-Interface" class="headerlink" title="Service Provider Interface"></a>Service Provider Interface</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DatabaseProvider</span> &#123;</span><br><span class="line">    String <span class="title function_">getProviderName</span><span class="params">()</span>;</span><br><span class="line">    String <span class="title function_">buildJdbcUrl</span><span class="params">(TenantConfig config)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createTenantDatabase</span><span class="params">(TenantConfig config)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createTenantTables</span><span class="params">(String tenantId, List&lt;String&gt; tableSchemas)</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">supportsBatch</span><span class="params">()</span>;</span><br><span class="line">    String <span class="title function_">getDriverClassName</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="MySQL-Provider-Implementation"><a href="#MySQL-Provider-Implementation" class="headerlink" title="MySQL Provider Implementation"></a>MySQL Provider Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySQLDatabaseProvider</span> <span class="keyword">implements</span> <span class="title class_">DatabaseProvider</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getProviderName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;mysql&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">buildJdbcUrl</span><span class="params">(TenantConfig config)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;jdbc:mysql://%s:%d/%s?useSSL=true&amp;serverTimezone=UTC&quot;</span>,</span><br><span class="line">                config.getHost(), config.getPort(), config.getDatabaseName());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createTenantDatabase</span><span class="params">(TenantConfig config)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> getAdminConnection(config)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;CREATE DATABASE IF NOT EXISTS &quot;</span> + config.getDatabaseName() + </span><br><span class="line">                        <span class="string">&quot; CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci&quot;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> (<span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> connection.createStatement()) &#123;</span><br><span class="line">                stmt.execute(sql);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DatabaseException</span>(<span class="string">&quot;Failed to create MySQL database for tenant: &quot;</span> + </span><br><span class="line">                                      config.getTenantId(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createTenantTables</span><span class="params">(String tenantId, List&lt;String&gt; tableSchemas)</span> &#123;</span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> connectionPoolManager.getDataSource(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection()) &#123;</span><br><span class="line">            connection.setAutoCommit(<span class="literal">false</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (String schema : tableSchemas) &#123;</span><br><span class="line">                <span class="keyword">try</span> (<span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> connection.createStatement()) &#123;</span><br><span class="line">                    stmt.execute(schema);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            connection.commit();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DatabaseException</span>(<span class="string">&quot;Failed to create tables for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDriverClassName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PostgreSQL-Provider-Implementation"><a href="#PostgreSQL-Provider-Implementation" class="headerlink" title="PostgreSQL Provider Implementation"></a>PostgreSQL Provider Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PostgreSQLDatabaseProvider</span> <span class="keyword">implements</span> <span class="title class_">DatabaseProvider</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getProviderName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;postgresql&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">buildJdbcUrl</span><span class="params">(TenantConfig config)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;jdbc:postgresql://%s:%d/%s&quot;</span>,</span><br><span class="line">                config.getHost(), config.getPort(), config.getDatabaseName());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createTenantDatabase</span><span class="params">(TenantConfig config)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> getAdminConnection(config)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;CREATE DATABASE &quot;</span> + config.getDatabaseName() + </span><br><span class="line">                        <span class="string">&quot; WITH ENCODING &#x27;UTF8&#x27; LC_COLLATE=&#x27;en_US.UTF-8&#x27; LC_CTYPE=&#x27;en_US.UTF-8&#x27;&quot;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> (<span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> connection.createStatement()) &#123;</span><br><span class="line">                stmt.execute(sql);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DatabaseException</span>(<span class="string">&quot;Failed to create PostgreSQL database for tenant: &quot;</span> + </span><br><span class="line">                                      config.getTenantId(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createTenantTables</span><span class="params">(String tenantId, List&lt;String&gt; tableSchemas)</span> &#123;</span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> connectionPoolManager.getDataSource(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection()) &#123;</span><br><span class="line">            connection.setAutoCommit(<span class="literal">false</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (String schema : tableSchemas) &#123;</span><br><span class="line">                <span class="keyword">try</span> (<span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> connection.createStatement()) &#123;</span><br><span class="line">                    stmt.execute(schema);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            connection.commit();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DatabaseException</span>(<span class="string">&quot;Failed to create tables for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDriverClassName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;org.postgresql.Driver&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SPI-Registry-and-Factory"><a href="#SPI-Registry-and-Factory" class="headerlink" title="SPI Registry and Factory"></a>SPI Registry and Factory</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseProviderFactory</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, DatabaseProvider&gt; providers = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initializeProviders</span><span class="params">()</span> &#123;</span><br><span class="line">        ServiceLoader&lt;DatabaseProvider&gt; serviceLoader = ServiceLoader.load(DatabaseProvider.class);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (DatabaseProvider provider : serviceLoader) &#123;</span><br><span class="line">            providers.put(provider.getProviderName(), provider);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> DatabaseProvider <span class="title function_">getProvider</span><span class="params">(String providerName)</span> &#123;</span><br><span class="line">        <span class="type">DatabaseProvider</span> <span class="variable">provider</span> <span class="operator">=</span> providers.get(providerName.toLowerCase());</span><br><span class="line">        <span class="keyword">if</span> (provider == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedDatabaseException</span>(<span class="string">&quot;Database provider not found: &quot;</span> + providerName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> provider;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Set&lt;String&gt; <span class="title function_">getSupportedProviders</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> providers.keySet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“Why use SPI pattern for database providers?”</em></p>
<p>SPI (Service Provider Interface) enables loose coupling and extensibility. New database providers can be added without modifying existing code, following the Open&#x2F;Closed Principle. It also allows for plugin-based architecture where providers can be loaded dynamically.</p>
<h2 id="Multi-Tenant-Database-Operations"><a href="#Multi-Tenant-Database-Operations" class="headerlink" title="Multi-Tenant Database Operations"></a>Multi-Tenant Database Operations</h2><h3 id="Core-SDK-Interface"><a href="#Core-SDK-Interface" class="headerlink" title="Core SDK Interface"></a>Core SDK Interface</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MultiTenantDatabaseSDK</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createTenant</span><span class="params">(String tenantId, TenantConfig config)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deleteTenant</span><span class="params">(String tenantId)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">executeSql</span><span class="params">(String sql, Object... params)</span>;</span><br><span class="line">    &lt;T&gt; List&lt;T&gt; <span class="title function_">query</span><span class="params">(String sql, RowMapper&lt;T&gt; rowMapper, Object... params)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">executeBatch</span><span class="params">(List&lt;String&gt; sqlStatements)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">executeTransaction</span><span class="params">(TransactionCallback callback)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SDK-Implementation"><a href="#SDK-Implementation" class="headerlink" title="SDK Implementation"></a>SDK Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiTenantDatabaseSDKImpl</span> <span class="keyword">implements</span> <span class="title class_">MultiTenantDatabaseSDK</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConnectionPoolManager connectionPoolManager;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DatabaseProviderFactory providerFactory;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TenantConfigRepository tenantConfigRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createTenant</span><span class="params">(String tenantId, TenantConfig config)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Create database</span></span><br><span class="line">            <span class="type">DatabaseProvider</span> <span class="variable">provider</span> <span class="operator">=</span> providerFactory.getProvider(config.getDatabaseType());</span><br><span class="line">            provider.createTenantDatabase(config);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Create tables</span></span><br><span class="line">            List&lt;String&gt; tableSchemas = loadTableSchemas();</span><br><span class="line">            provider.createTenantTables(tenantId, tableSchemas);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Save tenant configuration</span></span><br><span class="line">            tenantConfigRepository.save(config);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Initialize connection pool</span></span><br><span class="line">            connectionPoolManager.getDataSource(tenantId);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TenantCreationException</span>(<span class="string">&quot;Failed to create tenant: &quot;</span> + tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeSql</span><span class="params">(String sql, Object... params)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> TenantContext.getCurrentTenant();</span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> connectionPoolManager.getDataSource(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection();</span><br><span class="line">             <span class="type">PreparedStatement</span> <span class="variable">stmt</span> <span class="operator">=</span> connection.prepareStatement(sql)) &#123;</span><br><span class="line">            </span><br><span class="line">            setParameters(stmt, params);</span><br><span class="line">            stmt.execute();</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DatabaseException</span>(<span class="string">&quot;Failed to execute SQL for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; List&lt;T&gt; <span class="title function_">query</span><span class="params">(String sql, RowMapper&lt;T&gt; rowMapper, Object... params)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> TenantContext.getCurrentTenant();</span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> connectionPoolManager.getDataSource(tenantId);</span><br><span class="line">        </span><br><span class="line">        List&lt;T&gt; results = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection();</span><br><span class="line">             <span class="type">PreparedStatement</span> <span class="variable">stmt</span> <span class="operator">=</span> connection.prepareStatement(sql)) &#123;</span><br><span class="line">            </span><br><span class="line">            setParameters(stmt, params);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> (<span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> stmt.executeQuery()) &#123;</span><br><span class="line">                <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">                    results.add(rowMapper.mapRow(rs));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DatabaseException</span>(<span class="string">&quot;Failed to query for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> results;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeTransaction</span><span class="params">(TransactionCallback callback)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> TenantContext.getCurrentTenant();</span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> connectionPoolManager.getDataSource(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection()) &#123;</span><br><span class="line">            connection.setAutoCommit(<span class="literal">false</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                callback.doInTransaction(connection);</span><br><span class="line">                connection.commit();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                connection.rollback();</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DatabaseException</span>(<span class="string">&quot;Transaction failed for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Production-Use-Cases-and-Examples"><a href="#Production-Use-Cases-and-Examples" class="headerlink" title="Production Use Cases and Examples"></a>Production Use Cases and Examples</h2><h3 id="Use-Case-1-SaaS-CRM-System"><a href="#Use-Case-1-SaaS-CRM-System" class="headerlink" title="Use Case 1: SaaS CRM System"></a>Use Case 1: SaaS CRM System</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/customers&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MultiTenantDatabaseSDK databaseSDK;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Customer&gt; <span class="title function_">getCustomers</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> databaseSDK.query(</span><br><span class="line">            <span class="string">&quot;SELECT * FROM customers WHERE active = ?&quot;</span>,</span><br><span class="line">            (rs) -&gt; <span class="keyword">new</span> <span class="title class_">Customer</span>(</span><br><span class="line">                rs.getLong(<span class="string">&quot;id&quot;</span>),</span><br><span class="line">                rs.getString(<span class="string">&quot;name&quot;</span>),</span><br><span class="line">                rs.getString(<span class="string">&quot;email&quot;</span>)</span><br><span class="line">            ),</span><br><span class="line">            <span class="literal">true</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createCustomer</span><span class="params">(<span class="meta">@RequestBody</span> Customer customer)</span> &#123;</span><br><span class="line">        databaseSDK.executeSql(</span><br><span class="line">            <span class="string">&quot;INSERT INTO customers (name, email, created_at) VALUES (?, ?, ?)&quot;</span>,</span><br><span class="line">            customer.getName(),</span><br><span class="line">            customer.getEmail(),</span><br><span class="line">            Timestamp.from(Instant.now())</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Use-Case-2-Tenant-Onboarding-Process"><a href="#Use-Case-2-Tenant-Onboarding-Process" class="headerlink" title="Use Case 2: Tenant Onboarding Process"></a>Use Case 2: Tenant Onboarding Process</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantOnboardingService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MultiTenantDatabaseSDK databaseSDK;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onboardNewTenant</span><span class="params">(TenantRegistration registration)</span> &#123;</span><br><span class="line">        <span class="type">TenantConfig</span> <span class="variable">config</span> <span class="operator">=</span> TenantConfig.builder()</span><br><span class="line">            .tenantId(registration.getTenantId())</span><br><span class="line">            .databaseType(<span class="string">&quot;mysql&quot;</span>)</span><br><span class="line">            .host(<span class="string">&quot;localhost&quot;</span>)</span><br><span class="line">            .port(<span class="number">3306</span>)</span><br><span class="line">            .databaseName(<span class="string">&quot;tenant_&quot;</span> + registration.getTenantId())</span><br><span class="line">            .username(<span class="string">&quot;tenant_user&quot;</span>)</span><br><span class="line">            .password(generateSecurePassword())</span><br><span class="line">            .maxPoolSize(<span class="number">10</span>)</span><br><span class="line">            .minIdle(<span class="number">2</span>)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Create tenant database and tables</span></span><br><span class="line">            databaseSDK.createTenant(registration.getTenantId(), config);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Insert initial data</span></span><br><span class="line">            insertInitialData(registration);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Send welcome email</span></span><br><span class="line">            sendWelcomeEmail(registration);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// Rollback tenant creation</span></span><br><span class="line">            databaseSDK.deleteTenant(registration.getTenantId());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TenantOnboardingException</span>(<span class="string">&quot;Failed to onboard tenant&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Use-Case-3-Data-Migration-Between-Tenants"><a href="#Use-Case-3-Data-Migration-Between-Tenants" class="headerlink" title="Use Case 3: Data Migration Between Tenants"></a>Use Case 3: Data Migration Between Tenants</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantDataMigrationService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MultiTenantDatabaseSDK databaseSDK;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">migrateTenantData</span><span class="params">(String sourceTenantId, String targetTenantId)</span> &#123;</span><br><span class="line">        <span class="comment">// Export data from source tenant</span></span><br><span class="line">        TenantContext.setTenant(sourceTenantId);</span><br><span class="line">        List&lt;Customer&gt; customers = databaseSDK.query(</span><br><span class="line">            <span class="string">&quot;SELECT * FROM customers&quot;</span>,</span><br><span class="line">            <span class="built_in">this</span>::mapCustomer</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Import data to target tenant</span></span><br><span class="line">        TenantContext.setTenant(targetTenantId);</span><br><span class="line">        databaseSDK.executeTransaction(connection -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (Customer customer : customers) &#123;</span><br><span class="line">                <span class="type">PreparedStatement</span> <span class="variable">stmt</span> <span class="operator">=</span> connection.prepareStatement(</span><br><span class="line">                    <span class="string">&quot;INSERT INTO customers (name, email, created_at) VALUES (?, ?, ?)&quot;</span></span><br><span class="line">                );</span><br><span class="line">                stmt.setString(<span class="number">1</span>, customer.getName());</span><br><span class="line">                stmt.setString(<span class="number">2</span>, customer.getEmail());</span><br><span class="line">                stmt.setTimestamp(<span class="number">3</span>, customer.getCreatedAt());</span><br><span class="line">                stmt.executeUpdate();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Runtime-Datasource-Switching"><a href="#Runtime-Datasource-Switching" class="headerlink" title="Runtime Datasource Switching"></a>Runtime Datasource Switching</h2><h3 id="Dynamic-DataSource-Routing"><a href="#Dynamic-DataSource-Routing" class="headerlink" title="Dynamic DataSource Routing"></a>Dynamic DataSource Routing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiTenantDataSource</span> <span class="keyword">extends</span> <span class="title class_">AbstractRoutingDataSource</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">determineCurrentLookupKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> TenantContext.getCurrentTenant();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> DataSource <span class="title function_">determineTargetDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> TenantContext.getCurrentTenant();</span><br><span class="line">        <span class="keyword">if</span> (tenantId == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> getDefaultDataSource();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> connectionPoolManager.getDataSource(tenantId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Request-Flow-Diagram"><a href="#Request-Flow-Diagram" class="headerlink" title="Request Flow Diagram"></a>Request Flow Diagram</h3><pre>
<code class="mermaid">
sequenceDiagram
participant Client
participant API Gateway
participant SaaS Service
participant SDK
participant Database

Client-&gt;&gt;API Gateway: Request with tenant info
API Gateway-&gt;&gt;SaaS Service: Forward request
SaaS Service-&gt;&gt;SDK: Set tenant context
SDK-&gt;&gt;SDK: Store in ThreadLocal
SaaS Service-&gt;&gt;SDK: Execute database operation
SDK-&gt;&gt;SDK: Determine datasource
SDK-&gt;&gt;Database: Execute query
Database-&gt;&gt;SDK: Return results
SDK-&gt;&gt;SaaS Service: Return results
SaaS Service-&gt;&gt;Client: Return response
</code>
</pre>

<p><strong>Interview Insight</strong>: <em>“How do you handle database connection switching at runtime?”</em></p>
<p>We use Spring’s AbstractRoutingDataSource combined with ThreadLocal tenant context. The routing happens transparently - when a database operation is requested, the SDK determines the appropriate datasource based on the current tenant context stored in ThreadLocal.</p>
<h2 id="Performance-Optimization-Strategies"><a href="#Performance-Optimization-Strategies" class="headerlink" title="Performance Optimization Strategies"></a>Performance Optimization Strategies</h2><h3 id="Connection-Pool-Tuning"><a href="#Connection-Pool-Tuning" class="headerlink" title="Connection Pool Tuning"></a>Connection Pool Tuning</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;multitenant.pool&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConnectionPoolConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">maxPoolSize</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">minIdle</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">connectionTimeout</span> <span class="operator">=</span> <span class="number">30000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">idleTimeout</span> <span class="operator">=</span> <span class="number">600000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">maxLifetime</span> <span class="operator">=</span> <span class="number">1800000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">leakDetectionThreshold</span> <span class="operator">=</span> <span class="number">60000</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Getters and setters</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Connection-Pool-Monitoring"><a href="#Connection-Pool-Monitoring" class="headerlink" title="Connection Pool Monitoring"></a>Connection Pool Monitoring</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConnectionPoolMonitor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConnectionPoolManager poolManager;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 30000)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">monitorConnectionPools</span><span class="params">()</span> &#123;</span><br><span class="line">        poolManager.getAllDataSources().forEach((tenantId, dataSource) -&gt; &#123;</span><br><span class="line">            <span class="type">HikariPoolMXBean</span> <span class="variable">poolMXBean</span> <span class="operator">=</span> dataSource.getHikariPoolMXBean();</span><br><span class="line">            </span><br><span class="line">            Gauge.builder(<span class="string">&quot;connection.pool.active&quot;</span>)</span><br><span class="line">                .tag(<span class="string">&quot;tenant&quot;</span>, tenantId)</span><br><span class="line">                .register(meterRegistry, poolMXBean, HikariPoolMXBean::getActiveConnections);</span><br><span class="line">                </span><br><span class="line">            Gauge.builder(<span class="string">&quot;connection.pool.idle&quot;</span>)</span><br><span class="line">                .tag(<span class="string">&quot;tenant&quot;</span>, tenantId)</span><br><span class="line">                .register(meterRegistry, poolMXBean, HikariPoolMXBean::getIdleConnections);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Caching-Strategy"><a href="#Caching-Strategy" class="headerlink" title="Caching Strategy"></a>Caching Strategy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantConfigCacheService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LoadingCache&lt;String, TenantConfig&gt; configCache;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TenantConfigCacheService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.configCache = Caffeine.newBuilder()</span><br><span class="line">            .maximumSize(<span class="number">1000</span>)</span><br><span class="line">            .expireAfterWrite(<span class="number">30</span>, TimeUnit.MINUTES)</span><br><span class="line">            .build(<span class="built_in">this</span>::loadTenantConfig);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> TenantConfig <span class="title function_">getTenantConfig</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> configCache.get(tenantId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> TenantConfig <span class="title function_">loadTenantConfig</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> tenantConfigRepository.findByTenantId(tenantId)</span><br><span class="line">            .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">TenantNotFoundException</span>(<span class="string">&quot;Tenant not found: &quot;</span> + tenantId));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Security-and-Compliance"><a href="#Security-and-Compliance" class="headerlink" title="Security and Compliance"></a>Security and Compliance</h2><h3 id="Tenant-Isolation-Security"><a href="#Tenant-Isolation-Security" class="headerlink" title="Tenant Isolation Security"></a>Tenant Isolation Security</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantSecurityValidator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">validateTenantAccess</span><span class="params">(String requestedTenantId, String authenticatedTenantId)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!requestedTenantId.equals(authenticatedTenantId)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TenantAccessDeniedException</span>(<span class="string">&quot;Cross-tenant access denied&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">validateSqlInjection</span><span class="params">(String sql)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (containsSqlInjectionPatterns(sql)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;Potential SQL injection detected&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">containsSqlInjectionPatterns</span><span class="params">(String sql)</span> &#123;</span><br><span class="line">        String[] patterns = &#123;<span class="string">&quot;&#x27;;&quot;</span>, <span class="string">&quot;DROP&quot;</span>, <span class="string">&quot;DELETE&quot;</span>, <span class="string">&quot;UPDATE&quot;</span>, <span class="string">&quot;INSERT&quot;</span>, <span class="string">&quot;UNION&quot;</span>&#125;;</span><br><span class="line">        <span class="type">String</span> <span class="variable">upperSql</span> <span class="operator">=</span> sql.toUpperCase();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> Arrays.stream(patterns)</span><br><span class="line">            .anyMatch(upperSql::contains);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Encryption-and-Data-Protection"><a href="#Encryption-and-Data-Protection" class="headerlink" title="Encryption and Data Protection"></a>Encryption and Data Protection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataEncryptionService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AESUtil aesUtil;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">encryptSensitiveData</span><span class="params">(String data, String tenantId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantKey</span> <span class="operator">=</span> generateTenantSpecificKey(tenantId);</span><br><span class="line">        <span class="keyword">return</span> aesUtil.encrypt(data, tenantKey);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">decryptSensitiveData</span><span class="params">(String encryptedData, String tenantId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantKey</span> <span class="operator">=</span> generateTenantSpecificKey(tenantId);</span><br><span class="line">        <span class="keyword">return</span> aesUtil.decrypt(encryptedData, tenantKey);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">generateTenantSpecificKey</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="comment">// Generate tenant-specific encryption key</span></span><br><span class="line">        <span class="keyword">return</span> keyDerivationService.deriveKey(tenantId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Error-Handling-and-Resilience"><a href="#Error-Handling-and-Resilience" class="headerlink" title="Error Handling and Resilience"></a>Error Handling and Resilience</h2><h3 id="Exception-Hierarchy"><a href="#Exception-Hierarchy" class="headerlink" title="Exception Hierarchy"></a>Exception Hierarchy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseException</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DatabaseException</span><span class="params">(String message, Throwable cause)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message, cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantNotFoundException</span> <span class="keyword">extends</span> <span class="title class_">DatabaseException</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TenantNotFoundException</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantCreationException</span> <span class="keyword">extends</span> <span class="title class_">DatabaseException</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TenantCreationException</span><span class="params">(String message, Throwable cause)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message, cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Retry-Mechanism"><a href="#Retry-Mechanism" class="headerlink" title="Retry Mechanism"></a>Retry Mechanism</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseRetryService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RetryTemplate retryTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DatabaseRetryService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.retryTemplate = RetryTemplate.builder()</span><br><span class="line">            .maxAttempts(<span class="number">3</span>)</span><br><span class="line">            .exponentialBackoff(<span class="number">1000</span>, <span class="number">2</span>, <span class="number">10000</span>)</span><br><span class="line">            .retryOn(SQLException.class, DataAccessException.class)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">executeWithRetry</span><span class="params">(Supplier&lt;T&gt; operation)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> retryTemplate.execute(context -&gt; operation.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Circuit-Breaker-Implementation"><a href="#Circuit-Breaker-Implementation" class="headerlink" title="Circuit Breaker Implementation"></a>Circuit Breaker Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseCircuitBreaker</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CircuitBreaker circuitBreaker;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DatabaseCircuitBreaker</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.circuitBreaker = CircuitBreaker.ofDefaults(<span class="string">&quot;database&quot;</span>);</span><br><span class="line">        circuitBreaker.getEventPublisher()</span><br><span class="line">            .onStateTransition(event -&gt; </span><br><span class="line">                log.info(<span class="string">&quot;Circuit breaker state transition: &#123;&#125;&quot;</span>, event));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">executeWithCircuitBreaker</span><span class="params">(Supplier&lt;T&gt; operation)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> circuitBreaker.executeSupplier(operation);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Testing-Strategies"><a href="#Testing-Strategies" class="headerlink" title="Testing Strategies"></a>Testing Strategies</h2><h3 id="Unit-Testing"><a href="#Unit-Testing" class="headerlink" title="Unit Testing"></a>Unit Testing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExtendWith(MockitoExtension.class)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MultiTenantDatabaseSDKTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> ConnectionPoolManager connectionPoolManager;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> DatabaseProviderFactory providerFactory;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@InjectMocks</span></span><br><span class="line">    <span class="keyword">private</span> MultiTenantDatabaseSDKImpl sdk;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldExecuteSqlForCurrentTenant</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Given</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> <span class="string">&quot;tenant-123&quot;</span>;</span><br><span class="line">        TenantContext.setTenant(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">mockDataSource</span> <span class="operator">=</span> mock(DataSource.class);</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">mockConnection</span> <span class="operator">=</span> mock(Connection.class);</span><br><span class="line">        <span class="type">PreparedStatement</span> <span class="variable">mockStatement</span> <span class="operator">=</span> mock(PreparedStatement.class);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">when</span>(connectionPoolManager.getDataSource(tenantId)).thenReturn(mockDataSource);</span><br><span class="line">        <span class="keyword">when</span>(mockDataSource.getConnection()).thenReturn(mockConnection);</span><br><span class="line">        <span class="keyword">when</span>(mockConnection.prepareStatement(anyString())).thenReturn(mockStatement);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When</span></span><br><span class="line">        sdk.executeSql(<span class="string">&quot;INSERT INTO users (name) VALUES (?)&quot;</span>, <span class="string">&quot;John&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Then</span></span><br><span class="line">        verify(mockStatement).setString(<span class="number">1</span>, <span class="string">&quot;John&quot;</span>);</span><br><span class="line">        verify(mockStatement).execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Integration-Testing"><a href="#Integration-Testing" class="headerlink" title="Integration Testing"></a>Integration Testing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@TestPropertySource(properties = &#123;</span></span><br><span class="line"><span class="meta">    &quot;spring.datasource.url=jdbc:h2:mem:testdb&quot;,</span></span><br><span class="line"><span class="meta">    &quot;spring.jpa.hibernate.ddl-auto=create-drop&quot;</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MultiTenantIntegrationTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MultiTenantDatabaseSDK sdk;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldCreateTenantAndExecuteOperations</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Given</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> <span class="string">&quot;test-tenant&quot;</span>;</span><br><span class="line">        <span class="type">TenantConfig</span> <span class="variable">config</span> <span class="operator">=</span> createTestTenantConfig(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When</span></span><br><span class="line">        sdk.createTenant(tenantId, config);</span><br><span class="line">        </span><br><span class="line">        TenantContext.setTenant(tenantId);</span><br><span class="line">        sdk.executeSql(<span class="string">&quot;INSERT INTO users (name, email) VALUES (?, ?)&quot;</span>, <span class="string">&quot;John&quot;</span>, <span class="string">&quot;john@example.com&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        List&lt;User&gt; users = sdk.query(<span class="string">&quot;SELECT * FROM users&quot;</span>, <span class="built_in">this</span>::mapUser);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Then</span></span><br><span class="line">        assertThat(users).hasSize(<span class="number">1</span>);</span><br><span class="line">        assertThat(users.get(<span class="number">0</span>).getName()).isEqualTo(<span class="string">&quot;John&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Monitoring-and-Observability"><a href="#Monitoring-and-Observability" class="headerlink" title="Monitoring and Observability"></a>Monitoring and Observability</h2><h3 id="Metrics-Collection"><a href="#Metrics-Collection" class="headerlink" title="Metrics Collection"></a>Metrics Collection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiTenantMetrics</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter tenantCreationCounter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Timer databaseOperationTimer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Gauge activeTenantGauge;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MultiTenantMetrics</span><span class="params">(MeterRegistry meterRegistry)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.tenantCreationCounter = Counter.builder(<span class="string">&quot;tenant.creation.count&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.databaseOperationTimer = Timer.builder(<span class="string">&quot;database.operation.time&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.activeTenantGauge = Gauge.builder(<span class="string">&quot;tenant.active.count&quot;</span>)</span><br><span class="line">            .register(meterRegistry, <span class="built_in">this</span>, MultiTenantMetrics::getActiveTenantCount);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordTenantCreation</span><span class="params">()</span> &#123;</span><br><span class="line">        tenantCreationCounter.increment();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordDatabaseOperation</span><span class="params">(Duration duration)</span> &#123;</span><br><span class="line">        databaseOperationTimer.record(duration);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> <span class="title function_">getActiveTenantCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> connectionPoolManager.getActiveTenantCount();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Health-Checks"><a href="#Health-Checks" class="headerlink" title="Health Checks"></a>Health Checks</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiTenantHealthIndicator</span> <span class="keyword">implements</span> <span class="title class_">HealthIndicator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConnectionPoolManager connectionPoolManager;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Health <span class="title function_">health</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">activeTenants</span> <span class="operator">=</span> connectionPoolManager.getActiveTenantCount();</span><br><span class="line">            <span class="type">int</span> <span class="variable">totalConnections</span> <span class="operator">=</span> connectionPoolManager.getTotalActiveConnections();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> Health.up()</span><br><span class="line">                .withDetail(<span class="string">&quot;activeTenants&quot;</span>, activeTenants)</span><br><span class="line">                .withDetail(<span class="string">&quot;totalConnections&quot;</span>, totalConnections)</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> Health.down()</span><br><span class="line">                .withException(e)</span><br><span class="line">                .build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Deployment-and-Configuration"><a href="#Deployment-and-Configuration" class="headerlink" title="Deployment and Configuration"></a>Deployment and Configuration</h2><h3 id="Docker-Configuration"><a href="#Docker-Configuration" class="headerlink" title="Docker Configuration"></a>Docker Configuration</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">11</span>-jre-slim</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> target/multi-tenant-sdk.jar app.jar</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> JAVA_OPTS=<span class="string">&quot;-Xmx2g -Xms1g&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> HIKARI_MAX_POOL_SIZE=<span class="number">20</span></span><br><span class="line"><span class="keyword">ENV</span> HIKARI_MIN_IDLE=<span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;java <span class="variable">$JAVA_OPTS</span> -jar /app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h3 id="Kubernetes-Deployment"><a href="#Kubernetes-Deployment" class="headerlink" title="Kubernetes Deployment"></a>Kubernetes Deployment</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">multi-tenant-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">multi-tenant-app</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">multi-tenant-app</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">multi-tenant-sdk:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_PROFILES_ACTIVE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;production&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DATABASE_MAX_POOL_SIZE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;20&quot;</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;2Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;1000m&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Common-Interview-Questions-and-Answers"><a href="#Common-Interview-Questions-and-Answers" class="headerlink" title="Common Interview Questions and Answers"></a>Common Interview Questions and Answers</h2><p><strong>Q: “How do you handle tenant data isolation?”</strong></p>
<p>A: We implement database-per-tenant isolation using dynamic datasource routing. Each tenant has its own database and connection pool, ensuring complete data isolation. The SDK uses ThreadLocal to maintain tenant context throughout the request lifecycle.</p>
<p><strong>Q: “What happens if a tenant’s database becomes unavailable?”</strong></p>
<p>A: We implement circuit breaker pattern and retry mechanisms. If a tenant’s database is unavailable, the circuit breaker opens, preventing cascading failures. We also have health checks that monitor each tenant’s database connectivity.</p>
<p><strong>Q: “How do you handle database migrations across multiple tenants?”</strong></p>
<p>A: We use a versioned migration system where each tenant’s database schema version is tracked. Migrations are applied tenant by tenant, with rollback capabilities. Critical migrations are tested in staging environments first.</p>
<p><strong>Q: “How do you optimize connection pool usage?”</strong></p>
<p>A: We use adaptive connection pool sizing based on tenant activity. Inactive tenants have smaller pools, while active tenants get more connections. We also implement connection</p>
<h2 id="Advanced-Features-and-Extensions"><a href="#Advanced-Features-and-Extensions" class="headerlink" title="Advanced Features and Extensions"></a>Advanced Features and Extensions</h2><h3 id="Tenant-Database-Sharding"><a href="#Tenant-Database-Sharding" class="headerlink" title="Tenant Database Sharding"></a>Tenant Database Sharding</h3><p>For high-scale scenarios, the SDK supports database sharding across multiple database servers:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantShardingManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ShardConfig&gt; shards;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConsistentHashing&lt;String&gt; hashRing;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TenantShardingManager</span><span class="params">(List&lt;ShardConfig&gt; shards)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.shards = shards;</span><br><span class="line">        <span class="built_in">this</span>.hashRing = <span class="keyword">new</span> <span class="title class_">ConsistentHashing</span>&lt;&gt;(</span><br><span class="line">            shards.stream().map(ShardConfig::getShardId).collect(Collectors.toList())</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ShardConfig <span class="title function_">getShardForTenant</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">shardId</span> <span class="operator">=</span> hashRing.getNode(tenantId);</span><br><span class="line">        <span class="keyword">return</span> shards.stream()</span><br><span class="line">            .filter(shard -&gt; shard.getShardId().equals(shardId))</span><br><span class="line">            .findFirst()</span><br><span class="line">            .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">ShardNotFoundException</span>(<span class="string">&quot;Shard not found for tenant: &quot;</span> + tenantId));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rebalanceShards</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Implement shard rebalancing logic</span></span><br><span class="line">        <span class="keyword">for</span> (ShardConfig shard : shards) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">currentLoad</span> <span class="operator">=</span> calculateShardLoad(shard);</span><br><span class="line">            <span class="keyword">if</span> (currentLoad &gt; shard.getMaxCapacity() * <span class="number">0.8</span>) &#123;</span><br><span class="line">                triggerShardSplit(shard);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Tenant-Migration-and-Backup"><a href="#Tenant-Migration-and-Backup" class="headerlink" title="Tenant Migration and Backup"></a>Tenant Migration and Backup</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantMigrationService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MultiTenantDatabaseSDK databaseSDK;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TenantBackupService backupService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">migrateTenant</span><span class="params">(String tenantId, TenantConfig newConfig)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Create backup before migration</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">backupId</span> <span class="operator">=</span> backupService.createBackup(tenantId);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Export tenant data</span></span><br><span class="line">            <span class="type">TenantData</span> <span class="variable">exportedData</span> <span class="operator">=</span> exportTenantData(tenantId);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Create new tenant database</span></span><br><span class="line">            databaseSDK.createTenant(tenantId + <span class="string">&quot;_new&quot;</span>, newConfig);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Import data to new database</span></span><br><span class="line">            importTenantData(tenantId + <span class="string">&quot;_new&quot;</span>, exportedData);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Validate migration</span></span><br><span class="line">            <span class="keyword">if</span> (validateMigration(tenantId, tenantId + <span class="string">&quot;_new&quot;</span>)) &#123;</span><br><span class="line">                <span class="comment">// Switch to new database</span></span><br><span class="line">                switchTenantDatabase(tenantId, newConfig);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Cleanup old database</span></span><br><span class="line">                databaseSDK.deleteTenant(tenantId + <span class="string">&quot;_old&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Rollback</span></span><br><span class="line">                restoreFromBackup(tenantId, backupId);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TenantMigrationException</span>(<span class="string">&quot;Migration failed for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> TenantData <span class="title function_">exportTenantData</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        TenantContext.setTenant(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="type">TenantData</span> <span class="variable">data</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TenantData</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Export all tables</span></span><br><span class="line">        List&lt;String&gt; tables = databaseSDK.query(</span><br><span class="line">            <span class="string">&quot;SELECT table_name FROM information_schema.tables WHERE table_schema = ?&quot;</span>,</span><br><span class="line">            rs -&gt; rs.getString(<span class="string">&quot;table_name&quot;</span>),</span><br><span class="line">            TenantContext.getCurrentDatabase()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String table : tables) &#123;</span><br><span class="line">            List&lt;Map&lt;String, Object&gt;&gt; tableData = databaseSDK.query(</span><br><span class="line">                <span class="string">&quot;SELECT * FROM &quot;</span> + table,</span><br><span class="line">                <span class="built_in">this</span>::mapRowToMap</span><br><span class="line">            );</span><br><span class="line">            data.addTableData(table, tableData);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Read-Replica-Support"><a href="#Read-Replica-Support" class="headerlink" title="Read Replica Support"></a>Read Replica Support</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReadReplicaManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, List&lt;DataSource&gt;&gt; readReplicas = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LoadBalancer loadBalancer;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">getReadDataSource</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        List&lt;DataSource&gt; replicas = readReplicas.get(tenantId);</span><br><span class="line">        <span class="keyword">if</span> (replicas == <span class="literal">null</span> || replicas.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> connectionPoolManager.getDataSource(tenantId); <span class="comment">// Fallback to master</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> loadBalancer.selectDataSource(replicas);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addReadReplica</span><span class="params">(String tenantId, TenantConfig replicaConfig)</span> &#123;</span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">replicaDataSource</span> <span class="operator">=</span> createDataSource(replicaConfig);</span><br><span class="line">        readReplicas.computeIfAbsent(tenantId, k -&gt; <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;()).add(replicaDataSource);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 30000)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">monitorReplicaHealth</span><span class="params">()</span> &#123;</span><br><span class="line">        readReplicas.forEach((tenantId, replicas) -&gt; &#123;</span><br><span class="line">            replicas.removeIf(replica -&gt; !isHealthy(replica));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Multi-Database-Transaction-Support"><a href="#Multi-Database-Transaction-Support" class="headerlink" title="Multi-Database Transaction Support"></a>Multi-Database Transaction Support</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiTenantTransactionManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PlatformTransactionManager transactionManager;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeMultiTenantTransaction</span><span class="params">(List&lt;String&gt; tenantIds, </span></span><br><span class="line"><span class="params">                                            MultiTenantTransactionCallback callback)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">TransactionStatus</span> <span class="variable">status</span> <span class="operator">=</span> transactionManager.getTransaction(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">DefaultTransactionDefinition</span>()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Map&lt;String, Connection&gt; connections = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Get connections for all tenants</span></span><br><span class="line">            <span class="keyword">for</span> (String tenantId : tenantIds) &#123;</span><br><span class="line">                <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> connectionPoolManager.getDataSource(tenantId);</span><br><span class="line">                connections.put(tenantId, dataSource.getConnection());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Execute callback with all connections</span></span><br><span class="line">            callback.doInTransaction(connections);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Commit all transactions</span></span><br><span class="line">            connections.values().forEach(conn -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    conn.commit();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            transactionManager.commit(status);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            transactionManager.rollback(status);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MultiTenantTransactionException</span>(<span class="string">&quot;Multi-tenant transaction failed&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Benchmarking-and-Optimization"><a href="#Performance-Benchmarking-and-Optimization" class="headerlink" title="Performance Benchmarking and Optimization"></a>Performance Benchmarking and Optimization</h2><h3 id="Benchmark-Results"><a href="#Benchmark-Results" class="headerlink" title="Benchmark Results"></a>Benchmark Results</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PerformanceBenchmark</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MultiTenantDatabaseSDK sdk;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">benchmarkOnStartup</span><span class="params">(ApplicationReadyEvent event)</span> &#123;</span><br><span class="line">        runConnectionPoolBenchmark();</span><br><span class="line">        runTenantSwitchingBenchmark();</span><br><span class="line">        runConcurrentAccessBenchmark();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">runConnectionPoolBenchmark</span><span class="params">()</span> &#123;</span><br><span class="line">        Timer.<span class="type">Sample</span> <span class="variable">sample</span> <span class="operator">=</span> Timer.start(meterRegistry);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Test connection acquisition time</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> <span class="string">&quot;tenant-&quot;</span> + (i % <span class="number">10</span>);</span><br><span class="line">            TenantContext.setTenant(tenantId);</span><br><span class="line">            </span><br><span class="line">            sdk.query(<span class="string">&quot;SELECT 1&quot;</span>, rs -&gt; rs.getInt(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        sample.stop(Timer.builder(<span class="string">&quot;benchmark.connection.pool&quot;</span>).register(meterRegistry));</span><br><span class="line">        </span><br><span class="line">        log.info(<span class="string">&quot;Connection pool benchmark: &#123;&#125; ms&quot;</span>, (endTime - startTime) / <span class="number">1_000_000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">runTenantSwitchingBenchmark</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">iterations</span> <span class="operator">=</span> <span class="number">10000</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; iterations; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> <span class="string">&quot;tenant-&quot;</span> + (i % <span class="number">100</span>);</span><br><span class="line">            TenantContext.setTenant(tenantId);</span><br><span class="line">            <span class="comment">// Simulate tenant switching overhead</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        <span class="type">double</span> <span class="variable">avgSwitchTime</span> <span class="operator">=</span> (endTime - startTime) / <span class="number">1_000_000.0</span> / iterations;</span><br><span class="line">        </span><br><span class="line">        log.info(<span class="string">&quot;Average tenant switching time: &#123;&#125; ms&quot;</span>, avgSwitchTime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Performance-Optimization-Recommendations"><a href="#Performance-Optimization-Recommendations" class="headerlink" title="Performance Optimization Recommendations"></a>Performance Optimization Recommendations</h3><pre>
<code class="mermaid">
graph LR
A[Performance Optimization] --&gt; B[Connection Pooling]
A --&gt; C[Caching Strategy]
A --&gt; D[Query Optimization]
A --&gt; E[Resource Management]

B --&gt; B1[HikariCP Configuration]
B --&gt; B2[Pool Size Tuning]
B --&gt; B3[Connection Validation]

C --&gt; C1[Tenant Config Cache]
C --&gt; C2[Query Result Cache]
C --&gt; C3[Schema Cache]

D --&gt; D1[Prepared Statements]
D --&gt; D2[Batch Operations]
D --&gt; D3[Index Optimization]

E --&gt; E1[Memory Management]
E --&gt; E2[Thread Pool Tuning]
E --&gt; E3[GC Optimization]
</code>
</pre>

<h2 id="Security-Best-Practices"><a href="#Security-Best-Practices" class="headerlink" title="Security Best Practices"></a>Security Best Practices</h2><h3 id="Security-Architecture"><a href="#Security-Architecture" class="headerlink" title="Security Architecture"></a>Security Architecture</h3><pre>
<code class="mermaid">
graph TB
A[Client Request] --&gt; B[API Gateway]
B --&gt; C[Authentication Service]
C --&gt; D[Tenant Authorization]
D --&gt; E[Multi-Tenant SDK]
E --&gt; F[Security Validator]
F --&gt; G[Encrypted Connection]
G --&gt; H[Tenant Database]

I[Security Layers]
I --&gt; J[Network Security]
I --&gt; K[Application Security]
I --&gt; L[Database Security]
I --&gt; M[Data Encryption]
</code>
</pre>

<h3 id="Advanced-Security-Features"><a href="#Advanced-Security-Features" class="headerlink" title="Advanced Security Features"></a>Advanced Security Features</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantSecurityEnforcer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TenantPermissionService permissionService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuditLogService auditService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Around(&quot;@annotation(SecureTenantOperation)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">enforceSecurityz</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> TenantContext.getCurrentTenant();</span><br><span class="line">        <span class="type">String</span> <span class="variable">operation</span> <span class="operator">=</span> joinPoint.getSignature().getName();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Validate tenant access</span></span><br><span class="line">        <span class="keyword">if</span> (!permissionService.hasPermission(tenantId, operation)) &#123;</span><br><span class="line">            auditService.logUnauthorizedAccess(tenantId, operation);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TenantAccessDeniedException</span>(<span class="string">&quot;Access denied for operation: &quot;</span> + operation);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Rate limiting</span></span><br><span class="line">        <span class="keyword">if</span> (!rateLimiter.tryAcquire(tenantId)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RateLimitExceededException</span>(<span class="string">&quot;Rate limit exceeded for tenant: &quot;</span> + tenantId);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> joinPoint.proceed();</span><br><span class="line">            auditService.logSuccessfulOperation(tenantId, operation);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            auditService.logFailedOperation(tenantId, operation, e);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Data-Masking-and-Privacy"><a href="#Data-Masking-and-Privacy" class="headerlink" title="Data Masking and Privacy"></a>Data Masking and Privacy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataPrivacyManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, DataMaskingRule&gt; maskingRules;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ResultSet <span class="title function_">maskSensitiveData</span><span class="params">(ResultSet resultSet, String tenantId)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="type">TenantPrivacyConfig</span> <span class="variable">config</span> <span class="operator">=</span> getPrivacyConfig(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> (resultSet.next()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (DataMaskingRule rule : config.getMaskingRules()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">columnName</span> <span class="operator">=</span> rule.getColumnName();</span><br><span class="line">                <span class="type">String</span> <span class="variable">originalValue</span> <span class="operator">=</span> resultSet.getString(columnName);</span><br><span class="line">                <span class="type">String</span> <span class="variable">maskedValue</span> <span class="operator">=</span> applyMasking(originalValue, rule.getMaskingType());</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Update result set with masked value</span></span><br><span class="line">                ((UpdatableResultSet) resultSet).updateString(columnName, maskedValue);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> resultSet;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">applyMasking</span><span class="params">(String value, MaskingType type)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">            <span class="keyword">case</span> EMAIL:</span><br><span class="line">                <span class="keyword">return</span> maskEmail(value);</span><br><span class="line">            <span class="keyword">case</span> PHONE:</span><br><span class="line">                <span class="keyword">return</span> maskPhone(value);</span><br><span class="line">            <span class="keyword">case</span> CREDIT_CARD:</span><br><span class="line">                <span class="keyword">return</span> maskCreditCard(value);</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Disaster-Recovery-and-High-Availability"><a href="#Disaster-Recovery-and-High-Availability" class="headerlink" title="Disaster Recovery and High Availability"></a>Disaster Recovery and High Availability</h2><h3 id="Backup-and-Recovery-Strategy"><a href="#Backup-and-Recovery-Strategy" class="headerlink" title="Backup and Recovery Strategy"></a>Backup and Recovery Strategy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantBackupService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CloudStorageService storageService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DatabaseProvider databaseProvider;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0 0 2 * * *&quot;)</span> <span class="comment">// Daily at 2 AM</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performScheduledBackups</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;String&gt; activeTenants = getActiveTenants();</span><br><span class="line">        </span><br><span class="line">        activeTenants.parallelStream().forEach(tenantId -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">BackupResult</span> <span class="variable">result</span> <span class="operator">=</span> createBackup(tenantId);</span><br><span class="line">                storageService.uploadBackup(result);</span><br><span class="line">                cleanupOldBackups(tenantId);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;Backup failed for tenant: &#123;&#125;&quot;</span>, tenantId, e);</span><br><span class="line">                alertService.sendBackupFailureAlert(tenantId, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">createBackup</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">backupId</span> <span class="operator">=</span> generateBackupId(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TenantContext.setTenant(tenantId);</span><br><span class="line">            <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> connectionPoolManager.getDataSource(tenantId);</span><br><span class="line">            </span><br><span class="line">            <span class="type">BackupConfig</span> <span class="variable">config</span> <span class="operator">=</span> BackupConfig.builder()</span><br><span class="line">                .tenantId(tenantId)</span><br><span class="line">                .backupId(backupId)</span><br><span class="line">                .timestamp(Instant.now())</span><br><span class="line">                .compressionEnabled(<span class="literal">true</span>)</span><br><span class="line">                .encryptionEnabled(<span class="literal">true</span>)</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">            databaseProvider.createBackup(dataSource, config);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> backupId;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BackupException</span>(<span class="string">&quot;Backup creation failed for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">restoreFromBackup</span><span class="params">(String tenantId, String backupId)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">BackupMetadata</span> <span class="variable">metadata</span> <span class="operator">=</span> getBackupMetadata(tenantId, backupId);</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">backupStream</span> <span class="operator">=</span> storageService.downloadBackup(metadata.getStoragePath());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Create temporary database for restoration</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">tempTenantId</span> <span class="operator">=</span> tenantId + <span class="string">&quot;_restore_&quot;</span> + System.currentTimeMillis();</span><br><span class="line">            databaseProvider.restoreFromBackup(tempTenantId, backupStream);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Validate restoration</span></span><br><span class="line">            <span class="keyword">if</span> (validateRestoration(tenantId, tempTenantId)) &#123;</span><br><span class="line">                <span class="comment">// Switch to restored database</span></span><br><span class="line">                switchTenantDatabase(tenantId, tempTenantId);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RestoreException</span>(<span class="string">&quot;Backup validation failed&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RestoreException</span>(<span class="string">&quot;Restoration failed for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="High-Availability-Configuration"><a href="#High-Availability-Configuration" class="headerlink" title="High Availability Configuration"></a>High Availability Configuration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HighAvailabilityConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LoadBalancer <span class="title function_">databaseLoadBalancer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> LoadBalancer.builder()</span><br><span class="line">            .algorithm(LoadBalancingAlgorithm.ROUND_ROBIN)</span><br><span class="line">            .healthCheckInterval(Duration.ofSeconds(<span class="number">30</span>))</span><br><span class="line">            .failoverTimeout(Duration.ofSeconds(<span class="number">5</span>))</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FailoverManager <span class="title function_">failoverManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FailoverManager</span>(databaseProviderFactory, alertService);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FailoverManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, List&lt;TenantConfig&gt;&gt; replicaConfigs = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDatabaseFailure</span><span class="params">(DatabaseFailureEvent event)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> event.getTenantId();</span><br><span class="line">        </span><br><span class="line">        log.warn(<span class="string">&quot;Database failure detected for tenant: &#123;&#125;&quot;</span>, tenantId);</span><br><span class="line">        </span><br><span class="line">        List&lt;TenantConfig&gt; replicas = replicaConfigs.get(tenantId);</span><br><span class="line">        <span class="keyword">if</span> (replicas != <span class="literal">null</span> &amp;&amp; !replicas.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (TenantConfig replica : replicas) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isHealthy(replica)) &#123;</span><br><span class="line">                    performFailover(tenantId, replica);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            alertService.sendCriticalAlert(<span class="string">&quot;No healthy replicas available for tenant: &quot;</span> + tenantId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">performFailover</span><span class="params">(String tenantId, TenantConfig replicaConfig)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Update connection pool to use replica</span></span><br><span class="line">            connectionPoolManager.updateDataSource(tenantId, replicaConfig);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Update tenant configuration</span></span><br><span class="line">            tenantConfigRepository.updateConfig(tenantId, replicaConfig);</span><br><span class="line">            </span><br><span class="line">            log.info(<span class="string">&quot;Failover completed for tenant: &#123;&#125;&quot;</span>, tenantId);</span><br><span class="line">            alertService.sendFailoverAlert(tenantId, replicaConfig.getHost());</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Failover failed for tenant: &#123;&#125;&quot;</span>, tenantId, e);</span><br><span class="line">            alertService.sendFailoverFailureAlert(tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="External-References-and-Resources"><a href="#External-References-and-Resources" class="headerlink" title="External References and Resources"></a>External References and Resources</h2><h3 id="Documentation-and-Specifications"><a href="#Documentation-and-Specifications" class="headerlink" title="Documentation and Specifications"></a>Documentation and Specifications</h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/brettwooldridge/HikariCP#configuration-knobs-baby">HikariCP Configuration Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/tutorial/ext/basics/spi.html">Java SPI Tutorial</a></li>
<li><a target="_blank" rel="noopener" href="https://spring.io/blog/2022/07/31/how-to-integrate-hibernates-multitenant-feature-with-spring-data-jpa-in-a-spring-boot-application">Spring Boot Multi-Tenancy</a></li>
<li><a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/current/ddl-schemas.html">PostgreSQL Multi-Tenant Patterns</a></li>
<li><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/multiple-servers.html">MySQL Multi-Tenancy Best Practices</a></li>
</ul>
<h3 id="Performance-and-Monitoring"><a href="#Performance-and-Monitoring" class="headerlink" title="Performance and Monitoring"></a>Performance and Monitoring</h3><ul>
<li><a target="_blank" rel="noopener" href="https://micrometer.io/docs">Micrometer Metrics</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/brettwooldridge/HikariCP/wiki/MBean-(JMX)-Monitoring-and-Management">Connection Pool Monitoring</a></li>
<li><a target="_blank" rel="noopener" href="https://use-the-index-luke.com/">Database Performance Tuning</a></li>
</ul>
<h3 id="Security-Resources"><a href="#Security-Resources" class="headerlink" title="Security Resources"></a>Security Resources</h3><ul>
<li><a target="_blank" rel="noopener" href="https://owasp.org/www-project-database-security/">OWASP Database Security</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/architecture/guide/multitenant/considerations/data-partitioning">Multi-Tenant Security Patterns</a></li>
<li><a target="_blank" rel="noopener" href="https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html">SQL Injection Prevention</a></li>
</ul>
<h3 id="Cloud-and-DevOps"><a href="#Cloud-and-DevOps" class="headerlink" title="Cloud and DevOps"></a>Cloud and DevOps</h3><ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/extend-kubernetes/operator/">Kubernetes Database Operators</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/develop/dev-best-practices/">Docker Multi-Stage Builds</a></li>
<li><a target="_blank" rel="noopener" href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/db_instance">Terraform Database Provisioning</a></li>
</ul>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>This Multi-Tenant Database SDK provides a comprehensive solution for managing database operations across multiple tenants in a SaaS environment. The design emphasizes security, performance, and scalability while maintaining simplicity for developers.</p>
<p>Key benefits of this architecture include:</p>
<ul>
<li><strong>Strong tenant isolation</strong> through database-per-tenant approach</li>
<li><strong>High performance</strong> via connection pooling and caching strategies</li>
<li><strong>Extensibility</strong> through SPI pattern for database providers</li>
<li><strong>Production readiness</strong> with monitoring, backup, and failover capabilities</li>
<li><strong>Security</strong> with encryption, audit logging, and access controls</li>
</ul>
<p>The SDK can be extended to support additional database providers, implement more sophisticated sharding strategies, or integrate with cloud-native services. Regular monitoring and performance tuning ensure optimal operation in production environments.</p>
<p>Remember to adapt the configuration and implementation details based on your specific requirements, such as tenant scale, database types, and compliance needs. The provided examples serve as a solid foundation for building a robust multi-tenant database solution.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Charlie Feng</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
