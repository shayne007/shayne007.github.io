<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"shayne007.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="This place is for thinking and sharing.">
<meta property="og:type" content="website">
<meta property="og:title" content="Charlie Feng&#39;s Tech Space">
<meta property="og:url" content="https://shayne007.github.io/page/2/index.html">
<meta property="og:site_name" content="Charlie Feng&#39;s Tech Space">
<meta property="og:description" content="This place is for thinking and sharing.">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Charlie Feng">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://shayne007.github.io/page/2/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Charlie Feng's Tech Space</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"cdn":false,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.5.0/mermaid.min.js","integrity":"sha256-2obLuIPcceEhkE3G09G33hBdmE55ivVcZUlcKcGNHjU="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>





  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Charlie Feng's Tech Space</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">You will survive with skills</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Charlie Feng</p>
  <div class="site-description" itemprop="description">This place is for thinking and sharing.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">21</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/08/MySQL-Buffer-Pool-Complete-Theory-and-Best-Practices-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/08/MySQL-Buffer-Pool-Complete-Theory-and-Best-Practices-Guide/" class="post-title-link" itemprop="url">MySQL Buffer Pool: Complete Theory and Best Practices Guide</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-08 16:00:45 / Modified: 16:02:21" itemprop="dateCreated datePublished" datetime="2025-06-08T16:00:45+08:00">2025-06-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Theoretical-Foundation"><a href="#Theoretical-Foundation" class="headerlink" title="Theoretical Foundation"></a>Theoretical Foundation</h2><h3 id="What-is-the-Buffer-Pool"><a href="#What-is-the-Buffer-Pool" class="headerlink" title="What is the Buffer Pool?"></a>What is the Buffer Pool?</h3><p>The MySQL buffer pool is InnoDB’s main memory cache that stores data and index pages in RAM. It acts as a crucial buffer between your application and the slower disk storage, dramatically reducing I&#x2F;O operations and improving query performance.</p>
<p><strong>Core Concepts:</strong></p>
<ul>
<li><strong>Pages</strong>: InnoDB stores data in 16KB pages (by default). The buffer pool manages these pages in memory</li>
<li><strong>Cache Layer</strong>: Acts as a write-through cache for reads and a write-back cache for modifications</li>
<li><strong>Memory Management</strong>: Uses sophisticated algorithms to decide which pages to keep in memory</li>
<li><strong>Concurrency</strong>: Supports multiple buffer pool instances for better multi-threaded performance</li>
</ul>
<h3 id="Why-Buffer-Pool-Matters"><a href="#Why-Buffer-Pool-Matters" class="headerlink" title="Why Buffer Pool Matters"></a>Why Buffer Pool Matters</h3><p><strong>Performance Impact:</strong></p>
<ul>
<li>Memory access is ~1000x faster than disk access</li>
<li>Reduces physical I&#x2F;O operations significantly</li>
<li>Enables efficient handling of hot data</li>
<li>Critical for OLTP workloads with high concurrency</li>
</ul>
<p><strong>Business Impact:</strong></p>
<ul>
<li>Lower response times for user queries</li>
<li>Higher throughput and concurrent user capacity</li>
<li>Reduced hardware requirements for I&#x2F;O subsystem</li>
<li>Better resource utilization and cost efficiency</li>
</ul>
<h2 id="LRU-Structure-Deep-Dive"><a href="#LRU-Structure-Deep-Dive" class="headerlink" title="LRU Structure Deep Dive"></a>LRU Structure Deep Dive</h2><h3 id="Traditional-LRU-Limitations"><a href="#Traditional-LRU-Limitations" class="headerlink" title="Traditional LRU Limitations"></a>Traditional LRU Limitations</h3><p>A simple LRU (Least Recently Used) algorithm has a critical flaw for database workloads: large sequential scans can flush out frequently accessed data. If you scan a large table once, all those pages would be marked as “recently used” and push out your hot data.</p>
<h3 id="MySQL’s-Two-Segment-LRU-Solution"><a href="#MySQL’s-Two-Segment-LRU-Solution" class="headerlink" title="MySQL’s Two-Segment LRU Solution"></a>MySQL’s Two-Segment LRU Solution</h3><p>MySQL implements a sophisticated <strong>midpoint insertion strategy</strong> with two sublists:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Buffer Pool LRU List Structure:</span><br><span class="line"></span><br><span class="line">NEW SUBLIST (Hot/Young Pages - ~63%)</span><br><span class="line">├── Most recently accessed hot pages</span><br><span class="line">├── Frequently accessed data</span><br><span class="line">└── Pages promoted from old sublist</span><br><span class="line"></span><br><span class="line">───────── MIDPOINT ─────────</span><br><span class="line"></span><br><span class="line">OLD SUBLIST (Cold/Old Pages - ~37%)  </span><br><span class="line">├── Newly read pages (insertion point)</span><br><span class="line">├── Infrequently accessed pages</span><br><span class="line">└── Pages waiting for promotion</span><br></pre></td></tr></table></figure>

<h3 id="Page-Lifecycle-in-LRU"><a href="#Page-Lifecycle-in-LRU" class="headerlink" title="Page Lifecycle in LRU"></a>Page Lifecycle in LRU</h3><ol>
<li><strong>Initial Read</strong>: New pages inserted at head of OLD sublist (not NEW)</li>
<li><strong>Promotion Criteria</strong>: Pages moved to NEW sublist only if:<ul>
<li>Accessed again after initial read</li>
<li>Minimum time threshold passed (<code>innodb_old_blocks_time</code>)</li>
</ul>
</li>
<li><strong>Young Page Optimization</strong>: Pages in NEW sublist only move to head if in bottom 25%</li>
<li><strong>Eviction</strong>: Pages removed from tail of OLD sublist when space needed</li>
</ol>
<h3 id="Protection-Mechanisms"><a href="#Protection-Mechanisms" class="headerlink" title="Protection Mechanisms"></a>Protection Mechanisms</h3><p><strong>Sequential Scan Protection:</strong></p>
<ul>
<li>New pages start in OLD sublist</li>
<li>Single-access pages never pollute NEW sublist</li>
<li>Time-based promotion prevents rapid sequential access from corrupting cache</li>
</ul>
<p><strong>Read-Ahead Protection:</strong></p>
<ul>
<li>Prefetched pages placed in OLD sublist</li>
<li>Only promoted if actually accessed</li>
<li>Prevents speculative reads from evicting hot data</li>
</ul>
<h2 id="Configuration-and-Sizing"><a href="#Configuration-and-Sizing" class="headerlink" title="Configuration and Sizing"></a>Configuration and Sizing</h2><h3 id="Essential-Parameters"><a href="#Essential-Parameters" class="headerlink" title="Essential Parameters"></a>Essential Parameters</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Core buffer pool settings</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;innodb_buffer_pool%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Key parameters explained:</span></span><br><span class="line">innodb_buffer_pool_size         <span class="comment">-- Total memory allocated</span></span><br><span class="line">innodb_buffer_pool_instances    <span class="comment">-- Number of separate buffer pools  </span></span><br><span class="line">innodb_old_blocks_pct          <span class="comment">-- Percentage for old sublist (default: 37%)</span></span><br><span class="line">innodb_old_blocks_time         <span class="comment">-- Promotion delay in milliseconds (default: 1000)</span></span><br><span class="line">innodb_lru_scan_depth          <span class="comment">-- Pages scanned for cleanup (default: 1024)</span></span><br></pre></td></tr></table></figure>

<h3 id="Sizing-Best-Practices"><a href="#Sizing-Best-Practices" class="headerlink" title="Sizing Best Practices"></a>Sizing Best Practices</h3><p><strong>General Rules:</strong></p>
<ul>
<li><strong>Dedicated servers</strong>: 70-80% of total RAM</li>
<li><strong>Shared servers</strong>: 50-60% of total RAM  </li>
<li><strong>Minimum</strong>: At least 128MB for any production use</li>
<li><strong>Working set</strong>: Should ideally fit entire hot dataset</li>
</ul>
<p><strong>Sizing Formula:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Buffer Pool Size = (Hot Data Size + Hot Index Size + Growth Buffer) × Safety Factor</span><br><span class="line"></span><br><span class="line">Where:</span><br><span class="line">- Hot Data Size: Frequently accessed table data</span><br><span class="line">- Hot Index Size: Primary and secondary indexes in use</span><br><span class="line">- Growth Buffer: 20-30% for data growth</span><br><span class="line">- Safety Factor: 1.2-1.5 for overhead and fragmentation</span><br></pre></td></tr></table></figure>

<p><strong>Practical Sizing Example:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Calculate current data + index size</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    ROUND(<span class="built_in">SUM</span>(data_length <span class="operator">+</span> index_length) <span class="operator">/</span> <span class="number">1024</span> <span class="operator">/</span> <span class="number">1024</span> <span class="operator">/</span> <span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> total_gb,</span><br><span class="line">    ROUND(<span class="built_in">SUM</span>(data_length) <span class="operator">/</span> <span class="number">1024</span> <span class="operator">/</span> <span class="number">1024</span> <span class="operator">/</span> <span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> data_gb,</span><br><span class="line">    ROUND(<span class="built_in">SUM</span>(index_length) <span class="operator">/</span> <span class="number">1024</span> <span class="operator">/</span> <span class="number">1024</span> <span class="operator">/</span> <span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> index_gb</span><br><span class="line"><span class="keyword">FROM</span> information_schema.tables </span><br><span class="line"><span class="keyword">WHERE</span> engine <span class="operator">=</span> <span class="string">&#x27;InnoDB&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Check current buffer pool utilization</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    ROUND(@<span class="variable">@innodb_buffer_pool_size</span> <span class="operator">/</span> <span class="number">1024</span> <span class="operator">/</span> <span class="number">1024</span> <span class="operator">/</span> <span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> bp_size_gb,</span><br><span class="line">    ROUND((DATABASE_PAGES <span class="operator">*</span> <span class="number">16384</span>) <span class="operator">/</span> <span class="number">1024</span> <span class="operator">/</span> <span class="number">1024</span> <span class="operator">/</span> <span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> used_gb,</span><br><span class="line">    ROUND(((DATABASE_PAGES <span class="operator">*</span> <span class="number">16384</span>) <span class="operator">/</span> @<span class="variable">@innodb_buffer_pool_size</span>) <span class="operator">*</span> <span class="number">100</span>, <span class="number">2</span>) <span class="keyword">as</span> utilization_pct</span><br><span class="line"><span class="keyword">FROM</span> INFORMATION_SCHEMA.INNODB_BUFFER_POOL_STATS;</span><br></pre></td></tr></table></figure>

<h3 id="Multiple-Buffer-Pool-Instances"><a href="#Multiple-Buffer-Pool-Instances" class="headerlink" title="Multiple Buffer Pool Instances"></a>Multiple Buffer Pool Instances</h3><p><strong>When to Use:</strong></p>
<ul>
<li>Servers with 8+ CPU cores</li>
<li>Buffer pool size &gt; 1GB</li>
<li>High concurrency workloads</li>
</ul>
<p><strong>Configuration:</strong></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># my.cnf configuration</span></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">innodb_buffer_pool_size</span> = <span class="number">8</span>G</span><br><span class="line"><span class="attr">innodb_buffer_pool_instances</span> = <span class="number">8</span>    <span class="comment"># 1GB per instance</span></span><br></pre></td></tr></table></figure>

<p><strong>Benefits:</strong></p>
<ul>
<li>Reduces mutex contention</li>
<li>Better multi-threaded performance</li>
<li>Parallel LRU maintenance</li>
<li>Improved scalability</li>
</ul>
<h2 id="Monitoring-and-Diagnostics"><a href="#Monitoring-and-Diagnostics" class="headerlink" title="Monitoring and Diagnostics"></a>Monitoring and Diagnostics</h2><h3 id="Essential-Monitoring-Queries"><a href="#Essential-Monitoring-Queries" class="headerlink" title="Essential Monitoring Queries"></a>Essential Monitoring Queries</h3><p><strong>Buffer Pool Health Check:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Quick health overview</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    <span class="string">&#x27;Buffer Pool Hit Rate&#x27;</span> <span class="keyword">as</span> metric,</span><br><span class="line">    CONCAT(ROUND(HIT_RATE <span class="operator">*</span> <span class="number">100</span> <span class="operator">/</span> <span class="number">1000</span>, <span class="number">2</span>), <span class="string">&#x27;%&#x27;</span>) <span class="keyword">as</span> <span class="keyword">value</span>,</span><br><span class="line">    <span class="keyword">CASE</span> </span><br><span class="line">        <span class="keyword">WHEN</span> HIT_RATE <span class="operator">&gt;</span> <span class="number">990</span> <span class="keyword">THEN</span> <span class="string">&#x27;EXCELLENT&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> HIT_RATE <span class="operator">&gt;</span> <span class="number">950</span> <span class="keyword">THEN</span> <span class="string">&#x27;GOOD&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> HIT_RATE <span class="operator">&gt;</span> <span class="number">900</span> <span class="keyword">THEN</span> <span class="string">&#x27;FAIR&#x27;</span></span><br><span class="line">        <span class="keyword">ELSE</span> <span class="string">&#x27;POOR - NEEDS ATTENTION&#x27;</span></span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">as</span> status</span><br><span class="line"><span class="keyword">FROM</span> INFORMATION_SCHEMA.INNODB_BUFFER_POOL_STATS</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    <span class="string">&#x27;Old Sublist Ratio&#x27;</span> <span class="keyword">as</span> metric,</span><br><span class="line">    CONCAT(ROUND((OLD_DATABASE_PAGES <span class="operator">/</span> DATABASE_PAGES) <span class="operator">*</span> <span class="number">100</span>, <span class="number">2</span>), <span class="string">&#x27;%&#x27;</span>) <span class="keyword">as</span> <span class="keyword">value</span>,</span><br><span class="line">    <span class="keyword">CASE</span> </span><br><span class="line">        <span class="keyword">WHEN</span> (OLD_DATABASE_PAGES <span class="operator">/</span> DATABASE_PAGES) <span class="keyword">BETWEEN</span> <span class="number">0.30</span> <span class="keyword">AND</span> <span class="number">0.45</span> <span class="keyword">THEN</span> <span class="string">&#x27;NORMAL&#x27;</span></span><br><span class="line">        <span class="keyword">ELSE</span> <span class="string">&#x27;CHECK CONFIGURATION&#x27;</span></span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">as</span> status</span><br><span class="line"><span class="keyword">FROM</span> INFORMATION_SCHEMA.INNODB_BUFFER_POOL_STATS;</span><br></pre></td></tr></table></figure>

<p><strong>Detailed Performance Metrics:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Comprehensive buffer pool analysis</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    POOL_ID,</span><br><span class="line">    POOL_SIZE,</span><br><span class="line">    FREE_BUFFERS,</span><br><span class="line">    DATABASE_PAGES,</span><br><span class="line">    OLD_DATABASE_PAGES,</span><br><span class="line">    MODIFIED_DATABASE_PAGES,</span><br><span class="line">    ROUND(HIT_RATE <span class="operator">*</span> <span class="number">100</span> <span class="operator">/</span> <span class="number">1000</span>, <span class="number">2</span>) <span class="keyword">as</span> hit_rate_pct,</span><br><span class="line">    PAGES_MADE_YOUNG,</span><br><span class="line">    PAGES_NOT_MADE_YOUNG,</span><br><span class="line">    YOUNG_MAKE_PER_THOUSAND_GETS,</span><br><span class="line">    NOT_YOUNG_MAKE_PER_THOUSAND_GETS,</span><br><span class="line">    PAGES_READ_RATE,</span><br><span class="line">    PAGES_CREATE_RATE,</span><br><span class="line">    PAGES_WRITTEN_RATE</span><br><span class="line"><span class="keyword">FROM</span> INFORMATION_SCHEMA.INNODB_BUFFER_POOL_STATS;</span><br></pre></td></tr></table></figure>

<p><strong>Buffer Pool Status Deep Dive:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Extract key metrics from SHOW ENGINE INNODB STATUS</span></span><br><span class="line"><span class="keyword">SHOW</span> ENGINE INNODB STATUS\G</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Key sections to analyze:</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">BUFFER POOL AND MEMORY section shows:</span></span><br><span class="line"><span class="comment">- Total memory allocated</span></span><br><span class="line"><span class="comment">- Buffer pool size (in pages)</span></span><br><span class="line"><span class="comment">- Free buffers available</span></span><br><span class="line"><span class="comment">- Database pages (pages with data)</span></span><br><span class="line"><span class="comment">- Old database pages (pages in old sublist)</span></span><br><span class="line"><span class="comment">- Modified db pages (dirty pages)</span></span><br><span class="line"><span class="comment">- Pages made young/not young (LRU promotions)</span></span><br><span class="line"><span class="comment">- Buffer pool hit rate</span></span><br><span class="line"><span class="comment">- Read/write rates</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="Real-Time-Monitoring-Script"><a href="#Real-Time-Monitoring-Script" class="headerlink" title="Real-Time Monitoring Script"></a>Real-Time Monitoring Script</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Buffer pool monitoring script</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== <span class="subst">$(date)</span> ===&quot;</span></span><br><span class="line">    mysql -e <span class="string">&quot;</span></span><br><span class="line"><span class="string">    SELECT </span></span><br><span class="line"><span class="string">        CONCAT(&#x27;Hit Rate: &#x27;, ROUND(HIT_RATE * 100 / 1000, 2), &#x27;%&#x27;) as metric1,</span></span><br><span class="line"><span class="string">        CONCAT(&#x27;Pages Read/s: &#x27;, PAGES_READ_RATE) as metric2,</span></span><br><span class="line"><span class="string">        CONCAT(&#x27;Young Rate: &#x27;, YOUNG_MAKE_PER_THOUSAND_GETS, &#x27;/1000&#x27;) as metric3</span></span><br><span class="line"><span class="string">    FROM INFORMATION_SCHEMA.INNODB_BUFFER_POOL_STATS;&quot;</span> -N</span><br><span class="line">    <span class="built_in">sleep</span> 5</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h2 id="Performance-Optimization"><a href="#Performance-Optimization" class="headerlink" title="Performance Optimization"></a>Performance Optimization</h2><h3 id="Buffer-Pool-Tuning-Strategy"><a href="#Buffer-Pool-Tuning-Strategy" class="headerlink" title="Buffer Pool Tuning Strategy"></a>Buffer Pool Tuning Strategy</h3><p><strong>Step 1: Establish Baseline</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Document current performance</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    <span class="string">&#x27;Baseline Metrics&#x27;</span> <span class="keyword">as</span> phase,</span><br><span class="line">    NOW() <span class="keyword">as</span> <span class="type">timestamp</span>,</span><br><span class="line">    ROUND(HIT_RATE <span class="operator">*</span> <span class="number">100</span> <span class="operator">/</span> <span class="number">1000</span>, <span class="number">2</span>) <span class="keyword">as</span> hit_rate_pct,</span><br><span class="line">    PAGES_READ_RATE,</span><br><span class="line">    PAGES_WRITTEN_RATE,</span><br><span class="line">    YOUNG_MAKE_PER_THOUSAND_GETS</span><br><span class="line"><span class="keyword">FROM</span> INFORMATION_SCHEMA.INNODB_BUFFER_POOL_STATS;</span><br></pre></td></tr></table></figure>

<p><strong>Step 2: Analyze Workload Patterns</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Identify access patterns</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    table_schema,</span><br><span class="line">    table_name,</span><br><span class="line">    ROUND((data_length <span class="operator">+</span> index_length) <span class="operator">/</span> <span class="number">1024</span> <span class="operator">/</span> <span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> size_mb,</span><br><span class="line">    table_rows,</span><br><span class="line">    ROUND((data_length <span class="operator">+</span> index_length) <span class="operator">/</span> table_rows, <span class="number">2</span>) <span class="keyword">as</span> avg_row_size</span><br><span class="line"><span class="keyword">FROM</span> information_schema.tables </span><br><span class="line"><span class="keyword">WHERE</span> engine <span class="operator">=</span> <span class="string">&#x27;InnoDB&#x27;</span> <span class="keyword">AND</span> table_rows <span class="operator">&gt;</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (data_length <span class="operator">+</span> index_length) <span class="keyword">DESC</span></span><br><span class="line">LIMIT <span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<p><strong>Step 3: Optimize Configuration</strong></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Optimized buffer pool configuration</span></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># Size based on working set analysis</span></span><br><span class="line"><span class="attr">innodb_buffer_pool_size</span> = <span class="number">12</span>G</span><br><span class="line"></span><br><span class="line"><span class="comment"># Multiple instances for concurrency  </span></span><br><span class="line"><span class="attr">innodb_buffer_pool_instances</span> = <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Tuned for workload characteristics</span></span><br><span class="line"><span class="attr">innodb_old_blocks_pct</span> = <span class="number">37</span>          <span class="comment"># Default usually optimal</span></span><br><span class="line"><span class="attr">innodb_old_blocks_time</span> = <span class="number">1000</span>       <span class="comment"># Increase for scan-heavy workloads</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enhanced cleanup for write-heavy workloads</span></span><br><span class="line"><span class="attr">innodb_lru_scan_depth</span> = <span class="number">2048</span></span><br></pre></td></tr></table></figure>

<h3 id="Advanced-Optimization-Techniques"><a href="#Advanced-Optimization-Techniques" class="headerlink" title="Advanced Optimization Techniques"></a>Advanced Optimization Techniques</h3><p><strong>Buffer Pool Warmup:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Enable automatic dump/restore</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> innodb_buffer_pool_dump_at_shutdown <span class="operator">=</span> <span class="keyword">ON</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> innodb_buffer_pool_load_at_startup <span class="operator">=</span> <span class="keyword">ON</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Manual warmup for critical tables</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> critical_table FORCE INDEX (<span class="keyword">PRIMARY</span>);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> user_sessions FORCE INDEX (idx_user_id);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Monitor warmup progress</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    VARIABLE_NAME, </span><br><span class="line">    VARIABLE_VALUE </span><br><span class="line"><span class="keyword">FROM</span> INFORMATION_SCHEMA.GLOBAL_STATUS </span><br><span class="line"><span class="keyword">WHERE</span> VARIABLE_NAME <span class="keyword">LIKE</span> <span class="string">&#x27;Innodb_buffer_pool_load%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>Dynamic Resizing (MySQL 5.7+):</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Check current size and chunk configuration</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    @<span class="variable">@innodb_buffer_pool_size</span> <span class="operator">/</span> <span class="number">1024</span> <span class="operator">/</span> <span class="number">1024</span> <span class="operator">/</span> <span class="number">1024</span> <span class="keyword">as</span> current_size_gb,</span><br><span class="line">    @<span class="variable">@innodb_buffer_pool_chunk_size</span> <span class="operator">/</span> <span class="number">1024</span> <span class="operator">/</span> <span class="number">1024</span> <span class="keyword">as</span> chunk_size_mb;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Resize online (size must be multiple of chunk_size * instances)</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> innodb_buffer_pool_size <span class="operator">=</span> <span class="number">16106127360</span>; <span class="comment">-- 15GB</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Monitor resize progress</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    VARIABLE_NAME, </span><br><span class="line">    VARIABLE_VALUE </span><br><span class="line"><span class="keyword">FROM</span> INFORMATION_SCHEMA.GLOBAL_STATUS </span><br><span class="line"><span class="keyword">WHERE</span> VARIABLE_NAME <span class="keyword">LIKE</span> <span class="string">&#x27;Innodb_buffer_pool_resize%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="Real-World-Scenarios"><a href="#Real-World-Scenarios" class="headerlink" title="Real-World Scenarios"></a>Real-World Scenarios</h2><h3 id="Scenario-1-E-commerce-Platform"><a href="#Scenario-1-E-commerce-Platform" class="headerlink" title="Scenario 1: E-commerce Platform"></a>Scenario 1: E-commerce Platform</h3><p><strong>Characteristics:</strong></p>
<ul>
<li>High read&#x2F;write ratio (80:20)</li>
<li>Hot product catalog data</li>
<li>Seasonal traffic spikes</li>
<li>Mixed query patterns</li>
</ul>
<p><strong>Buffer Pool Strategy:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Configuration for e-commerce workload</span></span><br><span class="line">innodb_buffer_pool_size <span class="operator">=</span> <span class="number">24</span>G        # <span class="keyword">Large</span> buffer <span class="keyword">for</span> product catalog</span><br><span class="line">innodb_buffer_pool_instances <span class="operator">=</span> <span class="number">12</span>    # High concurrency support</span><br><span class="line">innodb_old_blocks_time <span class="operator">=</span> <span class="number">500</span>         # Faster promotion <span class="keyword">for</span> product searches</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Monitor hot tables</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    table_name,</span><br><span class="line">    ROUND((data_length <span class="operator">+</span> index_length) <span class="operator">/</span> <span class="number">1024</span> <span class="operator">/</span> <span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> size_mb</span><br><span class="line"><span class="keyword">FROM</span> information_schema.tables </span><br><span class="line"><span class="keyword">WHERE</span> table_schema <span class="operator">=</span> <span class="string">&#x27;ecommerce&#x27;</span> </span><br><span class="line">    <span class="keyword">AND</span> table_name <span class="keyword">IN</span> (<span class="string">&#x27;products&#x27;</span>, <span class="string">&#x27;categories&#x27;</span>, <span class="string">&#x27;inventory&#x27;</span>, <span class="string">&#x27;users&#x27;</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (data_length <span class="operator">+</span> index_length) <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Scenario-2-Analytics-Workload"><a href="#Scenario-2-Analytics-Workload" class="headerlink" title="Scenario 2: Analytics Workload"></a>Scenario 2: Analytics Workload</h3><p><strong>Characteristics:</strong></p>
<ul>
<li>Large table scans</li>
<li>Reporting queries</li>
<li>Batch processing</li>
<li>Sequential access patterns</li>
</ul>
<p><strong>Buffer Pool Strategy:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Configuration for analytics workload</span></span><br><span class="line">innodb_buffer_pool_size <span class="operator">=</span> <span class="number">32</span>G        # <span class="keyword">Large</span> buffer <span class="keyword">for</span> working sets</span><br><span class="line">innodb_old_blocks_pct <span class="operator">=</span> <span class="number">25</span>           # Smaller <span class="keyword">old</span> sublist</span><br><span class="line">innodb_old_blocks_time <span class="operator">=</span> <span class="number">2000</span>        # Longer promotion delay</span><br><span class="line">innodb_lru_scan_depth <span class="operator">=</span> <span class="number">4096</span>         # More aggressive cleanup</span><br></pre></td></tr></table></figure>

<h3 id="Scenario-3-OLTP-High-Concurrency"><a href="#Scenario-3-OLTP-High-Concurrency" class="headerlink" title="Scenario 3: OLTP High-Concurrency"></a>Scenario 3: OLTP High-Concurrency</h3><p><strong>Characteristics:</strong></p>
<ul>
<li>Short transactions</li>
<li>Point queries</li>
<li>High concurrency</li>
<li>Hot row contention</li>
</ul>
<p><strong>Buffer Pool Strategy:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Configuration for OLTP workload</span></span><br><span class="line">innodb_buffer_pool_size <span class="operator">=</span> <span class="number">16</span>G        # Sized <span class="keyword">for</span> working <span class="keyword">set</span></span><br><span class="line">innodb_buffer_pool_instances <span class="operator">=</span> <span class="number">16</span>    # Maximum concurrency</span><br><span class="line">innodb_old_blocks_time <span class="operator">=</span> <span class="number">100</span>         # Quick promotion <span class="keyword">for</span> hot data</span><br></pre></td></tr></table></figure>

<h2 id="Troubleshooting-Guide"><a href="#Troubleshooting-Guide" class="headerlink" title="Troubleshooting Guide"></a>Troubleshooting Guide</h2><h3 id="Problem-1-Low-Buffer-Pool-Hit-Rate"><a href="#Problem-1-Low-Buffer-Pool-Hit-Rate" class="headerlink" title="Problem 1: Low Buffer Pool Hit Rate (&lt;95%)"></a>Problem 1: Low Buffer Pool Hit Rate (&lt;95%)</h3><p><strong>Diagnostic Steps:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Check hit rate trend</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    <span class="string">&#x27;Current Hit Rate&#x27;</span> <span class="keyword">as</span> metric,</span><br><span class="line">    CONCAT(ROUND(HIT_RATE <span class="operator">*</span> <span class="number">100</span> <span class="operator">/</span> <span class="number">1000</span>, <span class="number">2</span>), <span class="string">&#x27;%&#x27;</span>) <span class="keyword">as</span> <span class="keyword">value</span></span><br><span class="line"><span class="keyword">FROM</span> INFORMATION_SCHEMA.INNODB_BUFFER_POOL_STATS;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Compare buffer pool size to data size</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    <span class="string">&#x27;Buffer Pool&#x27;</span> <span class="keyword">as</span> component,</span><br><span class="line">    ROUND(@<span class="variable">@innodb_buffer_pool_size</span> <span class="operator">/</span> <span class="number">1024</span> <span class="operator">/</span> <span class="number">1024</span> <span class="operator">/</span> <span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> size_gb</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    <span class="string">&#x27;Total Data+Index&#x27;</span> <span class="keyword">as</span> component,</span><br><span class="line">    ROUND(<span class="built_in">SUM</span>(data_length <span class="operator">+</span> index_length) <span class="operator">/</span> <span class="number">1024</span> <span class="operator">/</span> <span class="number">1024</span> <span class="operator">/</span> <span class="number">1024</span>, <span class="number">2</span>) <span class="keyword">as</span> size_gb</span><br><span class="line"><span class="keyword">FROM</span> information_schema.tables </span><br><span class="line"><span class="keyword">WHERE</span> engine <span class="operator">=</span> <span class="string">&#x27;InnoDB&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>Solutions:</strong></p>
<ol>
<li><strong>Increase buffer pool size</strong> if data doesn’t fit</li>
<li><strong>Optimize queries</strong> to reduce unnecessary data access</li>
<li><strong>Partition large tables</strong> to improve locality</li>
<li><strong>Review indexing strategy</strong> to reduce page reads</li>
</ol>
<h3 id="Problem-2-Excessive-LRU-Flushing"><a href="#Problem-2-Excessive-LRU-Flushing" class="headerlink" title="Problem 2: Excessive LRU Flushing"></a>Problem 2: Excessive LRU Flushing</h3><p><strong>Symptoms:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Check for LRU pressure</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    POOL_ID,</span><br><span class="line">    PENDING_FLUSH_LRU,</span><br><span class="line">    PAGES_MADE_YOUNG_RATE,</span><br><span class="line">    PAGES_READ_RATE</span><br><span class="line"><span class="keyword">FROM</span> INFORMATION_SCHEMA.INNODB_BUFFER_POOL_STATS</span><br><span class="line"><span class="keyword">WHERE</span> PENDING_FLUSH_LRU <span class="operator">&gt;</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p><strong>Root Causes:</strong></p>
<ul>
<li>Large sequential scans</li>
<li>Insufficient buffer pool size</li>
<li>Write-heavy workload</li>
<li>Poor query optimization</li>
</ul>
<p><strong>Solutions:</strong></p>
<ol>
<li><strong>Increase <code>innodb_lru_scan_depth</code></strong> for better cleanup</li>
<li><strong>Optimize scan queries</strong> with better indexes</li>
<li><strong>Increase buffer pool size</strong> if possible</li>
<li><strong>Tune <code>innodb_old_blocks_time</code></strong> for workload</li>
</ol>
<h3 id="Problem-3-Poor-Young-Old-Ratio"><a href="#Problem-3-Poor-Young-Old-Ratio" class="headerlink" title="Problem 3: Poor Young&#x2F;Old Ratio"></a>Problem 3: Poor Young&#x2F;Old Ratio</h3><p><strong>Diagnostic:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Check promotion patterns</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    POOL_ID,</span><br><span class="line">    YOUNG_MAKE_PER_THOUSAND_GETS,</span><br><span class="line">    NOT_YOUNG_MAKE_PER_THOUSAND_GETS,</span><br><span class="line">    ROUND((OLD_DATABASE_PAGES <span class="operator">/</span> DATABASE_PAGES) <span class="operator">*</span> <span class="number">100</span>, <span class="number">2</span>) <span class="keyword">as</span> old_pct</span><br><span class="line"><span class="keyword">FROM</span> INFORMATION_SCHEMA.INNODB_BUFFER_POOL_STATS;</span><br></pre></td></tr></table></figure>

<p><strong>Tuning:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Adjust old blocks percentage</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> innodb_old_blocks_pct <span class="operator">=</span> <span class="number">30</span>;  <span class="comment">-- Reduce if too much promotion</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> innodb_old_blocks_pct <span class="operator">=</span> <span class="number">40</span>;  <span class="comment">-- Increase if too little promotion</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Adjust promotion timing</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> innodb_old_blocks_time <span class="operator">=</span> <span class="number">2000</span>;  <span class="comment">-- Slower promotion</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> innodb_old_blocks_time <span class="operator">=</span> <span class="number">500</span>;   <span class="comment">-- Faster promotion</span></span><br></pre></td></tr></table></figure>

<h2 id="Best-Practices-Summary"><a href="#Best-Practices-Summary" class="headerlink" title="Best Practices Summary"></a>Best Practices Summary</h2><h3 id="Configuration-Best-Practices"><a href="#Configuration-Best-Practices" class="headerlink" title="Configuration Best Practices"></a>Configuration Best Practices</h3><ol>
<li><p><strong>Size Appropriately</strong></p>
<ul>
<li>Dedicated DB server: 70-80% of RAM</li>
<li>Shared server: 50-60% of RAM</li>
<li>Must accommodate working set</li>
</ul>
</li>
<li><p><strong>Use Multiple Instances</strong></p>
<ul>
<li>1 instance per GB on multi-core systems</li>
<li>Maximum benefit at 8-16 instances</li>
<li>Reduces contention significantly</li>
</ul>
</li>
<li><p><strong>Tune for Workload</strong></p>
<ul>
<li>OLTP: Faster promotion, more instances</li>
<li>Analytics: Slower promotion, larger old sublist</li>
<li>Mixed: Default settings usually optimal</li>
</ul>
</li>
</ol>
<h3 id="Monitoring-Best-Practices"><a href="#Monitoring-Best-Practices" class="headerlink" title="Monitoring Best Practices"></a>Monitoring Best Practices</h3><ol>
<li><p><strong>Key Metrics to Track</strong></p>
<ul>
<li>Buffer pool hit rate (target: &gt;99%)</li>
<li>Pages read rate (should be low)</li>
<li>Young&#x2F;old promotion ratio</li>
<li>LRU flush activity</li>
</ul>
</li>
<li><p><strong>Regular Health Checks</strong></p>
<ul>
<li>Weekly buffer pool analysis</li>
<li>Monitor after configuration changes</li>
<li>Track performance during peak loads</li>
</ul>
</li>
<li><p><strong>Alerting Thresholds</strong></p>
<ul>
<li>Hit rate &lt; 95%: Investigate immediately</li>
<li>Hit rate &lt; 99%: Monitor closely</li>
<li>High LRU flush rate: Check for scans</li>
</ul>
</li>
</ol>
<h3 id="Operational-Best-Practices"><a href="#Operational-Best-Practices" class="headerlink" title="Operational Best Practices"></a>Operational Best Practices</h3><ol>
<li><p><strong>Capacity Planning</strong></p>
<ul>
<li>Monitor data growth trends</li>
<li>Plan buffer pool growth with data</li>
<li>Consider seasonal usage patterns</li>
</ul>
</li>
<li><p><strong>Change Management</strong></p>
<ul>
<li>Test configuration changes in staging</li>
<li>Use dynamic variables when possible</li>
<li>Document baseline performance</li>
</ul>
</li>
<li><p><strong>Disaster Recovery</strong></p>
<ul>
<li>Enable buffer pool dump&#x2F;restore</li>
<li>Plan warmup strategy for failover</li>
<li>Consider warm standby instances</li>
</ul>
</li>
</ol>
<h3 id="Performance-Optimization-Checklist"><a href="#Performance-Optimization-Checklist" class="headerlink" title="Performance Optimization Checklist"></a>Performance Optimization Checklist</h3><ul>
<li><input disabled="" type="checkbox"> Buffer pool sized appropriately for working set</li>
<li><input disabled="" type="checkbox"> Multiple instances configured for concurrency</li>
<li><input disabled="" type="checkbox"> Hit rate consistently &gt;99%</li>
<li><input disabled="" type="checkbox"> LRU parameters tuned for workload</li>
<li><input disabled="" type="checkbox"> Buffer pool dump&#x2F;restore enabled</li>
<li><input disabled="" type="checkbox"> Monitoring and alerting in place</li>
<li><input disabled="" type="checkbox"> Regular performance reviews scheduled</li>
<li><input disabled="" type="checkbox"> Capacity planning updated quarterly</li>
</ul>
<h3 id="Common-Anti-Patterns-to-Avoid"><a href="#Common-Anti-Patterns-to-Avoid" class="headerlink" title="Common Anti-Patterns to Avoid"></a>Common Anti-Patterns to Avoid</h3><p>❌ <strong>Don’t:</strong></p>
<ul>
<li>Set buffer pool too small to save memory</li>
<li>Use single instance on multi-core systems</li>
<li>Ignore buffer pool hit rate</li>
<li>Make changes without baseline measurement</li>
<li>Forget to enable buffer pool persistence</li>
</ul>
<p>✅ <strong>Do:</strong></p>
<ul>
<li>Size based on working set analysis</li>
<li>Use multiple instances for concurrency</li>
<li>Monitor key metrics regularly</li>
<li>Test changes thoroughly</li>
<li>Plan for growth and peak loads</li>
</ul>
<p>This comprehensive guide provides both the theoretical understanding and practical implementation knowledge needed for MySQL buffer pool optimization in production environments.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/07/How-MySQL-Prevents-Most-Phantom-Reads/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/07/How-MySQL-Prevents-Most-Phantom-Reads/" class="post-title-link" itemprop="url">How MySQL Prevents Most Phantom Reads</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-07 22:08:41 / Modified: 22:10:23" itemprop="dateCreated datePublished" datetime="2025-06-07T22:08:41+08:00">2025-06-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>MySQL’s InnoDB storage engine uses a sophisticated combination of locking mechanisms and MVCC (Multi-Version Concurrency Control) to prevent phantom reads in the REPEATABLE READ isolation level. This makes MySQL’s implementation more restrictive than the SQL standard, effectively providing near-Serializable behavior while maintaining better performance.</p>
<h2 id="Key-Mechanisms"><a href="#Key-Mechanisms" class="headerlink" title="Key Mechanisms"></a>Key Mechanisms</h2><h3 id="Next-Key-Locking"><a href="#Next-Key-Locking" class="headerlink" title="Next-Key Locking"></a>Next-Key Locking</h3><p>Next-key locking is InnoDB’s primary mechanism for preventing phantom reads. It combines:</p>
<ul>
<li><strong>Record locks</strong>: Lock existing rows</li>
<li><strong>Gap locks</strong>: Lock the spaces between index records</li>
</ul>
<p>This combination ensures that no new rows can be inserted in the gaps where phantom reads could occur.</p>
<h3 id="Gap-Locking"><a href="#Gap-Locking" class="headerlink" title="Gap Locking"></a>Gap Locking</h3><p>Gap locks specifically target the empty spaces between index records:</p>
<ul>
<li>Prevents INSERT operations in those gaps</li>
<li>Only applies to indexed columns</li>
<li>Can be disabled (though not recommended)</li>
</ul>
<h3 id="Consistent-Nonlocking-Reads-MVCC"><a href="#Consistent-Nonlocking-Reads-MVCC" class="headerlink" title="Consistent Nonlocking Reads (MVCC)"></a>Consistent Nonlocking Reads (MVCC)</h3><p>For regular SELECT statements, MySQL uses MVCC snapshots:</p>
<ul>
<li>Each transaction sees a consistent view of data</li>
<li>No locking overhead for read operations</li>
<li>Phantom reads are prevented through snapshot isolation</li>
</ul>
<h2 id="Practical-Demonstration"><a href="#Practical-Demonstration" class="headerlink" title="Practical Demonstration"></a>Practical Demonstration</h2><h3 id="Setup-Creating-Test-Environment"><a href="#Setup-Creating-Test-Environment" class="headerlink" title="Setup: Creating Test Environment"></a>Setup: Creating Test Environment</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Create test table</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> employees (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    salary <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">    department <span class="type">VARCHAR</span>(<span class="number">30</span>),</span><br><span class="line">    INDEX idx_salary (salary),</span><br><span class="line">    INDEX idx_department (department)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Insert initial data</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (name, salary, department) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;Alice&#x27;</span>, <span class="number">50000</span>, <span class="string">&#x27;Engineering&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;Bob&#x27;</span>, <span class="number">60000</span>, <span class="string">&#x27;Engineering&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;Charlie&#x27;</span>, <span class="number">55000</span>, <span class="string">&#x27;Marketing&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;Diana&#x27;</span>, <span class="number">70000</span>, <span class="string">&#x27;Engineering&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="Scenario-1-Regular-SELECT-MVCC-Protection"><a href="#Scenario-1-Regular-SELECT-MVCC-Protection" class="headerlink" title="Scenario 1: Regular SELECT (MVCC Protection)"></a>Scenario 1: Regular SELECT (MVCC Protection)</h3><p><strong>Session A (Transaction 1):</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Start transaction with REPEATABLE READ</span></span><br><span class="line"><span class="keyword">SET</span> TRANSACTION ISOLATION LEVEL REPEATABLE READ;</span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- First query</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> <span class="number">55000</span>;</span><br><span class="line"><span class="comment">-- Results: Bob (60000), Diana (70000)</span></span><br></pre></td></tr></table></figure>

<p><strong>Session B (Transaction 2):</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Insert new high-salary employee</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (name, salary, department) </span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;Eve&#x27;</span>, <span class="number">65000</span>, <span class="string">&#x27;Engineering&#x27;</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<p><strong>Back to Session A:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Repeat the same query</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> <span class="number">55000</span>;</span><br><span class="line"><span class="comment">-- Results: Still Bob (60000), Diana (70000)</span></span><br><span class="line"><span class="comment">-- Eve is NOT visible - phantom read prevented!</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Scenario-2-SELECT-FOR-UPDATE-Next-Key-Locking"><a href="#Scenario-2-SELECT-FOR-UPDATE-Next-Key-Locking" class="headerlink" title="Scenario 2: SELECT FOR UPDATE (Next-Key Locking)"></a>Scenario 2: SELECT FOR UPDATE (Next-Key Locking)</h3><p><strong>Session A (Transaction 1):</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> TRANSACTION ISOLATION LEVEL REPEATABLE READ;</span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Query with FOR UPDATE</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> salary <span class="keyword">BETWEEN</span> <span class="number">50000</span> <span class="keyword">AND</span> <span class="number">60000</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line"><span class="comment">-- This creates next-key locks on the range</span></span><br></pre></td></tr></table></figure>

<p><strong>Session B (Transaction 2):</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Try to insert in the locked range</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (name, salary, department) </span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;Frank&#x27;</span>, <span class="number">55000</span>, <span class="string">&#x27;Sales&#x27;</span>);</span><br><span class="line"><span class="comment">-- This will BLOCK until Transaction 1 commits</span></span><br></pre></td></tr></table></figure>

<p><strong>Session A continues:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Repeat the query</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> salary <span class="keyword">BETWEEN</span> <span class="number">50000</span> <span class="keyword">AND</span> <span class="number">60000</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line"><span class="comment">-- Results remain consistent</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="comment">-- Now Session B&#x27;s INSERT will proceed</span></span><br></pre></td></tr></table></figure>

<h3 id="Scenario-3-Gap-Locking-Visualization"><a href="#Scenario-3-Gap-Locking-Visualization" class="headerlink" title="Scenario 3: Gap Locking Visualization"></a>Scenario 3: Gap Locking Visualization</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Current salary values: 50000, 55000, 60000, 70000</span></span><br><span class="line"><span class="comment">-- Gap locks are placed between these values:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Gaps protected by next-key locks:</span></span><br><span class="line"><span class="comment">-- (-∞, 50000)</span></span><br><span class="line"><span class="comment">-- (50000, 55000)</span></span><br><span class="line"><span class="comment">-- (55000, 60000)</span></span><br><span class="line"><span class="comment">-- (60000, 70000)</span></span><br><span class="line"><span class="comment">-- (70000, +∞)</span></span><br></pre></td></tr></table></figure>

<h2 id="Types-of-Locks-Used"><a href="#Types-of-Locks-Used" class="headerlink" title="Types of Locks Used"></a>Types of Locks Used</h2><h3 id="Record-Locks"><a href="#Record-Locks" class="headerlink" title="Record Locks"></a>Record Locks</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Locks specific existing rows</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line"><span class="comment">-- Locks only the row with id = 1</span></span><br></pre></td></tr></table></figure>

<h3 id="Gap-Locks"><a href="#Gap-Locks" class="headerlink" title="Gap Locks"></a>Gap Locks</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Locks gaps between index values</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> <span class="number">55000</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line"><span class="comment">-- Locks gaps: (55000, 60000), (60000, 70000), (70000, +∞)</span></span><br></pre></td></tr></table></figure>

<h3 id="Next-Key-Locks"><a href="#Next-Key-Locks" class="headerlink" title="Next-Key Locks"></a>Next-Key Locks</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Combination of record + gap locks</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> salary <span class="operator">&gt;=</span> <span class="number">55000</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line"><span class="comment">-- Locks: record(55000) + gap(55000, 60000) + record(60000) + gap(60000, 70000) + etc.</span></span><br></pre></td></tr></table></figure>

<h2 id="Important-Limitations-and-Caveats"><a href="#Important-Limitations-and-Caveats" class="headerlink" title="Important Limitations and Caveats"></a>Important Limitations and Caveats</h2><h3 id="Index-Dependency"><a href="#Index-Dependency" class="headerlink" title="Index Dependency"></a>Index Dependency</h3><p>Gap locking only works effectively with indexed columns:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- This uses gap locking (salary is indexed)</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> <span class="number">50000</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- This may not prevent phantoms effectively (name is not indexed)</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="keyword">LIKE</span> <span class="string">&#x27;A%&#x27;</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Disabling-Gap-Locks"><a href="#Disabling-Gap-Locks" class="headerlink" title="Disabling Gap Locks"></a>Disabling Gap Locks</h3><p>Gap locking can be disabled, which reintroduces phantom read risks:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Disable gap locking (NOT recommended)</span></span><br><span class="line"><span class="keyword">SET</span> SESSION innodb_locks_unsafe_for_binlog <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- or</span></span><br><span class="line"><span class="keyword">SET</span> SESSION transaction_isolation <span class="operator">=</span> <span class="string">&#x27;READ-COMMITTED&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Different-Behavior-by-Query-Type"><a href="#Different-Behavior-by-Query-Type" class="headerlink" title="Different Behavior by Query Type"></a>Different Behavior by Query Type</h3><table>
<thead>
<tr>
<th>Query Type</th>
<th>Locking Mechanism</th>
<th>Phantom Prevention</th>
</tr>
</thead>
<tbody><tr>
<td><code>SELECT</code></td>
<td>MVCC snapshot</td>
<td>✅ Yes</td>
</tr>
<tr>
<td><code>SELECT FOR UPDATE</code></td>
<td>Next-key locks</td>
<td>✅ Yes</td>
</tr>
<tr>
<td><code>SELECT FOR SHARE</code></td>
<td>Next-key locks</td>
<td>✅ Yes</td>
</tr>
<tr>
<td><code>UPDATE</code></td>
<td>Next-key locks</td>
<td>✅ Yes</td>
</tr>
<tr>
<td><code>DELETE</code></td>
<td>Next-key locks</td>
<td>✅ Yes</td>
</tr>
</tbody></table>
<h3 id="4-Edge-Cases-Where-Phantoms-Can-Still-Occur"><a href="#4-Edge-Cases-Where-Phantoms-Can-Still-Occur" class="headerlink" title="4. Edge Cases Where Phantoms Can Still Occur"></a>4. Edge Cases Where Phantoms Can Still Occur</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Case 1: Non-indexed column queries</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="keyword">LIKE</span> <span class="string">&#x27;Z%&#x27;</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line"><span class="comment">-- May not prevent phantoms effectively</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Case 2: After updating a row in the same transaction</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> <span class="number">50000</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> <span class="number">55000</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> <span class="number">50000</span>;</span><br><span class="line"><span class="comment">-- Second SELECT might see changes from other committed transactions</span></span><br></pre></td></tr></table></figure>

<h2 id="Best-Practices"><a href="#Best-Practices" class="headerlink" title="Best Practices"></a>Best Practices</h2><h3 id="Use-Indexed-Columns-for-Range-Queries"><a href="#Use-Indexed-Columns-for-Range-Queries" class="headerlink" title="Use Indexed Columns for Range Queries"></a>Use Indexed Columns for Range Queries</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Good: Uses index for gap locking</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> salary <span class="keyword">BETWEEN</span> <span class="number">50000</span> <span class="keyword">AND</span> <span class="number">70000</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Less effective: No index on name</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="keyword">BETWEEN</span> <span class="string">&#x27;A&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;M&#x27;</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Understand-Your-Query-Patterns"><a href="#Understand-Your-Query-Patterns" class="headerlink" title="Understand Your Query Patterns"></a>Understand Your Query Patterns</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- For read-only queries, regular SELECT is sufficient</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> department <span class="operator">=</span> <span class="string">&#x27;Engineering&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- For queries that need to prevent concurrent inserts</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> department <span class="operator">=</span> <span class="string">&#x27;Engineering&#x27;</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Monitor-Lock-Contention"><a href="#Monitor-Lock-Contention" class="headerlink" title="Monitor Lock Contention"></a>Monitor Lock Contention</h3><p><strong>For MySQL 8.0+:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Check current locks</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> performance_schema.data_locks;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Check lock waits</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> performance_schema.data_lock_waits;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- More detailed lock information</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    dl.OBJECT_SCHEMA,</span><br><span class="line">    dl.OBJECT_NAME,</span><br><span class="line">    dl.LOCK_TYPE,</span><br><span class="line">    dl.LOCK_MODE,</span><br><span class="line">    dl.LOCK_STATUS,</span><br><span class="line">    dl.LOCK_DATA</span><br><span class="line"><span class="keyword">FROM</span> performance_schema.data_locks dl;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Check which transactions are waiting</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    dlw.REQUESTING_ENGINE_TRANSACTION_ID <span class="keyword">as</span> waiting_trx,</span><br><span class="line">    dlw.BLOCKING_ENGINE_TRANSACTION_ID <span class="keyword">as</span> blocking_trx,</span><br><span class="line">    dl.LOCK_MODE <span class="keyword">as</span> waiting_lock_mode,</span><br><span class="line">    dl.LOCK_TYPE <span class="keyword">as</span> waiting_lock_type,</span><br><span class="line">    dl.OBJECT_NAME <span class="keyword">as</span> table_name</span><br><span class="line"><span class="keyword">FROM</span> performance_schema.data_lock_waits dlw</span><br><span class="line"><span class="keyword">JOIN</span> performance_schema.data_locks dl </span><br><span class="line">    <span class="keyword">ON</span> dlw.REQUESTING_ENGINE_LOCK_ID <span class="operator">=</span> dl.ENGINE_LOCK_ID;</span><br></pre></td></tr></table></figure>

<p><strong>For MySQL 5.7 and earlier:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Check current locks (deprecated in 8.0)</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> INFORMATION_SCHEMA.INNODB_LOCKS;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Check lock waits (deprecated in 8.0)</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> INFORMATION_SCHEMA.INNODB_LOCK_WAITS;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Considerations"><a href="#Performance-Considerations" class="headerlink" title="Performance Considerations"></a>Performance Considerations</h2><h3 id="Advantages"><a href="#Advantages" class="headerlink" title="Advantages"></a>Advantages</h3><ul>
<li>Prevents phantom reads without full table locking</li>
<li>MVCC provides excellent read performance</li>
<li>Better concurrency than Serializable isolation</li>
</ul>
<h3 id="Trade-offs"><a href="#Trade-offs" class="headerlink" title="Trade-offs"></a>Trade-offs</h3><ul>
<li>Gap locks can increase lock contention</li>
<li>More complex lock management overhead</li>
<li>Potential for deadlocks in high-concurrency scenarios</li>
</ul>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>MySQL InnoDB’s approach to preventing phantom reads is highly effective, combining:</p>
<ul>
<li><strong>MVCC snapshots</strong> for regular SELECT operations</li>
<li><strong>Next-key locking</strong> for locking reads and modifications</li>
<li><strong>Gap locking</strong> to prevent insertions in critical ranges</li>
</ul>
<p>This makes MySQL’s REPEATABLE READ isolation level more restrictive than the SQL standard, effectively preventing most phantom read scenarios while maintaining good performance characteristics. However, understanding the limitations and edge cases is crucial for designing robust database applications.</p>
<h2 id="Testing-Your-Understanding"><a href="#Testing-Your-Understanding" class="headerlink" title="Testing Your Understanding"></a>Testing Your Understanding</h2><p>Try these scenarios in your own MySQL environment:</p>
<ol>
<li><strong>Test MVCC behavior</strong>: Use two sessions with regular SELECT statements</li>
<li><strong>Test gap locking</strong>: Use SELECT FOR UPDATE with range queries</li>
<li><strong>Test limitations</strong>: Try queries on non-indexed columns</li>
<li><strong>Observe lock contention</strong>: Monitor <code>INFORMATION_SCHEMA.INNODB_LOCKS</code> during concurrent operations</li>
</ol>
<p>Understanding these mechanisms will help you design more robust database applications and troubleshoot concurrency issues effectively.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/07/MySQL-MVCC-Detailed-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/07/MySQL-MVCC-Detailed-Guide/" class="post-title-link" itemprop="url">MySQL MVCC Detailed Guide</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-07 20:12:50" itemprop="dateCreated datePublished" datetime="2025-06-07T20:12:50+08:00">2025-06-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-08 21:36:30" itemprop="dateModified" datetime="2025-06-08T21:36:30+08:00">2025-06-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="What-is-MVCC-Multi-Version-Concurrency-Control"><a href="#What-is-MVCC-Multi-Version-Concurrency-Control" class="headerlink" title="What is MVCC(Multi-Version Concurrency Control)?"></a>What is MVCC(Multi-Version Concurrency Control)?</h1><p>MVCC is a concurrency control method that allows multiple transactions to access the same data simultaneously without blocking each other. Instead of using locks for reads, MVCC maintains multiple versions of data and shows each transaction a consistent snapshot based on when the transaction started.</p>
<h1 id="Why-MVCC-Matters"><a href="#Why-MVCC-Matters" class="headerlink" title="Why MVCC Matters"></a>Why MVCC Matters</h1><h2 id="Traditional-Locking-Problems"><a href="#Traditional-Locking-Problems" class="headerlink" title="Traditional Locking Problems"></a>Traditional Locking Problems</h2><p>Without MVCC, databases face the <strong>readers-writers problem</strong>:</p>
<ul>
<li><strong>Readers block writers</strong>: Transactions reading data prevent others from modifying it</li>
<li><strong>Writers block readers</strong>: Transactions modifying data prevent others from reading it</li>
<li><strong>Performance bottleneck</strong>: High contention leads to poor concurrency</li>
</ul>
<h2 id="MVCC-Benefits"><a href="#MVCC-Benefits" class="headerlink" title="MVCC Benefits"></a>MVCC Benefits</h2><ul>
<li><strong>Non-blocking reads</strong>: Readers never block writers and vice versa</li>
<li><strong>Consistent snapshots</strong>: Each transaction sees a consistent view of data</li>
<li><strong>Higher concurrency</strong>: Multiple transactions can work simultaneously</li>
<li><strong>ACID compliance</strong>: Maintains isolation without sacrificing performance</li>
</ul>
<h1 id="Core-MVCC-Components"><a href="#Core-MVCC-Components" class="headerlink" title="Core MVCC Components"></a>Core MVCC Components</h1><h2 id="Hidden-Columns-in-InnoDB"><a href="#Hidden-Columns-in-InnoDB" class="headerlink" title="Hidden Columns in InnoDB"></a>Hidden Columns in InnoDB</h2><p>Every InnoDB table row contains hidden system columns:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">| User Data | DB_TRX_ID | DB_ROLL_PTR | DB_ROW_ID |</span><br><span class="line">|-----------|-----------|-------------|-----------|</span><br><span class="line">| name, age | 12345     | 0x8A2B...   | 67890     |</span><br></pre></td></tr></table></figure>

<h3 id="DB-TRX-ID-Transaction-ID"><a href="#DB-TRX-ID-Transaction-ID" class="headerlink" title="DB_TRX_ID (Transaction ID)"></a>DB_TRX_ID (Transaction ID)</h3><ul>
<li><strong>Size</strong>: 6 bytes</li>
<li><strong>Purpose</strong>: Identifies which transaction last modified this row</li>
<li><strong>Behavior</strong>: Updated every time a row is inserted or updated</li>
<li><strong>Uniqueness</strong>: Globally unique, monotonically increasing</li>
</ul>
<h3 id="DB-ROLL-PTR-Rollback-Pointer"><a href="#DB-ROLL-PTR-Rollback-Pointer" class="headerlink" title="DB_ROLL_PTR (Rollback Pointer)"></a>DB_ROLL_PTR (Rollback Pointer)</h3><ul>
<li><strong>Size</strong>: 7 bytes</li>
<li><strong>Purpose</strong>: Points to the undo log record for this row’s previous version</li>
<li><strong>Structure</strong>: Contains undo log segment ID and offset</li>
<li><strong>Function</strong>: Forms the backbone of the version chain</li>
</ul>
<h3 id="DB-ROW-ID-Row-ID"><a href="#DB-ROW-ID-Row-ID" class="headerlink" title="DB_ROW_ID (Row ID)"></a>DB_ROW_ID (Row ID)</h3><ul>
<li><strong>Size</strong>: 6 bytes</li>
<li><strong>Purpose</strong>: Auto-incrementing row identifier</li>
<li><strong>When used</strong>: Only when table has no primary key or unique index</li>
<li><strong>Note</strong>: Not directly related to MVCC, but part of InnoDB’s row format</li>
</ul>
<h2 id="Version-Chains-and-Undo-Log"><a href="#Version-Chains-and-Undo-Log" class="headerlink" title="Version Chains and Undo Log"></a>Version Chains and Undo Log</h2><h3 id="Version-Chain-Structure"><a href="#Version-Chain-Structure" class="headerlink" title="Version Chain Structure"></a>Version Chain Structure</h3><p>When a row is modified multiple times, MVCC creates a version chain:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Current Row (TRX_ID: 103)</span><br><span class="line">    ↓ (DB_ROLL_PTR)</span><br><span class="line">Version 2 (TRX_ID: 102) ← Undo Log Entry</span><br><span class="line">    ↓ (roll_ptr)</span><br><span class="line">Version 1 (TRX_ID: 101) ← Undo Log Entry</span><br><span class="line">    ↓ (roll_ptr)</span><br><span class="line">Original (TRX_ID: 100) ← Undo Log Entry</span><br></pre></td></tr></table></figure>

<h3 id="Detailed-Example"><a href="#Detailed-Example" class="headerlink" title="Detailed Example"></a>Detailed Example</h3><p>Let’s trace a row through multiple modifications:</p>
<h4 id="Initial-State"><a href="#Initial-State" class="headerlink" title="Initial State"></a>Initial State</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Transaction 100 inserts row</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (name, age) <span class="keyword">VALUES</span> (<span class="string">&#x27;Alice&#x27;</span>, <span class="number">25</span>);</span><br></pre></td></tr></table></figure>

<p><strong>Row State:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">| name: Alice | age: 25 | DB_TRX_ID: 100 | DB_ROLL_PTR: NULL |</span><br></pre></td></tr></table></figure>

<h4 id="First-Update"><a href="#First-Update" class="headerlink" title="First Update"></a>First Update</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Transaction 101 updates age</span></span><br><span class="line"><span class="keyword">UPDATE</span> users <span class="keyword">SET</span> age <span class="operator">=</span> <span class="number">26</span> <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;Alice&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>After Update:</strong></p>
<ul>
<li><strong>Current row</strong>: <code>| name: Alice | age: 26 | DB_TRX_ID: 101 | DB_ROLL_PTR: 0x8A2B |</code></li>
<li><strong>Undo log entry</strong>: <code>| operation: UPDATE | old_age: 25 | roll_ptr: NULL |</code></li>
</ul>
<h4 id="Second-Update"><a href="#Second-Update" class="headerlink" title="Second Update"></a>Second Update</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Transaction 102 updates name</span></span><br><span class="line"><span class="keyword">UPDATE</span> users <span class="keyword">SET</span> name <span class="operator">=</span> <span class="string">&#x27;Alicia&#x27;</span> <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;Alice&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>After Update:</strong></p>
<ul>
<li><strong>Current row</strong>: <code>| name: Alicia | age: 26 | DB_TRX_ID: 102 | DB_ROLL_PTR: 0x8C3D |</code></li>
<li><strong>New undo entry</strong>: <code>| operation: UPDATE | old_name: Alice | roll_ptr: 0x8A2B |</code></li>
<li><strong>Previous undo entry</strong>: <code>| operation: UPDATE | old_age: 25 | roll_ptr: NULL |</code></li>
</ul>
<h3 id="Undo-Log-Types"><a href="#Undo-Log-Types" class="headerlink" title="Undo Log Types"></a>Undo Log Types</h3><h4 id="INSERT-Undo-Log"><a href="#INSERT-Undo-Log" class="headerlink" title="INSERT Undo Log"></a>INSERT Undo Log</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">| Type: INSERT | Table ID | Primary Key Values | Transaction ID |</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>Purpose</strong>: Rolling back INSERT operations</li>
<li><strong>Content</strong>: Only primary key needed (for deletion)</li>
<li><strong>Cleanup</strong>: Purged immediately after transaction commits</li>
</ul>
<h4 id="UPDATE-Undo-Log"><a href="#UPDATE-Undo-Log" class="headerlink" title="UPDATE Undo Log"></a>UPDATE Undo Log</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">| Type: UPDATE | Table ID | Primary Key | Changed Columns | Old Values | roll_ptr |</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>Purpose</strong>: Rolling back UPDATE operations and MVCC reads</li>
<li><strong>Content</strong>: Original values of modified columns</li>
<li><strong>Cleanup</strong>: Purged when no active transaction needs this version</li>
</ul>
<h4 id="DELETE-Undo-Log"><a href="#DELETE-Undo-Log" class="headerlink" title="DELETE Undo Log"></a>DELETE Undo Log</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">| Type: DELETE | Table ID | Complete Row Data | roll_ptr |</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>Purpose</strong>: Rolling back DELETE operations</li>
<li><strong>Content</strong>: Entire row data</li>
<li><strong>Behavior</strong>: Row is marked as deleted but not physically removed</li>
</ul>
<h2 id="Read-View-Mechanism"><a href="#Read-View-Mechanism" class="headerlink" title="Read View Mechanism"></a>Read View Mechanism</h2><h3 id="Read-View-Structure"><a href="#Read-View-Structure" class="headerlink" title="Read View Structure"></a>Read View Structure</h3><p>A Read View is a snapshot of active transactions at a specific point in time:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ReadView</span> &#123;</span><br><span class="line">    <span class="type">trx_id_t</span>    m_low_limit_id;     <span class="comment">// Highest TRX_ID + 1 at creation time</span></span><br><span class="line">    <span class="type">trx_id_t</span>    m_up_limit_id;      <span class="comment">// Lowest active TRX_ID at creation time</span></span><br><span class="line">    <span class="type">trx_list_t</span>  m_ids;             <span class="comment">// List of active transaction IDs</span></span><br><span class="line">    <span class="type">trx_id_t</span>    m_creator_trx_id;   <span class="comment">// Transaction ID that created this view</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="Read-View-Fields-Explained"><a href="#Read-View-Fields-Explained" class="headerlink" title="Read View Fields Explained"></a>Read View Fields Explained</h3><h4 id="m-low-limit-id-High-Water-Mark"><a href="#m-low-limit-id-High-Water-Mark" class="headerlink" title="m_low_limit_id (High Water Mark)"></a>m_low_limit_id (High Water Mark)</h4><ul>
<li><strong>Definition</strong>: Next transaction ID to be assigned</li>
<li><strong>Rule</strong>: Any TRX_ID ≥ m_low_limit_id is invisible (not yet started)</li>
</ul>
<h4 id="m-up-limit-id-Low-Water-Mark"><a href="#m-up-limit-id-Low-Water-Mark" class="headerlink" title="m_up_limit_id (Low Water Mark)"></a>m_up_limit_id (Low Water Mark)</h4><ul>
<li><strong>Definition</strong>: Smallest active transaction ID when Read View was created</li>
<li><strong>Rule</strong>: Any TRX_ID &lt; m_up_limit_id is visible (committed before snapshot)</li>
</ul>
<h4 id="m-ids-Active-Transaction-List"><a href="#m-ids-Active-Transaction-List" class="headerlink" title="m_ids (Active Transaction List)"></a>m_ids (Active Transaction List)</h4><ul>
<li><strong>Definition</strong>: List of all active (uncommitted) transaction IDs</li>
<li><strong>Rule</strong>: Any TRX_ID in this list is invisible (uncommitted)</li>
</ul>
<h4 id="m-creator-trx-id"><a href="#m-creator-trx-id" class="headerlink" title="m_creator_trx_id"></a>m_creator_trx_id</h4><ul>
<li><strong>Definition</strong>: ID of the transaction that created this Read View</li>
<li><strong>Rule</strong>: Changes made by this transaction are always visible to itself</li>
</ul>
<h3 id="Visibility-Algorithm"><a href="#Visibility-Algorithm" class="headerlink" title="Visibility Algorithm"></a>Visibility Algorithm</h3><p>For each row version, MVCC determines visibility using this logic:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">is_visible</span>(<span class="params">row_trx_id, read_view</span>):</span><br><span class="line">    <span class="comment"># Rule 1: Own changes are always visible</span></span><br><span class="line">    <span class="keyword">if</span> row_trx_id == read_view.m_creator_trx_id:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Rule 2: Future transactions are invisible</span></span><br><span class="line">    <span class="keyword">if</span> row_trx_id &gt;= read_view.m_low_limit_id:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Rule 3: Very old transactions are visible</span></span><br><span class="line">    <span class="keyword">if</span> row_trx_id &lt; read_view.m_up_limit_id:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Rule 4: Check if transaction was active</span></span><br><span class="line">    <span class="keyword">if</span> row_trx_id <span class="keyword">in</span> read_view.m_ids:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>  <span class="comment"># Was active, so invisible</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span>   <span class="comment"># Was committed, so visible</span></span><br></pre></td></tr></table></figure>

<h3 id="Detailed-Visibility-Example"><a href="#Detailed-Visibility-Example" class="headerlink" title="Detailed Visibility Example"></a>Detailed Visibility Example</h3><p><strong>Scenario Setup:</strong></p>
<ul>
<li>Active transactions: 100, 102, 105</li>
<li>Next TRX_ID to assign: 106</li>
<li>Current transaction: 103 (reading data)</li>
</ul>
<p><strong>Read View for Transaction 103:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">m_creator_trx_id: 103</span><br><span class="line">m_up_limit_id: 100    (lowest active)</span><br><span class="line">m_low_limit_id: 106   (next to assign)</span><br><span class="line">m_ids: [100, 102, 105] (active transactions)</span><br></pre></td></tr></table></figure>

<p><strong>Visibility Tests:</strong></p>
<ul>
<li><strong>TRX_ID 99</strong>: Visible (&lt; m_up_limit_id, committed before snapshot)</li>
<li><strong>TRX_ID 100</strong>: Invisible (in m_ids, still active)</li>
<li><strong>TRX_ID 101</strong>: Visible (not in m_ids, committed)</li>
<li><strong>TRX_ID 102</strong>: Invisible (in m_ids, still active)</li>
<li><strong>TRX_ID 103</strong>: Visible (own transaction)</li>
<li><strong>TRX_ID 104</strong>: Visible (not in m_ids, committed)</li>
<li><strong>TRX_ID 105</strong>: Invisible (in m_ids, still active)</li>
<li><strong>TRX_ID 106</strong>: Invisible (≥ m_low_limit_id, future transaction)</li>
</ul>
<h2 id="Isolation-Levels-and-Read-Views"><a href="#Isolation-Levels-and-Read-Views" class="headerlink" title="Isolation Levels and Read Views"></a>Isolation Levels and Read Views</h2><h3 id="READ-COMMITTED"><a href="#READ-COMMITTED" class="headerlink" title="READ COMMITTED"></a>READ COMMITTED</h3><ul>
<li><strong>Read View Creation</strong>: New Read View for <strong>every</strong> SELECT statement</li>
<li><strong>Behavior</strong>: Sees all changes committed before each individual statement</li>
<li><strong>Result</strong>: Can see different data within the same transaction (non-repeatable reads)</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Transaction A</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">SELECT</span> age <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;Alice&#x27;</span>; <span class="comment">-- Returns 25</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Transaction B commits: UPDATE users SET age = 26 WHERE name = &#x27;Alice&#x27;;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> age <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;Alice&#x27;</span>; <span class="comment">-- Returns 26 (different result!)</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<h3 id="REPEATABLE-READ"><a href="#REPEATABLE-READ" class="headerlink" title="REPEATABLE READ"></a>REPEATABLE READ</h3><ul>
<li><strong>Read View Creation</strong>: Single Read View at <strong>first</strong> SELECT statement</li>
<li><strong>Behavior</strong>: Consistent snapshot throughout the entire transaction</li>
<li><strong>Result</strong>: Same data for all reads within the transaction</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Transaction A</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">SELECT</span> age <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;Alice&#x27;</span>; <span class="comment">-- Returns 25, creates Read View</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Transaction B commits: UPDATE users SET age = 26 WHERE name = &#x27;Alice&#x27;;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> age <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;Alice&#x27;</span>; <span class="comment">-- Still returns 25 (consistent!)</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<h2 id="MVCC-Read-Process-Step-by-Step"><a href="#MVCC-Read-Process-Step-by-Step" class="headerlink" title="MVCC Read Process (Step by Step)"></a>MVCC Read Process (Step by Step)</h2><h3 id="When-a-SELECT-Statement-Executes"><a href="#When-a-SELECT-Statement-Executes" class="headerlink" title="When a SELECT Statement Executes:"></a>When a SELECT Statement Executes:</h3><h4 id="Step-1-Create-or-Reuse-Read-View"><a href="#Step-1-Create-or-Reuse-Read-View" class="headerlink" title="Step 1: Create or Reuse Read View"></a>Step 1: Create or Reuse Read View</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> name, age <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> user_id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>READ COMMITTED</strong>: Create new Read View</li>
<li><strong>REPEATABLE READ</strong>: Use existing Read View or create if first read</li>
</ul>
<h4 id="Step-2-Locate-Current-Row-Version"><a href="#Step-2-Locate-Current-Row-Version" class="headerlink" title="Step 2: Locate Current Row Version"></a>Step 2: Locate Current Row Version</h4><ul>
<li>Use index or table scan to find the row</li>
<li>Current row has latest TRX_ID and ROLL_PTR</li>
</ul>
<h4 id="Step-3-Apply-Visibility-Rules"><a href="#Step-3-Apply-Visibility-Rules" class="headerlink" title="Step 3: Apply Visibility Rules"></a>Step 3: Apply Visibility Rules</h4><ul>
<li>Check if current version is visible using Read View</li>
<li>If visible, return this version</li>
<li>If not visible, follow the version chain</li>
</ul>
<h4 id="Step-4-Traverse-Version-Chain"><a href="#Step-4-Traverse-Version-Chain" class="headerlink" title="Step 4: Traverse Version Chain"></a>Step 4: Traverse Version Chain</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Current Row (TRX_ID: 105) → Not visible</span><br><span class="line">    ↓ (follow ROLL_PTR)</span><br><span class="line">Version in Undo (TRX_ID: 103) → Not visible</span><br><span class="line">    ↓ (follow roll_ptr)</span><br><span class="line">Version in Undo (TRX_ID: 101) → Visible! Return this version</span><br></pre></td></tr></table></figure>

<h4 id="Step-5-Return-Appropriate-Version"><a href="#Step-5-Return-Appropriate-Version" class="headerlink" title="Step 5: Return Appropriate Version"></a>Step 5: Return Appropriate Version</h4><ul>
<li>Return the first visible version found</li>
<li>If no visible version exists, row doesn’t exist for this transaction</li>
</ul>
<h2 id="MVCC-Write-Operations"><a href="#MVCC-Write-Operations" class="headerlink" title="MVCC Write Operations"></a>MVCC Write Operations</h2><h3 id="INSERT-Operations"><a href="#INSERT-Operations" class="headerlink" title="INSERT Operations"></a>INSERT Operations</h3><ol>
<li><strong>Create new row</strong> with current transaction’s TRX_ID</li>
<li><strong>No undo log needed</strong> for MVCC (only for rollback)</li>
<li><strong>Row immediately visible</strong> to the inserting transaction</li>
<li><strong>Invisible to others</strong> until transaction commits</li>
</ol>
<h3 id="UPDATE-Operations"><a href="#UPDATE-Operations" class="headerlink" title="UPDATE Operations"></a>UPDATE Operations</h3><ol>
<li><strong>Create undo log entry</strong> with original values</li>
<li><strong>Update current row</strong> with new values and TRX_ID</li>
<li><strong>Link to previous version</strong> via ROLL_PTR</li>
<li><strong>Original version remains</strong> accessible via undo log</li>
</ol>
<h3 id="DELETE-Operations"><a href="#DELETE-Operations" class="headerlink" title="DELETE Operations"></a>DELETE Operations</h3><ol>
<li><strong>Mark row as deleted</strong> (set delete flag)</li>
<li><strong>Create undo log entry</strong> with complete row data</li>
<li><strong>Row remains physically present</strong> but marked deleted</li>
<li><strong>Appears deleted to new transactions</strong> but still visible to older ones</li>
</ol>
<h2 id="Purge-Process"><a href="#Purge-Process" class="headerlink" title="Purge Process"></a>Purge Process</h2><h3 id="Why-Purge-is-Needed"><a href="#Why-Purge-is-Needed" class="headerlink" title="Why Purge is Needed"></a>Why Purge is Needed</h3><ul>
<li>Undo logs grow indefinitely without cleanup</li>
<li>Old versions become unnecessary when no transaction needs them</li>
<li>Storage space must be reclaimed</li>
</ul>
<h3 id="Purge-Thread-Operation"><a href="#Purge-Thread-Operation" class="headerlink" title="Purge Thread Operation"></a>Purge Thread Operation</h3><ol>
<li><strong>Identify purgeable versions</strong>: No active transaction needs them</li>
<li><strong>Remove undo log entries</strong>: Free up undo tablespace</li>
<li><strong>Physical row deletion</strong>: Remove rows marked for deletion</li>
<li><strong>Index cleanup</strong>: Remove deleted entries from secondary indexes</li>
</ol>
<h3 id="Purge-Lag-Issues"><a href="#Purge-Lag-Issues" class="headerlink" title="Purge Lag Issues"></a>Purge Lag Issues</h3><p>When purge falls behind:</p>
<ul>
<li><strong>Undo tablespace growth</strong>: Disk space consumption increases</li>
<li><strong>Version chain length</strong>: Longer chains slow down reads</li>
<li><strong>Memory pressure</strong>: More versions kept in buffer pool</li>
</ul>
<h2 id="Performance-Implications"><a href="#Performance-Implications" class="headerlink" title="Performance Implications"></a>Performance Implications</h2><h3 id="MVCC-Benefits-1"><a href="#MVCC-Benefits-1" class="headerlink" title="MVCC Benefits"></a>MVCC Benefits</h3><ul>
<li><strong>High concurrency</strong>: No read-write blocking</li>
<li><strong>Consistent reads</strong>: Snapshot isolation without locks</li>
<li><strong>Predictable performance</strong>: No lock contention delays</li>
</ul>
<h3 id="MVCC-Costs"><a href="#MVCC-Costs" class="headerlink" title="MVCC Costs"></a>MVCC Costs</h3><ul>
<li><strong>Storage overhead</strong>: Multiple versions consume space</li>
<li><strong>Version traversal</strong>: Long chains increase read latency</li>
<li><strong>Purge overhead</strong>: Background cleanup uses resources</li>
<li><strong>Undo log I&#x2F;O</strong>: Additional disk operations for version chains</li>
</ul>
<h3 id="Optimization-Strategies"><a href="#Optimization-Strategies" class="headerlink" title="Optimization Strategies"></a>Optimization Strategies</h3><ol>
<li><strong>Monitor purge lag</strong>: Ensure purge keeps up with modifications</li>
<li><strong>Tune undo tablespace</strong>: Size appropriately for workload</li>
<li><strong>Minimize long transactions</strong>: Reduce version chain lengths</li>
<li><strong>Index optimization</strong>: Reduce version traversal overhead</li>
</ol>
<h2 id="Common-MVCC-Scenarios"><a href="#Common-MVCC-Scenarios" class="headerlink" title="Common MVCC Scenarios"></a>Common MVCC Scenarios</h2><h3 id="Phantom-Reads-Prevention"><a href="#Phantom-Reads-Prevention" class="headerlink" title="Phantom Reads Prevention"></a>Phantom Reads Prevention</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Transaction 1 (REPEATABLE READ)</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> amount <span class="operator">&gt;</span> <span class="number">1000</span>; <span class="comment">-- Returns 5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Transaction 2 inserts new row</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (amount) <span class="keyword">VALUES</span> (<span class="number">1500</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Transaction 1 continues</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> amount <span class="operator">&gt;</span> <span class="number">1000</span>; <span class="comment">-- Still returns 5</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Consistent-Backup"><a href="#Consistent-Backup" class="headerlink" title="Consistent Backup"></a>Consistent Backup</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Long-running backup transaction</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION <span class="keyword">WITH</span> CONSISTENT SNAPSHOT;</span><br><span class="line"><span class="comment">-- Takes hours to complete, but sees consistent point-in-time data</span></span><br><span class="line">mysqldump <span class="comment">--single-transaction ...</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Read-Write-Workload"><a href="#Read-Write-Workload" class="headerlink" title="Read-Write Workload"></a>Read-Write Workload</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Reader transaction</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> accounts <span class="keyword">WHERE</span> account_id <span class="operator">=</span> <span class="number">1</span>; <span class="comment">-- Non-blocking read</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Writer transaction (concurrent)</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">100</span> <span class="keyword">WHERE</span> account_id <span class="operator">=</span> <span class="number">1</span>; <span class="comment">-- Non-blocking write</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Reader continues with original snapshot</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> accounts <span class="keyword">WHERE</span> account_id <span class="operator">=</span> <span class="number">1</span>; <span class="comment">-- Still sees original balance</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<p>This comprehensive understanding of MVCC explains how MySQL achieves high concurrency while maintaining data consistency, making it essential knowledge for database administrators and developers working with high-performance applications.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/01/MySQL-Notes-for-Interview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/01/MySQL-Notes-for-Interview/" class="post-title-link" itemprop="url">MySQL Notes for Interview</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-01 16:40:22 / Modified: 16:52:36" itemprop="dateCreated datePublished" datetime="2025-06-01T16:40:22+08:00">2025-06-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><p>MySQL基础知识</p>
</li>
<li><p>关键词</p>
<ul>
<li>事务隔离级别、三范式</li>
</ul>
</li>
<li><p>如何理解数据库表设计的三个范式</p>
<ul>
<li>第一范式：1NF 是对属性的原子性约束，要求<strong>属性具有原子性</strong>，不可再分解；</li>
<li>第二范式：2NF 是对记录的惟一性约束，要求<strong>记录有惟一标识</strong>，即实体的惟一性；</li>
<li>第三范式：3NF 是对字段冗余性的约束，即任何字段不能由其他字段派生出来，它要求<strong>字段没有冗余</strong>。</li>
</ul>
</li>
<li><p>查询SQL的执行过程</p>
<ul>
<li>执行<strong>连接器</strong><ul>
<li>管理连接，包括权限认证</li>
</ul>
</li>
<li>执行检索缓存（SQL语句与结果的kv存储）</li>
<li>执行<strong>分析器</strong><ul>
<li>词法分析</li>
<li>语法分析</li>
</ul>
</li>
<li>执行<strong>优化器</strong><ul>
<li>执行计划，选择索引方案</li>
</ul>
</li>
<li>执行<strong>执行器</strong><ul>
<li>调用存储引擎接口</li>
<li>表权限检查</li>
</ul>
</li>
</ul>
</li>
<li><p>数据库索引</p>
</li>
<li><p>关键词</p>
<ul>
<li>B+树</li>
<li>支持范围查询、减少磁盘IO、节约内存</li>
</ul>
</li>
<li><p>为什么使用B+树</p>
<ul>
<li>与 B+ 树相比，<strong>跳表</strong>在极端情况下会退化为链表，平衡性差，而数据库查询需要一个可预期的查询时间，并且跳表需要更多的内存。</li>
<li>与 B+ 树相比，<strong>B树</strong>的数据存储在全部节点中，对范围查询不友好。非叶子节点存储了数据，导致内存中难以放下全部非叶子节点。如果内存放不下非叶子节点，那么就意味着查询非叶子节点的时候都需要磁盘 IO。</li>
<li>二叉树、红黑树等层次太深，大量磁盘IO。</li>
<li><strong>B+树的高度一般在2-4层（500万-1000万条记录），根节点常驻内存，查找某一键值的行记录时最多只需要1-3次磁盘IO。</strong></li>
<li>通常使用<strong>自增长的主键</strong>作为索引<ul>
<li>自增主键是连续的，在插入数据的时候能减少<strong>页分裂</strong>，减少数据移动的频率。</li>
</ul>
</li>
</ul>
</li>
<li><p>索引失效的情况</p>
<ul>
<li>使用like、!&#x3D;模糊查询</li>
<li>数据区分度不大（性别等枚举字段）</li>
<li>特殊表达式，数学运算和函数调用</li>
<li>数据量小</li>
</ul>
</li>
<li><p>最左匹配原则（本质上是由联合索引的结构决定的）</p>
<ul>
<li>索引下推：利用联合索引中数据检查是否满足where条件</li>
</ul>
</li>
<li><p>SQL优化</p>
</li>
<li><p>关键词</p>
<ul>
<li>执行计划是否使用索引</li>
<li>索引列的选择</li>
<li>分页查询的优化</li>
</ul>
</li>
<li><p>查看执行计划</p>
<ul>
<li>explain的字段含义<ul>
<li>possible key、type、rows、extra等字段值的含义</li>
<li>全表扫描考虑优化</li>
</ul>
</li>
</ul>
</li>
<li><p>索引列的选择</p>
<ul>
<li>外键</li>
<li>where中的列</li>
<li>order by的列，减少数据库排序消耗</li>
<li>关联条件列</li>
<li>区分度高的列</li>
</ul>
</li>
<li><p>优化方案</p>
<ul>
<li>覆盖索引减少回表</li>
<li>用where替换having（先过滤数据再分组，减少分组耗时）</li>
<li>优化分页查询中的偏移量</li>
</ul>
</li>
<li><p>数据库锁</p>
</li>
<li><p>关键词</p>
<ul>
<li>锁的种类、锁与索引</li>
</ul>
</li>
<li><p>锁的分类</p>
<ul>
<li>根据锁的范围<ul>
<li>行锁</li>
<li>间隙锁（左开右开），工作在可重复读隔离级别</li>
<li>临键锁（左开右闭），工作在可重复读隔离级别</li>
<li>表锁</li>
</ul>
</li>
<li>乐观锁、悲观锁</li>
<li>互斥角度<ul>
<li>共享锁</li>
<li>排他锁</li>
</ul>
</li>
<li>意向锁</li>
</ul>
</li>
<li><p>锁与索引的关系</p>
<ul>
<li>InnoDB的锁是通过索引实现的，锁住一行记录就是锁住用上的索引上的一个叶子节点，没有找到索引就锁住整个表</li>
</ul>
</li>
<li><p>MVCC协议</p>
</li>
<li><p>关键词</p>
<ul>
<li>版本链、读写操作</li>
</ul>
</li>
<li><p>为什么需要MVCC</p>
<ul>
<li>避免读写阻塞问题</li>
</ul>
</li>
<li><p>版本链</p>
<ul>
<li>事务id（trx_id）：事务版本号</li>
<li>回滚指针(roll_ptr)<br> <img src="https://uploader.shimo.im/f/pX4tjYjXIvdzRuhR.png!thumbnail?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3NDg3NjgxNzksImZpbGVHVUlEIjoiWEtxNDJ5TE54ZUY5RWRBTiIsImlhdCI6MTc0ODc2Nzg3OSwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwicGFhIjoiYWxsOmFsbDoiLCJ1c2VySWQiOjE4ODA2NDY4fQ.YXDluI8DZURAoXzZ-VQ2fc-bLD_FAb73Z1hN8_8umps" alt="回滚指针"></li>
<li>undolog<ul>
<li>版本链存储咋在undolog，形似链表</li>
</ul>
</li>
</ul>
</li>
<li><p>Read View</p>
<ul>
<li>不同的Read View，看到不同的活跃事务id列表（m_ids，未提交的事务）；</li>
<li>Read View与事务隔离级别<ul>
<li>已提交读：事务每次发起查询的时候，都会重新创建一个新的 Read View。</li>
<li>可重复读：事务开始的时候，创建出 Read View，中间的多次读操作使用同一个Read View。</li>
</ul>
</li>
</ul>
</li>
<li><p>数据库事务</p>
</li>
<li><p>关键词</p>
<ul>
<li>ACID</li>
<li>隔离级别</li>
</ul>
</li>
<li><p>undolog</p>
<ul>
<li>用于事务回滚，存储了版本链</li>
<li>具体内容<ul>
<li>Insert操作，记录主键，回滚时根据主键删除记录</li>
<li>Delete操作，记录主键删除标记true，回滚时标记为false</li>
<li>Update操作<ul>
<li>更新主键，删除原记录、插入新记录</li>
<li>没有更新主键，记录被更新字段原始内容</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>redolog</p>
<ul>
<li>为什么需要redolog<ul>
<li>顺序写，性能好</li>
</ul>
</li>
<li>redolog buffer刷盘<ul>
<li>innodb_flush_log_at_trx_commit默认是1，事务提交时写入磁盘</li>
</ul>
</li>
</ul>
</li>
<li><p>binlog</p>
<ul>
<li>二进制日志文件</li>
<li>用途<ul>
<li>主从同步</li>
<li>数据库出现故障时恢复数据</li>
</ul>
</li>
<li>刷盘（sync_binlog）<ul>
<li>0，默认值，由操作系统决定刷盘时机</li>
<li>N，每N次提交就刷盘，N越小性能越差</li>
</ul>
</li>
</ul>
</li>
<li><p>数据更新事务执行过程</p>
<ul>
<li>读取并锁住目标行到buffer pool</li>
<li>写undo log回滚日志</li>
<li>修改buffer pool中的数据</li>
<li>写redo log</li>
<li>提交事务，根据innodb_flush_log_at_trx_commit决定是否写入磁盘</li>
<li>刷新buffer pool到磁盘（事务提交了，但buffer pool的数据不是立刻刷到磁盘）</li>
<li>子流程：<ul>
<li>如果在 redo log 已经刷新到磁盘，然后数据库宕机了，buffer pool 丢失了修改，那么在 MySQL 重启之后就会回放这个 redo log，从而纠正数据库里的数据。</li>
<li>如果都没有提交，中途回滚，就可以利用 undo log 去修复 buffer pool 和磁盘上的数据。因为有时，buffer pool 脏页会在事务提交前刷新磁盘，所以 undo log 也可以用来修复磁盘数据。</li>
</ul>
</li>
</ul>
</li>
<li><p>分库分表</p>
</li>
<li><p>关键词</p>
<ul>
<li>分治模式</li>
<li>数量大时分表，并发高时分库</li>
<li>分片算法</li>
</ul>
</li>
<li><p>主键生成</p>
<ul>
<li>数据库自增主键，每个库设置不同的步长</li>
<li>雪花算法</li>
</ul>
</li>
<li><p>分片算法</p>
<ul>
<li>范围分片，时间范围等</li>
<li>hash取模分片</li>
<li>一致性hash分片</li>
<li>查表法<ul>
<li>分片映射表，映射关系可以根据流量动态调整</li>
<li>分片映射表可以使用缓存，避免本身成为热点和性能瓶颈</li>
</ul>
</li>
</ul>
</li>
<li><p>分库分表的问题</p>
<ul>
<li>join操作问题</li>
<li>count计数问题</li>
<li>事务问题</li>
<li>成本问题</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/01/Redis-Notes-for-Interview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/01/Redis-Notes-for-Interview/" class="post-title-link" itemprop="url">Redis Notes for Interview</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-01 16:20:52" itemprop="dateCreated datePublished" datetime="2025-06-01T16:20:52+08:00">2025-06-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-09 21:40:47" itemprop="dateModified" datetime="2025-06-09T21:40:47+08:00">2025-06-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><p>Redis基础知识</p>
</li>
<li><p>关键词</p>
<ul>
<li>内存数据库</li>
<li>数据结构：string、hash、set、sorted set、list、geo、hyperloglog</li>
<li>集群模式：主从、哨兵、cluster分片</li>
<li>使用缓存进行性能优化</li>
</ul>
</li>
<li><p>为什么使用redis？</p>
<ul>
<li><strong>性能</strong>：我们在碰到需要执行耗时特别久，且结果不频繁变动的SQL，就特别适合将运行结果放入缓存。这样， 后面的请求就去缓存中读取，使得请求能够迅速响应。</li>
<li><strong>并发</strong>：在大并发的情况下，所有的请求直接访问数据库，数据库会出现连接异常。这个时候，就需要使用redis 做一个缓冲操作，让请求先访问到redis，而不是直接访问数据库（<strong>MySQl支持1500QPS，而Redis支持2-5wQPS</strong>）。</li>
</ul>
</li>
<li><p>redis的使用场景</p>
<ul>
<li>缓存</li>
<li>秒杀</li>
<li>分布式锁</li>
</ul>
</li>
<li><p>Redis为什么使用单线程</p>
</li>
<li><p>关键词</p>
<ul>
<li>线程任务：命令处理、io处理、持久化、数据同步</li>
<li>6.0版本、配置开启多线程</li>
<li>epoll、reactor</li>
</ul>
</li>
<li><p>高性能的原因</p>
<ul>
<li>内存操作</li>
<li>在Linux上采用了epoll和reactor结合的IO模型<ul>
<li>epoll的本质是管理一堆socket文件描述符<ul>
<li><strong>红黑树</strong>结构维护的全部监控文件描述符</li>
<li><strong>双向链表</strong>维护的就绪列表</li>
<li>中断机制添加就绪文件描述符</li>
<li>关键api：<strong>epoll_create、epoll_ctl、epoll_wait</strong></li>
<li>poll和select的区别：</li>
</ul>
</li>
<li>reactor模式<ul>
<li>Reactor（Dispatcher）调用epoll拿到可用文件描述符，分发事件</li>
<li>Acceptor处理创建连接事件</li>
<li>Handler处理IO读写事件，</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Redis数据类型的底层数据结构</p>
</li>
<li><p>关键词</p>
<ul>
<li>skiplist</li>
</ul>
</li>
<li><p>String（字符串）</p>
<ul>
<li>SDS（简单动态字符串）</li>
<li>缓存用户信息、计数器、分布式锁（setnx）</li>
</ul>
</li>
<li><p>Hash（哈希表）</p>
<ul>
<li>ziplist（小数据） + hashtable（大数据）</li>
<li>存储对象</li>
</ul>
</li>
<li><p>List（列表）</p>
<ul>
<li>双向链表或ziplist</li>
<li>消息队列、最新文章列表</li>
</ul>
</li>
<li><p>Set（集合）</p>
<ul>
<li>intset（整数集合）或hashtable</li>
<li>标签系统、共同好友（sinter求交集）</li>
</ul>
</li>
<li><p>ZSet（有序集合）</p>
<ul>
<li>ziplist + skiplist（跳表）</li>
<li>排行榜（ZADD&#x2F;ZRANGE）、延时队列</li>
</ul>
</li>
<li><p>Redis怎么做数据持久化</p>
</li>
<li><p>关键词</p>
<ul>
<li>AOF、RDB、混合模式</li>
</ul>
</li>
<li><p>RDB</p>
<ul>
<li>定时生成内存数据的二进制快照文件</li>
<li>fork子进程</li>
<li>每个5分钟甚至更长时间执行一次bgsave，数据丢失问题</li>
</ul>
</li>
<li><p>AOF</p>
<ul>
<li>记录所有写操作命令</li>
<li>同步磁盘策略<ul>
<li>每秒同步（appendfsync everysec）</li>
<li>每次修改同步（appendfsync always）</li>
<li>不同步（appendfsync no）</li>
</ul>
</li>
<li>rewrite机制</li>
</ul>
</li>
<li><p>二者比较</p>
<ul>
<li>RDB是每隔一段时间持久化一次, 故障时就会丢失宕机时刻与上一次持久化之间的数据，无法保证数据完整性</li>
<li>AOF存储的是指令序列, 恢复重放时要花费很长时间并且文件更大</li>
</ul>
</li>
<li><p>Redis有哪些集群部署模式</p>
</li>
<li><p>关键词</p>
<ul>
<li>一主多从，读写分离</li>
<li>哨兵</li>
<li>Cluster分片模式</li>
</ul>
</li>
<li><p>一主多从</p>
<ul>
<li>读操作，主库从库都可以接受</li>
<li>写操作，首先到主库执行，然后主库将写操作同步给从库</li>
</ul>
</li>
<li><p>哨兵</p>
<ul>
<li>主库挂了，数据不能写入，通过哨兵重新选主</li>
<li>监控、选主、通知<ul>
<li>哨兵集群</li>
<li>主观下线</li>
<li>客观下线，判断主库下线，需要大多数的哨兵都标记下线</li>
<li>选主打分规则<ul>
<li>从库优先级配置</li>
<li>从库复制进度</li>
<li>从库ID号小的</li>
</ul>
</li>
<li>多个哨兵实例发布订阅连接信息，以此进行信息交换，组成哨兵集群</li>
<li>基于info命令的从库列表，帮助哨兵与从库建立连接</li>
<li>客户端从哨兵订阅关键事件<ul>
<li>主库下线判断</li>
<li>新主库选定</li>
<li>从库重新配置</li>
</ul>
</li>
</ul>
</li>
<li>哨兵之间也有leader选举，决定由谁进行主从切换</li>
</ul>
</li>
<li><p>cluster分片</p>
<ul>
<li>RDB持久化，fork子进程阻塞主线程，当数据量大时导致Redis响应变慢</li>
<li>数据量大时使用分片集群解决单实例的问题<ul>
<li>超过25G</li>
</ul>
</li>
<li>CPU密集型任务可以通过分片集群利用多核CPU</li>
<li>采用hash槽来处理数据与实例之间的映射关系<ul>
<li>固定16384个槽位</li>
<li>哈希槽与实例的关系可以灵活分配</li>
<li>手动分配需要将16384个槽位分配完</li>
</ul>
</li>
</ul>
</li>
<li><p>缓存模式与缓存一致性</p>
</li>
<li><p>关键词</p>
<ul>
<li>Cache Aside旁路缓存</li>
<li>Read Through、Write Through、Write Back、Single Flight</li>
<li>删除缓存、延迟双删</li>
</ul>
</li>
<li><p> 如何保证缓存与数据库的一致性？</p>
<ul>
<li>Cache-Aside 模式：<ul>
<li>读：缓存命中则返回，否则查数据库并回填缓存。</li>
<li>写：先更新数据库，再删除缓存。</li>
</ul>
</li>
<li>延迟双删<ul>
<li>更新数据库后直接删除缓存，过一段时间紧后，再次删除缓存</li>
<li>降低了缓存命中率</li>
</ul>
</li>
<li>兜底方案：设置缓存过期时间、使用消息队列异步同步。</li>
</ul>
</li>
<li><p>穿透、击穿、雪崩缓存问题</p>
</li>
<li><p>关键词</p>
<ul>
<li>热点数据、随机过期时间</li>
<li>布隆过滤器</li>
</ul>
</li>
<li><p>缓存雪崩</p>
<ul>
<li>大量同时过期的key</li>
<li>redis实例宕机</li>
<li>应对策略<ul>
<li>随机过期时间、服务降级</li>
<li>熔断限流、高可靠集群部署；</li>
</ul>
</li>
</ul>
</li>
<li><p>缓存穿透</p>
<ul>
<li>数据既不在redis中，也不在数据库（数据误删或恶意攻击）。</li>
<li>应对策略：<ul>
<li>缓存空值或缺省值</li>
<li>布隆过滤器<ul>
<li>数据结构：位数组 + 多个哈希函数。</li>
<li>写入：对元素进行多次哈希，将对应位设为 1。</li>
<li>查询：若所有哈希位均为 1，则元素可能存在（可能存在误判）。</li>
</ul>
</li>
<li>前端进行非法参数校验。</li>
</ul>
</li>
</ul>
</li>
<li><p>缓存击穿</p>
<ul>
<li>单个热点数据过期失效。</li>
<li>应对策略：<ul>
<li>热点数据不设置过期时间；</li>
</ul>
</li>
</ul>
</li>
<li><p>怎么使用Redis实现分布式锁</p>
</li>
<li><p>关键词</p>
<ul>
<li>支持排他性操作的中间件都可以实现分布式锁</li>
<li>setNX同一个key只会有一个执行成功</li>
<li>过期时间</li>
<li>超时时间</li>
<li>锁续期</li>
</ul>
</li>
<li><p>加锁失败后重试</p>
<ul>
<li>确定等待时间：业务正常执行完毕的时间（99线或999线）</li>
<li>实现等待：<ul>
<li>sleep；</li>
<li>监听锁的释放（del事件）</li>
</ul>
</li>
<li>lua脚本实现超时重试</li>
</ul>
</li>
<li><p>加锁成功了为什么需要设置过期时间</p>
<ul>
<li>加锁成功的线程，执行业务的过程中崩溃，锁未释放</li>
<li>过期时间应该根据业务设置，99%的业务拿到锁之后，1s内完成，可以设置过期时间为2秒，或者保险起见，设置10秒设置1分钟都行。</li>
<li>如果业务持有锁在过期时间内执行不完，需要续期<ul>
<li>过期之前重置下过期时间</li>
<li>启动守护线程定时检查当前线程是否持有锁，持有则重置过期时间</li>
<li>redission看门狗机制</li>
</ul>
</li>
</ul>
</li>
<li><p>释放锁</p>
<ul>
<li>持有锁的机器宕机后恢复</li>
<li>释放需要检查这个锁是否是自己的，防止释放掉其他线程持有的锁</li>
</ul>
</li>
<li><p>Redlock</p>
</li>
<li><p>SingleFlight模式优化分布式锁</p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/01/Kafka-Notes-for-Interview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/01/Kafka-Notes-for-Interview/" class="post-title-link" itemprop="url">Kafka Notes for Interview</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-01 15:58:13" itemprop="dateCreated datePublished" datetime="2025-06-01T15:58:13+08:00">2025-06-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-09 17:17:22" itemprop="dateModified" datetime="2025-06-09T17:17:22+08:00">2025-06-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/kafka/" itemprop="url" rel="index"><span itemprop="name">kafka</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><p>Kafka基础知识</p>
</li>
<li><p>关键词</p>
<ul>
<li>消息队列、流平台</li>
<li>主题、分区、副本</li>
<li>生产者、消费者、broker、Zookeeper</li>
<li>消费者组、offset</li>
<li>ISR协议</li>
</ul>
</li>
<li><p>消息队列的使用场景</p>
<ul>
<li>异步、解耦、削峰</li>
<li>性能、扩展性、可用性</li>
<li>使用场景<ul>
<li>日志处理</li>
<li>消息通信</li>
<li>秒杀</li>
<li>订单超时取消</li>
</ul>
</li>
</ul>
</li>
<li><p>kafka是一个分布式流处理平台，主要用于实时流数据的传输和处理。它可以将大量的消息和事件以分布式、持久化、高可靠性、高吞吐量的方式传输和存储。</p>
</li>
<li><p>消费者组</p>
<ul>
<li>kafka提供的可扩展且具有容错性的消费者机制。</li>
<li>消费者组是一个有多个消费者实例构成的分组。多个实例共同订阅若干个主题，实现共同消费。同一个组下的每个实例都配置有相同的组ID，被分配不同的订阅分区。当某个实例挂掉的时候，其他实例会自动的承担起该实例负责消费的分区。</li>
</ul>
</li>
<li><p>架构设计与实现</p>
</li>
<li><p>关键词</p>
<ul>
<li>WAL顺序写</li>
<li>元数据管理</li>
</ul>
</li>
<li><p>协议和网络模块</p>
</li>
<li><p>数据存储</p>
<ul>
<li>元数据存储<ul>
<li>目前，kafka使用zk存储集群元数据，进行成员管理、controller选举，以及其他一些管理类任务。</li>
<li><strong>KIP-500</strong>提案之后，kafka将使用社区自研的基于raft的共识算法，替代zk，实现controller自选举。</li>
</ul>
</li>
<li>消息数据存储<ul>
<li>kafka使用WAL(write ahead log)日志来存储消息。</li>
</ul>
</li>
</ul>
</li>
<li><p>生产者与消费者</p>
<ul>
<li>分区分配策略</li>
<li>批量写入</li>
<li>消费者组</li>
</ul>
</li>
<li><p>HTTP协议支持和管控操作</p>
</li>
<li><p>集群构建</p>
</li>
<li><p>数据可靠性</p>
</li>
<li><p>可观测性</p>
</li>
<li><p>如何保证消息有序</p>
</li>
<li><p>关键词</p>
<ul>
<li>WAL</li>
<li>分区内有序</li>
<li>数据不均匀</li>
</ul>
</li>
<li><p>什么场景需要用到有序消息</p>
<ul>
<li>下单场景，产生创建订单消息和完成支付消息，业务上要求<strong>同一个订单</strong>的创建订单消息应该优先于完成支付消息。</li>
</ul>
</li>
<li><p>全局有序使用单分区方案，有消息积压问题</p>
</li>
<li><p>多分区方案，有分区负载均衡问题</p>
<ul>
<li>生产者根据业务特征选取同一个业务id的消息，写入到同一个分区</li>
<li>热点用户的数据写入同一个分区，导致该分区QPS很高，消费者也不一定来得及消费导致消息积压。</li>
<li>正确计算目标分区，解决数据不均匀问题<ul>
<li>类似redis的槽位分配机制</li>
<li>一致性哈希算法</li>
</ul>
</li>
<li>在单分区增加到多分区的时候，消费新分区的消费者在启动的时候，并不是立刻消费，暂停消费一段时间（比如三分钟、三十分钟），等待旧分区积压的消息都消费完成，避免可能的失序问题。</li>
</ul>
</li>
<li><p>使用线程池消费数据时，如何保证消息有序</p>
<ul>
<li>根据业务特征选取同一个业务id的消息组成一组给同一个线程处理。</li>
</ul>
</li>
<li><p>如何解决消息积压</p>
</li>
<li><p>关键词</p>
<ul>
<li>一个分区最多只能有一个消费者</li>
<li>增加分区、创建新Topic</li>
</ul>
</li>
<li><p>分区数大于消费者数量时，增加消费者</p>
</li>
<li><p>增加分区</p>
<ul>
<li>分区数量预估</li>
</ul>
</li>
<li><p>创建新Topic</p>
</li>
<li><p>优化消费者性能</p>
<ul>
<li>消费者使用了分布式锁，考虑能否去掉（同一个业务的消息发送到同一个分区后只会有一个消费者消费）。</li>
<li>消费逻辑降级处理，消息积压时使用快路径，比如使用缓存数据。</li>
<li>异步消费，消费线程拉取一批消息后使用线程池执行消费逻辑。通过批量提交，解决消费者宕机的数据丢失问题。处理逻辑保证幂等，解决重复消费问题。通过异步线程重试或者重新写入Topic，解决部分失败问题，注意重新次数。</li>
</ul>
</li>
<li><p>生产者聚合多条消息，消费者使用批处理。</p>
</li>
<li><p>如何保证消息不丢失</p>
</li>
<li><p>关键词</p>
<ul>
<li>消息写入语义</li>
<li>消费者commit</li>
</ul>
</li>
<li><p>消息丢失发送在哪个阶段</p>
<ul>
<li>生产存储消息<ul>
<li>写入语义控制参数：acks</li>
<li>ISR：指和主分区保持了主从同步的所有从分区。</li>
<li>消息丢失场景：<ul>
<li>批量写入，客户端请求还未发送时，生产者宕机；</li>
<li>acks&#x3D;0，消息发送成功，但是未写入broker时，broker宕机。</li>
<li>acks&#x3D;1，数据写入主分区后，主分区所在broker宕机，数据未同步，发生主分区选举。</li>
<li>acks&#x3D;all，允许unclean选举的情况下，如果ISR中没有任务分区，会选出没有数据的主分区。</li>
<li>acks&#x3D;all，禁用unclean选举，无论主分区还是从分区，数据都只是写入到了机器的PageCache，broker宕机任然可能丢失消息。</li>
</ul>
</li>
<li>刷盘的参数控制</li>
<li>确保发送方一定发了消息<ul>
<li>本地消息表+补偿机制</li>
<li>消息回查</li>
</ul>
</li>
</ul>
</li>
<li>消费消息<ul>
<li>异步消费，未提交offset消费者宕机，或者提交了消费逻辑未执行。</li>
</ul>
</li>
</ul>
</li>
<li><p>如何保证不重复消费</p>
</li>
<li><p>关键词</p>
<ul>
<li><strong>幂等</strong></li>
<li><strong>唯一索引</strong></li>
<li><strong>异步检测</strong></li>
<li><strong>布隆过滤器判断不存在key</strong></li>
<li><strong>redis记录key</strong></li>
</ul>
</li>
<li><p>重复消费的原因</p>
<ul>
<li>生产者重复发送</li>
<li>消费者处理完未提交宕机，重新启动后重新消费。</li>
</ul>
</li>
<li><p>设计幂等的消费逻辑</p>
<ul>
<li>业务表唯一索引<ul>
<li>开启本地事务将业务操作和插入数据到唯一索引两个操作提交，事务提交成功后提交消息。</li>
</ul>
</li>
<li>分库分表情况下（业务表、唯一索引表不在一个数据库）<ul>
<li><strong>异步检测</strong>，定时扫描唯一索引表的状态数据，与业务数据比较。</li>
</ul>
</li>
<li><strong>布隆过滤器 + redis + 唯一索引</strong>：请求成功后将该请求的key记录到数据库唯一索引，再记录到redis或布隆过滤器。<ul>
<li>布隆过滤器判断key不存在，那么处理请求</li>
<li>查询redis是否存在，存在就直接返回，这个请求是重复请求</li>
<li>数据库唯一索引冲突，则是重复请求</li>
</ul>
</li>
</ul>
</li>
<li><p>kafka的高吞吐实现</p>
</li>
<li><p>关键词</p>
<ul>
<li><strong>顺序读写（WAL）</strong></li>
<li><strong>零拷贝(sendfile系统调用)：0次CPU拷贝、2次DMA拷贝，2次上下文切换</strong></li>
<li>Page Cache：避免直接刷盘，同时缓解JVM的GC压力</li>
<li>日志文件与索引文件分段：二分查找、稀疏索引</li>
<li>批量发送</li>
<li>数据压缩</li>
</ul>
</li>
<li><p>kafka性能衰退的原因</p>
<ul>
<li>Topic或者分区太多<ul>
<li>每个分区都有一个日志文件，不同分区之间就不是顺序写了。</li>
<li>减少分区的使用</li>
<li>合并Topic</li>
</ul>
</li>
</ul>
</li>
<li><p>生产消息的批量处理</p>
<ul>
<li>在 Producer 端，如果要改善吞吐量，通常的标配是增加消息批次的大小以及批次缓存时间，即 batch.size 和 linger.ms。</li>
<li>linger.ms固定时间兜底</li>
</ul>
</li>
<li><p>broker的高性能</p>
<ul>
<li>kafka在写数据的时候，一方面基于OS层面的PageCache(os cache)来写数据，所以性能很高。</li>
<li>另一方面，它采用磁盘顺序写的方式，所以即使数据刷入磁盘的时候，性能也是极高的。</li>
<li>零拷贝：从kafka消费数据的时候，数据读取的过程为：<strong>磁盘 -&gt; os cache -&gt; application cache   -&gt;  os socket缓存  -&gt; 网卡</strong>。其中数据从操作系统Cache里拷贝到应用进程的缓存里，接着又从应用程序缓存里拷贝会操作系统的socket缓存里，这两次数据拷贝是没有必要的。零拷贝技术，省略了这两次数据拷贝，数据直接从os Cache发送到网卡。</li>
</ul>
</li>
<li><p>kafka的性能优化</p>
</li>
<li><p>关键词</p>
<ul>
<li>优化生产者、broker、消费者</li>
</ul>
</li>
<li><p>优化生产者</p>
<ul>
<li>acks<ul>
<li>追求性能时acks&#x3D;0或acks&#x3D;1</li>
<li>追求消息不丢失时只能acks&#x3D;all</li>
</ul>
</li>
<li>调大批次<ul>
<li>batch.size不是越大越好，实际项目中压测确定</li>
<li>linger.ms间隔时间</li>
</ul>
</li>
<li>调大buffer.memory缓冲池<ul>
<li>由于Topic或分区数太多时，可能导致缓冲池不够用</li>
</ul>
</li>
<li>压缩<ul>
<li>开启压缩</li>
<li>选择合适的压缩算法</li>
</ul>
</li>
</ul>
</li>
<li><p>优化broker</p>
<ul>
<li>swap<ul>
<li>vm.swappiness参数追求性能调小（默认60，可以调到1-10之间）。</li>
</ul>
</li>
<li>优化网络读写缓冲区<ul>
<li>Socket 默认读写缓冲区大小</li>
<li>Socket 最大读写缓冲区大小</li>
<li>TCP 读写缓冲区</li>
</ul>
</li>
<li>磁盘io<ul>
<li>使用XFS文件系统，提升读写性能。</li>
<li>禁用atime，文件读取不需要修改访问时间属性，提升性能。</li>
</ul>
</li>
<li>主从同步<ul>
<li>num.replica.fetchers：从分区拉取数据的线程数量，默认是 1。可以考虑设置成 3。</li>
<li>replica.fetch.min.bytes：可以通过调大这个参数来避免小批量同步数据。</li>
<li>replica.fetch.max.bytes：这个可以调大，比如说调整到 5m，但是不要小于 message.max.byte，也就是不要小于消息的最大长度。</li>
<li>replica.fetch.wait.max.ms：如果主分区没有数据或者数据不够从分区的最大等待时间，可以考虑同步调大这个值和 replica.fetch.max.bytes。</li>
</ul>
</li>
<li>JVM<ul>
<li>Full GC会影响消息的写入性能，也可能触发重新选主，或影响ISR。</li>
<li>调整堆内存大小（8G-16G），或CMS增大老年代。</li>
<li>或者启用G1垃圾回收器，并设置-XX:MaxGCPauseMillis&#x3D;200，减少停顿时间。</li>
</ul>
</li>
</ul>
</li>
<li><p>优化消费者</p>
<ul>
<li>解决消息积压</li>
</ul>
</li>
<li><p>消息中间件对比</p>
</li>
<li><p>关键词</p>
<ul>
<li>RabbitMQ、RocketMQ、Kafka与Pulsar</li>
<li>数据存储在不同的队列</li>
<li>计算存储分离架构</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/05/28/ElasticSearch-Notes-for-Interview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/05/28/ElasticSearch-Notes-for-Interview/" class="post-title-link" itemprop="url">ElasticSearch Notes for Interview</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-05-28 16:51:37" itemprop="dateCreated datePublished" datetime="2025-05-28T16:51:37+08:00">2025-05-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-01 16:06:56" itemprop="dateModified" datetime="2025-06-01T16:06:56+08:00">2025-06-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/elasticsearch/" itemprop="url" rel="index"><span itemprop="name">elasticsearch</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><p>Es基础知识</p>
</li>
<li><p>关键词</p>
<ul>
<li><p>基于<strong>Lucene</strong>的Restful的分布式实时全文搜索引擎，快速存储、搜索、分析海量数据。</p>
</li>
<li><p><strong>Index</strong>索引：存储数据的地方，类似mysql的表。</p>
</li>
<li><p><strong>document</strong>文档：类似mysql种的一行数据，但是每个文档可以有不同的字段。</p>
</li>
<li><p><strong>field</strong>字段：最小单位。</p>
</li>
<li><p><strong>shard</strong>分片：数据切分为多个shard后可以分布在多台服务器，横向扩展，提升吞吐量和性能。</p>
</li>
<li><p><strong>replica</strong>副本：一个shard可以创建多个replica副本，提供备用服务，提升搜索吞吐量和可用性。</p>
</li>
<li><p><strong>text</strong>与<strong>keyword</strong>：是否分词。</p>
</li>
<li><p><strong>query</strong>与<strong>filter</strong>：是否计算分值。</p>
</li>
</ul>
</li>
<li><p>Es的底层原理</p>
</li>
<li><p>关键词</p>
<ul>
<li><p><strong>倒排索引</strong></p>
</li>
<li><p><strong>前缀树</strong>，也叫做<strong>字典树</strong>（Trie Tree）</p>
</li>
<li><p><strong>refresh</strong>操作</p>
</li>
<li><p><strong>flush</strong>操作</p>
</li>
<li><p><strong>fsync</strong>操作</p>
</li>
</ul>
</li>
<li><p>什么倒排索引</p>
</li>
</ul>
<blockquote>
<p>每个文档都有对应的文档ID，文档内容可以表示为一系列关键词（<strong>Term</strong>）的集合。通过倒排索引，可以记录每个关键词在文档中出现的次数和位置。<br>倒排索引是关键词到文档ID、出现频率、位置的映射（<strong>posting list</strong>），每个关键词都对应一系列的文件，这些文件都出现了该关键词。<br>每个字段是分散统计的，也就是说每个字段都有一个posting list。关键词的查找基于前缀树，也叫做字典树（trie tree），es里面叫做<strong>Term Dictionary</strong>。为了节省内存空间，es对前缀树做了优化，压缩了公共前缀、后缀，就是所谓的<strong>FST（Finite State Transducers）</strong>。</p>
</blockquote>
<ul>
<li>写入数据</li>
</ul>
<p><strong>文档 -&gt; Indexing Buffer -&gt; Page Cache -&gt; 磁盘</strong></p>
<p><strong>Translog -&gt; Page Cache -&gt; 磁盘</strong></p>
<ul>
<li><p>refresh刷新操作将索引缓存写入到 Page Cache，保存为segment段文件，一个段里面包含了多个文档，refresh默认<strong>1秒钟</strong>执行一次，此时文档才能够被检索，这也是称Es为近实时搜索的原因。</p>
</li>
<li><p>Page Cache通过异步刷新（fsync）将数据写入到磁盘文件。</p>
</li>
<li><p>文档写入缓存的时候，同时会记录Translog，默认<strong>5秒钟</strong>固定间隔时间刷新到磁盘。</p>
</li>
<li><p>前缀树</p>
</li>
<li><p>Es怎么保证高可用？</p>
</li>
<li><p>关键词</p>
<ul>
<li><p>Es高可用的核心是<strong>shard</strong>分片与<strong>replica</strong>副本</p>
</li>
<li><p><strong>TransLog</strong>保障数据写入的高可用，避免掉电时的写入丢失</p>
</li>
</ul>
</li>
<li><p>Es高可用的基本保证</p>
</li>
</ul>
<blockquote>
<p>Es高可用的核心是分片，并且每个分片都有主从之分，万一主分片崩溃了，还可以使用从分片，也就是副本分片，从而保证了最基本的可用性。<br>Es在写入数据的过程中，为了保证高性能，都是写入到自己的Buffer里面，后面再刷新到磁盘上。所以为了降低数据丢失的风险，es还额外写了一个Translog，类似于Mysql里的redo log。后面es崩溃之后，可以利用Translog来恢复数据。</p>
</blockquote>
<ul>
<li><p>Es高可用的额外优化</p>
<ul>
<li><p>限流保护节点：插件、网关或代理、客户端限流。</p>
</li>
<li><p>利用消息队列削峰：数据写入数据库，监听binlog，发消息到MQ，消费消息并写入Es。</p>
</li>
<li><p>保护协调节点：使用单一角色；分组与隔离。</p>
</li>
<li><p>双集群部署：消息队列两个消费者双写到AB两个集群。</p>
</li>
</ul>
</li>
<li><p>Es查询性能优化？</p>
</li>
<li><p>关键词</p>
<ul>
<li><p>jvm参数</p>
</li>
<li><p>本地内存优化</p>
</li>
</ul>
</li>
<li><p>高性能方案</p>
<ul>
<li><p>常规方案</p>
<ul>
<li><p>优化垃圾回收</p>
</li>
<li><p>优化swap</p>
</li>
<li><p>文件描述符</p>
</li>
</ul>
</li>
<li><p>优化分页查询</p>
</li>
<li><p>批量提交</p>
</li>
<li><p>调大refresh时间间隔</p>
</li>
<li><p>优化不必要字段</p>
</li>
<li><p>冷热分离</p>
</li>
</ul>
</li>
<li><p>JVM本地内存优化</p>
</li>
</ul>
<p>场景：Elasticsearch 的 Lucene 索引占用大量堆外内存（Off-Heap），配置不当易引发 OOM。</p>
<p>优化方案：</p>
<ul>
<li><p>限制字段数据缓存（fielddata）大小，不超过堆内存的 30%</p>
<ul>
<li>indices.fielddata.cache.size: 30%</li>
</ul>
</li>
<li><p>优化分片（shard）数量</p>
<ul>
<li><p>单个分片大小建议在 10-50GB 之间，<strong>过多分片会增加堆外内存开销</strong>。</p>
</li>
<li><p>例如：100GB 索引，分配 2-5 个分片。</p>
</li>
</ul>
</li>
<li><p>Es的实战应用</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://shimo.im/docs/PJtKVDqYkYXddjgJ">视频图片结构化分析系统</a>使用<strong>ElasticSearch</strong>存储结构化信息支持目标检索功能</p>
<ul>
<li><p>技术选型分析</p>
<ul>
<li><p>需要存储哪些数据：视频分析结果数据（人形、车辆、人脸、骑行等）存储。</p>
</li>
<li><p>支持目标检索</p>
</li>
</ul>
</li>
<li><p>部署架构与高可用：三节点部署集群。</p>
</li>
<li><p>性能优化：Es批量写入、Es使用Kafka异步写入、refresh时间间隔配置修改。</p>
</li>
<li><p>常见问题解决经验</p>
<ul>
<li><p>数据丢失与备份</p>
</li>
<li><p>分页查询（&#x2F;image_result&#x2F;_search?scroll&#x3D;10m）</p>
</li>
<li><p>脑裂问题</p>
</li>
<li><p>中文分词</p>
<ul>
<li><p>ik中文分词器</p>
</li>
<li><p><strong>定制分词器</strong>：结巴分词+公安特征词库（10万+专用词汇）</p>
<ul>
<li>ik分词器的配置文件中<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/468392276">修改远程扩展词典</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2021/05/17/Kafka-In-Action/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/17/Kafka-In-Action/" class="post-title-link" itemprop="url">Kafka In Action</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-05-17 13:12:17 / Modified: 13:19:29" itemprop="dateCreated datePublished" datetime="2021-05-17T13:12:17+08:00">2021-05-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/kafka/" itemprop="url" rel="index"><span itemprop="name">kafka</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="消息引擎系统"><a href="#消息引擎系统" class="headerlink" title="消息引擎系统"></a>消息引擎系统</h1><p><img src="https://uploader.shimo.im/f/GwdoPlAJ7tC6GGpA.png!thumbnail?fileGuid=Ggk3HpKgtRQH3Dh6" alt="Kafka Logo"></p>
<ul>
<li>Apache Kafka 是一款开源的消息引擎系统。</li>
<li>消息引擎系统是一组规范。企业利用这组规范在不同系统之间传递语义准确的消息，实现松耦合的异步式数据传递。</li>
<li>Kafka 是消息引擎系统，也是分布式流处理平台。</li>
</ul>
<h1 id="Kafka-架构"><a href="#Kafka-架构" class="headerlink" title="Kafka 架构"></a>Kafka 架构</h1><p><img src="https://uploader.shimo.im/f/sNIPG7KWTDuxoecr.png!thumbnail?fileGuid=Ggk3HpKgtRQH3Dh6" alt="Kafka Architecture"></p>
<p>设计目标：</p>
<ul>
<li>提供一套 API 实现生产者和消费者；</li>
<li>降低网络传输和磁盘存储开销；</li>
<li>实现高伸缩性架构。</li>
</ul>
<h1 id="Kafka-版本号"><a href="#Kafka-版本号" class="headerlink" title="Kafka 版本号"></a>Kafka 版本号</h1><ul>
<li>0.7 版本:只有基础消息队列功能，无副本；打死也不使用</li>
<li>0.8 版本:增加了副本机制，新的 producer API；建议使用 0.8.2.2 版本；不建议使用 0.8.2.0 之后的 producer API</li>
<li>0.9 版本:增加权限和认证，新的 consumer API，Kafka Connect 功能；不建议使用 consumer API；</li>
<li>0.10 版本:引入 Kafka Streams 功能，bug 修复；建议版本<strong>0.10.2.2</strong>；建议使用新版 consumer API</li>
<li>0.11 版本:producer API 幂等，事务 API，消息格式重构；建议版本 0.11.0.3；谨慎对待消息格式变化</li>
<li>1.0 和 2.0 版本:Kafka Streams 改进；建议版本 2.0；</li>
</ul>
<h1 id="Kafka-的基本使用"><a href="#Kafka-的基本使用" class="headerlink" title="Kafka 的基本使用"></a>Kafka 的基本使用</h1><h2 id="如何做-kafka-线上集群部署方案？"><a href="#如何做-kafka-线上集群部署方案？" class="headerlink" title="如何做 kafka 线上集群部署方案？"></a>如何做 kafka 线上集群部署方案？</h2><p><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/101107">https://time.geekbang.org/column/article/101107</a></p>
<h2 id="集群参数配置"><a href="#集群参数配置" class="headerlink" title="集群参数配置"></a>集群参数配置</h2><ul>
<li>Broker 端参数</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># A comma separated list of directories under which to store log files</span></span><br><span class="line"><span class="attr">log.dirs</span>=<span class="string">/home/kafka1,/home/kafka2,/home/kafka3</span></span><br><span class="line"><span class="comment"># Zookeeper connection string</span></span><br><span class="line"><span class="attr">zookeeper.connect</span>=<span class="string">zk1:2181,zk2:2181,zk3:2181/kafka1</span></span><br><span class="line"><span class="comment"># Timeout in ms for connecting to zookeeper</span></span><br><span class="line"><span class="attr">zookeeper.connection.timeout.ms</span>=<span class="string">18000</span></span><br><span class="line"><span class="comment"># The address the socket server listens on</span></span><br><span class="line"><span class="attr">listeners</span>=<span class="string">PLAINTEXT://:9092</span></span><br><span class="line"><span class="comment"># Hostname and port the broker will advertise</span></span><br><span class="line"><span class="attr">advertised.listeners</span>=<span class="string">PLAINTEXT://:9092</span></span><br><span class="line"><span class="comment"># Log retention settings</span></span><br><span class="line"><span class="attr">log.retention.hours</span>=<span class="string">168</span></span><br><span class="line"><span class="attr">log.retention.ms</span>=<span class="string">15552000000</span></span><br><span class="line"><span class="attr">log.retention.bytes</span>=<span class="string">1073741824</span></span><br><span class="line"><span class="attr">log.segment.bytes</span>=<span class="string">1073741824</span></span><br><span class="line"><span class="attr">log.retention.check.interval.ms</span>=<span class="string">300000</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Topic 参数</li>
</ul>
<p>创建 Topic 时进行设置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-topics.sh \</span><br><span class="line">--bootstrap-server localhost:9092 \</span><br><span class="line">--create \</span><br><span class="line">--topic transaction \</span><br><span class="line">--partitions 1 \</span><br><span class="line">--replication-factor 1 \</span><br><span class="line">--config retention.ms=15552000000 \</span><br><span class="line">--config max.message.bytes=5242880</span><br></pre></td></tr></table></figure>

<p>修改 Topic 时设置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-configs.sh \</span><br><span class="line">--zookeeper localhost:2181 \</span><br><span class="line">--entity-type topics \</span><br><span class="line">--entity-name transaction \</span><br><span class="line">--alter \</span><br><span class="line">--add-config max.message.bytes=10485760</span><br></pre></td></tr></table></figure>

<ul>
<li>JVM 端参数</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> KAFKA_HEAP_OPTS=<span class="string">&quot;--Xms6g --Xmx6g&quot;</span></span><br><span class="line"><span class="built_in">export</span> KAFKA_JVM_PERFORMANCE_OPTS=<span class="string">&quot; \</span></span><br><span class="line"><span class="string">-server \</span></span><br><span class="line"><span class="string">-XX:+UseG1GC \</span></span><br><span class="line"><span class="string">-XX:MaxGCPauseMillis=20 \</span></span><br><span class="line"><span class="string">-XX:InitiatingHeapOccupancyPercent=35 \</span></span><br><span class="line"><span class="string">-XX:+ExplicitGCInvokesConcurrent \</span></span><br><span class="line"><span class="string">-Djava.awt.headless=true&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="无消息丢失配置"><a href="#无消息丢失配置" class="headerlink" title="无消息丢失配置"></a>无消息丢失配置</h2><ol>
<li>不要使用 producer.send(msg)，而要使用 producer.send(msg, callback)。记住，一定要使用带有回调通知的 send 方法。</li>
<li>设置 acks &#x3D; all。acks 是 Producer 的一个参数，代表了你对”已提交”消息的定义。如果设置成 all，则表明所有副本 Broker 都要接收到消息，该消息才算是”已提交”。这是最高等级的”已提交”定义。</li>
<li>设置 retries 为一个较大的值。这里的 retries 同样是 Producer 的参数，对应前面提到的 Producer 自动重试。当出现网络的瞬时抖动时，消息发送可能会失败，此时配置了 retries &gt; 0 的 Producer 能够自动重试消息发送，避免消息丢失。</li>
<li>设置 unclean.leader.election.enable &#x3D; false。这是 Broker 端的参数，它控制的是哪些 Broker 有资格竞选分区的 Leader。</li>
<li>设置 replication.factor &gt;&#x3D; 3。这也是 Broker 端的参数。其实这里想表述的是，最好将消息多保存几份，毕竟目前防止消息丢失的主要机制就是冗余。</li>
<li>设置 min.insync.replicas &gt; 1。这依然是 Broker 端参数，控制的是消息至少要被写入到多少个副本才算是”已提交”。设置成大于 1 可以提升消息持久性。在实际环境中千万不要使用默认值 1。</li>
<li>确保 replication.factor &gt; min.insync.replicas。如果两者相等，那么只要有一个副本挂机，整个分区就无法正常工作了。我们不仅要改善消息的持久性，防止数据丢失，还要在不降低可用性的基础上完成。推荐设置成 replication.factor &#x3D; min.insync.replicas + 1。</li>
<li>确保消息消费完成再提交。Consumer 端有个参数 enable.auto.commit，最好把它设置成 false，并采用手动提交位移的方式。就像前面说的，这对于单 Consumer 多线程处理的场景而言是至关重要的。</li>
</ol>
<h2 id="生产者分区策略"><a href="#生产者分区策略" class="headerlink" title="生产者分区策略"></a>生产者分区策略</h2><h2 id="数据可靠性保证"><a href="#数据可靠性保证" class="headerlink" title="数据可靠性保证"></a>数据可靠性保证</h2><h2 id="消息幂等与事务"><a href="#消息幂等与事务" class="headerlink" title="消息幂等与事务"></a>消息幂等与事务</h2><h2 id="消费者组"><a href="#消费者组" class="headerlink" title="消费者组"></a>消费者组</h2><p><img src="https://uploader.shimo.im/f/jsSjwxqokB6rcxVp.png!thumbnail?fileGuid=Ggk3HpKgtRQH3Dh6" alt="Consumer Group"></p>
<p><strong>rebalance</strong></p>
<ul>
<li>session.timeout.ms</li>
<li>heartbeat.interval.ms</li>
</ul>
<p>要保证 Consumer 实例在被判定为”dead”之前，能够发送至少 3 轮的心跳请求，即 session.timeout.ms &gt;&#x3D; 3 * heartbeat.interval.ms。</p>
<ul>
<li>max.poll.interval.ms</li>
</ul>
<p>This is a safety mechanism which guarantees that only active members of the group are able to commit offsets. So to stay in the group, you must continue to call poll.</p>
<ul>
<li>GC 参数</li>
</ul>
<p>The recommended way to handle these cases is to move message processing to another thread, which allows the consumer to continue calling<code>poll</code>while the processor is still working. Some care must be taken to ensure that committed offsets do not get ahead of the actual position.</p>
<h2 id="位移提交"><a href="#位移提交" class="headerlink" title="位移提交"></a>位移提交</h2><p><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/106904">https://time.geekbang.org/column/article/106904</a></p>
<p><img src="https://uploader.shimo.im/f/1aQ3bQwlOaMxZ7zE.png!thumbnail?fileGuid=Ggk3HpKgtRQH3Dh6" alt="Offset Commit"></p>
<ul>
<li>自动提交</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">enable.auto.commit</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">auto.commit.interval.ms</span>=<span class="string">5000</span></span><br></pre></td></tr></table></figure>

<p>一旦设置了 enable.auto.commit 为 true，Kafka 会保证在开始调用 poll 方法时，提交上次 poll 返回的所有消息。从顺序上来说，poll 方法的逻辑是先提交上一批消息的位移，再处理下一批消息，因此它能保证不出现<strong>消费丢失</strong>的情况。但自动提交位移的一个问题在于，它可能会出现<strong>重复消费</strong>。<br>重复消费发生在 consumer 故障重启后，重新从磁盘读取 commited offset。只要 consumer 没有重启，不会发生重复消费，因为在运行过程中 consumer 会记录已获取的消息位移。</p>
<ul>
<li>手动提交</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 同步阻塞</span></span><br><span class="line">consumer.commitSync()</span><br><span class="line"><span class="comment">// 异步回调</span></span><br><span class="line">consumer.commitAsync(callback)</span><br></pre></td></tr></table></figure>

<p>可同时使用 commitSync() 和 commitAsync()。对于常规性、阶段性的手动提交，我们调用 commitAsync() 避免程序阻塞，而在 Consumer 要关闭前，我们调用 commitSync() 方法执行同步阻塞式的位移提交，以确保 Consumer 关闭前能够保存正确的位移数据。将两者结合后，我们既实现了异步无阻塞式的位移管理，也确保了 Consumer 位移的正确性。<br>比如我程序运行期间有多次异步提交没有成功，比如 101 的 offset 和 201 的 offset 没有提交成功，程序关闭的时候 501 的 offset 提交成功了，就代表前面 500 条还是消费成功了，只要最新的位移提交成功，就代表之前的消息都提交成功了。</p>
<h2 id="消费者组消费进度监控"><a href="#消费者组消费进度监控" class="headerlink" title="消费者组消费进度监控"></a>消费者组消费进度监控</h2><ul>
<li>使用 Kafka 自带的命令行工具 kafka-consumer-groups 脚本。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./kafka-consumer-groups.sh \</span><br><span class="line">--bootstrap-server kafka:9092 \</span><br><span class="line">--describe \</span><br><span class="line">--all-groups</span><br></pre></td></tr></table></figure>

<p><img src="https://uploader.shimo.im/f/Cs83PebnjYOZFDXU.png!thumbnail?fileGuid=Ggk3HpKgtRQH3Dh6" alt="Consumer Groups"></p>
<ul>
<li>使用 Kafka Java Consumer API 编程。</li>
<li>使用 Kafka 自带的 JMX 监控指标。</li>
</ul>
<h1 id="Kafka-的副本机制"><a href="#Kafka-的副本机制" class="headerlink" title="Kafka 的副本机制"></a>Kafka 的副本机制</h1><h1 id="Kafka-请求-Reactor-处理机制"><a href="#Kafka-请求-Reactor-处理机制" class="headerlink" title="Kafka 请求 Reactor 处理机制"></a>Kafka 请求 Reactor 处理机制</h1><p>broker 参数</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The number of threads that the server uses for receiving requests from the network and sending responses to the network</span></span><br><span class="line"><span class="attr">num.network.threads</span>=<span class="string">3</span></span><br><span class="line"><span class="comment"># The number of threads that the server uses for processing requests, which may include disk I/O</span></span><br><span class="line"><span class="attr">num.io.threads</span>=<span class="string">8</span></span><br></pre></td></tr></table></figure>

<p><img src="https://uploader.shimo.im/f/lDRma97OpwXksWpD.png!thumbnail?fileGuid=Ggk3HpKgtRQH3Dh6" alt="Reactor Pattern"></p>
<h1 id="高水位和-Leader-Epoch-机制"><a href="#高水位和-Leader-Epoch-机制" class="headerlink" title="高水位和 Leader Epoch 机制"></a>高水位和 Leader Epoch 机制</h1><p><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/112118">https://time.geekbang.org/column/article/112118</a></p>
<h1 id="管理与监控"><a href="#管理与监控" class="headerlink" title="管理与监控"></a>管理与监控</h1><h2 id="主题日常管理"><a href="#主题日常管理" class="headerlink" title="主题日常管理"></a>主题日常管理</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建主题</span></span><br><span class="line">bin/kafka-topics.sh \</span><br><span class="line">--bootstrap-server broker_host:port \</span><br><span class="line">--create \</span><br><span class="line">--topic my_topic_name \</span><br><span class="line">--partitions 1 \</span><br><span class="line">--replication-factor 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看主题列表</span></span><br><span class="line">bin/kafka-topics.sh \</span><br><span class="line">--bootstrap-server broker_host:port \</span><br><span class="line">--list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看主题详情</span></span><br><span class="line">bin/kafka-topics.sh \</span><br><span class="line">--bootstrap-server broker_host:port \</span><br><span class="line">--describe \</span><br><span class="line">--topic &lt;topic_name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改分区数</span></span><br><span class="line">bin/kafka-topics.sh \</span><br><span class="line">--bootstrap-server broker_host:port \</span><br><span class="line">--alter \</span><br><span class="line">--topic &lt;topic_name&gt; \</span><br><span class="line">--partitions &lt;新分区数&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改主题配置</span></span><br><span class="line">bin/kafka-configs.sh \</span><br><span class="line">--zookeeper zookeeper_host:port \</span><br><span class="line">--entity-type topics \</span><br><span class="line">--entity-name &lt;topic_name&gt; \</span><br><span class="line">--alter \</span><br><span class="line">--add-config max.message.bytes=10485760</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除主题</span></span><br><span class="line">bin/kafka-topics.sh \</span><br><span class="line">--bootstrap-server broker_host:port \</span><br><span class="line">--delete \</span><br><span class="line">--topic &lt;topic_name&gt;</span><br></pre></td></tr></table></figure>

<h2 id="动态参数配置"><a href="#动态参数配置" class="headerlink" title="动态参数配置"></a>动态参数配置</h2><h2 id="kafka-调优"><a href="#kafka-调优" class="headerlink" title="kafka 调优"></a>kafka 调优</h2><p><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/128184">https://time.geekbang.org/column/article/128184</a></p>
<p>OS tuning</p>
<ul>
<li>Virtual Memory</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前配置</span></span><br><span class="line"><span class="built_in">cat</span> /proc/sys/vm/swappiness</span><br><span class="line"><span class="built_in">cat</span> /proc/sys/vm/dirty_background_ratio</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改配置</span></span><br><span class="line">vi /etc/sysctl.conf</span><br><span class="line"><span class="comment"># The percentage of how likely the VM subsystem is to use swap space rather than dropping pages from the page cache.</span></span><br><span class="line">vm.swappiness=1</span><br><span class="line"><span class="comment"># The percentage of the total amount of system memory, and setting this value to 5 is appropriate in many situations.</span></span><br><span class="line">vm.dirty_background_ratio=5</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前状态</span></span><br><span class="line"><span class="built_in">cat</span> /proc/vmstat | egrep <span class="string">&quot;dirty|writeback&quot;</span></span><br><span class="line">nr_dirty 11</span><br><span class="line">nr_writeback 0</span><br><span class="line">nr_writeback_temp 0</span><br><span class="line">nr_dirty_threshold 67635</span><br><span class="line">nr_dirty_background_threshold 33776</span><br></pre></td></tr></table></figure>

<ul>
<li>Disk</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -o noatime</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2021/05/15/Java-Concurrency-Basics/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/15/Java-Concurrency-Basics/" class="post-title-link" itemprop="url">Java Concurrency Basics</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-05-15 13:12:17 / Modified: 13:19:29" itemprop="dateCreated datePublished" datetime="2021-05-15T13:12:17+08:00">2021-05-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Java-Concurrency-Basics"><a href="#Java-Concurrency-Basics" class="headerlink" title="Java Concurrency Basics"></a>Java Concurrency Basics</h1><h2 id="线程基础"><a href="#线程基础" class="headerlink" title="线程基础"></a>线程基础</h2><h3 id="线程的生命周期"><a href="#线程的生命周期" class="headerlink" title="线程的生命周期"></a>线程的生命周期</h3><h3 id="线程的创建方式"><a href="#线程的创建方式" class="headerlink" title="线程的创建方式"></a>线程的创建方式</h3><h3 id="线程的基本操作"><a href="#线程的基本操作" class="headerlink" title="线程的基本操作"></a>线程的基本操作</h3><h2 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h2><h3 id="什么是线程安全"><a href="#什么是线程安全" class="headerlink" title="什么是线程安全"></a>什么是线程安全</h3><h3 id="如何保证线程安全"><a href="#如何保证线程安全" class="headerlink" title="如何保证线程安全"></a>如何保证线程安全</h3><h3 id="原子性、可见性、有序性"><a href="#原子性、可见性、有序性" class="headerlink" title="原子性、可见性、有序性"></a>原子性、可见性、有序性</h3><h2 id="锁机制"><a href="#锁机制" class="headerlink" title="锁机制"></a>锁机制</h2><h3 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a>synchronized</h3><h3 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h3><h3 id="Lock接口"><a href="#Lock接口" class="headerlink" title="Lock接口"></a>Lock接口</h3><h2 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h2><h3 id="线程池的工作原理"><a href="#线程池的工作原理" class="headerlink" title="线程池的工作原理"></a>线程池的工作原理</h3><h3 id="线程池的创建方式"><a href="#线程池的创建方式" class="headerlink" title="线程池的创建方式"></a>线程池的创建方式</h3><h3 id="线程池的参数配置"><a href="#线程池的参数配置" class="headerlink" title="线程池的参数配置"></a>线程池的参数配置</h3><h2 id="并发工具类"><a href="#并发工具类" class="headerlink" title="并发工具类"></a>并发工具类</h2><h3 id="CountDownLatch"><a href="#CountDownLatch" class="headerlink" title="CountDownLatch"></a>CountDownLatch</h3><h3 id="CyclicBarrier"><a href="#CyclicBarrier" class="headerlink" title="CyclicBarrier"></a>CyclicBarrier</h3><h3 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h3><h3 id="Exchanger"><a href="#Exchanger" class="headerlink" title="Exchanger"></a>Exchanger</h3><h2 id="并发集合"><a href="#并发集合" class="headerlink" title="并发集合"></a>并发集合</h2><h3 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a>ConcurrentHashMap</h3><h3 id="CopyOnWriteArrayList"><a href="#CopyOnWriteArrayList" class="headerlink" title="CopyOnWriteArrayList"></a>CopyOnWriteArrayList</h3><h3 id="BlockingQueue"><a href="#BlockingQueue" class="headerlink" title="BlockingQueue"></a>BlockingQueue</h3>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2021/05/15/Multithreading-Programming-Patterns-Guarded-Suspension/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/15/Multithreading-Programming-Patterns-Guarded-Suspension/" class="post-title-link" itemprop="url">Multithreading Programming Patterns - Guarded Suspension</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-05-15 13:12:17 / Modified: 13:19:29" itemprop="dateCreated datePublished" datetime="2021-05-15T13:12:17+08:00">2021-05-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Multithreading-Programming-Patterns-Guarded-Suspension"><a href="#Multithreading-Programming-Patterns-Guarded-Suspension" class="headerlink" title="Multithreading Programming Patterns - Guarded Suspension"></a>Multithreading Programming Patterns - Guarded Suspension</h1><h2 id="Guarded-Suspension-Pattern"><a href="#Guarded-Suspension-Pattern" class="headerlink" title="Guarded Suspension Pattern"></a>Guarded Suspension Pattern</h2><h3 id="什么是Guarded-Suspension模式"><a href="#什么是Guarded-Suspension模式" class="headerlink" title="什么是Guarded Suspension模式"></a>什么是Guarded Suspension模式</h3><h3 id="Guarded-Suspension模式的应用场景"><a href="#Guarded-Suspension模式的应用场景" class="headerlink" title="Guarded Suspension模式的应用场景"></a>Guarded Suspension模式的应用场景</h3><h3 id="Guarded-Suspension模式的实现"><a href="#Guarded-Suspension模式的实现" class="headerlink" title="Guarded Suspension模式的实现"></a>Guarded Suspension模式的实现</h3><h2 id="生产者-消费者模式"><a href="#生产者-消费者模式" class="headerlink" title="生产者-消费者模式"></a>生产者-消费者模式</h2><h3 id="什么是生产者-消费者模式"><a href="#什么是生产者-消费者模式" class="headerlink" title="什么是生产者-消费者模式"></a>什么是生产者-消费者模式</h3><h3 id="生产者-消费者模式的应用场景"><a href="#生产者-消费者模式的应用场景" class="headerlink" title="生产者-消费者模式的应用场景"></a>生产者-消费者模式的应用场景</h3><h3 id="生产者-消费者模式的实现"><a href="#生产者-消费者模式的实现" class="headerlink" title="生产者-消费者模式的实现"></a>生产者-消费者模式的实现</h3><h2 id="线程池模式"><a href="#线程池模式" class="headerlink" title="线程池模式"></a>线程池模式</h2><h3 id="什么是线程池模式"><a href="#什么是线程池模式" class="headerlink" title="什么是线程池模式"></a>什么是线程池模式</h3><h3 id="线程池模式的应用场景"><a href="#线程池模式的应用场景" class="headerlink" title="线程池模式的应用场景"></a>线程池模式的应用场景</h3><h3 id="线程池模式的实现"><a href="#线程池模式的实现" class="headerlink" title="线程池模式的实现"></a>线程池模式的实现</h3><h2 id="读写锁模式"><a href="#读写锁模式" class="headerlink" title="读写锁模式"></a>读写锁模式</h2><h3 id="什么是读写锁模式"><a href="#什么是读写锁模式" class="headerlink" title="什么是读写锁模式"></a>什么是读写锁模式</h3><h3 id="读写锁模式的应用场景"><a href="#读写锁模式的应用场景" class="headerlink" title="读写锁模式的应用场景"></a>读写锁模式的应用场景</h3><h3 id="读写锁模式的实现"><a href="#读写锁模式的实现" class="headerlink" title="读写锁模式的实现"></a>读写锁模式的实现</h3><h2 id="两阶段终止模式"><a href="#两阶段终止模式" class="headerlink" title="两阶段终止模式"></a>两阶段终止模式</h2><h3 id="什么是两阶段终止模式"><a href="#什么是两阶段终止模式" class="headerlink" title="什么是两阶段终止模式"></a>什么是两阶段终止模式</h3><h3 id="两阶段终止模式的应用场景"><a href="#两阶段终止模式的应用场景" class="headerlink" title="两阶段终止模式的应用场景"></a>两阶段终止模式的应用场景</h3><h3 id="两阶段终止模式的实现"><a href="#两阶段终止模式的实现" class="headerlink" title="两阶段终止模式的实现"></a>两阶段终止模式的实现</h3>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Charlie Feng</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
