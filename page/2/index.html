<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"shayne007.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="This place is for thinking and sharing.">
<meta property="og:type" content="website">
<meta property="og:title" content="Charlie Feng&#39;s Tech Space">
<meta property="og:url" content="https://shayne007.github.io/page/2/index.html">
<meta property="og:site_name" content="Charlie Feng&#39;s Tech Space">
<meta property="og:description" content="This place is for thinking and sharing.">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Charlie Feng">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://shayne007.github.io/page/2/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Charlie Feng's Tech Space</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"cdn":false,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.5.0/mermaid.min.js","integrity":"sha256-2obLuIPcceEhkE3G09G33hBdmE55ivVcZUlcKcGNHjU="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>





  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Charlie Feng's Tech Space</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">You will survive with skills</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Charlie Feng</p>
  <div class="site-description" itemprop="description">This place is for thinking and sharing.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">49</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/16/Elasticsearch-Underlying-Principles-Deep-Dive/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/16/Elasticsearch-Underlying-Principles-Deep-Dive/" class="post-title-link" itemprop="url">Elasticsearch Underlying Principles Deep Dive</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-16 16:35:40 / Modified: 16:36:36" itemprop="dateCreated datePublished" datetime="2025-06-16T16:35:40+08:00">2025-06-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/elasticsearch/" itemprop="url" rel="index"><span itemprop="name">elasticsearch</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Understanding-Inverted-Index-The-Heart-of-Search"><a href="#Understanding-Inverted-Index-The-Heart-of-Search" class="headerlink" title="Understanding Inverted Index: The Heart of Search"></a>Understanding Inverted Index: The Heart of Search</h2><p>The inverted index is Elasticsearch’s fundamental data structure that enables lightning-fast full-text search. Unlike a traditional database index that maps record IDs to field values, an inverted index maps each unique term to a list of documents containing that term.</p>
<h3 id="How-Inverted-Index-Works"><a href="#How-Inverted-Index-Works" class="headerlink" title="How Inverted Index Works"></a>How Inverted Index Works</h3><p>Consider a simple example with three documents:</p>
<ul>
<li>Document 1: “The quick brown fox”</li>
<li>Document 2: “The brown dog”</li>
<li>Document 3: “A quick fox jumps”</li>
</ul>
<p>The inverted index would look like:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Term     | Document IDs | Positions</span><br><span class="line">---------|-------------|----------</span><br><span class="line">the      | [1, 2]      | [1:0, 2:0]</span><br><span class="line">quick    | [1, 3]      | [1:1, 3:1]</span><br><span class="line">brown    | [1, 2]      | [1:2, 2:1]</span><br><span class="line">fox      | [1, 3]      | [1:3, 3:2]</span><br><span class="line">dog      | [2]         | [2:2]</span><br><span class="line">a        | [3]         | [3:0]</span><br><span class="line">jumps    | [3]         | [3:3]</span><br></pre></td></tr></table></figure>

<h3 id="Implementation-Details"><a href="#Implementation-Details" class="headerlink" title="Implementation Details"></a>Implementation Details</h3><p>Elasticsearch implements inverted indexes using several sophisticated techniques:</p>
<p><strong>Term Dictionary</strong>: Stores all unique terms in sorted order<br><strong>Posting Lists</strong>: For each term, maintains a list of documents containing that term<br><strong>Term Frequencies</strong>: Tracks how often each term appears in each document<br><strong>Positional Information</strong>: Stores exact positions for phrase queries</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index_options&quot;</span><span class="punctuation">:</span> <span class="string">&quot;positions&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“Can you explain why Elasticsearch is faster than traditional SQL databases for text search?”</em> The answer lies in the inverted index structure - instead of scanning entire documents, Elasticsearch directly maps search terms to relevant documents.</p>
<h2 id="Text-vs-Keyword-Understanding-Field-Types"><a href="#Text-vs-Keyword-Understanding-Field-Types" class="headerlink" title="Text vs Keyword: Understanding Field Types"></a>Text vs Keyword: Understanding Field Types</h2><p>The distinction between Text and Keyword fields is crucial for proper data modeling and search behavior.</p>
<h3 id="Text-Fields"><a href="#Text-Fields" class="headerlink" title="Text Fields"></a>Text Fields</h3><p>Text fields are analyzed - they go through tokenization, normalization, and other transformations:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;product_description&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;keyword&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ignore_above&quot;</span><span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Analysis Process for Text Fields</strong>:</p>
<ol>
<li><strong>Tokenization</strong>: “iPhone 13 Pro Max” → [“iPhone”, “13”, “Pro”, “Max”]</li>
<li><strong>Lowercase Filter</strong>: [“iphone”, “13”, “pro”, “max”]</li>
<li><strong>Stop Words Removal</strong>: (if configured)</li>
<li><strong>Stemming</strong>: (if configured) [“iphon”, “13”, “pro”, “max”]</li>
</ol>
<h3 id="Keyword-Fields"><a href="#Keyword-Fields" class="headerlink" title="Keyword Fields"></a>Keyword Fields</h3><p>Keyword fields are stored as-is, without analysis:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;product_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Use-Cases-Comparison"><a href="#Use-Cases-Comparison" class="headerlink" title="Use Cases Comparison"></a>Use Cases Comparison</h3><table>
<thead>
<tr>
<th>Scenario</th>
<th>Text Field</th>
<th>Keyword Field</th>
</tr>
</thead>
<tbody><tr>
<td>Full-text search</td>
<td>✅ “search iPhone” matches “iPhone 13”</td>
<td>❌ Exact match only</td>
</tr>
<tr>
<td>Aggregations</td>
<td>❌ Analyzed terms cause issues</td>
<td>✅ Perfect for grouping</td>
</tr>
<tr>
<td>Sorting</td>
<td>❌ Unreliable due to analysis</td>
<td>✅ Lexicographic sorting</td>
</tr>
<tr>
<td>Exact matching</td>
<td>❌ “iPhone-13” ≠ “iPhone 13”</td>
<td>✅ “iPhone-13” &#x3D; “iPhone-13”</td>
</tr>
</tbody></table>
<p><strong>Interview Insight</strong>: <em>“When would you use multi-fields?”</em> Multi-fields allow the same data to be indexed in multiple ways - as both text (for search) and keyword (for aggregations and sorting).</p>
<h2 id="Posting-Lists-Trie-Trees-and-FST"><a href="#Posting-Lists-Trie-Trees-and-FST" class="headerlink" title="Posting Lists, Trie Trees, and FST"></a>Posting Lists, Trie Trees, and FST</h2><h3 id="Posting-Lists"><a href="#Posting-Lists" class="headerlink" title="Posting Lists"></a>Posting Lists</h3><p>Posting lists are the core data structure that stores document IDs for each term. Elasticsearch optimizes these lists using several techniques:</p>
<p><strong>Delta Compression</strong>: Instead of storing absolute document IDs, store differences:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Original: [1, 5, 8, 12, 15]</span><br><span class="line">Compressed: [1, +4, +3, +4, +3]</span><br></pre></td></tr></table></figure>

<p><strong>Variable Byte Encoding</strong>: Uses fewer bytes for smaller numbers<br><strong>Skip Lists</strong>: Enable faster intersection operations for AND queries</p>
<h3 id="Trie-Trees-Prefix-Trees"><a href="#Trie-Trees-Prefix-Trees" class="headerlink" title="Trie Trees (Prefix Trees)"></a>Trie Trees (Prefix Trees)</h3><p>Trie trees optimize prefix-based operations and are used in Elasticsearch for:</p>
<ul>
<li>Autocomplete functionality</li>
<li>Wildcard queries</li>
<li>Range queries on terms</li>
</ul>
<pre>
<code class="mermaid">
graph TD
A[Root] --&gt; B[c]
A --&gt; C[s]
B --&gt; D[a]
B --&gt; E[o]
D --&gt; F[r]
D --&gt; G[t]
F --&gt; H[car]
G --&gt; I[cat]
E --&gt; J[o]
J --&gt; K[cool]
C --&gt; L[u]
L --&gt; M[n]
M --&gt; N[sun]
</code>
</pre>

<h3 id="Finite-State-Transducers-FST"><a href="#Finite-State-Transducers-FST" class="headerlink" title="Finite State Transducers (FST)"></a>Finite State Transducers (FST)</h3><p>FST is Elasticsearch’s secret weapon for memory-efficient term dictionaries. It combines the benefits of tries with minimal memory usage.</p>
<p><strong>Benefits of FST</strong>:</p>
<ul>
<li><strong>Memory Efficient</strong>: Shares common prefixes and suffixes</li>
<li><strong>Fast Lookups</strong>: O(k) complexity where k is key length</li>
<li><strong>Ordered Iteration</strong>: Maintains lexicographic order</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;prefix&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;elastics&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“How does Elasticsearch handle memory efficiency for large vocabularies?”</em> FST allows Elasticsearch to store millions of terms using minimal memory by sharing common character sequences.</p>
<h2 id="Data-Writing-Process-in-Elasticsearch-Cluster"><a href="#Data-Writing-Process-in-Elasticsearch-Cluster" class="headerlink" title="Data Writing Process in Elasticsearch Cluster"></a>Data Writing Process in Elasticsearch Cluster</h2><p>Understanding the write path is crucial for optimizing indexing performance and ensuring data durability.</p>
<h3 id="Write-Process-Overview"><a href="#Write-Process-Overview" class="headerlink" title="Write Process Overview"></a>Write Process Overview</h3><pre>
<code class="mermaid">
sequenceDiagram
participant Client
participant Coordinating Node
participant Primary Shard
participant Replica Shard
participant Translog
participant Lucene

Client-&gt;&gt;Coordinating Node: Index Request
Coordinating Node-&gt;&gt;Primary Shard: Route to Primary
Primary Shard-&gt;&gt;Translog: Write to Translog
Primary Shard-&gt;&gt;Lucene: Add to In-Memory Buffer
Primary Shard-&gt;&gt;Replica Shard: Replicate to Replicas
Replica Shard-&gt;&gt;Translog: Write to Translog
Replica Shard-&gt;&gt;Lucene: Add to In-Memory Buffer
Primary Shard-&gt;&gt;Coordinating Node: Success Response
Coordinating Node-&gt;&gt;Client: Acknowledge
</code>
</pre>

<h3 id="Detailed-Write-Steps"><a href="#Detailed-Write-Steps" class="headerlink" title="Detailed Write Steps"></a>Detailed Write Steps</h3><p><strong>Step 1: Document Routing</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shard_id = <span class="built_in">hash</span>(routing_value) % number_of_primary_shards</span><br><span class="line"><span class="comment"># Default routing_value is document _id</span></span><br></pre></td></tr></table></figure>

<p><strong>Step 2: Primary Shard Processing</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;products&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_routing&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user123&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;iPhone 13&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">999</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;electronics&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Step 3: Translog Write</strong><br>The transaction log ensures durability before data reaches disk:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Translog configuration</span></span><br><span class="line">PUT /my_index/_settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;translog&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;sync_interval&quot;</span>: <span class="string">&quot;5s&quot;</span>,</span><br><span class="line">    <span class="string">&quot;durability&quot;</span>: <span class="string">&quot;request&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Step 4: Replication</strong><br>Documents are replicated to replica shards for high availability:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.write.wait_for_active_shards&quot;</span><span class="punctuation">:</span> <span class="string">&quot;all&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Write-Performance-Optimization"><a href="#Write-Performance-Optimization" class="headerlink" title="Write Performance Optimization"></a>Write Performance Optimization</h3><p><strong>Bulk Indexing Best Practices</strong>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;products&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Product 1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;products&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Product 2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Optimal Bulk Size</strong>: 5-15 MB per bulk request<br><strong>Thread Pool Tuning</strong>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">thread_pool:</span></span><br><span class="line">  <span class="attr">write:</span></span><br><span class="line">    <span class="attr">size:</span> <span class="number">8</span></span><br><span class="line">    <span class="attr">queue_size:</span> <span class="number">200</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“How would you optimize Elasticsearch for high write throughput?”</em> Key strategies include bulk indexing, increasing refresh intervals, using appropriate replica counts, and tuning thread pools.</p>
<h2 id="Refresh-Flush-and-Fsync-Operations"><a href="#Refresh-Flush-and-Fsync-Operations" class="headerlink" title="Refresh, Flush, and Fsync Operations"></a>Refresh, Flush, and Fsync Operations</h2><p>These operations manage the transition of data from memory to disk and control search visibility.</p>
<h3 id="Refresh-Operation"><a href="#Refresh-Operation" class="headerlink" title="Refresh Operation"></a>Refresh Operation</h3><p>Refresh makes documents searchable by moving them from the in-memory buffer to the filesystem cache.</p>
<pre>
<code class="mermaid">
graph LR
A[In-Memory Buffer] --&gt;|Refresh| B[Filesystem Cache]
B --&gt;|Flush| C[Disk Segments]
D[Translog] --&gt;|Flush| E[Disk]

subgraph &quot;Search Visible&quot;
    B
    C
end
</code>
</pre>

<p><strong>Refresh Configuration</strong>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30s&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.max_refresh_listeners&quot;</span><span class="punctuation">:</span> <span class="number">1000</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Manual Refresh</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /my_index/_refresh</span><br></pre></td></tr></table></figure>

<p><strong>Real-time Use Case</strong>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /logs/_doc/<span class="number">1</span>?refresh=<span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-01-15T10:30:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ERROR&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Database connection failed&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Flush-Operation"><a href="#Flush-Operation" class="headerlink" title="Flush Operation"></a>Flush Operation</h3><p>Flush persists the translog to disk and creates new Lucene segments.</p>
<p><strong>Flush Triggers</strong>:</p>
<ul>
<li>Translog size exceeds threshold (default: 512MB)</li>
<li>Translog age exceeds threshold (default: 30 minutes)</li>
<li>Manual flush operation</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;translog.flush_threshold_size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1gb&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;translog.sync_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5s&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;translog.durability&quot;</span><span class="punctuation">:</span> <span class="string">&quot;request&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Manual Flush</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /my_index/_flush</span><br><span class="line">POST /_flush?wait_if_ongoing=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="Fsync-Operation"><a href="#Fsync-Operation" class="headerlink" title="Fsync Operation"></a>Fsync Operation</h3><p>Fsync ensures data is physically written to disk storage.</p>
<p><strong>Fsync Configuration</strong>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;translog.durability&quot;</span><span class="punctuation">:</span> <span class="string">&quot;async&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;translog.sync_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5s&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Performance-Impact-Analysis"><a href="#Performance-Impact-Analysis" class="headerlink" title="Performance Impact Analysis"></a>Performance Impact Analysis</h3><table>
<thead>
<tr>
<th>Operation</th>
<th>Frequency</th>
<th>Performance Impact</th>
<th>Data Safety</th>
</tr>
</thead>
<tbody><tr>
<td>Refresh</td>
<td>High (1s default)</td>
<td>Medium</td>
<td>No durability</td>
</tr>
<tr>
<td>Flush</td>
<td>Low (30m or 512MB)</td>
<td>High</td>
<td>Full durability</td>
</tr>
<tr>
<td>Fsync</td>
<td>Configurable</td>
<td>High</td>
<td>Hardware dependent</td>
</tr>
</tbody></table>
<h3 id="Production-Best-Practices"><a href="#Production-Best-Practices" class="headerlink" title="Production Best Practices"></a>Production Best Practices</h3><p><strong>High Throughput Indexing</strong>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;60s&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;translog.durability&quot;</span><span class="punctuation">:</span> <span class="string">&quot;async&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;translog.sync_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30s&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Near Real-time Search</strong>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1s&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;translog.durability&quot;</span><span class="punctuation">:</span> <span class="string">&quot;request&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“Explain the trade-offs between search latency and indexing performance.”</em> Frequent refreshes provide near real-time search but impact indexing throughput. Adjust refresh_interval based on your use case - use longer intervals for high-volume indexing and shorter for real-time requirements.</p>
<h2 id="Advanced-Concepts-and-Optimizations"><a href="#Advanced-Concepts-and-Optimizations" class="headerlink" title="Advanced Concepts and Optimizations"></a>Advanced Concepts and Optimizations</h2><h3 id="Segment-Merging"><a href="#Segment-Merging" class="headerlink" title="Segment Merging"></a>Segment Merging</h3><p>Elasticsearch continuously merges smaller segments into larger ones:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;index.merge.policy.max_merge_at_once&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.merge.policy.segments_per_tier&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.merge.scheduler.max_thread_count&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Force-Merge-for-Read-Only-Indices"><a href="#Force-Merge-for-Read-Only-Indices" class="headerlink" title="Force Merge for Read-Only Indices"></a>Force Merge for Read-Only Indices</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /old_logs/_forcemerge?max_num_segments=1</span><br></pre></td></tr></table></figure>

<h3 id="Circuit-Breakers"><a href="#Circuit-Breakers" class="headerlink" title="Circuit Breakers"></a>Circuit Breakers</h3><p>Prevent OutOfMemory errors during operations:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;persistent&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;indices.breaker.total.limit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;70%&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;indices.breaker.fielddata.limit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;40%&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;indices.breaker.request.limit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30%&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Monitoring-and-Troubleshooting"><a href="#Monitoring-and-Troubleshooting" class="headerlink" title="Monitoring and Troubleshooting"></a>Monitoring and Troubleshooting</h2><h3 id="Key-Metrics-to-Monitor"><a href="#Key-Metrics-to-Monitor" class="headerlink" title="Key Metrics to Monitor"></a>Key Metrics to Monitor</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Index stats</span></span><br><span class="line">GET /_stats/indexing,search,merge,refresh,flush</span><br><span class="line"></span><br><span class="line"><span class="comment"># Segment information</span></span><br><span class="line">GET /my_index/_segments</span><br><span class="line"></span><br><span class="line"><span class="comment"># Translog stats</span></span><br><span class="line">GET /_stats/translog</span><br></pre></td></tr></table></figure>

<h3 id="Common-Issues-and-Solutions"><a href="#Common-Issues-and-Solutions" class="headerlink" title="Common Issues and Solutions"></a>Common Issues and Solutions</h3><p><strong>Slow Indexing</strong>:</p>
<ul>
<li>Check bulk request size</li>
<li>Monitor merge operations</li>
<li>Verify disk I&#x2F;O capacity</li>
</ul>
<p><strong>Memory Issues</strong>:</p>
<ul>
<li>Implement proper mapping</li>
<li>Use appropriate field types</li>
<li>Monitor fielddata usage</li>
</ul>
<p><strong>Search Latency</strong>:</p>
<ul>
<li>Optimize queries</li>
<li>Check segment count</li>
<li>Monitor cache hit rates</li>
</ul>
<h2 id="Interview-Questions-Deep-Dive"><a href="#Interview-Questions-Deep-Dive" class="headerlink" title="Interview Questions Deep Dive"></a>Interview Questions Deep Dive</h2><p><strong>Q: “How does Elasticsearch achieve near real-time search?”</strong><br>A: Through the refresh operation that moves documents from in-memory buffers to searchable filesystem cache, typically every 1 second by default.</p>
<p><strong>Q: “What happens when a primary shard fails during indexing?”</strong><br>A: Elasticsearch promotes a replica shard to primary, replays the translog, and continues operations. The cluster remains functional with potential brief unavailability.</p>
<p><strong>Q: “How would you design an Elasticsearch cluster for a high-write, low-latency application?”</strong><br>A: Focus on horizontal scaling, optimize bulk operations, increase refresh intervals during high-write periods, use appropriate replica counts, and implement proper monitoring.</p>
<p><strong>Q: “Explain the memory implications of text vs keyword fields.”</strong><br>A: Text fields consume more memory during analysis and create larger inverted indexes. Keyword fields are more memory-efficient for exact-match scenarios and aggregations.</p>
<h2 id="External-References"><a href="#External-References" class="headerlink" title="External References"></a>External References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/">Elasticsearch Official Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://lucene.apache.org/core/8_11_0/core/org/apache/lucene/search/similarities/TFIDFSimilarity.html">Lucene Scoring Algorithm</a></li>
<li><a target="_blank" rel="noopener" href="https://citeseerx.ist.psu.edu/document?repid=rep1&type=pdf&doi=10.1.1.24.3698">Finite State Transducers Research Paper</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/tune-for-indexing-speed.html">Elasticsearch Performance Tuning Guide</a></li>
</ul>
<hr>
<p><em>This deep dive covers the fundamental concepts that power Elasticsearch’s search capabilities. Understanding these principles is essential for building scalable, performant search applications and succeeding in technical interviews.</em></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/14/Java-Thread-Pool-Deep-Dive-Production-Best-Practices/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/14/Java-Thread-Pool-Deep-Dive-Production-Best-Practices/" class="post-title-link" itemprop="url">Java Thread Pool Deep Dive: Production Best Practices</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-14 19:23:07 / Modified: 19:24:50" itemprop="dateCreated datePublished" datetime="2025-06-14T19:23:07+08:00">2025-06-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Understanding-Thread-Pools-in-Java"><a href="#Understanding-Thread-Pools-in-Java" class="headerlink" title="Understanding Thread Pools in Java"></a>Understanding Thread Pools in Java</h2><p>A thread pool is a collection of pre-created threads that can be reused to execute multiple tasks, eliminating the overhead of creating and destroying threads for each task. The Java Concurrency API provides robust thread pool implementations through the <code>ExecutorService</code> interface and <code>ThreadPoolExecutor</code> class.</p>
<h3 id="Why-Thread-Pools-Matter"><a href="#Why-Thread-Pools-Matter" class="headerlink" title="Why Thread Pools Matter"></a>Why Thread Pools Matter</h3><p>Thread creation and destruction are expensive operations that can significantly impact application performance. Thread pools solve this by:</p>
<ul>
<li><strong>Resource Management</strong>: Limiting the number of concurrent threads to prevent resource exhaustion</li>
<li><strong>Performance Optimization</strong>: Reusing threads reduces creation&#x2F;destruction overhead</li>
<li><strong>Task Queue Management</strong>: Providing controlled task execution with proper queuing mechanisms</li>
<li><strong>System Stability</strong>: Preventing thread explosion that could crash the application</li>
</ul>
<h2 id="Production-Level-Scenarios-and-Use-Cases"><a href="#Production-Level-Scenarios-and-Use-Cases" class="headerlink" title="Production-Level Scenarios and Use Cases"></a>Production-Level Scenarios and Use Cases</h2><h3 id="High-Volume-Web-Applications"><a href="#High-Volume-Web-Applications" class="headerlink" title="High-Volume Web Applications"></a>High-Volume Web Applications</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// E-commerce order processing system</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderProcessingService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor orderProcessor;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OrderProcessingService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.orderProcessor = <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">            <span class="number">10</span>,  <span class="comment">// corePoolSize: handle normal load</span></span><br><span class="line">            <span class="number">50</span>,  <span class="comment">// maximumPoolSize: handle peak traffic</span></span><br><span class="line">            <span class="number">60L</span>, TimeUnit.SECONDS, <span class="comment">// keepAliveTime</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="number">1000</span>), <span class="comment">// bounded queue</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ThreadFactory</span>() &#123;</span><br><span class="line">                <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">1</span>);</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(Runnable r)</span> &#123;</span><br><span class="line">                    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r, <span class="string">&quot;OrderProcessor-&quot;</span> + counter.getAndIncrement());</span><br><span class="line">                    t.setDaemon(<span class="literal">false</span>); <span class="comment">// Ensure proper shutdown</span></span><br><span class="line">                    <span class="keyword">return</span> t;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy() <span class="comment">// backpressure handling</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;OrderResult&gt; <span class="title function_">processOrder</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// Validate order</span></span><br><span class="line">            validateOrder(order);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Process payment</span></span><br><span class="line">            <span class="type">PaymentResult</span> <span class="variable">paymentResult</span> <span class="operator">=</span> paymentService.processPayment(order);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Update inventory</span></span><br><span class="line">            inventoryService.updateStock(order.getItems());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Send notification</span></span><br><span class="line">            notificationService.sendOrderConfirmation(order);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OrderResult</span>(order.getId(), paymentResult);</span><br><span class="line">        &#125;, orderProcessor);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Batch-Processing-Systems"><a href="#Batch-Processing-Systems" class="headerlink" title="Batch Processing Systems"></a>Batch Processing Systems</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Log analysis system processing millions of log entries</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogAnalysisService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ForkJoinPool forkJoinPool;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor ioThreadPool;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LogAnalysisService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// CPU-intensive tasks: use ForkJoinPool</span></span><br><span class="line">        <span class="built_in">this</span>.forkJoinPool = <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>(</span><br><span class="line">            Runtime.getRuntime().availableProcessors()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// I/O intensive tasks: higher thread count</span></span><br><span class="line">        <span class="built_in">this</span>.ioThreadPool = <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">            <span class="number">20</span>, <span class="comment">// corePoolSize</span></span><br><span class="line">            <span class="number">100</span>, <span class="comment">// maximumPoolSize  </span></span><br><span class="line">            <span class="number">30L</span>, TimeUnit.SECONDS,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">500</span>),</span><br><span class="line">            r -&gt; &#123;</span><br><span class="line">                <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r, <span class="string">&quot;LogIO-Thread&quot;</span>);</span><br><span class="line">                t.setDaemon(<span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processLogFiles</span><span class="params">(List&lt;File&gt; logFiles)</span> &#123;</span><br><span class="line">        <span class="comment">// Parallel processing of log files</span></span><br><span class="line">        logFiles.parallelStream()</span><br><span class="line">            .forEach(file -&gt; &#123;</span><br><span class="line">                CompletableFuture</span><br><span class="line">                    .supplyAsync(() -&gt; readLogFile(file), ioThreadPool)</span><br><span class="line">                    .thenCompose(content -&gt; </span><br><span class="line">                        CompletableFuture.supplyAsync(() -&gt; </span><br><span class="line">                            analyzeContent(content), forkJoinPool))</span><br><span class="line">                    .thenAccept(<span class="built_in">this</span>::storeResults)</span><br><span class="line">                    .exceptionally(throwable -&gt; &#123;</span><br><span class="line">                        logger.error(<span class="string">&quot;Failed to process file: &quot;</span> + file.getName(), throwable);</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Microservices-Communication"><a href="#Microservices-Communication" class="headerlink" title="Microservices Communication"></a>Microservices Communication</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Service-to-service communication with circuit breaker pattern</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExternalServiceClient</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor httpClientPool;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CircuitBreaker circuitBreaker;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ExternalServiceClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.httpClientPool = <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">            <span class="number">5</span>,   <span class="comment">// corePoolSize: minimum connections</span></span><br><span class="line">            <span class="number">20</span>,  <span class="comment">// maximumPoolSize: peak load handling</span></span><br><span class="line">            <span class="number">120L</span>, TimeUnit.SECONDS, <span class="comment">// longer keepAlive for HTTP connections</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;&gt;(), <span class="comment">// direct handoff</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">CustomThreadFactory</span>(<span class="string">&quot;HttpClient&quot;</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.AbortPolicy() <span class="comment">// fail fast on overload</span></span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">this</span>.circuitBreaker = CircuitBreaker.ofDefaults(<span class="string">&quot;externalService&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;ApiResponse&gt; <span class="title function_">callExternalService</span><span class="params">(ApiRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.supplyAsync(() -&gt; </span><br><span class="line">            circuitBreaker.executeSupplier(() -&gt; &#123;</span><br><span class="line">                <span class="comment">// HTTP call with timeout</span></span><br><span class="line">                <span class="keyword">return</span> httpClient.call(request);</span><br><span class="line">            &#125;), httpClientPool</span><br><span class="line">        ).orTimeout(<span class="number">5</span>, TimeUnit.SECONDS)</span><br><span class="line">         .exceptionally(throwable -&gt; &#123;</span><br><span class="line">             <span class="comment">// Fallback mechanism</span></span><br><span class="line">             <span class="keyword">return</span> handleServiceFailure(request, throwable);</span><br><span class="line">         &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Core-ThreadPoolExecutor-Parameters"><a href="#Core-ThreadPoolExecutor-Parameters" class="headerlink" title="Core ThreadPoolExecutor Parameters"></a>Core ThreadPoolExecutor Parameters</h2><p>Understanding these parameters is crucial for optimal thread pool configuration:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ThreadPoolExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">    <span class="type">int</span> corePoolSize,           <span class="comment">// Core threads always alive</span></span><br><span class="line">    <span class="type">int</span> maximumPoolSize,        <span class="comment">// Maximum threads allowed</span></span><br><span class="line">    <span class="type">long</span> keepAliveTime,         <span class="comment">// Idle thread timeout</span></span><br><span class="line">    TimeUnit unit,              <span class="comment">// Time unit for keepAliveTime</span></span><br><span class="line">    BlockingQueue&lt;Runnable&gt; workQueue,  <span class="comment">// Task queue</span></span><br><span class="line">    ThreadFactory threadFactory,        <span class="comment">// Thread creation</span></span><br><span class="line">    RejectedExecutionHandler handler    <span class="comment">// Rejection policy</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="Parameter-Deep-Dive"><a href="#Parameter-Deep-Dive" class="headerlink" title="Parameter Deep Dive"></a>Parameter Deep Dive</h3><p><strong>corePoolSize</strong>: The number of threads that remain alive even when idle. These threads are created on-demand as tasks arrive.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Example: Web server handling typical load</span></span><br><span class="line"><span class="type">int</span> <span class="variable">corePoolSize</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors() * <span class="number">2</span>;</span><br><span class="line"><span class="comment">// For CPU-bound: cores * 1</span></span><br><span class="line"><span class="comment">// For I/O-bound: cores * 2-4</span></span><br><span class="line"><span class="comment">// For mixed workload: cores * 1.5-2</span></span><br></pre></td></tr></table></figure>

<p><strong>maximumPoolSize</strong>: Maximum number of threads. Additional threads are created when the queue is full and more tasks arrive.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Calculate based on memory constraints</span></span><br><span class="line"><span class="type">long</span> <span class="variable">maxMemory</span> <span class="operator">=</span> Runtime.getRuntime().maxMemory();</span><br><span class="line"><span class="type">long</span> <span class="variable">threadStackSize</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">1024</span>; <span class="comment">// 1MB per thread (typical)</span></span><br><span class="line"><span class="type">int</span> <span class="variable">maxThreadsByMemory</span> <span class="operator">=</span> (<span class="type">int</span>) (maxMemory * <span class="number">0.1</span> / threadStackSize);</span><br><span class="line"><span class="type">int</span> <span class="variable">maximumPoolSize</span> <span class="operator">=</span> Math.min(maxThreadsByMemory, <span class="number">200</span>); <span class="comment">// Cap at 200</span></span><br></pre></td></tr></table></figure>

<p><strong>keepAliveTime</strong>: How long excess threads (above core size) remain idle before termination.</p>
<p><strong>workQueue</strong>: The queue implementation significantly impacts behavior:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Different queue types for different scenarios</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. Direct handoff - no queuing, immediate thread creation</span></span><br><span class="line">BlockingQueue&lt;Runnable&gt; directQueue = <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. Bounded queue - prevents memory exhaustion</span></span><br><span class="line">BlockingQueue&lt;Runnable&gt; boundedQueue = <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. Unbounded queue - unlimited queuing (risk of OutOfMemoryError)</span></span><br><span class="line">BlockingQueue&lt;Runnable&gt; unboundedQueue = <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. Priority queue - task prioritization</span></span><br><span class="line">BlockingQueue&lt;Runnable&gt; priorityQueue = <span class="keyword">new</span> <span class="title class_">PriorityBlockingQueue</span>&lt;&gt;(<span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<h2 id="Thread-Pool-Execution-Workflow"><a href="#Thread-Pool-Execution-Workflow" class="headerlink" title="Thread Pool Execution Workflow"></a>Thread Pool Execution Workflow</h2><pre>
<code class="mermaid">
flowchart
A[Task Submitted] --&gt; B{Core Pool Full?}
B --&gt;|No| C[Create New Core Thread]
C --&gt; D[Execute Task]
B --&gt;|Yes| E{Queue Full?}
E --&gt;|No| F[Add Task to Queue]
F --&gt; G[Core Thread Picks Task]
G --&gt; D
E --&gt;|Yes| H{Max Pool Reached?}
H --&gt;|No| I[Create Non-Core Thread]
I --&gt; D
H --&gt;|Yes| J[Apply Rejection Policy]
J --&gt; K[Reject&#x2F;Execute&#x2F;Discard&#x2F;Caller Runs]

D --&gt; L{More Tasks in Queue?}
L --&gt;|Yes| M[Pick Next Task]
M --&gt; D
L --&gt;|No| N{Non-Core Thread?}
N --&gt;|Yes| O{Keep Alive Expired?}
O --&gt;|Yes| P[Terminate Thread]
O --&gt;|No| Q[Wait for Task]
Q --&gt; L
N --&gt;|No| Q
</code>
</pre>

<h3 id="Internal-Mechanism-Details"><a href="#Internal-Mechanism-Details" class="headerlink" title="Internal Mechanism Details"></a>Internal Mechanism Details</h3><p>The <code>ThreadPoolExecutor</code> maintains several internal data structures:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolExecutorInternals</span> &#123;</span><br><span class="line">    <span class="comment">// Simplified view of internal state</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">ctl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(ctlOf(RUNNING, <span class="number">0</span>));</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; workQueue;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;Worker&gt; workers = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Worker&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">termination</span> <span class="operator">=</span> mainLock.newCondition();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Worker thread wrapper</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Worker</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueuedSynchronizer</span> </span><br><span class="line">                                <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Thread thread;</span><br><span class="line">        Runnable firstTask;</span><br><span class="line">        <span class="keyword">volatile</span> <span class="type">long</span> completedTasks;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            runWorker(<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Main worker loop</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">runWorker</span><span class="params">(Worker w)</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">wt</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> w.firstTask;</span><br><span class="line">        w.firstTask = <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (task != <span class="literal">null</span> || (task = getTask()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                w.lock();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    beforeExecute(wt, task);</span><br><span class="line">                    task.run();</span><br><span class="line">                    afterExecute(task, <span class="literal">null</span>);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    task = <span class="literal">null</span>;</span><br><span class="line">                    w.completedTasks++;</span><br><span class="line">                    w.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            processWorkerExit(w, completedAbruptly);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Thread-Pool-Optimization-Strategies"><a href="#Thread-Pool-Optimization-Strategies" class="headerlink" title="Thread Pool Optimization Strategies"></a>Thread Pool Optimization Strategies</h2><h3 id="Determining-Optimal-Core-Thread-Count"><a href="#Determining-Optimal-Core-Thread-Count" class="headerlink" title="Determining Optimal Core Thread Count"></a>Determining Optimal Core Thread Count</h3><p>The optimal thread count depends on workload characteristics:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolOptimizer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">calculateOptimalCoreSize</span><span class="params">(WorkloadType workloadType)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">availableProcessors</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span> (workloadType) &#123;</span><br><span class="line">            <span class="keyword">case</span> CPU_BOUND:</span><br><span class="line">                <span class="comment">// CPU-bound: cores + 1 (to handle occasional I/O)</span></span><br><span class="line">                <span class="keyword">return</span> availableProcessors + <span class="number">1</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> IO_BOUND:</span><br><span class="line">                <span class="comment">// I/O-bound: cores * target utilization / (1 - blocking factor)</span></span><br><span class="line">                <span class="comment">// blocking factor: 0.9 (90% waiting), utilization: 0.8</span></span><br><span class="line">                <span class="keyword">return</span> (<span class="type">int</span>) (availableProcessors * <span class="number">0.8</span> / (<span class="number">1</span> - <span class="number">0.9</span>));</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> MIXED:</span><br><span class="line">                <span class="comment">// Mixed workload: balanced approach</span></span><br><span class="line">                <span class="keyword">return</span> availableProcessors * <span class="number">2</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> DATABASE_OPERATIONS:</span><br><span class="line">                <span class="comment">// Database connection pool size consideration</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">dbConnectionPoolSize</span> <span class="operator">=</span> getDbConnectionPoolSize();</span><br><span class="line">                <span class="keyword">return</span> Math.min(availableProcessors * <span class="number">4</span>, dbConnectionPoolSize);</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> availableProcessors;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Dynamic sizing based on system metrics</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">adjustThreadPoolSize</span><span class="params">(ThreadPoolExecutor executor)</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolStats</span> <span class="variable">stats</span> <span class="operator">=</span> getThreadPoolStats(executor);</span><br><span class="line">        <span class="type">SystemMetrics</span> <span class="variable">systemMetrics</span> <span class="operator">=</span> getSystemMetrics();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (stats.getAverageQueueSize() &gt; <span class="number">100</span> &amp;&amp; </span><br><span class="line">            systemMetrics.getCpuUsage() &lt; <span class="number">0.7</span> &amp;&amp;</span><br><span class="line">            systemMetrics.getMemoryUsage() &lt; <span class="number">0.8</span>) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Increase core size if queue is growing and resources available</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">newCoreSize</span> <span class="operator">=</span> Math.min(</span><br><span class="line">                executor.getCorePoolSize() + <span class="number">2</span>,</span><br><span class="line">                executor.getMaximumPoolSize()</span><br><span class="line">            );</span><br><span class="line">            executor.setCorePoolSize(newCoreSize);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (stats.getAverageActiveThreads() &lt; executor.getCorePoolSize() * <span class="number">0.5</span>) &#123;</span><br><span class="line">            <span class="comment">// Decrease core size if consistently underutilized</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">newCoreSize</span> <span class="operator">=</span> Math.max(</span><br><span class="line">                executor.getCorePoolSize() - <span class="number">1</span>,</span><br><span class="line">                <span class="number">1</span> <span class="comment">// Minimum one thread</span></span><br><span class="line">            );</span><br><span class="line">            executor.setCorePoolSize(newCoreSize);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Performance-Monitoring-and-Tuning"><a href="#Performance-Monitoring-and-Tuning" class="headerlink" title="Performance Monitoring and Tuning"></a>Performance Monitoring and Tuning</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolMonitor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">monitorThreadPool</span><span class="params">(String poolName, ThreadPoolExecutor executor)</span> &#123;</span><br><span class="line">        <span class="comment">// Register metrics</span></span><br><span class="line">        Gauge.builder(<span class="string">&quot;threadpool.core.size&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;pool&quot;</span>, poolName)</span><br><span class="line">            .register(meterRegistry, executor, ThreadPoolExecutor::getCorePoolSize);</span><br><span class="line">            </span><br><span class="line">        Gauge.builder(<span class="string">&quot;threadpool.active.threads&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;pool&quot;</span>, poolName)</span><br><span class="line">            .register(meterRegistry, executor, ThreadPoolExecutor::getActiveCount);</span><br><span class="line">            </span><br><span class="line">        Gauge.builder(<span class="string">&quot;threadpool.queue.size&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;pool&quot;</span>, poolName)</span><br><span class="line">            .register(meterRegistry, executor, e -&gt; e.getQueue().size());</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// Custom monitoring</span></span><br><span class="line">        <span class="type">ScheduledExecutorService</span> <span class="variable">monitor</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line">        monitor.scheduleAtFixedRate(() -&gt; &#123;</span><br><span class="line">            logThreadPoolStats(poolName, executor);</span><br><span class="line">            checkForBottlenecks(executor);</span><br><span class="line">        &#125;, <span class="number">0</span>, <span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkForBottlenecks</span><span class="params">(ThreadPoolExecutor executor)</span> &#123;</span><br><span class="line">        <span class="type">double</span> <span class="variable">queueUtilization</span> <span class="operator">=</span> (<span class="type">double</span>) executor.getQueue().size() / <span class="number">1000</span>; <span class="comment">// assume capacity 1000</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">threadUtilization</span> <span class="operator">=</span> (<span class="type">double</span>) executor.getActiveCount() / executor.getMaximumPoolSize();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (queueUtilization &gt; <span class="number">0.8</span>) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;Thread pool queue utilization high: &#123;&#125;%&quot;</span>, queueUtilization * <span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (threadUtilization &gt; <span class="number">0.9</span>) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;Thread pool utilization high: &#123;&#125;%&quot;</span>, threadUtilization * <span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check for thread starvation</span></span><br><span class="line">        <span class="keyword">if</span> (executor.getActiveCount() == executor.getMaximumPoolSize() &amp;&amp; </span><br><span class="line">            executor.getQueue().size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;Potential thread starvation detected!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Production-Best-Practices"><a href="#Production-Best-Practices" class="headerlink" title="Production Best Practices"></a>Production Best Practices</h2><h3 id="Proper-Thread-Pool-Configuration"><a href="#Proper-Thread-Pool-Configuration" class="headerlink" title="Proper Thread Pool Configuration"></a>Proper Thread Pool Configuration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolConfiguration</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean(name = &quot;taskExecutor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title function_">taskExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Core configuration</span></span><br><span class="line">        executor.setCorePoolSize(<span class="number">10</span>);</span><br><span class="line">        executor.setMaxPoolSize(<span class="number">50</span>);</span><br><span class="line">        executor.setQueueCapacity(<span class="number">1000</span>);</span><br><span class="line">        executor.setKeepAliveSeconds(<span class="number">60</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Thread naming for debugging</span></span><br><span class="line">        executor.setThreadNamePrefix(<span class="string">&quot;AsyncTask-&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Graceful shutdown</span></span><br><span class="line">        executor.setWaitForTasksToCompleteOnShutdown(<span class="literal">true</span>);</span><br><span class="line">        executor.setAwaitTerminationSeconds(<span class="number">30</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Rejection policy</span></span><br><span class="line">        executor.setRejectedExecutionHandler(<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());</span><br><span class="line">        </span><br><span class="line">        executor.initialize();</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="keyword">public</span> ThreadPoolExecutor <span class="title function_">customThreadPool</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">            calculateCorePoolSize(),</span><br><span class="line">            calculateMaxPoolSize(),</span><br><span class="line">            <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="number">2000</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">CustomThreadFactory</span>(<span class="string">&quot;CustomPool&quot;</span>),</span><br><span class="line">            (r, executor) -&gt; &#123;</span><br><span class="line">                <span class="comment">// Custom rejection handling with metrics</span></span><br><span class="line">                rejectionCounter.increment();</span><br><span class="line">                logger.warn(<span class="string">&quot;Task rejected, queue size: &#123;&#125;, active threads: &#123;&#125;&quot;</span>, </span><br><span class="line">                    executor.getQueue().size(), executor.getActiveCount());</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Fallback: try to execute in caller thread</span></span><br><span class="line">                <span class="keyword">if</span> (!executor.isShutdown()) &#123;</span><br><span class="line">                    r.run();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Error-Handling-and-Recovery"><a href="#Error-Handling-and-Recovery" class="headerlink" title="Error Handling and Recovery"></a>Error Handling and Recovery</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RobustTaskExecution</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; CompletableFuture&lt;T&gt; <span class="title function_">executeWithRetry</span><span class="params">(</span></span><br><span class="line"><span class="params">            Supplier&lt;T&gt; task, </span></span><br><span class="line"><span class="params">            ThreadPoolExecutor executor,</span></span><br><span class="line"><span class="params">            <span class="type">int</span> maxRetries)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="type">Exception</span> <span class="variable">lastException</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">attempt</span> <span class="operator">=</span> <span class="number">1</span>; attempt &lt;= maxRetries; attempt++) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> task.get();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    lastException = e;</span><br><span class="line">                    logger.warn(<span class="string">&quot;Task attempt &#123;&#125; failed&quot;</span>, attempt, e);</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (attempt &lt; maxRetries) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="comment">// Exponential backoff</span></span><br><span class="line">                            Thread.sleep(<span class="number">1000</span> * (<span class="type">long</span>) Math.pow(<span class="number">2</span>, attempt - <span class="number">1</span>));</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">                            Thread.currentThread().interrupt();</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Task interrupted&quot;</span>, ie);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Task failed after &quot;</span> + maxRetries + <span class="string">&quot; attempts&quot;</span>, lastException);</span><br><span class="line">        &#125;, executor);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleUncaughtExceptions</span><span class="params">(ThreadPoolExecutor executor)</span> &#123;</span><br><span class="line">        <span class="comment">// Override afterExecute to handle exceptions</span></span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">customExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">            executor.getCorePoolSize(),</span><br><span class="line">            executor.getMaximumPoolSize(),</span><br><span class="line">            executor.getKeepAliveTime(TimeUnit.SECONDS),</span><br><span class="line">            TimeUnit.SECONDS,</span><br><span class="line">            executor.getQueue()</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterExecute</span><span class="params">(Runnable r, Throwable t)</span> &#123;</span><br><span class="line">                <span class="built_in">super</span>.afterExecute(r, t);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (t != <span class="literal">null</span>) &#123;</span><br><span class="line">                    logger.error(<span class="string">&quot;Task execution failed&quot;</span>, t);</span><br><span class="line">                    <span class="comment">// Custom error handling - alerting, recovery, etc.</span></span><br><span class="line">                    handleTaskFailure(r, t);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Extract exception from Future if needed</span></span><br><span class="line">                <span class="keyword">if</span> (t == <span class="literal">null</span> &amp;&amp; r <span class="keyword">instanceof</span> Future&lt;?&gt;) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        ((Future&lt;?&gt;) r).get();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (ExecutionException ee) &#123;</span><br><span class="line">                        t = ee.getCause();</span><br><span class="line">                        logger.error(<span class="string">&quot;Future task failed&quot;</span>, t);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">                        Thread.currentThread().interrupt();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Graceful-Shutdown-Implementation"><a href="#Graceful-Shutdown-Implementation" class="headerlink" title="Graceful Shutdown Implementation"></a>Graceful Shutdown Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolLifecycleManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PreDestroy</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span> &#123;</span><br><span class="line">        shutdownExecutor(orderProcessingExecutor, <span class="string">&quot;OrderProcessing&quot;</span>, <span class="number">30</span>);</span><br><span class="line">        shutdownExecutor(emailExecutor, <span class="string">&quot;Email&quot;</span>, <span class="number">10</span>);</span><br><span class="line">        shutdownExecutor(backgroundTaskExecutor, <span class="string">&quot;BackgroundTask&quot;</span>, <span class="number">60</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">shutdownExecutor</span><span class="params">(ExecutorService executor, String name, <span class="type">int</span> timeoutSeconds)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;Shutting down &#123;&#125; thread pool&quot;</span>, name);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Disable new task submission</span></span><br><span class="line">        executor.shutdown();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Wait for existing tasks to complete</span></span><br><span class="line">            <span class="keyword">if</span> (!executor.awaitTermination(timeoutSeconds, TimeUnit.SECONDS)) &#123;</span><br><span class="line">                logger.warn(<span class="string">&quot;&#123;&#125; thread pool did not terminate gracefully, forcing shutdown&quot;</span>, name);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Cancel currently executing tasks</span></span><br><span class="line">                List&lt;Runnable&gt; droppedTasks = executor.shutdownNow();</span><br><span class="line">                logger.warn(<span class="string">&quot;Dropped &#123;&#125; tasks from &#123;&#125; thread pool&quot;</span>, droppedTasks.size(), name);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Wait a bit more</span></span><br><span class="line">                <span class="keyword">if</span> (!executor.awaitTermination(<span class="number">5</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">                    logger.error(<span class="string">&quot;&#123;&#125; thread pool did not terminate after forced shutdown&quot;</span>, name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;&#123;&#125; thread pool terminated gracefully&quot;</span>, name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;Shutdown interrupted for &#123;&#125; thread pool&quot;</span>, name);</span><br><span class="line">            executor.shutdownNow();</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Interview-Questions-and-Key-Insights"><a href="#Interview-Questions-and-Key-Insights" class="headerlink" title="Interview Questions and Key Insights"></a>Interview Questions and Key Insights</h2><h3 id="Core-Concepts-Questions"><a href="#Core-Concepts-Questions" class="headerlink" title="Core Concepts Questions"></a>Core Concepts Questions</h3><p><strong>Q: What happens when a ThreadPoolExecutor receives a task?</strong></p>
<p>The execution follows a specific workflow:</p>
<ol>
<li>If core threads &lt; corePoolSize, create a new core thread</li>
<li>If core pool is full, add task to queue</li>
<li>If queue is full and threads &lt; maximumPoolSize, create non-core thread</li>
<li>If max pool size reached, apply rejection policy</li>
</ol>
<p><strong>Q: Explain the difference between submit() and execute() methods.</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// execute() - fire and forget, no return value</span></span><br><span class="line">executor.execute(() -&gt; System.out.println(<span class="string">&quot;Task executed&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// submit() - returns Future for result/exception handling</span></span><br><span class="line">Future&lt;?&gt; future = executor.submit(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Task result&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">CompletableFuture&lt;String&gt; completableFuture = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Async result&quot;</span>;</span><br><span class="line">&#125;, executor);</span><br></pre></td></tr></table></figure>

<p><strong>Q: How do you handle thread pool saturation?</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. Proper sizing</span></span><br><span class="line"><span class="type">int</span> <span class="variable">optimalSize</span> <span class="operator">=</span> availableProcessors * (<span class="number">1</span> + waitTime/serviceTime);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. Bounded queues to provide backpressure</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. Appropriate rejection policies</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy(); <span class="comment">// Backpressure</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.AbortPolicy();      <span class="comment">// Fail fast</span></span><br></pre></td></tr></table></figure>

<h3 id="Advanced-Scenarios"><a href="#Advanced-Scenarios" class="headerlink" title="Advanced Scenarios"></a>Advanced Scenarios</h3><p><strong>Q: How would you implement a thread pool that can handle both CPU-intensive and I&#x2F;O-intensive tasks?</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HybridThreadPoolManager</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor cpuPool;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor ioPool;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HybridThreadPoolManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// CPU pool: cores + 1</span></span><br><span class="line">        <span class="built_in">this</span>.cpuPool = <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">            Runtime.getRuntime().availableProcessors() + <span class="number">1</span>,</span><br><span class="line">            Runtime.getRuntime().availableProcessors() + <span class="number">1</span>,</span><br><span class="line">            <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// I/O pool: higher thread count</span></span><br><span class="line">        <span class="built_in">this</span>.ioPool = <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">            <span class="number">20</span>, <span class="number">100</span>, <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">500</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; CompletableFuture&lt;T&gt; <span class="title function_">executeTask</span><span class="params">(TaskType type, Supplier&lt;T&gt; task)</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> (type == TaskType.CPU_BOUND) ? cpuPool : ioPool;</span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.supplyAsync(task, executor);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Thread-Pool-State-Diagram"><a href="#Thread-Pool-State-Diagram" class="headerlink" title="Thread Pool State Diagram"></a>Thread Pool State Diagram</h2><pre>
<code class="mermaid">
stateDiagram-v2
[*] --&gt; RUNNING: new ThreadPoolExecutor()
RUNNING --&gt; SHUTDOWN: shutdown()
RUNNING --&gt; STOP: shutdownNow()
SHUTDOWN --&gt; TIDYING: All tasks completed
STOP --&gt; TIDYING: All tasks completed
TIDYING --&gt; TERMINATED: terminated() hook completed
TERMINATED --&gt; [*]

state RUNNING {
    [*] --&gt; Accepting_Tasks
    Accepting_Tasks --&gt; Executing_Tasks: Task submitted
    Executing_Tasks --&gt; Accepting_Tasks: Task completed
}

state SHUTDOWN {
    [*] --&gt; No_New_Tasks
    No_New_Tasks --&gt; Finishing_Tasks: Complete existing
}
</code>
</pre>

<h2 id="Advanced-Patterns-and-Techniques"><a href="#Advanced-Patterns-and-Techniques" class="headerlink" title="Advanced Patterns and Techniques"></a>Advanced Patterns and Techniques</h2><h3 id="Custom-Thread-Pool-Implementation"><a href="#Custom-Thread-Pool-Implementation" class="headerlink" title="Custom Thread Pool Implementation"></a>Custom Thread Pool Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AdaptiveThreadPool</span> <span class="keyword">extends</span> <span class="title class_">ThreadPoolExecutor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">totalTasks</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">totalTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">double</span> <span class="variable">averageTaskTime</span> <span class="operator">=</span> <span class="number">0.0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AdaptiveThreadPool</span><span class="params">(<span class="type">int</span> corePoolSize, <span class="type">int</span> maximumPoolSize)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(corePoolSize, maximumPoolSize, <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">              <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;(), <span class="keyword">new</span> <span class="title class_">AdaptiveThreadFactory</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeExecute</span><span class="params">(Thread t, Runnable r)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.beforeExecute(t, r);</span><br><span class="line">        <span class="comment">// Mark start time</span></span><br><span class="line">        TASK_START_TIME.set(System.nanoTime());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterExecute</span><span class="params">(Runnable r, Throwable t)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.afterExecute(r, t);</span><br><span class="line">        </span><br><span class="line">        <span class="type">long</span> <span class="variable">duration</span> <span class="operator">=</span> System.nanoTime() - TASK_START_TIME.get();</span><br><span class="line">        totalTasks.incrementAndGet();</span><br><span class="line">        totalTime.addAndGet(duration);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Update average task time</span></span><br><span class="line">        averageTaskTime = (<span class="type">double</span>) totalTime.get() / totalTasks.get();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Adaptive sizing based on task duration and queue size</span></span><br><span class="line">        adaptPoolSize();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">adaptPoolSize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">queueSize</span> <span class="operator">=</span> getQueue().size();</span><br><span class="line">        <span class="type">int</span> <span class="variable">activeThreads</span> <span class="operator">=</span> getActiveCount();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// If queue is growing and tasks are I/O bound (long duration)</span></span><br><span class="line">        <span class="keyword">if</span> (queueSize &gt; <span class="number">10</span> &amp;&amp; averageTaskTime &gt; <span class="number">100_000_000</span>) &#123; <span class="comment">// 100ms</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">newCoreSize</span> <span class="operator">=</span> Math.min(getCorePoolSize() + <span class="number">1</span>, getMaximumPoolSize());</span><br><span class="line">            setCorePoolSize(newCoreSize);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// If threads are idle and few tasks in queue</span></span><br><span class="line">        <span class="keyword">if</span> (queueSize &lt; <span class="number">5</span> &amp;&amp; activeThreads &lt; getCorePoolSize() / <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">newCoreSize</span> <span class="operator">=</span> Math.max(getCorePoolSize() - <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">            setCorePoolSize(newCoreSize);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Long&gt; TASK_START_TIME = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Integration-with-Spring-Framework"><a href="#Integration-with-Spring-Framework" class="headerlink" title="Integration with Spring Framework"></a>Integration with Spring Framework</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncConfiguration</span> <span class="keyword">implements</span> <span class="title class_">AsyncConfigurer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Executor <span class="title function_">getAsyncExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">        executor.setCorePoolSize(<span class="number">10</span>);</span><br><span class="line">        executor.setMaxPoolSize(<span class="number">100</span>);</span><br><span class="line">        executor.setQueueCapacity(<span class="number">500</span>);</span><br><span class="line">        executor.setThreadNamePrefix(<span class="string">&quot;Async-&quot;</span>);</span><br><span class="line">        executor.setRejectedExecutionHandler(<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());</span><br><span class="line">        executor.initialize();</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AsyncUncaughtExceptionHandler <span class="title function_">getAsyncUncaughtExceptionHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (throwable, method, objects) -&gt; &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;Async method &#123;&#125; failed with args &#123;&#125;&quot;</span>, </span><br><span class="line">                method.getName(), Arrays.toString(objects), throwable);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Custom error handling - metrics, alerting, etc.</span></span><br><span class="line">            handleAsyncException(method, throwable);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TaskScheduler <span class="title function_">taskScheduler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskScheduler</span> <span class="variable">scheduler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskScheduler</span>();</span><br><span class="line">        scheduler.setPoolSize(<span class="number">5</span>);</span><br><span class="line">        scheduler.setThreadNamePrefix(<span class="string">&quot;Scheduled-&quot;</span>);</span><br><span class="line">        scheduler.setWaitForTasksToCompleteOnShutdown(<span class="literal">true</span>);</span><br><span class="line">        scheduler.setAwaitTerminationSeconds(<span class="number">30</span>);</span><br><span class="line">        <span class="keyword">return</span> scheduler;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Summary-and-Key-Takeaways"><a href="#Summary-and-Key-Takeaways" class="headerlink" title="Summary and Key Takeaways"></a>Summary and Key Takeaways</h2><p>Thread pools are fundamental to building scalable Java applications. Key principles for success:</p>
<ol>
<li><strong>Right-size your pools</strong> based on workload characteristics (CPU vs I&#x2F;O bound)</li>
<li><strong>Use bounded queues</strong> to provide backpressure and prevent memory exhaustion  </li>
<li><strong>Implement proper monitoring</strong> to understand pool behavior and performance</li>
<li><strong>Handle failures gracefully</strong> with appropriate rejection policies and error handling</li>
<li><strong>Ensure clean shutdown</strong> to prevent resource leaks and data corruption</li>
<li><strong>Monitor and tune continuously</strong> based on production metrics and load patterns</li>
</ol>
<p>The choice of thread pool configuration can make the difference between a responsive, scalable application and one that fails under load. Always test your configuration under realistic load conditions and be prepared to adjust based on observed behavior.</p>
<p>Remember that thread pools are just one part of the concurrency story - proper synchronization, lock-free data structures, and understanding of the Java Memory Model are equally important for building robust concurrent applications.</p>
<h2 id="External-References"><a href="#External-References" class="headerlink" title="External References"></a>External References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/Executor.html">Oracle Java Documentation - Executor Framework</a></li>
<li><a target="_blank" rel="noopener" href="https://www.amazon.com/Java-Concurrency-Practice-Brian-Goetz/dp/0321349601">Java Concurrency in Practice by Brian Goetz</a></li>
<li><a target="_blank" rel="noopener" href="https://spring.io/guides/gs/async-method/">Spring Framework Async Execution</a></li>
<li><a target="_blank" rel="noopener" href="https://micrometer.io/docs/concepts#_executors">Micrometer Metrics for Thread Pools</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/gctuning/">JVM Performance Tuning Guide</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/14/Java-OOM-Troubleshooting-Guide-Production-Best-Practices/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/14/Java-OOM-Troubleshooting-Guide-Production-Best-Practices/" class="post-title-link" itemprop="url">Java OOM Troubleshooting Guide - Production Best Practices</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-14 17:50:06 / Modified: 17:52:14" itemprop="dateCreated datePublished" datetime="2025-06-14T17:50:06+08:00">2025-06-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Types-of-OutOfMemoryError-in-Production-Environments"><a href="#Types-of-OutOfMemoryError-in-Production-Environments" class="headerlink" title="Types of OutOfMemoryError in Production Environments"></a>Types of OutOfMemoryError in Production Environments</h2><h3 id="Java-Heap-Space-OOM"><a href="#Java-Heap-Space-OOM" class="headerlink" title="Java Heap Space OOM"></a>Java Heap Space OOM</h3><p>The most common OOM error occurs when the JVM cannot allocate objects in the heap due to insufficient memory.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Example code that can cause heap OOM</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HeapOOMExample</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;<span class="type">byte</span>[]&gt; memoryEater = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="comment">// Continuously allocate 1MB arrays</span></span><br><span class="line">                memoryEater.add(<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span> * <span class="number">1024</span>]);</span><br><span class="line">                System.out.println(<span class="string">&quot;Allocated arrays: &quot;</span> + memoryEater.size());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (OutOfMemoryError e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;java.lang.OutOfMemoryError: Java heap space&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Production Case Study</strong>: An e-commerce application experienced heap OOM during Black Friday sales due to caching user sessions without proper expiration policies.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Problematic session cache implementation</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SessionManager</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, UserSession&gt; sessions = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createSession</span><span class="params">(String sessionId, UserSession session)</span> &#123;</span><br><span class="line">        <span class="comment">// Problem: No expiration mechanism</span></span><br><span class="line">        sessions.put(sessionId, session);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Fixed version with expiration</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, SessionWithTimestamp&gt; sessionsFixed = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createSessionFixed</span><span class="params">(String sessionId, UserSession session)</span> &#123;</span><br><span class="line">        sessionsFixed.put(sessionId, <span class="keyword">new</span> <span class="title class_">SessionWithTimestamp</span>(session, System.currentTimeMillis()));</span><br><span class="line">        cleanupExpiredSessions();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PermGen-Metaspace-OOM"><a href="#PermGen-Metaspace-OOM" class="headerlink" title="PermGen&#x2F;Metaspace OOM"></a>PermGen&#x2F;Metaspace OOM</h3><p>Occurs when the permanent generation (Java 7 and earlier) or Metaspace (Java 8+) runs out of memory.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Dynamic class generation causing Metaspace OOM</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MetaspaceOOMExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;GeneratedClass&quot;</span> + i);</span><br><span class="line">            cc.addMethod(CtNewMethod.make(<span class="string">&quot;public void test() &#123;&#125;&quot;</span>, cc));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Loading classes without proper cleanup</span></span><br><span class="line">            Class&lt;?&gt; clazz = cc.toClass();</span><br><span class="line">            System.out.println(<span class="string">&quot;Created class: &quot;</span> + clazz.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“How would you differentiate between heap OOM and Metaspace OOM in production logs?”</em></p>
<ul>
<li>Heap OOM: <code>java.lang.OutOfMemoryError: Java heap space</code></li>
<li>Metaspace OOM: <code>java.lang.OutOfMemoryError: Metaspace</code></li>
</ul>
<h3 id="Direct-Memory-OOM"><a href="#Direct-Memory-OOM" class="headerlink" title="Direct Memory OOM"></a>Direct Memory OOM</h3><p>Occurs when off-heap memory allocated by NIO or unsafe operations exceeds limits.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Direct memory allocation example</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DirectMemoryOOM</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        List&lt;ByteBuffer&gt; buffers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="comment">// Allocate 1MB direct memory buffers</span></span><br><span class="line">                <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocateDirect(<span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line">                buffers.add(buffer);</span><br><span class="line">                System.out.println(<span class="string">&quot;Allocated direct buffers: &quot;</span> + buffers.size());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (OutOfMemoryError e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;java.lang.OutOfMemoryError: Direct buffer memory&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Production Case Study: Big Data Processing</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Scenario: Apache Kafka consumer processing large messages</span><br><span class="line">Symptoms: Intermittent failures during peak message processing</span><br><span class="line">Root Cause: NIO operations consuming direct memory without proper cleanup</span><br><span class="line">Fix: Increased -XX:MaxDirectMemorySize and improved buffer management</span><br></pre></td></tr></table></figure>

<h2 id="Generating-Heap-Dumps-When-OOM-Occurs"><a href="#Generating-Heap-Dumps-When-OOM-Occurs" class="headerlink" title="Generating Heap Dumps When OOM Occurs"></a>Generating Heap Dumps When OOM Occurs</h2><h3 id="Automatic-Heap-Dump-Generation"><a href="#Automatic-Heap-Dump-Generation" class="headerlink" title="Automatic Heap Dump Generation"></a>Automatic Heap Dump Generation</h3><p>Configure JVM parameters to automatically generate heap dumps on OOM:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># JVM flags for automatic heap dump generation</span></span><br><span class="line">java -XX:+HeapDumpOnOutOfMemoryError \</span><br><span class="line">     -XX:HeapDumpPath=/opt/app/heapdumps/ \</span><br><span class="line">     -XX:+PrintGCDetails \</span><br><span class="line">     -XX:+PrintGCTimeStamps \</span><br><span class="line">     -Xloggc:/opt/app/logs/gc.log \</span><br><span class="line">     -jar your-application.jar</span><br></pre></td></tr></table></figure>

<h3 id="Manual-Heap-Dump-Generation"><a href="#Manual-Heap-Dump-Generation" class="headerlink" title="Manual Heap Dump Generation"></a>Manual Heap Dump Generation</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Using jmap (requires application PID)</span></span><br><span class="line">jmap -dump:format=b,file=heap-dump.hprof &lt;PID&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Using jcmd (Java 8+)</span></span><br><span class="line">jcmd &lt;PID&gt; GC.run_finalization</span><br><span class="line">jcmd &lt;PID&gt; VM.gc</span><br><span class="line">jcmd &lt;PID&gt; GC.heap_dump /path/to/heap-dump.hprof</span><br><span class="line"></span><br><span class="line"><span class="comment"># Using kill signal (if configured)</span></span><br><span class="line"><span class="built_in">kill</span> -3 &lt;PID&gt;  <span class="comment"># Generates thread dump, not heap dump</span></span><br></pre></td></tr></table></figure>

<h3 id="Production-Ready-Heap-Dump-Script"><a href="#Production-Ready-Heap-Dump-Script" class="headerlink" title="Production-Ready Heap Dump Script"></a>Production-Ready Heap Dump Script</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># heap-dump-collector.sh</span></span><br><span class="line"></span><br><span class="line">APP_PID=$(pgrep -f <span class="string">&quot;your-application.jar&quot;</span>)</span><br><span class="line">DUMP_DIR=<span class="string">&quot;/opt/app/heapdumps&quot;</span></span><br><span class="line">TIMESTAMP=$(<span class="built_in">date</span> +%Y%m%d_%H%M%S)</span><br><span class="line">DUMP_FILE=<span class="string">&quot;<span class="variable">$&#123;DUMP_DIR&#125;</span>/heap-dump-<span class="variable">$&#123;TIMESTAMP&#125;</span>.hprof&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$APP_PID</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Application not running&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Generating heap dump for PID: <span class="variable">$APP_PID</span>&quot;</span></span><br><span class="line">jmap -dump:format=b,file=<span class="string">&quot;<span class="variable">$DUMP_FILE</span>&quot;</span> <span class="string">&quot;<span class="variable">$APP_PID</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Heap dump generated: <span class="variable">$DUMP_FILE</span>&quot;</span></span><br><span class="line">    <span class="comment"># Compress the dump file to save space</span></span><br><span class="line">    gzip <span class="string">&quot;<span class="variable">$DUMP_FILE</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Heap dump compressed: <span class="variable">$&#123;DUMP_FILE&#125;</span>.gz&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Failed to generate heap dump&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h2 id="Analyzing-Problems-with-MAT-and-VisualVM"><a href="#Analyzing-Problems-with-MAT-and-VisualVM" class="headerlink" title="Analyzing Problems with MAT and VisualVM"></a>Analyzing Problems with MAT and VisualVM</h2><h3 id="Memory-Analyzer-Tool-MAT-Analysis"><a href="#Memory-Analyzer-Tool-MAT-Analysis" class="headerlink" title="Memory Analyzer Tool (MAT) Analysis"></a>Memory Analyzer Tool (MAT) Analysis</h3><p><strong>Step-by-step MAT Analysis Process:</strong></p>
<ol>
<li><strong>Load the heap dump</strong> into MAT</li>
<li><strong>Automatic Leak Suspects Report</strong> - MAT automatically identifies potential memory leaks</li>
<li><strong>Dominator Tree Analysis</strong> - Shows objects and their retained heap sizes</li>
<li><strong>Histogram View</strong> - Groups objects by class and shows instance counts</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Example of analyzing a suspected memory leak</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LeakyClass</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; dataList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;LeakyClass&gt; instances = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LeakyClass</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Problem: Adding to static list without removal</span></span><br><span class="line">        instances.add(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addData</span><span class="params">(String data)</span> &#123;</span><br><span class="line">        dataList.add(data);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Missing cleanup method</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cleanup</span><span class="params">()</span> &#123;</span><br><span class="line">        instances.remove(<span class="built_in">this</span>);</span><br><span class="line">        dataList.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>MAT Analysis Results Interpretation:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Leak Suspects Report:</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│ Problem Suspect 1                                           │</span><br><span class="line">│ 45,234 instances of &quot;LeakyClass&quot;                           │</span><br><span class="line">│ Accumulated objects in cluster have total size 89.2 MB     │</span><br><span class="line">│ Keywords: java.util.ArrayList                               │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="VisualVM-Analysis-Approach"><a href="#VisualVM-Analysis-Approach" class="headerlink" title="VisualVM Analysis Approach"></a>VisualVM Analysis Approach</h3><p><strong>Real-time Monitoring Setup:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Enable JMX for VisualVM connection</span></span><br><span class="line">java -Dcom.sun.management.jmxremote \</span><br><span class="line">     -Dcom.sun.management.jmxremote.port=9999 \</span><br><span class="line">     -Dcom.sun.management.jmxremote.authenticate=<span class="literal">false</span> \</span><br><span class="line">     -Dcom.sun.management.jmxremote.ssl=<span class="literal">false</span> \</span><br><span class="line">     -jar your-application.jar</span><br></pre></td></tr></table></figure>

<p><strong>VisualVM Analysis Workflow:</strong></p>
<ol>
<li><strong>Connect to running application</strong></li>
<li><strong>Monitor heap usage patterns</strong></li>
<li><strong>Perform heap dumps during high memory usage</strong></li>
<li><strong>Analyze object retention paths</strong></li>
</ol>
<h2 id="Common-Causes-of-OOM-and-Solutions"><a href="#Common-Causes-of-OOM-and-Solutions" class="headerlink" title="Common Causes of OOM and Solutions"></a>Common Causes of OOM and Solutions</h2><h3 id="Memory-Leaks"><a href="#Memory-Leaks" class="headerlink" title="Memory Leaks"></a>Memory Leaks</h3><p><strong>Listener&#x2F;Observer Pattern Leaks:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Problematic code</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventPublisher</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;EventListener&gt; listeners = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addListener</span><span class="params">(EventListener listener)</span> &#123;</span><br><span class="line">        listeners.add(listener);</span><br><span class="line">        <span class="comment">// Problem: No removal mechanism</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Fixed version</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeListener</span><span class="params">(EventListener listener)</span> &#123;</span><br><span class="line">        listeners.remove(listener);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Proper cleanup in listener implementations</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyEventListener</span> <span class="keyword">implements</span> <span class="title class_">EventListener</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> EventPublisher publisher;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyEventListener</span><span class="params">(EventPublisher publisher)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.publisher = publisher;</span><br><span class="line">        publisher.addListener(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cleanup</span><span class="params">()</span> &#123;</span><br><span class="line">        publisher.removeListener(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Question</strong>: <em>“How would you identify and fix a listener leak in production?”</em></p>
<p><strong>Answer approach</strong>: Monitor heap dumps for increasing listener collections, implement weak references, or ensure proper cleanup in lifecycle methods.</p>
<h3 id="Connection-Pool-Leaks"><a href="#Connection-Pool-Leaks" class="headerlink" title="Connection Pool Leaks"></a>Connection Pool Leaks</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Database connection leak example</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Problematic method</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">getUsers</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> dataSource.getConnection();</span><br><span class="line">        <span class="type">PreparedStatement</span> <span class="variable">stmt</span> <span class="operator">=</span> conn.prepareStatement(<span class="string">&quot;SELECT * FROM users&quot;</span>);</span><br><span class="line">        <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> stmt.executeQuery();</span><br><span class="line">        </span><br><span class="line">        List&lt;User&gt; users = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">            users.add(<span class="keyword">new</span> <span class="title class_">User</span>(rs.getString(<span class="string">&quot;name&quot;</span>), rs.getString(<span class="string">&quot;email&quot;</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Problem: Resources not closed properly</span></span><br><span class="line">        <span class="keyword">return</span> users;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Fixed version with try-with-resources</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">getUsersFixed</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> dataSource.getConnection();</span><br><span class="line">             <span class="type">PreparedStatement</span> <span class="variable">stmt</span> <span class="operator">=</span> conn.prepareStatement(<span class="string">&quot;SELECT * FROM users&quot;</span>);</span><br><span class="line">             <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> stmt.executeQuery()) &#123;</span><br><span class="line">            </span><br><span class="line">            List&lt;User&gt; users = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">                users.add(<span class="keyword">new</span> <span class="title class_">User</span>(rs.getString(<span class="string">&quot;name&quot;</span>), rs.getString(<span class="string">&quot;email&quot;</span>)));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> users;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Oversized-Objects"><a href="#Oversized-Objects" class="headerlink" title="Oversized Objects"></a>Oversized Objects</h3><p><strong>Large Collection Handling:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Problematic approach for large datasets</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataProcessor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processLargeDataset</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;String&gt; allData = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Problem: Loading entire dataset into memory</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> Files.newBufferedReader(Paths.get(<span class="string">&quot;large-file.txt&quot;</span>))) &#123;</span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                allData.add(line);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Process all data at once</span></span><br><span class="line">        processData(allData);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Streaming approach to handle large datasets</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processLargeDatasetStreaming</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> (Stream&lt;String&gt; lines = Files.lines(Paths.get(<span class="string">&quot;large-file.txt&quot;</span>))) &#123;</span><br><span class="line">            lines.parallel()</span><br><span class="line">                 .filter(line -&gt; !line.isEmpty())</span><br><span class="line">                 .map(<span class="built_in">this</span>::transformLine)</span><br><span class="line">                 .forEach(<span class="built_in">this</span>::processLine);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Large Object Example:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Memory-intensive operation</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReportGenerator</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;CustomerReport&gt; <span class="title function_">generateMonthlyReports</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;CustomerReport&gt; reports = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// Loading 100K+ customer records into memory</span></span><br><span class="line">        List&lt;Customer&gt; allCustomers = customerRepository.findAll();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (Customer customer : allCustomers) &#123;</span><br><span class="line">            reports.add(generateReport(customer)); <span class="comment">// Each report ~50KB</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> reports; <span class="comment">// Total: ~5GB in memory</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Optimized Solution:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Stream-based processing</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OptimizedReportGenerator</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomerRepository customerRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generateMonthlyReports</span><span class="params">(ReportWriter writer)</span> &#123;</span><br><span class="line">        customerRepository.findAllByStream()</span><br><span class="line">            .map(<span class="built_in">this</span>::generateReport)</span><br><span class="line">            .forEach(writer::writeReport);</span><br><span class="line">        <span class="comment">// Memory usage: ~50KB per iteration</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Container-Resource-Constraints"><a href="#Container-Resource-Constraints" class="headerlink" title="Container Resource Constraints"></a>Container Resource Constraints</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Kubernetes deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;2Gi&quot;</span>  <span class="comment"># Container limit</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;-Xmx1536m&quot;</span>  <span class="comment"># JVM heap should be ~75% of container limit</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight:</strong> <em>“How do you size JVM heap in containerized environments? What’s the relationship between container memory limits and JVM heap size?”</em></p>
<h2 id="Tuning-Object-Promotion-and-GC-Parameters"><a href="#Tuning-Object-Promotion-and-GC-Parameters" class="headerlink" title="Tuning Object Promotion and GC Parameters"></a>Tuning Object Promotion and GC Parameters</h2><h3 id="Understanding-Object-Lifecycle"><a href="#Understanding-Object-Lifecycle" class="headerlink" title="Understanding Object Lifecycle"></a>Understanding Object Lifecycle</h3><pre>
<code class="mermaid">
graph TD
A[Object Creation] --&gt; B[Eden Space]
B --&gt; C{Minor GC}
C --&gt;|Survives| D[Survivor Space S0]
D --&gt; E{Minor GC}
E --&gt;|Survives| F[Survivor Space S1]
F --&gt; G{Age Threshold?}
G --&gt;|Yes| H[Old Generation]
G --&gt;|No| I[Back to Survivor]
C --&gt;|Dies| J[Garbage Collected]
E --&gt;|Dies| J
H --&gt; K{Major GC}
K --&gt; L[Garbage Collected or Retained]
</code>
</pre>

<h3 id="GC-Tuning-Parameters"><a href="#GC-Tuning-Parameters" class="headerlink" title="GC Tuning Parameters"></a>GC Tuning Parameters</h3><p><strong>G1GC Configuration for Production:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># G1GC tuning for 8GB heap</span></span><br><span class="line">java -Xms8g -Xmx8g \</span><br><span class="line">     -XX:+UseG1GC \</span><br><span class="line">     -XX:MaxGCPauseMillis=200 \</span><br><span class="line">     -XX:G1HeapRegionSize=16m \</span><br><span class="line">     -XX:G1NewSizePercent=20 \</span><br><span class="line">     -XX:G1MaxNewSizePercent=30 \</span><br><span class="line">     -XX:InitiatingHeapOccupancyPercent=45 \</span><br><span class="line">     -XX:G1MixedGCCountTarget=8 \</span><br><span class="line">     -XX:G1MixedGCLiveThresholdPercent=85 \</span><br><span class="line">     -jar your-application.jar</span><br></pre></td></tr></table></figure>

<p><strong>Parallel GC Configuration:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ParallelGC tuning for high-throughput applications</span></span><br><span class="line">java -Xms4g -Xmx4g \</span><br><span class="line">     -XX:+UseParallelGC \</span><br><span class="line">     -XX:ParallelGCThreads=8 \</span><br><span class="line">     -XX:NewRatio=3 \</span><br><span class="line">     -XX:SurvivorRatio=8 \</span><br><span class="line">     -XX:MaxTenuringThreshold=15 \</span><br><span class="line">     -XX:PretenureSizeThreshold=1048576 \</span><br><span class="line">     -jar your-application.jar</span><br></pre></td></tr></table></figure>

<h3 id="Object-Promotion-Threshold-Tuning"><a href="#Object-Promotion-Threshold-Tuning" class="headerlink" title="Object Promotion Threshold Tuning"></a>Object Promotion Threshold Tuning</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Monitor object age distribution</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ObjectAgeMonitoring</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// JVM flag to print tenuring distribution</span></span><br><span class="line">    <span class="comment">// -XX:+PrintTenuringDistribution</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">demonstrateObjectPromotion</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;<span class="type">byte</span>[]&gt; shortLived = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        List&lt;<span class="type">byte</span>[]&gt; longLived = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            <span class="comment">// Short-lived objects (should stay in young generation)</span></span><br><span class="line">            <span class="type">byte</span>[] temp = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            shortLived.add(temp);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">10</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// Long-lived objects (will be promoted to old generation)</span></span><br><span class="line">                longLived.add(<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Clear short-lived objects periodically</span></span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">100</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                shortLived.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="GC-Performance-Monitoring"><a href="#GC-Performance-Monitoring" class="headerlink" title="GC Performance Monitoring"></a>GC Performance Monitoring</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Comprehensive GC logging (Java 11+)</span></span><br><span class="line">java -Xlog:gc*:gc.log:<span class="keyword">time</span>,tags \</span><br><span class="line">     -XX:+UnlockExperimentalVMOptions \</span><br><span class="line">     -XX:+UseEpsilonGC \  <span class="comment"># For testing only</span></span><br><span class="line">     -jar your-application.jar</span><br><span class="line"></span><br><span class="line"><span class="comment"># GC analysis script</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment"># gc-analyzer.sh</span></span><br><span class="line"></span><br><span class="line">GC_LOG_FILE=<span class="string">&quot;gc.log&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== GC Performance Analysis ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Total GC events:&quot;</span></span><br><span class="line">grep -c <span class="string">&quot;GC(&quot;</span> <span class="string">&quot;<span class="variable">$GC_LOG_FILE</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Average pause time:&quot;</span></span><br><span class="line">grep <span class="string">&quot;GC(&quot;</span> <span class="string">&quot;<span class="variable">$GC_LOG_FILE</span>&quot;</span> | awk -F<span class="string">&#x27;,&#x27;</span> <span class="string">&#x27;&#123;sum+=$2; count++&#125; END &#123;print sum/count &quot;ms&quot;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Memory before/after GC:&quot;</span></span><br><span class="line">grep -E <span class="string">&quot;-&gt;.*\(&quot;</span> <span class="string">&quot;<span class="variable">$GC_LOG_FILE</span>&quot;</span> | <span class="built_in">tail</span> -10</span><br></pre></td></tr></table></figure>

<h2 id="Advanced-OOM-Prevention-Strategies"><a href="#Advanced-OOM-Prevention-Strategies" class="headerlink" title="Advanced OOM Prevention Strategies"></a>Advanced OOM Prevention Strategies</h2><h3 id="Memory-Efficient-Data-Structures"><a href="#Memory-Efficient-Data-Structures" class="headerlink" title="Memory-Efficient Data Structures"></a>Memory-Efficient Data Structures</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Using primitive collections to reduce memory overhead</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemoryEfficientStorage</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Instead of HashMap&lt;Integer, Integer&gt;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">TIntIntHashMap</span> <span class="variable">primitiveMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TIntIntHashMap</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Instead of List&lt;Integer&gt;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">TIntArrayList</span> <span class="variable">primitiveList</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TIntArrayList</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Object pooling for frequently created objects</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectPool&lt;StringBuilder&gt; stringBuilderPool = </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">GenericObjectPool</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">StringBuilderFactory</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">processData</span><span class="params">(List&lt;String&gt; data)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            sb = stringBuilderPool.borrowObject();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (String item : data) &#123;</span><br><span class="line">                sb.append(item).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> sb.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (sb != <span class="literal">null</span>) &#123;</span><br><span class="line">                stringBuilderPool.returnObject(sb);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Circuit-Breaker-Pattern-for-Memory-Protection"><a href="#Circuit-Breaker-Pattern-for-Memory-Protection" class="headerlink" title="Circuit Breaker Pattern for Memory Protection"></a>Circuit Breaker Pattern for Memory Protection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Circuit breaker to prevent memory exhaustion</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemoryCircuitBreaker</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">MemoryMXBean</span> <span class="variable">memoryBean</span> <span class="operator">=</span> ManagementFactory.getMemoryMXBean();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">double</span> <span class="variable">memoryThreshold</span> <span class="operator">=</span> <span class="number">0.85</span>; <span class="comment">// 85% of heap</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">circuitOpen</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isMemoryAvailable</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MemoryUsage</span> <span class="variable">heapUsage</span> <span class="operator">=</span> memoryBean.getHeapMemoryUsage();</span><br><span class="line">        <span class="type">double</span> <span class="variable">usedPercentage</span> <span class="operator">=</span> (<span class="type">double</span>) heapUsage.getUsed() / heapUsage.getMax();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (usedPercentage &gt; memoryThreshold) &#123;</span><br><span class="line">            circuitOpen = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (circuitOpen &amp;&amp; usedPercentage &lt; (memoryThreshold - <span class="number">0.1</span>)) &#123;</span><br><span class="line">            circuitOpen = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> !circuitOpen;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">executeWithMemoryCheck</span><span class="params">(Supplier&lt;T&gt; operation)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isMemoryAvailable()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Circuit breaker open: Memory usage too high&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> operation.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Production-Monitoring-and-Alerting"><a href="#Production-Monitoring-and-Alerting" class="headerlink" title="Production Monitoring and Alerting"></a>Production Monitoring and Alerting</h2><h3 id="JVM-Metrics-Collection"><a href="#JVM-Metrics-Collection" class="headerlink" title="JVM Metrics Collection"></a>JVM Metrics Collection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Custom JVM metrics collector</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JVMMetricsCollector</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">MemoryMXBean</span> <span class="variable">memoryBean</span> <span class="operator">=</span> ManagementFactory.getMemoryMXBean();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;GarbageCollectorMXBean&gt; gcBeans = ManagementFactory.getGarbageCollectorMXBeans();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 30000)</span> <span class="comment">// Every 30 seconds</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">collectMetrics</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MemoryUsage</span> <span class="variable">heapUsage</span> <span class="operator">=</span> memoryBean.getHeapMemoryUsage();</span><br><span class="line">        <span class="type">MemoryUsage</span> <span class="variable">nonHeapUsage</span> <span class="operator">=</span> memoryBean.getNonHeapMemoryUsage();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Log heap metrics</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">heapUsedPercent</span> <span class="operator">=</span> (<span class="type">double</span>) heapUsage.getUsed() / heapUsage.getMax() * <span class="number">100</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (heapUsedPercent &gt; <span class="number">80</span>) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;High heap usage: &#123;&#125;%&quot;</span>, String.format(<span class="string">&quot;%.2f&quot;</span>, heapUsedPercent));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Log GC metrics</span></span><br><span class="line">        <span class="keyword">for</span> (GarbageCollectorMXBean gcBean : gcBeans) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">collections</span> <span class="operator">=</span> gcBean.getCollectionCount();</span><br><span class="line">            <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> gcBean.getCollectionTime();</span><br><span class="line">            </span><br><span class="line">            log.info(<span class="string">&quot;GC [&#123;&#125;]: Collections=&#123;&#125;, Time=&#123;&#125;ms&quot;</span>, </span><br><span class="line">                    gcBean.getName(), collections, time);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Alerting-Configuration"><a href="#Alerting-Configuration" class="headerlink" title="Alerting Configuration"></a>Alerting Configuration</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Prometheus alerting rules for OOM prevention</span></span><br><span class="line"><span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jvm-memory-alerts</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">HighHeapUsage</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">jvm_memory_used_bytes&#123;area=&quot;heap&quot;&#125;</span> <span class="string">/</span> <span class="string">jvm_memory_max_bytes&#123;area=&quot;heap&quot;&#125;</span> <span class="string">&gt;</span> <span class="number">0.85</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">2m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;High JVM heap usage detected&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;Heap usage is above 85% for more than 2 minutes&quot;</span></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">HighGCTime</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">rate(jvm_gc_collection_seconds_sum[5m])</span> <span class="string">&gt;</span> <span class="number">0.1</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;High GC time detected&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;Application spending more than 10% time in GC&quot;</span></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">FrequentGC</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">rate(jvm_gc_collection_seconds_count[5m])</span> <span class="string">&gt;</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">2m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;Frequent GC cycles&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;More than 2 GC cycles per second&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Interview-Questions-and-Expert-Insights"><a href="#Interview-Questions-and-Expert-Insights" class="headerlink" title="Interview Questions and Expert Insights"></a>Interview Questions and Expert Insights</h2><h3 id="Core-Technical-Questions"><a href="#Core-Technical-Questions" class="headerlink" title="Core Technical Questions"></a>Core Technical Questions</h3><p><strong>Q: “Explain the difference between memory leak and memory pressure in Java applications.”</strong></p>
<p><strong>Expert Answer</strong>: Memory leak refers to objects that are no longer needed but still referenced, preventing garbage collection. Memory pressure occurs when application legitimately needs more memory than available. Leaks show constant growth in heap dumps, while pressure shows high but stable memory usage with frequent GC.</p>
<p><strong>Q: “How would you troubleshoot an application that has intermittent OOM errors?”</strong></p>
<p><strong>Systematic Approach</strong>:</p>
<ol>
<li>Enable heap dump generation on OOM</li>
<li>Monitor GC logs for patterns</li>
<li>Use application performance monitoring (APM) tools</li>
<li>Implement memory circuit breakers</li>
<li>Analyze heap dumps during both normal and high-load periods</li>
</ol>
<p><strong>Q: “What’s the impact of different GC algorithms on OOM behavior?”</strong></p>
<p><strong>Comparison Table</strong>:</p>
<table>
<thead>
<tr>
<th>GC Algorithm</th>
<th>OOM Behavior</th>
<th>Best Use Case</th>
</tr>
</thead>
<tbody><tr>
<td>Serial GC</td>
<td>Quick OOM detection</td>
<td>Small applications</td>
</tr>
<tr>
<td>Parallel GC</td>
<td>High throughput before OOM</td>
<td>Batch processing</td>
</tr>
<tr>
<td>G1GC</td>
<td>Predictable pause times</td>
<td>Large heaps (&gt;4GB)</td>
</tr>
<tr>
<td>ZGC</td>
<td>Ultra-low latency</td>
<td>Real-time applications</td>
</tr>
</tbody></table>
<h3 id="Advanced-Troubleshooting-Scenarios"><a href="#Advanced-Troubleshooting-Scenarios" class="headerlink" title="Advanced Troubleshooting Scenarios"></a>Advanced Troubleshooting Scenarios</h3><p><strong>Scenario</strong>: “Application runs fine for hours, then suddenly throws OOM. Heap dump shows high memory usage but no obvious leaks.”</p>
<p><strong>Investigation Strategy</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Implement memory pressure monitoring</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemoryPressureDetector</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Queue&lt;Long&gt; memorySnapshots = <span class="keyword">new</span> <span class="title class_">ConcurrentLinkedQueue</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">maxSnapshots</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 60000)</span> <span class="comment">// Every minute</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">takeSnapshot</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">usedMemory</span> <span class="operator">=</span> Runtime.getRuntime().totalMemory() - Runtime.getRuntime().freeMemory();</span><br><span class="line">        </span><br><span class="line">        memorySnapshots.offer(usedMemory);</span><br><span class="line">        <span class="keyword">if</span> (memorySnapshots.size() &gt; maxSnapshots) &#123;</span><br><span class="line">            memorySnapshots.poll();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Detect memory pressure trends</span></span><br><span class="line">        <span class="keyword">if</span> (memorySnapshots.size() &gt;= <span class="number">10</span>) &#123;</span><br><span class="line">            List&lt;Long&gt; recent = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(memorySnapshots);</span><br><span class="line">            Collections.reverse(recent);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Check if memory is consistently increasing</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">increasingTrend</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; Math.min(<span class="number">10</span>, recent.size()); i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (recent.get(i) &lt;= recent.get(i-<span class="number">1</span>)) &#123;</span><br><span class="line">                    increasingTrend = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (increasingTrend) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;Detected increasing memory pressure trend&quot;</span>);</span><br><span class="line">                <span class="comment">// Trigger proactive measures</span></span><br><span class="line">                triggerGarbageCollection();</span><br><span class="line">                generateHeapDump();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">triggerGarbageCollection</span><span class="params">()</span> &#123;</span><br><span class="line">        System.gc(); <span class="comment">// Use with caution in production</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Best-Practices-Summary"><a href="#Best-Practices-Summary" class="headerlink" title="Best Practices Summary"></a>Best Practices Summary</h2><h3 id="Development-Phase"><a href="#Development-Phase" class="headerlink" title="Development Phase"></a>Development Phase</h3><ul>
<li>Implement proper resource management with try-with-resources</li>
<li>Use weak references for caches and listeners</li>
<li>Design with memory constraints in mind</li>
<li>Implement object pooling for frequently created objects</li>
</ul>
<h3 id="Testing-Phase"><a href="#Testing-Phase" class="headerlink" title="Testing Phase"></a>Testing Phase</h3><ul>
<li>Load test with realistic data volumes</li>
<li>Monitor memory usage patterns during extended runs</li>
<li>Test GC behavior under various loads</li>
<li>Validate heap dump analysis procedures</li>
</ul>
<h3 id="Production-Phase"><a href="#Production-Phase" class="headerlink" title="Production Phase"></a>Production Phase</h3><ul>
<li>Enable automatic heap dump generation</li>
<li>Implement comprehensive monitoring and alerting</li>
<li>Have heap dump analysis procedures documented</li>
<li>Maintain GC logs for performance analysis</li>
</ul>
<h3 id="Emergency-Response"><a href="#Emergency-Response" class="headerlink" title="Emergency Response"></a>Emergency Response</h3><ul>
<li>Automated heap dump collection on OOM</li>
<li>Circuit breaker patterns to prevent cascading failures</li>
<li>Memory pressure monitoring and proactive alerting</li>
<li>Documented escalation procedures for memory issues</li>
</ul>
<h2 id="External-References-and-Tools"><a href="#External-References-and-Tools" class="headerlink" title="External References and Tools"></a>External References and Tools</h2><h3 id="Essential-Tools"><a href="#Essential-Tools" class="headerlink" title="Essential Tools"></a>Essential Tools</h3><ul>
<li><strong>Eclipse MAT</strong>: <a target="_blank" rel="noopener" href="https://www.eclipse.org/mat/">https://www.eclipse.org/mat/</a></li>
<li><strong>VisualVM</strong>: <a target="_blank" rel="noopener" href="https://visualvm.github.io/">https://visualvm.github.io/</a></li>
<li><strong>JProfiler</strong>: <a target="_blank" rel="noopener" href="https://www.ej-technologies.com/products/jprofiler/">https://www.ej-technologies.com/products/jprofiler/</a></li>
<li><strong>Async Profiler</strong>: <a target="_blank" rel="noopener" href="https://github.com/jvm-profiling-tools/async-profiler">https://github.com/jvm-profiling-tools/async-profiler</a></li>
</ul>
<h3 id="Monitoring-Solutions"><a href="#Monitoring-Solutions" class="headerlink" title="Monitoring Solutions"></a>Monitoring Solutions</h3><ul>
<li><strong>Micrometer</strong>: <a target="_blank" rel="noopener" href="https://micrometer.io/">https://micrometer.io/</a></li>
<li><strong>Prometheus JVM Metrics</strong>: <a target="_blank" rel="noopener" href="https://github.com/prometheus/client_java">https://github.com/prometheus/client_java</a></li>
<li><strong>APM Tools</strong>: New Relic, AppDynamics, Datadog</li>
</ul>
<h3 id="Documentation"><a href="#Documentation" class="headerlink" title="Documentation"></a>Documentation</h3><ul>
<li><strong>Oracle JVM Tuning Guide</strong>: <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/">https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/</a></li>
<li><strong>G1GC Documentation</strong>: <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/G1.html">https://docs.oracle.com/javase/8/docs/technotes/guides/vm/G1.html</a></li>
<li><strong>JVM Flags Reference</strong>: <a target="_blank" rel="noopener" href="https://chriswhocodes.com/hotspot_options_jdk11.html">https://chriswhocodes.com/hotspot_options_jdk11.html</a></li>
</ul>
<h3 id="Best-Practices-Resources"><a href="#Best-Practices-Resources" class="headerlink" title="Best Practices Resources"></a>Best Practices Resources</h3><ul>
<li><strong>Java Performance Tuning</strong>: “Java Performance: The Definitive Guide” by Scott Oaks</li>
<li><strong>GC Tuning</strong>: “Optimizing Java” by Benjamin J. Evans</li>
<li><strong>Memory Management</strong>: “Java Memory Management” by Kiran Kumar</li>
</ul>
<p>Remember: OOM troubleshooting is both art and science. Combine systematic analysis with deep understanding of your application’s memory patterns. Always test memory optimizations in staging environments before production deployment.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/13/Design-Message-Notification-Service/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/13/Design-Message-Notification-Service/" class="post-title-link" itemprop="url">Design Message Notification Service</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-13 20:54:18 / Modified: 20:57:50" itemprop="dateCreated datePublished" datetime="2025-06-13T20:54:18+08:00">2025-06-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system-design/" itemprop="url" rel="index"><span itemprop="name">system-design</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="System-Overview"><a href="#System-Overview" class="headerlink" title="System Overview"></a>System Overview</h2><p>The Message Notification Service is a scalable, multi-channel notification platform designed to handle 10 million messages per day across email, SMS, and WeChat channels. The system employs event-driven architecture with message queues for decoupling, template-based messaging, and comprehensive delivery tracking.</p>
<p><strong>Interview Insight</strong>: When discussing notification systems, emphasize the trade-offs between consistency and availability. For notifications, we typically choose availability over strict consistency since delayed delivery is preferable to no delivery.</p>
<pre>
<code class="mermaid">
graph TB
A[Business Services] --&gt; B[MessageNotificationSDK]
B --&gt; C[API Gateway]
C --&gt; D[Message Service]
D --&gt; E[Message Queue]
E --&gt; F[Channel Processors]
F --&gt; G[Email Service]
F --&gt; H[SMS Service]
F --&gt; I[WeChat Service]
D --&gt; J[Template Engine]
D --&gt; K[Scheduler Service]
F --&gt; L[Delivery Tracker]
L --&gt; M[Analytics DB]
D --&gt; N[Message Store]
</code>
</pre>

<h2 id="Core-Architecture-Components"><a href="#Core-Architecture-Components" class="headerlink" title="Core Architecture Components"></a>Core Architecture Components</h2><h3 id="Message-Notification-Service-API"><a href="#Message-Notification-Service-API" class="headerlink" title="Message Notification Service API"></a>Message Notification Service API</h3><p>The central service provides RESTful APIs for immediate and scheduled notifications:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;messageId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;msg_123456&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;recipients&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;userId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user_001&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;channels&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;email&quot;</span><span class="punctuation">,</span> <span class="string">&quot;sms&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user@example.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;phone&quot;</span><span class="punctuation">:</span> <span class="string">&quot;+1234567890&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;template&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;templateId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;welcome_template&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;variables&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;userName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;John Doe&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;activationLink&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://app.com/activate/xyz&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;priority&quot;</span><span class="punctuation">:</span> <span class="string">&quot;high&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;scheduledAt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-03-15T10:00:00Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;retryPolicy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;maxRetries&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;backoffMultiplier&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: Discuss idempotency here - each message should have a unique ID to prevent duplicate sends. This is crucial for financial notifications or critical alerts.</p>
<h3 id="Message-Queue-Architecture"><a href="#Message-Queue-Architecture" class="headerlink" title="Message Queue Architecture"></a>Message Queue Architecture</h3><p>The system uses Apache Kafka for high-throughput message processing with the following topic structure:</p>
<ul>
<li><code>notification.immediate</code> - Real-time notifications</li>
<li><code>notification.scheduled</code> - Scheduled notifications  </li>
<li><code>notification.retry</code> - Failed message retries</li>
<li><code>notification.dlq</code> - Dead letter queue for permanent failures</li>
</ul>
<pre>
<code class="mermaid">
flowchart LR
A[API Gateway] --&gt; B[Message Validator]
B --&gt; C{Message Type}
C --&gt;|Immediate| D[notification.immediate]
C --&gt;|Scheduled| E[notification.scheduled]
D --&gt; F[Channel Router]
E --&gt; G[Scheduler Service]
G --&gt; F
F --&gt; H[Email Processor]
F --&gt; I[SMS Processor]
F --&gt; J[WeChat Processor]
H --&gt; K[Email Provider]
I --&gt; L[SMS Provider]
J --&gt; M[WeChat API]
</code>
</pre>

<p><strong>Interview Insight</strong>: Explain partitioning strategy - partition by user ID for ordered processing per user, or by message type for parallel processing. The choice depends on whether message ordering matters for your use case.</p>
<h3 id="Template-Engine-Design"><a href="#Template-Engine-Design" class="headerlink" title="Template Engine Design"></a>Template Engine Design</h3><p>Templates support dynamic content injection with internationalization:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">templates:</span></span><br><span class="line">  <span class="attr">welcome_email:</span></span><br><span class="line">    <span class="attr">subject:</span> <span class="string">&quot;Welcome <span class="template-variable">&#123;&#123;userName&#125;&#125;</span> - <span class="template-variable">&#123;&#123;companyName&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">body:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      &lt;html&gt;</span></span><br><span class="line"><span class="string">        &lt;body&gt;</span></span><br><span class="line"><span class="string">          &lt;h1&gt;Welcome &#123;&#123;userName&#125;&#125;!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">          &lt;p&gt;Thank you for joining &#123;&#123;companyName&#125;&#125;.&lt;/p&gt;</span></span><br><span class="line"><span class="string">          &lt;a href=&quot;&#123;&#123;activationLink&#125;&#125;&quot;&gt;Activate Account&lt;/a&gt;</span></span><br><span class="line"><span class="string">        &lt;/body&gt;</span></span><br><span class="line"><span class="string">      &lt;/html&gt;</span></span><br><span class="line"><span class="string"></span>    <span class="attr">channels:</span> [<span class="string">&quot;email&quot;</span>]</span><br><span class="line">    <span class="attr">variables:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">userName:</span> <span class="string">required</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">companyName:</span> <span class="string">required</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">activationLink:</span> <span class="string">required</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">sms_verification:</span></span><br><span class="line">    <span class="attr">body:</span> <span class="string">&quot;Your <span class="template-variable">&#123;&#123;companyName&#125;&#125;</span> verification code: <span class="template-variable">&#123;&#123;code&#125;&#125;</span>. Valid for <span class="template-variable">&#123;&#123;expiry&#125;&#125;</span> minutes.&quot;</span></span><br><span class="line">    <span class="attr">channels:</span> [<span class="string">&quot;sms&quot;</span>]</span><br><span class="line">    <span class="attr">variables:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">companyName:</span> <span class="string">required</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">code:</span> <span class="string">required</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">expiry:</span> <span class="string">required</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: Template versioning is critical for production systems. Discuss A&#x2F;B testing capabilities where different template versions can be tested simultaneously to optimize engagement rates.</p>
<h2 id="Scalability-and-Performance"><a href="#Scalability-and-Performance" class="headerlink" title="Scalability and Performance"></a>Scalability and Performance</h2><h3 id="High-Volume-Message-Processing"><a href="#High-Volume-Message-Processing" class="headerlink" title="High-Volume Message Processing"></a>High-Volume Message Processing</h3><p>To handle 10 million messages daily (approximately 116 messages&#x2F;second average, 1000+ messages&#x2F;second peak):</p>
<p><strong>Horizontal Scaling Strategy</strong>:</p>
<ul>
<li>Multiple Kafka consumer groups for parallel processing</li>
<li>Channel-specific processors with independent scaling</li>
<li>Load balancing across processor instances</li>
</ul>
<p><strong>Performance Optimizations</strong>:</p>
<ul>
<li>Connection pooling for external APIs</li>
<li>Batch processing for similar notifications</li>
<li>Asynchronous processing with circuit breakers</li>
</ul>
<pre>
<code class="mermaid">
sequenceDiagram
participant BS as Business Service
participant SDK as Notification SDK
participant API as API Gateway
participant MQ as Message Queue
participant CP as Channel Processor
participant EP as Email Provider

BS-&gt;&gt;SDK: sendNotification(request)
SDK-&gt;&gt;API: POST &#x2F;notifications
API-&gt;&gt;API: Validate &amp; Enrich
API-&gt;&gt;MQ: Publish message
API--&gt;&gt;SDK: messageId (async)
SDK--&gt;&gt;BS: messageId

MQ-&gt;&gt;CP: Consume message
CP-&gt;&gt;CP: Apply template
CP-&gt;&gt;EP: Send email
EP--&gt;&gt;CP: Delivery status
CP-&gt;&gt;MQ: Update delivery status
</code>
</pre>

<p><strong>Interview Insight</strong>: Discuss the CAP theorem application - in notification systems, we choose availability and partition tolerance over consistency. It’s better to potentially send a duplicate notification than to miss sending one entirely.</p>
<h3 id="Caching-Strategy"><a href="#Caching-Strategy" class="headerlink" title="Caching Strategy"></a>Caching Strategy</h3><p><strong>Multi-Level Caching</strong>:</p>
<ul>
<li><strong>Template Cache</strong>: Redis cluster for compiled templates</li>
<li><strong>User Preference Cache</strong>: User notification preferences and contact info</li>
<li><strong>Rate Limiting Cache</strong>: Sliding window counters for rate limiting</li>
</ul>
<h2 id="Channel-Specific-Implementations"><a href="#Channel-Specific-Implementations" class="headerlink" title="Channel-Specific Implementations"></a>Channel-Specific Implementations</h2><h3 id="Email-Service"><a href="#Email-Service" class="headerlink" title="Email Service"></a>Email Service</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmailChannelProcessor</span> <span class="keyword">implements</span> <span class="title class_">ChannelProcessor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmailProviderFactory providerFactory;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DeliveryResult <span class="title function_">process</span><span class="params">(NotificationMessage message)</span> &#123;</span><br><span class="line">        <span class="type">EmailProvider</span> <span class="variable">provider</span> <span class="operator">=</span> providerFactory.getProvider(message.getPriority());</span><br><span class="line">        </span><br><span class="line">        <span class="type">EmailContent</span> <span class="variable">content</span> <span class="operator">=</span> templateEngine.render(</span><br><span class="line">            message.getTemplateId(), </span><br><span class="line">            message.getVariables()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> provider.send(EmailRequest.builder()</span><br><span class="line">            .to(message.getRecipient().getEmail())</span><br><span class="line">            .subject(content.getSubject())</span><br><span class="line">            .htmlBody(content.getBody())</span><br><span class="line">            .priority(message.getPriority())</span><br><span class="line">            .build());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Provider Failover Strategy</strong>:</p>
<ul>
<li>Primary: AWS SES (high volume, cost-effective)</li>
<li>Secondary: SendGrid (reliability backup)</li>
<li>Tertiary: Mailgun (final fallback)</li>
</ul>
<h3 id="SMS-Service-Implementation"><a href="#SMS-Service-Implementation" class="headerlink" title="SMS Service Implementation"></a>SMS Service Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SmsChannelProcessor</span> <span class="keyword">implements</span> <span class="title class_">ChannelProcessor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DeliveryResult <span class="title function_">process</span><span class="params">(NotificationMessage message)</span> &#123;</span><br><span class="line">        <span class="comment">// Route based on country code for optimal delivery rates</span></span><br><span class="line">        <span class="type">SmsProvider</span> <span class="variable">provider</span> <span class="operator">=</span> routingService.selectProvider(</span><br><span class="line">            message.getRecipient().getPhoneNumber()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="type">SmsContent</span> <span class="variable">content</span> <span class="operator">=</span> templateEngine.render(</span><br><span class="line">            message.getTemplateId(),</span><br><span class="line">            message.getVariables()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> provider.send(SmsRequest.builder()</span><br><span class="line">            .to(message.getRecipient().getPhoneNumber())</span><br><span class="line">            .message(content.getMessage())</span><br><span class="line">            .build());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: SMS routing is geography-dependent. Different providers have better delivery rates in different regions. Discuss how you’d implement intelligent routing based on phone number analysis.</p>
<h3 id="WeChat-Integration"><a href="#WeChat-Integration" class="headerlink" title="WeChat Integration"></a>WeChat Integration</h3><p>WeChat requires special handling due to its ecosystem:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeChatChannelProcessor</span> <span class="keyword">implements</span> <span class="title class_">ChannelProcessor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DeliveryResult <span class="title function_">process</span><span class="params">(NotificationMessage message)</span> &#123;</span><br><span class="line">        <span class="comment">// WeChat template messages have strict formatting requirements</span></span><br><span class="line">        <span class="type">WeChatTemplate</span> <span class="variable">template</span> <span class="operator">=</span> weChatTemplateService.getTemplate(</span><br><span class="line">            message.getTemplateId()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="type">WeChatMessage</span> <span class="variable">weChatMessage</span> <span class="operator">=</span> WeChatMessage.builder()</span><br><span class="line">            .openId(message.getRecipient().getWeChatOpenId())</span><br><span class="line">            .templateId(template.getWeChatTemplateId())</span><br><span class="line">            .data(transformVariables(message.getVariables()))</span><br><span class="line">            .build();</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> weChatApiClient.sendTemplateMessage(weChatMessage);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Scheduling-and-Delivery-Management"><a href="#Scheduling-and-Delivery-Management" class="headerlink" title="Scheduling and Delivery Management"></a>Scheduling and Delivery Management</h2><h3 id="Scheduler-Service-Architecture"><a href="#Scheduler-Service-Architecture" class="headerlink" title="Scheduler Service Architecture"></a>Scheduler Service Architecture</h3><pre>
<code class="mermaid">
flowchart TD
A[Scheduled Messages] --&gt; B[Time-based Partitioner]
B --&gt; C[Quartz Scheduler Cluster]
C --&gt; D[Message Trigger]
D --&gt; E{Delivery Window?}
E --&gt;|Yes| F[Send to Processing Queue]
E --&gt;|No| G[Reschedule]
F --&gt; H[Channel Processors]
G --&gt; A
</code>
</pre>

<p><strong>Delivery Window Management</strong>:</p>
<ul>
<li>Timezone-aware scheduling</li>
<li>Business hours enforcement</li>
<li>Frequency capping to prevent spam</li>
</ul>
<h3 id="Retry-and-Failure-Handling"><a href="#Retry-and-Failure-Handling" class="headerlink" title="Retry and Failure Handling"></a>Retry and Failure Handling</h3><p><strong>Exponential Backoff Strategy</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RetryPolicyManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> RetryPolicy <span class="title function_">getRetryPolicy</span><span class="params">(ChannelType channel, FailureReason reason)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> RetryPolicy.builder()</span><br><span class="line">            .maxRetries(getMaxRetries(channel, reason))</span><br><span class="line">            .initialDelay(Duration.ofSeconds(<span class="number">30</span>))</span><br><span class="line">            .backoffMultiplier(<span class="number">2.0</span>)</span><br><span class="line">            .maxDelay(Duration.ofHours(<span class="number">4</span>))</span><br><span class="line">            .jitter(<span class="number">0.1</span>)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getMaxRetries</span><span class="params">(ChannelType channel, FailureReason reason)</span> &#123;</span><br><span class="line">        <span class="comment">// Email: 3 retries for transient failures, 0 for invalid addresses</span></span><br><span class="line">        <span class="comment">// SMS: 2 retries for network issues, 0 for invalid numbers  </span></span><br><span class="line">        <span class="comment">// WeChat: 3 retries for API limits, 1 for user blocks</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: Discuss the importance of classifying failures - temporary vs permanent. Retrying an invalid email address wastes resources, while network timeouts should be retried with backoff.</p>
<h2 id="MessageNotificationSDK-Design"><a href="#MessageNotificationSDK-Design" class="headerlink" title="MessageNotificationSDK Design"></a>MessageNotificationSDK Design</h2><h3 id="SDK-Architecture"><a href="#SDK-Architecture" class="headerlink" title="SDK Architecture"></a>SDK Architecture</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageNotificationSDK</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> NotificationClient notificationClient;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CircuitBreaker circuitBreaker;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;MessageResult&gt; <span class="title function_">sendNotification</span><span class="params">(NotificationRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> circuitBreaker.executeAsync(() -&gt; </span><br><span class="line">            notificationClient.sendNotification(request)</span><br><span class="line">        ).exceptionally(throwable -&gt; &#123;</span><br><span class="line">            <span class="comment">// Fallback: store in local queue for retry</span></span><br><span class="line">            localQueueService.enqueue(request);</span><br><span class="line">            <span class="keyword">return</span> MessageResult.queued(request.getMessageId());</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;MessageResult&gt; <span class="title function_">sendScheduledNotification</span><span class="params">(</span></span><br><span class="line"><span class="params">        NotificationRequest request, </span></span><br><span class="line"><span class="params">        Instant scheduledTime</span></span><br><span class="line"><span class="params">    )</span> &#123;</span><br><span class="line">        <span class="type">ScheduledNotificationRequest</span> <span class="variable">scheduledRequest</span> <span class="operator">=</span> </span><br><span class="line">            ScheduledNotificationRequest.builder()</span><br><span class="line">                .notificationRequest(request)</span><br><span class="line">                .scheduledAt(scheduledTime)</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">return</span> notificationClient.scheduleNotification(scheduledRequest);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SDK-Configuration"><a href="#SDK-Configuration" class="headerlink" title="SDK Configuration"></a>SDK Configuration</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">notification:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">baseUrl:</span> <span class="string">https://notifications.company.com</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">30s</span></span><br><span class="line">    <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">circuit-breaker:</span></span><br><span class="line">    <span class="attr">failure-threshold:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">recovery-timeout:</span> <span class="string">60s</span></span><br><span class="line">  <span class="attr">local-queue:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">max-size:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">flush-interval:</span> <span class="string">30s</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: The SDK should be resilient to service unavailability. Discuss local queuing, circuit breakers, and graceful degradation strategies.</p>
<h2 id="Monitoring-and-Observability"><a href="#Monitoring-and-Observability" class="headerlink" title="Monitoring and Observability"></a>Monitoring and Observability</h2><h3 id="Key-Metrics-Dashboard"><a href="#Key-Metrics-Dashboard" class="headerlink" title="Key Metrics Dashboard"></a>Key Metrics Dashboard</h3><p><strong>Throughput Metrics</strong>:</p>
<ul>
<li>Messages processed per second by channel</li>
<li>Queue depth and processing latency</li>
<li>Template rendering performance</li>
</ul>
<p><strong>Delivery Metrics</strong>:</p>
<ul>
<li>Delivery success rate by channel and provider</li>
<li>Bounce and failure rates</li>
<li>Time to delivery distribution</li>
</ul>
<p><strong>Business Metrics</strong>:</p>
<ul>
<li>User engagement rates</li>
<li>Opt-out rates by channel</li>
<li>Cost per notification by channel</li>
</ul>
<pre>
<code class="mermaid">
graph LR
A[Notification Service] --&gt; B[Metrics Collector]
B --&gt; C[Prometheus]
C --&gt; D[Grafana Dashboard]
B --&gt; E[Application Logs]
E --&gt; F[ELK Stack]
B --&gt; G[Distributed Tracing]
G --&gt; H[Jaeger]
</code>
</pre>

<h3 id="Alerting-Strategy"><a href="#Alerting-Strategy" class="headerlink" title="Alerting Strategy"></a>Alerting Strategy</h3><p><strong>Critical Alerts</strong>:</p>
<ul>
<li>Queue depth &gt; 10,000 messages</li>
<li>Delivery success rate &lt; 95%</li>
<li>Provider API failure rate &gt; 5%</li>
</ul>
<p><strong>Warning Alerts</strong>:</p>
<ul>
<li>Processing latency &gt; 30 seconds</li>
<li>Template rendering errors</li>
<li>Unusual bounce rate increases</li>
</ul>
<h2 id="Security-and-Compliance"><a href="#Security-and-Compliance" class="headerlink" title="Security and Compliance"></a>Security and Compliance</h2><h3 id="Data-Protection"><a href="#Data-Protection" class="headerlink" title="Data Protection"></a>Data Protection</h3><p><strong>Encryption</strong>:</p>
<ul>
<li>At-rest: AES-256 encryption for stored messages</li>
<li>In-transit: TLS 1.3 for all API communications</li>
<li>PII masking in logs and metrics</li>
</ul>
<p><strong>Access Control</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreAuthorize(&quot;hasRole(&#x27;NOTIFICATION_ADMIN&#x27;) or hasPermission(#request.userId, &#x27;SEND_NOTIFICATION&#x27;)&quot;)</span></span><br><span class="line"><span class="keyword">public</span> MessageResult <span class="title function_">sendNotification</span><span class="params">(NotificationRequest request)</span> &#123;</span><br><span class="line">    <span class="comment">// Implementation</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Compliance-Considerations"><a href="#Compliance-Considerations" class="headerlink" title="Compliance Considerations"></a>Compliance Considerations</h3><p><strong>GDPR Compliance</strong>:</p>
<ul>
<li>Right to be forgotten: Automatic message deletion after retention period</li>
<li>Consent management: Integration with preference center</li>
<li>Data minimization: Only store necessary message data</li>
</ul>
<p><strong>CAN-SPAM Act</strong>:</p>
<ul>
<li>Automatic unsubscribe link injection</li>
<li>Sender identification requirements</li>
<li>Opt-out processing within 10 business days</li>
</ul>
<p><strong>Interview Insight</strong>: Security should be built-in, not bolted-on. Discuss defense in depth - encryption, authentication, authorization, input validation, and audit logging at every layer.</p>
<h2 id="Performance-Benchmarks-and-Capacity-Planning"><a href="#Performance-Benchmarks-and-Capacity-Planning" class="headerlink" title="Performance Benchmarks and Capacity Planning"></a>Performance Benchmarks and Capacity Planning</h2><h3 id="Load-Testing-Results"><a href="#Load-Testing-Results" class="headerlink" title="Load Testing Results"></a>Load Testing Results</h3><p><strong>Target Performance</strong>:</p>
<ul>
<li>10M messages&#x2F;day &#x3D; 115 messages&#x2F;second average</li>
<li>Peak capacity: 1,000 messages&#x2F;second</li>
<li>99th percentile latency: &lt; 100ms for API calls</li>
<li>95th percentile delivery time: &lt; 30 seconds</li>
</ul>
<p><strong>Scaling Calculations</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Email Channel:</span><br><span class="line">- Provider rate limit: 1000 emails/second</span><br><span class="line">- Buffer factor: 2x for burst capacity</span><br><span class="line">- Required instances: 2 (with failover)</span><br><span class="line"></span><br><span class="line">SMS Channel:  </span><br><span class="line">- Provider rate limit: 100 SMS/second</span><br><span class="line">- Peak SMS load: ~200/second (20% of total)</span><br><span class="line">- Required instances: 4 (with geographic distribution)</span><br></pre></td></tr></table></figure>

<h3 id="Database-Sizing"><a href="#Database-Sizing" class="headerlink" title="Database Sizing"></a>Database Sizing</h3><p><strong>Message Storage Requirements</strong>:</p>
<ul>
<li>10M messages&#x2F;day × 2KB average size &#x3D; 20GB&#x2F;day</li>
<li>90-day retention &#x3D; 1.8TB storage requirement</li>
<li>With replication and indexes: 5TB total</li>
</ul>
<h2 id="Cost-Optimization-Strategies"><a href="#Cost-Optimization-Strategies" class="headerlink" title="Cost Optimization Strategies"></a>Cost Optimization Strategies</h2><h3 id="Provider-Cost-Management"><a href="#Provider-Cost-Management" class="headerlink" title="Provider Cost Management"></a>Provider Cost Management</h3><p><strong>Email Costs</strong>:</p>
<ul>
<li>AWS SES: $0.10 per 1,000 emails</li>
<li>SendGrid: $0.20 per 1,000 emails  </li>
<li>Strategy: Primary on SES, failover to SendGrid</li>
</ul>
<p><strong>SMS Costs</strong>:</p>
<ul>
<li>Twilio US: $0.0075 per SMS</li>
<li>International routing for cost optimization</li>
<li>Bulk messaging discounts negotiation</li>
</ul>
<p><strong>Infrastructure Costs</strong>:</p>
<ul>
<li>Kafka cluster: $500&#x2F;month</li>
<li>Application servers: $800&#x2F;month</li>
<li>Database: $300&#x2F;month</li>
<li>Monitoring: $200&#x2F;month</li>
<li><strong>Total</strong>: ~$1,800&#x2F;month for 10M messages</li>
</ul>
<p><strong>Interview Insight</strong>: Always discuss cost optimization in system design. Show understanding of the business impact - a 10% improvement in delivery rates might justify 50% higher costs if it drives revenue.</p>
<h2 id="Testing-Strategy"><a href="#Testing-Strategy" class="headerlink" title="Testing Strategy"></a>Testing Strategy</h2><h3 id="Integration-Testing"><a href="#Integration-Testing" class="headerlink" title="Integration Testing"></a>Integration Testing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@TestcontainersConfiguration</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NotificationServiceIntegrationTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldProcessHighVolumeNotifications</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Simulate 1000 concurrent notification requests</span></span><br><span class="line">        List&lt;CompletableFuture&lt;MessageResult&gt;&gt; futures = IntStream.range(<span class="number">0</span>, <span class="number">1000</span>)</span><br><span class="line">            .mapToObj(i -&gt; notificationService.sendNotification(createTestRequest(i)))</span><br><span class="line">            .collect(toList());</span><br><span class="line">            </span><br><span class="line">        CompletableFuture.allOf(futures.toArray(<span class="keyword">new</span> <span class="title class_">CompletableFuture</span>[<span class="number">0</span>]))</span><br><span class="line">            .join();</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// Verify all messages processed within SLA</span></span><br><span class="line">        assertThat(futures).allSatisfy(future -&gt; </span><br><span class="line">            assertThat(future.get().getStatus()).isEqualTo(DELIVERED)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Chaos-Engineering"><a href="#Chaos-Engineering" class="headerlink" title="Chaos Engineering"></a>Chaos Engineering</h3><p><strong>Failure Scenarios</strong>:</p>
<ul>
<li>Provider API timeouts and rate limiting</li>
<li>Database connection failures</li>
<li>Kafka broker failures</li>
<li>Network partitions between services</li>
</ul>
<h2 id="Future-Enhancements"><a href="#Future-Enhancements" class="headerlink" title="Future Enhancements"></a>Future Enhancements</h2><h3 id="Advanced-Features-Roadmap"><a href="#Advanced-Features-Roadmap" class="headerlink" title="Advanced Features Roadmap"></a>Advanced Features Roadmap</h3><p><strong>Machine Learning Integration</strong>:</p>
<ul>
<li>Optimal send time prediction per user</li>
<li>Template A&#x2F;B testing automation</li>
<li>Delivery success rate optimization</li>
</ul>
<p><strong>Rich Media Support</strong>:</p>
<ul>
<li>Image and video attachments</li>
<li>Interactive email templates</li>
<li>Push notification rich media</li>
</ul>
<p><strong>Advanced Analytics</strong>:</p>
<ul>
<li>User engagement scoring</li>
<li>Campaign performance analytics</li>
<li>Predictive churn analysis</li>
</ul>
<p><strong>Interview Insight</strong>: Always end system design discussions with future considerations. This shows forward thinking and understanding that systems evolve. Discuss how your current architecture would accommodate these enhancements.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>This Message Notification Service design provides a robust, scalable foundation for high-volume, multi-channel notifications. The architecture emphasizes reliability, observability, and maintainability while meeting the 10 million messages per day requirement with room for growth.</p>
<p>Key design principles applied:</p>
<ul>
<li><strong>Decoupling</strong>: Message queues separate concerns and enable independent scaling</li>
<li><strong>Reliability</strong>: Multiple failover mechanisms and retry strategies</li>
<li><strong>Observability</strong>: Comprehensive monitoring and alerting</li>
<li><strong>Security</strong>: Built-in encryption, access control, and compliance features</li>
<li><strong>Cost Efficiency</strong>: Provider optimization and resource right-sizing</li>
</ul>
<p>The system can be deployed incrementally, starting with core notification functionality and adding advanced features as business needs evolve.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/13/Design-Multi-Tenant-Database-SDK/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/13/Design-Multi-Tenant-Database-SDK/" class="post-title-link" itemprop="url">Design Multi-Tenant Database SDK</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-13 18:40:02" itemprop="dateCreated datePublished" datetime="2025-06-13T18:40:02+08:00">2025-06-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-29 13:36:32" itemprop="dateModified" datetime="2025-06-29T13:36:32+08:00">2025-06-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system-design/" itemprop="url" rel="index"><span itemprop="name">system-design</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Overview-and-Architecture"><a href="#Overview-and-Architecture" class="headerlink" title="Overview and Architecture"></a>Overview and Architecture</h2><p>A Multi-Tenant Database SDK is a critical component in modern SaaS architectures that enables applications to dynamically manage database connections and operations across multiple tenants. This SDK provides a unified interface for database operations while maintaining tenant isolation and optimizing resource utilization through connection pooling and runtime datasource switching.</p>
<h3 id="Core-Architecture-Components"><a href="#Core-Architecture-Components" class="headerlink" title="Core Architecture Components"></a>Core Architecture Components</h3><pre>
<code class="mermaid">
graph TB
A[SaaS Application] --&gt; B[Multi-Tenant SDK]
B --&gt; C[Tenant Context Manager]
B --&gt; D[Connection Pool Manager]
B --&gt; E[Database Provider Factory]

C --&gt; F[ThreadLocal Storage]
D --&gt; G[MySQL Connection Pool]
D --&gt; H[PostgreSQL Connection Pool]

E --&gt; I[MySQL Provider]
E --&gt; J[PostgreSQL Provider]

I --&gt; K[(MySQL Database)]
J --&gt; L[(PostgreSQL Database)]

B --&gt; M[SPI Registry]
M --&gt; N[Database Provider Interface]
N --&gt; I
N --&gt; J
</code>
</pre>

<p><strong>Interview Insight</strong>: <em>“How would you design a multi-tenant database architecture?”</em></p>
<p>The key is to balance tenant isolation with resource efficiency. Our SDK uses a <strong>database-per-tenant</strong> approach with dynamic datasource switching, which provides strong isolation while maintaining performance through connection pooling.</p>
<h2 id="Tenant-Context-Management"><a href="#Tenant-Context-Management" class="headerlink" title="Tenant Context Management"></a>Tenant Context Management</h2><h3 id="ThreadLocal-Implementation"><a href="#ThreadLocal-Implementation" class="headerlink" title="ThreadLocal Implementation"></a>ThreadLocal Implementation</h3><p>The tenant context is stored using ThreadLocal to ensure thread-safe tenant identification throughout the request lifecycle.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantContext</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; TENANT_ID = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; DATABASE_NAME = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setTenant</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        TENANT_ID.set(tenantId);</span><br><span class="line">        DATABASE_NAME.set(<span class="string">&quot;tenant_&quot;</span> + tenantId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getCurrentTenant</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> TENANT_ID.get();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getCurrentDatabase</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DATABASE_NAME.get();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span> &#123;</span><br><span class="line">        TENANT_ID.remove();</span><br><span class="line">        DATABASE_NAME.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Tenant-Context-Interceptor"><a href="#Tenant-Context-Interceptor" class="headerlink" title="Tenant Context Interceptor"></a>Tenant Context Interceptor</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantContextInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, </span></span><br><span class="line"><span class="params">                           HttpServletResponse response, </span></span><br><span class="line"><span class="params">                           Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> extractTenantId(request);</span><br><span class="line">        <span class="keyword">if</span> (tenantId != <span class="literal">null</span>) &#123;</span><br><span class="line">            TenantContext.setTenant(tenantId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, </span></span><br><span class="line"><span class="params">                              HttpServletResponse response, </span></span><br><span class="line"><span class="params">                              Object handler, Exception ex)</span> &#123;</span><br><span class="line">        TenantContext.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">extractTenantId</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="comment">// Extract from header, JWT token, or subdomain</span></span><br><span class="line">        <span class="keyword">return</span> request.getHeader(<span class="string">&quot;X-Tenant-ID&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“Why use ThreadLocal for tenant context?”</em></p>
<p>ThreadLocal ensures that each request thread maintains its own tenant context without interference from other concurrent requests. This is crucial in multi-threaded web applications where multiple tenants’ requests are processed simultaneously.</p>
<h2 id="Connection-Pool-Management"><a href="#Connection-Pool-Management" class="headerlink" title="Connection Pool Management"></a>Connection Pool Management</h2><h3 id="Dynamic-DataSource-Configuration"><a href="#Dynamic-DataSource-Configuration" class="headerlink" title="Dynamic DataSource Configuration"></a>Dynamic DataSource Configuration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiTenantDataSourceConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">multiTenantDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MultiTenantDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MultiTenantDataSource</span>();</span><br><span class="line">        dataSource.setDefaultTargetDataSource(createDefaultDataSource());</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ConnectionPoolManager <span class="title function_">connectionPoolManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConnectionPoolManager</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Connection-Pool-Manager-Implementation"><a href="#Connection-Pool-Manager-Implementation" class="headerlink" title="Connection Pool Manager Implementation"></a>Connection Pool Manager Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConnectionPoolManager</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, HikariDataSource&gt; dataSources = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DatabaseProviderFactory providerFactory;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ConnectionPoolManager</span><span class="params">(DatabaseProviderFactory providerFactory)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.providerFactory = providerFactory;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">getDataSource</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> dataSources.computeIfAbsent(tenantId, <span class="built_in">this</span>::createDataSource);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> HikariDataSource <span class="title function_">createDataSource</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="type">TenantConfig</span> <span class="variable">config</span> <span class="operator">=</span> getTenantConfig(tenantId);</span><br><span class="line">        <span class="type">DatabaseProvider</span> <span class="variable">provider</span> <span class="operator">=</span> providerFactory.getProvider(config.getDatabaseType());</span><br><span class="line">        </span><br><span class="line">        <span class="type">HikariConfig</span> <span class="variable">hikariConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HikariConfig</span>();</span><br><span class="line">        hikariConfig.setJdbcUrl(provider.buildJdbcUrl(config));</span><br><span class="line">        hikariConfig.setUsername(config.getUsername());</span><br><span class="line">        hikariConfig.setPassword(config.getPassword());</span><br><span class="line">        hikariConfig.setMaximumPoolSize(config.getMaxPoolSize());</span><br><span class="line">        hikariConfig.setMinimumIdle(config.getMinIdle());</span><br><span class="line">        hikariConfig.setConnectionTimeout(config.getConnectionTimeout());</span><br><span class="line">        hikariConfig.setIdleTimeout(config.getIdleTimeout());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HikariDataSource</span>(hikariConfig);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">closeTenantDataSource</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="type">HikariDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> dataSources.remove(tenantId);</span><br><span class="line">        <span class="keyword">if</span> (dataSource != <span class="literal">null</span>) &#123;</span><br><span class="line">            dataSource.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“How do you handle connection pool sizing for multiple tenants?”</em></p>
<p>We use adaptive pool sizing based on tenant usage patterns. Each tenant gets a dedicated connection pool with configurable min&#x2F;max connections. Monitor pool metrics and adjust dynamically based on tenant activity.</p>
<h2 id="Database-Provider-Implementation-via-SPI"><a href="#Database-Provider-Implementation-via-SPI" class="headerlink" title="Database Provider Implementation via SPI"></a>Database Provider Implementation via SPI</h2><h3 id="Service-Provider-Interface"><a href="#Service-Provider-Interface" class="headerlink" title="Service Provider Interface"></a>Service Provider Interface</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DatabaseProvider</span> &#123;</span><br><span class="line">    String <span class="title function_">getProviderName</span><span class="params">()</span>;</span><br><span class="line">    String <span class="title function_">buildJdbcUrl</span><span class="params">(TenantConfig config)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createTenantDatabase</span><span class="params">(TenantConfig config)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createTenantTables</span><span class="params">(String tenantId, List&lt;String&gt; tableSchemas)</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">supportsBatch</span><span class="params">()</span>;</span><br><span class="line">    String <span class="title function_">getDriverClassName</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="MySQL-Provider-Implementation"><a href="#MySQL-Provider-Implementation" class="headerlink" title="MySQL Provider Implementation"></a>MySQL Provider Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySQLDatabaseProvider</span> <span class="keyword">implements</span> <span class="title class_">DatabaseProvider</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getProviderName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;mysql&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">buildJdbcUrl</span><span class="params">(TenantConfig config)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;jdbc:mysql://%s:%d/%s?useSSL=true&amp;serverTimezone=UTC&quot;</span>,</span><br><span class="line">                config.getHost(), config.getPort(), config.getDatabaseName());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createTenantDatabase</span><span class="params">(TenantConfig config)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> getAdminConnection(config)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;CREATE DATABASE IF NOT EXISTS &quot;</span> + config.getDatabaseName() + </span><br><span class="line">                        <span class="string">&quot; CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci&quot;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> (<span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> connection.createStatement()) &#123;</span><br><span class="line">                stmt.execute(sql);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DatabaseException</span>(<span class="string">&quot;Failed to create MySQL database for tenant: &quot;</span> + </span><br><span class="line">                                      config.getTenantId(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createTenantTables</span><span class="params">(String tenantId, List&lt;String&gt; tableSchemas)</span> &#123;</span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> connectionPoolManager.getDataSource(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection()) &#123;</span><br><span class="line">            connection.setAutoCommit(<span class="literal">false</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (String schema : tableSchemas) &#123;</span><br><span class="line">                <span class="keyword">try</span> (<span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> connection.createStatement()) &#123;</span><br><span class="line">                    stmt.execute(schema);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            connection.commit();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DatabaseException</span>(<span class="string">&quot;Failed to create tables for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDriverClassName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PostgreSQL-Provider-Implementation"><a href="#PostgreSQL-Provider-Implementation" class="headerlink" title="PostgreSQL Provider Implementation"></a>PostgreSQL Provider Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PostgreSQLDatabaseProvider</span> <span class="keyword">implements</span> <span class="title class_">DatabaseProvider</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getProviderName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;postgresql&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">buildJdbcUrl</span><span class="params">(TenantConfig config)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;jdbc:postgresql://%s:%d/%s&quot;</span>,</span><br><span class="line">                config.getHost(), config.getPort(), config.getDatabaseName());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createTenantDatabase</span><span class="params">(TenantConfig config)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> getAdminConnection(config)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;CREATE DATABASE &quot;</span> + config.getDatabaseName() + </span><br><span class="line">                        <span class="string">&quot; WITH ENCODING &#x27;UTF8&#x27; LC_COLLATE=&#x27;en_US.UTF-8&#x27; LC_CTYPE=&#x27;en_US.UTF-8&#x27;&quot;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> (<span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> connection.createStatement()) &#123;</span><br><span class="line">                stmt.execute(sql);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DatabaseException</span>(<span class="string">&quot;Failed to create PostgreSQL database for tenant: &quot;</span> + </span><br><span class="line">                                      config.getTenantId(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createTenantTables</span><span class="params">(String tenantId, List&lt;String&gt; tableSchemas)</span> &#123;</span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> connectionPoolManager.getDataSource(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection()) &#123;</span><br><span class="line">            connection.setAutoCommit(<span class="literal">false</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (String schema : tableSchemas) &#123;</span><br><span class="line">                <span class="keyword">try</span> (<span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> connection.createStatement()) &#123;</span><br><span class="line">                    stmt.execute(schema);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            connection.commit();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DatabaseException</span>(<span class="string">&quot;Failed to create tables for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDriverClassName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;org.postgresql.Driver&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SPI-Registry-and-Factory"><a href="#SPI-Registry-and-Factory" class="headerlink" title="SPI Registry and Factory"></a>SPI Registry and Factory</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseProviderFactory</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, DatabaseProvider&gt; providers = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initializeProviders</span><span class="params">()</span> &#123;</span><br><span class="line">        ServiceLoader&lt;DatabaseProvider&gt; serviceLoader = ServiceLoader.load(DatabaseProvider.class);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (DatabaseProvider provider : serviceLoader) &#123;</span><br><span class="line">            providers.put(provider.getProviderName(), provider);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> DatabaseProvider <span class="title function_">getProvider</span><span class="params">(String providerName)</span> &#123;</span><br><span class="line">        <span class="type">DatabaseProvider</span> <span class="variable">provider</span> <span class="operator">=</span> providers.get(providerName.toLowerCase());</span><br><span class="line">        <span class="keyword">if</span> (provider == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedDatabaseException</span>(<span class="string">&quot;Database provider not found: &quot;</span> + providerName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> provider;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Set&lt;String&gt; <span class="title function_">getSupportedProviders</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> providers.keySet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“Why use SPI pattern for database providers?”</em></p>
<p>SPI (Service Provider Interface) enables loose coupling and extensibility. New database providers can be added without modifying existing code, following the Open&#x2F;Closed Principle. It also allows for plugin-based architecture where providers can be loaded dynamically.</p>
<h2 id="Multi-Tenant-Database-Operations"><a href="#Multi-Tenant-Database-Operations" class="headerlink" title="Multi-Tenant Database Operations"></a>Multi-Tenant Database Operations</h2><h3 id="Core-SDK-Interface"><a href="#Core-SDK-Interface" class="headerlink" title="Core SDK Interface"></a>Core SDK Interface</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MultiTenantDatabaseSDK</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createTenant</span><span class="params">(String tenantId, TenantConfig config)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deleteTenant</span><span class="params">(String tenantId)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">executeSql</span><span class="params">(String sql, Object... params)</span>;</span><br><span class="line">    &lt;T&gt; List&lt;T&gt; <span class="title function_">query</span><span class="params">(String sql, RowMapper&lt;T&gt; rowMapper, Object... params)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">executeBatch</span><span class="params">(List&lt;String&gt; sqlStatements)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">executeTransaction</span><span class="params">(TransactionCallback callback)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SDK-Implementation"><a href="#SDK-Implementation" class="headerlink" title="SDK Implementation"></a>SDK Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiTenantDatabaseSDKImpl</span> <span class="keyword">implements</span> <span class="title class_">MultiTenantDatabaseSDK</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConnectionPoolManager connectionPoolManager;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DatabaseProviderFactory providerFactory;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TenantConfigRepository tenantConfigRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createTenant</span><span class="params">(String tenantId, TenantConfig config)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Create database</span></span><br><span class="line">            <span class="type">DatabaseProvider</span> <span class="variable">provider</span> <span class="operator">=</span> providerFactory.getProvider(config.getDatabaseType());</span><br><span class="line">            provider.createTenantDatabase(config);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Create tables</span></span><br><span class="line">            List&lt;String&gt; tableSchemas = loadTableSchemas();</span><br><span class="line">            provider.createTenantTables(tenantId, tableSchemas);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Save tenant configuration</span></span><br><span class="line">            tenantConfigRepository.save(config);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Initialize connection pool</span></span><br><span class="line">            connectionPoolManager.getDataSource(tenantId);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TenantCreationException</span>(<span class="string">&quot;Failed to create tenant: &quot;</span> + tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeSql</span><span class="params">(String sql, Object... params)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> TenantContext.getCurrentTenant();</span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> connectionPoolManager.getDataSource(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection();</span><br><span class="line">             <span class="type">PreparedStatement</span> <span class="variable">stmt</span> <span class="operator">=</span> connection.prepareStatement(sql)) &#123;</span><br><span class="line">            </span><br><span class="line">            setParameters(stmt, params);</span><br><span class="line">            stmt.execute();</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DatabaseException</span>(<span class="string">&quot;Failed to execute SQL for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; List&lt;T&gt; <span class="title function_">query</span><span class="params">(String sql, RowMapper&lt;T&gt; rowMapper, Object... params)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> TenantContext.getCurrentTenant();</span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> connectionPoolManager.getDataSource(tenantId);</span><br><span class="line">        </span><br><span class="line">        List&lt;T&gt; results = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection();</span><br><span class="line">             <span class="type">PreparedStatement</span> <span class="variable">stmt</span> <span class="operator">=</span> connection.prepareStatement(sql)) &#123;</span><br><span class="line">            </span><br><span class="line">            setParameters(stmt, params);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> (<span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> stmt.executeQuery()) &#123;</span><br><span class="line">                <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">                    results.add(rowMapper.mapRow(rs));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DatabaseException</span>(<span class="string">&quot;Failed to query for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> results;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeTransaction</span><span class="params">(TransactionCallback callback)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> TenantContext.getCurrentTenant();</span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> connectionPoolManager.getDataSource(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection()) &#123;</span><br><span class="line">            connection.setAutoCommit(<span class="literal">false</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                callback.doInTransaction(connection);</span><br><span class="line">                connection.commit();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                connection.rollback();</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DatabaseException</span>(<span class="string">&quot;Transaction failed for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Production-Use-Cases-and-Examples"><a href="#Production-Use-Cases-and-Examples" class="headerlink" title="Production Use Cases and Examples"></a>Production Use Cases and Examples</h2><h3 id="Use-Case-1-SaaS-CRM-System"><a href="#Use-Case-1-SaaS-CRM-System" class="headerlink" title="Use Case 1: SaaS CRM System"></a>Use Case 1: SaaS CRM System</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/customers&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MultiTenantDatabaseSDK databaseSDK;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Customer&gt; <span class="title function_">getCustomers</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> databaseSDK.query(</span><br><span class="line">            <span class="string">&quot;SELECT * FROM customers WHERE active = ?&quot;</span>,</span><br><span class="line">            (rs) -&gt; <span class="keyword">new</span> <span class="title class_">Customer</span>(</span><br><span class="line">                rs.getLong(<span class="string">&quot;id&quot;</span>),</span><br><span class="line">                rs.getString(<span class="string">&quot;name&quot;</span>),</span><br><span class="line">                rs.getString(<span class="string">&quot;email&quot;</span>)</span><br><span class="line">            ),</span><br><span class="line">            <span class="literal">true</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createCustomer</span><span class="params">(<span class="meta">@RequestBody</span> Customer customer)</span> &#123;</span><br><span class="line">        databaseSDK.executeSql(</span><br><span class="line">            <span class="string">&quot;INSERT INTO customers (name, email, created_at) VALUES (?, ?, ?)&quot;</span>,</span><br><span class="line">            customer.getName(),</span><br><span class="line">            customer.getEmail(),</span><br><span class="line">            Timestamp.from(Instant.now())</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Use-Case-2-Tenant-Onboarding-Process"><a href="#Use-Case-2-Tenant-Onboarding-Process" class="headerlink" title="Use Case 2: Tenant Onboarding Process"></a>Use Case 2: Tenant Onboarding Process</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantOnboardingService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MultiTenantDatabaseSDK databaseSDK;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onboardNewTenant</span><span class="params">(TenantRegistration registration)</span> &#123;</span><br><span class="line">        <span class="type">TenantConfig</span> <span class="variable">config</span> <span class="operator">=</span> TenantConfig.builder()</span><br><span class="line">            .tenantId(registration.getTenantId())</span><br><span class="line">            .databaseType(<span class="string">&quot;mysql&quot;</span>)</span><br><span class="line">            .host(<span class="string">&quot;localhost&quot;</span>)</span><br><span class="line">            .port(<span class="number">3306</span>)</span><br><span class="line">            .databaseName(<span class="string">&quot;tenant_&quot;</span> + registration.getTenantId())</span><br><span class="line">            .username(<span class="string">&quot;tenant_user&quot;</span>)</span><br><span class="line">            .password(generateSecurePassword())</span><br><span class="line">            .maxPoolSize(<span class="number">10</span>)</span><br><span class="line">            .minIdle(<span class="number">2</span>)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Create tenant database and tables</span></span><br><span class="line">            databaseSDK.createTenant(registration.getTenantId(), config);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Insert initial data</span></span><br><span class="line">            insertInitialData(registration);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Send welcome email</span></span><br><span class="line">            sendWelcomeEmail(registration);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// Rollback tenant creation</span></span><br><span class="line">            databaseSDK.deleteTenant(registration.getTenantId());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TenantOnboardingException</span>(<span class="string">&quot;Failed to onboard tenant&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Use-Case-3-Data-Migration-Between-Tenants"><a href="#Use-Case-3-Data-Migration-Between-Tenants" class="headerlink" title="Use Case 3: Data Migration Between Tenants"></a>Use Case 3: Data Migration Between Tenants</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantDataMigrationService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MultiTenantDatabaseSDK databaseSDK;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">migrateTenantData</span><span class="params">(String sourceTenantId, String targetTenantId)</span> &#123;</span><br><span class="line">        <span class="comment">// Export data from source tenant</span></span><br><span class="line">        TenantContext.setTenant(sourceTenantId);</span><br><span class="line">        List&lt;Customer&gt; customers = databaseSDK.query(</span><br><span class="line">            <span class="string">&quot;SELECT * FROM customers&quot;</span>,</span><br><span class="line">            <span class="built_in">this</span>::mapCustomer</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Import data to target tenant</span></span><br><span class="line">        TenantContext.setTenant(targetTenantId);</span><br><span class="line">        databaseSDK.executeTransaction(connection -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (Customer customer : customers) &#123;</span><br><span class="line">                <span class="type">PreparedStatement</span> <span class="variable">stmt</span> <span class="operator">=</span> connection.prepareStatement(</span><br><span class="line">                    <span class="string">&quot;INSERT INTO customers (name, email, created_at) VALUES (?, ?, ?)&quot;</span></span><br><span class="line">                );</span><br><span class="line">                stmt.setString(<span class="number">1</span>, customer.getName());</span><br><span class="line">                stmt.setString(<span class="number">2</span>, customer.getEmail());</span><br><span class="line">                stmt.setTimestamp(<span class="number">3</span>, customer.getCreatedAt());</span><br><span class="line">                stmt.executeUpdate();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Runtime-Datasource-Switching"><a href="#Runtime-Datasource-Switching" class="headerlink" title="Runtime Datasource Switching"></a>Runtime Datasource Switching</h2><h3 id="Dynamic-DataSource-Routing"><a href="#Dynamic-DataSource-Routing" class="headerlink" title="Dynamic DataSource Routing"></a>Dynamic DataSource Routing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiTenantDataSource</span> <span class="keyword">extends</span> <span class="title class_">AbstractRoutingDataSource</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">determineCurrentLookupKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> TenantContext.getCurrentTenant();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> DataSource <span class="title function_">determineTargetDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> TenantContext.getCurrentTenant();</span><br><span class="line">        <span class="keyword">if</span> (tenantId == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> getDefaultDataSource();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> connectionPoolManager.getDataSource(tenantId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Request-Flow-Diagram"><a href="#Request-Flow-Diagram" class="headerlink" title="Request Flow Diagram"></a>Request Flow Diagram</h3><pre>
<code class="mermaid">
sequenceDiagram
participant Client
participant API Gateway
participant SaaS Service
participant SDK
participant Database

Client-&gt;&gt;API Gateway: Request with tenant info
API Gateway-&gt;&gt;SaaS Service: Forward request
SaaS Service-&gt;&gt;SDK: Set tenant context
SDK-&gt;&gt;SDK: Store in ThreadLocal
SaaS Service-&gt;&gt;SDK: Execute database operation
SDK-&gt;&gt;SDK: Determine datasource
SDK-&gt;&gt;Database: Execute query
Database-&gt;&gt;SDK: Return results
SDK-&gt;&gt;SaaS Service: Return results
SaaS Service-&gt;&gt;Client: Return response
</code>
</pre>

<p><strong>Interview Insight</strong>: <em>“How do you handle database connection switching at runtime?”</em></p>
<p>We use Spring’s AbstractRoutingDataSource combined with ThreadLocal tenant context. The routing happens transparently - when a database operation is requested, the SDK determines the appropriate datasource based on the current tenant context stored in ThreadLocal.</p>
<h2 id="Performance-Optimization-Strategies"><a href="#Performance-Optimization-Strategies" class="headerlink" title="Performance Optimization Strategies"></a>Performance Optimization Strategies</h2><h3 id="Connection-Pool-Tuning"><a href="#Connection-Pool-Tuning" class="headerlink" title="Connection Pool Tuning"></a>Connection Pool Tuning</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;multitenant.pool&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConnectionPoolConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">maxPoolSize</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">minIdle</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">connectionTimeout</span> <span class="operator">=</span> <span class="number">30000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">idleTimeout</span> <span class="operator">=</span> <span class="number">600000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">maxLifetime</span> <span class="operator">=</span> <span class="number">1800000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">leakDetectionThreshold</span> <span class="operator">=</span> <span class="number">60000</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Getters and setters</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Connection-Pool-Monitoring"><a href="#Connection-Pool-Monitoring" class="headerlink" title="Connection Pool Monitoring"></a>Connection Pool Monitoring</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConnectionPoolMonitor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConnectionPoolManager poolManager;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 30000)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">monitorConnectionPools</span><span class="params">()</span> &#123;</span><br><span class="line">        poolManager.getAllDataSources().forEach((tenantId, dataSource) -&gt; &#123;</span><br><span class="line">            <span class="type">HikariPoolMXBean</span> <span class="variable">poolMXBean</span> <span class="operator">=</span> dataSource.getHikariPoolMXBean();</span><br><span class="line">            </span><br><span class="line">            Gauge.builder(<span class="string">&quot;connection.pool.active&quot;</span>)</span><br><span class="line">                .tag(<span class="string">&quot;tenant&quot;</span>, tenantId)</span><br><span class="line">                .register(meterRegistry, poolMXBean, HikariPoolMXBean::getActiveConnections);</span><br><span class="line">                </span><br><span class="line">            Gauge.builder(<span class="string">&quot;connection.pool.idle&quot;</span>)</span><br><span class="line">                .tag(<span class="string">&quot;tenant&quot;</span>, tenantId)</span><br><span class="line">                .register(meterRegistry, poolMXBean, HikariPoolMXBean::getIdleConnections);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Caching-Strategy"><a href="#Caching-Strategy" class="headerlink" title="Caching Strategy"></a>Caching Strategy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantConfigCacheService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LoadingCache&lt;String, TenantConfig&gt; configCache;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TenantConfigCacheService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.configCache = Caffeine.newBuilder()</span><br><span class="line">            .maximumSize(<span class="number">1000</span>)</span><br><span class="line">            .expireAfterWrite(<span class="number">30</span>, TimeUnit.MINUTES)</span><br><span class="line">            .build(<span class="built_in">this</span>::loadTenantConfig);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> TenantConfig <span class="title function_">getTenantConfig</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> configCache.get(tenantId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> TenantConfig <span class="title function_">loadTenantConfig</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> tenantConfigRepository.findByTenantId(tenantId)</span><br><span class="line">            .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">TenantNotFoundException</span>(<span class="string">&quot;Tenant not found: &quot;</span> + tenantId));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Security-and-Compliance"><a href="#Security-and-Compliance" class="headerlink" title="Security and Compliance"></a>Security and Compliance</h2><h3 id="Tenant-Isolation-Security"><a href="#Tenant-Isolation-Security" class="headerlink" title="Tenant Isolation Security"></a>Tenant Isolation Security</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantSecurityValidator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">validateTenantAccess</span><span class="params">(String requestedTenantId, String authenticatedTenantId)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!requestedTenantId.equals(authenticatedTenantId)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TenantAccessDeniedException</span>(<span class="string">&quot;Cross-tenant access denied&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">validateSqlInjection</span><span class="params">(String sql)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (containsSqlInjectionPatterns(sql)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;Potential SQL injection detected&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">containsSqlInjectionPatterns</span><span class="params">(String sql)</span> &#123;</span><br><span class="line">        String[] patterns = &#123;<span class="string">&quot;&#x27;;&quot;</span>, <span class="string">&quot;DROP&quot;</span>, <span class="string">&quot;DELETE&quot;</span>, <span class="string">&quot;UPDATE&quot;</span>, <span class="string">&quot;INSERT&quot;</span>, <span class="string">&quot;UNION&quot;</span>&#125;;</span><br><span class="line">        <span class="type">String</span> <span class="variable">upperSql</span> <span class="operator">=</span> sql.toUpperCase();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> Arrays.stream(patterns)</span><br><span class="line">            .anyMatch(upperSql::contains);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Encryption-and-Data-Protection"><a href="#Encryption-and-Data-Protection" class="headerlink" title="Encryption and Data Protection"></a>Encryption and Data Protection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataEncryptionService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AESUtil aesUtil;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">encryptSensitiveData</span><span class="params">(String data, String tenantId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantKey</span> <span class="operator">=</span> generateTenantSpecificKey(tenantId);</span><br><span class="line">        <span class="keyword">return</span> aesUtil.encrypt(data, tenantKey);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">decryptSensitiveData</span><span class="params">(String encryptedData, String tenantId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantKey</span> <span class="operator">=</span> generateTenantSpecificKey(tenantId);</span><br><span class="line">        <span class="keyword">return</span> aesUtil.decrypt(encryptedData, tenantKey);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">generateTenantSpecificKey</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="comment">// Generate tenant-specific encryption key</span></span><br><span class="line">        <span class="keyword">return</span> keyDerivationService.deriveKey(tenantId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Error-Handling-and-Resilience"><a href="#Error-Handling-and-Resilience" class="headerlink" title="Error Handling and Resilience"></a>Error Handling and Resilience</h2><h3 id="Exception-Hierarchy"><a href="#Exception-Hierarchy" class="headerlink" title="Exception Hierarchy"></a>Exception Hierarchy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseException</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DatabaseException</span><span class="params">(String message, Throwable cause)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message, cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantNotFoundException</span> <span class="keyword">extends</span> <span class="title class_">DatabaseException</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TenantNotFoundException</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantCreationException</span> <span class="keyword">extends</span> <span class="title class_">DatabaseException</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TenantCreationException</span><span class="params">(String message, Throwable cause)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message, cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Retry-Mechanism"><a href="#Retry-Mechanism" class="headerlink" title="Retry Mechanism"></a>Retry Mechanism</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseRetryService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RetryTemplate retryTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DatabaseRetryService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.retryTemplate = RetryTemplate.builder()</span><br><span class="line">            .maxAttempts(<span class="number">3</span>)</span><br><span class="line">            .exponentialBackoff(<span class="number">1000</span>, <span class="number">2</span>, <span class="number">10000</span>)</span><br><span class="line">            .retryOn(SQLException.class, DataAccessException.class)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">executeWithRetry</span><span class="params">(Supplier&lt;T&gt; operation)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> retryTemplate.execute(context -&gt; operation.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Circuit-Breaker-Implementation"><a href="#Circuit-Breaker-Implementation" class="headerlink" title="Circuit Breaker Implementation"></a>Circuit Breaker Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseCircuitBreaker</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CircuitBreaker circuitBreaker;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DatabaseCircuitBreaker</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.circuitBreaker = CircuitBreaker.ofDefaults(<span class="string">&quot;database&quot;</span>);</span><br><span class="line">        circuitBreaker.getEventPublisher()</span><br><span class="line">            .onStateTransition(event -&gt; </span><br><span class="line">                log.info(<span class="string">&quot;Circuit breaker state transition: &#123;&#125;&quot;</span>, event));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">executeWithCircuitBreaker</span><span class="params">(Supplier&lt;T&gt; operation)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> circuitBreaker.executeSupplier(operation);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Testing-Strategies"><a href="#Testing-Strategies" class="headerlink" title="Testing Strategies"></a>Testing Strategies</h2><h3 id="Unit-Testing"><a href="#Unit-Testing" class="headerlink" title="Unit Testing"></a>Unit Testing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExtendWith(MockitoExtension.class)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MultiTenantDatabaseSDKTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> ConnectionPoolManager connectionPoolManager;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> DatabaseProviderFactory providerFactory;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@InjectMocks</span></span><br><span class="line">    <span class="keyword">private</span> MultiTenantDatabaseSDKImpl sdk;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldExecuteSqlForCurrentTenant</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Given</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> <span class="string">&quot;tenant-123&quot;</span>;</span><br><span class="line">        TenantContext.setTenant(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">mockDataSource</span> <span class="operator">=</span> mock(DataSource.class);</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">mockConnection</span> <span class="operator">=</span> mock(Connection.class);</span><br><span class="line">        <span class="type">PreparedStatement</span> <span class="variable">mockStatement</span> <span class="operator">=</span> mock(PreparedStatement.class);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">when</span>(connectionPoolManager.getDataSource(tenantId)).thenReturn(mockDataSource);</span><br><span class="line">        <span class="keyword">when</span>(mockDataSource.getConnection()).thenReturn(mockConnection);</span><br><span class="line">        <span class="keyword">when</span>(mockConnection.prepareStatement(anyString())).thenReturn(mockStatement);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When</span></span><br><span class="line">        sdk.executeSql(<span class="string">&quot;INSERT INTO users (name) VALUES (?)&quot;</span>, <span class="string">&quot;John&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Then</span></span><br><span class="line">        verify(mockStatement).setString(<span class="number">1</span>, <span class="string">&quot;John&quot;</span>);</span><br><span class="line">        verify(mockStatement).execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Integration-Testing"><a href="#Integration-Testing" class="headerlink" title="Integration Testing"></a>Integration Testing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@TestPropertySource(properties = &#123;</span></span><br><span class="line"><span class="meta">    &quot;spring.datasource.url=jdbc:h2:mem:testdb&quot;,</span></span><br><span class="line"><span class="meta">    &quot;spring.jpa.hibernate.ddl-auto=create-drop&quot;</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MultiTenantIntegrationTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MultiTenantDatabaseSDK sdk;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldCreateTenantAndExecuteOperations</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Given</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> <span class="string">&quot;test-tenant&quot;</span>;</span><br><span class="line">        <span class="type">TenantConfig</span> <span class="variable">config</span> <span class="operator">=</span> createTestTenantConfig(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When</span></span><br><span class="line">        sdk.createTenant(tenantId, config);</span><br><span class="line">        </span><br><span class="line">        TenantContext.setTenant(tenantId);</span><br><span class="line">        sdk.executeSql(<span class="string">&quot;INSERT INTO users (name, email) VALUES (?, ?)&quot;</span>, <span class="string">&quot;John&quot;</span>, <span class="string">&quot;john@example.com&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        List&lt;User&gt; users = sdk.query(<span class="string">&quot;SELECT * FROM users&quot;</span>, <span class="built_in">this</span>::mapUser);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Then</span></span><br><span class="line">        assertThat(users).hasSize(<span class="number">1</span>);</span><br><span class="line">        assertThat(users.get(<span class="number">0</span>).getName()).isEqualTo(<span class="string">&quot;John&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Monitoring-and-Observability"><a href="#Monitoring-and-Observability" class="headerlink" title="Monitoring and Observability"></a>Monitoring and Observability</h2><h3 id="Metrics-Collection"><a href="#Metrics-Collection" class="headerlink" title="Metrics Collection"></a>Metrics Collection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiTenantMetrics</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter tenantCreationCounter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Timer databaseOperationTimer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Gauge activeTenantGauge;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MultiTenantMetrics</span><span class="params">(MeterRegistry meterRegistry)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.tenantCreationCounter = Counter.builder(<span class="string">&quot;tenant.creation.count&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.databaseOperationTimer = Timer.builder(<span class="string">&quot;database.operation.time&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.activeTenantGauge = Gauge.builder(<span class="string">&quot;tenant.active.count&quot;</span>)</span><br><span class="line">            .register(meterRegistry, <span class="built_in">this</span>, MultiTenantMetrics::getActiveTenantCount);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordTenantCreation</span><span class="params">()</span> &#123;</span><br><span class="line">        tenantCreationCounter.increment();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordDatabaseOperation</span><span class="params">(Duration duration)</span> &#123;</span><br><span class="line">        databaseOperationTimer.record(duration);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> <span class="title function_">getActiveTenantCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> connectionPoolManager.getActiveTenantCount();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Health-Checks"><a href="#Health-Checks" class="headerlink" title="Health Checks"></a>Health Checks</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiTenantHealthIndicator</span> <span class="keyword">implements</span> <span class="title class_">HealthIndicator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConnectionPoolManager connectionPoolManager;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Health <span class="title function_">health</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">activeTenants</span> <span class="operator">=</span> connectionPoolManager.getActiveTenantCount();</span><br><span class="line">            <span class="type">int</span> <span class="variable">totalConnections</span> <span class="operator">=</span> connectionPoolManager.getTotalActiveConnections();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> Health.up()</span><br><span class="line">                .withDetail(<span class="string">&quot;activeTenants&quot;</span>, activeTenants)</span><br><span class="line">                .withDetail(<span class="string">&quot;totalConnections&quot;</span>, totalConnections)</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> Health.down()</span><br><span class="line">                .withException(e)</span><br><span class="line">                .build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Deployment-and-Configuration"><a href="#Deployment-and-Configuration" class="headerlink" title="Deployment and Configuration"></a>Deployment and Configuration</h2><h3 id="Docker-Configuration"><a href="#Docker-Configuration" class="headerlink" title="Docker Configuration"></a>Docker Configuration</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">11</span>-jre-slim</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> target/multi-tenant-sdk.jar app.jar</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> JAVA_OPTS=<span class="string">&quot;-Xmx2g -Xms1g&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> HIKARI_MAX_POOL_SIZE=<span class="number">20</span></span><br><span class="line"><span class="keyword">ENV</span> HIKARI_MIN_IDLE=<span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;java <span class="variable">$JAVA_OPTS</span> -jar /app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h3 id="Kubernetes-Deployment"><a href="#Kubernetes-Deployment" class="headerlink" title="Kubernetes Deployment"></a>Kubernetes Deployment</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">multi-tenant-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">multi-tenant-app</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">multi-tenant-app</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">multi-tenant-sdk:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_PROFILES_ACTIVE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;production&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DATABASE_MAX_POOL_SIZE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;20&quot;</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;2Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;1000m&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Common-Interview-Questions-and-Answers"><a href="#Common-Interview-Questions-and-Answers" class="headerlink" title="Common Interview Questions and Answers"></a>Common Interview Questions and Answers</h2><p><strong>Q: “How do you handle tenant data isolation?”</strong></p>
<p>A: We implement database-per-tenant isolation using dynamic datasource routing. Each tenant has its own database and connection pool, ensuring complete data isolation. The SDK uses ThreadLocal to maintain tenant context throughout the request lifecycle.</p>
<p><strong>Q: “What happens if a tenant’s database becomes unavailable?”</strong></p>
<p>A: We implement circuit breaker pattern and retry mechanisms. If a tenant’s database is unavailable, the circuit breaker opens, preventing cascading failures. We also have health checks that monitor each tenant’s database connectivity.</p>
<p><strong>Q: “How do you handle database migrations across multiple tenants?”</strong></p>
<p>A: We use a versioned migration system where each tenant’s database schema version is tracked. Migrations are applied tenant by tenant, with rollback capabilities. Critical migrations are tested in staging environments first.</p>
<p><strong>Q: “How do you optimize connection pool usage?”</strong></p>
<p>A: We use adaptive connection pool sizing based on tenant activity. Inactive tenants have smaller pools, while active tenants get more connections. We also implement connection</p>
<h2 id="Advanced-Features-and-Extensions"><a href="#Advanced-Features-and-Extensions" class="headerlink" title="Advanced Features and Extensions"></a>Advanced Features and Extensions</h2><h3 id="Tenant-Database-Sharding"><a href="#Tenant-Database-Sharding" class="headerlink" title="Tenant Database Sharding"></a>Tenant Database Sharding</h3><p>For high-scale scenarios, the SDK supports database sharding across multiple database servers:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantShardingManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ShardConfig&gt; shards;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConsistentHashing&lt;String&gt; hashRing;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TenantShardingManager</span><span class="params">(List&lt;ShardConfig&gt; shards)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.shards = shards;</span><br><span class="line">        <span class="built_in">this</span>.hashRing = <span class="keyword">new</span> <span class="title class_">ConsistentHashing</span>&lt;&gt;(</span><br><span class="line">            shards.stream().map(ShardConfig::getShardId).collect(Collectors.toList())</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ShardConfig <span class="title function_">getShardForTenant</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">shardId</span> <span class="operator">=</span> hashRing.getNode(tenantId);</span><br><span class="line">        <span class="keyword">return</span> shards.stream()</span><br><span class="line">            .filter(shard -&gt; shard.getShardId().equals(shardId))</span><br><span class="line">            .findFirst()</span><br><span class="line">            .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">ShardNotFoundException</span>(<span class="string">&quot;Shard not found for tenant: &quot;</span> + tenantId));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rebalanceShards</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Implement shard rebalancing logic</span></span><br><span class="line">        <span class="keyword">for</span> (ShardConfig shard : shards) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">currentLoad</span> <span class="operator">=</span> calculateShardLoad(shard);</span><br><span class="line">            <span class="keyword">if</span> (currentLoad &gt; shard.getMaxCapacity() * <span class="number">0.8</span>) &#123;</span><br><span class="line">                triggerShardSplit(shard);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Tenant-Migration-and-Backup"><a href="#Tenant-Migration-and-Backup" class="headerlink" title="Tenant Migration and Backup"></a>Tenant Migration and Backup</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantMigrationService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MultiTenantDatabaseSDK databaseSDK;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TenantBackupService backupService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">migrateTenant</span><span class="params">(String tenantId, TenantConfig newConfig)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Create backup before migration</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">backupId</span> <span class="operator">=</span> backupService.createBackup(tenantId);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Export tenant data</span></span><br><span class="line">            <span class="type">TenantData</span> <span class="variable">exportedData</span> <span class="operator">=</span> exportTenantData(tenantId);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Create new tenant database</span></span><br><span class="line">            databaseSDK.createTenant(tenantId + <span class="string">&quot;_new&quot;</span>, newConfig);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Import data to new database</span></span><br><span class="line">            importTenantData(tenantId + <span class="string">&quot;_new&quot;</span>, exportedData);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Validate migration</span></span><br><span class="line">            <span class="keyword">if</span> (validateMigration(tenantId, tenantId + <span class="string">&quot;_new&quot;</span>)) &#123;</span><br><span class="line">                <span class="comment">// Switch to new database</span></span><br><span class="line">                switchTenantDatabase(tenantId, newConfig);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Cleanup old database</span></span><br><span class="line">                databaseSDK.deleteTenant(tenantId + <span class="string">&quot;_old&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Rollback</span></span><br><span class="line">                restoreFromBackup(tenantId, backupId);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TenantMigrationException</span>(<span class="string">&quot;Migration failed for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> TenantData <span class="title function_">exportTenantData</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        TenantContext.setTenant(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="type">TenantData</span> <span class="variable">data</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TenantData</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Export all tables</span></span><br><span class="line">        List&lt;String&gt; tables = databaseSDK.query(</span><br><span class="line">            <span class="string">&quot;SELECT table_name FROM information_schema.tables WHERE table_schema = ?&quot;</span>,</span><br><span class="line">            rs -&gt; rs.getString(<span class="string">&quot;table_name&quot;</span>),</span><br><span class="line">            TenantContext.getCurrentDatabase()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String table : tables) &#123;</span><br><span class="line">            List&lt;Map&lt;String, Object&gt;&gt; tableData = databaseSDK.query(</span><br><span class="line">                <span class="string">&quot;SELECT * FROM &quot;</span> + table,</span><br><span class="line">                <span class="built_in">this</span>::mapRowToMap</span><br><span class="line">            );</span><br><span class="line">            data.addTableData(table, tableData);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Read-Replica-Support"><a href="#Read-Replica-Support" class="headerlink" title="Read Replica Support"></a>Read Replica Support</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReadReplicaManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, List&lt;DataSource&gt;&gt; readReplicas = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LoadBalancer loadBalancer;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">getReadDataSource</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        List&lt;DataSource&gt; replicas = readReplicas.get(tenantId);</span><br><span class="line">        <span class="keyword">if</span> (replicas == <span class="literal">null</span> || replicas.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> connectionPoolManager.getDataSource(tenantId); <span class="comment">// Fallback to master</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> loadBalancer.selectDataSource(replicas);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addReadReplica</span><span class="params">(String tenantId, TenantConfig replicaConfig)</span> &#123;</span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">replicaDataSource</span> <span class="operator">=</span> createDataSource(replicaConfig);</span><br><span class="line">        readReplicas.computeIfAbsent(tenantId, k -&gt; <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;()).add(replicaDataSource);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 30000)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">monitorReplicaHealth</span><span class="params">()</span> &#123;</span><br><span class="line">        readReplicas.forEach((tenantId, replicas) -&gt; &#123;</span><br><span class="line">            replicas.removeIf(replica -&gt; !isHealthy(replica));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Multi-Database-Transaction-Support"><a href="#Multi-Database-Transaction-Support" class="headerlink" title="Multi-Database Transaction Support"></a>Multi-Database Transaction Support</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiTenantTransactionManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PlatformTransactionManager transactionManager;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeMultiTenantTransaction</span><span class="params">(List&lt;String&gt; tenantIds, </span></span><br><span class="line"><span class="params">                                            MultiTenantTransactionCallback callback)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">TransactionStatus</span> <span class="variable">status</span> <span class="operator">=</span> transactionManager.getTransaction(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">DefaultTransactionDefinition</span>()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Map&lt;String, Connection&gt; connections = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Get connections for all tenants</span></span><br><span class="line">            <span class="keyword">for</span> (String tenantId : tenantIds) &#123;</span><br><span class="line">                <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> connectionPoolManager.getDataSource(tenantId);</span><br><span class="line">                connections.put(tenantId, dataSource.getConnection());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Execute callback with all connections</span></span><br><span class="line">            callback.doInTransaction(connections);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Commit all transactions</span></span><br><span class="line">            connections.values().forEach(conn -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    conn.commit();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            transactionManager.commit(status);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            transactionManager.rollback(status);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MultiTenantTransactionException</span>(<span class="string">&quot;Multi-tenant transaction failed&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Benchmarking-and-Optimization"><a href="#Performance-Benchmarking-and-Optimization" class="headerlink" title="Performance Benchmarking and Optimization"></a>Performance Benchmarking and Optimization</h2><h3 id="Benchmark-Results"><a href="#Benchmark-Results" class="headerlink" title="Benchmark Results"></a>Benchmark Results</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PerformanceBenchmark</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MultiTenantDatabaseSDK sdk;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">benchmarkOnStartup</span><span class="params">(ApplicationReadyEvent event)</span> &#123;</span><br><span class="line">        runConnectionPoolBenchmark();</span><br><span class="line">        runTenantSwitchingBenchmark();</span><br><span class="line">        runConcurrentAccessBenchmark();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">runConnectionPoolBenchmark</span><span class="params">()</span> &#123;</span><br><span class="line">        Timer.<span class="type">Sample</span> <span class="variable">sample</span> <span class="operator">=</span> Timer.start(meterRegistry);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Test connection acquisition time</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> <span class="string">&quot;tenant-&quot;</span> + (i % <span class="number">10</span>);</span><br><span class="line">            TenantContext.setTenant(tenantId);</span><br><span class="line">            </span><br><span class="line">            sdk.query(<span class="string">&quot;SELECT 1&quot;</span>, rs -&gt; rs.getInt(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        sample.stop(Timer.builder(<span class="string">&quot;benchmark.connection.pool&quot;</span>).register(meterRegistry));</span><br><span class="line">        </span><br><span class="line">        log.info(<span class="string">&quot;Connection pool benchmark: &#123;&#125; ms&quot;</span>, (endTime - startTime) / <span class="number">1_000_000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">runTenantSwitchingBenchmark</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">iterations</span> <span class="operator">=</span> <span class="number">10000</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; iterations; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> <span class="string">&quot;tenant-&quot;</span> + (i % <span class="number">100</span>);</span><br><span class="line">            TenantContext.setTenant(tenantId);</span><br><span class="line">            <span class="comment">// Simulate tenant switching overhead</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        <span class="type">double</span> <span class="variable">avgSwitchTime</span> <span class="operator">=</span> (endTime - startTime) / <span class="number">1_000_000.0</span> / iterations;</span><br><span class="line">        </span><br><span class="line">        log.info(<span class="string">&quot;Average tenant switching time: &#123;&#125; ms&quot;</span>, avgSwitchTime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Performance-Optimization-Recommendations"><a href="#Performance-Optimization-Recommendations" class="headerlink" title="Performance Optimization Recommendations"></a>Performance Optimization Recommendations</h3><pre>
<code class="mermaid">
graph LR
A[Performance Optimization] --&gt; B[Connection Pooling]
A --&gt; C[Caching Strategy]
A --&gt; D[Query Optimization]
A --&gt; E[Resource Management]

B --&gt; B1[HikariCP Configuration]
B --&gt; B2[Pool Size Tuning]
B --&gt; B3[Connection Validation]

C --&gt; C1[Tenant Config Cache]
C --&gt; C2[Query Result Cache]
C --&gt; C3[Schema Cache]

D --&gt; D1[Prepared Statements]
D --&gt; D2[Batch Operations]
D --&gt; D3[Index Optimization]

E --&gt; E1[Memory Management]
E --&gt; E2[Thread Pool Tuning]
E --&gt; E3[GC Optimization]
</code>
</pre>

<h2 id="Security-Best-Practices"><a href="#Security-Best-Practices" class="headerlink" title="Security Best Practices"></a>Security Best Practices</h2><h3 id="Security-Architecture"><a href="#Security-Architecture" class="headerlink" title="Security Architecture"></a>Security Architecture</h3><pre>
<code class="mermaid">
graph TB
A[Client Request] --&gt; B[API Gateway]
B --&gt; C[Authentication Service]
C --&gt; D[Tenant Authorization]
D --&gt; E[Multi-Tenant SDK]
E --&gt; F[Security Validator]
F --&gt; G[Encrypted Connection]
G --&gt; H[Tenant Database]

I[Security Layers]
I --&gt; J[Network Security]
I --&gt; K[Application Security]
I --&gt; L[Database Security]
I --&gt; M[Data Encryption]
</code>
</pre>

<h3 id="Advanced-Security-Features"><a href="#Advanced-Security-Features" class="headerlink" title="Advanced Security Features"></a>Advanced Security Features</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantSecurityEnforcer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TenantPermissionService permissionService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuditLogService auditService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Around(&quot;@annotation(SecureTenantOperation)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">enforceSecurityz</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> TenantContext.getCurrentTenant();</span><br><span class="line">        <span class="type">String</span> <span class="variable">operation</span> <span class="operator">=</span> joinPoint.getSignature().getName();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Validate tenant access</span></span><br><span class="line">        <span class="keyword">if</span> (!permissionService.hasPermission(tenantId, operation)) &#123;</span><br><span class="line">            auditService.logUnauthorizedAccess(tenantId, operation);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TenantAccessDeniedException</span>(<span class="string">&quot;Access denied for operation: &quot;</span> + operation);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Rate limiting</span></span><br><span class="line">        <span class="keyword">if</span> (!rateLimiter.tryAcquire(tenantId)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RateLimitExceededException</span>(<span class="string">&quot;Rate limit exceeded for tenant: &quot;</span> + tenantId);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> joinPoint.proceed();</span><br><span class="line">            auditService.logSuccessfulOperation(tenantId, operation);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            auditService.logFailedOperation(tenantId, operation, e);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Data-Masking-and-Privacy"><a href="#Data-Masking-and-Privacy" class="headerlink" title="Data Masking and Privacy"></a>Data Masking and Privacy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataPrivacyManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, DataMaskingRule&gt; maskingRules;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ResultSet <span class="title function_">maskSensitiveData</span><span class="params">(ResultSet resultSet, String tenantId)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="type">TenantPrivacyConfig</span> <span class="variable">config</span> <span class="operator">=</span> getPrivacyConfig(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> (resultSet.next()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (DataMaskingRule rule : config.getMaskingRules()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">columnName</span> <span class="operator">=</span> rule.getColumnName();</span><br><span class="line">                <span class="type">String</span> <span class="variable">originalValue</span> <span class="operator">=</span> resultSet.getString(columnName);</span><br><span class="line">                <span class="type">String</span> <span class="variable">maskedValue</span> <span class="operator">=</span> applyMasking(originalValue, rule.getMaskingType());</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Update result set with masked value</span></span><br><span class="line">                ((UpdatableResultSet) resultSet).updateString(columnName, maskedValue);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> resultSet;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">applyMasking</span><span class="params">(String value, MaskingType type)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">            <span class="keyword">case</span> EMAIL:</span><br><span class="line">                <span class="keyword">return</span> maskEmail(value);</span><br><span class="line">            <span class="keyword">case</span> PHONE:</span><br><span class="line">                <span class="keyword">return</span> maskPhone(value);</span><br><span class="line">            <span class="keyword">case</span> CREDIT_CARD:</span><br><span class="line">                <span class="keyword">return</span> maskCreditCard(value);</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Disaster-Recovery-and-High-Availability"><a href="#Disaster-Recovery-and-High-Availability" class="headerlink" title="Disaster Recovery and High Availability"></a>Disaster Recovery and High Availability</h2><h3 id="Backup-and-Recovery-Strategy"><a href="#Backup-and-Recovery-Strategy" class="headerlink" title="Backup and Recovery Strategy"></a>Backup and Recovery Strategy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantBackupService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CloudStorageService storageService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DatabaseProvider databaseProvider;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0 0 2 * * *&quot;)</span> <span class="comment">// Daily at 2 AM</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performScheduledBackups</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;String&gt; activeTenants = getActiveTenants();</span><br><span class="line">        </span><br><span class="line">        activeTenants.parallelStream().forEach(tenantId -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">BackupResult</span> <span class="variable">result</span> <span class="operator">=</span> createBackup(tenantId);</span><br><span class="line">                storageService.uploadBackup(result);</span><br><span class="line">                cleanupOldBackups(tenantId);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;Backup failed for tenant: &#123;&#125;&quot;</span>, tenantId, e);</span><br><span class="line">                alertService.sendBackupFailureAlert(tenantId, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">createBackup</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">backupId</span> <span class="operator">=</span> generateBackupId(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TenantContext.setTenant(tenantId);</span><br><span class="line">            <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> connectionPoolManager.getDataSource(tenantId);</span><br><span class="line">            </span><br><span class="line">            <span class="type">BackupConfig</span> <span class="variable">config</span> <span class="operator">=</span> BackupConfig.builder()</span><br><span class="line">                .tenantId(tenantId)</span><br><span class="line">                .backupId(backupId)</span><br><span class="line">                .timestamp(Instant.now())</span><br><span class="line">                .compressionEnabled(<span class="literal">true</span>)</span><br><span class="line">                .encryptionEnabled(<span class="literal">true</span>)</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">            databaseProvider.createBackup(dataSource, config);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> backupId;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BackupException</span>(<span class="string">&quot;Backup creation failed for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">restoreFromBackup</span><span class="params">(String tenantId, String backupId)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">BackupMetadata</span> <span class="variable">metadata</span> <span class="operator">=</span> getBackupMetadata(tenantId, backupId);</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">backupStream</span> <span class="operator">=</span> storageService.downloadBackup(metadata.getStoragePath());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Create temporary database for restoration</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">tempTenantId</span> <span class="operator">=</span> tenantId + <span class="string">&quot;_restore_&quot;</span> + System.currentTimeMillis();</span><br><span class="line">            databaseProvider.restoreFromBackup(tempTenantId, backupStream);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Validate restoration</span></span><br><span class="line">            <span class="keyword">if</span> (validateRestoration(tenantId, tempTenantId)) &#123;</span><br><span class="line">                <span class="comment">// Switch to restored database</span></span><br><span class="line">                switchTenantDatabase(tenantId, tempTenantId);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RestoreException</span>(<span class="string">&quot;Backup validation failed&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RestoreException</span>(<span class="string">&quot;Restoration failed for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="High-Availability-Configuration"><a href="#High-Availability-Configuration" class="headerlink" title="High Availability Configuration"></a>High Availability Configuration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HighAvailabilityConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LoadBalancer <span class="title function_">databaseLoadBalancer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> LoadBalancer.builder()</span><br><span class="line">            .algorithm(LoadBalancingAlgorithm.ROUND_ROBIN)</span><br><span class="line">            .healthCheckInterval(Duration.ofSeconds(<span class="number">30</span>))</span><br><span class="line">            .failoverTimeout(Duration.ofSeconds(<span class="number">5</span>))</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FailoverManager <span class="title function_">failoverManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FailoverManager</span>(databaseProviderFactory, alertService);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FailoverManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, List&lt;TenantConfig&gt;&gt; replicaConfigs = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDatabaseFailure</span><span class="params">(DatabaseFailureEvent event)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> event.getTenantId();</span><br><span class="line">        </span><br><span class="line">        log.warn(<span class="string">&quot;Database failure detected for tenant: &#123;&#125;&quot;</span>, tenantId);</span><br><span class="line">        </span><br><span class="line">        List&lt;TenantConfig&gt; replicas = replicaConfigs.get(tenantId);</span><br><span class="line">        <span class="keyword">if</span> (replicas != <span class="literal">null</span> &amp;&amp; !replicas.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (TenantConfig replica : replicas) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isHealthy(replica)) &#123;</span><br><span class="line">                    performFailover(tenantId, replica);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            alertService.sendCriticalAlert(<span class="string">&quot;No healthy replicas available for tenant: &quot;</span> + tenantId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">performFailover</span><span class="params">(String tenantId, TenantConfig replicaConfig)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Update connection pool to use replica</span></span><br><span class="line">            connectionPoolManager.updateDataSource(tenantId, replicaConfig);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Update tenant configuration</span></span><br><span class="line">            tenantConfigRepository.updateConfig(tenantId, replicaConfig);</span><br><span class="line">            </span><br><span class="line">            log.info(<span class="string">&quot;Failover completed for tenant: &#123;&#125;&quot;</span>, tenantId);</span><br><span class="line">            alertService.sendFailoverAlert(tenantId, replicaConfig.getHost());</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Failover failed for tenant: &#123;&#125;&quot;</span>, tenantId, e);</span><br><span class="line">            alertService.sendFailoverFailureAlert(tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="External-References-and-Resources"><a href="#External-References-and-Resources" class="headerlink" title="External References and Resources"></a>External References and Resources</h2><h3 id="Documentation-and-Specifications"><a href="#Documentation-and-Specifications" class="headerlink" title="Documentation and Specifications"></a>Documentation and Specifications</h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/brettwooldridge/HikariCP#configuration-knobs-baby">HikariCP Configuration Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/tutorial/ext/basics/spi.html">Java SPI Tutorial</a></li>
<li><a target="_blank" rel="noopener" href="https://spring.io/blog/2022/07/31/how-to-integrate-hibernates-multitenant-feature-with-spring-data-jpa-in-a-spring-boot-application">Spring Boot Multi-Tenancy</a></li>
<li><a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/current/ddl-schemas.html">PostgreSQL Multi-Tenant Patterns</a></li>
<li><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/multiple-servers.html">MySQL Multi-Tenancy Best Practices</a></li>
</ul>
<h3 id="Performance-and-Monitoring"><a href="#Performance-and-Monitoring" class="headerlink" title="Performance and Monitoring"></a>Performance and Monitoring</h3><ul>
<li><a target="_blank" rel="noopener" href="https://micrometer.io/docs">Micrometer Metrics</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/brettwooldridge/HikariCP/wiki/MBean-(JMX)-Monitoring-and-Management">Connection Pool Monitoring</a></li>
<li><a target="_blank" rel="noopener" href="https://use-the-index-luke.com/">Database Performance Tuning</a></li>
</ul>
<h3 id="Security-Resources"><a href="#Security-Resources" class="headerlink" title="Security Resources"></a>Security Resources</h3><ul>
<li><a target="_blank" rel="noopener" href="https://owasp.org/www-project-database-security/">OWASP Database Security</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/architecture/guide/multitenant/considerations/data-partitioning">Multi-Tenant Security Patterns</a></li>
<li><a target="_blank" rel="noopener" href="https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html">SQL Injection Prevention</a></li>
</ul>
<h3 id="Cloud-and-DevOps"><a href="#Cloud-and-DevOps" class="headerlink" title="Cloud and DevOps"></a>Cloud and DevOps</h3><ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/extend-kubernetes/operator/">Kubernetes Database Operators</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/develop/dev-best-practices/">Docker Multi-Stage Builds</a></li>
<li><a target="_blank" rel="noopener" href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/db_instance">Terraform Database Provisioning</a></li>
</ul>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>This Multi-Tenant Database SDK provides a comprehensive solution for managing database operations across multiple tenants in a SaaS environment. The design emphasizes security, performance, and scalability while maintaining simplicity for developers.</p>
<p>Key benefits of this architecture include:</p>
<ul>
<li><strong>Strong tenant isolation</strong> through database-per-tenant approach</li>
<li><strong>High performance</strong> via connection pooling and caching strategies</li>
<li><strong>Extensibility</strong> through SPI pattern for database providers</li>
<li><strong>Production readiness</strong> with monitoring, backup, and failover capabilities</li>
<li><strong>Security</strong> with encryption, audit logging, and access controls</li>
</ul>
<p>The SDK can be extended to support additional database providers, implement more sophisticated sharding strategies, or integrate with cloud-native services. Regular monitoring and performance tuning ensure optimal operation in production environments.</p>
<p>Remember to adapt the configuration and implementation details based on your specific requirements, such as tenant scale, database types, and compliance needs. The provided examples serve as a solid foundation for building a robust multi-tenant database solution.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/13/Design-Universal-Message-Queue-SDK-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/13/Design-Universal-Message-Queue-SDK-Guide/" class="post-title-link" itemprop="url">Design Universal Message Queue SDK</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-13 18:12:54" itemprop="dateCreated datePublished" datetime="2025-06-13T18:12:54+08:00">2025-06-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-27 16:43:31" itemprop="dateModified" datetime="2025-06-27T16:43:31+08:00">2025-06-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system-design/" itemprop="url" rel="index"><span itemprop="name">system-design</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Introduction-to-Universal-Message-Queue-SDK"><a href="#Introduction-to-Universal-Message-Queue-SDK" class="headerlink" title="Introduction to Universal Message Queue SDK"></a>Introduction to Universal Message Queue SDK</h2><p>The Universal Message Queue Component SDK is a sophisticated middleware solution designed to abstract the complexity of different message queue implementations while providing a unified interface for asynchronous communication patterns. This SDK addresses the critical need for vendor-agnostic messaging capabilities in distributed systems, enabling seamless integration with Kafka, Redis, and RocketMQ through a single, consistent API.</p>
<h3 id="Core-Value-Proposition"><a href="#Core-Value-Proposition" class="headerlink" title="Core Value Proposition"></a>Core Value Proposition</h3><p>Modern distributed systems require reliable asynchronous communication patterns to achieve scalability, resilience, and performance. The Universal MQ SDK provides:</p>
<ul>
<li><strong>Vendor Independence</strong>: Switch between Kafka, Redis, and RocketMQ without code changes</li>
<li><strong>Unified API</strong>: Single interface for all messaging operations</li>
<li><strong>Production Resilience</strong>: Built-in failure handling and recovery mechanisms</li>
<li><strong>Asynchronous RPC</strong>: Transform synchronous HTTP calls into asynchronous message-driven operations</li>
</ul>
<p><strong>Interview Insight</strong>: <em>Why use a universal SDK instead of direct MQ client libraries?</em><br><em>Answer: A universal SDK provides abstraction that enables vendor flexibility, reduces learning curve for developers, standardizes error handling patterns, and centralizes configuration management. It also allows for gradual migration between MQ technologies without application code changes.</em></p>
<h2 id="Architecture-Overview"><a href="#Architecture-Overview" class="headerlink" title="Architecture Overview"></a>Architecture Overview</h2><p>The SDK follows a layered architecture pattern with clear separation of concerns:</p>
<pre>
<code class="mermaid">
flowchart TB
subgraph &quot;Client Applications&quot;
    A[Service A] --&gt; B[Service B]
    C[Service C] --&gt; D[Service D]
end

subgraph &quot;Universal MQ SDK&quot;
    E[Unified API Layer]
    F[SPI Interface]
    G[Async RPC Manager]
    H[Message Serialization]
    I[Failure Handling]
end

subgraph &quot;MQ Implementations&quot;
    J[Kafka Provider]
    K[Redis Provider]
    L[RocketMQ Provider]
end

subgraph &quot;Message Brokers&quot;
    M[Apache Kafka]
    N[Redis Streams]
    O[Apache RocketMQ]
end

A --&gt; E
C --&gt; E
E --&gt; F
F --&gt; G
F --&gt; H
F --&gt; I
F --&gt; J
F --&gt; K
F --&gt; L
J --&gt; M
K --&gt; N
L --&gt; O
</code>
</pre>

<h3 id="Key-Components"><a href="#Key-Components" class="headerlink" title="Key Components"></a>Key Components</h3><p><strong>Unified API Layer</strong>: Provides consistent interface for all messaging operations<br><strong>SPI (Service Provider Interface)</strong>: Enables pluggable MQ implementations<br><strong>Async RPC Manager</strong>: Handles request-response correlation and callback execution<br><strong>Message Serialization</strong>: Manages data format conversion and schema evolution<br><strong>Failure Handling</strong>: Implements retry, circuit breaker, and dead letter queue patterns</p>
<h2 id="Service-Provider-Interface-SPI-Design"><a href="#Service-Provider-Interface-SPI-Design" class="headerlink" title="Service Provider Interface (SPI) Design"></a>Service Provider Interface (SPI) Design</h2><p>The SPI mechanism enables runtime discovery and loading of different MQ implementations without modifying core SDK code.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Core SPI Interface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MessageQueueProvider</span> &#123;</span><br><span class="line">    String <span class="title function_">getProviderName</span><span class="params">()</span>;</span><br><span class="line">    MessageProducer <span class="title function_">createProducer</span><span class="params">(ProducerConfig config)</span>;</span><br><span class="line">    MessageConsumer <span class="title function_">createConsumer</span><span class="params">(ConsumerConfig config)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">(Properties properties)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Health check capabilities</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isHealthy</span><span class="params">()</span>;</span><br><span class="line">    ProviderMetrics <span class="title function_">getMetrics</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SPI Configuration</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MQProviderFactory</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, MessageQueueProvider&gt; providers = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">loadProviders</span><span class="params">()</span> &#123;</span><br><span class="line">        ServiceLoader&lt;MessageQueueProvider&gt; loader = </span><br><span class="line">            ServiceLoader.load(MessageQueueProvider.class);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (MessageQueueProvider provider : loader) &#123;</span><br><span class="line">            providers.put(provider.getProviderName(), provider);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> MessageQueueProvider <span class="title function_">getProvider</span><span class="params">(String providerName)</span> &#123;</span><br><span class="line">        <span class="type">MessageQueueProvider</span> <span class="variable">provider</span> <span class="operator">=</span> providers.get(providerName);</span><br><span class="line">        <span class="keyword">if</span> (provider == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedMQProviderException</span>(</span><br><span class="line">                <span class="string">&quot;Provider not found: &quot;</span> + providerName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> provider;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Provider-Implementation-Example-Kafka"><a href="#Provider-Implementation-Example-Kafka" class="headerlink" title="Provider Implementation Example - Kafka"></a>Provider Implementation Example - Kafka</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// META-INF/services/com.example.mq.MessageQueueProvider</span></span><br><span class="line">com.example.mq.kafka.KafkaMessageQueueProvider</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KafkaMessageQueueProvider</span> <span class="keyword">implements</span> <span class="title class_">MessageQueueProvider</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> KafkaProducer&lt;String, Object&gt; kafkaProducer;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getProviderName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;kafka&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">(Properties properties)</span> &#123;</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">kafkaProps</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        kafkaProps.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, </span><br><span class="line">                      properties.getProperty(<span class="string">&quot;kafka.bootstrap.servers&quot;</span>));</span><br><span class="line">        kafkaProps.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, </span><br><span class="line">                      StringSerializer.class.getName());</span><br><span class="line">        kafkaProps.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, </span><br><span class="line">                      JsonSerializer.class.getName());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Production settings</span></span><br><span class="line">        kafkaProps.put(ProducerConfig.ACKS_CONFIG, <span class="string">&quot;all&quot;</span>);</span><br><span class="line">        kafkaProps.put(ProducerConfig.RETRIES_CONFIG, Integer.MAX_VALUE);</span><br><span class="line">        kafkaProps.put(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG, <span class="literal">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">this</span>.kafkaProducer = <span class="keyword">new</span> <span class="title class_">KafkaProducer</span>&lt;&gt;(kafkaProps);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MessageProducer <span class="title function_">createProducer</span><span class="params">(ProducerConfig config)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">KafkaMessageProducer</span>(kafkaProducer, config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>How does SPI improve maintainability compared to factory patterns?</em><br><em>Answer: SPI provides compile-time independence - new providers can be added without modifying existing code. It supports modular deployment where providers can be packaged separately, enables runtime provider discovery, and follows the Open&#x2F;Closed Principle by being open for extension but closed for modification.</em></p>
<h2 id="Asynchronous-RPC-Implementation"><a href="#Asynchronous-RPC-Implementation" class="headerlink" title="Asynchronous RPC Implementation"></a>Asynchronous RPC Implementation</h2><p>The Async RPC pattern transforms traditional synchronous HTTP calls into message-driven asynchronous operations, providing better scalability and fault tolerance.</p>
<pre>
<code class="mermaid">
sequenceDiagram
participant Client as Client Service
participant SDK as MQ SDK
participant Server as Server Service
participant MQ as Message Queue
participant Callback as Callback Handler

Client-&gt;&gt;SDK: asyncPost(url, data, callback)
SDK-&gt;&gt;SDK: Generate messageKey &amp; responseTopic
SDK-&gt;&gt;Server: Direct HTTP POST with MQ headers
Note over Server: X-Message-Key: uuid-12345&lt;br&#x2F;&gt;X-Response-Topic: client-responses
Server-&gt;&gt;Server: Process business logic asynchronously
Server-&gt;&gt;Server: HTTP 202 Accepted (immediate response)
Server-&gt;&gt;MQ: Publish response message when ready
MQ-&gt;&gt;SDK: SDK consumes response message
SDK-&gt;&gt;Callback: Execute callback(response)
</code>
</pre>

<h3 id="Async-RPC-Manager-Implementation"><a href="#Async-RPC-Manager-Implementation" class="headerlink" title="Async RPC Manager Implementation"></a>Async RPC Manager Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncRpcManager</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageQueueProvider mqProvider;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, CallbackContext&gt; pendingRequests = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService timeoutExecutor;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">asyncPost</span><span class="params">(String url, Object requestBody, </span></span><br><span class="line"><span class="params">                             AsyncCallback&lt;T&gt; callback, Class&lt;T&gt; responseType)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">messageKey</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        <span class="type">String</span> <span class="variable">responseTopic</span> <span class="operator">=</span> <span class="string">&quot;async-rpc-responses-&quot;</span> + getServiceName();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Store callback context</span></span><br><span class="line">        <span class="type">CallbackContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CallbackContext</span>(callback, responseType, </span><br><span class="line">                                                     System.currentTimeMillis());</span><br><span class="line">        pendingRequests.put(messageKey, context);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Schedule timeout handling</span></span><br><span class="line">        scheduleTimeout(messageKey);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Make direct HTTP request with MQ response headers</span></span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">        headers.set(<span class="string">&quot;X-Message-Key&quot;</span>, messageKey);</span><br><span class="line">        headers.set(<span class="string">&quot;X-Response-Topic&quot;</span>, responseTopic);</span><br><span class="line">        headers.set(<span class="string">&quot;X-Correlation-ID&quot;</span>, messageKey);</span><br><span class="line">        headers.set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Send HTTP request directly - expect 202 Accepted for async processing</span></span><br><span class="line">            ResponseEntity&lt;Void&gt; response = restTemplate.postForEntity(url, </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(requestBody, headers), Void.class);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (response.getStatusCode() != HttpStatus.ACCEPTED) &#123;</span><br><span class="line">                <span class="comment">// Server doesn&#x27;t support async processing</span></span><br><span class="line">                pendingRequests.remove(messageKey);</span><br><span class="line">                callback.onError(<span class="keyword">new</span> <span class="title class_">AsyncRpcException</span>(<span class="string">&quot;Server returned &quot;</span> + response.getStatusCode() + </span><br><span class="line">                                                     <span class="string">&quot; - async processing not supported&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// If 202 Accepted, we wait for MQ response</span></span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// Clean up on immediate HTTP failure</span></span><br><span class="line">            pendingRequests.remove(messageKey);</span><br><span class="line">            callback.onError(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleResponseMessage</span><span class="params">(MessageReceivedEvent event)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">messageKey</span> <span class="operator">=</span> event.getMessageKey();</span><br><span class="line">        <span class="type">CallbackContext</span> <span class="variable">context</span> <span class="operator">=</span> pendingRequests.remove(messageKey);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (context != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">response</span> <span class="operator">=</span> deserializeResponse(event.getPayload(), </span><br><span class="line">                                                    context.getResponseType());</span><br><span class="line">                context.getCallback().onSuccess(response);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                context.getCallback().onError(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">scheduleTimeout</span><span class="params">(String messageKey)</span> &#123;</span><br><span class="line">        timeoutExecutor.schedule(() -&gt; &#123;</span><br><span class="line">            <span class="type">CallbackContext</span> <span class="variable">context</span> <span class="operator">=</span> pendingRequests.remove(messageKey);</span><br><span class="line">            <span class="keyword">if</span> (context != <span class="literal">null</span>) &#123;</span><br><span class="line">                context.getCallback().onTimeout();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Server-Side-Response-Handler"><a href="#Server-Side-Response-Handler" class="headerlink" title="Server-Side Response Handler"></a>Server-Side Response Handler</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncRpcController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageQueueProvider mqProvider;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/api/process-async&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Void&gt; <span class="title function_">processAsync</span><span class="params">(<span class="meta">@RequestBody</span> ProcessRequest request,</span></span><br><span class="line"><span class="params">                                           HttpServletRequest httpRequest)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">messageKey</span> <span class="operator">=</span> httpRequest.getHeader(<span class="string">&quot;X-Message-Key&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">responseTopic</span> <span class="operator">=</span> httpRequest.getHeader(<span class="string">&quot;X-Response-Topic&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (messageKey == <span class="literal">null</span> || responseTopic == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.badRequest().build();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Return 202 Accepted immediately - process asynchronously</span></span><br><span class="line">        CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Long-running business logic</span></span><br><span class="line">                <span class="type">ProcessResponse</span> <span class="variable">response</span> <span class="operator">=</span> businessService.process(request);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Send response via MQ when processing is complete</span></span><br><span class="line">                <span class="type">MessageProducer</span> <span class="variable">producer</span> <span class="operator">=</span> mqProvider.createProducer(</span><br><span class="line">                    ProducerConfig.builder()</span><br><span class="line">                        .topic(responseTopic)</span><br><span class="line">                        .build());</span><br><span class="line">                        </span><br><span class="line">                <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> Message.builder()</span><br><span class="line">                    .key(messageKey)</span><br><span class="line">                    .payload(response)</span><br><span class="line">                    .header(<span class="string">&quot;correlation-id&quot;</span>, messageKey)</span><br><span class="line">                    .header(<span class="string">&quot;processing-time&quot;</span>, String.valueOf(System.currentTimeMillis()))</span><br><span class="line">                    .build();</span><br><span class="line">                    </span><br><span class="line">                producer.send(message);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// Send error response via MQ</span></span><br><span class="line">                sendErrorResponse(responseTopic, messageKey, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Client gets immediate acknowledgment that request was accepted</span></span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.accepted()</span><br><span class="line">                .header(<span class="string">&quot;X-Message-Key&quot;</span>, messageKey)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Why use direct HTTP for requests instead of publishing to MQ?</em><br><em>Answer: Direct HTTP for requests provides immediate feedback (request validation, routing errors), utilizes existing HTTP infrastructure (load balancers, proxies, security), maintains request traceability, and reduces latency. The MQ is only used for the response path where asynchronous benefits (decoupling, persistence, fault tolerance) are most valuable. This hybrid approach gets the best of both worlds - immediate request processing feedback and asynchronous response handling.</em></p>
<h2 id="Message-Producer-and-Consumer-Interfaces"><a href="#Message-Producer-and-Consumer-Interfaces" class="headerlink" title="Message Producer and Consumer Interfaces"></a>Message Producer and Consumer Interfaces</h2><p>The SDK defines unified interfaces for message production and consumption that abstract the underlying MQ implementation details.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MessageProducer</span> <span class="keyword">extends</span> <span class="title class_">AutoCloseable</span> &#123;</span><br><span class="line">    CompletableFuture&lt;SendResult&gt; <span class="title function_">send</span><span class="params">(Message message)</span>;</span><br><span class="line">    CompletableFuture&lt;SendResult&gt; <span class="title function_">send</span><span class="params">(String topic, Object payload)</span>;</span><br><span class="line">    CompletableFuture&lt;SendResult&gt; <span class="title function_">sendWithKey</span><span class="params">(String topic, String key, Object payload)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Batch operations for performance</span></span><br><span class="line">    CompletableFuture&lt;List&lt;SendResult&gt;&gt; <span class="title function_">sendBatch</span><span class="params">(List&lt;Message&gt; messages)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Transactional support</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">beginTransaction</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">commitTransaction</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">rollbackTransaction</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MessageConsumer</span> <span class="keyword">extends</span> <span class="title class_">AutoCloseable</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(String topic, MessageHandler handler)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(List&lt;String&gt; topics, MessageHandler handler)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">unsubscribe</span><span class="params">(String topic)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Manual acknowledgment control</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">acknowledge</span><span class="params">(Message message)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">reject</span><span class="params">(Message message, <span class="type">boolean</span> requeue)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Consumer group management</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">joinConsumerGroup</span><span class="params">(String groupId)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">leaveConsumerGroup</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Unified message format</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String key;</span><br><span class="line">    <span class="keyword">private</span> Object payload;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; headers;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> timestamp;</span><br><span class="line">    <span class="keyword">private</span> String topic;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> partition;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> offset;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Serialization metadata</span></span><br><span class="line">    <span class="keyword">private</span> String contentType;</span><br><span class="line">    <span class="keyword">private</span> String encoding;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Redis-Streams-Implementation-Example"><a href="#Redis-Streams-Implementation-Example" class="headerlink" title="Redis Streams Implementation Example"></a>Redis Streams Implementation Example</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisMessageConsumer</span> <span class="keyword">implements</span> <span class="title class_">MessageConsumer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String consumerGroup;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String consumerName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">consuming</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(String topic, MessageHandler handler)</span> &#123;</span><br><span class="line">        <span class="comment">// Create consumer group if not exists</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForStream().createGroup(topic, consumerGroup);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// Group might already exist</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        consuming = <span class="literal">true</span>;</span><br><span class="line">        CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (consuming) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    List&lt;MapRecord&lt;String, Object, Object&gt;&gt; records = </span><br><span class="line">                        redisTemplate.opsForStream().read(</span><br><span class="line">                            Consumer.from(consumerGroup, consumerName),</span><br><span class="line">                            StreamReadOptions.empty().count(<span class="number">10</span>).block(Duration.ofSeconds(<span class="number">1</span>)),</span><br><span class="line">                            StreamOffset.create(topic, ReadOffset.lastConsumed())</span><br><span class="line">                        );</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">for</span> (MapRecord&lt;String, Object, Object&gt; record : records) &#123;</span><br><span class="line">                        <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> convertToMessage(record);</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            handler.handle(message);</span><br><span class="line">                            <span class="comment">// Acknowledge message</span></span><br><span class="line">                            redisTemplate.opsForStream().acknowledge(topic, consumerGroup, </span><br><span class="line">                                                                   record.getId());</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                            <span class="comment">// Handle processing error</span></span><br><span class="line">                            handleProcessingError(message, e);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    handleConsumerError(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleProcessingError</span><span class="params">(Message message, Exception error)</span> &#123;</span><br><span class="line">        <span class="comment">// Implement retry logic or dead letter queue</span></span><br><span class="line">        <span class="type">RetryPolicy</span> <span class="variable">retryPolicy</span> <span class="operator">=</span> getRetryPolicy();</span><br><span class="line">        <span class="keyword">if</span> (retryPolicy.shouldRetry(message)) &#123;</span><br><span class="line">            scheduleRetry(message, retryPolicy.getNextDelay());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sendToDeadLetterQueue(message, error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Failure-Handling-and-Resilience-Patterns"><a href="#Failure-Handling-and-Resilience-Patterns" class="headerlink" title="Failure Handling and Resilience Patterns"></a>Failure Handling and Resilience Patterns</h2><p>Robust failure handling is crucial for production systems. The SDK implements multiple resilience patterns to handle various failure scenarios.</p>
<pre>
<code class="mermaid">
flowchart LR
A[Message Send] --&gt; B{Send Success?}
B --&gt;|Yes| C[Success]
B --&gt;|No| D[Retry Logic]
D --&gt; E{Max Retries?}
E --&gt;|No| F[Exponential Backoff]
F --&gt; A
E --&gt;|Yes| G[Circuit Breaker]
G --&gt; H{Circuit Open?}
H --&gt;|Yes| I[Fail Fast]
H --&gt;|No| J[Dead Letter Queue]
J --&gt; K[Alert&#x2F;Monitor]
</code>
</pre>

<h3 id="Resilience-Implementation"><a href="#Resilience-Implementation" class="headerlink" title="Resilience Implementation"></a>Resilience Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResilientMessageProducer</span> <span class="keyword">implements</span> <span class="title class_">MessageProducer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageProducer delegate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RetryTemplate retryTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CircuitBreaker circuitBreaker;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DeadLetterQueueManager dlqManager;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ResilientMessageProducer</span><span class="params">(MessageProducer delegate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.delegate = delegate;</span><br><span class="line">        <span class="built_in">this</span>.retryTemplate = buildRetryTemplate();</span><br><span class="line">        <span class="built_in">this</span>.circuitBreaker = buildCircuitBreaker();</span><br><span class="line">        <span class="built_in">this</span>.dlqManager = <span class="keyword">new</span> <span class="title class_">DeadLetterQueueManager</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;SendResult&gt; <span class="title function_">send</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> circuitBreaker.executeSupplier(() -&gt; &#123;</span><br><span class="line">                    <span class="keyword">return</span> retryTemplate.execute(context -&gt; &#123;</span><br><span class="line">                        <span class="keyword">return</span> delegate.send(message).get();</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// Send to dead letter queue after all retries exhausted</span></span><br><span class="line">                dlqManager.sendToDeadLetterQueue(message, e);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MessageSendException</span>(<span class="string">&quot;Failed to send message after retries&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> RetryTemplate <span class="title function_">buildRetryTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> RetryTemplate.builder()</span><br><span class="line">            .maxAttempts(<span class="number">3</span>)</span><br><span class="line">            .exponentialBackoff(<span class="number">1000</span>, <span class="number">2</span>, <span class="number">10000</span>)</span><br><span class="line">            .retryOn(MessageSendException.class)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> CircuitBreaker <span class="title function_">buildCircuitBreaker</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CircuitBreaker.ofDefaults(<span class="string">&quot;messageProducer&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Dead Letter Queue Management</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeadLetterQueueManager</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageProducer dlqProducer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> NotificationService notificationService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendToDeadLetterQueue</span><span class="params">(Message originalMessage, Exception error)</span> &#123;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">dlqMessage</span> <span class="operator">=</span> Message.builder()</span><br><span class="line">            .payload(originalMessage)</span><br><span class="line">            .headers(Map.of(</span><br><span class="line">                <span class="string">&quot;original-topic&quot;</span>, originalMessage.getTopic(),</span><br><span class="line">                <span class="string">&quot;error-message&quot;</span>, error.getMessage(),</span><br><span class="line">                <span class="string">&quot;error-type&quot;</span>, error.getClass().getSimpleName(),</span><br><span class="line">                <span class="string">&quot;failure-timestamp&quot;</span>, String.valueOf(System.currentTimeMillis())</span><br><span class="line">            ))</span><br><span class="line">            .topic(<span class="string">&quot;dead-letter-queue&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            dlqProducer.send(dlqMessage);</span><br><span class="line">            notificationService.alertDeadLetter(originalMessage, error);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception dlqError) &#123;</span><br><span class="line">            <span class="comment">// Log to persistent storage as last resort</span></span><br><span class="line">            persistentLogger.logFailedMessage(originalMessage, error, dlqError);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Network-Partition-Handling"><a href="#Network-Partition-Handling" class="headerlink" title="Network Partition Handling"></a>Network Partition Handling</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NetworkPartitionHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HealthCheckService healthCheckService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LocalMessageBuffer localBuffer;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleNetworkPartition</span><span class="params">(NetworkPartitionEvent event)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (event.isPartitioned()) &#123;</span><br><span class="line">            <span class="comment">// Switch to local buffering mode</span></span><br><span class="line">            localBuffer.enableBuffering();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Start health check monitoring</span></span><br><span class="line">            healthCheckService.startPartitionRecoveryMonitoring();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Network recovered - flush buffered messages</span></span><br><span class="line">            flushBufferedMessages();</span><br><span class="line">            localBuffer.disableBuffering();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">flushBufferedMessages</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Message&gt; bufferedMessages = localBuffer.getAllBufferedMessages();</span><br><span class="line">        </span><br><span class="line">        CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (Message message : bufferedMessages) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    delegate.send(message).get();</span><br><span class="line">                    localBuffer.removeBufferedMessage(message.getId());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="comment">// Keep in buffer for next flush attempt</span></span><br><span class="line">                    logger.warn(<span class="string">&quot;Failed to flush buffered message: &#123;&#125;&quot;</span>, message.getId(), e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>How do you handle message ordering in failure scenarios?</em><br><em>Answer: Message ordering can be maintained through partitioning strategies (same key goes to same partition), single-threaded consumers per partition, and implementing sequence numbers with gap detection. However, strict ordering often conflicts with high availability, so systems typically choose between strong ordering and high availability based on business requirements.</em></p>
<h2 id="Configuration-and-Best-Practices"><a href="#Configuration-and-Best-Practices" class="headerlink" title="Configuration and Best Practices"></a>Configuration and Best Practices</h2><h3 id="Configuration-Management"><a href="#Configuration-Management" class="headerlink" title="Configuration Management"></a>Configuration Management</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.yml</span></span><br><span class="line"><span class="attr">universal-mq:</span></span><br><span class="line">  <span class="attr">provider:</span> <span class="string">kafka</span>  <span class="comment"># kafka, redis, rocketmq</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Common configuration</span></span><br><span class="line">  <span class="attr">async-rpc:</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">30s</span></span><br><span class="line">    <span class="attr">max-pending-requests:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">response-topic-prefix:</span> <span class="string">&quot;async-rpc-responses&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">resilience:</span></span><br><span class="line">    <span class="attr">retry:</span></span><br><span class="line">      <span class="attr">max-attempts:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">initial-delay:</span> <span class="string">1s</span></span><br><span class="line">      <span class="attr">max-delay:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">multiplier:</span> <span class="number">2.0</span></span><br><span class="line">    <span class="attr">circuit-breaker:</span></span><br><span class="line">      <span class="attr">failure-rate-threshold:</span> <span class="number">50</span></span><br><span class="line">      <span class="attr">wait-duration-in-open-state:</span> <span class="string">60s</span></span><br><span class="line">      <span class="attr">sliding-window-size:</span> <span class="number">100</span></span><br><span class="line">    <span class="attr">dead-letter-queue:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">topic:</span> <span class="string">&quot;dead-letter-queue&quot;</span></span><br><span class="line">      </span><br><span class="line">  <span class="comment"># Provider-specific configuration</span></span><br><span class="line">  <span class="attr">kafka:</span></span><br><span class="line">    <span class="attr">bootstrap-servers:</span> <span class="string">&quot;localhost:9092&quot;</span></span><br><span class="line">    <span class="attr">producer:</span></span><br><span class="line">      <span class="attr">acks:</span> <span class="string">&quot;all&quot;</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">2147483647</span></span><br><span class="line">      <span class="attr">enable-idempotence:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">batch-size:</span> <span class="number">16384</span></span><br><span class="line">      <span class="attr">linger-ms:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">consumer:</span></span><br><span class="line">      <span class="attr">group-id:</span> <span class="string">&quot;universal-mq-consumers&quot;</span></span><br><span class="line">      <span class="attr">auto-offset-reset:</span> <span class="string">&quot;earliest&quot;</span></span><br><span class="line">      <span class="attr">enable-auto-commit:</span> <span class="literal">false</span></span><br><span class="line">      </span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">&quot;localhost&quot;</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">      <span class="attr">consumer-group:</span> <span class="string">&quot;universal-mq-group&quot;</span></span><br><span class="line">      <span class="attr">consumer-name:</span> <span class="string">&quot;$&#123;spring.application.name&#125;-$&#123;random.uuid&#125;&quot;</span></span><br><span class="line">      </span><br><span class="line">  <span class="attr">rocketmq:</span></span><br><span class="line">    <span class="attr">name-server:</span> <span class="string">&quot;localhost:9876&quot;</span></span><br><span class="line">    <span class="attr">producer:</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">&quot;universal-mq-producers&quot;</span></span><br><span class="line">      <span class="attr">send-msg-timeout:</span> <span class="number">3000</span></span><br><span class="line">    <span class="attr">consumer:</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">&quot;universal-mq-consumers&quot;</span></span><br><span class="line">      <span class="attr">consume-message-batch-max-size:</span> <span class="number">32</span></span><br></pre></td></tr></table></figure>

<h3 id="Production-Best-Practices"><a href="#Production-Best-Practices" class="headerlink" title="Production Best Practices"></a>Production Best Practices</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(UniversalMqProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UniversalMqConfiguration</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty(name = &quot;universal-mq.monitoring.enabled&quot;, havingValue = &quot;true&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> MqMetricsCollector <span class="title function_">metricsCollector</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MqMetricsCollector</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MessageQueueHealthIndicator <span class="title function_">healthIndicator</span><span class="params">(MessageQueueProvider provider)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MessageQueueHealthIndicator</span>(provider);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Production-ready thread pool configuration</span></span><br><span class="line">    <span class="meta">@Bean(&quot;mqExecutor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Executor <span class="title function_">taskExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">        executor.setCorePoolSize(<span class="number">10</span>);</span><br><span class="line">        executor.setMaxPoolSize(<span class="number">50</span>);</span><br><span class="line">        executor.setQueueCapacity(<span class="number">1000</span>);</span><br><span class="line">        executor.setKeepAliveSeconds(<span class="number">60</span>);</span><br><span class="line">        executor.setThreadNamePrefix(<span class="string">&quot;mq-&quot;</span>);</span><br><span class="line">        executor.setRejectedExecutionHandler(<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());</span><br><span class="line">        executor.initialize();</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Monitoring and Metrics</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqMetricsCollector</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter messagesProduced;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter messagesConsumed;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Timer messageProcessingTime;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MqMetricsCollector</span><span class="params">(MeterRegistry meterRegistry)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.meterRegistry = meterRegistry;</span><br><span class="line">        <span class="built_in">this</span>.messagesProduced = Counter.builder(<span class="string">&quot;mq.messages.produced&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Number of messages produced&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">        <span class="built_in">this</span>.messagesConsumed = Counter.builder(<span class="string">&quot;mq.messages.consumed&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Number of messages consumed&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">        <span class="built_in">this</span>.messageProcessingTime = Timer.builder(<span class="string">&quot;mq.message.processing.time&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Message processing time&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordMessageProduced</span><span class="params">(String topic, String provider)</span> &#123;</span><br><span class="line">        messagesProduced.increment(</span><br><span class="line">            Tags.of(<span class="string">&quot;topic&quot;</span>, topic, <span class="string">&quot;provider&quot;</span>, provider));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordMessageConsumed</span><span class="params">(String topic, String provider, <span class="type">long</span> processingTimeMs)</span> &#123;</span><br><span class="line">        messagesConsumed.increment(</span><br><span class="line">            Tags.of(<span class="string">&quot;topic&quot;</span>, topic, <span class="string">&quot;provider&quot;</span>, provider));</span><br><span class="line">        messageProcessingTime.record(processingTimeMs, TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Use-Cases-and-Examples"><a href="#Use-Cases-and-Examples" class="headerlink" title="Use Cases and Examples"></a>Use Cases and Examples</h2><h3 id="Use-Case-1-E-commerce-Order-Processing"><a href="#Use-Case-1-E-commerce-Order-Processing" class="headerlink" title="Use Case 1: E-commerce Order Processing"></a>Use Case 1: E-commerce Order Processing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Order processing with async notification</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AsyncRpcManager asyncRpcManager;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageProducer messageProducer;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processOrder</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">        <span class="comment">// Validate and save order</span></span><br><span class="line">        <span class="type">Order</span> <span class="variable">savedOrder</span> <span class="operator">=</span> orderRepository.save(order);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Async inventory check via direct HTTP + MQ response</span></span><br><span class="line">        asyncRpcManager.asyncPost(</span><br><span class="line">            <span class="string">&quot;http://inventory-service/check&quot;</span>, </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InventoryCheckRequest</span>(order.getItems()),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">AsyncCallback</span>&lt;InventoryCheckResponse&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(InventoryCheckResponse response)</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (response.isAvailable()) &#123;</span><br><span class="line">                        processPayment(savedOrder);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        cancelOrder(savedOrder, <span class="string">&quot;Insufficient inventory&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Exception error)</span> &#123;</span><br><span class="line">                    cancelOrder(savedOrder, <span class="string">&quot;Inventory check failed: &quot;</span> + error.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTimeout</span><span class="params">()</span> &#123;</span><br><span class="line">                    cancelOrder(savedOrder, <span class="string">&quot;Inventory check timeout&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            InventoryCheckResponse.class</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processPayment</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">        <span class="comment">// Async payment processing via direct HTTP + MQ response</span></span><br><span class="line">        asyncRpcManager.asyncPost(</span><br><span class="line">            <span class="string">&quot;http://payment-service/process&quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">PaymentRequest</span>(order.getTotalAmount(), order.getPaymentMethod()),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">PaymentCallback</span>(order),</span><br><span class="line">            PaymentResponse.class</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Inventory service response handler</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/check&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Void&gt; <span class="title function_">checkInventory</span><span class="params">(<span class="meta">@RequestBody</span> InventoryCheckRequest request,</span></span><br><span class="line"><span class="params">                                              HttpServletRequest httpRequest)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">messageKey</span> <span class="operator">=</span> httpRequest.getHeader(<span class="string">&quot;X-Message-Key&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">responseTopic</span> <span class="operator">=</span> httpRequest.getHeader(<span class="string">&quot;X-Response-Topic&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Process asynchronously and return 202 Accepted immediately</span></span><br><span class="line">        CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            <span class="type">InventoryCheckResponse</span> <span class="variable">response</span> <span class="operator">=</span> inventoryService.checkAvailability(request.getItems());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Send response via MQ after processing is complete</span></span><br><span class="line">            <span class="type">Message</span> <span class="variable">responseMessage</span> <span class="operator">=</span> Message.builder()</span><br><span class="line">                .key(messageKey)</span><br><span class="line">                .payload(response)</span><br><span class="line">                .topic(responseTopic)</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">                messageProducer.send(responseMessage);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.accepted()</span><br><span class="line">                .header(<span class="string">&quot;X-Message-Key&quot;</span>, messageKey)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Use-Case-2-Real-time-Analytics-Pipeline"><a href="#Use-Case-2-Real-time-Analytics-Pipeline" class="headerlink" title="Use Case 2: Real-time Analytics Pipeline"></a>Use Case 2: Real-time Analytics Pipeline</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Event streaming for analytics</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnalyticsEventProcessor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageConsumer eventConsumer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageProducer enrichedEventProducer;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startProcessing</span><span class="params">()</span> &#123;</span><br><span class="line">        eventConsumer.subscribe(<span class="string">&quot;user-events&quot;</span>, <span class="built_in">this</span>::processUserEvent);</span><br><span class="line">        eventConsumer.subscribe(<span class="string">&quot;system-events&quot;</span>, <span class="built_in">this</span>::processSystemEvent);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processUserEvent</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="type">UserEvent</span> <span class="variable">event</span> <span class="operator">=</span> (UserEvent) message.getPayload();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Enrich event with user profile data</span></span><br><span class="line">        <span class="type">UserProfile</span> <span class="variable">profile</span> <span class="operator">=</span> userProfileService.getProfile(event.getUserId());</span><br><span class="line">        <span class="type">EnrichedUserEvent</span> <span class="variable">enrichedEvent</span> <span class="operator">=</span> EnrichedUserEvent.builder()</span><br><span class="line">            .originalEvent(event)</span><br><span class="line">            .userProfile(profile)</span><br><span class="line">            .enrichmentTimestamp(System.currentTimeMillis())</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Send to analytics pipeline</span></span><br><span class="line">        enrichedEventProducer.send(<span class="string">&quot;enriched-user-events&quot;</span>, enrichedEvent);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Update real-time metrics</span></span><br><span class="line">        metricsService.updateUserMetrics(enrichedEvent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Use-Case-3-Microservice-Choreography"><a href="#Use-Case-3-Microservice-Choreography" class="headerlink" title="Use Case 3: Microservice Choreography"></a>Use Case 3: Microservice Choreography</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Saga pattern implementation</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderSagaOrchestrator</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, SagaState&gt; activeSagas = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleOrderCreated</span><span class="params">(OrderCreatedEvent event)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sagaId</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        <span class="type">SagaState</span> <span class="variable">saga</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SagaState</span>(sagaId, event.getOrder());</span><br><span class="line">        activeSagas.put(sagaId, saga);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Start saga - reserve inventory</span></span><br><span class="line">        asyncRpcManager.asyncPost(</span><br><span class="line">            <span class="string">&quot;http://inventory-service/reserve&quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ReserveInventoryRequest</span>(event.getOrder().getItems(), sagaId),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InventoryReservationCallback</span>(sagaId),</span><br><span class="line">            ReservationResponse.class</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryReservationCallback</span> <span class="keyword">implements</span> <span class="title class_">AsyncCallback</span>&lt;ReservationResponse&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String sagaId;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(ReservationResponse response)</span> &#123;</span><br><span class="line">            <span class="type">SagaState</span> <span class="variable">saga</span> <span class="operator">=</span> activeSagas.get(sagaId);</span><br><span class="line">            <span class="keyword">if</span> (response.isSuccess()) &#123;</span><br><span class="line">                saga.markInventoryReserved();</span><br><span class="line">                <span class="comment">// Next step - process payment</span></span><br><span class="line">                processPayment(saga);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Compensate - cancel order</span></span><br><span class="line">                compensateOrder(saga);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Exception error)</span> &#123;</span><br><span class="line">            compensateOrder(activeSagas.get(sagaId));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>How do you handle distributed transactions across multiple services?</em><br><em>Answer: Use saga patterns (orchestration or choreography) rather than two-phase commit. Implement compensating actions for each step, maintain saga state, and use event sourcing for audit trails. The Universal MQ SDK enables reliable event delivery needed for saga coordination.</em></p>
<h2 id="Performance-Optimization"><a href="#Performance-Optimization" class="headerlink" title="Performance Optimization"></a>Performance Optimization</h2><h3 id="Batching-and-Throughput-Optimization"><a href="#Batching-and-Throughput-Optimization" class="headerlink" title="Batching and Throughput Optimization"></a>Batching and Throughput Optimization</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BatchingMessageProducer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Message&gt; messageBuffer = <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">10000</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ScheduledExecutorService</span> <span class="variable">batchProcessor</span> <span class="operator">=</span> </span><br><span class="line">        Executors.newSingleThreadScheduledExecutor();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startBatchProcessing</span><span class="params">()</span> &#123;</span><br><span class="line">        batchProcessor.scheduleWithFixedDelay(<span class="built_in">this</span>::processBatch, <span class="number">100</span>, <span class="number">100</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;SendResult&gt; <span class="title function_">send</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        CompletableFuture&lt;SendResult&gt; future = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;&gt;();</span><br><span class="line">        message.setResultFuture(future);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!messageBuffer.offer(message)) &#123;</span><br><span class="line">            future.completeExceptionally(<span class="keyword">new</span> <span class="title class_">BufferFullException</span>(<span class="string">&quot;Message buffer is full&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> future;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processBatch</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Message&gt; batch = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        messageBuffer.drainTo(batch, <span class="number">100</span>); <span class="comment">// Max batch size</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!batch.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                List&lt;SendResult&gt; results = delegate.sendBatch(batch).get();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Complete futures</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; batch.size(); i++) &#123;</span><br><span class="line">                    batch.get(i).getResultFuture().complete(results.get(i));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// Complete all futures exceptionally</span></span><br><span class="line">                batch.forEach(msg -&gt; </span><br><span class="line">                    msg.getResultFuture().completeExceptionally(e));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Connection-Pooling-and-Resource-Management"><a href="#Connection-Pooling-and-Resource-Management" class="headerlink" title="Connection Pooling and Resource Management"></a>Connection Pooling and Resource Management</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqConnectionPool</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GenericObjectPool&lt;Connection&gt; connectionPool;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MqConnectionPool</span><span class="params">(ConnectionFactory factory)</span> &#123;</span><br><span class="line">        GenericObjectPoolConfig&lt;Connection&gt; config = <span class="keyword">new</span> <span class="title class_">GenericObjectPoolConfig</span>&lt;&gt;();</span><br><span class="line">        config.setMaxTotal(<span class="number">50</span>);</span><br><span class="line">        config.setMaxIdle(<span class="number">10</span>);</span><br><span class="line">        config.setMinIdle(<span class="number">5</span>);</span><br><span class="line">        config.setTestOnBorrow(<span class="literal">true</span>);</span><br><span class="line">        config.setTestWhileIdle(<span class="literal">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">this</span>.connectionPool = <span class="keyword">new</span> <span class="title class_">GenericObjectPool</span>&lt;&gt;(factory, config);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">executeWithConnection</span><span class="params">(ConnectionCallback&lt;T&gt; callback)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> connectionPool.borrowObject();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> callback.execute(connection);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            connectionPool.returnObject(connection);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Testing-Strategies"><a href="#Testing-Strategies" class="headerlink" title="Testing Strategies"></a>Testing Strategies</h2><h3 id="Integration-Testing-with-Testcontainers"><a href="#Integration-Testing-with-Testcontainers" class="headerlink" title="Integration Testing with Testcontainers"></a>Integration Testing with Testcontainers</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Testcontainers</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UniversalMqIntegrationTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Container</span></span><br><span class="line">    <span class="keyword">static</span> <span class="type">KafkaContainer</span> <span class="variable">kafka</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">KafkaContainer</span>(DockerImageName.parse(<span class="string">&quot;confluentinc/cp-kafka:latest&quot;</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Container</span></span><br><span class="line">    <span class="keyword">static</span> GenericContainer&lt;?&gt; redis = <span class="keyword">new</span> <span class="title class_">GenericContainer</span>&lt;&gt;(<span class="string">&quot;redis:7-alpine&quot;</span>)</span><br><span class="line">            .withExposedPorts(<span class="number">6379</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UniversalMqSDK mqSDK;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@DynamicPropertySource</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">configureProperties</span><span class="params">(DynamicPropertyRegistry registry)</span> &#123;</span><br><span class="line">        registry.add(<span class="string">&quot;universal-mq.kafka.bootstrap-servers&quot;</span>, kafka::getBootstrapServers);</span><br><span class="line">        registry.add(<span class="string">&quot;universal-mq.redis.host&quot;</span>, redis::getHost);</span><br><span class="line">        registry.add(<span class="string">&quot;universal-mq.redis.port&quot;</span>, () -&gt; redis.getMappedPort(<span class="number">6379</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testAsyncRpcWithKafka</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// Configure for Kafka</span></span><br><span class="line">        mqSDK.switchProvider(<span class="string">&quot;kafka&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">        AtomicReference&lt;String&gt; responseRef = <span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Mock HTTP server response</span></span><br><span class="line">        mockWebServer.enqueue(<span class="keyword">new</span> <span class="title class_">MockResponse</span>().setResponseCode(<span class="number">202</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Send async request</span></span><br><span class="line">        mqSDK.asyncPost(<span class="string">&quot;http://localhost:&quot;</span> + mockWebServer.getPort() + <span class="string">&quot;/test&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">TestRequest</span>(<span class="string">&quot;test data&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">AsyncCallback</span>&lt;TestResponse&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(TestResponse response)</span> &#123;</span><br><span class="line">                        responseRef.set(response.getMessage());</span><br><span class="line">                        latch.countDown();</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Exception error)</span> &#123;</span><br><span class="line">                        latch.countDown();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                TestResponse.class);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Simulate server response</span></span><br><span class="line">        simulateServerResponse(<span class="string">&quot;test-message-key&quot;</span>, <span class="string">&quot;Test response&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        assertTrue(latch.await(<span class="number">10</span>, TimeUnit.SECONDS));</span><br><span class="line">        assertEquals(<span class="string">&quot;Test response&quot;</span>, responseRef.get());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testProviderSwitching</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Test switching between providers</span></span><br><span class="line">        mqSDK.switchProvider(<span class="string">&quot;kafka&quot;</span>);</span><br><span class="line">        assertEquals(<span class="string">&quot;kafka&quot;</span>, mqSDK.getCurrentProvider());</span><br><span class="line">        </span><br><span class="line">        mqSDK.switchProvider(<span class="string">&quot;redis&quot;</span>);</span><br><span class="line">        assertEquals(<span class="string">&quot;redis&quot;</span>, mqSDK.getCurrentProvider());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Verify both providers work</span></span><br><span class="line">        assertDoesNotThrow(() -&gt; &#123;</span><br><span class="line">            mqSDK.send(<span class="string">&quot;test-topic&quot;</span>, <span class="string">&quot;test message&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testFailureRecovery</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// Test circuit breaker and retry mechanisms</span></span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">errorLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">3</span>); <span class="comment">// Expect 3 retries</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Mock server to fail initially then succeed</span></span><br><span class="line">        mockWebServer.enqueue(<span class="keyword">new</span> <span class="title class_">MockResponse</span>().setResponseCode(<span class="number">500</span>));</span><br><span class="line">        mockWebServer.enqueue(<span class="keyword">new</span> <span class="title class_">MockResponse</span>().setResponseCode(<span class="number">500</span>));</span><br><span class="line">        mockWebServer.enqueue(<span class="keyword">new</span> <span class="title class_">MockResponse</span>().setResponseCode(<span class="number">202</span>));</span><br><span class="line">        </span><br><span class="line">        mqSDK.asyncPost(<span class="string">&quot;http://localhost:&quot;</span> + mockWebServer.getPort() + <span class="string">&quot;/fail-test&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">TestRequest</span>(<span class="string">&quot;retry test&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">AsyncCallback</span>&lt;TestResponse&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(TestResponse response)</span> &#123;</span><br><span class="line">                        <span class="comment">// Should eventually succeed</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Exception error)</span> &#123;</span><br><span class="line">                        errorLatch.countDown();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                TestResponse.class);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Verify retry attempts</span></span><br><span class="line">        assertTrue(errorLatch.await(<span class="number">5</span>, TimeUnit.SECONDS));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Unit-Testing-with-Mocks"><a href="#Unit-Testing-with-Mocks" class="headerlink" title="Unit Testing with Mocks"></a>Unit Testing with Mocks</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExtendWith(MockitoExtension.class)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AsyncRpcManagerTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> MessageQueueProvider mqProvider;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> MessageProducer messageProducer;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@InjectMocks</span></span><br><span class="line">    <span class="keyword">private</span> AsyncRpcManager asyncRpcManager;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testSuccessfulAsyncCall</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Setup</span></span><br><span class="line">        <span class="keyword">when</span>(mqProvider.createProducer(any())).thenReturn(messageProducer);</span><br><span class="line">        <span class="keyword">when</span>(restTemplate.postForEntity(any(String.class), any(), eq(Void.class)))</span><br><span class="line">                .thenReturn(ResponseEntity.accepted().build());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Test</span></span><br><span class="line">        CompletableFuture&lt;String&gt; future = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;&gt;();</span><br><span class="line">        asyncRpcManager.asyncPost(<span class="string">&quot;http://test.com/api&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">TestRequest</span>(<span class="string">&quot;test&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">AsyncCallback</span>&lt;String&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(String response)</span> &#123;</span><br><span class="line">                        future.complete(response);</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Exception error)</span> &#123;</span><br><span class="line">                        future.completeExceptionally(error);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                String.class);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Simulate response</span></span><br><span class="line">        <span class="type">MessageReceivedEvent</span> <span class="variable">event</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageReceivedEvent</span>(<span class="string">&quot;test-message-key&quot;</span>, <span class="string">&quot;Success response&quot;</span>);</span><br><span class="line">        asyncRpcManager.handleResponseMessage(event);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Verify</span></span><br><span class="line">        assertDoesNotThrow(() -&gt; assertEquals(<span class="string">&quot;Success response&quot;</span>, future.get(<span class="number">1</span>, TimeUnit.SECONDS)));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testTimeoutHandling</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Configure short timeout for testing</span></span><br><span class="line">        asyncRpcManager.setTimeout(Duration.ofMillis(<span class="number">100</span>));</span><br><span class="line">        </span><br><span class="line">        CompletableFuture&lt;Boolean&gt; timeoutFuture = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        asyncRpcManager.asyncPost(<span class="string">&quot;http://test.com/api&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">TestRequest</span>(<span class="string">&quot;timeout test&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">AsyncCallback</span>&lt;String&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(String response)</span> &#123;</span><br><span class="line">                        timeoutFuture.complete(<span class="literal">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTimeout</span><span class="params">()</span> &#123;</span><br><span class="line">                        timeoutFuture.complete(<span class="literal">true</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Exception error)</span> &#123;</span><br><span class="line">                        timeoutFuture.completeExceptionally(error);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                String.class);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Verify timeout occurs</span></span><br><span class="line">        assertDoesNotThrow(() -&gt; assertTrue(timeoutFuture.get(<span class="number">1</span>, TimeUnit.SECONDS)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Security-Considerations"><a href="#Security-Considerations" class="headerlink" title="Security Considerations"></a>Security Considerations</h2><h3 id="Message-Encryption-and-Authentication"><a href="#Message-Encryption-and-Authentication" class="headerlink" title="Message Encryption and Authentication"></a>Message Encryption and Authentication</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecureMessageProducer</span> <span class="keyword">implements</span> <span class="title class_">MessageProducer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageProducer delegate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EncryptionService encryptionService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthenticationService authService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;SendResult&gt; <span class="title function_">send</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="comment">// Add authentication headers</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">authToken</span> <span class="operator">=</span> authService.generateToken();</span><br><span class="line">        message.getHeaders().put(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;Bearer &quot;</span> + authToken);</span><br><span class="line">        message.getHeaders().put(<span class="string">&quot;X-Client-ID&quot;</span>, authService.getClientId());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Encrypt sensitive payload</span></span><br><span class="line">        <span class="keyword">if</span> (isSensitiveMessage(message)) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">encryptedPayload</span> <span class="operator">=</span> encryptionService.encrypt(message.getPayload());</span><br><span class="line">            message = message.toBuilder()</span><br><span class="line">                    .payload(encryptedPayload)</span><br><span class="line">                    .header(<span class="string">&quot;Encrypted&quot;</span>, <span class="string">&quot;true&quot;</span>)</span><br><span class="line">                    .header(<span class="string">&quot;Encryption-Algorithm&quot;</span>, encryptionService.getAlgorithm())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> delegate.send(message);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isSensitiveMessage</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> message.getHeaders().containsKey(<span class="string">&quot;Sensitive&quot;</span>) ||</span><br><span class="line">               message.getPayload() <span class="keyword">instanceof</span> PersonalData ||</span><br><span class="line">               message.getTopic().contains(<span class="string">&quot;pii&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecureMessageConsumer</span> <span class="keyword">implements</span> <span class="title class_">MessageConsumer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageConsumer delegate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EncryptionService encryptionService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthenticationService authService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(String topic, MessageHandler handler)</span> &#123;</span><br><span class="line">        delegate.subscribe(topic, <span class="keyword">new</span> <span class="title class_">SecureMessageHandler</span>(handler));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">SecureMessageHandler</span> <span class="keyword">implements</span> <span class="title class_">MessageHandler</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> MessageHandler delegate;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">SecureMessageHandler</span><span class="params">(MessageHandler delegate)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.delegate = delegate;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">            <span class="comment">// Verify authentication</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">authHeader</span> <span class="operator">=</span> message.getHeaders().get(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!authService.validateToken(authHeader)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnauthorizedMessageException</span>(<span class="string">&quot;Invalid authentication token&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Decrypt if necessary</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;true&quot;</span>.equals(message.getHeaders().get(<span class="string">&quot;Encrypted&quot;</span>))) &#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">decryptedPayload</span> <span class="operator">=</span> encryptionService.decrypt(message.getPayload());</span><br><span class="line">                message = message.toBuilder().payload(decryptedPayload).build();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            delegate.handle(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Access-Control-and-Topic-Security"><a href="#Access-Control-and-Topic-Security" class="headerlink" title="Access Control and Topic Security"></a>Access Control and Topic Security</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TopicAccessController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AccessControlService accessControlService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">validateTopicAccess</span><span class="params">(String topic, String operation, String clientId)</span> &#123;</span><br><span class="line">        <span class="type">TopicPermission</span> <span class="variable">permission</span> <span class="operator">=</span> TopicPermission.valueOf(operation.toUpperCase());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!accessControlService.hasPermission(clientId, topic, permission)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AccessDeniedException</span>(</span><br><span class="line">                String.format(<span class="string">&quot;Client %s does not have %s permission for topic %s&quot;</span>, </span><br><span class="line">                             clientId, operation, topic));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasRole(&#x27;ADMIN&#x27;) or hasPermission(#topic, &#x27;WRITE&#x27;)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createTopic</span><span class="params">(String topic, TopicConfiguration config)</span> &#123;</span><br><span class="line">        <span class="comment">// Topic creation logic</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasPermission(#topic, &#x27;READ&#x27;)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">subscribeTo</span><span class="params">(String topic)</span> &#123;</span><br><span class="line">        <span class="comment">// Subscription logic</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Monitoring-and-Observability"><a href="#Monitoring-and-Observability" class="headerlink" title="Monitoring and Observability"></a>Monitoring and Observability</h2><h3 id="Distributed-Tracing-Integration"><a href="#Distributed-Tracing-Integration" class="headerlink" title="Distributed Tracing Integration"></a>Distributed Tracing Integration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TracingMessageProducer</span> <span class="keyword">implements</span> <span class="title class_">MessageProducer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageProducer delegate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Tracer tracer;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;SendResult&gt; <span class="title function_">send</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="type">Span</span> <span class="variable">span</span> <span class="operator">=</span> tracer.nextSpan()</span><br><span class="line">                .name(<span class="string">&quot;message-send&quot;</span>)</span><br><span class="line">                .tag(<span class="string">&quot;mq.topic&quot;</span>, message.getTopic())</span><br><span class="line">                .tag(<span class="string">&quot;mq.key&quot;</span>, message.getKey())</span><br><span class="line">                .start();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> (Tracer.<span class="type">SpanInScope</span> <span class="variable">ws</span> <span class="operator">=</span> tracer.withSpanInScope(span)) &#123;</span><br><span class="line">            <span class="comment">// Inject trace context into message headers</span></span><br><span class="line">            <span class="type">TraceContext</span> <span class="variable">traceContext</span> <span class="operator">=</span> span.context();</span><br><span class="line">            message.getHeaders().put(<span class="string">&quot;X-Trace-ID&quot;</span>, traceContext.traceId());</span><br><span class="line">            message.getHeaders().put(<span class="string">&quot;X-Span-ID&quot;</span>, traceContext.spanId());</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> delegate.send(message)</span><br><span class="line">                    .whenComplete((result, throwable) -&gt; &#123;</span><br><span class="line">                        <span class="keyword">if</span> (throwable != <span class="literal">null</span>) &#123;</span><br><span class="line">                            span.tag(<span class="string">&quot;error&quot;</span>, throwable.getMessage());</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            span.tag(<span class="string">&quot;mq.partition&quot;</span>, String.valueOf(result.getPartition()));</span><br><span class="line">                            span.tag(<span class="string">&quot;mq.offset&quot;</span>, String.valueOf(result.getOffset()));</span><br><span class="line">                        &#125;</span><br><span class="line">                        span.end();</span><br><span class="line">                    &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TracingMessageConsumer</span> <span class="keyword">implements</span> <span class="title class_">MessageConsumer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageConsumer delegate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Tracer tracer;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(String topic, MessageHandler handler)</span> &#123;</span><br><span class="line">        delegate.subscribe(topic, <span class="keyword">new</span> <span class="title class_">TracingMessageHandler</span>(handler));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">TracingMessageHandler</span> <span class="keyword">implements</span> <span class="title class_">MessageHandler</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> MessageHandler delegate;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">            <span class="comment">// Extract trace context from message headers</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">traceId</span> <span class="operator">=</span> message.getHeaders().get(<span class="string">&quot;X-Trace-ID&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">spanId</span> <span class="operator">=</span> message.getHeaders().get(<span class="string">&quot;X-Span-ID&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="type">SpanBuilder</span> <span class="variable">spanBuilder</span> <span class="operator">=</span> tracer.nextSpan()</span><br><span class="line">                    .name(<span class="string">&quot;message-consume&quot;</span>)</span><br><span class="line">                    .tag(<span class="string">&quot;mq.topic&quot;</span>, message.getTopic())</span><br><span class="line">                    .tag(<span class="string">&quot;mq.key&quot;</span>, message.getKey());</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (traceId != <span class="literal">null</span> &amp;&amp; spanId != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Continue trace from producer</span></span><br><span class="line">                spanBuilder = spanBuilder.asChildOf(createSpanContext(traceId, spanId));</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="type">Span</span> <span class="variable">span</span> <span class="operator">=</span> spanBuilder.start();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> (Tracer.<span class="type">SpanInScope</span> <span class="variable">ws</span> <span class="operator">=</span> tracer.withSpanInScope(span)) &#123;</span><br><span class="line">                delegate.handle(message);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                span.tag(<span class="string">&quot;error&quot;</span>, e.getMessage());</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                span.end();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Health-Checks-and-Metrics-Dashboard"><a href="#Health-Checks-and-Metrics-Dashboard" class="headerlink" title="Health Checks and Metrics Dashboard"></a>Health Checks and Metrics Dashboard</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqHealthIndicator</span> <span class="keyword">implements</span> <span class="title class_">HealthIndicator</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;MessageQueueProvider&gt; providers;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Health <span class="title function_">health</span><span class="params">()</span> &#123;</span><br><span class="line">        Health.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Health</span>.Builder();</span><br><span class="line">        </span><br><span class="line">        <span class="type">boolean</span> <span class="variable">allHealthy</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        Map&lt;String, Object&gt; details = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (MessageQueueProvider provider : providers) &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">healthy</span> <span class="operator">=</span> provider.isHealthy();</span><br><span class="line">            allHealthy &amp;= healthy;</span><br><span class="line">            </span><br><span class="line">            details.put(provider.getProviderName() + <span class="string">&quot;.status&quot;</span>, </span><br><span class="line">                       healthy ? <span class="string">&quot;UP&quot;</span> : <span class="string">&quot;DOWN&quot;</span>);</span><br><span class="line">            details.put(provider.getProviderName() + <span class="string">&quot;.metrics&quot;</span>, </span><br><span class="line">                       provider.getMetrics());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> allHealthy ? builder.up().withDetails(details).build() :</span><br><span class="line">                           builder.down().withDetails(details).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Custom metrics for business monitoring</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BusinessMetricsCollector</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Track message processing latency by business context</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordBusinessOperationLatency</span><span class="params">(String operation, <span class="type">long</span> latencyMs)</span> &#123;</span><br><span class="line">        Timer.builder(<span class="string">&quot;business.operation.latency&quot;</span>)</span><br><span class="line">                .tag(<span class="string">&quot;operation&quot;</span>, operation)</span><br><span class="line">                .register(meterRegistry)</span><br><span class="line">                .record(latencyMs, TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Track business-specific error rates</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordBusinessError</span><span class="params">(String errorType, String context)</span> &#123;</span><br><span class="line">        Counter.builder(<span class="string">&quot;business.errors&quot;</span>)</span><br><span class="line">                .tag(<span class="string">&quot;error.type&quot;</span>, errorType)</span><br><span class="line">                .tag(<span class="string">&quot;context&quot;</span>, context)</span><br><span class="line">                .register(meterRegistry)</span><br><span class="line">                .increment();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Migration-and-Deployment-Strategies"><a href="#Migration-and-Deployment-Strategies" class="headerlink" title="Migration and Deployment Strategies"></a>Migration and Deployment Strategies</h2><h3 id="Blue-Green-Deployment-with-Message-Queue-Migration"><a href="#Blue-Green-Deployment-with-Message-Queue-Migration" class="headerlink" title="Blue-Green Deployment with Message Queue Migration"></a>Blue-Green Deployment with Message Queue Migration</h3><pre>
<code class="mermaid">
flowchart TB
subgraph &quot;Blue Environment (Current)&quot;
    B1[Service A] --&gt; B2[Kafka Cluster]
    B3[Service B] --&gt; B2
end

subgraph &quot;Green Environment (New)&quot;
    G1[Service A] --&gt; G2[RocketMQ Cluster]
    G3[Service B] --&gt; G2
end

subgraph &quot;Migration Process&quot;
    M1[Dual Write Phase]
    M2[Consumer Migration]
    M3[Producer Migration]
    M4[Verification]
end

B2 --&gt; M1
G2 --&gt; M1
M1 --&gt; M2
M2 --&gt; M3
M3 --&gt; M4
</code>
</pre>

<h3 id="Migration-Implementation"><a href="#Migration-Implementation" class="headerlink" title="Migration Implementation"></a>Migration Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqMigrationManager</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, MessageQueueProvider&gt; providers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MigrationConfig migrationConfig;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startMigration</span><span class="params">(String fromProvider, String toProvider)</span> &#123;</span><br><span class="line">        <span class="type">MigrationPlan</span> <span class="variable">plan</span> <span class="operator">=</span> createMigrationPlan(fromProvider, toProvider);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Phase 1: Start dual write</span></span><br><span class="line">        enableDualWrite(fromProvider, toProvider);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Phase 2: Migrate consumers gradually</span></span><br><span class="line">        migrateConsumersGradually(fromProvider, toProvider, plan);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Phase 3: Stop old producer after lag verification</span></span><br><span class="line">        stopOldProducerAfterVerification(fromProvider, toProvider);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Phase 4: Clean up</span></span><br><span class="line">        cleanupOldInfrastructure(fromProvider);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">enableDualWrite</span><span class="params">(String fromProvider, String toProvider)</span> &#123;</span><br><span class="line">        <span class="comment">// Configure all producers to write to both systems</span></span><br><span class="line">        <span class="type">MessageProducer</span> <span class="variable">oldProducer</span> <span class="operator">=</span> providers.get(fromProvider).createProducer(getConfig());</span><br><span class="line">        <span class="type">MessageProducer</span> <span class="variable">newProducer</span> <span class="operator">=</span> providers.get(toProvider).createProducer(getConfig());</span><br><span class="line">        </span><br><span class="line">        <span class="type">DualWriteProducer</span> <span class="variable">dualProducer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DualWriteProducer</span>(oldProducer, newProducer);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Replace existing producers</span></span><br><span class="line">        applicationContext.getBean(MessageProducerFactory.class)</span><br><span class="line">                .setDefaultProducer(dualProducer);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">migrateConsumersGradually</span><span class="params">(String fromProvider, String toProvider, </span></span><br><span class="line"><span class="params">                                          MigrationPlan plan)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (ConsumerMigrationStep step : plan.getConsumerSteps()) &#123;</span><br><span class="line">            <span class="comment">// Stop percentage of old consumers</span></span><br><span class="line">            stopConsumers(fromProvider, step.getTopics(), step.getPercentage());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Start same percentage of new consumers</span></span><br><span class="line">            startConsumers(toProvider, step.getTopics(), step.getPercentage());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Wait and verify lag is manageable</span></span><br><span class="line">            waitAndVerifyLag(step.getVerificationTimeMs());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Dual write producer for zero-downtime migration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DualWriteProducer</span> <span class="keyword">implements</span> <span class="title class_">MessageProducer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageProducer primaryProducer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageProducer secondaryProducer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MigrationMetrics metrics;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;SendResult&gt; <span class="title function_">send</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="comment">// Send to primary (current) system</span></span><br><span class="line">        CompletableFuture&lt;SendResult&gt; primaryFuture = primaryProducer.send(message);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Send to secondary (new) system - don&#x27;t fail if this fails</span></span><br><span class="line">        CompletableFuture&lt;SendResult&gt; secondaryFuture = secondaryProducer.send(message)</span><br><span class="line">                .handle((result, throwable) -&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> (throwable != <span class="literal">null</span>) &#123;</span><br><span class="line">                        metrics.recordSecondaryWriteFailure(message.getTopic(), throwable);</span><br><span class="line">                        <span class="comment">// Log but don&#x27;t propagate error</span></span><br><span class="line">                        logger.warn(<span class="string">&quot;Secondary write failed for topic: &#123;&#125;&quot;</span>, </span><br><span class="line">                                   message.getTopic(), throwable);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> result;</span><br><span class="line">                &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Return primary result - migration is transparent to clients</span></span><br><span class="line">        <span class="keyword">return</span> primaryFuture;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Advanced-Topics"><a href="#Advanced-Topics" class="headerlink" title="Advanced Topics"></a>Advanced Topics</h2><h3 id="Message-Schema-Evolution"><a href="#Message-Schema-Evolution" class="headerlink" title="Message Schema Evolution"></a>Message Schema Evolution</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Schema registry integration</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SchemaAwareMessageProducer</span> <span class="keyword">implements</span> <span class="title class_">MessageProducer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageProducer delegate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SchemaRegistry schemaRegistry;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;SendResult&gt; <span class="title function_">send</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="comment">// Validate and evolve schema</span></span><br><span class="line">        <span class="type">Schema</span> <span class="variable">currentSchema</span> <span class="operator">=</span> schemaRegistry.getLatestSchema(message.getTopic());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (currentSchema != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Validate message against schema</span></span><br><span class="line">            <span class="type">SchemaValidationResult</span> <span class="variable">validation</span> <span class="operator">=</span> currentSchema.validate(message.getPayload());</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (!validation.isValid()) &#123;</span><br><span class="line">                <span class="comment">// Attempt automatic schema evolution</span></span><br><span class="line">                <span class="type">Object</span> <span class="variable">evolvedPayload</span> <span class="operator">=</span> schemaRegistry.evolvePayload(</span><br><span class="line">                        message.getPayload(), currentSchema);</span><br><span class="line">                message = message.toBuilder().payload(evolvedPayload).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Add schema metadata to message</span></span><br><span class="line">        message.getHeaders().put(<span class="string">&quot;Schema-ID&quot;</span>, currentSchema.getId());</span><br><span class="line">        message.getHeaders().put(<span class="string">&quot;Schema-Version&quot;</span>, String.valueOf(currentSchema.getVersion()));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> delegate.send(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Backward compatibility handler</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BackwardCompatibilityConsumer</span> <span class="keyword">implements</span> <span class="title class_">MessageConsumer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageConsumer delegate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SchemaRegistry schemaRegistry;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(String topic, MessageHandler handler)</span> &#123;</span><br><span class="line">        delegate.subscribe(topic, <span class="keyword">new</span> <span class="title class_">CompatibilityMessageHandler</span>(handler, topic));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">CompatibilityMessageHandler</span> <span class="keyword">implements</span> <span class="title class_">MessageHandler</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> MessageHandler delegate;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String topic;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">schemaId</span> <span class="operator">=</span> message.getHeaders().get(<span class="string">&quot;Schema-ID&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (schemaId != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Get the schema used to produce this message</span></span><br><span class="line">                <span class="type">Schema</span> <span class="variable">producerSchema</span> <span class="operator">=</span> schemaRegistry.getSchema(schemaId);</span><br><span class="line">                <span class="type">Schema</span> <span class="variable">currentSchema</span> <span class="operator">=</span> schemaRegistry.getLatestSchema(topic);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (!producerSchema.equals(currentSchema)) &#123;</span><br><span class="line">                    <span class="comment">// Migrate message to current schema</span></span><br><span class="line">                    <span class="type">Object</span> <span class="variable">migratedPayload</span> <span class="operator">=</span> schemaRegistry.migratePayload(</span><br><span class="line">                            message.getPayload(), producerSchema, currentSchema);</span><br><span class="line">                    message = message.toBuilder().payload(migratedPayload).build();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            delegate.handle(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Event-Sourcing-Integration"><a href="#Event-Sourcing-Integration" class="headerlink" title="Event Sourcing Integration"></a>Event Sourcing Integration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Event store using Universal MQ SDK</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventStore</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageProducer eventProducer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageConsumer eventConsumer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EventRepository eventRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">storeEvent</span><span class="params">(DomainEvent event)</span> &#123;</span><br><span class="line">        <span class="comment">// Store in persistent event log</span></span><br><span class="line">        <span class="type">EventRecord</span> <span class="variable">record</span> <span class="operator">=</span> EventRecord.builder()</span><br><span class="line">                .eventId(event.getEventId())</span><br><span class="line">                .aggregateId(event.getAggregateId())</span><br><span class="line">                .eventType(event.getClass().getSimpleName())</span><br><span class="line">                .eventData(serialize(event))</span><br><span class="line">                .timestamp(event.getTimestamp())</span><br><span class="line">                .version(event.getVersion())</span><br><span class="line">                .build();</span><br><span class="line">        </span><br><span class="line">        eventRepository.save(record);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Publish for real-time processing</span></span><br><span class="line">        <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> Message.builder()</span><br><span class="line">                .key(event.getAggregateId())</span><br><span class="line">                .payload(event)</span><br><span class="line">                .topic(<span class="string">&quot;domain-events&quot;</span>)</span><br><span class="line">                .header(<span class="string">&quot;Event-Type&quot;</span>, event.getClass().getSimpleName())</span><br><span class="line">                .header(<span class="string">&quot;Aggregate-ID&quot;</span>, event.getAggregateId())</span><br><span class="line">                .build();</span><br><span class="line">        </span><br><span class="line">        eventProducer.send(message);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> List&lt;DomainEvent&gt; <span class="title function_">getEventHistory</span><span class="params">(String aggregateId, <span class="type">int</span> fromVersion)</span> &#123;</span><br><span class="line">        <span class="comment">// Replay events from persistent store</span></span><br><span class="line">        List&lt;EventRecord&gt; records = eventRepository.findByAggregateIdAndVersionGreaterThan(</span><br><span class="line">                aggregateId, fromVersion);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> records.stream()</span><br><span class="line">                .map(<span class="built_in">this</span>::deserializeEvent)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startEventProjections</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Subscribe to events for read model updates</span></span><br><span class="line">        eventConsumer.subscribe(<span class="string">&quot;domain-events&quot;</span>, <span class="built_in">this</span>::handleDomainEvent);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleDomainEvent</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="type">DomainEvent</span> <span class="variable">event</span> <span class="operator">=</span> (DomainEvent) message.getPayload();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Update read models/projections</span></span><br><span class="line">        projectionService.updateProjections(event);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Trigger side effects</span></span><br><span class="line">        sideEffectProcessor.processSideEffects(event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Interview-Questions-and-Expert-Insights"><a href="#Interview-Questions-and-Expert-Insights" class="headerlink" title="Interview Questions and Expert Insights"></a>Interview Questions and Expert Insights</h2><h3 id="Q-How-would-you-handle-message-ordering-guarantees-across-different-MQ-providers"><a href="#Q-How-would-you-handle-message-ordering-guarantees-across-different-MQ-providers" class="headerlink" title="Q: How would you handle message ordering guarantees across different MQ providers?"></a><strong>Q: How would you handle message ordering guarantees across different MQ providers?</strong></h3><p><strong>Expert Answer</strong>: Message ordering is achieved differently across providers:</p>
<ul>
<li><strong>Kafka</strong>: Uses partitioning - messages with the same key go to the same partition, maintaining order within that partition</li>
<li><strong>Redis Streams</strong>: Inherently ordered within a stream, use stream keys for partitioning</li>
<li><strong>RocketMQ</strong>: Supports both ordered and unordered messages, use MessageQueueSelector for ordering</li>
</ul>
<p>The Universal SDK abstracts this by implementing a consistent partitioning strategy based on message keys, ensuring the same ordering semantics regardless of the underlying provider.</p>
<h3 id="Q-What-are-the-performance-implications-of-your-SPI-based-approach"><a href="#Q-What-are-the-performance-implications-of-your-SPI-based-approach" class="headerlink" title="Q: What are the performance implications of your SPI-based approach?"></a><strong>Q: What are the performance implications of your SPI-based approach?</strong></h3><p><strong>Expert Answer</strong>: The SPI approach has minimal runtime overhead:</p>
<ul>
<li><strong>Initialization cost</strong>: Provider discovery happens once at startup</li>
<li><strong>Runtime cost</strong>: Single level of indirection (interface call)</li>
<li><strong>Memory overhead</strong>: Multiple providers loaded but only active one used</li>
<li><strong>Optimization</strong>: Use provider-specific optimizations under the unified interface</li>
</ul>
<p>Benefits outweigh costs: vendor flexibility, simplified testing, and operational consistency justify the slight performance trade-off.</p>
<h3 id="Q-How-do-you-ensure-exactly-once-delivery-semantics"><a href="#Q-How-do-you-ensure-exactly-once-delivery-semantics" class="headerlink" title="Q: How do you ensure exactly-once delivery semantics?"></a><strong>Q: How do you ensure exactly-once delivery semantics?</strong></h3><p><strong>Expert Answer</strong>: Exactly-once is challenging and provider-dependent:</p>
<ul>
<li><strong>Kafka</strong>: Use idempotent producers + transactional consumers</li>
<li><strong>Redis</strong>: Leverage Redis transactions and consumer group acknowledgments</li>
<li><strong>RocketMQ</strong>: Built-in transactional message support</li>
</ul>
<p>The SDK implements idempotency through:</p>
<ul>
<li>Message deduplication using correlation IDs</li>
<li>Idempotent message handlers</li>
<li>At-least-once delivery with deduplication at the application level</li>
</ul>
<h3 id="Q-How-would-you-handle-schema-evolution-in-a-microservices-environment"><a href="#Q-How-would-you-handle-schema-evolution-in-a-microservices-environment" class="headerlink" title="Q: How would you handle schema evolution in a microservices environment?"></a><strong>Q: How would you handle schema evolution in a microservices environment?</strong></h3><p><strong>Expert Answer</strong>: Schema evolution requires careful planning:</p>
<ol>
<li><strong>Forward Compatibility</strong>: New producers can write data that old consumers can read</li>
<li><strong>Backward Compatibility</strong>: Old producers can write data that new consumers can read</li>
<li><strong>Full Compatibility</strong>: Both forward and backward compatibility</li>
</ol>
<p>Implementation strategies:</p>
<ul>
<li>Use Avro or Protocol Buffers for schema definition</li>
<li>Implement schema registry for centralized schema management</li>
<li>Version schemas and maintain compatibility matrices</li>
<li>Gradual rollout of schema changes with monitoring</li>
</ul>
<h2 id="External-References-and-Resources"><a href="#External-References-and-Resources" class="headerlink" title="External References and Resources"></a>External References and Resources</h2><h3 id="Official-Documentation"><a href="#Official-Documentation" class="headerlink" title="Official Documentation"></a>Official Documentation</h3><ul>
<li><a target="_blank" rel="noopener" href="https://kafka.apache.org/documentation/">Apache Kafka Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://redis.io/docs/data-types/streams/">Redis Streams Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://rocketmq.apache.org/docs/quick-start/">Apache RocketMQ Documentation</a></li>
</ul>
<h3 id="Best-Practices-and-Patterns"><a href="#Best-Practices-and-Patterns" class="headerlink" title="Best Practices and Patterns"></a>Best Practices and Patterns</h3><ul>
<li><a target="_blank" rel="noopener" href="https://microservices.io/patterns/">Microservices Patterns by Chris Richardson</a></li>
<li><a target="_blank" rel="noopener" href="https://learning.oreilly.com/library/view/building-event-driven-microservices/9781492057888/">Building Event-Driven Microservices by Adam Bellemare</a></li>
<li><a target="_blank" rel="noopener" href="https://dataintensive.net/">Designing Data-Intensive Applications by Martin Kleppmann</a></li>
</ul>
<h3 id="Production-Operations"><a href="#Production-Operations" class="headerlink" title="Production Operations"></a>Production Operations</h3><ul>
<li><a target="_blank" rel="noopener" href="https://kafka.apache.org/documentation/#operations">Kafka Operations and Monitoring</a></li>
<li><a target="_blank" rel="noopener" href="https://redis.io/topics/sentinel">Redis High Availability</a></li>
<li><a target="_blank" rel="noopener" href="https://distributed-systems-observability-ebook.humio.com/">Distributed Systems Observability</a></li>
</ul>
<h3 id="Testing-and-Development"><a href="#Testing-and-Development" class="headerlink" title="Testing and Development"></a>Testing and Development</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.testcontainers.org/">Testcontainers Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://spring.io/guides/gs/testing-web/">Spring Boot Testing</a></li>
<li><a target="_blank" rel="noopener" href="https://principlesofchaos.org/">Chaos Engineering Principles</a></li>
</ul>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>The Universal Message Queue Component SDK provides a robust, production-ready solution for abstracting message queue implementations while maintaining high performance and reliability. By leveraging the SPI mechanism, implementing comprehensive failure handling, and supporting advanced patterns like async RPC, this SDK enables organizations to build resilient distributed systems that can evolve with changing technology requirements.</p>
<p>The key to success with this SDK lies in understanding the trade-offs between abstraction and performance, implementing proper monitoring and observability, and following established patterns for distributed system design. With careful attention to schema evolution, security, and operational concerns, this SDK can serve as a foundation for scalable microservices architectures.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/13/Design-File-Storage-Service/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/13/Design-File-Storage-Service/" class="post-title-link" itemprop="url">Design File Storage Service</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-13 17:50:00 / Modified: 19:47:39" itemprop="dateCreated datePublished" datetime="2025-06-13T17:50:00+08:00">2025-06-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system-design/" itemprop="url" rel="index"><span itemprop="name">system-design</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="System-Overview"><a href="#System-Overview" class="headerlink" title="System Overview"></a>System Overview</h2><h3 id="Vision"><a href="#Vision" class="headerlink" title="Vision"></a>Vision</h3><p>Design a scalable, extensible file storage service that abstracts multiple storage backends (HDFS, NFS) through a unified interface, providing seamless file operations for distributed applications.</p>
<h3 id="Key-Design-Principles"><a href="#Key-Design-Principles" class="headerlink" title="Key Design Principles"></a>Key Design Principles</h3><ul>
<li><strong>Pluggability</strong>: SPI-based driver architecture for easy backend integration</li>
<li><strong>Scalability</strong>: Handle millions of files with horizontal scaling</li>
<li><strong>Reliability</strong>: 99.9% availability with fault tolerance</li>
<li><strong>Performance</strong>: Sub-second response times for file operations</li>
<li><strong>Security</strong>: Enterprise-grade access control and encryption</li>
</ul>
<h3 id="High-Level-Architecture"><a href="#High-Level-Architecture" class="headerlink" title="High-Level Architecture"></a>High-Level Architecture</h3><pre>
<code class="mermaid">
graph TB
Client[Client Applications] --&gt; SDK[FileSystem SDK]
SDK --&gt; LB[Load Balancer]
LB --&gt; API[File Storage API Gateway]

API --&gt; Service[FileStorageService]
Service --&gt; SPI[SPI Framework]

SPI --&gt; HDFS[HDFS Driver]
SPI --&gt; NFS[NFS Driver]
SPI --&gt; S3[S3 Driver]

HDFS --&gt; HDFSCluster[HDFS Cluster]
NFS --&gt; NFSServer[NFS Server]
S3 --&gt; S3Bucket[S3 Storage]

Service --&gt; Cache[Redis Cache]
Service --&gt; DB[Metadata DB]
Service --&gt; MQ[Message Queue]
</code>
</pre>

<p><strong>💡 Interview Insight</strong>: <em>When discussing system architecture, emphasize the separation of concerns - API layer handles routing and validation, service layer manages business logic, and SPI layer provides storage abstraction. This demonstrates understanding of layered architecture patterns.</em></p>
<hr>
<h2 id="Architecture-Design"><a href="#Architecture-Design" class="headerlink" title="Architecture Design"></a>Architecture Design</h2><h3 id="Component-Interaction-Flow"><a href="#Component-Interaction-Flow" class="headerlink" title="Component Interaction Flow"></a>Component Interaction Flow</h3><pre>
<code class="mermaid">
sequenceDiagram
participant Client
participant SDK
participant Gateway
participant FileService
participant SPI
participant Storage
participant MetadataDB

Client-&gt;&gt;SDK: uploadFile(file, metadata)
SDK-&gt;&gt;Gateway: POST &#x2F;files&#x2F;upload
Gateway-&gt;&gt;FileService: processUpload()
FileService-&gt;&gt;SPI: store(fileData)
SPI-&gt;&gt;Storage: writeFile()
Storage--&gt;&gt;SPI: fileLocation
SPI--&gt;&gt;FileService: storageResult
FileService-&gt;&gt;MetadataDB: saveMetadata()
FileService--&gt;&gt;Gateway: uploadResponse
Gateway--&gt;&gt;SDK: HTTP 201 + fileUrl
SDK--&gt;&gt;Client: FileUploadResult
</code>
</pre>

<h3 id="Design-Patterns-Applied"><a href="#Design-Patterns-Applied" class="headerlink" title="Design Patterns Applied"></a>Design Patterns Applied</h3><ol>
<li><strong>Strategy Pattern</strong>: SPI drivers implement different storage strategies</li>
<li><strong>Factory Pattern</strong>: Driver creation based on configuration</li>
<li><strong>Template Method</strong>: Common file operations with backend-specific implementations</li>
<li><strong>Circuit Breaker</strong>: Fault tolerance for external storage systems</li>
<li><strong>Observer Pattern</strong>: Event-driven notifications for file operations</li>
</ol>
<p><strong>💡 Interview Insight</strong>: <em>Discussing design patterns shows architectural maturity. Mention how the Strategy pattern enables runtime switching between storage backends without code changes, which is crucial for multi-cloud deployments.</em></p>
<hr>
<h2 id="Core-Components"><a href="#Core-Components" class="headerlink" title="Core Components"></a>Core Components</h2><h3 id="1-FileStorageService"><a href="#1-FileStorageService" class="headerlink" title="1. FileStorageService"></a>1. FileStorageService</h3><p>The central orchestrator managing all file operations:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> FileSystemSPIManager spiManager;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MetadataRepository metadataRepo;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CacheManager cacheManager;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> FileUploadResult <span class="title function_">uploadFile</span><span class="params">(FileUploadRequest request)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. Validate file and metadata</span></span><br><span class="line">        validateFile(request.getFile());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. Generate unique file ID</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileId</span> <span class="operator">=</span> generateFileId();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. Determine storage backend based on policy</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">driverType</span> <span class="operator">=</span> determineStorageBackend(request);</span><br><span class="line">        <span class="type">FileSystemDriver</span> <span class="variable">driver</span> <span class="operator">=</span> spiManager.getDriver(driverType);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. Store file using appropriate driver</span></span><br><span class="line">        <span class="type">StorageResult</span> <span class="variable">result</span> <span class="operator">=</span> driver.store(fileId, request.getFile());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. Save metadata</span></span><br><span class="line">        <span class="type">FileMetadata</span> <span class="variable">metadata</span> <span class="operator">=</span> createMetadata(fileId, request, result);</span><br><span class="line">        metadataRepo.save(metadata);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 6. Cache metadata for quick access</span></span><br><span class="line">        cacheManager.put(fileId, metadata);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 7. Generate download URL</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">downloadUrl</span> <span class="operator">=</span> generateDownloadUrl(fileId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FileUploadResult</span>(fileId, downloadUrl, metadata);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> FileDownloadResult <span class="title function_">downloadFile</span><span class="params">(String fileId)</span> &#123;</span><br><span class="line">        <span class="comment">// Implementation with caching and fallback strategies</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-Metadata-Management"><a href="#2-Metadata-Management" class="headerlink" title="2. Metadata Management"></a>2. Metadata Management</h3><pre>
<code class="mermaid">
erDiagram
FILE_METADATA {
    string file_id PK
    string original_name
    string content_type
    long file_size
    string storage_backend
    string storage_path
    string checksum
    timestamp created_at
    timestamp updated_at
    string created_by
    json custom_attributes
    enum status
}

FILE_ACCESS_LOG {
    string log_id PK
    string file_id FK
    string operation_type
    string client_ip
    timestamp access_time
    boolean success
    string error_message
}

STORAGE_QUOTA {
    string tenant_id PK
    long total_quota
    long used_space
    long file_count
    timestamp last_updated
}
</code>
</pre>

<p><strong>💡 Interview Insight</strong>: <em>Metadata design is crucial for system scalability. Discuss partitioning strategies - file_id can be hash-partitioned, and time-based partitioning for access logs enables efficient historical data management.</em></p>
<hr>
<h2 id="SPI-Framework-Implementation"><a href="#SPI-Framework-Implementation" class="headerlink" title="SPI Framework Implementation"></a>SPI Framework Implementation</h2><h3 id="SPI-Architecture"><a href="#SPI-Architecture" class="headerlink" title="SPI Architecture"></a>SPI Architecture</h3><pre>
<code class="mermaid">
classDiagram
class FileSystemDriver {
    &lt;&lt;interface&gt;&gt;
    +store(fileId, fileData) StorageResult
    +retrieve(fileId) FileData
    +delete(fileId) boolean
    +exists(fileId) boolean
    +generateDownloadUrl(fileId) String
}

class HDFSDriver {
    -hdfsConfig: Configuration
    -fileSystem: FileSystem
    +store(fileId, fileData) StorageResult
    +retrieve(fileId) FileData
}

class NFSDriver {
    -nfsConfig: NFSConfig
    -mountPoint: String
    +store(fileId, fileData) StorageResult
    +retrieve(fileId) FileData
}

class S3Driver {
    -s3Client: AmazonS3
    -bucketName: String
    +store(fileId, fileData) StorageResult
    +retrieve(fileId) FileData
}

class DriverFactory {
    +createDriver(driverType) FileSystemDriver
}

class SPIManager {
    -drivers: Map~String,FileSystemDriver~
    +getDriver(type) FileSystemDriver
    +registerDriver(type, driver)
}

FileSystemDriver &lt;|-- HDFSDriver
FileSystemDriver &lt;|-- NFSDriver
FileSystemDriver &lt;|-- S3Driver
DriverFactory --&gt; FileSystemDriver
SPIManager --&gt; FileSystemDriver
</code>
</pre>

<h3 id="SPI-Configuration"><a href="#SPI-Configuration" class="headerlink" title="SPI Configuration"></a>SPI Configuration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// META-INF/services/com.fileservice.spi.FileSystemDriver</span></span><br><span class="line">com.fileservice.driver.HDFSDriver</span><br><span class="line">com.fileservice.driver.NFSDriver</span><br><span class="line">com.fileservice.driver.S3Driver</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileSystemSPIManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, FileSystemDriver&gt; drivers = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initializeDrivers</span><span class="params">()</span> &#123;</span><br><span class="line">        ServiceLoader&lt;FileSystemDriver&gt; loader = </span><br><span class="line">            ServiceLoader.load(FileSystemDriver.class);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (FileSystemDriver driver : loader) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">driverType</span> <span class="operator">=</span> driver.getDriverType();</span><br><span class="line">            drivers.put(driverType, driver);</span><br><span class="line">            logger.info(<span class="string">&quot;Registered driver: &#123;&#125;&quot;</span>, driverType);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> FileSystemDriver <span class="title function_">getDriver</span><span class="params">(String driverType)</span> &#123;</span><br><span class="line">        <span class="type">FileSystemDriver</span> <span class="variable">driver</span> <span class="operator">=</span> drivers.get(driverType);</span><br><span class="line">        <span class="keyword">if</span> (driver == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedDriverException</span>(<span class="string">&quot;Driver not found: &quot;</span> + driverType);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> driver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>💡 Interview Insight</strong>: <em>SPI demonstrates understanding of extensibility patterns. Mention that this approach allows adding new storage backends without modifying core service code, following the Open-Closed Principle.</em></p>
<hr>
<h2 id="API-Design"><a href="#API-Design" class="headerlink" title="API Design"></a>API Design</h2><h3 id="RESTful-API-Endpoints"><a href="#RESTful-API-Endpoints" class="headerlink" title="RESTful API Endpoints"></a>RESTful API Endpoints</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">openapi:</span> <span class="number">3.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">info:</span></span><br><span class="line">  <span class="attr">title:</span> <span class="string">File</span> <span class="string">Storage</span> <span class="string">Service</span> <span class="string">API</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">1.0</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="attr">paths:</span></span><br><span class="line">  <span class="string">/api/v1/files:</span></span><br><span class="line">    <span class="attr">post:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">Upload</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">requestBody:</span></span><br><span class="line">        <span class="attr">content:</span></span><br><span class="line">          <span class="attr">multipart/form-data:</span></span><br><span class="line">            <span class="attr">schema:</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">              <span class="attr">properties:</span></span><br><span class="line">                <span class="attr">file:</span></span><br><span class="line">                  <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                  <span class="attr">format:</span> <span class="string">binary</span></span><br><span class="line">                <span class="attr">metadata:</span></span><br><span class="line">                  <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">                <span class="attr">storagePreference:</span></span><br><span class="line">                  <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                  <span class="attr">enum:</span> [<span class="string">hdfs</span>, <span class="string">nfs</span>, <span class="string">s3</span>]</span><br><span class="line">      <span class="attr">responses:</span></span><br><span class="line">        <span class="attr">&#x27;201&#x27;:</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">File</span> <span class="string">uploaded</span> <span class="string">successfully</span></span><br><span class="line">          <span class="attr">content:</span></span><br><span class="line">            <span class="attr">application/json:</span></span><br><span class="line">              <span class="attr">schema:</span></span><br><span class="line">                <span class="string">$ref:</span> <span class="string">&#x27;#/components/schemas/FileUploadResponse&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">get:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">List</span> <span class="string">files</span> <span class="string">with</span> <span class="string">pagination</span></span><br><span class="line">      <span class="attr">parameters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">page</span></span><br><span class="line">          <span class="attr">in:</span> <span class="string">query</span></span><br><span class="line">          <span class="attr">schema:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">size</span></span><br><span class="line">          <span class="attr">in:</span> <span class="string">query</span></span><br><span class="line">          <span class="attr">schema:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">filter</span></span><br><span class="line">          <span class="attr">in:</span> <span class="string">query</span></span><br><span class="line">          <span class="attr">schema:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">responses:</span></span><br><span class="line">        <span class="attr">&#x27;200&#x27;:</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">Files</span> <span class="string">retrieved</span> <span class="string">successfully</span></span><br><span class="line"></span><br><span class="line">  <span class="string">/api/v1/files/&#123;fileId&#125;:</span></span><br><span class="line">    <span class="attr">get:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">Get</span> <span class="string">file</span> <span class="string">metadata</span></span><br><span class="line">      <span class="attr">parameters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fileId</span></span><br><span class="line">          <span class="attr">in:</span> <span class="string">path</span></span><br><span class="line">          <span class="attr">required:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">schema:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">responses:</span></span><br><span class="line">        <span class="attr">&#x27;200&#x27;:</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">File</span> <span class="string">metadata</span> <span class="string">retrieved</span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">delete:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">Delete</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">responses:</span></span><br><span class="line">        <span class="attr">&#x27;204&#x27;:</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">File</span> <span class="string">deleted</span> <span class="string">successfully</span></span><br><span class="line"></span><br><span class="line">  <span class="string">/api/v1/files/&#123;fileId&#125;/download:</span></span><br><span class="line">    <span class="attr">get:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">Download</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">responses:</span></span><br><span class="line">        <span class="attr">&#x27;200&#x27;:</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">File</span> <span class="string">content</span></span><br><span class="line">          <span class="attr">content:</span></span><br><span class="line">            <span class="attr">application/octet-stream:</span></span><br><span class="line">              <span class="attr">schema:</span></span><br><span class="line">                <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                <span class="attr">format:</span> <span class="string">binary</span></span><br><span class="line"></span><br><span class="line"><span class="attr">components:</span></span><br><span class="line">  <span class="attr">schemas:</span></span><br><span class="line">    <span class="attr">FileUploadResponse:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">      <span class="attr">properties:</span></span><br><span class="line">        <span class="attr">fileId:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">        <span class="attr">downloadUrl:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">        <span class="attr">metadata:</span></span><br><span class="line">          <span class="string">$ref:</span> <span class="string">&#x27;#/components/schemas/FileMetadata&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="Request-Response-Flow"><a href="#Request-Response-Flow" class="headerlink" title="Request&#x2F;Response Flow"></a>Request&#x2F;Response Flow</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">flowchart TD</span><br><span class="line">    A[Client Request] --&gt; B&#123;Request Validation&#125;</span><br><span class="line">    B --&gt;|Valid| C[Authentication &amp; Authorization]</span><br><span class="line">    B --&gt;|Invalid| D[Return 400 Bad Request]</span><br><span class="line">    </span><br><span class="line">    C --&gt;|Authorized| E[Route to Service]</span><br><span class="line">    C --&gt;|Unauthorized| F[Return 401/403]</span><br><span class="line">    </span><br><span class="line">    E --&gt; G[Business Logic Processing]</span><br><span class="line">    G --&gt; H&#123;Storage Operation&#125;</span><br><span class="line">    </span><br><span class="line">    H --&gt;|Success| I[Update Metadata]</span><br><span class="line">    H --&gt;|Failure| J[Rollback &amp; Error Response]</span><br><span class="line">    </span><br><span class="line">    I --&gt; K[Generate Response]</span><br><span class="line">    K --&gt; L[Return Success Response]</span><br><span class="line">    </span><br><span class="line">    J --&gt; M[Return Error Response]</span><br></pre></td></tr></table></figure>

<p><strong>💡 Interview Insight</strong>: <em>API design considerations include idempotency for upload operations, proper HTTP status codes, and consistent error response format. Discuss rate limiting and API versioning strategies for production systems.</em></p>
<hr>
<h2 id="Client-SDK"><a href="#Client-SDK" class="headerlink" title="Client SDK"></a>Client SDK</h2><h3 id="SDK-Architecture"><a href="#SDK-Architecture" class="headerlink" title="SDK Architecture"></a>SDK Architecture</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageClient</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String baseUrl;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HttpClient httpClient;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthenticationProvider authProvider;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RetryPolicy retryPolicy;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FileStorageClient</span><span class="params">(FileStorageConfig config)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.baseUrl = config.getBaseUrl();</span><br><span class="line">        <span class="built_in">this</span>.httpClient = createHttpClient(config);</span><br><span class="line">        <span class="built_in">this</span>.authProvider = <span class="keyword">new</span> <span class="title class_">AuthenticationProvider</span>(config);</span><br><span class="line">        <span class="built_in">this</span>.retryPolicy = RetryPolicy.exponentialBackoff();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;FileUploadResult&gt; <span class="title function_">uploadFileAsync</span><span class="params">(</span></span><br><span class="line"><span class="params">            String filePath, </span></span><br><span class="line"><span class="params">            FileUploadOptions options)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> uploadFileInternal(filePath, options);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileStorageException</span>(<span class="string">&quot;Upload failed&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> FileDownloadResult <span class="title function_">downloadFile</span><span class="params">(String fileId, String destPath)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> retryPolicy.execute(() -&gt; &#123;</span><br><span class="line">            <span class="type">HttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> buildDownloadRequest(fileId);</span><br><span class="line">            HttpResponse&lt;<span class="type">byte</span>[]&gt; response = httpClient.send(request, </span><br><span class="line">                HttpResponse.BodyHandlers.ofByteArray());</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (response.statusCode() == <span class="number">200</span>) &#123;</span><br><span class="line">                Files.write(Paths.get(destPath), response.body());</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FileDownloadResult</span>(fileId, destPath);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileStorageException</span>(<span class="string">&quot;Download failed: &quot;</span> + response.statusCode());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SDK-Features"><a href="#SDK-Features" class="headerlink" title="SDK Features"></a>SDK Features</h3><ol>
<li><strong>Async Operations</strong>: Non-blocking file operations</li>
<li><strong>Retry Logic</strong>: Exponential backoff with jitter</li>
<li><strong>Progress Tracking</strong>: Upload&#x2F;download progress callbacks</li>
<li><strong>Connection Pooling</strong>: Efficient HTTP connection management</li>
<li><strong>Error Handling</strong>: Comprehensive exception hierarchy</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Usage Example</span></span><br><span class="line"><span class="type">FileStorageClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileStorageClient</span>(config);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Async upload with progress tracking</span></span><br><span class="line">CompletableFuture&lt;FileUploadResult&gt; future = client.uploadFileAsync(</span><br><span class="line">    <span class="string">&quot;large-file.zip&quot;</span>,</span><br><span class="line">    FileUploadOptions.builder()</span><br><span class="line">        .storageBackend(<span class="string">&quot;hdfs&quot;</span>)</span><br><span class="line">        .progressCallback(progress -&gt; </span><br><span class="line">            System.out.println(<span class="string">&quot;Upload progress: &quot;</span> + progress.getPercentage() + <span class="string">&quot;%&quot;</span>))</span><br><span class="line">        .build()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">future.thenAccept(result -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;File uploaded: &quot;</span> + result.getDownloadUrl());</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>💡 Interview Insight</strong>: <em>SDK design demonstrates client-side engineering skills. Discuss thread safety, connection pooling, and how to handle large file uploads with chunking and resume capabilities.</em></p>
<hr>
<h2 id="Storage-Backends"><a href="#Storage-Backends" class="headerlink" title="Storage Backends"></a>Storage Backends</h2><h3 id="HDFS-Integration"><a href="#HDFS-Integration" class="headerlink" title="HDFS Integration"></a>HDFS Integration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HDFSDriver</span> <span class="keyword">implements</span> <span class="title class_">FileSystemDriver</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileSystem hdfsFileSystem;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Configuration hadoopConfig;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> StorageResult <span class="title function_">store</span><span class="params">(String fileId, FileData fileData)</span> &#123;</span><br><span class="line">        <span class="type">Path</span> <span class="variable">hdfsPath</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Path</span>(<span class="string">&quot;/fileservice/&quot;</span> + generatePath(fileId));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">FSDataOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> hdfsFileSystem.create(hdfsPath)) &#123;</span><br><span class="line">            IOUtils.copyBytes(fileData.getInputStream(), outputStream, <span class="number">4096</span>, <span class="literal">false</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="type">FileStatus</span> <span class="variable">fileStatus</span> <span class="operator">=</span> hdfsFileSystem.getFileStatus(hdfsPath);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> StorageResult.builder()</span><br><span class="line">                .fileId(fileId)</span><br><span class="line">                .storagePath(hdfsPath.toString())</span><br><span class="line">                .size(fileStatus.getLen())</span><br><span class="line">                .checksum(calculateChecksum(fileData))</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StorageException</span>(<span class="string">&quot;HDFS store failed&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FileData <span class="title function_">retrieve</span><span class="params">(String fileId)</span> &#123;</span><br><span class="line">        <span class="type">Path</span> <span class="variable">hdfsPath</span> <span class="operator">=</span> getPathFromFileId(fileId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">FSDataInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> hdfsFileSystem.open(hdfsPath);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FileData</span>(inputStream, hdfsFileSystem.getFileStatus(hdfsPath).getLen());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StorageException</span>(<span class="string">&quot;HDFS retrieve failed&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">generatePath</span><span class="params">(String fileId)</span> &#123;</span><br><span class="line">        <span class="comment">// Generate hierarchical path: /2023/12/15/abc123...</span></span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;%s/%s/%s/%s&quot;</span>, </span><br><span class="line">            LocalDate.now().getYear(),</span><br><span class="line">            LocalDate.now().getMonthValue(),</span><br><span class="line">            LocalDate.now().getDayOfMonth(),</span><br><span class="line">            fileId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="NFS-Integration"><a href="#NFS-Integration" class="headerlink" title="NFS Integration"></a>NFS Integration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NFSDriver</span> <span class="keyword">implements</span> <span class="title class_">FileSystemDriver</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String mountPoint;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileSystem nfsFileSystem;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> StorageResult <span class="title function_">store</span><span class="params">(String fileId, FileData fileData)</span> &#123;</span><br><span class="line">        <span class="type">Path</span> <span class="variable">nfsPath</span> <span class="operator">=</span> Paths.get(mountPoint, generatePath(fileId));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Files.createDirectories(nfsPath.getParent());</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">input</span> <span class="operator">=</span> fileData.getInputStream();</span><br><span class="line">                 <span class="type">OutputStream</span> <span class="variable">output</span> <span class="operator">=</span> Files.newOutputStream(nfsPath)) &#123;</span><br><span class="line">                </span><br><span class="line">                <span class="type">long</span> <span class="variable">bytesTransferred</span> <span class="operator">=</span> input.transferTo(output);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> StorageResult.builder()</span><br><span class="line">                    .fileId(fileId)</span><br><span class="line">                    .storagePath(nfsPath.toString())</span><br><span class="line">                    .size(bytesTransferred)</span><br><span class="line">                    .checksum(calculateChecksum(nfsPath))</span><br><span class="line">                    .build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StorageException</span>(<span class="string">&quot;NFS store failed&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Storage-Selection-Strategy"><a href="#Storage-Selection-Strategy" class="headerlink" title="Storage Selection Strategy"></a>Storage Selection Strategy</h3><pre>
<code class="mermaid">
flowchart
A[File Upload Request] --&gt; B{File Size Check}
B --&gt;|&lt; 100MB| C{Performance Priority?}
B --&gt;|&gt; 100MB| D{Durability Priority?}

C --&gt;|Yes| E[NFS - Low Latency]
C --&gt;|No| F[HDFS - Cost Effective]

D --&gt;|Yes| G[HDFS - Replication]
D --&gt;|No| H[S3 - Archival]

E --&gt; I[Store in NFS]
F --&gt; J[Store in HDFS]
G --&gt; J
H --&gt; K[Store in S3]
</code>
</pre>

<p><strong>💡 Interview Insight</strong>: <em>Storage selection demonstrates understanding of trade-offs. NFS offers low latency but limited scalability, HDFS provides distributed storage with replication, S3 offers infinite scale but higher latency. Discuss when to use each based on access patterns.</em></p>
<hr>
<h2 id="Security-Performance"><a href="#Security-Performance" class="headerlink" title="Security &amp; Performance"></a>Security &amp; Performance</h2><h3 id="Security-Implementation"><a href="#Security-Implementation" class="headerlink" title="Security Implementation"></a>Security Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/v1/files&quot;)</span></span><br><span class="line"><span class="meta">@PreAuthorize(&quot;hasRole(&#x27;FILE_USER&#x27;)&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;@fileSecurityService.canUpload(authentication.name, #request.storageBackend)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;FileUploadResponse&gt; <span class="title function_">uploadFile</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;metadata&quot;)</span> String metadata,</span></span><br><span class="line"><span class="params">            FileUploadRequest request)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Validate file type and size</span></span><br><span class="line">        fileValidationService.validateFile(file);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Scan for malware</span></span><br><span class="line">        <span class="keyword">if</span> (!malwareScanService.isFileSafe(file)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;File failed security scan&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">FileUploadResult</span> <span class="variable">result</span> <span class="operator">=</span> fileStorageService.uploadFile(request);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.CREATED).body(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileSecurityService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">canUpload</span><span class="params">(String username, String storageBackend)</span> &#123;</span><br><span class="line">        <span class="type">UserPermissions</span> <span class="variable">permissions</span> <span class="operator">=</span> userService.getPermissions(username);</span><br><span class="line">        <span class="keyword">return</span> permissions.hasStorageAccess(storageBackend);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generateSignedUrl</span><span class="params">(String fileId, Duration expiry)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> jwtService.createToken(</span><br><span class="line">            Map.of(<span class="string">&quot;fileId&quot;</span>, fileId, <span class="string">&quot;action&quot;</span>, <span class="string">&quot;download&quot;</span>),</span><br><span class="line">            expiry</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> baseUrl + <span class="string">&quot;/files/&quot;</span> + fileId + <span class="string">&quot;/download?token=&quot;</span> + token;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Performance-Optimizations"><a href="#Performance-Optimizations" class="headerlink" title="Performance Optimizations"></a>Performance Optimizations</h3><ol>
<li><strong>Connection Pooling</strong>: HTTP and database connection pools</li>
<li><strong>Caching Strategy</strong>: Multi-level caching (Redis + Local)</li>
<li><strong>Async Processing</strong>: Non-blocking I&#x2F;O operations</li>
<li><strong>Compression</strong>: Automatic compression for large files</li>
<li><strong>CDN Integration</strong>: Geographic distribution for downloads</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PerformanceConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title function_">fileProcessingExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">        executor.setCorePoolSize(<span class="number">10</span>);</span><br><span class="line">        executor.setMaxPoolSize(<span class="number">50</span>);</span><br><span class="line">        executor.setQueueCapacity(<span class="number">100</span>);</span><br><span class="line">        executor.setThreadNamePrefix(<span class="string">&quot;file-processor-&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CacheManager <span class="title function_">cacheManager</span><span class="params">()</span> &#123;</span><br><span class="line">        RedisCacheManager.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> RedisCacheManager</span><br><span class="line">            .RedisCacheManagerBuilder</span><br><span class="line">            .fromConnectionFactory(redisConnectionFactory())</span><br><span class="line">            .cacheDefaults(cacheConfiguration());</span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>💡 Interview Insight</strong>: <em>Performance discussions should cover caching strategies (what to cache, cache invalidation), connection pooling, and async processing. Mention specific metrics like P99 latency targets and throughput requirements.</em></p>
<hr>
<h2 id="Monitoring-Operations"><a href="#Monitoring-Operations" class="headerlink" title="Monitoring &amp; Operations"></a>Monitoring &amp; Operations</h2><h3 id="Metrics-and-Monitoring"><a href="#Metrics-and-Monitoring" class="headerlink" title="Metrics and Monitoring"></a>Metrics and Monitoring</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageMetrics</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Counter</span> <span class="variable">uploadCounter</span> <span class="operator">=</span> Counter.builder(<span class="string">&quot;file.uploads.total&quot;</span>)</span><br><span class="line">        .description(<span class="string">&quot;Total file uploads&quot;</span>)</span><br><span class="line">        .tag(<span class="string">&quot;storage_backend&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">        .register(Metrics.globalRegistry);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Timer</span> <span class="variable">uploadTimer</span> <span class="operator">=</span> Timer.builder(<span class="string">&quot;file.upload.duration&quot;</span>)</span><br><span class="line">        .description(<span class="string">&quot;File upload duration&quot;</span>)</span><br><span class="line">        .register(Metrics.globalRegistry);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Gauge</span> <span class="variable">storageUsage</span> <span class="operator">=</span> Gauge.builder(<span class="string">&quot;storage.usage.bytes&quot;</span>)</span><br><span class="line">        .description(<span class="string">&quot;Storage usage by backend&quot;</span>)</span><br><span class="line">        .tag(<span class="string">&quot;backend&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">        .register(Metrics.globalRegistry, <span class="built_in">this</span>, FileStorageMetrics::getStorageUsage);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordUpload</span><span class="params">(String backend, Duration duration)</span> &#123;</span><br><span class="line">        uploadCounter.increment(Tags.of(<span class="string">&quot;storage_backend&quot;</span>, backend));</span><br><span class="line">        uploadTimer.record(duration);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Health-Checks"><a href="#Health-Checks" class="headerlink" title="Health Checks"></a>Health Checks</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageHealthIndicator</span> <span class="keyword">implements</span> <span class="title class_">HealthIndicator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Health <span class="title function_">health</span><span class="params">()</span> &#123;</span><br><span class="line">        Health.<span class="type">Builder</span> <span class="variable">status</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Health</span>.Builder();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check storage backends</span></span><br><span class="line">        <span class="keyword">for</span> (String backend : spiManager.getAvailableBackends()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">FileSystemDriver</span> <span class="variable">driver</span> <span class="operator">=</span> spiManager.getDriver(backend);</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">healthy</span> <span class="operator">=</span> driver.healthCheck();</span><br><span class="line">                status.withDetail(backend, healthy ? <span class="string">&quot;UP&quot;</span> : <span class="string">&quot;DOWN&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                status.withDetail(backend, <span class="string">&quot;ERROR: &quot;</span> + e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> status.up().build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Observability-Dashboard"><a href="#Observability-Dashboard" class="headerlink" title="Observability Dashboard"></a>Observability Dashboard</h3><pre>
<code class="mermaid">
graph LR
subgraph &quot;Application Metrics&quot;
    A[Upload Rate]
    B[Download Rate]
    C[Error Rate]
    D[Response Time]
end

subgraph &quot;Infrastructure Metrics&quot;
    E[CPU Usage]
    F[Memory Usage]
    G[Disk I&#x2F;O]
    H[Network I&#x2F;O]
end

subgraph &quot;Business Metrics&quot;
    I[Storage Usage]
    J[Active Users]
    K[File Types]
    L[Storage Costs]
end

A --&gt; M[Grafana Dashboard]
B --&gt; M
C --&gt; M
D --&gt; M
E --&gt; M
F --&gt; M
G --&gt; M
H --&gt; M
I --&gt; M
J --&gt; M
K --&gt; M
L --&gt; M
</code>
</pre>

<p><strong>💡 Interview Insight</strong>: <em>Observability is crucial for production systems. Discuss the difference between metrics (quantitative), logs (qualitative), and traces (request flow). Mention SLA&#x2F;SLO concepts and how monitoring supports them.</em></p>
<hr>
<h2 id="Deployment-Strategy"><a href="#Deployment-Strategy" class="headerlink" title="Deployment Strategy"></a>Deployment Strategy</h2><h3 id="Containerized-Deployment"><a href="#Containerized-Deployment" class="headerlink" title="Containerized Deployment"></a>Containerized Deployment</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose.yml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">file-storage-service:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">file-storage-service:latest</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_PROFILES_ACTIVE=production</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">STORAGE_BACKENDS=hdfs,nfs,s3</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config:/app/config</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">postgres</span></span><br><span class="line">      </span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:alpine</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">      </span><br><span class="line">  <span class="attr">postgres:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:13</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">POSTGRES_DB:</span> <span class="string">fileservice</span></span><br><span class="line">      <span class="attr">POSTGRES_USER:</span> <span class="string">fileuser</span></span><br><span class="line">      <span class="attr">POSTGRES_PASSWORD:</span> <span class="string">filepass</span></span><br></pre></td></tr></table></figure>

<h3 id="Kubernetes-Deployment"><a href="#Kubernetes-Deployment" class="headerlink" title="Kubernetes Deployment"></a>Kubernetes Deployment</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">file-storage-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">file-storage-service</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">file-storage-service</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">file-storage-service</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">file-storage-service:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">STORAGE_BACKENDS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;hdfs,s3&quot;</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;512Mi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;1000m&quot;</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/actuator/health</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<h3 id="Scaling-Strategy"><a href="#Scaling-Strategy" class="headerlink" title="Scaling Strategy"></a>Scaling Strategy</h3><pre>
<code class="mermaid">
graph TD
A[Load Balancer] --&gt; B[File Service Instance 1]
A --&gt; C[File Service Instance 2]
A --&gt; D[File Service Instance N]

B --&gt; E[Storage Backend Pool]
C --&gt; E
D --&gt; E

E --&gt; F[HDFS Cluster]
E --&gt; G[NFS Servers]
E --&gt; H[S3 Storage]

I[Auto Scaler] --&gt; A
I --&gt; B
I --&gt; C
I --&gt; D
</code>
</pre>

<p><strong>💡 Interview Insight</strong>: <em>Deployment discussions should cover horizontal vs vertical scaling, stateless service design, and data partitioning strategies. Mention circuit breakers for external dependencies and graceful degradation patterns.</em></p>
<hr>
<h2 id="Interview-Key-Points-Summary"><a href="#Interview-Key-Points-Summary" class="headerlink" title="Interview Key Points Summary"></a>Interview Key Points Summary</h2><h3 id="System-Design-Fundamentals"><a href="#System-Design-Fundamentals" class="headerlink" title="System Design Fundamentals"></a>System Design Fundamentals</h3><ul>
<li><strong>Scalability</strong>: Horizontal scaling through stateless services</li>
<li><strong>Reliability</strong>: Circuit breakers, retries, and failover mechanisms</li>
<li><strong>Consistency</strong>: Eventual consistency for metadata with strong consistency for file operations</li>
<li><strong>Availability</strong>: Multi-region deployment with data replication</li>
</ul>
<h3 id="Technical-Deep-Dives"><a href="#Technical-Deep-Dives" class="headerlink" title="Technical Deep Dives"></a>Technical Deep Dives</h3><ul>
<li><strong>SPI Pattern</strong>: Demonstrates extensibility and loose coupling</li>
<li><strong>Caching Strategy</strong>: Multi-level caching with proper invalidation</li>
<li><strong>Security</strong>: Authentication, authorization, and file validation</li>
<li><strong>Monitoring</strong>: Metrics, logging, and distributed tracing</li>
</ul>
<h3 id="Trade-offs-and-Decisions"><a href="#Trade-offs-and-Decisions" class="headerlink" title="Trade-offs and Decisions"></a>Trade-offs and Decisions</h3><ul>
<li><strong>Storage Selection</strong>: Performance vs cost vs durability</li>
<li><strong>Consistency Models</strong>: CAP theorem considerations</li>
<li><strong>API Design</strong>: REST vs GraphQL vs gRPC</li>
<li><strong>Technology Choices</strong>: Java ecosystem vs alternatives</li>
</ul>
<h3 id="Production-Readiness"><a href="#Production-Readiness" class="headerlink" title="Production Readiness"></a>Production Readiness</h3><ul>
<li><strong>Operations</strong>: Deployment, monitoring, and incident response</li>
<li><strong>Performance</strong>: Benchmarking and optimization strategies</li>
<li><strong>Security</strong>: Threat modeling and security testing</li>
<li><strong>Compliance</strong>: Data protection and regulatory requirements</li>
</ul>
<p>This comprehensive design demonstrates understanding of distributed systems, software architecture patterns, and production engineering practices essential for senior engineering roles.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/13/Design-Logs-Analysis-Platform-with-ELK-Stack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/13/Design-Logs-Analysis-Platform-with-ELK-Stack/" class="post-title-link" itemprop="url">Design Logs Analysis Platform with ELK Stack</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-13 14:44:17 / Modified: 14:50:49" itemprop="dateCreated datePublished" datetime="2025-06-13T14:44:17+08:00">2025-06-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system-design/" itemprop="url" rel="index"><span itemprop="name">system-design</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Platform-Architecture-Overview"><a href="#Platform-Architecture-Overview" class="headerlink" title="Platform Architecture Overview"></a>Platform Architecture Overview</h2><p>A logs analysis platform is the backbone of modern observability, enabling organizations to collect, process, store, and analyze massive volumes of log data from distributed systems. This comprehensive guide covers the end-to-end design of a scalable, fault-tolerant logs analysis platform that not only helps with troubleshooting but also enables predictive fault detection.</p>
<h3 id="High-Level-Architecture"><a href="#High-Level-Architecture" class="headerlink" title="High-Level Architecture"></a>High-Level Architecture</h3><pre>
<code class="mermaid">
graph TB
subgraph &quot;Data Sources&quot;
    A[Application Logs]
    B[System Logs]
    C[Security Logs]
    D[Infrastructure Logs]
    E[Database Logs]
end

subgraph &quot;Collection Layer&quot;
    F[Filebeat]
    G[Metricbeat]
    H[Winlogbeat]
    I[Custom Beats]
end

subgraph &quot;Message Queue&quot;
    J[Kafka&#x2F;Redis]
end

subgraph &quot;Processing Layer&quot;
    K[Logstash]
    L[Elasticsearch Ingest Pipelines]
end

subgraph &quot;Storage Layer&quot;
    M[Elasticsearch Cluster]
    N[Cold Storage S3&#x2F;HDFS]
end

subgraph &quot;Analytics &amp; Visualization&quot;
    O[Kibana]
    P[Grafana]
    Q[Custom Dashboards]
end

subgraph &quot;AI&#x2F;ML Layer&quot;
    R[Elasticsearch ML]
    S[External ML Services]
end

A --&gt; F
B --&gt; G
C --&gt; H
D --&gt; I
E --&gt; F

F --&gt; J
G --&gt; J
H --&gt; J
I --&gt; J

J --&gt; K
J --&gt; L

K --&gt; M
L --&gt; M

M --&gt; N
M --&gt; O
M --&gt; P
M --&gt; R

R --&gt; S
O --&gt; Q
</code>
</pre>

<p><strong>Interview Insight</strong>: <em>“When designing log platforms, interviewers often ask about handling different log formats and volumes. Emphasize the importance of a flexible ingestion layer and proper data modeling from day one.”</em></p>
<h2 id="Data-Collection-Layer"><a href="#Data-Collection-Layer" class="headerlink" title="Data Collection Layer"></a>Data Collection Layer</h2><h3 id="Log-Sources-Classification"><a href="#Log-Sources-Classification" class="headerlink" title="Log Sources Classification"></a>Log Sources Classification</h3><h4 id="1-Application-Logs"><a href="#1-Application-Logs" class="headerlink" title="1. Application Logs"></a>1. Application Logs</h4><ul>
<li><strong>Structured Logs</strong>: JSON, XML formatted logs</li>
<li><strong>Semi-structured</strong>: Key-value pairs, custom formats</li>
<li><strong>Unstructured</strong>: Plain text, error dumps</li>
</ul>
<h4 id="2-Infrastructure-Logs"><a href="#2-Infrastructure-Logs" class="headerlink" title="2. Infrastructure Logs"></a>2. Infrastructure Logs</h4><ul>
<li>Container logs (Docker, Kubernetes)</li>
<li>Load balancer logs (Nginx, HAProxy)</li>
<li>Web server logs (Apache, IIS)</li>
<li>Network device logs</li>
</ul>
<h4 id="3-System-Logs"><a href="#3-System-Logs" class="headerlink" title="3. System Logs"></a>3. System Logs</h4><ul>
<li>Operating system logs (syslog, Windows Event Log)</li>
<li>Authentication logs</li>
<li>Kernel logs</li>
</ul>
<h3 id="Collection-Strategy-with-Beats"><a href="#Collection-Strategy-with-Beats" class="headerlink" title="Collection Strategy with Beats"></a>Collection Strategy with Beats</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Example Filebeat Configuration</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/app/*.log</span></span><br><span class="line">  <span class="attr">fields:</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">web-app</span></span><br><span class="line">    <span class="attr">environment:</span> <span class="string">production</span></span><br><span class="line">  <span class="attr">multiline.pattern:</span> <span class="string">&#x27;^[0-9]&#123;4&#125;-[0-9]&#123;2&#125;-[0-9]&#123;2&#125;&#x27;</span></span><br><span class="line">  <span class="attr">multiline.negate:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">multiline.match:</span> <span class="string">after</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">container</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;/var/lib/docker/containers/*/*.log&#x27;</span></span><br><span class="line">  <span class="attr">processors:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">add_kubernetes_metadata:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">$&#123;NODE_NAME&#125;</span></span><br><span class="line">      <span class="attr">matchers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">logs_path:</span></span><br><span class="line">          <span class="attr">logs_path:</span> <span class="string">&quot;/var/lib/docker/containers&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.kafka:</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;kafka1:9092&quot;</span>, <span class="string">&quot;kafka2:9092&quot;</span>, <span class="string">&quot;kafka3:9092&quot;</span>]</span><br><span class="line">  <span class="attr">topic:</span> <span class="string">&#x27;logs-%&#123;[fields.environment]&#125;&#x27;</span></span><br><span class="line">  <span class="attr">partition.round_robin:</span></span><br><span class="line">    <span class="attr">reachable_only:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“Discuss the trade-offs between direct shipping to Elasticsearch vs. using a message queue. Kafka provides better reliability and backpressure handling, especially important for high-volume environments.”</em></p>
<h2 id="Data-Processing-and-Storage"><a href="#Data-Processing-and-Storage" class="headerlink" title="Data Processing and Storage"></a>Data Processing and Storage</h2><h3 id="Logstash-Processing-Pipeline"><a href="#Logstash-Processing-Pipeline" class="headerlink" title="Logstash Processing Pipeline"></a>Logstash Processing Pipeline</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Logstash Configuration Example</span></span><br><span class="line">input &#123;</span><br><span class="line">  kafka &#123;</span><br><span class="line">    bootstrap_servers =&gt; <span class="string">&quot;kafka1:9092,kafka2:9092&quot;</span></span><br><span class="line">    topics =&gt; [<span class="string">&quot;logs-production&quot;</span>, <span class="string">&quot;logs-staging&quot;</span>]</span><br><span class="line">    codec =&gt; json</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  <span class="comment"># Parse application logs</span></span><br><span class="line">  <span class="keyword">if</span> [fields][service] == <span class="string">&quot;web-app&quot;</span> &#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">      match =&gt; &#123; </span><br><span class="line">        <span class="string">&quot;message&quot;</span> =&gt; <span class="string">&quot;%&#123;TIMESTAMP_ISO8601:timestamp&#125; \[%&#123;LOGLEVEL:level&#125;\] %&#123;DATA:logger&#125; - %&#123;GREEDYDATA:log_message&#125;&quot;</span> </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    date &#123;</span><br><span class="line">      match =&gt; [ <span class="string">&quot;timestamp&quot;</span>, <span class="string">&quot;ISO8601&quot;</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Extract error patterns for ML</span></span><br><span class="line">    <span class="keyword">if</span> [level] == <span class="string">&quot;ERROR&quot;</span> &#123;</span><br><span class="line">      mutate &#123;</span><br><span class="line">        add_tag =&gt; [<span class="string">&quot;error&quot;</span>, <span class="string">&quot;needs_analysis&quot;</span>]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Enrich with GeoIP for web logs</span></span><br><span class="line">  <span class="keyword">if</span> [fields][log_type] == <span class="string">&quot;access&quot;</span> &#123;</span><br><span class="line">    geoip &#123;</span><br><span class="line">      source =&gt; <span class="string">&quot;client_ip&quot;</span></span><br><span class="line">      target =&gt; <span class="string">&quot;geoip&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Remove sensitive data</span></span><br><span class="line">  mutate &#123;</span><br><span class="line">    remove_field =&gt; [<span class="string">&quot;password&quot;</span>, <span class="string">&quot;credit_card&quot;</span>, <span class="string">&quot;ssn&quot;</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [<span class="string">&quot;es-node1:9200&quot;</span>, <span class="string">&quot;es-node2:9200&quot;</span>, <span class="string">&quot;es-node3:9200&quot;</span>]</span><br><span class="line">    index =&gt; <span class="string">&quot;logs-%&#123;[fields][service]&#125;-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class="line">    template_name =&gt; <span class="string">&quot;logs&quot;</span></span><br><span class="line">    template =&gt; <span class="string">&quot;/etc/logstash/templates/logs-template.json&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Elasticsearch-Index-Strategy"><a href="#Elasticsearch-Index-Strategy" class="headerlink" title="Elasticsearch Index Strategy"></a>Elasticsearch Index Strategy</h3><h4 id="Index-Lifecycle-Management-ILM"><a href="#Index-Lifecycle-Management-ILM" class="headerlink" title="Index Lifecycle Management (ILM)"></a>Index Lifecycle Management (ILM)</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;policy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;phases&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;hot&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;rollover&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;max_size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10GB&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;max_age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1d&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;set_priority&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;priority&quot;</span><span class="punctuation">:</span> <span class="number">100</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;warm&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;min_age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2d&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;allocate&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;forcemerge&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;max_num_segments&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;set_priority&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;priority&quot;</span><span class="punctuation">:</span> <span class="number">50</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;cold&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;min_age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30d&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;allocate&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;require&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;box_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cold&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;set_priority&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;priority&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;delete&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;min_age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;90d&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“Index lifecycle management is crucial for cost control. Explain how you’d balance search performance with storage costs, and discuss the trade-offs of different retention policies.”</em></p>
<h2 id="Search-and-Analytics"><a href="#Search-and-Analytics" class="headerlink" title="Search and Analytics"></a>Search and Analytics</h2><h3 id="Query-Optimization-Strategies"><a href="#Query-Optimization-Strategies" class="headerlink" title="Query Optimization Strategies"></a>Query Optimization Strategies</h3><h4 id="1-Efficient-Query-Patterns"><a href="#1-Efficient-Query-Patterns" class="headerlink" title="1. Efficient Query Patterns"></a>1. Efficient Query Patterns</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;@timestamp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="string">&quot;now-1h&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;service.keyword&quot;</span><span class="punctuation">:</span> <span class="string">&quot;payment-api&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;error&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;error_types&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;error_type.keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;error_timeline&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;date_histogram&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;@timestamp&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5m&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-Search-Templates-for-Common-Queries"><a href="#2-Search-Templates-for-Common-Queries" class="headerlink" title="2. Search Templates for Common Queries"></a>2. Search Templates for Common Queries</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;script&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;lang&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mustache&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;@timestamp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;start_time&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;lte&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;end_time&#125;&#125;&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;service.keyword&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;services&#125;&#125;&quot;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“Performance optimization questions are common. Discuss field data types (keyword vs text), query caching, and the importance of using filters over queries for better performance.”</em></p>
<h2 id="Visualization-and-Monitoring"><a href="#Visualization-and-Monitoring" class="headerlink" title="Visualization and Monitoring"></a>Visualization and Monitoring</h2><h3 id="Kibana-Dashboard-Design"><a href="#Kibana-Dashboard-Design" class="headerlink" title="Kibana Dashboard Design"></a>Kibana Dashboard Design</h3><h4 id="1-Operational-Dashboard-Structure"><a href="#1-Operational-Dashboard-Structure" class="headerlink" title="1. Operational Dashboard Structure"></a>1. Operational Dashboard Structure</h4><pre>
<code class="mermaid">
graph LR
subgraph &quot;Executive Dashboard&quot;
    A[System Health Overview]
    B[SLA Metrics]
    C[Cost Analytics]
end

subgraph &quot;Operational Dashboard&quot;
    D[Error Rate Trends]
    E[Service Performance]
    F[Infrastructure Metrics]
end

subgraph &quot;Troubleshooting Dashboard&quot;
    G[Error Investigation]
    H[Trace Analysis]
    I[Log Deep Dive]
end

A --&gt; D
D --&gt; G
B --&gt; E
E --&gt; H
C --&gt; F
F --&gt; I
</code>
</pre>

<h4 id="2-Sample-Kibana-Visualization-Config"><a href="#2-Sample-Kibana-Visualization-Config" class="headerlink" title="2. Sample Kibana Visualization Config"></a>2. Sample Kibana Visualization Config</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;visualization&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Error Rate by Service&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;line&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;seriesParams&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Error Rate&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;drawLinesBetweenPoints&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;showCircles&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;categoryAxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CategoryAxis-1&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;category&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bottom&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Time&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;count&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;schema&quot;</span><span class="punctuation">:</span> <span class="string">&quot;metric&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date_histogram&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;schema&quot;</span><span class="punctuation">:</span> <span class="string">&quot;segment&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;@timestamp&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;auto&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min_doc_count&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filters&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;schema&quot;</span><span class="punctuation">:</span> <span class="string">&quot;group&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;filters&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ERROR&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Errors&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Fault-Prediction-and-Alerting"><a href="#Fault-Prediction-and-Alerting" class="headerlink" title="Fault Prediction and Alerting"></a>Fault Prediction and Alerting</h2><h3 id="Machine-Learning-Implementation"><a href="#Machine-Learning-Implementation" class="headerlink" title="Machine Learning Implementation"></a>Machine Learning Implementation</h3><h4 id="1-Anomaly-Detection-Pipeline"><a href="#1-Anomaly-Detection-Pipeline" class="headerlink" title="1. Anomaly Detection Pipeline"></a>1. Anomaly Detection Pipeline</h4><pre>
<code class="mermaid">
flowchart TD
A[Log Ingestion] --&gt; B[Feature Extraction]
B --&gt; C[Anomaly Detection Model]
C --&gt; D{Anomaly Score &gt; Threshold?}
D --&gt;|Yes| E[Generate Alert]
D --&gt;|No| F[Continue Monitoring]
E --&gt; G[Incident Management]
G --&gt; H[Root Cause Analysis]
H --&gt; I[Model Feedback]
I --&gt; C
F --&gt; A
</code>
</pre>

<h4 id="2-Elasticsearch-ML-Job-Configuration"><a href="#2-Elasticsearch-ML-Job-Configuration" class="headerlink" title="2. Elasticsearch ML Job Configuration"></a>2. Elasticsearch ML Job Configuration</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;job_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;error-rate-anomaly&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;analysis_config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bucket_span&quot;</span><span class="punctuation">:</span> <span class="string">&quot;15m&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;detectors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;detector_description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;High error rate&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;function&quot;</span><span class="punctuation">:</span> <span class="string">&quot;high_count&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;by_field_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;service.keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;detector_description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Response time anomaly&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;function&quot;</span><span class="punctuation">:</span> <span class="string">&quot;high_mean&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;field_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;response_time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;by_field_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;service.keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;influencers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;service.keyword&quot;</span><span class="punctuation">,</span> <span class="string">&quot;host.keyword&quot;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data_description&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;time_field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;@timestamp&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;model_plot_config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Alerting-Strategy"><a href="#Alerting-Strategy" class="headerlink" title="Alerting Strategy"></a>Alerting Strategy</h3><h4 id="1-Alert-Hierarchy"><a href="#1-Alert-Hierarchy" class="headerlink" title="1. Alert Hierarchy"></a>1. Alert Hierarchy</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Watcher Alert Example</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;trigger&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;schedule&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;interval&quot;:</span> <span class="string">&quot;5m&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;input&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;search&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;request&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;search_type&quot;:</span> <span class="string">&quot;query_then_fetch&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;indices&quot;:</span> [<span class="string">&quot;logs-*&quot;</span>],</span><br><span class="line">        <span class="attr">&quot;body&quot;:</span> &#123;</span><br><span class="line">          <span class="attr">&quot;query&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;bool&quot;:</span> &#123;</span><br><span class="line">              <span class="attr">&quot;filter&quot;:</span> [</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">&quot;range&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;@timestamp&quot;:</span> &#123;</span><br><span class="line">                      <span class="attr">&quot;gte&quot;:</span> <span class="string">&quot;now-5m&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">&quot;term&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;level.keyword&quot;:</span> <span class="string">&quot;ERROR&quot;</span></span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;aggs&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;error_count&quot;:</span> &#123;</span><br><span class="line">              <span class="attr">&quot;cardinality&quot;:</span> &#123;</span><br><span class="line">                <span class="attr">&quot;field&quot;:</span> <span class="string">&quot;message.keyword&quot;</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;condition&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;compare&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;ctx.payload.aggregations.error_count.value&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;gt&quot;:</span> <span class="number">10</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;actions&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;send_slack&quot;:</span> &#123;</span><br><span class="line">      <span class="attr">&quot;webhook&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;scheme&quot;:</span> <span class="string">&quot;https&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;host&quot;:</span> <span class="string">&quot;hooks.slack.com&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;port&quot;:</span> <span class="number">443</span>,</span><br><span class="line">        <span class="attr">&quot;method&quot;:</span> <span class="string">&quot;post&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;path&quot;:</span> <span class="string">&quot;/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXXXXXX&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;body&quot;:</span> <span class="string">&quot;High error rate detected: <span class="template-variable">&#123;&#123;ctx.payload.aggregations.error_count.value&#125;&#125;</span> unique errors in the last 5 minutes&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“Discuss the difference between reactive and proactive monitoring. Explain how you’d tune alert thresholds to minimize false positives while ensuring critical issues are caught early.”</em></p>
<h2 id="Security-and-Compliance"><a href="#Security-and-Compliance" class="headerlink" title="Security and Compliance"></a>Security and Compliance</h2><h3 id="Security-Implementation"><a href="#Security-Implementation" class="headerlink" title="Security Implementation"></a>Security Implementation</h3><h4 id="1-Authentication-and-Authorization"><a href="#1-Authentication-and-Authorization" class="headerlink" title="1. Authentication and Authorization"></a>1. Authentication and Authorization</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Elasticsearch Security Configuration</span></span><br><span class="line"><span class="attr">xpack.security.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.http.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Role-based Access Control</span></span><br><span class="line"><span class="attr">roles:</span></span><br><span class="line">  <span class="attr">log_reader:</span></span><br><span class="line">    <span class="attr">cluster:</span> [<span class="string">&quot;monitor&quot;</span>]</span><br><span class="line">    <span class="attr">indices:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">names:</span> [<span class="string">&quot;logs-*&quot;</span>]</span><br><span class="line">        <span class="attr">privileges:</span> [<span class="string">&quot;read&quot;</span>, <span class="string">&quot;view_index_metadata&quot;</span>]</span><br><span class="line">        <span class="attr">field_security:</span></span><br><span class="line">          <span class="attr">grant:</span> [<span class="string">&quot;@timestamp&quot;</span>, <span class="string">&quot;level&quot;</span>, <span class="string">&quot;message&quot;</span>, <span class="string">&quot;service&quot;</span>]</span><br><span class="line">          <span class="attr">except:</span> [<span class="string">&quot;sensitive_data&quot;</span>]</span><br><span class="line">  </span><br><span class="line">  <span class="attr">log_admin:</span></span><br><span class="line">    <span class="attr">cluster:</span> [<span class="string">&quot;all&quot;</span>]</span><br><span class="line">    <span class="attr">indices:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">names:</span> [<span class="string">&quot;*&quot;</span>]</span><br><span class="line">        <span class="attr">privileges:</span> [<span class="string">&quot;all&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="2-Data-Masking-Pipeline"><a href="#2-Data-Masking-Pipeline" class="headerlink" title="2. Data Masking Pipeline"></a>2. Data Masking Pipeline</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Mask sensitive data&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;processors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;gsub&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;message&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\\b\\d&#123;4&#125;[\\s-]?\\d&#123;4&#125;[\\s-]?\\d&#123;4&#125;[\\s-]?\\d&#123;4&#125;\\b&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;replacement&quot;</span><span class="punctuation">:</span> <span class="string">&quot;****-****-****-****&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;gsub&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;message&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Z|a-z]&#123;2,&#125;\\b&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;replacement&quot;</span><span class="punctuation">:</span> <span class="string">&quot;***@***.***&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“Security questions often focus on PII handling and compliance. Be prepared to discuss GDPR implications, data retention policies, and the right to be forgotten in log systems.”</em></p>
<h2 id="Scalability-and-Performance"><a href="#Scalability-and-Performance" class="headerlink" title="Scalability and Performance"></a>Scalability and Performance</h2><h3 id="Cluster-Sizing-and-Architecture"><a href="#Cluster-Sizing-and-Architecture" class="headerlink" title="Cluster Sizing and Architecture"></a>Cluster Sizing and Architecture</h3><h4 id="1-Node-Roles-and-Allocation"><a href="#1-Node-Roles-and-Allocation" class="headerlink" title="1. Node Roles and Allocation"></a>1. Node Roles and Allocation</h4><pre>
<code class="mermaid">
graph TB
subgraph &quot;Master Nodes (3)&quot;
    M1[Master-1]
    M2[Master-2]
    M3[Master-3]
end

subgraph &quot;Hot Data Nodes (6)&quot;
    H1[Hot-1&lt;br&#x2F;&gt;High CPU&#x2F;RAM&lt;br&#x2F;&gt;SSD Storage]
    H2[Hot-2]
    H3[Hot-3]
    H4[Hot-4]
    H5[Hot-5]
    H6[Hot-6]
end

subgraph &quot;Warm Data Nodes (4)&quot;
    W1[Warm-1&lt;br&#x2F;&gt;Medium CPU&#x2F;RAM&lt;br&#x2F;&gt;HDD Storage]
    W2[Warm-2]
    W3[Warm-3]
    W4[Warm-4]
end

subgraph &quot;Cold Data Nodes (2)&quot;
    C1[Cold-1&lt;br&#x2F;&gt;Low CPU&#x2F;RAM&lt;br&#x2F;&gt;Cheap Storage]
    C2[Cold-2]
end

subgraph &quot;Coordinating Nodes (2)&quot;
    CO1[Coord-1&lt;br&#x2F;&gt;Query Processing]
    CO2[Coord-2]
end
</code>
</pre>

<h4 id="2-Performance-Optimization"><a href="#2-Performance-Optimization" class="headerlink" title="2. Performance Optimization"></a>2. Performance Optimization</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Elasticsearch Configuration for Performance</span></span><br><span class="line"><span class="attr">cluster.name:</span> <span class="string">logs-production</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">$&#123;HOSTNAME&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Memory Settings</span></span><br><span class="line"><span class="attr">bootstrap.memory_lock:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">indices.memory.index_buffer_size:</span> <span class="number">30</span><span class="string">%</span></span><br><span class="line"><span class="attr">indices.memory.min_index_buffer_size:</span> <span class="string">96mb</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Thread Pool Optimization</span></span><br><span class="line"><span class="attr">thread_pool.write.queue_size:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">thread_pool.search.queue_size:</span> <span class="number">1000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Index Settings for High Volume</span></span><br><span class="line"><span class="attr">index.refresh_interval:</span> <span class="string">30s</span></span><br><span class="line"><span class="attr">index.number_of_shards:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">index.number_of_replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">index.translog.flush_threshold_size:</span> <span class="string">1gb</span></span><br></pre></td></tr></table></figure>

<h3 id="Capacity-Planning-Model"><a href="#Capacity-Planning-Model" class="headerlink" title="Capacity Planning Model"></a>Capacity Planning Model</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Capacity Planning Calculator</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_storage_requirements</span>(<span class="params"></span></span><br><span class="line"><span class="params">    daily_log_volume_gb,</span></span><br><span class="line"><span class="params">    retention_days,</span></span><br><span class="line"><span class="params">    replication_factor,</span></span><br><span class="line"><span class="params">    compression_ratio=<span class="number">0.7</span></span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    raw_storage = daily_log_volume_gb * retention_days</span><br><span class="line">    with_replication = raw_storage * (<span class="number">1</span> + replication_factor)</span><br><span class="line">    compressed_storage = with_replication * compression_ratio</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Add 20% buffer for operations</span></span><br><span class="line">    total_storage = compressed_storage * <span class="number">1.2</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;raw_daily&quot;</span>: daily_log_volume_gb,</span><br><span class="line">        <span class="string">&quot;total_compressed&quot;</span>: compressed_storage,</span><br><span class="line">        <span class="string">&quot;recommended_capacity&quot;</span>: total_storage,</span><br><span class="line">        <span class="string">&quot;hot_tier&quot;</span>: total_storage * <span class="number">0.3</span>,  <span class="comment"># 30% in hot</span></span><br><span class="line">        <span class="string">&quot;warm_tier&quot;</span>: total_storage * <span class="number">0.5</span>,  <span class="comment"># 50% in warm</span></span><br><span class="line">        <span class="string">&quot;cold_tier&quot;</span>: total_storage * <span class="number">0.2</span>   <span class="comment"># 20% in cold</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example calculation</span></span><br><span class="line">requirements = calculate_storage_requirements(</span><br><span class="line">    daily_log_volume_gb=<span class="number">500</span>,</span><br><span class="line">    retention_days=<span class="number">90</span>,</span><br><span class="line">    replication_factor=<span class="number">1</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“Capacity planning is a critical skill. Discuss how you’d model growth, handle traffic spikes, and plan for different data tiers. Include both storage and compute considerations.”</em></p>
<h2 id="Implementation-Roadmap"><a href="#Implementation-Roadmap" class="headerlink" title="Implementation Roadmap"></a>Implementation Roadmap</h2><h3 id="Phase-wise-Implementation"><a href="#Phase-wise-Implementation" class="headerlink" title="Phase-wise Implementation"></a>Phase-wise Implementation</h3><pre>
<code class="mermaid">
gantt
title Logs Analysis Platform Implementation
dateFormat  YYYY-MM-DD
section Phase 1: Foundation
Infrastructure Setup           :done,    phase1a, 2024-01-01, 2024-01-15
Basic ELK Stack Deployment    :done,    phase1b, 2024-01-15, 2024-01-30
Initial Log Collection        :done,    phase1c, 2024-01-30, 2024-02-15

section Phase 2: Core Features
Advanced Processing           :active,  phase2a, 2024-02-15, 2024-03-01
Security Implementation       :         phase2b, 2024-03-01, 2024-03-15
Basic Dashboards             :         phase2c, 2024-03-15, 2024-03-30

section Phase 3: Intelligence
ML&#x2F;Anomaly Detection         :         phase3a, 2024-03-30, 2024-04-15
Advanced Alerting            :         phase3b, 2024-04-15, 2024-04-30
Predictive Analytics         :         phase3c, 2024-04-30, 2024-05-15

section Phase 4: Optimization
Performance Tuning           :         phase4a, 2024-05-15, 2024-05-30
Cost Optimization            :         phase4b, 2024-05-30, 2024-06-15
Documentation &amp; Training     :         phase4c, 2024-06-15, 2024-06-30
</code>
</pre>

<h3 id="Migration-Strategy"><a href="#Migration-Strategy" class="headerlink" title="Migration Strategy"></a>Migration Strategy</h3><h4 id="1-Parallel-Run-Approach"><a href="#1-Parallel-Run-Approach" class="headerlink" title="1. Parallel Run Approach"></a>1. Parallel Run Approach</h4><pre>
<code class="mermaid">
sequenceDiagram
participant Legacy as Legacy System
participant New as New ELK Platform
participant Apps as Applications
participant Ops as Operations Team

Note over Legacy, Ops: Phase 1: Parallel Ingestion
Apps-&gt;&gt;Legacy: Continue logging
Apps-&gt;&gt;New: Start dual logging
New-&gt;&gt;Ops: Validation reports

Note over Legacy, Ops: Phase 2: Gradual Migration
Apps-&gt;&gt;Legacy: Reduced logging
Apps-&gt;&gt;New: Primary logging
New-&gt;&gt;Ops: Performance metrics

Note over Legacy, Ops: Phase 3: Full Cutover
Apps-&gt;&gt;New: All logging
Legacy-&gt;&gt;New: Historical data migration
New-&gt;&gt;Ops: Full operational control
</code>
</pre>

<h2 id="Operational-Best-Practices"><a href="#Operational-Best-Practices" class="headerlink" title="Operational Best Practices"></a>Operational Best Practices</h2><h3 id="Monitoring-and-Maintenance"><a href="#Monitoring-and-Maintenance" class="headerlink" title="Monitoring and Maintenance"></a>Monitoring and Maintenance</h3><h4 id="1-Platform-Health-Monitoring"><a href="#1-Platform-Health-Monitoring" class="headerlink" title="1. Platform Health Monitoring"></a>1. Platform Health Monitoring</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Metricbeat Configuration for ELK Monitoring</span></span><br><span class="line"><span class="attr">metricbeat.modules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">module:</span> <span class="string">elasticsearch</span></span><br><span class="line">  <span class="attr">metricsets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">node</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">node_stats</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cluster_stats</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">index</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">index_recovery</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">index_summary</span></span><br><span class="line">  <span class="attr">period:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;http://localhost:9200&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">module:</span> <span class="string">kibana</span></span><br><span class="line">  <span class="attr">metricsets:</span> [<span class="string">&quot;status&quot;</span>]</span><br><span class="line">  <span class="attr">period:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;localhost:5601&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">module:</span> <span class="string">logstash</span></span><br><span class="line">  <span class="attr">metricsets:</span> [<span class="string">&quot;node&quot;</span>, <span class="string">&quot;node_stats&quot;</span>]</span><br><span class="line">  <span class="attr">period:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;localhost:9600&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="2-Operational-Runbooks"><a href="#2-Operational-Runbooks" class="headerlink" title="2. Operational Runbooks"></a>2. Operational Runbooks</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">## Incident Response Runbook</span></span><br><span class="line"></span><br><span class="line"><span class="section">### High CPU Usage on Elasticsearch Nodes</span></span><br><span class="line"><span class="bullet">1.</span> Check query patterns in slow log</span><br><span class="line"><span class="bullet">2.</span> Identify expensive aggregations</span><br><span class="line"><span class="bullet">3.</span> Review recent index changes</span><br><span class="line"><span class="bullet">4.</span> Scale horizontally if needed</span><br><span class="line"></span><br><span class="line"><span class="section">### High Memory Usage</span></span><br><span class="line"><span class="bullet">1.</span> Check field data cache size</span><br><span class="line"><span class="bullet">2.</span> Review mapping for analyzed fields</span><br><span class="line"><span class="bullet">3.</span> Implement circuit breakers</span><br><span class="line"><span class="bullet">4.</span> Consider node memory increase</span><br><span class="line"></span><br><span class="line"><span class="section">### Disk Space Issues</span></span><br><span class="line"><span class="bullet">1.</span> Check ILM policy execution</span><br><span class="line"><span class="bullet">2.</span> Force merge old indices</span><br><span class="line"><span class="bullet">3.</span> Move indices to cold tier</span><br><span class="line"><span class="bullet">4.</span> Delete unnecessary indices</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“Operations questions test your real-world experience. Discuss common failure scenarios, monitoring strategies, and how you’d handle a production outage with logs being critical for troubleshooting.”</em></p>
<h3 id="Data-Quality-and-Governance"><a href="#Data-Quality-and-Governance" class="headerlink" title="Data Quality and Governance"></a>Data Quality and Governance</h3><h4 id="1-Log-Quality-Metrics"><a href="#1-Log-Quality-Metrics" class="headerlink" title="1. Log Quality Metrics"></a>1. Log Quality Metrics</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;quality_checks&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;completeness&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;missing_timestamp&quot;</span><span class="punctuation">:</span> <span class="number">0.01</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;missing_service_tag&quot;</span><span class="punctuation">:</span> <span class="number">0.05</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;empty_messages&quot;</span><span class="punctuation">:</span> <span class="number">0.02</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;consistency&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;format_compliance&quot;</span><span class="punctuation">:</span> <span class="number">0.95</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;schema_violations&quot;</span><span class="punctuation">:</span> <span class="number">0.03</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timeliness&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;ingestion_delay_p95&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30s&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;processing_delay_p95&quot;</span><span class="punctuation">:</span> <span class="string">&quot;60s&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-Cost-Optimization-Strategies"><a href="#2-Cost-Optimization-Strategies" class="headerlink" title="2. Cost Optimization Strategies"></a>2. Cost Optimization Strategies</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cost Optimization Analysis</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">analyze_index_costs</span>(<span class="params">indices_stats</span>):</span><br><span class="line">    cost_analysis = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> index, stats <span class="keyword">in</span> indices_stats.items():</span><br><span class="line">        storage_gb = stats[<span class="string">&#x27;store_size_gb&#x27;</span>]</span><br><span class="line">        daily_queries = stats[<span class="string">&#x27;search_count&#x27;</span>] / stats[<span class="string">&#x27;age_days&#x27;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Calculate cost per query</span></span><br><span class="line">        storage_cost = storage_gb * <span class="number">0.023</span>  <span class="comment"># AWS EBS cost</span></span><br><span class="line">        compute_cost = daily_queries * <span class="number">0.0001</span>  <span class="comment"># Estimated compute per query</span></span><br><span class="line">        </span><br><span class="line">        cost_analysis[index] = &#123;</span><br><span class="line">            <span class="string">&#x27;storage_cost&#x27;</span>: storage_cost,</span><br><span class="line">            <span class="string">&#x27;compute_cost&#x27;</span>: compute_cost,</span><br><span class="line">            <span class="string">&#x27;cost_per_query&#x27;</span>: (storage_cost + compute_cost) / <span class="built_in">max</span>(daily_queries, <span class="number">1</span>),</span><br><span class="line">            <span class="string">&#x27;recommendation&#x27;</span>: get_tier_recommendation(storage_gb, daily_queries)</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> cost_analysis</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_tier_recommendation</span>(<span class="params">storage_gb, daily_queries</span>):</span><br><span class="line">    <span class="keyword">if</span> daily_queries &gt; <span class="number">100</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hot&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> daily_queries &gt; <span class="number">10</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;warm&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;cold&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>This comprehensive logs analysis platform design provides a robust foundation for enterprise-scale log management, combining the power of the ELK stack with modern best practices for scalability, security, and operational excellence. The platform enables both reactive troubleshooting and proactive fault prediction, making it an essential component of any modern DevOps toolkit.</p>
<h3 id="Key-Success-Factors"><a href="#Key-Success-Factors" class="headerlink" title="Key Success Factors"></a>Key Success Factors</h3><ol>
<li><strong>Proper Data Modeling</strong>: Design indices and mappings from the start</li>
<li><strong>Scalable Architecture</strong>: Plan for growth in both volume and complexity  </li>
<li><strong>Security First</strong>: Implement proper access controls and data protection</li>
<li><strong>Operational Excellence</strong>: Build comprehensive monitoring and alerting</li>
<li><strong>Cost Awareness</strong>: Optimize storage tiers and retention policies</li>
<li><strong>Team Training</strong>: Ensure proper adoption and utilization</li>
</ol>
<p><strong>Final Interview Insight</strong>: <em>“When discussing log platforms in interviews, emphasize the business value: faster incident resolution, proactive issue detection, and data-driven decision making. Technical excellence should always tie back to business outcomes.”</em></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/12/Design-User-Login-System-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/12/Design-User-Login-System-Guide/" class="post-title-link" itemprop="url">Design User Login System Guide</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-12 23:47:50" itemprop="dateCreated datePublished" datetime="2025-06-12T23:47:50+08:00">2025-06-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-23 20:38:30" itemprop="dateModified" datetime="2025-06-23T20:38:30+08:00">2025-06-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system-design/" itemprop="url" rel="index"><span itemprop="name">system-design</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="System-Overview-and-Architecture"><a href="#System-Overview-and-Architecture" class="headerlink" title="System Overview and Architecture"></a>System Overview and Architecture</h2><p>A robust user login system forms the backbone of secure web applications, handling authentication (verifying user identity) and authorization (controlling access to resources). This guide presents a production-ready architecture that balances security, scalability, and maintainability.</p>
<h3 id="Core-Components-Architecture"><a href="#Core-Components-Architecture" class="headerlink" title="Core Components Architecture"></a>Core Components Architecture</h3><pre>
<code class="mermaid">
graph TB
A[User Browser] --&gt; B[UserLoginWebsite]
B --&gt; C[AuthenticationFilter]
C --&gt; D[UserLoginService]
D --&gt; E[Redis Session Store]
D --&gt; F[UserService]
D --&gt; G[PermissionService]

subgraph &quot;External Services&quot;
    F[UserService]
    G[PermissionService]
end

subgraph &quot;Session Management&quot;
    E[Redis Session Store]
    H[JWT Token Service]
end

subgraph &quot;Web Layer&quot;
    B[UserLoginWebsite]
    C[AuthenticationFilter]
end

subgraph &quot;Business Layer&quot;
    D[UserLoginService]
end
</code>
</pre>

<p><strong>Design Philosophy</strong>: The architecture follows the separation of concerns principle, with each component having a single responsibility. The web layer handles HTTP interactions, the business layer manages authentication logic, and external services provide user data and permissions.</p>
<h2 id="UserLoginWebsite-Component"><a href="#UserLoginWebsite-Component" class="headerlink" title="UserLoginWebsite Component"></a>UserLoginWebsite Component</h2><p>The UserLoginWebsite serves as the presentation layer, providing both user-facing login interfaces and administrative user management capabilities.</p>
<h3 id="Key-Responsibilities"><a href="#Key-Responsibilities" class="headerlink" title="Key Responsibilities"></a>Key Responsibilities</h3><ul>
<li><strong>User Interface</strong>: Render login forms, dashboard, and user profile pages</li>
<li><strong>Admin Interface</strong>: Provide user management tools for administrators</li>
<li><strong>Session Handling</strong>: Manage cookies and client-side session state</li>
<li><strong>Security Headers</strong>: Implement CSRF protection and secure cookie settings</li>
</ul>
<h3 id="Implementation-Example"><a href="#Implementation-Example" class="headerlink" title="Implementation Example"></a>Implementation Example</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/auth&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserLoginService userLoginService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;LoginResponse&gt; <span class="title function_">login</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestBody</span> LoginRequest request,</span></span><br><span class="line"><span class="params">            HttpServletResponse response)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">LoginResult</span> <span class="variable">result</span> <span class="operator">=</span> userLoginService.authenticate(</span><br><span class="line">                request.getUsername(), </span><br><span class="line">                request.getPassword()</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Set secure cookie with session ID</span></span><br><span class="line">            <span class="type">Cookie</span> <span class="variable">sessionCookie</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cookie</span>(<span class="string">&quot;JSESSIONID&quot;</span>, result.getSessionId());</span><br><span class="line">            sessionCookie.setHttpOnly(<span class="literal">true</span>);</span><br><span class="line">            sessionCookie.setSecure(<span class="literal">true</span>);</span><br><span class="line">            sessionCookie.setPath(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">            sessionCookie.setMaxAge(<span class="number">3600</span>); <span class="comment">// 1 hour</span></span><br><span class="line">            response.addCookie(sessionCookie);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.ok(<span class="keyword">new</span> <span class="title class_">LoginResponse</span>(result.getUser()));</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.status(HttpStatus.UNAUTHORIZED)</span><br><span class="line">                .body(<span class="keyword">new</span> <span class="title class_">LoginResponse</span>(<span class="string">&quot;Invalid credentials&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/logout&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Void&gt; <span class="title function_">logout</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sessionId</span> <span class="operator">=</span> extractSessionId(request);</span><br><span class="line">        userLoginService.logout(sessionId);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok().build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“How do you handle CSRF attacks in login systems?”</em></p>
<p><strong>Answer</strong>: Implement CSRF tokens for state-changing operations, use SameSite cookie attributes, and validate the Origin&#x2F;Referer headers. The login form should include a CSRF token that’s validated on the server side.</p>
<h2 id="UserLoginService-Component"><a href="#UserLoginService-Component" class="headerlink" title="UserLoginService Component"></a>UserLoginService Component</h2><p>The UserLoginService acts as the core business logic layer, orchestrating authentication workflows and session management.</p>
<h3 id="Design-Philosophy"><a href="#Design-Philosophy" class="headerlink" title="Design Philosophy"></a>Design Philosophy</h3><p>The service follows the facade pattern, providing a unified interface for complex authentication operations while delegating specific tasks to specialized components.</p>
<h3 id="Core-Operations-Flow"><a href="#Core-Operations-Flow" class="headerlink" title="Core Operations Flow"></a>Core Operations Flow</h3><pre>
<code class="mermaid">
sequenceDiagram
participant C as Client
participant ULS as UserLoginService
participant US as UserService
participant PS as PermissionService
participant R as Redis

C-&gt;&gt;ULS: authenticate(username, password)
ULS-&gt;&gt;US: validateCredentials(username, password)
US--&gt;&gt;ULS: User object
ULS-&gt;&gt;PS: getUserPermissions(userId)
PS--&gt;&gt;ULS: Permissions list
ULS-&gt;&gt;R: storeSession(sessionId, userInfo)
R--&gt;&gt;ULS: confirmation
ULS--&gt;&gt;C: LoginResult with sessionId
</code>
</pre>

<h3 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserLoginService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PermissionService permissionService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtTokenService jwtTokenService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SESSION_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;user:session:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SESSION_TIMEOUT</span> <span class="operator">=</span> <span class="number">3600</span>; <span class="comment">// 1 hour</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> LoginResult <span class="title function_">authenticate</span><span class="params">(String username, String password)</span> &#123;</span><br><span class="line">        <span class="comment">// Step 1: Validate credentials</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.validateCredentials(username, password);</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthenticationException</span>(<span class="string">&quot;Invalid credentials&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Step 2: Load user permissions</span></span><br><span class="line">        List&lt;Permission&gt; permissions = permissionService.getUserPermissions(user.getId());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Step 3: Create session</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">sessionId</span> <span class="operator">=</span> generateSessionId();</span><br><span class="line">        <span class="type">UserSession</span> <span class="variable">session</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserSession</span>(user, permissions, System.currentTimeMillis());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Step 4: Store session in Redis</span></span><br><span class="line">        redisTemplate.opsForValue().set(</span><br><span class="line">            SESSION_PREFIX + sessionId, </span><br><span class="line">            session, </span><br><span class="line">            SESSION_TIMEOUT, </span><br><span class="line">            TimeUnit.SECONDS</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Step 5: Generate JWT token (optional)</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">jwtToken</span> <span class="operator">=</span> jwtTokenService.generateToken(user, permissions);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LoginResult</span>(sessionId, user, jwtToken);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logout</span><span class="params">(String sessionId)</span> &#123;</span><br><span class="line">        redisTemplate.delete(SESSION_PREFIX + sessionId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> UserSession <span class="title function_">getSession</span><span class="params">(String sessionId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (UserSession) redisTemplate.opsForValue().get(SESSION_PREFIX + sessionId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refreshSession</span><span class="params">(String sessionId)</span> &#123;</span><br><span class="line">        redisTemplate.expire(SESSION_PREFIX + sessionId, SESSION_TIMEOUT, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">generateSessionId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> UUID.randomUUID().toString().replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“How do you handle concurrent login attempts?”</em></p>
<p><strong>Answer</strong>: Implement rate limiting using Redis counters, track failed login attempts per IP&#x2F;username, and use exponential backoff. Consider implementing account lockout policies and CAPTCHA after multiple failed attempts.</p>
<h2 id="Redis-Session-Management"><a href="#Redis-Session-Management" class="headerlink" title="Redis Session Management"></a>Redis Session Management</h2><p>Redis serves as the distributed session store, providing fast access to session data across multiple application instances.</p>
<h3 id="Session-Storage-Strategy"><a href="#Session-Storage-Strategy" class="headerlink" title="Session Storage Strategy"></a>Session Storage Strategy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisSessionManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">USER_SESSION_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;session:user:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">USER_PERMISSIONS_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;session:permissions:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_TIMEOUT</span> <span class="operator">=</span> <span class="number">1800</span>; <span class="comment">// 30 minutes</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">storeUserSession</span><span class="params">(String sessionId, UserSession session)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userKey</span> <span class="operator">=</span> USER_SESSION_PREFIX + sessionId;</span><br><span class="line">        <span class="type">String</span> <span class="variable">permissionsKey</span> <span class="operator">=</span> USER_PERMISSIONS_PREFIX + sessionId;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Store user info and permissions separately for optimized access</span></span><br><span class="line">        redisTemplate.opsForHash().putAll(userKey, session.toMap());</span><br><span class="line">        redisTemplate.opsForSet().add(permissionsKey, session.getPermissions().toArray());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Set expiration</span></span><br><span class="line">        redisTemplate.expire(userKey, DEFAULT_TIMEOUT, TimeUnit.SECONDS);</span><br><span class="line">        redisTemplate.expire(permissionsKey, DEFAULT_TIMEOUT, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> UserSession <span class="title function_">getUserSession</span><span class="params">(String sessionId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userKey</span> <span class="operator">=</span> USER_SESSION_PREFIX + sessionId;</span><br><span class="line">        Map&lt;Object, Object&gt; sessionData = redisTemplate.opsForHash().entries(userKey);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (sessionData.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Refresh session timeout on access</span></span><br><span class="line">        redisTemplate.expire(userKey, DEFAULT_TIMEOUT, TimeUnit.SECONDS);</span><br><span class="line">        redisTemplate.expire(USER_PERMISSIONS_PREFIX + sessionId, DEFAULT_TIMEOUT, TimeUnit.SECONDS);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> UserSession.fromMap(sessionData);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Session-Cleanup-Strategy"><a href="#Session-Cleanup-Strategy" class="headerlink" title="Session Cleanup Strategy"></a>Session Cleanup Strategy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SessionCleanupService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 300000)</span> <span class="comment">// Every 5 minutes</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cleanupExpiredSessions</span><span class="params">()</span> &#123;</span><br><span class="line">        Set&lt;String&gt; expiredSessions = findExpiredSessions();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String sessionId : expiredSessions) &#123;</span><br><span class="line">            cleanupSession(sessionId);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        log.info(<span class="string">&quot;Cleaned up &#123;&#125; expired sessions&quot;</span>, expiredSessions.size());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">cleanupSession</span><span class="params">(String sessionId)</span> &#123;</span><br><span class="line">        redisTemplate.delete(USER_SESSION_PREFIX + sessionId);</span><br><span class="line">        redisTemplate.delete(USER_PERMISSIONS_PREFIX + sessionId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“How do you handle Redis failures in session management?”</em></p>
<p><strong>Answer</strong>: Implement fallback mechanisms like database session storage, use Redis clustering for high availability, and implement circuit breakers. Consider graceful degradation where users are redirected to re-login if session data is unavailable.</p>
<h2 id="AuthenticationFilter-Component"><a href="#AuthenticationFilter-Component" class="headerlink" title="AuthenticationFilter Component"></a>AuthenticationFilter Component</h2><p>The AuthenticationFilter acts as a security gateway, validating every HTTP request to ensure proper authentication and authorization.</p>
<h3 id="Filter-Implementation"><a href="#Filter-Implementation" class="headerlink" title="Filter Implementation"></a>Filter Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Order(1)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthenticationFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserLoginService userLoginService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PermissionService permissionService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;String&gt; EXCLUDED_PATHS = Set.of(</span><br><span class="line">        <span class="string">&quot;/auth/login&quot;</span>, <span class="string">&quot;/auth/register&quot;</span>, <span class="string">&quot;/public&quot;</span>, <span class="string">&quot;/health&quot;</span></span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, </span></span><br><span class="line"><span class="params">                        FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">httpRequest</span> <span class="operator">=</span> (HttpServletRequest) request;</span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">httpResponse</span> <span class="operator">=</span> (HttpServletResponse) response;</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">requestPath</span> <span class="operator">=</span> httpRequest.getRequestURI();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Skip authentication for excluded paths</span></span><br><span class="line">        <span class="keyword">if</span> (isExcludedPath(requestPath)) &#123;</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Extract session ID from cookie</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">sessionId</span> <span class="operator">=</span> extractSessionId(httpRequest);</span><br><span class="line">            <span class="keyword">if</span> (sessionId == <span class="literal">null</span>) &#123;</span><br><span class="line">                handleUnauthorized(httpResponse, <span class="string">&quot;No session found&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Validate session</span></span><br><span class="line">            <span class="type">UserSession</span> <span class="variable">session</span> <span class="operator">=</span> userLoginService.getSession(sessionId);</span><br><span class="line">            <span class="keyword">if</span> (session == <span class="literal">null</span> || isSessionExpired(session)) &#123;</span><br><span class="line">                handleUnauthorized(httpResponse, <span class="string">&quot;Session expired&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Check permissions for the requested resource</span></span><br><span class="line">            <span class="keyword">if</span> (!hasPermission(session, requestPath, httpRequest.getMethod())) &#123;</span><br><span class="line">                handleForbidden(httpResponse, <span class="string">&quot;Insufficient permissions&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Refresh session timeout</span></span><br><span class="line">            userLoginService.refreshSession(sessionId);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Set user context for downstream processing</span></span><br><span class="line">            SecurityContextHolder.setContext(<span class="keyword">new</span> <span class="title class_">SecurityContext</span>(session.getUser()));</span><br><span class="line">            </span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Authentication filter error&quot;</span>, e);</span><br><span class="line">            handleUnauthorized(httpResponse, <span class="string">&quot;Authentication error&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            SecurityContextHolder.clearContext();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">hasPermission</span><span class="params">(UserSession session, String path, String method)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> permissionService.checkPermission(</span><br><span class="line">            session.getUser().getId(), </span><br><span class="line">            path, </span><br><span class="line">            method</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleUnauthorized</span><span class="params">(HttpServletResponse response, String message)</span> </span><br><span class="line">            <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        response.setStatus(HttpStatus.UNAUTHORIZED.value());</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">        response.getWriter().write(<span class="string">&quot;&#123;\&quot;error\&quot;:\&quot;&quot;</span> + message + <span class="string">&quot;\&quot;&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“How do you optimize filter performance for high-traffic applications?”</em></p>
<p><strong>Answer</strong>: Cache permission checks in Redis, use efficient data structures for path matching, implement request batching for permission validation, and consider using async processing for non-blocking operations.</p>
<h2 id="JWT-Integration-Strategy"><a href="#JWT-Integration-Strategy" class="headerlink" title="JWT Integration Strategy"></a>JWT Integration Strategy</h2><p>JWT (JSON Web Tokens) can complement session-based authentication by providing stateless authentication capabilities and enabling distributed systems integration.</p>
<h3 id="When-to-Use-JWT"><a href="#When-to-Use-JWT" class="headerlink" title="When to Use JWT"></a>When to Use JWT</h3><p><strong>Use JWT when:</strong></p>
<ul>
<li>Building microservices architecture</li>
<li>Implementing single sign-on (SSO)</li>
<li>Supporting mobile applications</li>
<li>Enabling API authentication</li>
<li>Requiring stateless authentication</li>
</ul>
<p><strong>Use Sessions when:</strong></p>
<ul>
<li>Building traditional web applications</li>
<li>Requiring immediate token revocation</li>
<li>Handling sensitive operations</li>
<li>Managing complex user states</li>
</ul>
<h3 id="Hybrid-Approach-Implementation"><a href="#Hybrid-Approach-Implementation" class="headerlink" title="Hybrid Approach Implementation"></a>Hybrid Approach Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtTokenService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jwt.secret&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String jwtSecret;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jwt.expiration&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> jwtExpiration;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generateToken</span><span class="params">(User user, List&lt;Permission&gt; permissions)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; claims = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        claims.put(<span class="string">&quot;userId&quot;</span>, user.getId());</span><br><span class="line">        claims.put(<span class="string">&quot;username&quot;</span>, user.getUsername());</span><br><span class="line">        claims.put(<span class="string">&quot;permissions&quot;</span>, permissions.stream()</span><br><span class="line">            .map(Permission::getName)</span><br><span class="line">            .collect(Collectors.toList()));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> Jwts.builder()</span><br><span class="line">            .setClaims(claims)</span><br><span class="line">            .setSubject(user.getUsername())</span><br><span class="line">            .setIssuedAt(<span class="keyword">new</span> <span class="title class_">Date</span>())</span><br><span class="line">            .setExpiration(<span class="keyword">new</span> <span class="title class_">Date</span>(System.currentTimeMillis() + jwtExpiration * <span class="number">1000</span>))</span><br><span class="line">            .signWith(SignatureAlgorithm.HS256, jwtSecret)</span><br><span class="line">            .compact();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Claims <span class="title function_">validateToken</span><span class="params">(String token)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Jwts.parser()</span><br><span class="line">                .setSigningKey(jwtSecret)</span><br><span class="line">                .parseClaimsJws(token)</span><br><span class="line">                .getBody();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JwtException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthenticationException</span>(<span class="string">&quot;Invalid JWT token&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isTokenExpired</span><span class="params">(String token)</span> &#123;</span><br><span class="line">        <span class="type">Date</span> <span class="variable">expiration</span> <span class="operator">=</span> validateToken(token).getExpiration();</span><br><span class="line">        <span class="keyword">return</span> expiration.before(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="JWT-vs-Session-Comparison"><a href="#JWT-vs-Session-Comparison" class="headerlink" title="JWT vs Session Comparison"></a>JWT vs Session Comparison</h3><table>
<thead>
<tr>
<th>Aspect</th>
<th>JWT</th>
<th>Session</th>
</tr>
</thead>
<tbody><tr>
<td><strong>State</strong></td>
<td>Stateless</td>
<td>Stateful</td>
</tr>
<tr>
<td><strong>Revocation</strong></td>
<td>Difficult</td>
<td>Immediate</td>
</tr>
<tr>
<td><strong>Scalability</strong></td>
<td>High</td>
<td>Medium</td>
</tr>
<tr>
<td><strong>Security</strong></td>
<td>Token-based</td>
<td>Server-side</td>
</tr>
<tr>
<td><strong>Complexity</strong></td>
<td>Medium</td>
<td>Low</td>
</tr>
<tr>
<td><strong>Mobile Support</strong></td>
<td>Excellent</td>
<td>Good</td>
</tr>
</tbody></table>
<p><strong>Interview Insight</strong>: <em>“How do you handle JWT token revocation?”</em></p>
<p><strong>Answer</strong>: Implement a token blacklist in Redis, use short-lived tokens with refresh mechanism, maintain a token version number in the database, and implement token rotation strategies.</p>
<h2 id="Security-Best-Practices"><a href="#Security-Best-Practices" class="headerlink" title="Security Best Practices"></a>Security Best Practices</h2><h3 id="Password-Security"><a href="#Password-Security" class="headerlink" title="Password Security"></a>Password Security</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PasswordSecurityService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">BCryptPasswordEncoder</span> <span class="variable">passwordEncoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>(<span class="number">12</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hashPassword</span><span class="params">(String plainPassword)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> passwordEncoder.encode(plainPassword);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">verifyPassword</span><span class="params">(String plainPassword, String hashedPassword)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> passwordEncoder.matches(plainPassword, hashedPassword);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isPasswordStrong</span><span class="params">(String password)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> password.length() &gt;= <span class="number">8</span> &amp;&amp;</span><br><span class="line">               password.matches(<span class="string">&quot;.*[A-Z].*&quot;</span>) &amp;&amp;</span><br><span class="line">               password.matches(<span class="string">&quot;.*[a-z].*&quot;</span>) &amp;&amp;</span><br><span class="line">               password.matches(<span class="string">&quot;.*[0-9].*&quot;</span>) &amp;&amp;</span><br><span class="line">               password.matches(<span class="string">&quot;.*[!@#$%^&amp;*()].*&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Rate-Limiting-Implementation"><a href="#Rate-Limiting-Implementation" class="headerlink" title="Rate Limiting Implementation"></a>Rate Limiting Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RateLimitingService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">RATE_LIMIT_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;rate_limit:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_ATTEMPTS</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">WINDOW_SECONDS</span> <span class="operator">=</span> <span class="number">300</span>; <span class="comment">// 5 minutes</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isRateLimited</span><span class="params">(String identifier)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RATE_LIMIT_PREFIX + identifier;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">attempts</span> <span class="operator">=</span> (Integer) redisTemplate.opsForValue().get(key);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (attempts == <span class="literal">null</span>) &#123;</span><br><span class="line">            redisTemplate.opsForValue().set(key, <span class="number">1</span>, WINDOW_SECONDS, TimeUnit.SECONDS);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (attempts &gt;= MAX_ATTEMPTS) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        redisTemplate.opsForValue().increment(key);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="User-Session-Lifecycle-Management"><a href="#User-Session-Lifecycle-Management" class="headerlink" title="User Session Lifecycle Management"></a>User Session Lifecycle Management</h2><h3 id="Session-Creation-Flow"><a href="#Session-Creation-Flow" class="headerlink" title="Session Creation Flow"></a>Session Creation Flow</h3><pre>
<code class="mermaid">
flowchart TD
A[User Login Request] --&gt; B{Validate Credentials}
B --&gt;|Invalid| C[Return Error]
B --&gt;|Valid| D[Load User Permissions]
D --&gt; E[Generate Session ID]
E --&gt; F[Create JWT Token]
F --&gt; G[Store Session in Redis]
G --&gt; H[Set Secure Cookie]
H --&gt; I[Return Success Response]

style A fill:#e1f5fe
style I fill:#c8e6c9
style C fill:#ffcdd2
</code>
</pre>

<h3 id="Session-Validation-Process"><a href="#Session-Validation-Process" class="headerlink" title="Session Validation Process"></a>Session Validation Process</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SessionValidator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ValidationResult <span class="title function_">validateSession</span><span class="params">(String sessionId, String requestPath)</span> &#123;</span><br><span class="line">        <span class="comment">// Step 1: Check session existence</span></span><br><span class="line">        <span class="type">UserSession</span> <span class="variable">session</span> <span class="operator">=</span> getSessionFromRedis(sessionId);</span><br><span class="line">        <span class="keyword">if</span> (session == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ValidationResult.failure(<span class="string">&quot;Session not found&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Step 2: Check session expiration</span></span><br><span class="line">        <span class="keyword">if</span> (isSessionExpired(session)) &#123;</span><br><span class="line">            cleanupSession(sessionId);</span><br><span class="line">            <span class="keyword">return</span> ValidationResult.failure(<span class="string">&quot;Session expired&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Step 3: Validate user status</span></span><br><span class="line">        <span class="keyword">if</span> (!isUserActive(session.getUser())) &#123;</span><br><span class="line">            <span class="keyword">return</span> ValidationResult.failure(<span class="string">&quot;User account disabled&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Step 4: Check resource permissions</span></span><br><span class="line">        <span class="keyword">if</span> (!hasResourcePermission(session, requestPath)) &#123;</span><br><span class="line">            <span class="keyword">return</span> ValidationResult.failure(<span class="string">&quot;Insufficient permissions&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ValidationResult.success(session);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isSessionExpired</span><span class="params">(UserSession session)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">currentTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">long</span> <span class="variable">sessionTime</span> <span class="operator">=</span> session.getLastAccessTime();</span><br><span class="line">        <span class="keyword">return</span> (currentTime - sessionTime) &gt; SESSION_TIMEOUT_MS;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Error-Handling-and-Logging"><a href="#Error-Handling-and-Logging" class="headerlink" title="Error Handling and Logging"></a>Error Handling and Logging</h2><h3 id="Comprehensive-Error-Handling"><a href="#Comprehensive-Error-Handling" class="headerlink" title="Comprehensive Error Handling"></a>Comprehensive Error Handling</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthenticationExceptionHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(AuthenticationExceptionHandler.class);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler(AuthenticationException.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;ErrorResponse&gt; <span class="title function_">handleAuthenticationException</span><span class="params">(</span></span><br><span class="line"><span class="params">            AuthenticationException e, HttpServletRequest request)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Log security event</span></span><br><span class="line">        logger.warn(<span class="string">&quot;Authentication failed for IP: &#123;&#125; - &#123;&#125;&quot;</span>, </span><br><span class="line">                   getClientIpAddress(request), e.getMessage());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.UNAUTHORIZED)</span><br><span class="line">                .body(<span class="keyword">new</span> <span class="title class_">ErrorResponse</span>(<span class="string">&quot;Authentication failed&quot;</span>, <span class="string">&quot;AUTH_001&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler(AuthorizationException.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;ErrorResponse&gt; <span class="title function_">handleAuthorizationException</span><span class="params">(</span></span><br><span class="line"><span class="params">            AuthorizationException e, HttpServletRequest request)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Log authorization event</span></span><br><span class="line">        logger.warn(<span class="string">&quot;Authorization failed for user: &#123;&#125; on resource: &#123;&#125;&quot;</span>, </span><br><span class="line">                   getCurrentUser(), request.getRequestURI());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.FORBIDDEN)</span><br><span class="line">                .body(<span class="keyword">new</span> <span class="title class_">ErrorResponse</span>(<span class="string">&quot;Access denied&quot;</span>, <span class="string">&quot;AUTH_002&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Optimization-Strategies"><a href="#Performance-Optimization-Strategies" class="headerlink" title="Performance Optimization Strategies"></a>Performance Optimization Strategies</h2><h3 id="Caching-Strategies"><a href="#Caching-Strategies" class="headerlink" title="Caching Strategies"></a>Caching Strategies</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PermissionCacheService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PERMISSION_CACHE_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;permissions:user:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CACHE_TTL</span> <span class="operator">=</span> <span class="number">600</span>; <span class="comment">// 10 minutes</span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Cacheable(value = &quot;userPermissions&quot;, key = &quot;#userId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Permission&gt; <span class="title function_">getUserPermissions</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cacheKey</span> <span class="operator">=</span> PERMISSION_CACHE_PREFIX + userId;</span><br><span class="line">        List&lt;Permission&gt; permissions = (List&lt;Permission&gt;) redisTemplate.opsForValue().get(cacheKey);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (permissions == <span class="literal">null</span>) &#123;</span><br><span class="line">            permissions = permissionService.loadUserPermissions(userId);</span><br><span class="line">            redisTemplate.opsForValue().set(cacheKey, permissions, CACHE_TTL, TimeUnit.SECONDS);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> permissions;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@CacheEvict(value = &quot;userPermissions&quot;, key = &quot;#userId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invalidateUserPermissions</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">        redisTemplate.delete(PERMISSION_CACHE_PREFIX + userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Monitoring-and-Alerting"><a href="#Monitoring-and-Alerting" class="headerlink" title="Monitoring and Alerting"></a>Monitoring and Alerting</h2><h3 id="Security-Metrics"><a href="#Security-Metrics" class="headerlink" title="Security Metrics"></a>Security Metrics</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityMetricsCollector</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter loginAttempts;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter loginFailures;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Timer authenticationTime;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SecurityMetricsCollector</span><span class="params">(MeterRegistry meterRegistry)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.meterRegistry = meterRegistry;</span><br><span class="line">        <span class="built_in">this</span>.loginAttempts = Counter.builder(<span class="string">&quot;login.attempts&quot;</span>)</span><br><span class="line">                .description(<span class="string">&quot;Total login attempts&quot;</span>)</span><br><span class="line">                .register(meterRegistry);</span><br><span class="line">        <span class="built_in">this</span>.loginFailures = Counter.builder(<span class="string">&quot;login.failures&quot;</span>)</span><br><span class="line">                .description(<span class="string">&quot;Failed login attempts&quot;</span>)</span><br><span class="line">                .register(meterRegistry);</span><br><span class="line">        <span class="built_in">this</span>.authenticationTime = Timer.builder(<span class="string">&quot;authentication.time&quot;</span>)</span><br><span class="line">                .description(<span class="string">&quot;Authentication processing time&quot;</span>)</span><br><span class="line">                .register(meterRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordLoginAttempt</span><span class="params">()</span> &#123;</span><br><span class="line">        loginAttempts.increment();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordLoginFailure</span><span class="params">(String reason)</span> &#123;</span><br><span class="line">        loginFailures.increment(Tags.of(<span class="string">&quot;reason&quot;</span>, reason));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Timer.Sample <span class="title function_">startAuthenticationTimer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Timer.start(meterRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Production-Deployment-Considerations"><a href="#Production-Deployment-Considerations" class="headerlink" title="Production Deployment Considerations"></a>Production Deployment Considerations</h2><h3 id="High-Availability-Setup"><a href="#High-Availability-Setup" class="headerlink" title="High Availability Setup"></a>High Availability Setup</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Redis Cluster Configuration</span></span><br><span class="line"><span class="attr">redis:</span></span><br><span class="line">  <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">nodes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-node1:6379</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-node2:6379</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-node3:6379</span></span><br><span class="line">    <span class="attr">max-redirects:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="string">2000ms</span></span><br><span class="line">  <span class="attr">lettuce:</span></span><br><span class="line">    <span class="attr">pool:</span></span><br><span class="line">      <span class="attr">max-active:</span> <span class="number">8</span></span><br><span class="line">      <span class="attr">max-idle:</span> <span class="number">8</span></span><br><span class="line">      <span class="attr">min-idle:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h3 id="Load-Balancer-Configuration"><a href="#Load-Balancer-Configuration" class="headerlink" title="Load Balancer Configuration"></a>Load Balancer Configuration</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> auth_backend &#123;</span><br><span class="line">    <span class="attribute">server</span> auth-service-<span class="number">1</span>:<span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">server</span> auth-service-<span class="number">2</span>:<span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">server</span> auth-service-<span class="number">3</span>:<span class="number">8080</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">server_name</span> auth.example.com;</span><br><span class="line">    </span><br><span class="line">    <span class="section">location</span> /auth &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://auth_backend;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Testing-Strategies"><a href="#Testing-Strategies" class="headerlink" title="Testing Strategies"></a>Testing Strategies</h2><h3 id="Integration-Testing"><a href="#Integration-Testing" class="headerlink" title="Integration Testing"></a>Integration Testing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@AutoConfigureTestDatabase</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserLoginServiceIntegrationTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserLoginService userLoginService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@MockBean</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldAuthenticateValidUser</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Given</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">mockUser</span> <span class="operator">=</span> createMockUser();</span><br><span class="line">        <span class="keyword">when</span>(userService.validateCredentials(<span class="string">&quot;testuser&quot;</span>, <span class="string">&quot;password&quot;</span>))</span><br><span class="line">            .thenReturn(mockUser);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When</span></span><br><span class="line">        <span class="type">LoginResult</span> <span class="variable">result</span> <span class="operator">=</span> userLoginService.authenticate(<span class="string">&quot;testuser&quot;</span>, <span class="string">&quot;password&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Then</span></span><br><span class="line">        assertThat(result.getSessionId()).isNotNull();</span><br><span class="line">        assertThat(result.getUser().getUsername()).isEqualTo(<span class="string">&quot;testuser&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldRejectInvalidCredentials</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Given</span></span><br><span class="line">        <span class="keyword">when</span>(userService.validateCredentials(<span class="string">&quot;testuser&quot;</span>, <span class="string">&quot;wrongpassword&quot;</span>))</span><br><span class="line">            .thenReturn(<span class="literal">null</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When &amp; Then</span></span><br><span class="line">        assertThatThrownBy(() -&gt; userLoginService.authenticate(<span class="string">&quot;testuser&quot;</span>, <span class="string">&quot;wrongpassword&quot;</span>))</span><br><span class="line">            .isInstanceOf(AuthenticationException.class)</span><br><span class="line">            .hasMessage(<span class="string">&quot;Invalid credentials&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Common-Interview-Questions-and-Answers"><a href="#Common-Interview-Questions-and-Answers" class="headerlink" title="Common Interview Questions and Answers"></a>Common Interview Questions and Answers</h2><p><strong>Q: How do you handle session fixation attacks?</strong></p>
<p><strong>A</strong>: Generate a new session ID after successful authentication, invalidate the old session, and ensure session IDs are cryptographically secure. Implement proper session lifecycle management.</p>
<p><strong>Q: What’s the difference between authentication and authorization?</strong></p>
<p><strong>A</strong>: Authentication verifies who you are (identity), while authorization determines what you can do (permissions). Authentication happens first, followed by authorization for each resource access.</p>
<p><strong>Q: How do you implement “Remember Me” functionality securely?</strong></p>
<p><strong>A</strong>: Use a separate persistent token stored in a secure cookie, implement token rotation, store tokens with expiration dates, and provide users with the ability to revoke all persistent sessions.</p>
<p><strong>Q: How do you handle distributed session management?</strong></p>
<p><strong>A</strong>: Use Redis cluster for session storage, implement sticky sessions with load balancers, or use JWT tokens for stateless authentication. Each approach has trade-offs in terms of complexity and scalability.</p>
<h2 id="External-Resources"><a href="#External-Resources" class="headerlink" title="External Resources"></a>External Resources</h2><ul>
<li><a target="_blank" rel="noopener" href="https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html">OWASP Authentication Cheat Sheet</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/">Spring Security Reference Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://redis.io/docs/manual/keyspace-notifications/">Redis Session Management Best Practices</a></li>
<li><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc8725">JWT Best Practices</a></li>
<li><a target="_blank" rel="noopener" href="https://pages.nist.gov/800-63-3/">NIST Digital Identity Guidelines</a></li>
</ul>
<p>This comprehensive guide provides a production-ready approach to implementing user login systems with proper authentication, authorization, and session management. The modular design allows for easy maintenance and scaling while maintaining security best practices.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/12/Design-Grey-Service-Router-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/12/Design-Grey-Service-Router-Guide/" class="post-title-link" itemprop="url">Design Grey Service Router Guide</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-12 22:04:26" itemprop="dateCreated datePublished" datetime="2025-06-12T22:04:26+08:00">2025-06-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-07-01 15:02:58" itemprop="dateModified" datetime="2025-07-01T15:02:58+08:00">2025-07-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system-design/" itemprop="url" rel="index"><span itemprop="name">system-design</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>A grey service router system enables controlled service version management across multi-tenant environments, allowing gradual rollouts, A&#x2F;B testing, and safe database schema migrations. This system provides the infrastructure to route requests to specific service versions based on tenant configuration while maintaining high availability and performance.</p>
<h3 id="Key-Benefits"><a href="#Key-Benefits" class="headerlink" title="Key Benefits"></a>Key Benefits</h3><ul>
<li><strong>Risk Mitigation</strong>: Gradual rollout reduces blast radius of potential issues</li>
<li><strong>Tenant Isolation</strong>: Each tenant can use different service versions independently</li>
<li><strong>Schema Management</strong>: Controlled database migrations per tenant</li>
<li><strong>Load Balancing</strong>: Intelligent traffic distribution across service instances</li>
</ul>
<h2 id="System-Architecture"><a href="#System-Architecture" class="headerlink" title="System Architecture"></a>System Architecture</h2><pre>
<code class="mermaid">
flowchart TB
A[Client Request] --&gt; B[GreyRouterSDK]
B --&gt; C[GreyRouterService]
C --&gt; D[Redis Cache]
C --&gt; E[TenantManagementService]
C --&gt; F[Nacos Registry]

G[GreyServiceManageUI] --&gt; C

D --&gt; H[Service Instance V1.0]
D --&gt; I[Service Instance V1.1]
D --&gt; J[Service Instance V2.0]

C --&gt; K[Database Schema Manager]
K --&gt; L[(Tenant DB 1)]
K --&gt; M[(Tenant DB 2)]
K --&gt; N[(Tenant DB 3)]

subgraph &quot;Service Versions&quot;
    H
    I
    J
end

subgraph &quot;Tenant Databases&quot;
    L
    M
    N
end
</code>
</pre>

<h2 id="Core-Components"><a href="#Core-Components" class="headerlink" title="Core Components"></a>Core Components</h2><h3 id="GreyRouterService"><a href="#GreyRouterService" class="headerlink" title="GreyRouterService"></a>GreyRouterService</h3><p>The central service that orchestrates routing decisions and manages service versions.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/grey-router&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreyRouterController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GreyRouterService greyRouterService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/route&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;ServiceInstanceInfo&gt; <span class="title function_">routeRequest</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestBody</span> RouteRequest request)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">ServiceInstanceInfo</span> <span class="variable">instance</span> <span class="operator">=</span> greyRouterService</span><br><span class="line">            .routeToServiceInstance(</span><br><span class="line">                request.getTenantId(),</span><br><span class="line">                request.getServiceName(),</span><br><span class="line">                request.getRequestMetadata()</span><br><span class="line">            );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(instance);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upgrade-schema/&#123;tenantId&#125;/&#123;serviceVersion&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;UpgradeResult&gt; <span class="title function_">upgradeSchema</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String tenantId,</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String serviceVersion)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">UpgradeResult</span> <span class="variable">result</span> <span class="operator">=</span> greyRouterService</span><br><span class="line">            .upgradeDatabaseSchema(tenantId, serviceVersion);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Data-Structures-in-Redis"><a href="#Data-Structures-in-Redis" class="headerlink" title="Data Structures in Redis"></a>Data Structures in Redis</h3><p>Carefully designed Redis data structures optimize routing performance:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisDataStructures</span> &#123;</span><br><span class="line">    <span class="comment">// Tenant to Service Version Mapping</span></span><br><span class="line">    <span class="comment">// Key: tenant:&#123;tenant_id&#125;:services</span></span><br><span class="line">    <span class="comment">// Type: Hash</span></span><br><span class="line">    <span class="comment">// Structure: &#123;service_name: version, service_name: version, ...&#125;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TENANT_SERVICE_VERSIONS</span> <span class="operator">=</span> <span class="string">&quot;tenant:%s:services&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Service Version to Instances Mapping</span></span><br><span class="line">    <span class="comment">// Key: service:&#123;service_name&#125;:version:&#123;version&#125;:instances</span></span><br><span class="line">    <span class="comment">// Type: Set</span></span><br><span class="line">    <span class="comment">// Structure: &#123;instance_id1, instance_id2, ...&#125;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SERVICE_INSTANCES</span> <span class="operator">=</span> <span class="string">&quot;service:%s:version:%s:instances&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Set: active_tenants</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ACTIVE_TENANTS</span> <span class="operator">=</span> <span class="string">&quot;active_tenants&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hash: tenant:&#123;tenantId&#125;:metadata -&gt; &#123;key: value&#125;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TENANT_METADATA</span> <span class="operator">=</span> <span class="string">&quot;tenant:%s:metadata&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Example data structure usage</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">storeTenantServiceMapping</span><span class="params">(String tenantId, </span></span><br><span class="line"><span class="params">                                        Map&lt;String, String&gt; serviceVersions)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> String.format(TENANT_SERVICE_VERSIONS, tenantId);</span><br><span class="line">        redisTemplate.opsForHash().putAll(key, serviceVersions);</span><br><span class="line">        redisTemplate.expire(key, Duration.ofHours(<span class="number">24</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Lua-Script-for-Routing-and-Load-Balancing"><a href="#Lua-Script-for-Routing-and-Load-Balancing" class="headerlink" title="Lua Script for Routing and Load Balancing"></a>Lua Script for Routing and Load Balancing</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- grey_router.lua</span></span><br><span class="line"><span class="comment">-- Args: tenantId, serviceName, loadBalanceStrategy</span></span><br><span class="line"><span class="comment">-- Returns: selected service instance details</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> tenant_id = ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">local</span> service_name = ARGV[<span class="number">2</span>]</span><br><span class="line"><span class="keyword">local</span> lb_strategy = ARGV[<span class="number">3</span>] <span class="keyword">or</span> <span class="string">&quot;round_robin&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Get tenant&#x27;s designated service version</span></span><br><span class="line"><span class="keyword">local</span> tenant_services_key = <span class="string">&quot;tenant:&quot;</span> .. tenant_id .. <span class="string">&quot;:services&quot;</span></span><br><span class="line"><span class="keyword">local</span> service_version = redis.call(<span class="string">&#x27;HGET&#x27;</span>, tenant_services_key, service_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> service_version <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> &#123;err = <span class="string">&quot;Service version not found for tenant&quot;</span>&#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Get available instances for this service version</span></span><br><span class="line"><span class="keyword">local</span> instances_key = <span class="string">&quot;service:&quot;</span> .. service_name .. <span class="string">&quot;:version:&quot;</span> .. service_version .. <span class="string">&quot;:instances&quot;</span></span><br><span class="line"><span class="keyword">local</span> instances = redis.call(<span class="string">&#x27;SMEMBERS&#x27;</span>, instances_key)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> #instances == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> &#123;err = <span class="string">&quot;No instances available&quot;</span>&#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Load balancing logic</span></span><br><span class="line"><span class="keyword">local</span> selected_instance</span><br><span class="line"><span class="keyword">if</span> lb_strategy == <span class="string">&quot;round_robin&quot;</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">local</span> counter_key = instances_key .. <span class="string">&quot;:counter&quot;</span></span><br><span class="line">    <span class="keyword">local</span> counter = redis.call(<span class="string">&#x27;INCR&#x27;</span>, counter_key)</span><br><span class="line">    <span class="keyword">local</span> index = ((counter - <span class="number">1</span>) % #instances) + <span class="number">1</span></span><br><span class="line">    selected_instance = instances[index]</span><br><span class="line"><span class="keyword">elseif</span> lb_strategy == <span class="string">&quot;random&quot;</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">local</span> index = <span class="built_in">math</span>.<span class="built_in">random</span>(<span class="number">1</span>, #instances)</span><br><span class="line">    selected_instance = instances[index]</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Update instance usage metrics</span></span><br><span class="line"><span class="keyword">local</span> usage_key = <span class="string">&quot;instance:&quot;</span> .. selected_instance .. <span class="string">&quot;:usage&quot;</span></span><br><span class="line">redis.call(<span class="string">&#x27;INCR&#x27;</span>, usage_key)</span><br><span class="line">redis.call(<span class="string">&#x27;EXPIRE&#x27;</span>, usage_key, <span class="number">300</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">    instance = selected_instance,</span><br><span class="line">    version = service_version,</span><br><span class="line">    timestamp = redis.call(<span class="string">&#x27;TIME&#x27;</span>)[<span class="number">1</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="GreyRouterSDK-Client"><a href="#GreyRouterSDK-Client" class="headerlink" title="GreyRouterSDK Client"></a>GreyRouterSDK Client</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreyRouterSDK</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RestTemplate restTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String greyRouterServiceUrl;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">executeWithRouting</span><span class="params">(String tenantId, String serviceName, </span></span><br><span class="line"><span class="params">                                  ServiceCall&lt;T&gt; serviceCall)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Get routing information</span></span><br><span class="line">        <span class="type">ServiceInstanceInfo</span> <span class="variable">instance</span> <span class="operator">=</span> getServiceInstance(tenantId, serviceName);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Execute with circuit breaker and retry</span></span><br><span class="line">        <span class="keyword">return</span> executeWithResilience(instance, serviceCall);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> ServiceInstanceInfo <span class="title function_">getServiceInstance</span><span class="params">(String tenantId, String serviceName)</span> &#123;</span><br><span class="line">        <span class="comment">// First try Redis cache</span></span><br><span class="line">        <span class="type">ServiceInstanceInfo</span> <span class="variable">cached</span> <span class="operator">=</span> getCachedInstance(tenantId, serviceName);</span><br><span class="line">        <span class="keyword">if</span> (cached != <span class="literal">null</span> &amp;&amp; isInstanceHealthy(cached)) &#123;</span><br><span class="line">            <span class="keyword">return</span> cached;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Fallback to router service</span></span><br><span class="line">        <span class="type">RouteRequest</span> <span class="variable">request</span> <span class="operator">=</span> RouteRequest.builder()</span><br><span class="line">            .tenantId(tenantId)</span><br><span class="line">            .serviceName(serviceName)</span><br><span class="line">            .build();</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> restTemplate.postForObject(</span><br><span class="line">            greyRouterServiceUrl + <span class="string">&quot;/route&quot;</span>, </span><br><span class="line">            request, </span><br><span class="line">            ServiceInstanceInfo.class</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Retryable(value = &#123;Exception.class&#125;, maxAttempts = 3)</span></span><br><span class="line">    <span class="keyword">private</span> &lt;T&gt; T <span class="title function_">executeWithResilience</span><span class="params">(ServiceInstanceInfo instance, </span></span><br><span class="line"><span class="params">                                      ServiceCall&lt;T&gt; serviceCall)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> serviceCall.execute(instance);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// Mark instance as unhealthy temporarily</span></span><br><span class="line">            markInstanceUnhealthy(instance);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="API-Gateway-Integration"><a href="#API-Gateway-Integration" class="headerlink" title="API Gateway Integration"></a>API Gateway Integration</h3><p>The routing logic integrates with API gateways to intercept requests and apply tenant-specific routing:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreyRouteFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> extractTenantId(exchange.getRequest());</span><br><span class="line">        <span class="type">String</span> <span class="variable">serviceName</span> <span class="operator">=</span> extractServiceName(exchange.getRequest());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (tenantId != <span class="literal">null</span> &amp;&amp; serviceName != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> routeToSpecificVersion(exchange, chain, tenantId, serviceName);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Mono&lt;Void&gt; <span class="title function_">routeToSpecificVersion</span><span class="params">(ServerWebExchange exchange, </span></span><br><span class="line"><span class="params">                                             GatewayFilterChain chain,</span></span><br><span class="line"><span class="params">                                             String tenantId, </span></span><br><span class="line"><span class="params">                                             String serviceName)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Execute Lua script for atomic routing decision</span></span><br><span class="line">        DefaultRedisScript&lt;Map&gt; script = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;();</span><br><span class="line">        script.setScriptText(loadLuaScript(<span class="string">&quot;route_and_balance.lua&quot;</span>));</span><br><span class="line">        script.setResultType(Map.class);</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, Object&gt; result = redisTemplate.execute(script, </span><br><span class="line">            Collections.emptyList(), tenantId, serviceName);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (result.containsKey(<span class="string">&quot;err&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> handleRoutingError(exchange, (String) result.get(<span class="string">&quot;err&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">targetInstance</span> <span class="operator">=</span> (String) result.get(<span class="string">&quot;instance&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">version</span> <span class="operator">=</span> (String) result.get(<span class="string">&quot;version&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Modify request to target specific instance</span></span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">modifiedRequest</span> <span class="operator">=</span> exchange.getRequest().mutate()</span><br><span class="line">            .header(<span class="string">&quot;X-Target-Instance&quot;</span>, targetInstance)</span><br><span class="line">            .header(<span class="string">&quot;X-Service-Version&quot;</span>, version)</span><br><span class="line">            .build();</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange.mutate().request(modifiedRequest).build());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">100</span>; <span class="comment">// Execute before other filters</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Database-Schema-Management"><a href="#Database-Schema-Management" class="headerlink" title="Database Schema Management"></a>Database Schema Management</h2><h3 id="Schema-Version-Control"><a href="#Schema-Version-Control" class="headerlink" title="Schema Version Control"></a>Schema Version Control</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseSchemaManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSourceManager dataSourceManager;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> UpgradeResult <span class="title function_">upgradeTenantSchema</span><span class="params">(String tenantId, </span></span><br><span class="line"><span class="params">                                           String serviceVersion)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">tenantDataSource</span> <span class="operator">=</span> dataSourceManager</span><br><span class="line">            .getTenantDataSource(tenantId);</span><br><span class="line">            </span><br><span class="line">        List&lt;SchemaMigration&gt; migrations = getSchemaMigrations(serviceVersion);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> executeTransactionalMigration(tenantDataSource, migrations);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">private</span> UpgradeResult <span class="title function_">executeTransactionalMigration</span><span class="params">(</span></span><br><span class="line"><span class="params">            DataSource dataSource, </span></span><br><span class="line"><span class="params">            List&lt;SchemaMigration&gt; migrations)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">UpgradeResult</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UpgradeResult</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (SchemaMigration migration : migrations) &#123;</span><br><span class="line">                executeMigration(dataSource, migration);</span><br><span class="line">                updateSchemaVersion(dataSource, migration.getVersion());</span><br><span class="line">            &#125;</span><br><span class="line">            result.setSuccess(<span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            result.setSuccess(<span class="literal">false</span>);</span><br><span class="line">            result.setErrorMessage(e.getMessage());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SchemaUpgradeException</span>(<span class="string">&quot;Migration failed&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">executeMigration</span><span class="params">(DataSource dataSource, </span></span><br><span class="line"><span class="params">                                SchemaMigration migration)</span> &#123;</span><br><span class="line">        <span class="type">JdbcTemplate</span> <span class="variable">jdbcTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcTemplate</span>(dataSource);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Validate migration before execution</span></span><br><span class="line">        validateMigration(migration);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Execute with timeout</span></span><br><span class="line">        jdbcTemplate.update(migration.getSql());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Log migration execution</span></span><br><span class="line">        logMigrationExecution(migration);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Migration-Example"><a href="#Migration-Example" class="headerlink" title="Migration Example"></a>Migration Example</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- V1.1__add_user_preferences.sql</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> users <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> preferences JSON;</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_users_preferences <span class="keyword">ON</span> users <span class="keyword">USING</span> GIN (preferences);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- V1.2__update_order_status.sql  </span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> orders <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> status_updated_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> orders <span class="keyword">SET</span> status_updated_at <span class="operator">=</span> created_at <span class="keyword">WHERE</span> status_updated_at <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure>

<h2 id="Management-UI-Implementation"><a href="#Management-UI-Implementation" class="headerlink" title="Management UI Implementation"></a>Management UI Implementation</h2><h3 id="Frontend-Service-Assignment"><a href="#Frontend-Service-Assignment" class="headerlink" title="Frontend Service Assignment"></a>Frontend Service Assignment</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TenantServiceManagement.jsx</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; useState, useEffect &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">TenantServiceManagement</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> [tenants, setTenants] = <span class="title function_">useState</span>([]);</span><br><span class="line">    <span class="keyword">const</span> [selectedTenant, setSelectedTenant] = <span class="title function_">useState</span>(<span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">const</span> [services, setServices] = <span class="title function_">useState</span>([]);</span><br><span class="line">    <span class="keyword">const</span> [pendingUpgrades, setPendingUpgrades] = <span class="title function_">useState</span>(&#123;&#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">loadTenantServices</span> = <span class="keyword">async</span> (<span class="params">tenantId</span>) =&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">`/api/tenants/<span class="subst">$&#123;tenantId&#125;</span>/services`</span>);</span><br><span class="line">            <span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">            <span class="title function_">setServices</span>(data);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Failed to load tenant services:&#x27;</span>, error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleVersionChange</span> = (<span class="params">serviceId, newVersion</span>) =&gt; &#123;</span><br><span class="line">        <span class="title function_">setPendingUpgrades</span>(<span class="function"><span class="params">prev</span> =&gt;</span> (&#123;</span><br><span class="line">            ...prev,</span><br><span class="line">            [serviceId]: newVersion</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">applyUpgrades</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> [serviceId, version] <span class="keyword">of</span> <span class="title class_">Object</span>.<span class="title function_">entries</span>(pendingUpgrades)) &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">updateServiceVersion</span>(selectedTenant.<span class="property">id</span>, serviceId, version);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">setPendingUpgrades</span>(&#123;&#125;);</span><br><span class="line">        <span class="title function_">loadTenantServices</span>(selectedTenant.<span class="property">id</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;tenant-service-management&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">TenantSelector</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">tenants</span>=<span class="string">&#123;tenants&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">onSelect</span>=<span class="string">&#123;setSelectedTenant&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            /&gt;</span></span></span><br><span class="line"><span class="language-xml">            </span></span><br><span class="line"><span class="language-xml">            &#123;selectedTenant &amp;&amp; (</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">ServiceVersionTable</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">services</span>=<span class="string">&#123;services&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">pendingUpgrades</span>=<span class="string">&#123;pendingUpgrades&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">onVersionChange</span>=<span class="string">&#123;handleVersionChange&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml">            )&#125;</span></span><br><span class="line"><span class="language-xml">            </span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;applyUpgrades&#125;</span> <span class="attr">disabled</span>=<span class="string">&#123;!Object.keys(pendingUpgrades).length&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                Apply Upgrades</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="Backend-API-for-Management"><a href="#Backend-API-for-Management" class="headerlink" title="Backend API for Management"></a>Backend API for Management</h3><pre>
<code class="mermaid">
sequenceDiagram
participant Admin as Administrator
participant UI as ManageUI
participant Router as GreyRouterService
participant Redis as Redis Cache
participant DB as Tenant Database

Admin-&gt;&gt;UI: Select tenant &quot;acme-corp&quot;
UI-&gt;&gt;Router: GET &#x2F;api&#x2F;tenants&#x2F;acme-corp&#x2F;services
Router-&gt;&gt;Redis: HGETALL tenant:acme-corp:services
Redis--&gt;&gt;Router: {user-service: &quot;v1.0&quot;, order-service: &quot;v1.2&quot;}
Router--&gt;&gt;UI: Service version mapping
UI--&gt;&gt;Admin: Display service version table

Admin-&gt;&gt;UI: Update user-service to v2.0
UI-&gt;&gt;Router: PUT &#x2F;api&#x2F;tenants&#x2F;acme-corp&#x2F;services&#x2F;user-service
Router-&gt;&gt;Redis: HSET tenant:acme-corp:services user-service &quot;v2.0&quot;

Admin-&gt;&gt;UI: Trigger schema upgrade
UI-&gt;&gt;Router: POST &#x2F;api&#x2F;tenants&#x2F;acme-corp&#x2F;schema-upgrade
Router-&gt;&gt;DB: Execute migration scripts
DB--&gt;&gt;Router: Migration completed
Router-&gt;&gt;Redis: HSET tenant:acme-corp:db_schema user-service &quot;20240320001&quot;
Router--&gt;&gt;UI: Upgrade successful
</code>
</pre>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/tenants&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantManagementController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;tenantId&#125;/services&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;List&lt;ServiceInfo&gt;&gt; <span class="title function_">getTenantServices</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String tenantId)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        List&lt;ServiceInfo&gt; services = tenantService.getTenantServices(tenantId);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(services);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PutMapping(&quot;/&#123;tenantId&#125;/services/&#123;serviceId&#125;/version&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;UpdateResult&gt; <span class="title function_">updateServiceVersion</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String tenantId,</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String serviceId,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestBody</span> VersionUpdateRequest request)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Validate version compatibility</span></span><br><span class="line">        <span class="type">ValidationResult</span> <span class="variable">validation</span> <span class="operator">=</span> versionCompatibilityService</span><br><span class="line">            .validateUpgrade(serviceId, request.getCurrentVersion(), </span><br><span class="line">                           request.getTargetVersion());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!validation.isValid()) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.badRequest()</span><br><span class="line">                .body(UpdateResult.failure(validation.getErrors()));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Update routing configuration</span></span><br><span class="line">        <span class="type">UpdateResult</span> <span class="variable">result</span> <span class="operator">=</span> greyRouterService.updateTenantServiceVersion(</span><br><span class="line">            tenantId, serviceId, request.getTargetVersion());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(result);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/&#123;tenantId&#125;/schema-upgrade&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;UpgradeResult&gt; <span class="title function_">triggerSchemaUpgrade</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String tenantId,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestBody</span> SchemaUpgradeRequest request)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Async schema upgrade with progress tracking</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">upgradeId</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        </span><br><span class="line">        CompletableFuture.supplyAsync(() -&gt; </span><br><span class="line">            databaseSchemaManager.upgradeTenantSchema(tenantId, request.getVersion())</span><br><span class="line">        ).whenComplete((result, throwable) -&gt; &#123;</span><br><span class="line">            notificationService.notifyUpgradeComplete(tenantId, upgradeId, result);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.accepted()</span><br><span class="line">            .body(UpgradeResult.inProgress(upgradeId));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Integration-with-External-Systems"><a href="#Integration-with-External-Systems" class="headerlink" title="Integration with External Systems"></a>Integration with External Systems</h2><h3 id="Nacos-Integration"><a href="#Nacos-Integration" class="headerlink" title="Nacos Integration"></a>Nacos Integration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NacosServiceDiscovery</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> NamingService namingService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedDelay = 30000)</span> <span class="comment">// 30 seconds</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refreshServiceInstances</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;String&gt; services = namingService.getServicesOfServer(<span class="number">1</span>, <span class="number">1000</span>).getData();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (String serviceName : services) &#123;</span><br><span class="line">                List&lt;Instance&gt; instances = namingService.getAllInstances(serviceName);</span><br><span class="line">                updateRedisServiceInstances(serviceName, instances);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Failed to refresh service instances from Nacos&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateRedisServiceInstances</span><span class="params">(String serviceName, </span></span><br><span class="line"><span class="params">                                           List&lt;Instance&gt; instances)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, List&lt;String&gt;&gt; versionInstances = instances.stream()</span><br><span class="line">            .filter(Instance::isEnabled)</span><br><span class="line">            .collect(Collectors.groupingBy(</span><br><span class="line">                instance -&gt; instance.getMetadata().getOrDefault(<span class="string">&quot;version&quot;</span>, <span class="string">&quot;1.0&quot;</span>),</span><br><span class="line">                Collectors.mapping(instance -&gt; </span><br><span class="line">                    instance.getIp() + <span class="string">&quot;:&quot;</span> + instance.getPort(),</span><br><span class="line">                    Collectors.toList())</span><br><span class="line">            ));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Update Redis atomically</span></span><br><span class="line">        redisTemplate.execute((RedisCallback&lt;Void&gt;) connection -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, List&lt;String&gt;&gt; entry : versionInstances.entrySet()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> String.format(<span class="string">&quot;service:%s:version:%s:instances&quot;</span>, </span><br><span class="line">                                         serviceName, entry.getKey());</span><br><span class="line">                connection.del(key.getBytes());</span><br><span class="line">                <span class="keyword">for</span> (String instance : entry.getValue()) &#123;</span><br><span class="line">                    connection.sAdd(key.getBytes(), instance.getBytes());</span><br><span class="line">                &#125;</span><br><span class="line">                connection.expire(key.getBytes(), <span class="number">300</span>); <span class="comment">// 5 minutes TTL</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="TenantManagementService-Integration"><a href="#TenantManagementService-Integration" class="headerlink" title="TenantManagementService Integration"></a>TenantManagementService Integration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantSyncService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;tenant.management.api.url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String tenantManagementUrl;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0 */10 * * * *&quot;)</span> <span class="comment">// Every 10 minutes</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">syncTenants</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">            ResponseEntity&lt;TenantListResponse&gt; response = restTemplate.getForEntity(</span><br><span class="line">                tenantManagementUrl + <span class="string">&quot;/api/tenants&quot;</span>, </span><br><span class="line">                TenantListResponse.class</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (response.getStatusCode().is2xxSuccessful()) &#123;</span><br><span class="line">                updateTenantCache(response.getBody().getTenants());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Failed to sync tenants from tenant management service&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateTenantCache</span><span class="params">(List&lt;Tenant&gt; tenants)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantsKey</span> <span class="operator">=</span> <span class="string">&quot;system:tenants&quot;</span>;</span><br><span class="line">        redisTemplate.delete(tenantsKey);</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, String&gt; tenantMap = tenants.stream()</span><br><span class="line">            .collect(toMap(Tenant::getId, Tenant::getName));</span><br><span class="line">            </span><br><span class="line">        redisTemplate.opsForHash().putAll(tenantsKey, tenantMap);</span><br><span class="line">        redisTemplate.expire(tenantsKey, Duration.ofHours(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Use-Cases-and-Examples"><a href="#Use-Cases-and-Examples" class="headerlink" title="Use Cases and Examples"></a>Use Cases and Examples</h2><h3 id="Use-Case-1-Gradual-Service-Rollout"><a href="#Use-Case-1-Gradual-Service-Rollout" class="headerlink" title="Use Case 1: Gradual Service Rollout"></a>Use Case 1: Gradual Service Rollout</h3><p><strong>Scenario</strong>: Rolling out a new payment service version (v2.1) to 10% of tenants initially.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Step 1: Deploy new service version to Nacos</span></span><br><span class="line"><span class="comment">// Step 2: Configure gradual rollout</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GradualRolloutService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initiateGradualRollout</span><span class="params">(String serviceId, String newVersion, </span></span><br><span class="line"><span class="params">                                     <span class="type">double</span> rolloutPercentage)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        List&lt;String&gt; allTenants = tenantService.getAllActiveTenants();</span><br><span class="line">        <span class="type">int</span> <span class="variable">rolloutCount</span> <span class="operator">=</span> (<span class="type">int</span>) (allTenants.size() * rolloutPercentage);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Select tenants for rollout (e.g., based on risk profile)</span></span><br><span class="line">        List&lt;String&gt; rolloutTenants = selectTenantsForRollout(allTenants, rolloutCount);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String tenantId : rolloutTenants) &#123;</span><br><span class="line">            updateTenantServiceVersion(tenantId, serviceId, newVersion);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Monitor rollout metrics</span></span><br><span class="line">        scheduleRolloutMonitoring(serviceId, newVersion, rolloutTenants);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Use-Case-2-A-B-Testing"><a href="#Use-Case-2-A-B-Testing" class="headerlink" title="Use Case 2: A&#x2F;B Testing"></a>Use Case 2: A&#x2F;B Testing</h3><p><strong>Scenario</strong>: Testing two different recommendation algorithms.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ABTestingRouter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ServiceInstanceInfo <span class="title function_">routeForABTest</span><span class="params">(String tenantId, String serviceName, </span></span><br><span class="line"><span class="params">                                            String experimentId)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Get tenant&#x27;s experiment assignment</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">variant</span> <span class="operator">=</span> getExperimentVariant(tenantId, experimentId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Route to appropriate service version</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">targetVersion</span> <span class="operator">=</span> getVersionForVariant(serviceName, variant);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> routeToSpecificVersion(tenantId, serviceName, targetVersion);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getExperimentVariant</span><span class="params">(String tenantId, String experimentId)</span> &#123;</span><br><span class="line">        <span class="comment">// Consistent hashing for stable assignment</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">hash</span> <span class="operator">=</span> DigestUtils.md5Hex(tenantId + experimentId);</span><br><span class="line">        <span class="type">int</span> <span class="variable">hashValue</span> <span class="operator">=</span> Math.abs(hash.hashCode());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> (hashValue % <span class="number">2</span> == <span class="number">0</span>) ? <span class="string">&quot;A&quot;</span> : <span class="string">&quot;B&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Use-Case-3-Emergency-Rollback"><a href="#Use-Case-3-Emergency-Rollback" class="headerlink" title="Use Case 3: Emergency Rollback"></a>Use Case 3: Emergency Rollback</h3><p><strong>Scenario</strong>: Critical bug discovered in production, immediate rollback needed.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/emergency&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmergencyController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/rollback&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;RollbackResult&gt; <span class="title function_">emergencyRollback</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestBody</span> EmergencyRollbackRequest request)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Validate rollback permissions</span></span><br><span class="line">        <span class="keyword">if</span> (!hasEmergencyRollbackPermission(request.getOperatorId())) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.status(HttpStatus.FORBIDDEN).build();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Execute immediate rollback</span></span><br><span class="line">        <span class="type">RollbackResult</span> <span class="variable">result</span> <span class="operator">=</span> executeEmergencyRollback(</span><br><span class="line">            request.getServiceId(),</span><br><span class="line">            request.getFromVersion(),</span><br><span class="line">            request.getToVersion(),</span><br><span class="line">            request.getAffectedTenants()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Notify stakeholders</span></span><br><span class="line">        notificationService.notifyEmergencyRollback(request, result);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(result);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> RollbackResult <span class="title function_">executeEmergencyRollback</span><span class="params">(String serviceId, </span></span><br><span class="line"><span class="params">                                                   String fromVersion,</span></span><br><span class="line"><span class="params">                                                   String toVersion, </span></span><br><span class="line"><span class="params">                                                   List&lt;String&gt; tenants)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> redisTemplate.execute(<span class="keyword">new</span> <span class="title class_">SessionCallback</span>&lt;RollbackResult&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> RollbackResult <span class="title function_">execute</span><span class="params">(RedisOperations operations)</span> </span><br><span class="line">                    <span class="keyword">throws</span> DataAccessException &#123;</span><br><span class="line">                </span><br><span class="line">                operations.multi();</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">for</span> (String tenantId : tenants) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> String.format(<span class="string">&quot;tenant:%s:services&quot;</span>, tenantId);</span><br><span class="line">                    operations.opsForHash().put(key, serviceId, toVersion);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                List&lt;Object&gt; results = operations.exec();</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> RollbackResult.builder()</span><br><span class="line">                    .success(<span class="literal">true</span>)</span><br><span class="line">                    .rollbackCount(results.size())</span><br><span class="line">                    .timestamp(Instant.now())</span><br><span class="line">                    .build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Monitoring-and-Observability"><a href="#Monitoring-and-Observability" class="headerlink" title="Monitoring and Observability"></a>Monitoring and Observability</h2><h3 id="Metrics-Collection"><a href="#Metrics-Collection" class="headerlink" title="Metrics Collection"></a>Metrics Collection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreyRouterMetrics</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter routingRequestsCounter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Timer routingLatencyTimer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Gauge activeTenantsGauge;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GreyRouterMetrics</span><span class="params">(MeterRegistry meterRegistry)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.meterRegistry = meterRegistry;</span><br><span class="line">        <span class="built_in">this</span>.routingRequestsCounter = Counter.builder(<span class="string">&quot;grey_router_requests_total&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Total routing requests&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;service&quot;</span>, <span class="string">&quot;grey-router&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.routingLatencyTimer = Timer.builder(<span class="string">&quot;grey_router_latency&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Routing decision latency&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.activeTenantsGauge = Gauge.builder(<span class="string">&quot;grey_router_active_tenants&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Number of active tenants&quot;</span>)</span><br><span class="line">            .register(meterRegistry, <span class="built_in">this</span>, GreyRouterMetrics::getActiveTenantCount);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordRoutingRequest</span><span class="params">(String tenantId, String serviceName, </span></span><br><span class="line"><span class="params">                                   String version, <span class="type">boolean</span> success)</span> &#123;</span><br><span class="line">        routingRequestsCounter.increment(</span><br><span class="line">            Tags.of(</span><br><span class="line">                Tag.of(<span class="string">&quot;tenant&quot;</span>, tenantId),</span><br><span class="line">                Tag.of(<span class="string">&quot;service&quot;</span>, serviceName),</span><br><span class="line">                Tag.of(<span class="string">&quot;version&quot;</span>, version),</span><br><span class="line">                Tag.of(<span class="string">&quot;status&quot;</span>, success ? <span class="string">&quot;success&quot;</span> : <span class="string">&quot;failure&quot;</span>)</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Health-Checks"><a href="#Health-Checks" class="headerlink" title="Health Checks"></a>Health Checks</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreyRouterHealthIndicator</span> <span class="keyword">implements</span> <span class="title class_">HealthIndicator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Health <span class="title function_">health</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Check Redis connectivity</span></span><br><span class="line">            redisTemplate.opsForValue().get(<span class="string">&quot;health_check&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Check service registry connectivity</span></span><br><span class="line">            nacosServiceDiscovery.checkConnectivity();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Check database connectivity</span></span><br><span class="line">            databaseHealthChecker.checkAllTenantDatabases();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> Health.up()</span><br><span class="line">                .withDetail(<span class="string">&quot;redis&quot;</span>, <span class="string">&quot;UP&quot;</span>)</span><br><span class="line">                .withDetail(<span class="string">&quot;nacos&quot;</span>, <span class="string">&quot;UP&quot;</span>)</span><br><span class="line">                .withDetail(<span class="string">&quot;databases&quot;</span>, <span class="string">&quot;UP&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> Health.down()</span><br><span class="line">                .withException(e)</span><br><span class="line">                .build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Optimization"><a href="#Performance-Optimization" class="headerlink" title="Performance Optimization"></a>Performance Optimization</h2><h3 id="Caching-Strategy"><a href="#Caching-Strategy" class="headerlink" title="Caching Strategy"></a>Caching Strategy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CachingStrategy</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// L1 Cache: Local application cache</span></span><br><span class="line">    <span class="meta">@Cacheable(value = &quot;tenantServices&quot;, key = &quot;#tenantId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">getTenantServices</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash()</span><br><span class="line">            .entries(String.format(<span class="string">&quot;tenant:%s:services&quot;</span>, tenantId));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// L2 Cache: Redis distributed cache</span></span><br><span class="line">    <span class="keyword">public</span> ServiceInstanceInfo <span class="title function_">getCachedServiceInstance</span><span class="params">(String tenantId, </span></span><br><span class="line"><span class="params">                                                      String serviceName)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cacheKey</span> <span class="operator">=</span> String.format(<span class="string">&quot;routing:%s:%s&quot;</span>, tenantId, serviceName);</span><br><span class="line">        <span class="keyword">return</span> (ServiceInstanceInfo) redisTemplate.opsForValue().get(cacheKey);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Cache warming strategy</span></span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">warmCache</span><span class="params">(ServiceVersionUpdatedEvent event)</span> &#123;</span><br><span class="line">        CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            List&lt;String&gt; affectedTenants = getTenantsUsingService(event.getServiceId());</span><br><span class="line">            <span class="keyword">for</span> (String tenantId : affectedTenants) &#123;</span><br><span class="line">                preloadTenantRouting(tenantId, event.getServiceId());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Connection-Pooling"><a href="#Connection-Pooling" class="headerlink" title="Connection Pooling"></a>Connection Pooling</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LettuceConnectionFactory <span class="title function_">redisConnectionFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">LettuceClientConfiguration</span> <span class="variable">clientConfig</span> <span class="operator">=</span> LettuceClientConfiguration.builder()</span><br><span class="line">            .poolConfig(connectionPoolConfig())</span><br><span class="line">            .commandTimeout(Duration.ofSeconds(<span class="number">2</span>))</span><br><span class="line">            .shutdownTimeout(Duration.ofSeconds(<span class="number">5</span>))</span><br><span class="line">            .build();</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LettuceConnectionFactory</span>(redisStandaloneConfiguration(), clientConfig);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> GenericObjectPoolConfig&lt;?&gt; connectionPoolConfig() &#123;</span><br><span class="line">        GenericObjectPoolConfig&lt;?&gt; poolConfig = <span class="keyword">new</span> <span class="title class_">GenericObjectPoolConfig</span>&lt;&gt;();</span><br><span class="line">        poolConfig.setMaxTotal(<span class="number">50</span>);</span><br><span class="line">        poolConfig.setMaxIdle(<span class="number">20</span>);</span><br><span class="line">        poolConfig.setMinIdle(<span class="number">10</span>);</span><br><span class="line">        poolConfig.setMaxWaitMillis(<span class="number">2000</span>);</span><br><span class="line">        poolConfig.setTestOnBorrow(<span class="literal">true</span>);</span><br><span class="line">        poolConfig.setTestOnReturn(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> poolConfig;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Security-Considerations"><a href="#Security-Considerations" class="headerlink" title="Security Considerations"></a>Security Considerations</h2><h3 id="Authentication-and-Authorization"><a href="#Authentication-and-Authorization" class="headerlink" title="Authentication and Authorization"></a>Authentication and Authorization</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@PreAuthorize(&quot;hasRole(&#x27;GREY_ROUTER_ADMIN&#x27;)&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecureGreyRouterController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/tenants/&#123;tenantId&#125;/services/&#123;serviceId&#125;/upgrade&quot;)</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasPermission(#tenantId, &#x27;TENANT&#x27;, &#x27;MANAGE_SERVICES&#x27;)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;UpgradeResult&gt; <span class="title function_">upgradeService</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String tenantId,</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String serviceId,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestBody</span> ServiceUpgradeRequest request,</span></span><br><span class="line"><span class="params">            Authentication authentication)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Audit log the operation</span></span><br><span class="line">        auditService.logServiceUpgrade(</span><br><span class="line">            authentication.getName(),</span><br><span class="line">            tenantId,</span><br><span class="line">            serviceId,</span><br><span class="line">            request.getTargetVersion()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(greyRouterService.upgradeService(request));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Data-Encryption"><a href="#Data-Encryption" class="headerlink" title="Data Encryption"></a>Data Encryption</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EncryptionService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AESUtil aesUtil;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">storeSensitiveRouteData</span><span class="params">(String tenantId, RouteConfiguration config)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">encryptedConfig</span> <span class="operator">=</span> aesUtil.encrypt(</span><br><span class="line">            JsonUtils.toJson(config),</span><br><span class="line">            getTenantEncryptionKey(tenantId)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        redisTemplate.opsForValue().set(</span><br><span class="line">            <span class="string">&quot;encrypted:tenant:&quot;</span> + tenantId + <span class="string">&quot;:config&quot;</span>,</span><br><span class="line">            encryptedConfig,</span><br><span class="line">            Duration.ofHours(<span class="number">24</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Interview-Questions-and-Insights"><a href="#Interview-Questions-and-Insights" class="headerlink" title="Interview Questions and Insights"></a>Interview Questions and Insights</h2><h3 id="Technical-Architecture-Questions"><a href="#Technical-Architecture-Questions" class="headerlink" title="Technical Architecture Questions"></a>Technical Architecture Questions</h3><p><strong>Q: How do you ensure consistent routing decisions across multiple Grey Router Service instances?</strong></p>
<p><strong>A</strong>: Consistency is achieved through:</p>
<ul>
<li><strong>Centralized State</strong>: All routing decisions are based on data stored in Redis, ensuring all instances see the same state</li>
<li><strong>Lua Scripts</strong>: Atomic operations in Redis prevent race conditions during routing and load balancing</li>
<li><strong>Cache Synchronization</strong>: Event-driven cache invalidation ensures consistency across local caches</li>
<li><strong>Versioned Configuration</strong>: Each routing rule has a version number to handle concurrent updates</li>
</ul>
<p><strong>Q: How would you handle the scenario where a tenant’s database schema upgrade fails halfway through?</strong></p>
<p><strong>A</strong>: Robust failure handling includes:</p>
<ul>
<li><strong>Transactional Migrations</strong>: Each schema upgrade runs in a database transaction</li>
<li><strong>Rollback Scripts</strong>: Every migration has a corresponding rollback script</li>
<li><strong>State Tracking</strong>: Migration state is tracked in a dedicated schema_version table</li>
<li><strong>Compensation Actions</strong>: Failed upgrades trigger automatic rollback and notification</li>
<li><strong>Isolation</strong>: Failed upgrades for one tenant don’t affect others</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> UpgradeResult <span class="title function_">executeSchemaUpgrade</span><span class="params">(String tenantId, String version)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        beginUpgrade(tenantId, version);</span><br><span class="line">        executeMigrations(tenantId, version);</span><br><span class="line">        commitUpgrade(tenantId, version);</span><br><span class="line">        <span class="keyword">return</span> UpgradeResult.success();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        rollbackUpgrade(tenantId, version);</span><br><span class="line">        notifyUpgradeFailure(tenantId, version, e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SchemaUpgradeException</span>(<span class="string">&quot;Upgrade failed for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Performance-and-Scalability-Questions"><a href="#Performance-and-Scalability-Questions" class="headerlink" title="Performance and Scalability Questions"></a>Performance and Scalability Questions</h3><p><strong>Q: How do you optimize the performance of routing decisions when handling thousands of requests per second?</strong></p>
<p><strong>A</strong>: Performance optimization strategies:</p>
<ul>
<li><strong>Redis Lua Scripts</strong>: Atomic routing decisions with minimal network round trips</li>
<li><strong>Connection Pooling</strong>: Optimized Redis connection management</li>
<li><strong>Local Caching</strong>: L1 cache for frequently accessed routing rules</li>
<li><strong>Async Processing</strong>: Non-blocking I&#x2F;O for external service calls</li>
<li><strong>Circuit Breakers</strong>: Prevent cascade failures and improve response times</li>
</ul>
<p><strong>Q: How would you scale this system to handle 10,000+ tenants?</strong></p>
<p><strong>A</strong>: Scaling strategies:</p>
<ul>
<li><strong>Horizontal Scaling</strong>: Multiple Grey Router Service instances behind a load balancer</li>
<li><strong>Redis Clustering</strong>: Distributed Redis setup for higher throughput</li>
<li><strong>Partitioning</strong>: Tenant data partitioned across multiple Redis clusters</li>
<li><strong>Caching Layers</strong>: Multi-level caching to reduce database load</li>
<li><strong>Async Operations</strong>: Background processing for non-critical operations</li>
</ul>
<h3 id="Operational-Excellence-Questions"><a href="#Operational-Excellence-Questions" class="headerlink" title="Operational Excellence Questions"></a>Operational Excellence Questions</h3><p><strong>Q: How do you monitor and troubleshoot routing issues in production?</strong></p>
<p><strong>A</strong>: Comprehensive monitoring approach:</p>
<ul>
<li><strong>Metrics</strong>: Request success rates, latency percentiles, error rates by tenant&#x2F;service</li>
<li><strong>Distributed Tracing</strong>: End-to-end request tracing across service boundaries</li>
<li><strong>Alerting</strong>: Threshold-based alerts for SLA violations</li>
<li><strong>Dashboards</strong>: Real-time visualization of system health and performance</li>
<li><strong>Log Aggregation</strong>: Centralized logging with correlation IDs</li>
</ul>
<h2 id="Best-Practices-and-Recommendations"><a href="#Best-Practices-and-Recommendations" class="headerlink" title="Best Practices and Recommendations"></a>Best Practices and Recommendations</h2><h3 id="Configuration-Management"><a href="#Configuration-Management" class="headerlink" title="Configuration Management"></a>Configuration Management</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.yml</span></span><br><span class="line"><span class="attr">grey-router:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">cluster:</span></span><br><span class="line">      <span class="attr">nodes:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">redis-node1:6379</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">redis-node2:6379</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">redis-node3:6379</span></span><br><span class="line">    <span class="attr">pool:</span></span><br><span class="line">      <span class="attr">max-active:</span> <span class="number">50</span></span><br><span class="line">      <span class="attr">max-idle:</span> <span class="number">20</span></span><br><span class="line">      <span class="attr">min-idle:</span> <span class="number">10</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">routing:</span></span><br><span class="line">    <span class="attr">cache-ttl:</span> <span class="string">300s</span></span><br><span class="line">    <span class="attr">circuit-breaker:</span></span><br><span class="line">      <span class="attr">failure-threshold:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">recovery-time:</span> <span class="string">30s</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">schema-upgrade:</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">300s</span></span><br><span class="line">    <span class="attr">max-concurrent-upgrades:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">backup-enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="Error-Handling-Patterns"><a href="#Error-Handling-Patterns" class="headerlink" title="Error Handling Patterns"></a>Error Handling Patterns</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ErrorHandlingPatterns</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Circuit Breaker Pattern</span></span><br><span class="line">    <span class="meta">@CircuitBreaker(name = &quot;nacos-registry&quot;, fallbackMethod = &quot;fallbackServiceLookup&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ServiceInstance&gt; <span class="title function_">getServiceInstances</span><span class="params">(String serviceName)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nacosDiscoveryClient.getInstances(serviceName);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> List&lt;ServiceInstance&gt; <span class="title function_">fallbackServiceLookup</span><span class="params">(String serviceName, Exception ex)</span> &#123;</span><br><span class="line">        <span class="comment">// Return cached instances or default configuration</span></span><br><span class="line">        <span class="keyword">return</span> getCachedServiceInstances(serviceName);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Retry Pattern with Exponential Backoff</span></span><br><span class="line">    <span class="meta">@Retryable(</span></span><br><span class="line"><span class="meta">        value = &#123;RedisConnectionException.class&#125;,</span></span><br><span class="line"><span class="meta">        maxAttempts = 3,</span></span><br><span class="line"><span class="meta">        backoff = @Backoff(delay = 1000, multiplier = 2)</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateRoutingConfiguration</span><span class="params">(String tenantId, Map&lt;String, String&gt; config)</span> &#123;</span><br><span class="line">        redisTemplate.opsForHash().putAll(<span class="string">&quot;tenant:&quot;</span> + tenantId + <span class="string">&quot;:services&quot;</span>, config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Testing-Strategies"><a href="#Testing-Strategies" class="headerlink" title="Testing Strategies"></a>Testing Strategies</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GreyRouterIntegrationTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GreyRouterService greyRouterService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@MockBean</span></span><br><span class="line">    <span class="keyword">private</span> NacosServiceDiscovery nacosServiceDiscovery;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldRouteToCorrectServiceVersion</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Given</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> <span class="string">&quot;tenant-123&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">serviceName</span> <span class="operator">=</span> <span class="string">&quot;payment-service&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">expectedVersion</span> <span class="operator">=</span> <span class="string">&quot;v2.1&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        setupTenantServiceMapping(tenantId, serviceName, expectedVersion);</span><br><span class="line">        setupServiceInstances(serviceName, expectedVersion, </span><br><span class="line">                            Arrays.asList(<span class="string">&quot;instance1:8080&quot;</span>, <span class="string">&quot;instance2:8080&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When</span></span><br><span class="line">        <span class="type">ServiceInstanceInfo</span> <span class="variable">result</span> <span class="operator">=</span> greyRouterService</span><br><span class="line">            .routeToServiceInstance(tenantId, serviceName, <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Then</span></span><br><span class="line">        assertThat(result.getVersion()).isEqualTo(expectedVersion);</span><br><span class="line">        assertThat(result.getInstance()).isIn(<span class="string">&quot;instance1:8080&quot;</span>, <span class="string">&quot;instance2:8080&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldHandleSchemaUpgradeFailureGracefully</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Test schema upgrade rollback scenarios</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> <span class="string">&quot;tenant-456&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">version</span> <span class="operator">=</span> <span class="string">&quot;v2.0&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Mock database failure during migration</span></span><br><span class="line">        <span class="keyword">when</span>(databaseSchemaManager.upgradeTenantSchema(tenantId, version))</span><br><span class="line">            .thenThrow(<span class="keyword">new</span> <span class="title class_">SchemaUpgradeException</span>(<span class="string">&quot;Migration failed&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When &amp; Then</span></span><br><span class="line">        assertThatThrownBy(() -&gt; greyRouterService.upgradeDatabaseSchema(tenantId, version))</span><br><span class="line">            .isInstanceOf(SchemaUpgradeException.class);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Verify rollback was triggered</span></span><br><span class="line">        verify(databaseSchemaManager).rollbackToVersion(tenantId, <span class="string">&quot;v1.9&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Production-Deployment-Considerations"><a href="#Production-Deployment-Considerations" class="headerlink" title="Production Deployment Considerations"></a>Production Deployment Considerations</h2><h3 id="Infrastructure-Requirements"><a href="#Infrastructure-Requirements" class="headerlink" title="Infrastructure Requirements"></a>Infrastructure Requirements</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose.yml for development</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">grey-router-service:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">grey-router:latest</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_PROFILES_ACTIVE=production</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REDIS_CLUSTER_NODES=redis-cluster:6379</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">NACOS_SERVER_ADDR=nacos:8848</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-cluster</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">redis-cluster:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:7-alpine</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">--appendonly</span> <span class="literal">yes</span> <span class="string">--cluster-enabled</span> <span class="literal">yes</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">nacos:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nacos/nacos-server:latest</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8848:8848&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MODE=standalone</span></span><br></pre></td></tr></table></figure>

<h3 id="Kubernetes-Deployment"><a href="#Kubernetes-Deployment" class="headerlink" title="Kubernetes Deployment"></a>Kubernetes Deployment</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># k8s-deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grey-router-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grey-router</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">grey-router</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">grey-router</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grey-router</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">grey-router:v1.0.0</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_PROFILES_ACTIVE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;kubernetes&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">REDIS_CLUSTER_NODES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;redis-cluster-service:6379&quot;</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;512Mi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/actuator/health</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/actuator/health/readiness</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grey-router-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grey-router</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br></pre></td></tr></table></figure>

<h3 id="Monitoring-and-Alerting-Configuration"><a href="#Monitoring-and-Alerting-Configuration" class="headerlink" title="Monitoring and Alerting Configuration"></a>Monitoring and Alerting Configuration</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># prometheus-rules.yml</span></span><br><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grey-router-alerts</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">GreyRouterHighErrorRate</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      rate(grey_router_requests_total&#123;status=&quot;failure&quot;&#125;[5m]) / </span></span><br><span class="line"><span class="string">      rate(grey_router_requests_total[5m]) &gt; 0.05</span></span><br><span class="line"><span class="string"></span>    <span class="attr">for:</span> <span class="string">2m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;High error rate in Grey Router&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;Error rate is <span class="template-variable">&#123;&#123; $value | humanizePercentage &#125;&#125;</span> for the last 5 minutes&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">GreyRouterHighLatency</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      histogram_quantile(0.95, rate(grey_router_latency_bucket[5m])) &gt; 0.5</span></span><br><span class="line"><span class="string"></span>    <span class="attr">for:</span> <span class="string">2m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;High latency in Grey Router&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;95th percentile latency is <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>s&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">RedisConnectionFailure</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      up&#123;job=&quot;redis-cluster&quot;&#125; == 0</span></span><br><span class="line"><span class="string"></span>    <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;Redis cluster is down&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;Redis cluster connection failed&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Database-Migration-Best-Practices"><a href="#Database-Migration-Best-Practices" class="headerlink" title="Database Migration Best Practices"></a>Database Migration Best Practices</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductionMigrationStrategies</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Online schema migration for large tables</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performOnlineSchemaChange</span><span class="params">(String tenantId, String tableName, </span></span><br><span class="line"><span class="params">                                        String alterStatement)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Use pt-online-schema-change for MySQL or similar tools</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">command</span> <span class="operator">=</span> String.format(</span><br><span class="line">            <span class="string">&quot;pt-online-schema-change --alter=&#x27;%s&#x27; --execute D=%s,t=%s&quot;</span>,</span><br><span class="line">            alterStatement, getDatabaseName(tenantId), tableName</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="type">ProcessBuilder</span> <span class="variable">pb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, command);</span><br><span class="line">        pb.environment().put(<span class="string">&quot;MYSQL_PWD&quot;</span>, getDatabasePassword(tenantId));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> pb.start();</span><br><span class="line">            <span class="type">int</span> <span class="variable">exitCode</span> <span class="operator">=</span> process.waitFor();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (exitCode != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SchemaUpgradeException</span>(<span class="string">&quot;Online schema change failed&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SchemaUpgradeException</span>(<span class="string">&quot;Failed to execute online schema change&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Blue-green deployment for database schemas</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">blueGreenSchemaDeployment</span><span class="params">(String tenantId, String newVersion)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Create new schema version</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">blueSchema</span> <span class="operator">=</span> getCurrentSchema(tenantId);</span><br><span class="line">        <span class="type">String</span> <span class="variable">greenSchema</span> <span class="operator">=</span> createSchemaVersion(tenantId, newVersion);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Apply migrations to green schema</span></span><br><span class="line">            applyMigrationsToSchema(greenSchema, newVersion);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Validate green schema</span></span><br><span class="line">            validateSchemaIntegrity(greenSchema);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Switch traffic to green schema</span></span><br><span class="line">            switchSchemaTraffic(tenantId, greenSchema);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Keep blue schema for rollback</span></span><br><span class="line">            scheduleSchemaCleanup(blueSchema, Duration.ofHours(<span class="number">24</span>));</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// Rollback to blue schema</span></span><br><span class="line">            rollbackToSchema(tenantId, blueSchema);</span><br><span class="line">            cleanupFailedSchema(greenSchema);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Advanced-Features"><a href="#Advanced-Features" class="headerlink" title="Advanced Features"></a>Advanced Features</h2><h3 id="Multi-Region-Support"><a href="#Multi-Region-Support" class="headerlink" title="Multi-Region Support"></a>Multi-Region Support</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiRegionConfiguration</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="keyword">public</span> GreyRouterService <span class="title function_">multiRegionGreyRouterService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MultiRegionGreyRouterService</span>(</span><br><span class="line">            getRegionSpecificRouters(),</span><br><span class="line">            crossRegionLoadBalancer()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, GreyRouterService&gt; <span class="title function_">getRegionSpecificRouters</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, GreyRouterService&gt; routers = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Configure region-specific routers</span></span><br><span class="line">        routers.put(<span class="string">&quot;us-east-1&quot;</span>, createRegionRouter(<span class="string">&quot;us-east-1&quot;</span>));</span><br><span class="line">        routers.put(<span class="string">&quot;us-west-2&quot;</span>, createRegionRouter(<span class="string">&quot;us-west-2&quot;</span>));</span><br><span class="line">        routers.put(<span class="string">&quot;eu-west-1&quot;</span>, createRegionRouter(<span class="string">&quot;eu-west-1&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> routers;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiRegionGreyRouterService</span> <span class="keyword">implements</span> <span class="title class_">GreyRouterService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, GreyRouterService&gt; regionRouters;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CrossRegionLoadBalancer loadBalancer;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ServiceInstanceInfo <span class="title function_">routeToServiceInstance</span><span class="params">(String tenantId, </span></span><br><span class="line"><span class="params">                                                    String serviceName, </span></span><br><span class="line"><span class="params">                                                    Map&lt;String, String&gt; metadata)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Determine target region based on tenant location or latency</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">targetRegion</span> <span class="operator">=</span> determineTargetRegion(tenantId, metadata);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Route within the target region</span></span><br><span class="line">        <span class="type">GreyRouterService</span> <span class="variable">regionRouter</span> <span class="operator">=</span> regionRouters.get(targetRegion);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> regionRouter.routeToServiceInstance(tenantId, serviceName, metadata);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoInstanceAvailableException e) &#123;</span><br><span class="line">            <span class="comment">// Cross-region fallback</span></span><br><span class="line">            <span class="keyword">return</span> loadBalancer.routeToAlternativeRegion(tenantId, serviceName, </span><br><span class="line">                                                       targetRegion, metadata);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">determineTargetRegion</span><span class="params">(String tenantId, Map&lt;String, String&gt; metadata)</span> &#123;</span><br><span class="line">        <span class="comment">// Logic to determine optimal region based on:</span></span><br><span class="line">        <span class="comment">// 1. Tenant configuration</span></span><br><span class="line">        <span class="comment">// 2. Service availability</span></span><br><span class="line">        <span class="comment">// 3. Network latency</span></span><br><span class="line">        <span class="comment">// 4. Compliance requirements</span></span><br><span class="line">        </span><br><span class="line">        <span class="type">TenantConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> tenantConfigService.getTenantConfig(tenantId);</span><br><span class="line">        <span class="keyword">if</span> (config.hasRegionPreference()) &#123;</span><br><span class="line">            <span class="keyword">return</span> config.getPreferredRegion();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Use latency-based routing</span></span><br><span class="line">        <span class="keyword">return</span> latencyBasedRegionSelector.selectRegion(metadata.get(<span class="string">&quot;client-ip&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Canary-Release-Automation"><a href="#Canary-Release-Automation" class="headerlink" title="Canary Release Automation"></a>Canary Release Automation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CanaryReleaseManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MetricsCollector metricsCollector;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AlertManager alertManager;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initiateCanaryRelease</span><span class="params">(String serviceId, String newVersion, </span></span><br><span class="line"><span class="params">                                    CanaryConfiguration config)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">CanaryRelease</span> <span class="variable">canary</span> <span class="operator">=</span> CanaryRelease.builder()</span><br><span class="line">            .serviceId(serviceId)</span><br><span class="line">            .newVersion(newVersion)</span><br><span class="line">            .configuration(config)</span><br><span class="line">            .status(CanaryStatus.STARTING)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Start with minimal traffic</span></span><br><span class="line">        updateCanaryTrafficSplit(canary, <span class="number">0.01</span>); <span class="comment">// 1%</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Schedule automated progression</span></span><br><span class="line">        scheduleCanaryProgression(canary);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedDelay = 300000)</span> <span class="comment">// 5 minutes</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">progressCanaryReleases</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;CanaryRelease&gt; activeCanaries = getActiveCanaryReleases();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (CanaryRelease canary : activeCanaries) &#123;</span><br><span class="line">            <span class="type">CanaryMetrics</span> <span class="variable">metrics</span> <span class="operator">=</span> metricsCollector.collectCanaryMetrics(canary);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (shouldProgressCanary(canary, metrics)) &#123;</span><br><span class="line">                progressCanary(canary);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shouldAbortCanary(canary, metrics)) &#123;</span><br><span class="line">                abortCanary(canary);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">shouldProgressCanary</span><span class="params">(CanaryRelease canary, CanaryMetrics metrics)</span> &#123;</span><br><span class="line">        <span class="comment">// Success criteria:</span></span><br><span class="line">        <span class="comment">// 1. Error rate &lt; 0.1%</span></span><br><span class="line">        <span class="comment">// 2. Latency increase &lt; 10%</span></span><br><span class="line">        <span class="comment">// 3. No critical alerts</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> metrics.getErrorRate() &lt; <span class="number">0.001</span> &amp;&amp;</span><br><span class="line">               metrics.getLatencyIncrease() &lt; <span class="number">0.1</span> &amp;&amp;</span><br><span class="line">               !alertManager.hasCriticalAlerts(canary.getServiceId());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">progressCanary</span><span class="params">(CanaryRelease canary)</span> &#123;</span><br><span class="line">        <span class="type">double</span> <span class="variable">currentTraffic</span> <span class="operator">=</span> canary.getCurrentTrafficPercentage();</span><br><span class="line">        <span class="type">double</span> <span class="variable">nextTraffic</span> <span class="operator">=</span> Math.min(currentTraffic * <span class="number">2</span>, <span class="number">1.0</span>); <span class="comment">// Double traffic</span></span><br><span class="line">        </span><br><span class="line">        updateCanaryTrafficSplit(canary, nextTraffic);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (nextTraffic &gt;= <span class="number">1.0</span>) &#123;</span><br><span class="line">            completeCanaryRelease(canary);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Advanced-Load-Balancing-Strategies"><a href="#Advanced-Load-Balancing-Strategies" class="headerlink" title="Advanced Load Balancing Strategies"></a>Advanced Load Balancing Strategies</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- advanced_load_balancer.lua</span></span><br><span class="line"><span class="comment">-- Weighted round-robin with health checks and circuit breaker logic</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> service_name = ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">local</span> tenant_id = ARGV[<span class="number">2</span>]</span><br><span class="line"><span class="keyword">local</span> lb_strategy = ARGV[<span class="number">3</span>] <span class="keyword">or</span> <span class="string">&quot;weighted_round_robin&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Get service instances with health status</span></span><br><span class="line"><span class="keyword">local</span> instances_key = <span class="string">&quot;service:&quot;</span> .. service_name .. <span class="string">&quot;:instances&quot;</span></span><br><span class="line"><span class="keyword">local</span> instances = redis.call(<span class="string">&#x27;HGETALL&#x27;</span>, instances_key)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> healthy_instances = &#123;&#125;</span><br><span class="line"><span class="keyword">local</span> total_weight = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Filter healthy instances and calculate total weight</span></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, #instances, <span class="number">2</span> <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> instance = instances[i]</span><br><span class="line">    <span class="keyword">local</span> instance_data = cjson.decode(instances[i + <span class="number">1</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- Check circuit breaker status</span></span><br><span class="line">    <span class="keyword">local</span> cb_key = <span class="string">&quot;circuit_breaker:&quot;</span> .. instance</span><br><span class="line">    <span class="keyword">local</span> cb_status = redis.call(<span class="string">&#x27;GET&#x27;</span>, cb_key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> cb_status ~= <span class="string">&quot;OPEN&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- Check health status</span></span><br><span class="line">        <span class="keyword">local</span> health_key = <span class="string">&quot;health:&quot;</span> .. instance</span><br><span class="line">        <span class="keyword">local</span> health_score = redis.call(<span class="string">&#x27;GET&#x27;</span>, health_key) <span class="keyword">or</span> <span class="number">100</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">tonumber</span>(health_score) &gt; <span class="number">50</span> <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">table</span>.<span class="built_in">insert</span>(healthy_instances, &#123;</span><br><span class="line">                instance = instance,</span><br><span class="line">                weight = instance_data.weight <span class="keyword">or</span> <span class="number">1</span>,</span><br><span class="line">                health_score = <span class="built_in">tonumber</span>(health_score),</span><br><span class="line">                current_connections = instance_data.connections <span class="keyword">or</span> <span class="number">0</span></span><br><span class="line">            &#125;)</span><br><span class="line">            total_weight = total_weight + (instance_data.weight <span class="keyword">or</span> <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> #healthy_instances == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> &#123;err = <span class="string">&quot;No healthy instances available&quot;</span>&#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> selected_instance</span><br><span class="line"><span class="keyword">if</span> lb_strategy == <span class="string">&quot;weighted_round_robin&quot;</span> <span class="keyword">then</span></span><br><span class="line">    selected_instance = weighted_round_robin_select(healthy_instances, total_weight)</span><br><span class="line"><span class="keyword">elseif</span> lb_strategy == <span class="string">&quot;least_connections&quot;</span> <span class="keyword">then</span></span><br><span class="line">    selected_instance = least_connections_select(healthy_instances)</span><br><span class="line"><span class="keyword">elseif</span> lb_strategy == <span class="string">&quot;health_aware&quot;</span> <span class="keyword">then</span></span><br><span class="line">    selected_instance = health_aware_select(healthy_instances)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Update instance metrics</span></span><br><span class="line"><span class="keyword">local</span> metrics_key = <span class="string">&quot;metrics:&quot;</span> .. selected_instance.instance</span><br><span class="line">redis.call(<span class="string">&#x27;HINCRBY&#x27;</span>, metrics_key, <span class="string">&#x27;requests&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">redis.call(<span class="string">&#x27;HINCRBY&#x27;</span>, metrics_key, <span class="string">&#x27;connections&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">redis.call(<span class="string">&#x27;EXPIRE&#x27;</span>, metrics_key, <span class="number">300</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">    instance = selected_instance.instance,</span><br><span class="line">    weight = selected_instance.weight,</span><br><span class="line">    health_score = selected_instance.health_score</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">weighted_round_robin_select</span><span class="params">(instances, total_weight)</span></span></span><br><span class="line">    <span class="keyword">local</span> counter_key = <span class="string">&quot;lb_counter:&quot;</span> .. service_name</span><br><span class="line">    <span class="keyword">local</span> counter = redis.call(<span class="string">&#x27;INCR&#x27;</span>, counter_key)</span><br><span class="line">    redis.call(<span class="string">&#x27;EXPIRE&#x27;</span>, counter_key, <span class="number">3600</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">local</span> threshold = (counter % total_weight) + <span class="number">1</span></span><br><span class="line">    <span class="keyword">local</span> current_weight = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> _, instance <span class="keyword">in</span> <span class="built_in">ipairs</span>(instances) <span class="keyword">do</span></span><br><span class="line">        current_weight = current_weight + instance.weight</span><br><span class="line">        <span class="keyword">if</span> current_weight &gt;= threshold <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> instance</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> instances[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">least_connections_select</span><span class="params">(instances)</span></span></span><br><span class="line">    <span class="keyword">local</span> min_connections = <span class="built_in">math</span>.<span class="built_in">huge</span></span><br><span class="line">    <span class="keyword">local</span> selected = instances[<span class="number">1</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> _, instance <span class="keyword">in</span> <span class="built_in">ipairs</span>(instances) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> instance.current_connections &lt; min_connections <span class="keyword">then</span></span><br><span class="line">            min_connections = instance.current_connections</span><br><span class="line">            selected = instance</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> selected</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">health_aware_select</span><span class="params">(instances)</span></span></span><br><span class="line">    <span class="comment">-- Weighted selection based on health score</span></span><br><span class="line">    <span class="keyword">local</span> total_health = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> _, instance <span class="keyword">in</span> <span class="built_in">ipairs</span>(instances) <span class="keyword">do</span></span><br><span class="line">        total_health = total_health + instance.health_score</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">local</span> random_point = <span class="built_in">math</span>.<span class="built_in">random</span>() * total_health</span><br><span class="line">    <span class="keyword">local</span> current_health = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> _, instance <span class="keyword">in</span> <span class="built_in">ipairs</span>(instances) <span class="keyword">do</span></span><br><span class="line">        current_health = current_health + instance.health_score</span><br><span class="line">        <span class="keyword">if</span> current_health &gt;= random_point <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> instance</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> instances[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="Security-Deep-Dive"><a href="#Security-Deep-Dive" class="headerlink" title="Security Deep Dive"></a>Security Deep Dive</h2><h3 id="OAuth2-Integration"><a href="#OAuth2-Integration" class="headerlink" title="OAuth2 Integration"></a>OAuth2 Integration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreyRouterSecurityConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityFilterChain <span class="title function_">filterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">            .authorizeHttpRequests(authz -&gt; authz</span><br><span class="line">                .requestMatchers(<span class="string">&quot;/actuator/health&quot;</span>).permitAll()</span><br><span class="line">                .requestMatchers(<span class="string">&quot;/api/public/**&quot;</span>).permitAll()</span><br><span class="line">                .requestMatchers(<span class="string">&quot;/api/admin/**&quot;</span>).hasRole(<span class="string">&quot;GREY_ROUTER_ADMIN&quot;</span>)</span><br><span class="line">                .requestMatchers(<span class="string">&quot;/api/tenants/**&quot;</span>).hasRole(<span class="string">&quot;TENANT_MANAGER&quot;</span>)</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">            )</span><br><span class="line">            .oauth2ResourceServer(oauth2 -&gt; oauth2</span><br><span class="line">                .jwt(jwt -&gt; jwt</span><br><span class="line">                    .jwtAuthenticationConverter(jwtAuthenticationConverter())</span><br><span class="line">                )</span><br><span class="line">            );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JwtAuthenticationConverter <span class="title function_">jwtAuthenticationConverter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">JwtAuthenticationConverter</span> <span class="variable">converter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JwtAuthenticationConverter</span>();</span><br><span class="line">        converter.setJwtGrantedAuthoritiesConverter(jwt -&gt; &#123;</span><br><span class="line">            Collection&lt;String&gt; roles = jwt.getClaimAsStringList(<span class="string">&quot;roles&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> roles.stream()</span><br><span class="line">                .map(role -&gt; <span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(<span class="string">&quot;ROLE_&quot;</span> + role))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> converter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Rate-Limiting-and-Throttling"><a href="#Rate-Limiting-and-Throttling" class="headerlink" title="Rate Limiting and Throttling"></a>Rate Limiting and Throttling</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RateLimitingFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RateLimitProperties rateLimitProperties;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, </span></span><br><span class="line"><span class="params">                        FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">httpRequest</span> <span class="operator">=</span> (HttpServletRequest) request;</span><br><span class="line">        <span class="type">String</span> <span class="variable">clientId</span> <span class="operator">=</span> extractClientId(httpRequest);</span><br><span class="line">        <span class="type">String</span> <span class="variable">endpoint</span> <span class="operator">=</span> httpRequest.getRequestURI();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (isRateLimited(clientId, endpoint)) &#123;</span><br><span class="line">            <span class="type">HttpServletResponse</span> <span class="variable">httpResponse</span> <span class="operator">=</span> (HttpServletResponse) response;</span><br><span class="line">            httpResponse.setStatus(HttpStatus.TOO_MANY_REQUESTS.value());</span><br><span class="line">            httpResponse.getWriter().write(<span class="string">&quot;Rate limit exceeded&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isRateLimited</span><span class="params">(String clientId, String endpoint)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;rate_limit:&quot;</span> + clientId + <span class="string">&quot;:&quot;</span> + endpoint;</span><br><span class="line">        <span class="type">String</span> <span class="variable">windowKey</span> <span class="operator">=</span> key + <span class="string">&quot;:&quot;</span> + getCurrentWindow();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Sliding window rate limiting</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">currentCount</span> <span class="operator">=</span> redisTemplate.opsForValue().increment(windowKey);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (currentCount == <span class="number">1</span>) &#123;</span><br><span class="line">            redisTemplate.expire(windowKey, Duration.ofMinutes(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">RateLimitConfig</span> <span class="variable">config</span> <span class="operator">=</span> rateLimitProperties.getConfigForEndpoint(endpoint);</span><br><span class="line">        <span class="keyword">return</span> currentCount &gt; config.getRequestsPerMinute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Benchmarking"><a href="#Performance-Benchmarking" class="headerlink" title="Performance Benchmarking"></a>Performance Benchmarking</h2><h3 id="Load-Testing-Results"><a href="#Load-Testing-Results" class="headerlink" title="Load Testing Results"></a>Load Testing Results</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PerformanceBenchmark</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">runLoadTest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Benchmark Results (on AWS c5.2xlarge):</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * Concurrent Users: 1000</span></span><br><span class="line"><span class="comment">         * Test Duration: 10 minutes</span></span><br><span class="line"><span class="comment">         * Average Response Time: 45ms</span></span><br><span class="line"><span class="comment">         * 95th Percentile: 120ms</span></span><br><span class="line"><span class="comment">         * 99th Percentile: 250ms</span></span><br><span class="line"><span class="comment">         * Throughput: 15,000 RPS</span></span><br><span class="line"><span class="comment">         * Error Rate: 0.02%</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * Redis Operations:</span></span><br><span class="line"><span class="comment">         * - Simple GET: 0.5ms avg</span></span><br><span class="line"><span class="comment">         * - Lua Script Execution: 2.1ms avg</span></span><br><span class="line"><span class="comment">         * - Hash Operations: 0.8ms avg</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * Database Operations:</span></span><br><span class="line"><span class="comment">         * - Schema Migration (small): 2.3s avg</span></span><br><span class="line"><span class="comment">         * - Schema Migration (large table): 45s avg</span></span><br><span class="line"><span class="comment">         * - Connection Pool Utilization: 60%</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">benchmarkRoutingDecision</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">StopWatch</span> <span class="variable">stopWatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StopWatch</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Warm up</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            greyRouterService.routeToServiceInstance(<span class="string">&quot;tenant-&quot;</span> + i, <span class="string">&quot;test-service&quot;</span>, <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Actual benchmark</span></span><br><span class="line">        stopWatch.start();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">            greyRouterService.routeToServiceInstance(<span class="string">&quot;tenant-&quot;</span> + (i % <span class="number">100</span>), <span class="string">&quot;test-service&quot;</span>, <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;());</span><br><span class="line">        &#125;</span><br><span class="line">        stopWatch.stop();</span><br><span class="line">        </span><br><span class="line">        <span class="type">double</span> <span class="variable">avgTime</span> <span class="operator">=</span> stopWatch.getTotalTimeMillis() / <span class="number">10000.0</span>;</span><br><span class="line">        assertThat(avgTime).isLessThan(<span class="number">5.0</span>); <span class="comment">// Less than 5ms average</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Disaster-Recovery-and-Business-Continuity"><a href="#Disaster-Recovery-and-Business-Continuity" class="headerlink" title="Disaster Recovery and Business Continuity"></a>Disaster Recovery and Business Continuity</h2><h3 id="Backup-and-Recovery-Strategies"><a href="#Backup-and-Recovery-Strategies" class="headerlink" title="Backup and Recovery Strategies"></a>Backup and Recovery Strategies</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DisasterRecoveryService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0 0 2 * * ?&quot;)</span> <span class="comment">// Daily at 2 AM</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performBackup</span><span class="params">()</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Backup Redis data</span></span><br><span class="line">        backupRedisData();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Backup configuration data</span></span><br><span class="line">        backupConfigurationData();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Backup tenant database schemas</span></span><br><span class="line">        backupTenantSchemas();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">backupRedisData</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Create Redis backup</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">backupCommand</span> <span class="operator">=</span> <span class="string">&quot;redis-cli --rdb /backup/redis-backup-&quot;</span> + </span><br><span class="line">                                 LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd-HH-mm&quot;</span>)) + </span><br><span class="line">                                 <span class="string">&quot;.rdb&quot;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="type">ProcessBuilder</span> <span class="variable">pb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, backupCommand);</span><br><span class="line">            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> pb.start();</span><br><span class="line">            </span><br><span class="line">            <span class="type">int</span> <span class="variable">exitCode</span> <span class="operator">=</span> process.waitFor();</span><br><span class="line">            <span class="keyword">if</span> (exitCode != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BackupException</span>(<span class="string">&quot;Redis backup failed&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Upload to S3 or other cloud storage</span></span><br><span class="line">            uploadBackupToCloud(<span class="string">&quot;redis-backup&quot;</span>);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Failed to backup Redis data&quot;</span>, e);</span><br><span class="line">            alertManager.sendAlert(<span class="string">&quot;Redis backup failed&quot;</span>, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performDisasterRecovery</span><span class="params">(String backupTimestamp)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Stop all routing traffic</span></span><br><span class="line">        enableMaintenanceMode();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Restore Redis data</span></span><br><span class="line">            restoreRedisFromBackup(backupTimestamp);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Restore configuration</span></span><br><span class="line">            restoreConfigurationFromBackup(backupTimestamp);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Validate system integrity</span></span><br><span class="line">            validateSystemIntegrity();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Resume routing traffic</span></span><br><span class="line">            disableMaintenanceMode();</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Disaster recovery failed&quot;</span>, e);</span><br><span class="line">            <span class="comment">// Keep maintenance mode active</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DisasterRecoveryException</span>(<span class="string">&quot;Recovery failed&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="High-Availability-Setup"><a href="#High-Availability-Setup" class="headerlink" title="High Availability Setup"></a>High Availability Setup</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Redis Sentinel Configuration</span></span><br><span class="line"><span class="comment"># sentinel.conf</span></span><br><span class="line"><span class="string">port</span> <span class="number">26379</span></span><br><span class="line"><span class="string">sentinel</span> <span class="string">monitor</span> <span class="string">mymaster</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">6379 </span><span class="number">2</span></span><br><span class="line"><span class="string">sentinel</span> <span class="string">down-after-milliseconds</span> <span class="string">mymaster</span> <span class="number">5000</span></span><br><span class="line"><span class="string">sentinel</span> <span class="string">failover-timeout</span> <span class="string">mymaster</span> <span class="number">10000</span></span><br><span class="line"><span class="string">sentinel</span> <span class="string">parallel-syncs</span> <span class="string">mymaster</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Application configuration for HA</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">master:</span> <span class="string">mymaster</span></span><br><span class="line">      <span class="attr">nodes:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.10</span><span class="string">:26379</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.11</span><span class="string">:26379</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.12</span><span class="string">:26379</span></span><br><span class="line">    <span class="attr">lettuce:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">50</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">20</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">cluster:</span></span><br><span class="line">        <span class="attr">refresh:</span></span><br><span class="line">          <span class="attr">adaptive:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">period:</span> <span class="string">30s</span></span><br></pre></td></tr></table></figure>

<h2 id="Future-Enhancements-and-Roadmap"><a href="#Future-Enhancements-and-Roadmap" class="headerlink" title="Future Enhancements and Roadmap"></a>Future Enhancements and Roadmap</h2><h3 id="Machine-Learning-Integration"><a href="#Machine-Learning-Integration" class="headerlink" title="Machine Learning Integration"></a>Machine Learning Integration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MLEnhancedRouting</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MLModelService mlModelService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ServiceInstanceInfo <span class="title function_">intelligentRouting</span><span class="params">(String tenantId, </span></span><br><span class="line"><span class="params">                                                String serviceName,</span></span><br><span class="line"><span class="params">                                                RequestContext context)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Collect features for ML model</span></span><br><span class="line">        Map&lt;String, Double&gt; features = extractFeatures(tenantId, serviceName, context);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Get ML prediction for optimal routing</span></span><br><span class="line">        <span class="type">MLPrediction</span> <span class="variable">prediction</span> <span class="operator">=</span> mlModelService.predict(<span class="string">&quot;routing-optimizer&quot;</span>, features);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Apply ML-guided routing decision</span></span><br><span class="line">        <span class="keyword">if</span> (prediction.getConfidence() &gt; <span class="number">0.8</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> routeBasedOnMLPrediction(prediction);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Fallback to traditional routing</span></span><br><span class="line">            <span class="keyword">return</span> traditionalRouting(tenantId, serviceName, context);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Double&gt; <span class="title function_">extractFeatures</span><span class="params">(String tenantId, String serviceName, </span></span><br><span class="line"><span class="params">                                              RequestContext context)</span> &#123;</span><br><span class="line">        Map&lt;String, Double&gt; features = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Historical performance features</span></span><br><span class="line">        features.put(<span class="string">&quot;avg_response_time&quot;</span>, getAvgResponseTime(tenantId, serviceName));</span><br><span class="line">        features.put(<span class="string">&quot;error_rate&quot;</span>, getErrorRate(tenantId, serviceName));</span><br><span class="line">        features.put(<span class="string">&quot;load_factor&quot;</span>, getCurrentLoadFactor(serviceName));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Contextual features</span></span><br><span class="line">        features.put(<span class="string">&quot;time_of_day&quot;</span>, (<span class="type">double</span>) LocalTime.now().getHour());</span><br><span class="line">        features.put(<span class="string">&quot;day_of_week&quot;</span>, (<span class="type">double</span>) LocalDate.now().getDayOfWeek().getValue());</span><br><span class="line">        features.put(<span class="string">&quot;request_size&quot;</span>, (<span class="type">double</span>) context.getRequestSize());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Tenant-specific features</span></span><br><span class="line">        features.put(<span class="string">&quot;tenant_tier&quot;</span>, (<span class="type">double</span>) getTenantTier(tenantId));</span><br><span class="line">        features.put(<span class="string">&quot;historical_latency&quot;</span>, getHistoricalLatency(tenantId));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> features;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Event-Sourcing-Integration"><a href="#Event-Sourcing-Integration" class="headerlink" title="Event Sourcing Integration"></a>Event Sourcing Integration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RoutingEvent</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String eventId;</span><br><span class="line">    <span class="keyword">private</span> String tenantId;</span><br><span class="line">    <span class="keyword">private</span> String serviceName;</span><br><span class="line">    <span class="keyword">private</span> String fromVersion;</span><br><span class="line">    <span class="keyword">private</span> String toVersion;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime timestamp;</span><br><span class="line">    <span class="keyword">private</span> String eventType; <span class="comment">// ROUTE_CREATED, VERSION_UPDATED, MIGRATION_COMPLETED</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; metadata;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Event sourcing for audit trail and replay capability</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventSourcingService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">replayEvents</span><span class="params">(String tenantId, LocalDateTime fromTime)</span> &#123;</span><br><span class="line">        List&lt;RoutingEvent&gt; events = routingEventRepository</span><br><span class="line">            .findByTenantIdAndTimestampAfter(tenantId, fromTime);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (RoutingEvent event : events) &#123;</span><br><span class="line">            applyEvent(event);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">applyEvent</span><span class="params">(RoutingEvent event)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (event.getEventType()) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;VERSION_UPDATED&quot;</span>:</span><br><span class="line">                updateTenantServiceVersion(event.getTenantId(), </span><br><span class="line">                                         event.getServiceName(), </span><br><span class="line">                                         event.getToVersion());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;MIGRATION_COMPLETED&quot;</span>:</span><br><span class="line">                markMigrationComplete(event.getTenantId(), event.getToVersion());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// Handle other event types</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>The Grey Service Router system provides a robust foundation for managing multi-tenant service deployments with controlled rollouts, database schema migrations, and intelligent traffic routing. Key success factors include:</p>
<p><strong>Operational Excellence</strong>: Comprehensive monitoring, automated rollback capabilities, and disaster recovery procedures ensure high availability and reliability.</p>
<p><strong>Performance Optimization</strong>: Multi-level caching, optimized Redis operations, and efficient load balancing algorithms deliver sub-5ms routing decisions even under high load.</p>
<p><strong>Security</strong>: Role-based access control, rate limiting, and encryption protect against unauthorized access and abuse.</p>
<p><strong>Scalability</strong>: Horizontal scaling capabilities, multi-region support, and efficient data structures support thousands of tenants and high request volumes.</p>
<p><strong>Maintainability</strong>: Clean architecture, comprehensive testing, and automated deployment pipelines enable rapid development and safe production changes.</p>
<p>This system architecture has been battle-tested in production environments handling millions of requests daily across hundreds of tenants, demonstrating its effectiveness for enterprise-scale grey deployment scenarios.</p>
<h2 id="External-References"><a href="#External-References" class="headerlink" title="External References"></a>External References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://redis.io/docs/manual/programmability/lua-api/">Redis Lua Scripting Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints.health">Spring Boot Actuator Health Indicators</a></li>
<li><a target="_blank" rel="noopener" href="https://nacos.io/en-us/docs/architecture.html">Nacos Service Discovery</a></li>
<li><a target="_blank" rel="noopener" href="https://martinfowler.com/bliki/CircuitBreaker.html">Circuit Breaker Pattern</a></li>
<li><a target="_blank" rel="noopener" href="https://flywaydb.org/documentation/concepts/migrations">Database Migration Best Practices</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">Kubernetes Deployment Strategies</a></li>
<li><a target="_blank" rel="noopener" href="https://prometheus.io/docs/introduction/overview/">Prometheus Monitoring</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/servlet/oauth2/resource-server/index.html">OAuth2 Resource Server</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Charlie Feng</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
