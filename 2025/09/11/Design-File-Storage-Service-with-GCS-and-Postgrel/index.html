<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"shayne007.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="System OverviewThe File Storage Service is a robust, scalable solution for handling file uploads, storage, and retrieval operations. Built on Google Cloud Storage (GCS) and PostgreSQL, it provides ent">
<meta property="og:type" content="article">
<meta property="og:title" content="Design File Storage Service with GCS and PostgreSQL">
<meta property="og:url" content="https://shayne007.github.io/2025/09/11/Design-File-Storage-Service-with-GCS-and-Postgrel/index.html">
<meta property="og:site_name" content="Charlie Feng&#39;s Tech Space">
<meta property="og:description" content="System OverviewThe File Storage Service is a robust, scalable solution for handling file uploads, storage, and retrieval operations. Built on Google Cloud Storage (GCS) and PostgreSQL, it provides ent">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-09-10T16:09:52.000Z">
<meta property="article:modified_time" content="2025-09-10T16:17:22.348Z">
<meta property="article:author" content="Charlie Feng">
<meta property="article:tag" content="system-design">
<meta property="article:tag" content="file storage">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://shayne007.github.io/2025/09/11/Design-File-Storage-Service-with-GCS-and-Postgrel/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://shayne007.github.io/2025/09/11/Design-File-Storage-Service-with-GCS-and-Postgrel/","path":"2025/09/11/Design-File-Storage-Service-with-GCS-and-Postgrel/","title":"Design File Storage Service with GCS and PostgreSQL"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Design File Storage Service with GCS and PostgreSQL | Charlie Feng's Tech Space</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"cdn":false,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.5.0/mermaid.min.js","integrity":"sha256-2obLuIPcceEhkE3G09G33hBdmE55ivVcZUlcKcGNHjU="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>





  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Charlie Feng's Tech Space</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">You will survive with skills</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#System-Overview"><span class="nav-number">1.</span> <span class="nav-text">System Overview</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Architecture-Goals"><span class="nav-number">1.1.</span> <span class="nav-text">Architecture Goals</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#High-Level-Architecture"><span class="nav-number">2.</span> <span class="nav-text">High-Level Architecture</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Core-Components-Deep-Dive"><span class="nav-number">3.</span> <span class="nav-text">Core Components Deep Dive</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#File-Upload-Service"><span class="nav-number">3.1.</span> <span class="nav-text">File Upload Service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Chunk-Management-System"><span class="nav-number">3.2.</span> <span class="nav-text">Chunk Management System</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Database-Schema-Design"><span class="nav-number">3.3.</span> <span class="nav-text">Database Schema Design</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GCS-Integration-Service"><span class="nav-number">3.4.</span> <span class="nav-text">GCS Integration Service</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#File-Storage-SDK-Design"><span class="nav-number">4.</span> <span class="nav-text">File Storage SDK Design</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Security-Implementation"><span class="nav-number">5.</span> <span class="nav-text">Security Implementation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Authentication-and-Authorization"><span class="nav-number">5.1.</span> <span class="nav-text">Authentication and Authorization</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#File-Encryption"><span class="nav-number">5.2.</span> <span class="nav-text">File Encryption</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Performance-Optimization-Strategies"><span class="nav-number">6.</span> <span class="nav-text">Performance Optimization Strategies</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Caching-Layer-Implementation"><span class="nav-number">6.1.</span> <span class="nav-text">Caching Layer Implementation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Database-Query-Optimization"><span class="nav-number">6.2.</span> <span class="nav-text">Database Query Optimization</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Monitoring-and-Observability"><span class="nav-number">7.</span> <span class="nav-text">Monitoring and Observability</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Comprehensive-Monitoring-Setup"><span class="nav-number">7.1.</span> <span class="nav-text">Comprehensive Monitoring Setup</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Error-Handling-and-Resilience"><span class="nav-number">8.</span> <span class="nav-text">Error Handling and Resilience</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Comprehensive-Error-Handling-Strategy"><span class="nav-number">8.1.</span> <span class="nav-text">Comprehensive Error Handling Strategy</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Production-Deployment-Architecture"><span class="nav-number">9.</span> <span class="nav-text">Production Deployment Architecture</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Kubernetes-Deployment-Configuration"><span class="nav-number">9.1.</span> <span class="nav-text">Kubernetes Deployment Configuration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Infrastructure-as-Code-Terraform"><span class="nav-number">9.2.</span> <span class="nav-text">Infrastructure as Code (Terraform)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Performance-Benchmarks-and-SLAs"><span class="nav-number">10.</span> <span class="nav-text">Performance Benchmarks and SLAs</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Service-Level-Objectives"><span class="nav-number">10.1.</span> <span class="nav-text">Service Level Objectives</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Load-Testing-Strategy"><span class="nav-number">10.2.</span> <span class="nav-text">Load Testing Strategy</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Interview-Questions-and-Insights"><span class="nav-number">11.</span> <span class="nav-text">Interview Questions and Insights</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#System-Design-Questions"><span class="nav-number">11.1.</span> <span class="nav-text">System Design Questions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Scalability-Questions"><span class="nav-number">11.2.</span> <span class="nav-text">Scalability Questions</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SDK-Usage-Examples"><span class="nav-number">12.</span> <span class="nav-text">SDK Usage Examples</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Java-SDK-Usage"><span class="nav-number">12.1.</span> <span class="nav-text">Java SDK Usage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#React-SDK-Usage"><span class="nav-number">12.2.</span> <span class="nav-text">React SDK Usage</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Security-Best-Practices"><span class="nav-number">13.</span> <span class="nav-text">Security Best Practices</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Content-Validation-and-Sanitization"><span class="nav-number">13.1.</span> <span class="nav-text">Content Validation and Sanitization</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Access-Control-Implementation"><span class="nav-number">13.2.</span> <span class="nav-text">Access Control Implementation</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Disaster-Recovery-and-Backup-Strategy"><span class="nav-number">14.</span> <span class="nav-text">Disaster Recovery and Backup Strategy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Automated-Backup-System"><span class="nav-number">14.1.</span> <span class="nav-text">Automated Backup System</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Multi-Region-Deployment-Flow"><span class="nav-number">14.2.</span> <span class="nav-text">Multi-Region Deployment Flow</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cost-Optimization-Strategies"><span class="nav-number">15.</span> <span class="nav-text">Cost Optimization Strategies</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Intelligent-Storage-Class-Management"><span class="nav-number">15.1.</span> <span class="nav-text">Intelligent Storage Class Management</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Usage-Analytics-and-Reporting"><span class="nav-number">15.2.</span> <span class="nav-text">Usage Analytics and Reporting</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Testing-Strategy"><span class="nav-number">16.</span> <span class="nav-text">Testing Strategy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Integration-Testing"><span class="nav-number">16.1.</span> <span class="nav-text">Integration Testing</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Load-Testing-with-JMeter-Configuration"><span class="nav-number">16.2.</span> <span class="nav-text">Load Testing with JMeter Configuration</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#External-Resources-and-Documentation"><span class="nav-number">17.</span> <span class="nav-text">External Resources and Documentation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Essential-Resources"><span class="nav-number">17.1.</span> <span class="nav-text">Essential Resources</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Charlie Feng</p>
  <div class="site-description" itemprop="description">This place is for thinking and sharing.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">53</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/09/11/Design-File-Storage-Service-with-GCS-and-Postgrel/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Design File Storage Service with GCS and PostgreSQL | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Design File Storage Service with GCS and PostgreSQL
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-09-11 00:09:52 / Modified: 00:17:22" itemprop="dateCreated datePublished" datetime="2025-09-11T00:09:52+08:00">2025-09-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system-design/" itemprop="url" rel="index"><span itemprop="name">system-design</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="System-Overview"><a href="#System-Overview" class="headerlink" title="System Overview"></a>System Overview</h2><p>The File Storage Service is a robust, scalable solution for handling file uploads, storage, and retrieval operations. Built on Google Cloud Storage (GCS) and PostgreSQL, it provides enterprise-grade file management capabilities with comprehensive SDK support for seamless integration.</p>
<h3 id="Architecture-Goals"><a href="#Architecture-Goals" class="headerlink" title="Architecture Goals"></a>Architecture Goals</h3><ul>
<li><strong>Scalability</strong>: Handle millions of files with horizontal scaling</li>
<li><strong>Reliability</strong>: 99.9% uptime with fault tolerance</li>
<li><strong>Security</strong>: End-to-end encryption and access control</li>
<li><strong>Performance</strong>: Sub-second response times for file operations</li>
<li><strong>Cost Efficiency</strong>: Intelligent storage tiering and lifecycle management</li>
</ul>
<h2 id="High-Level-Architecture"><a href="#High-Level-Architecture" class="headerlink" title="High-Level Architecture"></a>High-Level Architecture</h2><pre>
<code class="mermaid">
graph TB
subgraph &quot;Client Layer&quot;
    A[Web Client] 
    B[Mobile Client]
    C[Service Integration]
end

subgraph &quot;API Gateway&quot;
    D[Load Balancer]
    E[Authentication]
    F[Rate Limiting]
end

subgraph &quot;File Storage Service&quot;
    G[Upload Controller]
    H[Download Controller]
    I[Metadata Service]
    J[Chunk Manager]
end

subgraph &quot;Storage Layer&quot;
    K[PostgreSQL&lt;br&#x2F;&gt;Metadata DB]
    L[Redis&lt;br&#x2F;&gt;Cache Layer]
    M[Google Cloud Storage&lt;br&#x2F;&gt;File Storage]
end

subgraph &quot;External Services&quot;
    N[Notification Service]
    O[Audit Service]
    P[Monitoring]
end

A --&gt; D
B --&gt; D
C --&gt; D
D --&gt; E
E --&gt; F
F --&gt; G
F --&gt; H
G --&gt; I
H --&gt; I
G --&gt; J
I --&gt; K
I --&gt; L
J --&gt; M
G --&gt; M
H --&gt; M
I --&gt; N
I --&gt; O
G --&gt; P
H --&gt; P
</code>
</pre>

<h2 id="Core-Components-Deep-Dive"><a href="#Core-Components-Deep-Dive" class="headerlink" title="Core Components Deep Dive"></a>Core Components Deep Dive</h2><h3 id="File-Upload-Service"><a href="#File-Upload-Service" class="headerlink" title="File Upload Service"></a>File Upload Service</h3><p>The upload service handles both single-shot uploads and chunked uploads for large files, implementing resumable upload patterns for reliability.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/v1/files&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileUploadController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileUploadService fileUploadService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChunkManagerService chunkManagerService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileValidationService validationService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;FileUploadResponse&gt; <span class="title function_">uploadFile</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(value = &quot;projectId&quot;, required = false)</span> String projectId,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(value = &quot;metadata&quot;, required = false)</span> String metadata)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Validate file</span></span><br><span class="line">        validationService.validateFile(file);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Determine upload strategy</span></span><br><span class="line">        <span class="keyword">if</span> (file.getSize() &gt; MAX_SINGLE_UPLOAD_SIZE) &#123;</span><br><span class="line">            <span class="keyword">return</span> initiateChunkedUpload(file, projectId, metadata);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> uploadDirectly(file, projectId, metadata);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload/chunked/initiate&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;ChunkedUploadResponse&gt; <span class="title function_">initiateChunkedUpload</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestBody</span> ChunkedUploadRequest request)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">uploadId</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        <span class="type">ChunkedUploadSession</span> <span class="variable">session</span> <span class="operator">=</span> chunkManagerService.createUploadSession(</span><br><span class="line">            uploadId, request.getFileName(), request.getTotalSize(), </span><br><span class="line">            request.getChunkSize(), request.getProjectId()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(ChunkedUploadResponse.builder()</span><br><span class="line">            .uploadId(uploadId)</span><br><span class="line">            .totalChunks(session.getTotalChunks())</span><br><span class="line">            .chunkSize(session.getChunkSize())</span><br><span class="line">            .build());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PutMapping(&quot;/upload/chunked/&#123;uploadId&#125;/chunk/&#123;chunkNumber&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;ChunkUploadResponse&gt; <span class="title function_">uploadChunk</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String uploadId,</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> <span class="type">int</span> chunkNumber,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;chunk&quot;)</span> MultipartFile chunk)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">ChunkUploadResult</span> <span class="variable">result</span> <span class="operator">=</span> chunkManagerService.uploadChunk(</span><br><span class="line">            uploadId, chunkNumber, chunk</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (result.isComplete()) &#123;</span><br><span class="line">            <span class="comment">// All chunks uploaded, finalize the file</span></span><br><span class="line">            <span class="type">FileMetadata</span> <span class="variable">fileMetadata</span> <span class="operator">=</span> chunkManagerService.finalizeUpload(uploadId);</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.ok(ChunkUploadResponse.builder()</span><br><span class="line">                .chunkNumber(chunkNumber)</span><br><span class="line">                .completed(<span class="literal">true</span>)</span><br><span class="line">                .fileUrl(fileMetadata.getDownloadUrl())</span><br><span class="line">                .fileId(fileMetadata.getFileId())</span><br><span class="line">                .build());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(ChunkUploadResponse.builder()</span><br><span class="line">            .chunkNumber(chunkNumber)</span><br><span class="line">            .completed(<span class="literal">false</span>)</span><br><span class="line">            .build());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Chunk-Management-System"><a href="#Chunk-Management-System" class="headerlink" title="Chunk Management System"></a>Chunk Management System</h3><p>For files larger than 10MB, the system implements intelligent chunking with resumable uploads:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChunkManagerService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GcsService gcsService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileMetadataRepository metadataRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_CHUNK_SIZE</span> <span class="operator">=</span> <span class="number">5</span> * <span class="number">1024</span> * <span class="number">1024</span>; <span class="comment">// 5MB</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CHUNK_SESSION_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;chunk_session:&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ChunkedUploadSession <span class="title function_">createUploadSession</span><span class="params">(String uploadId, </span></span><br><span class="line"><span class="params">            String fileName, <span class="type">long</span> totalSize, <span class="type">int</span> chunkSize, String projectId)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> <span class="variable">totalChunks</span> <span class="operator">=</span> (<span class="type">int</span>) Math.ceil((<span class="type">double</span>) totalSize / chunkSize);</span><br><span class="line">        </span><br><span class="line">        <span class="type">ChunkedUploadSession</span> <span class="variable">session</span> <span class="operator">=</span> ChunkedUploadSession.builder()</span><br><span class="line">            .uploadId(uploadId)</span><br><span class="line">            .fileName(fileName)</span><br><span class="line">            .totalSize(totalSize)</span><br><span class="line">            .chunkSize(chunkSize)</span><br><span class="line">            .totalChunks(totalChunks)</span><br><span class="line">            .projectId(projectId)</span><br><span class="line">            .uploadedChunks(<span class="keyword">new</span> <span class="title class_">BitSet</span>(totalChunks))</span><br><span class="line">            .createdAt(Instant.now())</span><br><span class="line">            .expiresAt(Instant.now().plus(Duration.ofHours(<span class="number">24</span>)))</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Store session in Redis with TTL</span></span><br><span class="line">        redisTemplate.opsForValue().set(</span><br><span class="line">            CHUNK_SESSION_PREFIX + uploadId, </span><br><span class="line">            session, </span><br><span class="line">            Duration.ofHours(<span class="number">24</span>)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> session;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> ChunkUploadResult <span class="title function_">uploadChunk</span><span class="params">(String uploadId, <span class="type">int</span> chunkNumber, </span></span><br><span class="line"><span class="params">            MultipartFile chunk)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">ChunkedUploadSession</span> <span class="variable">session</span> <span class="operator">=</span> getUploadSession(uploadId);</span><br><span class="line">        <span class="keyword">if</span> (session == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UploadSessionNotFoundException</span>(<span class="string">&quot;Upload session not found: &quot;</span> + uploadId);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Validate chunk</span></span><br><span class="line">        validateChunk(session, chunkNumber, chunk);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Upload chunk to GCS with temporary naming</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">tempChunkPath</span> <span class="operator">=</span> generateTempChunkPath(uploadId, chunkNumber);</span><br><span class="line">        gcsService.uploadChunk(chunk.getInputStream(), tempChunkPath);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Update session state</span></span><br><span class="line">        session.getUploadedChunks().set(chunkNumber - <span class="number">1</span>);</span><br><span class="line">        updateUploadSession(session);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check if all chunks are uploaded</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isComplete</span> <span class="operator">=</span> session.getUploadedChunks().cardinality() == session.getTotalChunks();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ChunkUploadResult.builder()</span><br><span class="line">            .chunkNumber(chunkNumber)</span><br><span class="line">            .complete(isComplete)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> FileMetadata <span class="title function_">finalizeUpload</span><span class="params">(String uploadId)</span> &#123;</span><br><span class="line">        <span class="type">ChunkedUploadSession</span> <span class="variable">session</span> <span class="operator">=</span> getUploadSession(uploadId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Combine all chunks into final file</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">finalFilePath</span> <span class="operator">=</span> generateFinalFilePath(session);</span><br><span class="line">        List&lt;String&gt; chunkPaths = generateChunkPaths(uploadId, session.getTotalChunks());</span><br><span class="line">        </span><br><span class="line">        gcsService.combineChunks(chunkPaths, finalFilePath);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Create file metadata</span></span><br><span class="line">        <span class="type">FileMetadata</span> <span class="variable">metadata</span> <span class="operator">=</span> FileMetadata.builder()</span><br><span class="line">            .fileId(UUID.randomUUID().toString())</span><br><span class="line">            .originalFileName(session.getFileName())</span><br><span class="line">            .gcsPath(finalFilePath)</span><br><span class="line">            .fileSize(session.getTotalSize())</span><br><span class="line">            .projectId(session.getProjectId())</span><br><span class="line">            .uploadedAt(Instant.now())</span><br><span class="line">            .downloadUrl(gcsService.generateSignedUrl(finalFilePath, Duration.ofDays(<span class="number">365</span>)))</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        metadataRepository.save(metadata);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Clean up chunks and session</span></span><br><span class="line">        cleanupChunks(chunkPaths);</span><br><span class="line">        deleteUploadSession(uploadId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> metadata;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Database-Schema-Design"><a href="#Database-Schema-Design" class="headerlink" title="Database Schema Design"></a>Database Schema Design</h3><p>The PostgreSQL schema is optimized for query performance and supports file versioning:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Files table for storing file metadata</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> files (</span><br><span class="line">    file_id <span class="type">VARCHAR</span>(<span class="number">36</span>) <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    original_filename <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    content_type <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    file_size <span class="type">BIGINT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    gcs_bucket <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    gcs_path <span class="type">VARCHAR</span>(<span class="number">500</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    project_id <span class="type">VARCHAR</span>(<span class="number">36</span>),</span><br><span class="line">    upload_session_id <span class="type">VARCHAR</span>(<span class="number">36</span>),</span><br><span class="line">    checksum_md5 <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    checksum_sha256 <span class="type">VARCHAR</span>(<span class="number">64</span>),</span><br><span class="line">    encryption_key_id <span class="type">VARCHAR</span>(<span class="number">36</span>),</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">WITH</span> <span class="type">TIME</span> ZONE <span class="keyword">DEFAULT</span> NOW(),</span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span> <span class="keyword">WITH</span> <span class="type">TIME</span> ZONE <span class="keyword">DEFAULT</span> NOW(),</span><br><span class="line">    deleted_at <span class="type">TIMESTAMP</span> <span class="keyword">WITH</span> <span class="type">TIME</span> ZONE,</span><br><span class="line">    created_by <span class="type">VARCHAR</span>(<span class="number">36</span>),</span><br><span class="line">    tags JSONB,</span><br><span class="line">    metadata JSONB</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- File versions for supporting file versioning</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> file_versions (</span><br><span class="line">    version_id <span class="type">VARCHAR</span>(<span class="number">36</span>) <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    file_id <span class="type">VARCHAR</span>(<span class="number">36</span>) <span class="keyword">REFERENCES</span> files(file_id),</span><br><span class="line">    version_number <span class="type">INTEGER</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    gcs_path <span class="type">VARCHAR</span>(<span class="number">500</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    file_size <span class="type">BIGINT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    checksum_md5 <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">WITH</span> <span class="type">TIME</span> ZONE <span class="keyword">DEFAULT</span> NOW(),</span><br><span class="line">    created_by <span class="type">VARCHAR</span>(<span class="number">36</span>),</span><br><span class="line">    change_description TEXT</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Upload sessions for chunked uploads</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> upload_sessions (</span><br><span class="line">    session_id <span class="type">VARCHAR</span>(<span class="number">36</span>) <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    original_filename <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    total_size <span class="type">BIGINT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    chunk_size <span class="type">INTEGER</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    total_chunks <span class="type">INTEGER</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    uploaded_chunks_bitmap TEXT,</span><br><span class="line">    project_id <span class="type">VARCHAR</span>(<span class="number">36</span>),</span><br><span class="line">    status <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;IN_PROGRESS&#x27;</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">WITH</span> <span class="type">TIME</span> ZONE <span class="keyword">DEFAULT</span> NOW(),</span><br><span class="line">    expires_at <span class="type">TIMESTAMP</span> <span class="keyword">WITH</span> <span class="type">TIME</span> ZONE <span class="keyword">NOT NULL</span>,</span><br><span class="line">    created_by <span class="type">VARCHAR</span>(<span class="number">36</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Indexes for performance optimization</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_files_project_id <span class="keyword">ON</span> files(project_id);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_files_created_at <span class="keyword">ON</span> files(created_at);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_files_deleted_at <span class="keyword">ON</span> files(deleted_at) <span class="keyword">WHERE</span> deleted_at <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_files_tags <span class="keyword">ON</span> files <span class="keyword">USING</span> GIN(tags);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_file_versions_file_id <span class="keyword">ON</span> file_versions(file_id);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_upload_sessions_expires_at <span class="keyword">ON</span> upload_sessions(expires_at);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Partitioning for large datasets (optional)</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> files_2024 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> files</span><br><span class="line">    <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="string">&#x27;2024-01-01&#x27;</span>) <span class="keyword">TO</span> (<span class="string">&#x27;2025-01-01&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="GCS-Integration-Service"><a href="#GCS-Integration-Service" class="headerlink" title="GCS Integration Service"></a>GCS Integration Service</h3><p>The GCS service handles actual file storage with intelligent lifecycle management:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GcsService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Storage storage;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String bucketName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String cdnDomain;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Duration</span> <span class="variable">DEFAULT_SIGNED_URL_DURATION</span> <span class="operator">=</span> Duration.ofHours(<span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">uploadFile</span><span class="params">(InputStream inputStream, String fileName, </span></span><br><span class="line"><span class="params">            String contentType, Map&lt;String, String&gt; metadata)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">gcsPath</span> <span class="operator">=</span> generateGcsPath(fileName);</span><br><span class="line">        </span><br><span class="line">        <span class="type">BlobId</span> <span class="variable">blobId</span> <span class="operator">=</span> BlobId.of(bucketName, gcsPath);</span><br><span class="line">        BlobInfo.<span class="type">Builder</span> <span class="variable">blobInfoBuilder</span> <span class="operator">=</span> BlobInfo.newBuilder(blobId)</span><br><span class="line">            .setContentType(contentType)</span><br><span class="line">            .setCacheControl(<span class="string">&quot;public, max-age=31536000&quot;</span>); <span class="comment">// 1 year cache</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Add custom metadata</span></span><br><span class="line">        <span class="keyword">if</span> (metadata != <span class="literal">null</span>) &#123;</span><br><span class="line">            blobInfoBuilder.setMetadata(metadata);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Set storage class based on file characteristics</span></span><br><span class="line">        <span class="type">StorageClass</span> <span class="variable">storageClass</span> <span class="operator">=</span> determineStorageClass(fileName, metadata);</span><br><span class="line">        blobInfoBuilder.setStorageClass(storageClass);</span><br><span class="line">        </span><br><span class="line">        <span class="type">BlobInfo</span> <span class="variable">blobInfo</span> <span class="operator">=</span> blobInfoBuilder.build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Blob</span> <span class="variable">blob</span> <span class="operator">=</span> storage.create(blobInfo, inputStream);</span><br><span class="line">            <span class="keyword">return</span> blob.getName();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileStorageException</span>(<span class="string">&quot;Failed to upload file to GCS&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generateSignedUrl</span><span class="params">(String gcsPath, Duration duration)</span> &#123;</span><br><span class="line">        <span class="type">BlobId</span> <span class="variable">blobId</span> <span class="operator">=</span> BlobId.of(bucketName, gcsPath);</span><br><span class="line">        </span><br><span class="line">        <span class="type">URL</span> <span class="variable">signedUrl</span> <span class="operator">=</span> storage.signUrl(</span><br><span class="line">            BlobInfo.newBuilder(blobId).build(),</span><br><span class="line">            duration.toMillis(),</span><br><span class="line">            TimeUnit.MILLISECONDS,</span><br><span class="line">            Storage.SignUrlOption.httpMethod(HttpMethod.GET)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> signedUrl.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">combineChunks</span><span class="params">(List&lt;String&gt; chunkPaths, String finalPath)</span> &#123;</span><br><span class="line">        <span class="type">BlobId</span> <span class="variable">finalBlobId</span> <span class="operator">=</span> BlobId.of(bucketName, finalPath);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Use GCS compose operation for efficient chunk combination</span></span><br><span class="line">        Storage.ComposeRequest.<span class="type">Builder</span> <span class="variable">composeBuilder</span> <span class="operator">=</span> Storage.ComposeRequest.newBuilder()</span><br><span class="line">            .setTarget(BlobInfo.newBuilder(finalBlobId).build());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String chunkPath : chunkPaths) &#123;</span><br><span class="line">            <span class="type">BlobId</span> <span class="variable">chunkBlobId</span> <span class="operator">=</span> BlobId.of(bucketName, chunkPath);</span><br><span class="line">            composeBuilder.addSource(chunkBlobId);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        storage.compose(composeBuilder.build());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> StorageClass <span class="title function_">determineStorageClass</span><span class="params">(String fileName, Map&lt;String, String&gt; metadata)</span> &#123;</span><br><span class="line">        <span class="comment">// Intelligent storage class selection based on file type and metadata</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileExtension</span> <span class="operator">=</span> getFileExtension(fileName);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Archive files go to coldline storage</span></span><br><span class="line">        <span class="keyword">if</span> (isArchiveFile(fileExtension)) &#123;</span><br><span class="line">            <span class="keyword">return</span> StorageClass.COLDLINE;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Frequently accessed files use standard storage</span></span><br><span class="line">        <span class="keyword">return</span> StorageClass.STANDARD;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Lifecycle management</span></span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0 2 * * *&quot;)</span> <span class="comment">// Daily at 2 AM</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">optimizeStorageClasses</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Move infrequently accessed files to cheaper storage classes</span></span><br><span class="line">        <span class="comment">// This could be based on access patterns, file age, etc.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="File-Storage-SDK-Design"><a href="#File-Storage-SDK-Design" class="headerlink" title="File Storage SDK Design"></a>File Storage SDK Design</h2><p>The SDK provides a clean, intuitive interface for client applications:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageClient</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String baseUrl;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String apiKey;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OkHttpClient httpClient;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectMapper objectMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FileStorageClient</span><span class="params">(String baseUrl, String apiKey)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.baseUrl = baseUrl;</span><br><span class="line">        <span class="built_in">this</span>.apiKey = apiKey;</span><br><span class="line">        <span class="built_in">this</span>.httpClient = createHttpClient();</span><br><span class="line">        <span class="built_in">this</span>.objectMapper = <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Upload a single file</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> FileUploadResult <span class="title function_">uploadFile</span><span class="params">(File file, UploadOptions options)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (file.length() &gt; options.getChunkThreshold()) &#123;</span><br><span class="line">            <span class="keyword">return</span> uploadFileChunked(file, options);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> uploadFileDirect(file, options);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Upload file with progress callback</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> FileUploadResult <span class="title function_">uploadFile</span><span class="params">(File file, UploadOptions options, </span></span><br><span class="line"><span class="params">            ProgressCallback progressCallback)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> uploadFileChunked(file, options, progressCallback);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Download file by ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> InputStream <span class="title function_">downloadFile</span><span class="params">(String fileId)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">FileMetadata</span> <span class="variable">metadata</span> <span class="operator">=</span> getFileMetadata(fileId);</span><br><span class="line">        <span class="keyword">return</span> downloadFileByUrl(metadata.getDownloadUrl());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get file metadata</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> FileMetadata <span class="title function_">getFileMetadata</span><span class="params">(String fileId)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">            .url(baseUrl + <span class="string">&quot;/api/v1/files/&quot;</span> + fileId + <span class="string">&quot;/metadata&quot;</span>)</span><br><span class="line">            .addHeader(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;Bearer &quot;</span> + apiKey)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> httpClient.newCall(request).execute()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!response.isSuccessful()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;Failed to get file metadata: &quot;</span> + response.code());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> objectMapper.readValue(response.body().string(), FileMetadata.class);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * List files with pagination and filtering</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> PagedResult&lt;FileMetadata&gt; <span class="title function_">listFiles</span><span class="params">(FileQuery query)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        HttpUrl.<span class="type">Builder</span> <span class="variable">urlBuilder</span> <span class="operator">=</span> HttpUrl.parse(baseUrl + <span class="string">&quot;/api/v1/files&quot;</span>).newBuilder();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (query.getProjectId() != <span class="literal">null</span>) &#123;</span><br><span class="line">            urlBuilder.addQueryParameter(<span class="string">&quot;projectId&quot;</span>, query.getProjectId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (query.getFileType() != <span class="literal">null</span>) &#123;</span><br><span class="line">            urlBuilder.addQueryParameter(<span class="string">&quot;fileType&quot;</span>, query.getFileType());</span><br><span class="line">        &#125;</span><br><span class="line">        urlBuilder.addQueryParameter(<span class="string">&quot;page&quot;</span>, String.valueOf(query.getPage()));</span><br><span class="line">        urlBuilder.addQueryParameter(<span class="string">&quot;size&quot;</span>, String.valueOf(query.getSize()));</span><br><span class="line">        </span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">            .url(urlBuilder.build())</span><br><span class="line">            .addHeader(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;Bearer &quot;</span> + apiKey)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> httpClient.newCall(request).execute()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!response.isSuccessful()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;Failed to list files: &quot;</span> + response.code());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            TypeReference&lt;PagedResult&lt;FileMetadata&gt;&gt; typeRef = </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;PagedResult&lt;FileMetadata&gt;&gt;() &#123;&#125;;</span><br><span class="line">            <span class="keyword">return</span> objectMapper.readValue(response.body().string(), typeRef);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Delete file (soft delete)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteFile</span><span class="params">(String fileId)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">            .url(baseUrl + <span class="string">&quot;/api/v1/files/&quot;</span> + fileId)</span><br><span class="line">            .delete()</span><br><span class="line">            .addHeader(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;Bearer &quot;</span> + apiKey)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> httpClient.newCall(request).execute()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!response.isSuccessful()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;Failed to delete file: &quot;</span> + response.code());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> FileUploadResult <span class="title function_">uploadFileChunked</span><span class="params">(File file, UploadOptions options, </span></span><br><span class="line"><span class="params">            ProgressCallback progressCallback)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Initiate chunked upload</span></span><br><span class="line">            <span class="type">ChunkedUploadResponse</span> <span class="variable">initResponse</span> <span class="operator">=</span> initiateChunkedUpload(file, options);</span><br><span class="line">            </span><br><span class="line">            <span class="type">long</span> <span class="variable">uploadedBytes</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">chunkSize</span> <span class="operator">=</span> initResponse.getChunkSize();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> (<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file)) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">chunkNumber</span> <span class="operator">=</span> <span class="number">1</span>; chunkNumber &lt;= initResponse.getTotalChunks(); chunkNumber++) &#123;</span><br><span class="line">                    <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[Math.min(chunkSize, (<span class="type">int</span>) (file.length() - uploadedBytes))];</span><br><span class="line">                    <span class="type">int</span> <span class="variable">bytesRead</span> <span class="operator">=</span> fis.read(buffer);</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (bytesRead &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        uploadChunk(initResponse.getUploadId(), chunkNumber, </span><br><span class="line">                            Arrays.copyOf(buffer, bytesRead));</span><br><span class="line">                        uploadedBytes += bytesRead;</span><br><span class="line">                        </span><br><span class="line">                        <span class="keyword">if</span> (progressCallback != <span class="literal">null</span>) &#123;</span><br><span class="line">                            progressCallback.onProgress(uploadedBytes, file.length());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// All chunks uploaded successfully</span></span><br><span class="line">            <span class="keyword">return</span> FileUploadResult.builder()</span><br><span class="line">                .fileId(initResponse.getFinalFileId())</span><br><span class="line">                .downloadUrl(initResponse.getFinalDownloadUrl())</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileUploadException</span>(<span class="string">&quot;Failed to upload file&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Security-Implementation"><a href="#Security-Implementation" class="headerlink" title="Security Implementation"></a>Security Implementation</h2><h3 id="Authentication-and-Authorization"><a href="#Authentication-and-Authorization" class="headerlink" title="Authentication and Authorization"></a>Authentication and Authorization</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileAccessSecurityService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtTokenProvider tokenProvider;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserService userService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ProjectService projectService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">canAccessFile</span><span class="params">(String userId, String fileId, FileOperation operation)</span> &#123;</span><br><span class="line">        <span class="type">FileMetadata</span> <span class="variable">fileMetadata</span> <span class="operator">=</span> getFileMetadata(fileId);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getUser(userId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check project-level permissions</span></span><br><span class="line">        <span class="keyword">if</span> (fileMetadata.getProjectId() != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">ProjectPermission</span> <span class="variable">permission</span> <span class="operator">=</span> projectService.getUserPermission(</span><br><span class="line">                userId, fileMetadata.getProjectId()</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> hasRequiredPermission(permission, operation);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check file-level permissions</span></span><br><span class="line">        <span class="keyword">return</span> fileMetadata.getCreatedBy().equals(userId) || user.isAdmin();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;@fileAccessSecurityService.canAccessFile(authentication.name, #fileId, &#x27;READ&#x27;)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> FileMetadata <span class="title function_">getFile</span><span class="params">(String fileId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fileMetadataRepository.findById(fileId)</span><br><span class="line">            .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">FileNotFoundException</span>(<span class="string">&quot;File not found: &quot;</span> + fileId));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">hasRequiredPermission</span><span class="params">(ProjectPermission permission, FileOperation operation)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (operation) &#123;</span><br><span class="line">            <span class="keyword">case</span> READ:</span><br><span class="line">                <span class="keyword">return</span> permission.canRead();</span><br><span class="line">            <span class="keyword">case</span> WRITE:</span><br><span class="line">                <span class="keyword">return</span> permission.canWrite();</span><br><span class="line">            <span class="keyword">case</span> DELETE:</span><br><span class="line">                <span class="keyword">return</span> permission.canDelete();</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="File-Encryption"><a href="#File-Encryption" class="headerlink" title="File Encryption"></a>File Encryption</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileEncryptionService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GoogleKmsService kmsService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String keyRingName;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> EncryptedUploadStream <span class="title function_">encryptFile</span><span class="params">(InputStream inputStream, String fileId)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Generate data encryption key (DEK)</span></span><br><span class="line">            <span class="type">byte</span>[] dek = generateDataEncryptionKey();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Encrypt DEK with KEK (Key Encryption Key) using Google KMS</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">encryptedDek</span> <span class="operator">=</span> kmsService.encrypt(keyRingName, dek);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Create cipher for file encryption</span></span><br><span class="line">            <span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;AES/GCM/NoPadding&quot;</span>);</span><br><span class="line">            <span class="type">SecretKeySpec</span> <span class="variable">keySpec</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(dek, <span class="string">&quot;AES&quot;</span>);</span><br><span class="line">            cipher.init(Cipher.ENCRYPT_MODE, keySpec);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Store encryption metadata</span></span><br><span class="line">            <span class="type">FileEncryptionMetadata</span> <span class="variable">encryptionMetadata</span> <span class="operator">=</span> FileEncryptionMetadata.builder()</span><br><span class="line">                .fileId(fileId)</span><br><span class="line">                .encryptedDek(encryptedDek)</span><br><span class="line">                .algorithm(<span class="string">&quot;AES-256-GCM&quot;</span>)</span><br><span class="line">                .keyVersion(kmsService.getCurrentKeyVersion())</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">EncryptedUploadStream</span>(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">CipherInputStream</span>(inputStream, cipher),</span><br><span class="line">                encryptionMetadata</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">EncryptionException</span>(<span class="string">&quot;Failed to encrypt file&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> InputStream <span class="title function_">decryptFile</span><span class="params">(InputStream encryptedStream, String fileId)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">FileEncryptionMetadata</span> <span class="variable">metadata</span> <span class="operator">=</span> getEncryptionMetadata(fileId);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Decrypt DEK using KMS</span></span><br><span class="line">            <span class="type">byte</span>[] dek = kmsService.decrypt(metadata.getEncryptedDek());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Create cipher for decryption</span></span><br><span class="line">            <span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;AES/GCM/NoPadding&quot;</span>);</span><br><span class="line">            <span class="type">SecretKeySpec</span> <span class="variable">keySpec</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(dek, <span class="string">&quot;AES&quot;</span>);</span><br><span class="line">            cipher.init(Cipher.DECRYPT_MODE, keySpec);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CipherInputStream</span>(encryptedStream, cipher);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DecryptionException</span>(<span class="string">&quot;Failed to decrypt file&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Optimization-Strategies"><a href="#Performance-Optimization-Strategies" class="headerlink" title="Performance Optimization Strategies"></a>Performance Optimization Strategies</h2><h3 id="Caching-Layer-Implementation"><a href="#Caching-Layer-Implementation" class="headerlink" title="Caching Layer Implementation"></a>Caching Layer Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileCacheService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GcsService gcsService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FILE_METADATA_CACHE_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;file_metadata:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FILE_CONTENT_CACHE_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;file_content:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Duration</span> <span class="variable">METADATA_TTL</span> <span class="operator">=</span> Duration.ofHours(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Duration</span> <span class="variable">SMALL_FILE_TTL</span> <span class="operator">=</span> Duration.ofMinutes(<span class="number">30</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Cacheable(value = &quot;file_metadata&quot;, key = &quot;#fileId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> FileMetadata <span class="title function_">getFileMetadata</span><span class="params">(String fileId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cacheKey</span> <span class="operator">=</span> FILE_METADATA_CACHE_PREFIX + fileId;</span><br><span class="line">        </span><br><span class="line">        <span class="type">FileMetadata</span> <span class="variable">cached</span> <span class="operator">=</span> (FileMetadata) redisTemplate.opsForValue().get(cacheKey);</span><br><span class="line">        <span class="keyword">if</span> (cached != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> cached;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">FileMetadata</span> <span class="variable">metadata</span> <span class="operator">=</span> fileMetadataRepository.findById(fileId)</span><br><span class="line">            .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">FileNotFoundException</span>(<span class="string">&quot;File not found: &quot;</span> + fileId));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Cache metadata</span></span><br><span class="line">        redisTemplate.opsForValue().set(cacheKey, metadata, METADATA_TTL);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> metadata;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> InputStream <span class="title function_">getFileContent</span><span class="params">(String fileId)</span> &#123;</span><br><span class="line">        <span class="type">FileMetadata</span> <span class="variable">metadata</span> <span class="operator">=</span> getFileMetadata(fileId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Cache small files (&lt; 1MB) in Redis</span></span><br><span class="line">        <span class="keyword">if</span> (metadata.getFileSize() &lt; <span class="number">1024</span> * <span class="number">1024</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">cacheKey</span> <span class="operator">=</span> FILE_CONTENT_CACHE_PREFIX + fileId;</span><br><span class="line">            <span class="type">byte</span>[] cachedContent = (<span class="type">byte</span>[]) redisTemplate.opsForValue().get(cacheKey);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (cachedContent != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(cachedContent);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Load from GCS and cache</span></span><br><span class="line">            <span class="type">byte</span>[] content = gcsService.downloadFileAsBytes(metadata.getGcsPath());</span><br><span class="line">            redisTemplate.opsForValue().set(cacheKey, content, SMALL_FILE_TTL);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(content);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Large files: direct stream from GCS</span></span><br><span class="line">        <span class="keyword">return</span> gcsService.downloadFile(metadata.getGcsPath());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Database-Query-Optimization"><a href="#Database-Query-Optimization" class="headerlink" title="Database Query Optimization"></a>Database Query Optimization</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileMetadataRepository</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PersistenceContext</span></span><br><span class="line">    <span class="keyword">private</span> EntityManager entityManager;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Optimized query for file listing with filtering and pagination</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Page&lt;FileMetadata&gt; <span class="title function_">findFilesWithFilters</span><span class="params">(FileSearchCriteria criteria, </span></span><br><span class="line"><span class="params">            Pageable pageable)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">CriteriaBuilder</span> <span class="variable">cb</span> <span class="operator">=</span> entityManager.getCriteriaBuilder();</span><br><span class="line">        CriteriaQuery&lt;FileMetadata&gt; query = cb.createQuery(FileMetadata.class);</span><br><span class="line">        Root&lt;FileMetadata&gt; root = query.from(FileMetadata.class);</span><br><span class="line">        </span><br><span class="line">        List&lt;Predicate&gt; predicates = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Active files only (not soft deleted)</span></span><br><span class="line">        predicates.add(cb.isNull(root.get(<span class="string">&quot;deletedAt&quot;</span>)));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Project filter</span></span><br><span class="line">        <span class="keyword">if</span> (criteria.getProjectId() != <span class="literal">null</span>) &#123;</span><br><span class="line">            predicates.add(cb.equal(root.get(<span class="string">&quot;projectId&quot;</span>), criteria.getProjectId()));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Content type filter</span></span><br><span class="line">        <span class="keyword">if</span> (criteria.getContentType() != <span class="literal">null</span>) &#123;</span><br><span class="line">            predicates.add(cb.like(root.get(<span class="string">&quot;contentType&quot;</span>), criteria.getContentType() + <span class="string">&quot;%&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// File size range filter</span></span><br><span class="line">        <span class="keyword">if</span> (criteria.getMinSize() != <span class="literal">null</span>) &#123;</span><br><span class="line">            predicates.add(cb.greaterThanOrEqualTo(root.get(<span class="string">&quot;fileSize&quot;</span>), criteria.getMinSize()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (criteria.getMaxSize() != <span class="literal">null</span>) &#123;</span><br><span class="line">            predicates.add(cb.lessThanOrEqualTo(root.get(<span class="string">&quot;fileSize&quot;</span>), criteria.getMaxSize()));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Date range filter</span></span><br><span class="line">        <span class="keyword">if</span> (criteria.getCreatedAfter() != <span class="literal">null</span>) &#123;</span><br><span class="line">            predicates.add(cb.greaterThanOrEqualTo(root.get(<span class="string">&quot;createdAt&quot;</span>), criteria.getCreatedAfter()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (criteria.getCreatedBefore() != <span class="literal">null</span>) &#123;</span><br><span class="line">            predicates.add(cb.lessThanOrEqualTo(root.get(<span class="string">&quot;createdAt&quot;</span>), criteria.getCreatedBefore()));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Tags filter (using JSONB operations)</span></span><br><span class="line">        <span class="keyword">if</span> (criteria.getTags() != <span class="literal">null</span> &amp;&amp; !criteria.getTags().isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String tag : criteria.getTags()) &#123;</span><br><span class="line">                predicates.add(cb.isTrue(</span><br><span class="line">                    cb.function(<span class="string">&quot;jsonb_exists&quot;</span>, Boolean.class, root.get(<span class="string">&quot;tags&quot;</span>), cb.literal(tag))</span><br><span class="line">                ));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        query.where(predicates.toArray(<span class="keyword">new</span> <span class="title class_">Predicate</span>[<span class="number">0</span>]));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Default ordering by creation date (newest first)</span></span><br><span class="line">        query.orderBy(cb.desc(root.get(<span class="string">&quot;createdAt&quot;</span>)));</span><br><span class="line">        </span><br><span class="line">        TypedQuery&lt;FileMetadata&gt; typedQuery = entityManager.createQuery(query);</span><br><span class="line">        typedQuery.setFirstResult((<span class="type">int</span>) pageable.getOffset());</span><br><span class="line">        typedQuery.setMaxResults(pageable.getPageSize());</span><br><span class="line">        </span><br><span class="line">        List&lt;FileMetadata&gt; results = typedQuery.getResultList();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Count query for pagination</span></span><br><span class="line">        CriteriaQuery&lt;Long&gt; countQuery = cb.createQuery(Long.class);</span><br><span class="line">        Root&lt;FileMetadata&gt; countRoot = countQuery.from(FileMetadata.class);</span><br><span class="line">        countQuery.select(cb.count(countRoot));</span><br><span class="line">        countQuery.where(predicates.toArray(<span class="keyword">new</span> <span class="title class_">Predicate</span>[<span class="number">0</span>]));</span><br><span class="line">        </span><br><span class="line">        <span class="type">Long</span> <span class="variable">totalCount</span> <span class="operator">=</span> entityManager.createQuery(countQuery).getSingleResult();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageImpl</span>&lt;&gt;(results, pageable, totalCount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Monitoring-and-Observability"><a href="#Monitoring-and-Observability" class="headerlink" title="Monitoring and Observability"></a>Monitoring and Observability</h2><h3 id="Comprehensive-Monitoring-Setup"><a href="#Comprehensive-Monitoring-Setup" class="headerlink" title="Comprehensive Monitoring Setup"></a>Comprehensive Monitoring Setup</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageMetrics</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Timer uploadTimer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Timer downloadTimer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter uploadSuccessCounter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter uploadFailureCounter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Gauge activeUploadsGauge;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FileStorageMetrics</span><span class="params">(MeterRegistry meterRegistry)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.meterRegistry = meterRegistry;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">this</span>.uploadTimer = Timer.builder(<span class="string">&quot;file_upload_duration&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Time taken to upload files&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;service&quot;</span>, <span class="string">&quot;file-storage&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.downloadTimer = Timer.builder(<span class="string">&quot;file_download_duration&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Time taken to download files&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;service&quot;</span>, <span class="string">&quot;file-storage&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.uploadSuccessCounter = Counter.builder(<span class="string">&quot;file_upload_success_total&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Total number of successful file uploads&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;service&quot;</span>, <span class="string">&quot;file-storage&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.uploadFailureCounter = Counter.builder(<span class="string">&quot;file_upload_failure_total&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Total number of failed file uploads&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;service&quot;</span>, <span class="string">&quot;file-storage&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.activeUploadsGauge = Gauge.builder(<span class="string">&quot;file_upload_active_count&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Number of currently active uploads&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;service&quot;</span>, <span class="string">&quot;file-storage&quot;</span>)</span><br><span class="line">            .register(meterRegistry, <span class="built_in">this</span>, FileStorageMetrics::getActiveUploadsCount);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordUploadSuccess</span><span class="params">(String fileType, <span class="type">long</span> fileSizeBytes, Duration duration)</span> &#123;</span><br><span class="line">        uploadSuccessCounter.increment(</span><br><span class="line">            Tags.of(</span><br><span class="line">                <span class="string">&quot;file_type&quot;</span>, fileType,</span><br><span class="line">                <span class="string">&quot;size_category&quot;</span>, categorizeFileSize(fileSizeBytes)</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        uploadTimer.record(duration);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Record file size distribution</span></span><br><span class="line">        DistributionSummary.builder(<span class="string">&quot;file_upload_size_bytes&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;file_type&quot;</span>, fileType)</span><br><span class="line">            .register(meterRegistry)</span><br><span class="line">            .record(fileSizeBytes);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordUploadFailure</span><span class="params">(String fileType, String errorType, Duration duration)</span> &#123;</span><br><span class="line">        uploadFailureCounter.increment(</span><br><span class="line">            Tags.of(</span><br><span class="line">                <span class="string">&quot;file_type&quot;</span>, fileType,</span><br><span class="line">                <span class="string">&quot;error_type&quot;</span>, errorType</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">categorizeFileSize</span><span class="params">(<span class="type">long</span> sizeBytes)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (sizeBytes &lt; <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="string">&quot;small&quot;</span>;      <span class="comment">// &lt; 1MB</span></span><br><span class="line">        <span class="keyword">if</span> (sizeBytes &lt; <span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="string">&quot;medium&quot;</span>; <span class="comment">// &lt; 10MB</span></span><br><span class="line">        <span class="keyword">if</span> (sizeBytes &lt; <span class="number">100</span> * <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="string">&quot;large&quot;</span>; <span class="comment">// &lt; 100MB</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;xlarge&quot;</span>; <span class="comment">// &gt;= 100MB</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> <span class="title function_">getActiveUploadsCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Implementation to get current active upload count</span></span><br><span class="line">        <span class="keyword">return</span> uploadSessionService.getActiveUploadCount();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Health Check Implementation</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageHealthIndicator</span> <span class="keyword">implements</span> <span class="title class_">HealthIndicator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GcsService gcsService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataSource dataSource;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Health <span class="title function_">health</span><span class="params">()</span> &#123;</span><br><span class="line">        Health.<span class="type">Builder</span> <span class="variable">healthBuilder</span> <span class="operator">=</span> Health.up();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check PostgreSQL connectivity</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!connection.isValid(<span class="number">5</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> Health.down()</span><br><span class="line">                    .withDetail(<span class="string">&quot;database&quot;</span>, <span class="string">&quot;Connection validation failed&quot;</span>)</span><br><span class="line">                    .build();</span><br><span class="line">            &#125;</span><br><span class="line">            healthBuilder.withDetail(<span class="string">&quot;database&quot;</span>, <span class="string">&quot;UP&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> Health.down()</span><br><span class="line">                .withDetail(<span class="string">&quot;database&quot;</span>, <span class="string">&quot;Connection failed: &quot;</span> + e.getMessage())</span><br><span class="line">                .build();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check Redis connectivity</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.execute((RedisCallback&lt;String&gt;) connection -&gt; &#123;</span><br><span class="line">                connection.ping();</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;PONG&quot;</span>;</span><br><span class="line">            &#125;);</span><br><span class="line">            healthBuilder.withDetail(<span class="string">&quot;redis&quot;</span>, <span class="string">&quot;UP&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            healthBuilder.withDetail(<span class="string">&quot;redis&quot;</span>, <span class="string">&quot;DOWN: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check GCS connectivity</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">gcsHealthy</span> <span class="operator">=</span> gcsService.checkHealth();</span><br><span class="line">            healthBuilder.withDetail(<span class="string">&quot;gcs&quot;</span>, gcsHealthy ? <span class="string">&quot;UP&quot;</span> : <span class="string">&quot;DOWN&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!gcsHealthy) &#123;</span><br><span class="line">                <span class="keyword">return</span> healthBuilder.down().build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> Health.down()</span><br><span class="line">                .withDetail(<span class="string">&quot;gcs&quot;</span>, <span class="string">&quot;Health check failed: &quot;</span> + e.getMessage())</span><br><span class="line">                .build();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> healthBuilder.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Error-Handling-and-Resilience"><a href="#Error-Handling-and-Resilience" class="headerlink" title="Error Handling and Resilience"></a>Error Handling and Resilience</h2><h3 id="Comprehensive-Error-Handling-Strategy"><a href="#Comprehensive-Error-Handling-Strategy" class="headerlink" title="Comprehensive Error Handling Strategy"></a>Comprehensive Error Handling Strategy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageExceptionHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(FileStorageExceptionHandler.class);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler(FileNotFoundException.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.NOT_FOUND)</span></span><br><span class="line">    <span class="keyword">public</span> ErrorResponse <span class="title function_">handleFileNotFound</span><span class="params">(FileNotFoundException e)</span> &#123;</span><br><span class="line">        logger.warn(<span class="string">&quot;File not found: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> ErrorResponse.builder()</span><br><span class="line">            .code(<span class="string">&quot;FILE_NOT_FOUND&quot;</span>)</span><br><span class="line">            .message(<span class="string">&quot;The requested file was not found&quot;</span>)</span><br><span class="line">            .timestamp(Instant.now())</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler(FileSizeExceededException.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.PAYLOAD_TOO_LARGE)</span></span><br><span class="line">    <span class="keyword">public</span> ErrorResponse <span class="title function_">handleFileSizeExceeded</span><span class="params">(FileSizeExceededException e)</span> &#123;</span><br><span class="line">        logger.warn(<span class="string">&quot;File size exceeded: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> ErrorResponse.builder()</span><br><span class="line">            .code(<span class="string">&quot;FILE_SIZE_EXCEEDED&quot;</span>)</span><br><span class="line">            .message(<span class="string">&quot;File size exceeds the maximum allowed limit&quot;</span>)</span><br><span class="line">            .details(Map.of(<span class="string">&quot;maxSize&quot;</span>, e.getMaxAllowedSize(), <span class="string">&quot;actualSize&quot;</span>, e.getActualSize()))</span><br><span class="line">            .timestamp(Instant.now())</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler(UnsupportedFileTypeException.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.UNSUPPORTED_MEDIA_TYPE)</span></span><br><span class="line">    <span class="keyword">public</span> ErrorResponse <span class="title function_">handleUnsupportedFileType</span><span class="params">(UnsupportedFileTypeException e)</span> &#123;</span><br><span class="line">        logger.warn(<span class="string">&quot;Unsupported file type: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> ErrorResponse.builder()</span><br><span class="line">            .code(<span class="string">&quot;UNSUPPORTED_FILE_TYPE&quot;</span>)</span><br><span class="line">            .message(<span class="string">&quot;The file type is not supported&quot;</span>)</span><br><span class="line">            .details(Map.of(<span class="string">&quot;supportedTypes&quot;</span>, e.getSupportedTypes()))</span><br><span class="line">            .timestamp(Instant.now())</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler(StorageException.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line">    <span class="keyword">public</span> ErrorResponse <span class="title function_">handleStorageException</span><span class="params">(StorageException e)</span> &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;Storage operation failed&quot;</span>, e);</span><br><span class="line">        <span class="keyword">return</span> ErrorResponse.builder()</span><br><span class="line">            .code(<span class="string">&quot;STORAGE_ERROR&quot;</span>)</span><br><span class="line">            .message(<span class="string">&quot;An error occurred while processing the file&quot;</span>)</span><br><span class="line">            .timestamp(Instant.now())</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler(RateLimitExceededException.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.TOO_MANY_REQUESTS)</span></span><br><span class="line">    <span class="keyword">public</span> ErrorResponse <span class="title function_">handleRateLimit</span><span class="params">(RateLimitExceededException e)</span> &#123;</span><br><span class="line">        logger.warn(<span class="string">&quot;Rate limit exceeded for user: &#123;&#125;&quot;</span>, e.getUserId());</span><br><span class="line">        <span class="keyword">return</span> ErrorResponse.builder()</span><br><span class="line">            .code(<span class="string">&quot;RATE_LIMIT_EXCEEDED&quot;</span>)</span><br><span class="line">            .message(<span class="string">&quot;Upload rate limit exceeded&quot;</span>)</span><br><span class="line">            .details(Map.of(<span class="string">&quot;retryAfter&quot;</span>, e.getRetryAfterSeconds()))</span><br><span class="line">            .timestamp(Instant.now())</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Retry Mechanism for GCS Operations</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResilientGcsService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Storage storage;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RetryTemplate retryTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CircuitBreaker circuitBreaker;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ResilientGcsService</span><span class="params">(Storage storage)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.storage = storage;</span><br><span class="line">        <span class="built_in">this</span>.retryTemplate = createRetryTemplate();</span><br><span class="line">        <span class="built_in">this</span>.circuitBreaker = createCircuitBreaker();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Retryable(value = &#123;StorageException.class&#125;, maxAttempts = 3, </span></span><br><span class="line"><span class="meta">               backoff = @Backoff(delay = 1000, multiplier = 2))</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">uploadWithRetry</span><span class="params">(InputStream inputStream, String path, String contentType)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> circuitBreaker.executeSupplier(() -&gt; </span><br><span class="line">            retryTemplate.execute(context -&gt; &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;Attempting upload, attempt: &#123;&#125;&quot;</span>, context.getRetryCount() + <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">return</span> doUpload(inputStream, path, contentType);</span><br><span class="line">            &#125;)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> RetryTemplate <span class="title function_">createRetryTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">RetryTemplate</span> <span class="variable">template</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RetryTemplate</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="type">FixedBackOffPolicy</span> <span class="variable">backOffPolicy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FixedBackOffPolicy</span>();</span><br><span class="line">        backOffPolicy.setBackOffPeriod(<span class="number">2000</span>); <span class="comment">// 2 seconds</span></span><br><span class="line">        template.setBackOffPolicy(backOffPolicy);</span><br><span class="line">        </span><br><span class="line">        <span class="type">SimpleRetryPolicy</span> <span class="variable">retryPolicy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleRetryPolicy</span>();</span><br><span class="line">        retryPolicy.setMaxAttempts(<span class="number">3</span>);</span><br><span class="line">        template.setRetryPolicy(retryPolicy);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> CircuitBreaker <span class="title function_">createCircuitBreaker</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CircuitBreaker.ofDefaults(<span class="string">&quot;gcs-upload&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Production-Deployment-Architecture"><a href="#Production-Deployment-Architecture" class="headerlink" title="Production Deployment Architecture"></a>Production Deployment Architecture</h2><h3 id="Kubernetes-Deployment-Configuration"><a href="#Kubernetes-Deployment-Configuration" class="headerlink" title="Kubernetes Deployment Configuration"></a>Kubernetes Deployment Configuration</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># file-storage-deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">file-storage-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">file-storage-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">file-storage-service</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">file-storage-service</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">file-storage-service</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">file-storage-service:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_PROFILES_ACTIVE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;production&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DATABASE_URL</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">file-storage-secrets</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">database-url</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">REDIS_URL</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">file-storage-secrets</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">redis-url</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GCS_BUCKET_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">file-storage-config</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">gcs-bucket-name</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;512Mi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/actuator/health</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">30</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/actuator/health/readiness</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gcs-key</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">&quot;/etc/gcs&quot;</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gcs-key</span></span><br><span class="line">        <span class="attr">secret:</span></span><br><span class="line">          <span class="attr">secretName:</span> <span class="string">gcs-service-account-key</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">file-storage-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">file-storage-service</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">file-storage-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line">    <span class="attr">cert-manager.io/cluster-issuer:</span> <span class="string">&quot;letsencrypt-prod&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/proxy-body-size:</span> <span class="string">&quot;100m&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">api.fileservice.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">file-storage-tls</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">api.fileservice.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">file-storage-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h3 id="Infrastructure-as-Code-Terraform"><a href="#Infrastructure-as-Code-Terraform" class="headerlink" title="Infrastructure as Code (Terraform)"></a>Infrastructure as Code (Terraform)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"># GCS Bucket Configuration</span><br><span class="line">resource &quot;google_storage_bucket&quot; &quot;file_storage_bucket&quot; &#123;</span><br><span class="line">  name          = &quot;company-file-storage-$&#123;var.environment&#125;&quot;</span><br><span class="line">  location      = &quot;US&quot;</span><br><span class="line">  force_destroy = false</span><br><span class="line"></span><br><span class="line">  versioning &#123;</span><br><span class="line">    enabled = true</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  lifecycle_rule &#123;</span><br><span class="line">    condition &#123;</span><br><span class="line">      age = 30</span><br><span class="line">    &#125;</span><br><span class="line">    action &#123;</span><br><span class="line">      type          = &quot;SetStorageClass&quot;</span><br><span class="line">      storage_class = &quot;NEARLINE&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  lifecycle_rule &#123;</span><br><span class="line">    condition &#123;</span><br><span class="line">      age = 90</span><br><span class="line">    &#125;</span><br><span class="line">    action &#123;</span><br><span class="line">      type          = &quot;SetStorageClass&quot;</span><br><span class="line">      storage_class = &quot;COLDLINE&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  lifecycle_rule &#123;</span><br><span class="line">    condition &#123;</span><br><span class="line">      age = 365</span><br><span class="line">    &#125;</span><br><span class="line">    action &#123;</span><br><span class="line">      type          = &quot;SetStorageClass&quot;</span><br><span class="line">      storage_class = &quot;ARCHIVE&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cors &#123;</span><br><span class="line">    origin          = [&quot;https://app.company.com&quot;]</span><br><span class="line">    method          = [&quot;GET&quot;, &quot;HEAD&quot;, &quot;PUT&quot;, &quot;POST&quot;, &quot;DELETE&quot;]</span><br><span class="line">    response_header = [&quot;*&quot;]</span><br><span class="line">    max_age_seconds = 3600</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Cloud SQL PostgreSQL Instance</span><br><span class="line">resource &quot;google_sql_database_instance&quot; &quot;file_storage_db&quot; &#123;</span><br><span class="line">  name             = &quot;file-storage-db-$&#123;var.environment&#125;&quot;</span><br><span class="line">  database_version = &quot;POSTGRES_13&quot;</span><br><span class="line">  region          = &quot;us-central1&quot;</span><br><span class="line"></span><br><span class="line">  settings &#123;</span><br><span class="line">    tier = &quot;db-custom-2-4096&quot;</span><br><span class="line">    </span><br><span class="line">    backup_configuration &#123;</span><br><span class="line">      enabled                        = true</span><br><span class="line">      start_time                    = &quot;03:00&quot;</span><br><span class="line">      location                      = &quot;us&quot;</span><br><span class="line">      point_in_time_recovery_enabled = true</span><br><span class="line">      backup_retention_settings &#123;</span><br><span class="line">        retained_backups = 30</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ip_configuration &#123;</span><br><span class="line">      ipv4_enabled    = false</span><br><span class="line">      private_network = google_compute_network.vpc.id</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    database_flags &#123;</span><br><span class="line">      name  = &quot;max_connections&quot;</span><br><span class="line">      value = &quot;200&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    database_flags &#123;</span><br><span class="line">      name  = &quot;shared_preload_libraries&quot;</span><br><span class="line">      value = &quot;pg_stat_statements&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Redis Instance for Caching</span><br><span class="line">resource &quot;google_redis_instance&quot; &quot;file_storage_cache&quot; &#123;</span><br><span class="line">  name           = &quot;file-storage-cache-$&#123;var.environment&#125;&quot;</span><br><span class="line">  tier           = &quot;STANDARD_HA&quot;</span><br><span class="line">  memory_size_gb = 4</span><br><span class="line">  region         = &quot;us-central1&quot;</span><br><span class="line">  </span><br><span class="line">  redis_version     = &quot;REDIS_6_X&quot;</span><br><span class="line">  display_name      = &quot;File Storage Cache&quot;</span><br><span class="line">  authorized_network = google_compute_network.vpc.id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Benchmarks-and-SLAs"><a href="#Performance-Benchmarks-and-SLAs" class="headerlink" title="Performance Benchmarks and SLAs"></a>Performance Benchmarks and SLAs</h2><h3 id="Service-Level-Objectives"><a href="#Service-Level-Objectives" class="headerlink" title="Service Level Objectives"></a>Service Level Objectives</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SLO Configuration</span></span><br><span class="line"><span class="attr">slo_targets:</span></span><br><span class="line">  <span class="attr">availability:</span></span><br><span class="line">    <span class="attr">target:</span> <span class="number">99.9</span><span class="string">%</span></span><br><span class="line">    <span class="attr">measurement_window:</span> <span class="string">30_days</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">latency:</span></span><br><span class="line">    <span class="attr">upload_p95:</span> <span class="string">5s</span>      <span class="comment"># 95% of uploads complete within 5 seconds</span></span><br><span class="line">    <span class="attr">upload_p99:</span> <span class="string">15s</span>     <span class="comment"># 99% of uploads complete within 15 seconds</span></span><br><span class="line">    <span class="attr">download_p95:</span> <span class="string">500ms</span> <span class="comment"># 95% of downloads start within 500ms</span></span><br><span class="line">    <span class="attr">download_p99:</span> <span class="string">2s</span>    <span class="comment"># 99% of downloads start within 2 seconds</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">throughput:</span></span><br><span class="line">    <span class="attr">max_concurrent_uploads:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">max_upload_rate:</span> <span class="string">10GB/s</span></span><br><span class="line">    <span class="attr">max_download_rate:</span> <span class="string">50GB/s</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">error_rate:</span></span><br><span class="line">    <span class="attr">target:</span> <span class="number">0.1</span><span class="string">%</span>        <span class="comment"># Less than 0.1% error rate</span></span><br><span class="line">    <span class="attr">measurement_window:</span> <span class="string">24_hours</span></span><br></pre></td></tr></table></figure>

<h3 id="Load-Testing-Strategy"><a href="#Load-Testing-Strategy" class="headerlink" title="Load Testing Strategy"></a>Load Testing Strategy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageLoadTester</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileStorageClient client;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutorService executorService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> LoadTestResult <span class="title function_">runLoadTest</span><span class="params">(LoadTestConfig config)</span> &#123;</span><br><span class="line">        List&lt;CompletableFuture&lt;UploadResult&gt;&gt; futures = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; config.getConcurrentUsers(); i++) &#123;</span><br><span class="line">            CompletableFuture&lt;UploadResult&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">return</span> simulateUserUpload(config);</span><br><span class="line">            &#125;, executorService);</span><br><span class="line">            </span><br><span class="line">            futures.add(future);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Collect results</span></span><br><span class="line">        List&lt;UploadResult&gt; results = futures.stream()</span><br><span class="line">            .map(CompletableFuture::join)</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> analyzeResults(results);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> UploadResult <span class="title function_">simulateUserUpload</span><span class="params">(LoadTestConfig config)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Generate test file</span></span><br><span class="line">            <span class="type">byte</span>[] testData = generateTestFile(config.getFileSize());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Upload file</span></span><br><span class="line">            <span class="type">FileUploadResult</span> <span class="variable">result</span> <span class="operator">=</span> client.uploadFile(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(testData),</span><br><span class="line">                <span class="string">&quot;test-file-&quot;</span> + UUID.randomUUID().toString(),</span><br><span class="line">                <span class="string">&quot;application/octet-stream&quot;</span></span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="type">long</span> <span class="variable">duration</span> <span class="operator">=</span> System.currentTimeMillis() - startTime;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> UploadResult.builder()</span><br><span class="line">                .success(<span class="literal">true</span>)</span><br><span class="line">                .duration(duration)</span><br><span class="line">                .fileSize(testData.length)</span><br><span class="line">                .fileId(result.getFileId())</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">duration</span> <span class="operator">=</span> System.currentTimeMillis() - startTime;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> UploadResult.builder()</span><br><span class="line">                .success(<span class="literal">false</span>)</span><br><span class="line">                .duration(duration)</span><br><span class="line">                .error(e.getMessage())</span><br><span class="line">                .build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Interview-Questions-and-Insights"><a href="#Interview-Questions-and-Insights" class="headerlink" title="Interview Questions and Insights"></a>Interview Questions and Insights</h2><h3 id="System-Design-Questions"><a href="#System-Design-Questions" class="headerlink" title="System Design Questions"></a>System Design Questions</h3><p><strong>Q: How would you handle a scenario where files need to be replicated across multiple regions for disaster recovery?</strong></p>
<p>A: I would implement a multi-region replication strategy:</p>
<ol>
<li><strong>Primary-Secondary Pattern</strong>: Use GCS multi-region buckets for automatic replication</li>
<li><strong>Database Replication</strong>: Set up PostgreSQL read replicas in different regions</li>
<li><strong>Metadata Consistency</strong>: Implement eventual consistency with conflict resolution</li>
<li><strong>Failover Logic</strong>: Automatic failover with health checks and circuit breakers</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiRegionReplicationService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, GcsService&gt; regionalGcsServices;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CircuitBreaker circuitBreaker;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> FileUploadResult <span class="title function_">uploadWithReplication</span><span class="params">(MultipartFile file, String primaryRegion)</span> &#123;</span><br><span class="line">        <span class="comment">// Upload to primary region first</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">primaryPath</span> <span class="operator">=</span> uploadToPrimary(file, primaryRegion);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Async replication to secondary regions</span></span><br><span class="line">        CompletableFuture.runAsync(() -&gt; replicateToSecondaryRegions(file, primaryPath));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> buildUploadResult(primaryPath);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">replicateToSecondaryRegions</span><span class="params">(MultipartFile file, String primaryPath)</span> &#123;</span><br><span class="line">        regionalGcsServices.entrySet().parallelStream()</span><br><span class="line">            .filter(entry -&gt; !entry.getKey().equals(primaryRegion))</span><br><span class="line">            .forEach(entry -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    circuitBreaker.executeSupplier(() -&gt; </span><br><span class="line">                        entry.getValue().replicateFile(primaryPath, file)</span><br><span class="line">                    );</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    logger.error(<span class="string">&quot;Failed to replicate to region: &#123;&#125;&quot;</span>, entry.getKey(), e);</span><br><span class="line">                    <span class="comment">// Schedule retry or alert operations team</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Q: How would you optimize the system for handling millions of small files vs. thousands of large files?</strong></p>
<p>A: Different optimization strategies are needed:</p>
<p><strong>For Small Files (&lt; 1MB):</strong></p>
<ul>
<li>Batch multiple small files into larger objects</li>
<li>Use aggressive caching in Redis</li>
<li>Implement file bundling&#x2F;archiving</li>
<li>Use CDN for frequently accessed files</li>
</ul>
<p><strong>For Large Files (&gt; 100MB):</strong></p>
<ul>
<li>Mandatory chunked uploads with resumability</li>
<li>Implement progressive download with range requests</li>
<li>Use streaming processing to avoid memory issues</li>
<li>Implement intelligent storage class selection</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileOptimizationService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> StorageStrategy <span class="title function_">determineOptimalStrategy</span><span class="params">(FileMetadata file)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (file.getFileSize() &lt; SMALL_FILE_THRESHOLD) &#123;</span><br><span class="line">            <span class="keyword">return</span> StorageStrategy.builder()</span><br><span class="line">                .cacheInRedis(<span class="literal">true</span>)</span><br><span class="line">                .bundleWithOthers(shouldBundle(file))</span><br><span class="line">                .storageClass(StorageClass.STANDARD)</span><br><span class="line">                .cdnEnabled(<span class="literal">true</span>)</span><br><span class="line">                .build();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (file.getFileSize() &gt; LARGE_FILE_THRESHOLD) &#123;</span><br><span class="line">            <span class="keyword">return</span> StorageStrategy.builder()</span><br><span class="line">                .chunkedUpload(<span class="literal">true</span>)</span><br><span class="line">                .resumableUpload(<span class="literal">true</span>)</span><br><span class="line">                .storageClass(determineStorageClass(file))</span><br><span class="line">                .compressionEnabled(shouldCompress(file))</span><br><span class="line">                .build();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> StorageStrategy.defaultStrategy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Q: How would you implement file deduplication to save storage costs?</strong></p>
<p>A: Implement content-based deduplication using cryptographic hashing:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileDeduplicationService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileHashRepository hashRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GcsService gcsService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> FileUploadResult <span class="title function_">uploadWithDeduplication</span><span class="params">(MultipartFile file, String projectId)</span> &#123;</span><br><span class="line">        <span class="comment">// Calculate file hash</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">sha256Hash</span> <span class="operator">=</span> calculateSHA256(file);</span><br><span class="line">        <span class="type">String</span> <span class="variable">md5Hash</span> <span class="operator">=</span> calculateMD5(file);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check if file already exists</span></span><br><span class="line">        Optional&lt;FileMetadata&gt; existingFile = hashRepository.findByHash(sha256Hash);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (existingFile.isPresent()) &#123;</span><br><span class="line">            <span class="comment">// File exists, create reference instead of duplicate</span></span><br><span class="line">            <span class="keyword">return</span> createFileReference(existingFile.get(), projectId);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// New file, upload and store hash</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">gcsPath</span> <span class="operator">=</span> gcsService.uploadFile(file.getInputStream(), </span><br><span class="line">            generateFileName(), file.getContentType());</span><br><span class="line">        </span><br><span class="line">        <span class="type">FileMetadata</span> <span class="variable">metadata</span> <span class="operator">=</span> FileMetadata.builder()</span><br><span class="line">            .fileId(UUID.randomUUID().toString())</span><br><span class="line">            .originalFileName(file.getOriginalFilename())</span><br><span class="line">            .gcsPath(gcsPath)</span><br><span class="line">            .fileSize(file.getSize())</span><br><span class="line">            .projectId(projectId)</span><br><span class="line">            .sha256Hash(sha256Hash)</span><br><span class="line">            .md5Hash(md5Hash)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> fileMetadataRepository.save(metadata);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> FileUploadResult <span class="title function_">createFileReference</span><span class="params">(FileMetadata originalFile, String projectId)</span> &#123;</span><br><span class="line">        <span class="comment">// Create a new metadata entry that references the same GCS object</span></span><br><span class="line">        <span class="type">FileMetadata</span> <span class="variable">referenceMetadata</span> <span class="operator">=</span> originalFile.toBuilder()</span><br><span class="line">            .fileId(UUID.randomUUID().toString())</span><br><span class="line">            .projectId(projectId)</span><br><span class="line">            .createdAt(Instant.now())</span><br><span class="line">            .isReference(<span class="literal">true</span>)</span><br><span class="line">            .originalFileId(originalFile.getFileId())</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        fileMetadataRepository.save(referenceMetadata);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> FileUploadResult.builder()</span><br><span class="line">            .fileId(referenceMetadata.getFileId())</span><br><span class="line">            .downloadUrl(generateDownloadUrl(referenceMetadata))</span><br><span class="line">            .deduplicated(<span class="literal">true</span>)</span><br><span class="line">            .originalFileId(originalFile.getFileId())</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Scalability-Questions"><a href="#Scalability-Questions" class="headerlink" title="Scalability Questions"></a>Scalability Questions</h3><p><strong>Q: How would you handle rate limiting to prevent abuse while maintaining good user experience?</strong></p>
<p>A: Implement a multi-tier rate limiting strategy:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileUploadRateLimiter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisTemplate&lt;String, String&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Different limits for different user tiers</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;UserTier, RateLimitConfig&gt; tierLimits = Map.of(</span><br><span class="line">        UserTier.FREE, <span class="keyword">new</span> <span class="title class_">RateLimitConfig</span>(<span class="number">10</span>, Duration.ofMinutes(<span class="number">1</span>), <span class="number">100</span> * <span class="number">1024</span> * <span class="number">1024L</span>), <span class="comment">// 10 files/min, 100MB/day</span></span><br><span class="line">        UserTier.PREMIUM, <span class="keyword">new</span> <span class="title class_">RateLimitConfig</span>(<span class="number">100</span>, Duration.ofMinutes(<span class="number">1</span>), <span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1024L</span>), <span class="comment">// 100 files/min, 10GB/day</span></span><br><span class="line">        UserTier.ENTERPRISE, <span class="keyword">new</span> <span class="title class_">RateLimitConfig</span>(<span class="number">1000</span>, Duration.ofMinutes(<span class="number">1</span>), Long.MAX_VALUE) <span class="comment">// 1000 files/min, unlimited</span></span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">allowUpload</span><span class="params">(String userId, <span class="type">long</span> fileSize)</span> &#123;</span><br><span class="line">        <span class="type">UserTier</span> <span class="variable">userTier</span> <span class="operator">=</span> getUserTier(userId);</span><br><span class="line">        <span class="type">RateLimitConfig</span> <span class="variable">config</span> <span class="operator">=</span> tierLimits.get(userTier);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check request rate limit</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">rateLimitKey</span> <span class="operator">=</span> <span class="string">&quot;rate_limit:&quot;</span> + userId;</span><br><span class="line">        <span class="keyword">if</span> (!checkRateLimit(rateLimitKey, config.getRequestsPerWindow(), config.getTimeWindow())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RateLimitExceededException</span>(<span class="string">&quot;Request rate limit exceeded&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check bandwidth limit</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">bandwidthKey</span> <span class="operator">=</span> <span class="string">&quot;bandwidth:&quot;</span> + userId + <span class="string">&quot;:&quot;</span> + LocalDate.now();</span><br><span class="line">        <span class="type">long</span> <span class="variable">currentUsage</span> <span class="operator">=</span> getCurrentBandwidthUsage(bandwidthKey);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (currentUsage + fileSize &gt; config.getDailyBandwidthLimit()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BandwidthLimitExceededException</span>(<span class="string">&quot;Daily bandwidth limit exceeded&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Update bandwidth usage</span></span><br><span class="line">        redisTemplate.opsForValue().increment(bandwidthKey, fileSize);</span><br><span class="line">        redisTemplate.expire(bandwidthKey, Duration.ofDays(<span class="number">1</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkRateLimit</span><span class="params">(String key, <span class="type">int</span> limit, Duration window)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            local key = KEYS[1]</span></span><br><span class="line"><span class="string">            local limit = tonumber(ARGV[1])</span></span><br><span class="line"><span class="string">            local window = tonumber(ARGV[2])</span></span><br><span class="line"><span class="string">            local now = tonumber(ARGV[3])</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            redis.call(&#x27;zremrangebyscore&#x27;, key, 0, now - window)</span></span><br><span class="line"><span class="string">            local current = redis.call(&#x27;zcard&#x27;, key)</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            if current &lt; limit then</span></span><br><span class="line"><span class="string">                redis.call(&#x27;zadd&#x27;, key, now, now)</span></span><br><span class="line"><span class="string">                redis.call(&#x27;expire&#x27;, key, window)</span></span><br><span class="line"><span class="string">                return 1</span></span><br><span class="line"><span class="string">            else</span></span><br><span class="line"><span class="string">                return 0</span></span><br><span class="line"><span class="string">            end</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> redisTemplate.execute(</span><br><span class="line">            RedisScript.of(script, Long.class),</span><br><span class="line">            List.of(key),</span><br><span class="line">            String.valueOf(limit),</span><br><span class="line">            String.valueOf(window.toMillis()),</span><br><span class="line">            String.valueOf(System.currentTimeMillis())</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result != <span class="literal">null</span> &amp;&amp; result == <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SDK-Usage-Examples"><a href="#SDK-Usage-Examples" class="headerlink" title="SDK Usage Examples"></a>SDK Usage Examples</h2><h3 id="Java-SDK-Usage"><a href="#Java-SDK-Usage" class="headerlink" title="Java SDK Usage"></a>Java SDK Usage</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageExamples</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// Initialize the client</span></span><br><span class="line">        <span class="type">FileStorageClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileStorageClient</span>(</span><br><span class="line">            <span class="string">&quot;https://api.fileservice.com&quot;</span>, </span><br><span class="line">            <span class="string">&quot;your-api-key&quot;</span></span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Example 1: Simple file upload</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;document.pdf&quot;</span>);</span><br><span class="line">        <span class="type">UploadOptions</span> <span class="variable">options</span> <span class="operator">=</span> UploadOptions.builder()</span><br><span class="line">            .projectId(<span class="string">&quot;project-123&quot;</span>)</span><br><span class="line">            .tags(Set.of(<span class="string">&quot;document&quot;</span>, <span class="string">&quot;pdf&quot;</span>))</span><br><span class="line">            .metadata(Map.of(<span class="string">&quot;department&quot;</span>, <span class="string">&quot;engineering&quot;</span>))</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">FileUploadResult</span> <span class="variable">result</span> <span class="operator">=</span> client.uploadFile(file, options);</span><br><span class="line">            System.out.println(<span class="string">&quot;File uploaded successfully: &quot;</span> + result.getFileId());</span><br><span class="line">            System.out.println(<span class="string">&quot;Download URL: &quot;</span> + result.getDownloadUrl());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileUploadException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Upload failed: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Example 2: Large file upload with progress tracking</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">largeFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;large-video.mp4&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">FileUploadResult</span> <span class="variable">result</span> <span class="operator">=</span> client.uploadFile(largeFile, options, (uploaded, total) -&gt; &#123;</span><br><span class="line">            <span class="type">double</span> <span class="variable">progress</span> <span class="operator">=</span> (<span class="type">double</span>) uploaded / total * <span class="number">100</span>;</span><br><span class="line">            System.out.printf(<span class="string">&quot;Upload progress: %.2f%%\n&quot;</span>, progress);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Example 3: File download</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> client.downloadFile(result.getFileId())) &#123;</span><br><span class="line">            Files.copy(inputStream, Paths.get(<span class="string">&quot;downloaded-file.mp4&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;File downloaded successfully&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Download failed: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Example 4: List files with filtering</span></span><br><span class="line">        <span class="type">FileQuery</span> <span class="variable">query</span> <span class="operator">=</span> FileQuery.builder()</span><br><span class="line">            .projectId(<span class="string">&quot;project-123&quot;</span>)</span><br><span class="line">            .fileType(<span class="string">&quot;image/*&quot;</span>)</span><br><span class="line">            .createdAfter(LocalDateTime.now().minusDays(<span class="number">7</span>))</span><br><span class="line">            .tags(Set.of(<span class="string">&quot;processed&quot;</span>))</span><br><span class="line">            .page(<span class="number">0</span>)</span><br><span class="line">            .size(<span class="number">20</span>)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        PagedResult&lt;FileMetadata&gt; files = client.listFiles(query);</span><br><span class="line">        files.getContent().forEach(file -&gt; </span><br><span class="line">            System.out.println(<span class="string">&quot;File: &quot;</span> + file.getOriginalFileName() + <span class="string">&quot; - &quot;</span> + file.getFileSize() + <span class="string">&quot; bytes&quot;</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="React-SDK-Usage"><a href="#React-SDK-Usage" class="headerlink" title="React SDK Usage"></a>React SDK Usage</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">FileStorageClient</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@company/file-storage-sdk&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">App</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> [client] = <span class="title function_">useState</span>(<span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="title class_">FileStorageClient</span>(&#123;</span><br><span class="line">    <span class="attr">baseUrl</span>: <span class="string">&#x27;https://api.fileservice.com&#x27;</span>,</span><br><span class="line">    <span class="attr">apiKey</span>: process.<span class="property">env</span>.<span class="property">REACT_APP_API_KEY</span></span><br><span class="line">  &#125;));</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> [uploadProgress, setUploadProgress] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleFileUpload</span> = <span class="keyword">async</span> (<span class="params">file</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> result = <span class="keyword">await</span> client.<span class="title function_">uploadFile</span>(file, &#123;</span><br><span class="line">        <span class="attr">projectId</span>: <span class="string">&#x27;project-123&#x27;</span>,</span><br><span class="line">        <span class="attr">onProgress</span>: <span class="function">(<span class="params">loaded, total</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">setUploadProgress</span>((loaded / total) * <span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      </span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Upload successful:&#x27;</span>, result);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Upload failed:&#x27;</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleFileDrop</span> = (<span class="params">acceptedFiles</span>) =&gt; &#123;</span><br><span class="line">    acceptedFiles.<span class="title function_">forEach</span>(<span class="function"><span class="params">file</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">handleFileUpload</span>(file);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">FileDropzone</span> <span class="attr">onDrop</span>=<span class="string">&#123;handleFileDrop&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;uploadProgress &gt; 0 &amp;&amp; (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">ProgressBar</span> <span class="attr">value</span>=<span class="string">&#123;uploadProgress&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      )&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Security-Best-Practices"><a href="#Security-Best-Practices" class="headerlink" title="Security Best Practices"></a>Security Best Practices</h2><h3 id="Content-Validation-and-Sanitization"><a href="#Content-Validation-and-Sanitization" class="headerlink" title="Content Validation and Sanitization"></a>Content Validation and Sanitization</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileSecurityService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; allowedContentTypes = Set.of(</span><br><span class="line">        <span class="string">&quot;image/jpeg&quot;</span>, <span class="string">&quot;image/png&quot;</span>, <span class="string">&quot;image/gif&quot;</span>, <span class="string">&quot;image/webp&quot;</span>,</span><br><span class="line">        <span class="string">&quot;application/pdf&quot;</span>, <span class="string">&quot;text/plain&quot;</span>, <span class="string">&quot;application/json&quot;</span>,</span><br><span class="line">        <span class="string">&quot;video/mp4&quot;</span>, <span class="string">&quot;video/webm&quot;</span></span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; dangerousExtensions = Set.of(</span><br><span class="line">        <span class="string">&quot;.exe&quot;</span>, <span class="string">&quot;.bat&quot;</span>, <span class="string">&quot;.cmd&quot;</span>, <span class="string">&quot;.scr&quot;</span>, <span class="string">&quot;.pif&quot;</span>, <span class="string">&quot;.com&quot;</span>, <span class="string">&quot;.vbs&quot;</span>, <span class="string">&quot;.js&quot;</span></span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">validateFile</span><span class="params">(MultipartFile file)</span> &#123;</span><br><span class="line">        <span class="comment">// Check file size</span></span><br><span class="line">        <span class="keyword">if</span> (file.getSize() &gt; MAX_FILE_SIZE) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileSizeExceededException</span>(<span class="string">&quot;File size exceeds maximum allowed size&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Validate content type</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">contentType</span> <span class="operator">=</span> file.getContentType();</span><br><span class="line">        <span class="keyword">if</span> (contentType == <span class="literal">null</span> || !allowedContentTypes.contains(contentType.toLowerCase())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedFileTypeException</span>(<span class="string">&quot;File type not allowed: &quot;</span> + contentType);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check file extension</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> file.getOriginalFilename();</span><br><span class="line">        <span class="keyword">if</span> (filename != <span class="literal">null</span> &amp;&amp; hasDangerousExtension(filename)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;File extension not allowed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Scan file content for malware (integrate with antivirus service)</span></span><br><span class="line">        scanForMalware(file);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Validate file signature matches declared content type</span></span><br><span class="line">        validateFileSignature(file, contentType);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">scanForMalware</span><span class="params">(MultipartFile file)</span> &#123;</span><br><span class="line">        <span class="comment">// Integration with antivirus scanning service</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">AntivirusResult</span> <span class="variable">result</span> <span class="operator">=</span> antivirusService.scanFile(file.getBytes());</span><br><span class="line">            <span class="keyword">if</span> (!result.isClean()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;File contains malware: &quot;</span> + result.getThreatName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;Unable to scan file for malware&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">validateFileSignature</span><span class="params">(MultipartFile file, String declaredContentType)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[] header = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">12</span>];</span><br><span class="line">            file.getInputStream().read(header);</span><br><span class="line">            </span><br><span class="line">            <span class="type">String</span> <span class="variable">detectedType</span> <span class="operator">=</span> detectContentType(header);</span><br><span class="line">            <span class="keyword">if</span> (!declaredContentType.equals(detectedType)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;File signature doesn&#x27;t match declared content type&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;Unable to validate file signature&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Access-Control-Implementation"><a href="#Access-Control-Implementation" class="headerlink" title="Access Control Implementation"></a>Access Control Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileAccessControlService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtTokenProvider tokenProvider;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PermissionEvaluator permissionEvaluator;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;@fileAccessControlService.canAccessFile(authentication, #fileId, &#x27;READ&#x27;)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> FileMetadata <span class="title function_">getFileMetadata</span><span class="params">(String fileId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fileMetadataRepository.findById(fileId)</span><br><span class="line">            .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">FileNotFoundException</span>(<span class="string">&quot;File not found: &quot;</span> + fileId));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">canAccessFile</span><span class="params">(Authentication authentication, String fileId, String operation)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> authentication.getName();</span><br><span class="line">        <span class="type">FileMetadata</span> <span class="variable">file</span> <span class="operator">=</span> getFileMetadata(fileId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Owner can do everything</span></span><br><span class="line">        <span class="keyword">if</span> (file.getCreatedBy().equals(userId)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check project-level permissions</span></span><br><span class="line">        <span class="keyword">if</span> (file.getProjectId() != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> permissionEvaluator.hasPermission(authentication, file.getProjectId(), <span class="string">&quot;Project&quot;</span>, operation);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check if file is public</span></span><br><span class="line">        <span class="keyword">if</span> (file.getVisibility() == FileVisibility.PUBLIC &amp;&amp; <span class="string">&quot;READ&quot;</span>.equals(operation)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check explicit file permissions</span></span><br><span class="line">        <span class="keyword">return</span> hasExplicitFilePermission(userId, fileId, operation);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">hasExplicitFilePermission</span><span class="params">(String userId, String fileId, String operation)</span> &#123;</span><br><span class="line">        <span class="comment">// Check file-specific permissions in ACL table</span></span><br><span class="line">        <span class="keyword">return</span> filePermissionRepository.existsByFileIdAndUserIdAndPermission(</span><br><span class="line">            fileId, userId, FilePermission.valueOf(operation)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Disaster-Recovery-and-Backup-Strategy"><a href="#Disaster-Recovery-and-Backup-Strategy" class="headerlink" title="Disaster Recovery and Backup Strategy"></a>Disaster Recovery and Backup Strategy</h2><h3 id="Automated-Backup-System"><a href="#Automated-Backup-System" class="headerlink" title="Automated Backup System"></a>Automated Backup System</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileBackupService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GcsService primaryGcsService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GcsService backupGcsService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileMetadataRepository fileMetadataRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0 2 * * *&quot;)</span> <span class="comment">// Daily at 2 AM</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performIncrementalBackup</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">lastBackup</span> <span class="operator">=</span> getLastBackupTime();</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Find files modified since last backup</span></span><br><span class="line">        List&lt;FileMetadata&gt; modifiedFiles = fileMetadataRepository</span><br><span class="line">            .findByUpdatedAtBetween(lastBackup, now);</span><br><span class="line">        </span><br><span class="line">        <span class="type">BackupResult</span> <span class="variable">result</span> <span class="operator">=</span> BackupResult.builder()</span><br><span class="line">            .startTime(now)</span><br><span class="line">            .totalFiles(modifiedFiles.size())</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Backup files in parallel</span></span><br><span class="line">            List&lt;CompletableFuture&lt;FileBackupResult&gt;&gt; futures = modifiedFiles.stream()</span><br><span class="line">                .map(file -&gt; CompletableFuture.supplyAsync(() -&gt; backupFile(file)))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">            </span><br><span class="line">            List&lt;FileBackupResult&gt; backupResults = futures.stream()</span><br><span class="line">                .map(CompletableFuture::join)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">            </span><br><span class="line">            result = result.toBuilder()</span><br><span class="line">                .endTime(LocalDateTime.now())</span><br><span class="line">                .successCount(backupResults.stream().mapToInt(r -&gt; r.isSuccess() ? <span class="number">1</span> : <span class="number">0</span>).sum())</span><br><span class="line">                .failureCount(backupResults.stream().mapToInt(r -&gt; r.isSuccess() ? <span class="number">0</span> : <span class="number">1</span>).sum())</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Record backup completion</span></span><br><span class="line">            recordBackupCompletion(result);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;Backup process failed&quot;</span>, e);</span><br><span class="line">            alertService.sendBackupFailureAlert(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> FileBackupResult <span class="title function_">backupFile</span><span class="params">(FileMetadata fileMetadata)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Generate backup path</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">backupPath</span> <span class="operator">=</span> generateBackupPath(fileMetadata);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Copy file to backup bucket</span></span><br><span class="line">            primaryGcsService.copyFile(fileMetadata.getGcsPath(), </span><br><span class="line">                backupGcsService, backupPath);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Create backup metadata record</span></span><br><span class="line">            <span class="type">FileBackupMetadata</span> <span class="variable">backupMetadata</span> <span class="operator">=</span> FileBackupMetadata.builder()</span><br><span class="line">                .originalFileId(fileMetadata.getFileId())</span><br><span class="line">                .backupPath(backupPath)</span><br><span class="line">                .backupTime(LocalDateTime.now())</span><br><span class="line">                .backupSize(fileMetadata.getFileSize())</span><br><span class="line">                .checksum(fileMetadata.getChecksumSha256())</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">            fileBackupRepository.save(backupMetadata);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> FileBackupResult.success(fileMetadata.getFileId());</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;Failed to backup file: &#123;&#125;&quot;</span>, fileMetadata.getFileId(), e);</span><br><span class="line">            <span class="keyword">return</span> FileBackupResult.failure(fileMetadata.getFileId(), e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0 3 * * 0&quot;)</span> <span class="comment">// Weekly on Sunday at 3 AM</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performFullBackup</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Full backup implementation</span></span><br><span class="line">        logger.info(<span class="string">&quot;Starting full backup process&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Export database schema and data</span></span><br><span class="line">        exportDatabase();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Backup all files</span></span><br><span class="line">        performFullFileBackup();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Verify backup integrity</span></span><br><span class="line">        verifyBackupIntegrity();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> RestoreResult <span class="title function_">restoreFromBackup</span><span class="params">(RestoreRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (request.getRestoreType() == RestoreType.POINT_IN_TIME) &#123;</span><br><span class="line">                <span class="keyword">return</span> restoreToPointInTime(request.getTargetTime());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (request.getRestoreType() == RestoreType.SPECIFIC_FILES) &#123;</span><br><span class="line">                <span class="keyword">return</span> restoreSpecificFiles(request.getFileIds());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> restoreFullSystem(request.getBackupId());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;Restore operation failed&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> RestoreResult.failure(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Multi-Region-Deployment-Flow"><a href="#Multi-Region-Deployment-Flow" class="headerlink" title="Multi-Region Deployment Flow"></a>Multi-Region Deployment Flow</h3><pre>
<code class="mermaid">
graph TB
subgraph &quot;Primary Region (US-Central)&quot;
    A[API Gateway] --&gt; B[File Service Instances]
    B --&gt; C[Primary PostgreSQL]
    B --&gt; D[Primary GCS Bucket]
    B --&gt; E[Redis Cache]
end

subgraph &quot;Secondary Region (Europe-West)&quot;
    F[API Gateway] --&gt; G[File Service Instances]
    G --&gt; H[Read Replica PostgreSQL]
    G --&gt; I[Secondary GCS Bucket]
    G --&gt; J[Redis Cache]
end

subgraph &quot;Disaster Recovery Region (Asia-Southeast)&quot;
    K[Standby API Gateway] --&gt; L[Standby File Service]
    L --&gt; M[Backup PostgreSQL]
    L --&gt; N[Archive GCS Bucket]
end

C --&gt; H
D --&gt; I
D --&gt; N

O[Global Load Balancer] --&gt; A
O --&gt; F
O --&gt; K

P[Health Checker] --&gt; O
Q[Failover Controller] --&gt; O

style A fill:#e1f5fe
style F fill:#e8f5e8
style K fill:#fff3e0
</code>
</pre>

<h2 id="Cost-Optimization-Strategies"><a href="#Cost-Optimization-Strategies" class="headerlink" title="Cost Optimization Strategies"></a>Cost Optimization Strategies</h2><h3 id="Intelligent-Storage-Class-Management"><a href="#Intelligent-Storage-Class-Management" class="headerlink" title="Intelligent Storage Class Management"></a>Intelligent Storage Class Management</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StorageCostOptimizer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GcsService gcsService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileMetadataRepository fileMetadataRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileAccessLogRepository accessLogRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0 1 * * *&quot;)</span> <span class="comment">// Daily at 1 AM</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">optimizeStorageClasses</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">cutoffDate</span> <span class="operator">=</span> LocalDateTime.now().minusDays(<span class="number">30</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Find files that haven&#x27;t been accessed in 30 days</span></span><br><span class="line">        List&lt;FileMetadata&gt; candidates = fileMetadataRepository.findInfrequentlyAccessedFiles(cutoffDate);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (FileMetadata file : candidates) &#123;</span><br><span class="line">            <span class="type">StorageOptimizationDecision</span> <span class="variable">decision</span> <span class="operator">=</span> analyzeFile(file);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (decision.shouldChangeStorageClass()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    gcsService.changeStorageClass(file.getGcsPath(), decision.getTargetStorageClass());</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// Update metadata</span></span><br><span class="line">                    file.setStorageClass(decision.getTargetStorageClass());</span><br><span class="line">                    file.setLastOptimized(LocalDateTime.now());</span><br><span class="line">                    fileMetadataRepository.save(file);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// Record cost savings</span></span><br><span class="line">                    recordCostSavings(file, decision);</span><br><span class="line">                    </span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    logger.error(<span class="string">&quot;Failed to optimize storage for file: &#123;&#125;&quot;</span>, file.getFileId(), e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> StorageOptimizationDecision <span class="title function_">analyzeFile</span><span class="params">(FileMetadata file)</span> &#123;</span><br><span class="line">        <span class="comment">// Analyze access patterns</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">accessCount</span> <span class="operator">=</span> accessLogRepository.countByFileIdAndAccessTimeAfter(</span><br><span class="line">            file.getFileId(), LocalDateTime.now().minusDays(<span class="number">30</span>)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">lastAccess</span> <span class="operator">=</span> accessLogRepository.findLastAccessTime(file.getFileId());</span><br><span class="line">        <span class="type">long</span> <span class="variable">daysSinceLastAccess</span> <span class="operator">=</span> ChronoUnit.DAYS.between(lastAccess, LocalDateTime.now());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Decision matrix for storage class optimization</span></span><br><span class="line">        <span class="keyword">if</span> (daysSinceLastAccess &gt; <span class="number">365</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> StorageOptimizationDecision.moveToArchive();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (daysSinceLastAccess &gt; <span class="number">90</span> &amp;&amp; accessCount &lt; <span class="number">5</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> StorageOptimizationDecision.moveToColdline();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (daysSinceLastAccess &gt; <span class="number">30</span> &amp;&amp; accessCount &lt; <span class="number">10</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> StorageOptimizationDecision.moveToNearline();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> StorageOptimizationDecision.noChange();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">recordCostSavings</span><span class="params">(FileMetadata file, StorageOptimizationDecision decision)</span> &#123;</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">originalCost</span> <span class="operator">=</span> calculateMonthlyCost(file.getFileSize(), file.getCurrentStorageClass());</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">newCost</span> <span class="operator">=</span> calculateMonthlyCost(file.getFileSize(), decision.getTargetStorageClass());</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">savings</span> <span class="operator">=</span> originalCost.subtract(newCost);</span><br><span class="line">        </span><br><span class="line">        <span class="type">CostOptimizationRecord</span> <span class="variable">record</span> <span class="operator">=</span> CostOptimizationRecord.builder()</span><br><span class="line">            .fileId(file.getFileId())</span><br><span class="line">            .optimizationDate(LocalDateTime.now())</span><br><span class="line">            .fromStorageClass(file.getCurrentStorageClass())</span><br><span class="line">            .toStorageClass(decision.getTargetStorageClass())</span><br><span class="line">            .fileSize(file.getFileSize())</span><br><span class="line">            .monthlySavings(savings)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        costOptimizationRepository.save(record);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Update metrics</span></span><br><span class="line">        costSavingsCounter.increment(Tags.of(<span class="string">&quot;storage_class&quot;</span>, decision.getTargetStorageClass().name()),</span><br><span class="line">            savings.doubleValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Usage-Analytics-and-Reporting"><a href="#Usage-Analytics-and-Reporting" class="headerlink" title="Usage Analytics and Reporting"></a>Usage Analytics and Reporting</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageAnalyticsService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> StorageAnalyticsReport <span class="title function_">generateMonthlyReport</span><span class="params">(String projectId, YearMonth month)</span> &#123;</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">startOfMonth</span> <span class="operator">=</span> month.atDay(<span class="number">1</span>).atStartOfDay();</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">endOfMonth</span> <span class="operator">=</span> month.atEndOfMonth().atTime(<span class="number">23</span>, <span class="number">59</span>, <span class="number">59</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Storage usage metrics</span></span><br><span class="line">        <span class="type">StorageUsageMetrics</span> <span class="variable">usage</span> <span class="operator">=</span> StorageUsageMetrics.builder()</span><br><span class="line">            .totalFiles(fileMetadataRepository.countByProjectIdAndCreatedAtBetween(</span><br><span class="line">                projectId, startOfMonth, endOfMonth))</span><br><span class="line">            .totalStorageBytes(fileMetadataRepository.sumFileSizeByProjectIdAndDateRange(</span><br><span class="line">                projectId, startOfMonth, endOfMonth))</span><br><span class="line">            .averageFileSize(calculateAverageFileSize(projectId, startOfMonth, endOfMonth))</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Access patterns</span></span><br><span class="line">        <span class="type">AccessPatternMetrics</span> <span class="variable">access</span> <span class="operator">=</span> AccessPatternMetrics.builder()</span><br><span class="line">            .totalDownloads(accessLogRepository.countDownloadsByProjectAndDateRange(</span><br><span class="line">                projectId, startOfMonth, endOfMonth))</span><br><span class="line">            .totalUploads(uploadLogRepository.countUploadsByProjectAndDateRange(</span><br><span class="line">                projectId, startOfMonth, endOfMonth))</span><br><span class="line">            .uniqueUsers(accessLogRepository.countUniqueUsersByProjectAndDateRange(</span><br><span class="line">                projectId, startOfMonth, endOfMonth))</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Cost analysis</span></span><br><span class="line">        <span class="type">CostAnalysisMetrics</span> <span class="variable">cost</span> <span class="operator">=</span> CostAnalysisMetrics.builder()</span><br><span class="line">            .storageCost(calculateStorageCost(usage))</span><br><span class="line">            .bandwidthCost(calculateBandwidthCost(access))</span><br><span class="line">            .operationsCost(calculateOperationsCost(access))</span><br><span class="line">            .totalCost(calculateTotalCost(usage, access))</span><br><span class="line">            .projectedCost(projectCostForNextMonth(usage, access))</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Top files by size and access</span></span><br><span class="line">        List&lt;FileUsageStats&gt; topFilesBySize = getTopFilesBySize(projectId, <span class="number">10</span>);</span><br><span class="line">        List&lt;FileUsageStats&gt; topFilesByAccess = getTopFilesByAccess(projectId, <span class="number">10</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> StorageAnalyticsReport.builder()</span><br><span class="line">            .projectId(projectId)</span><br><span class="line">            .reportMonth(month)</span><br><span class="line">            .generatedAt(LocalDateTime.now())</span><br><span class="line">            .storageUsage(usage)</span><br><span class="line">            .accessPatterns(access)</span><br><span class="line">            .costAnalysis(cost)</span><br><span class="line">            .topFilesBySize(topFilesBySize)</span><br><span class="line">            .topFilesByAccess(topFilesByAccess)</span><br><span class="line">            .recommendations(generateRecommendations(usage, access, cost))</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> List&lt;CostOptimizationRecommendation&gt; <span class="title function_">generateRecommendations</span><span class="params">(</span></span><br><span class="line"><span class="params">            StorageUsageMetrics usage, AccessPatternMetrics access, CostAnalysisMetrics cost)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        List&lt;CostOptimizationRecommendation&gt; recommendations = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Recommendation 1: Storage class optimization</span></span><br><span class="line">        <span class="keyword">if</span> (cost.getStorageCost().compareTo(cost.getBandwidthCost()) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            recommendations.add(CostOptimizationRecommendation.builder()</span><br><span class="line">                .type(RecommendationType.STORAGE_CLASS_OPTIMIZATION)</span><br><span class="line">                .description(<span class="string">&quot;Consider moving infrequently accessed files to cheaper storage classes&quot;</span>)</span><br><span class="line">                .potentialSavings(estimateStorageClassSavings(usage))</span><br><span class="line">                .priority(RecommendationPriority.HIGH)</span><br><span class="line">                .build());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Recommendation 2: File lifecycle management</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">oldFilesCount</span> <span class="operator">=</span> fileMetadataRepository.countOldFiles(</span><br><span class="line">            usage.getProjectId(), LocalDateTime.now().minusYears(<span class="number">1</span>)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (oldFilesCount &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">            recommendations.add(CostOptimizationRecommendation.builder()</span><br><span class="line">                .type(RecommendationType.LIFECYCLE_POLICY)</span><br><span class="line">                .description(<span class="string">&quot;Implement automatic archival for files older than 1 year&quot;</span>)</span><br><span class="line">                .potentialSavings(estimateLifecycleSavings(oldFilesCount))</span><br><span class="line">                .priority(RecommendationPriority.MEDIUM)</span><br><span class="line">                .build());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> recommendations;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Testing-Strategy"><a href="#Testing-Strategy" class="headerlink" title="Testing Strategy"></a>Testing Strategy</h2><h3 id="Integration-Testing"><a href="#Integration-Testing" class="headerlink" title="Integration Testing"></a>Integration Testing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)</span></span><br><span class="line"><span class="meta">@TestPropertySource(properties = &#123;</span></span><br><span class="line"><span class="meta">    &quot;spring.datasource.url=jdbc:h2:mem:testdb&quot;,</span></span><br><span class="line"><span class="meta">    &quot;gcs.bucket-name=test-bucket&quot;,</span></span><br><span class="line"><span class="meta">    &quot;redis.host=localhost&quot;</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileStorageIntegrationTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TestRestTemplate restTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> FileMetadataRepository fileMetadataRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@MockBean</span></span><br><span class="line">    <span class="keyword">private</span> GcsService gcsService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldUploadFileSuccessfully</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// Arrange</span></span><br><span class="line">        <span class="type">MockMultipartFile</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockMultipartFile</span>(</span><br><span class="line">            <span class="string">&quot;file&quot;</span>, <span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;text/plain&quot;</span>, <span class="string">&quot;Hello World&quot;</span>.getBytes()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">when</span>(gcsService.uploadFile(any(), any(), any(), any()))</span><br><span class="line">            .thenReturn(<span class="string">&quot;test-bucket/files/test.txt&quot;</span>);</span><br><span class="line">        <span class="keyword">when</span>(gcsService.generateSignedUrl(any(), any()))</span><br><span class="line">            .thenReturn(<span class="string">&quot;https://storage.googleapis.com/test-bucket/files/test.txt&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Act</span></span><br><span class="line">        MultiValueMap&lt;String, Object&gt; body = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line">        body.add(<span class="string">&quot;file&quot;</span>, file.getResource());</span><br><span class="line">        body.add(<span class="string">&quot;projectId&quot;</span>, <span class="string">&quot;test-project&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">        headers.setContentType(MediaType.MULTIPART_FORM_DATA);</span><br><span class="line">        headers.setBearerAuth(<span class="string">&quot;test-token&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        ResponseEntity&lt;FileUploadResponse&gt; response = restTemplate.exchange(</span><br><span class="line">            <span class="string">&quot;/api/v1/files/upload&quot;</span>,</span><br><span class="line">            HttpMethod.POST,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(body, headers),</span><br><span class="line">            FileUploadResponse.class</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Assert</span></span><br><span class="line">        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);</span><br><span class="line">        assertThat(response.getBody().getFileId()).isNotNull();</span><br><span class="line">        assertThat(response.getBody().getDownloadUrl()).contains(<span class="string">&quot;storage.googleapis.com&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Verify database record</span></span><br><span class="line">        Optional&lt;FileMetadata&gt; savedFile = fileMetadataRepository.findById(response.getBody().getFileId());</span><br><span class="line">        assertThat(savedFile).isPresent();</span><br><span class="line">        assertThat(savedFile.get().getOriginalFileName()).isEqualTo(<span class="string">&quot;test.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldHandleChunkedUploadCorrectly</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// Arrange</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">uploadId</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        <span class="type">int</span> <span class="variable">totalChunks</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">chunkSize</span> <span class="operator">=</span> <span class="number">1024</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Initiate chunked upload</span></span><br><span class="line">        <span class="type">ChunkedUploadRequest</span> <span class="variable">initRequest</span> <span class="operator">=</span> ChunkedUploadRequest.builder()</span><br><span class="line">            .fileName(<span class="string">&quot;large-file.mp4&quot;</span>)</span><br><span class="line">            .totalSize(<span class="number">3072</span>)</span><br><span class="line">            .chunkSize(chunkSize)</span><br><span class="line">            .projectId(<span class="string">&quot;test-project&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        ResponseEntity&lt;ChunkedUploadResponse&gt; initResponse = restTemplate.postForEntity(</span><br><span class="line">            <span class="string">&quot;/api/v1/files/upload/chunked/initiate&quot;</span>,</span><br><span class="line">            initRequest,</span><br><span class="line">            ChunkedUploadResponse.class</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        assertThat(initResponse.getStatusCode()).isEqualTo(HttpStatus.OK);</span><br><span class="line">        <span class="type">String</span> <span class="variable">actualUploadId</span> <span class="operator">=</span> initResponse.getBody().getUploadId();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Upload chunks</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= totalChunks; i++) &#123;</span><br><span class="line">            <span class="type">MockMultipartFile</span> <span class="variable">chunk</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockMultipartFile</span>(</span><br><span class="line">                <span class="string">&quot;chunk&quot;</span>, <span class="string">&quot;chunk&quot;</span> + i, <span class="string">&quot;application/octet-stream&quot;</span>, </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">byte</span>[i == totalChunks ? <span class="number">1024</span> : chunkSize] <span class="comment">// Last chunk smaller</span></span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            MultiValueMap&lt;String, Object&gt; chunkBody = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line">            chunkBody.add(<span class="string">&quot;chunk&quot;</span>, chunk.getResource());</span><br><span class="line">            </span><br><span class="line">            ResponseEntity&lt;ChunkUploadResponse&gt; chunkResponse = restTemplate.exchange(</span><br><span class="line">                <span class="string">&quot;/api/v1/files/upload/chunked/&quot;</span> + actualUploadId + <span class="string">&quot;/chunk/&quot;</span> + i,</span><br><span class="line">                HttpMethod.PUT,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(chunkBody, createAuthHeaders()),</span><br><span class="line">                ChunkUploadResponse.class</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            assertThat(chunkResponse.getStatusCode()).isEqualTo(HttpStatus.OK);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (i == totalChunks) &#123;</span><br><span class="line">                <span class="comment">// Last chunk should complete the upload</span></span><br><span class="line">                assertThat(chunkResponse.getBody().isCompleted()).isTrue();</span><br><span class="line">                assertThat(chunkResponse.getBody().getFileId()).isNotNull();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldEnforceRateLimitsCorrectly</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Test rate limiting behavior</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> <span class="string">&quot;test-user&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Simulate exceeding rate limit</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">15</span>; i++) &#123; <span class="comment">// Assuming limit is 10 requests per minute</span></span><br><span class="line">            <span class="type">MockMultipartFile</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockMultipartFile</span>(</span><br><span class="line">                <span class="string">&quot;file&quot;</span>, <span class="string">&quot;test&quot;</span> + i + <span class="string">&quot;.txt&quot;</span>, <span class="string">&quot;text/plain&quot;</span>, (<span class="string">&quot;Content &quot;</span> + i).getBytes()</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            MultiValueMap&lt;String, Object&gt; body = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line">            body.add(<span class="string">&quot;file&quot;</span>, file.getResource());</span><br><span class="line">            </span><br><span class="line">            ResponseEntity&lt;String&gt; response = restTemplate.exchange(</span><br><span class="line">                <span class="string">&quot;/api/v1/files/upload&quot;</span>,</span><br><span class="line">                HttpMethod.POST,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(body, createAuthHeaders(userId)),</span><br><span class="line">                String.class</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (i &lt; <span class="number">10</span>) &#123;</span><br><span class="line">                assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                assertThat(response.getStatusCode()).isEqualTo(HttpStatus.TOO_MANY_REQUESTS);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Load-Testing-with-JMeter-Configuration"><a href="#Load-Testing-with-JMeter-Configuration" class="headerlink" title="Load Testing with JMeter Configuration"></a>Load Testing with JMeter Configuration</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">jmeterTestPlan</span> <span class="attr">version</span>=<span class="string">&quot;1.2&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">hashTree</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TestPlan</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;TestPlan.comments&quot;</span>&gt;</span>File Storage Service Load Test<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">boolProp</span> <span class="attr">name</span>=<span class="string">&quot;TestPlan.functional_mode&quot;</span>&gt;</span>false<span class="tag">&lt;/<span class="name">boolProp</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">boolProp</span> <span class="attr">name</span>=<span class="string">&quot;TestPlan.tearDown_on_shutdown&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">boolProp</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">boolProp</span> <span class="attr">name</span>=<span class="string">&quot;TestPlan.serialize_threadgroups&quot;</span>&gt;</span>false<span class="tag">&lt;/<span class="name">boolProp</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">elementProp</span> <span class="attr">name</span>=<span class="string">&quot;TestPlan.arguments&quot;</span> <span class="attr">elementType</span>=<span class="string">&quot;Arguments&quot;</span> <span class="attr">guiclass</span>=<span class="string">&quot;ArgumentsPanel&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">collectionProp</span> <span class="attr">name</span>=<span class="string">&quot;Arguments.arguments&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">elementProp</span> <span class="attr">name</span>=<span class="string">&quot;base_url&quot;</span> <span class="attr">elementType</span>=<span class="string">&quot;Argument&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;Argument.name&quot;</span>&gt;</span>base_url<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;Argument.value&quot;</span>&gt;</span>https://api.fileservice.com<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">elementProp</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">collectionProp</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">elementProp</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;TestPlan.user_define_classpath&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">TestPlan</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hashTree</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- Thread Group for File Upload Load Test --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ThreadGroup</span> <span class="attr">guiclass</span>=<span class="string">&quot;ThreadGroupGui&quot;</span> <span class="attr">testclass</span>=<span class="string">&quot;ThreadGroup&quot;</span> <span class="attr">testname</span>=<span class="string">&quot;File Upload Load Test&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;ThreadGroup.on_sample_error&quot;</span>&gt;</span>continue<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">elementProp</span> <span class="attr">name</span>=<span class="string">&quot;ThreadGroup.main_controller&quot;</span> <span class="attr">elementType</span>=<span class="string">&quot;LoopController&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">boolProp</span> <span class="attr">name</span>=<span class="string">&quot;LoopController.continue_forever&quot;</span>&gt;</span>false<span class="tag">&lt;/<span class="name">boolProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;LoopController.loops&quot;</span>&gt;</span>10<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">elementProp</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;ThreadGroup.num_threads&quot;</span>&gt;</span>100<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;ThreadGroup.ramp_time&quot;</span>&gt;</span>60<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">boolProp</span> <span class="attr">name</span>=<span class="string">&quot;ThreadGroup.scheduler&quot;</span>&gt;</span>false<span class="tag">&lt;/<span class="name">boolProp</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;ThreadGroup.duration&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;ThreadGroup.delay&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">ThreadGroup</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">hashTree</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- HTTP Request for File Upload --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">HTTPSamplerProxy</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">elementProp</span> <span class="attr">name</span>=<span class="string">&quot;HTTPsampler.Files&quot;</span> <span class="attr">elementType</span>=<span class="string">&quot;HTTPFileArgs&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">collectionProp</span> <span class="attr">name</span>=<span class="string">&quot;HTTPFileArgs.files&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">elementProp</span> <span class="attr">name</span>=<span class="string">&quot;&quot;</span> <span class="attr">elementType</span>=<span class="string">&quot;HTTPFileArg&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;File.path&quot;</span>&gt;</span>$&#123;__P(test_file_path)&#125;<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;File.paramname&quot;</span>&gt;</span>file<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;File.mimetype&quot;</span>&gt;</span>application/octet-stream<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">elementProp</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">collectionProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">elementProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">elementProp</span> <span class="attr">name</span>=<span class="string">&quot;HTTPsampler.Arguments&quot;</span> <span class="attr">elementType</span>=<span class="string">&quot;Arguments&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">collectionProp</span> <span class="attr">name</span>=<span class="string">&quot;Arguments.arguments&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">elementProp</span> <span class="attr">name</span>=<span class="string">&quot;projectId&quot;</span> <span class="attr">elementType</span>=<span class="string">&quot;HTTPArgument&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">boolProp</span> <span class="attr">name</span>=<span class="string">&quot;HTTPArgument.always_encode&quot;</span>&gt;</span>false<span class="tag">&lt;/<span class="name">boolProp</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;Argument.value&quot;</span>&gt;</span>load-test-project<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;Argument.name&quot;</span>&gt;</span>projectId<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">elementProp</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">collectionProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">elementProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;HTTPSampler.domain&quot;</span>&gt;</span>$&#123;base_url&#125;<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;HTTPSampler.port&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;HTTPSampler.protocol&quot;</span>&gt;</span>https<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;HTTPSampler.contentEncoding&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;HTTPSampler.path&quot;</span>&gt;</span>/api/v1/files/upload<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;HTTPSampler.method&quot;</span>&gt;</span>POST<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">boolProp</span> <span class="attr">name</span>=<span class="string">&quot;HTTPSampler.follow_redirects&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">boolProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">boolProp</span> <span class="attr">name</span>=<span class="string">&quot;HTTPSampler.auto_redirects&quot;</span>&gt;</span>false<span class="tag">&lt;/<span class="name">boolProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">boolProp</span> <span class="attr">name</span>=<span class="string">&quot;HTTPSampler.use_keepalive&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">boolProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">boolProp</span> <span class="attr">name</span>=<span class="string">&quot;HTTPSampler.DO_MULTIPART_POST&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">boolProp</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">HTTPSamplerProxy</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">hashTree</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">hashTree</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">hashTree</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">jmeterTestPlan</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="External-Resources-and-Documentation"><a href="#External-Resources-and-Documentation" class="headerlink" title="External Resources and Documentation"></a>External Resources and Documentation</h2><h3 id="Essential-Resources"><a href="#Essential-Resources" class="headerlink" title="Essential Resources"></a>Essential Resources</h3><p><strong>Google Cloud Storage Documentation:</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://cloud.google.com/storage/docs/best-practices">GCS Best Practices Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.google.com/storage/docs/storage-classes">Storage Classes and Lifecycle Management</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.google.com/storage/docs/resumable-uploads">Resumable Uploads</a></li>
</ul>
<p><strong>PostgreSQL Performance:</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://wiki.postgresql.org/wiki/Performance_Optimization">PostgreSQL Performance Tuning Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://use-the-index-luke.com/">Indexing Strategies</a></li>
<li><a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/current/datatype-json.html">JSONB Performance</a></li>
</ul>
<p><strong>Spring Boot Integration:</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://spring.io/guides/gs/uploading-files/">Spring Boot File Upload</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/">Spring Security Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html">Spring Boot Actuator</a></li>
</ul>
<p><strong>Monitoring and Observability:</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://micrometer.io/docs">Micrometer Metrics</a></li>
<li><a target="_blank" rel="noopener" href="https://prometheus.io/docs/practices/naming/">Prometheus Best Practices</a></li>
<li><a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards">Grafana Dashboard Examples</a></li>
</ul>
<p><strong>Security Best Practices:</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload">OWASP File Upload Security</a></li>
<li><a target="_blank" rel="noopener" href="https://auth0.com/blog/a-look-at-the-latest-draft-for-jwt-bcp/">JWT Security Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.google.com/security/best-practices">Google Cloud Security Best Practices</a></li>
</ul>
<p>This comprehensive file storage service design provides a production-ready, scalable solution that handles millions of files efficiently while maintaining high availability, security, and performance standards. The architecture supports both small and large file operations, implements intelligent cost optimization, and provides robust monitoring and disaster recovery capabilities.
    </p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/system-design/" rel="tag"># system-design</a>
              <a href="/tags/file-storage/" rel="tag"># file storage</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/08/03/K8s-common-interview-questions/" rel="prev" title="K8s common interview questions">
                  <i class="fa fa-angle-left"></i> K8s common interview questions
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Charlie Feng</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
