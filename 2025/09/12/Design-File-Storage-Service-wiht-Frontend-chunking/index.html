<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"shayne007.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="File Storage Service Design GuideSystem Architecture OverviewA production-ready File Storage Service requires careful consideration of scalability, reliability, security, and performance. This service">
<meta property="og:type" content="article">
<meta property="og:title" content="Design File Storage Service wiht Frontend chunking">
<meta property="og:url" content="https://shayne007.github.io/2025/09/12/Design-File-Storage-Service-wiht-Frontend-chunking/index.html">
<meta property="og:site_name" content="Charlie Feng&#39;s Tech Space">
<meta property="og:description" content="File Storage Service Design GuideSystem Architecture OverviewA production-ready File Storage Service requires careful consideration of scalability, reliability, security, and performance. This service">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-09-11T16:19:55.000Z">
<meta property="article:modified_time" content="2025-09-11T16:26:51.701Z">
<meta property="article:author" content="Charlie Feng">
<meta property="article:tag" content="system-design">
<meta property="article:tag" content="file storage">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://shayne007.github.io/2025/09/12/Design-File-Storage-Service-wiht-Frontend-chunking/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://shayne007.github.io/2025/09/12/Design-File-Storage-Service-wiht-Frontend-chunking/","path":"2025/09/12/Design-File-Storage-Service-wiht-Frontend-chunking/","title":"Design File Storage Service wiht Frontend chunking"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Design File Storage Service wiht Frontend chunking | Charlie Feng's Tech Space</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"cdn":false,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.5.0/mermaid.min.js","integrity":"sha256-2obLuIPcceEhkE3G09G33hBdmE55ivVcZUlcKcGNHjU="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>





  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Charlie Feng's Tech Space</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">You will survive with skills</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#File-Storage-Service-Design-Guide"><span class="nav-number">1.</span> <span class="nav-text">File Storage Service Design Guide</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#System-Architecture-Overview"><span class="nav-number">1.1.</span> <span class="nav-text">System Architecture Overview</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Database-Schema-Design"><span class="nav-number">1.2.</span> <span class="nav-text">Database Schema Design</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Core-Service-Implementation"><span class="nav-number">1.3.</span> <span class="nav-text">Core Service Implementation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#File-Service-Interface"><span class="nav-number">1.3.1.</span> <span class="nav-text">File Service Interface</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#File-Storage-Service-Implementation"><span class="nav-number">1.3.2.</span> <span class="nav-text">File Storage Service Implementation</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#API-Endpoints-Design"><span class="nav-number">1.4.</span> <span class="nav-text">API Endpoints Design</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#REST-API-Specification"><span class="nav-number">1.4.1.</span> <span class="nav-text">REST API Specification</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#API-Request-Response-Models"><span class="nav-number">1.4.2.</span> <span class="nav-text">API Request&#x2F;Response Models</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#File-Storage-SDK-Implementation"><span class="nav-number">1.5.</span> <span class="nav-text">File Storage SDK Implementation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SDK-Architecture"><span class="nav-number">1.5.1.</span> <span class="nav-text">SDK Architecture</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SDK-Usage-Examples"><span class="nav-number">1.5.2.</span> <span class="nav-text">SDK Usage Examples</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chunked-Upload-Flow"><span class="nav-number">1.6.</span> <span class="nav-text">Chunked Upload Flow</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Chunked-Upload-Implementation-Details"><span class="nav-number">1.6.1.</span> <span class="nav-text">Chunked Upload Implementation Details</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Security-and-Authentication"><span class="nav-number">1.7.</span> <span class="nav-text">Security and Authentication</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#API-Security-Implementation"><span class="nav-number">1.7.1.</span> <span class="nav-text">API Security Implementation</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Performance-Optimization"><span class="nav-number">1.8.</span> <span class="nav-text">Performance Optimization</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Caching-Strategy"><span class="nav-number">1.8.1.</span> <span class="nav-text">Caching Strategy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Monitoring-and-Observability"><span class="nav-number">1.8.2.</span> <span class="nav-text">Monitoring and Observability</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Error-Handling-and-Resilience"><span class="nav-number">1.9.</span> <span class="nav-text">Error Handling and Resilience</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Comprehensive-Error-Handling"><span class="nav-number">1.9.1.</span> <span class="nav-text">Comprehensive Error Handling</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Deployment-and-Infrastructure"><span class="nav-number">1.10.</span> <span class="nav-text">Deployment and Infrastructure</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Docker-Configuration"><span class="nav-number">1.10.1.</span> <span class="nav-text">Docker Configuration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kubernetes-Deployment"><span class="nav-number">1.10.2.</span> <span class="nav-text">Kubernetes Deployment</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Testing-Strategy"><span class="nav-number">1.11.</span> <span class="nav-text">Testing Strategy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Integration-Testing"><span class="nav-number">1.11.1.</span> <span class="nav-text">Integration Testing</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Common-Interview-Questions-Answers"><span class="nav-number">1.12.</span> <span class="nav-text">Common Interview Questions &amp; Answers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Best-Practices-and-Recommendations"><span class="nav-number">1.13.</span> <span class="nav-text">Best Practices and Recommendations</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Production-Deployment-Checklist"><span class="nav-number">1.13.1.</span> <span class="nav-text">Production Deployment Checklist</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#External-Resources"><span class="nav-number">1.13.2.</span> <span class="nav-text">External Resources</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Charlie Feng</p>
  <div class="site-description" itemprop="description">This place is for thinking and sharing.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/09/12/Design-File-Storage-Service-wiht-Frontend-chunking/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Design File Storage Service wiht Frontend chunking | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Design File Storage Service wiht Frontend chunking
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-09-12 00:19:55 / Modified: 00:26:51" itemprop="dateCreated datePublished" datetime="2025-09-12T00:19:55+08:00">2025-09-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system-design/" itemprop="url" rel="index"><span itemprop="name">system-design</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="File-Storage-Service-Design-Guide"><a href="#File-Storage-Service-Design-Guide" class="headerlink" title="File Storage Service Design Guide"></a>File Storage Service Design Guide</h1><h2 id="System-Architecture-Overview"><a href="#System-Architecture-Overview" class="headerlink" title="System Architecture Overview"></a>System Architecture Overview</h2><p>A production-ready File Storage Service requires careful consideration of scalability, reliability, security, and performance. This service acts as a centralized file management system that abstracts the complexity of cloud storage while providing rich metadata capabilities through PostgreSQL.</p>
<pre>
<code class="mermaid">
graph TB
A[Client Applications] --&gt; B[Load Balancer]
B --&gt; C[File Storage API Gateway]
C --&gt; D[File Storage Service Cluster]
D --&gt; E[PostgreSQL Cluster]
D --&gt; F[Google Cloud Storage]
D --&gt; G[Redis Cache]
H[File Storage SDK] --&gt; C
I[Monitoring &amp; Logging] --&gt; D
J[CDN] --&gt; F
</code>
</pre>

<p>The architecture follows a microservices pattern where the File Storage Service is independently deployable and scalable. The service handles both file operations and metadata management, ensuring data consistency and providing high availability.</p>
<p><strong>Interview Insight</strong>: <em>When asked about system architecture decisions, emphasize the separation of concerns - metadata in PostgreSQL for complex queries and actual files in GCS for scalability and durability.</em></p>
<h2 id="Database-Schema-Design"><a href="#Database-Schema-Design" class="headerlink" title="Database Schema Design"></a>Database Schema Design</h2><p>The PostgreSQL schema is designed to support various file types, track upload progress for chunked uploads, and maintain audit trails.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Files table for storing file metadata</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> files (</span><br><span class="line">    id UUID <span class="keyword">PRIMARY KEY</span> <span class="keyword">DEFAULT</span> gen_random_uuid(),</span><br><span class="line">    filename <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    original_filename <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    file_size <span class="type">BIGINT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    mime_type <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    file_hash <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT NULL</span>, <span class="comment">-- SHA-256 hash for deduplication</span></span><br><span class="line">    gcs_bucket <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    gcs_object_key <span class="type">VARCHAR</span>(<span class="number">500</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    upload_status <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;PENDING&#x27;</span>, <span class="comment">-- PENDING, UPLOADING, COMPLETED, FAILED</span></span><br><span class="line">    created_by UUID <span class="keyword">NOT NULL</span>,</span><br><span class="line">    project_id UUID,</span><br><span class="line">    tags JSONB,</span><br><span class="line">    metadata JSONB, <span class="comment">-- Extensible metadata storage</span></span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">WITH</span> <span class="type">TIME</span> ZONE <span class="keyword">DEFAULT</span> NOW(),</span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span> <span class="keyword">WITH</span> <span class="type">TIME</span> ZONE <span class="keyword">DEFAULT</span> NOW(),</span><br><span class="line">    expires_at <span class="type">TIMESTAMP</span> <span class="keyword">WITH</span> <span class="type">TIME</span> ZONE, <span class="comment">-- For temporary files</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">CONSTRAINT</span> valid_upload_status <span class="keyword">CHECK</span> (upload_status <span class="keyword">IN</span> (<span class="string">&#x27;PENDING&#x27;</span>, <span class="string">&#x27;UPLOADING&#x27;</span>, <span class="string">&#x27;COMPLETED&#x27;</span>, <span class="string">&#x27;FAILED&#x27;</span>))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Chunked uploads table for managing large file uploads</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> chunked_uploads (</span><br><span class="line">    id UUID <span class="keyword">PRIMARY KEY</span> <span class="keyword">DEFAULT</span> gen_random_uuid(),</span><br><span class="line">    file_id UUID <span class="keyword">REFERENCES</span> files(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE,</span><br><span class="line">    upload_id <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT NULL</span>, <span class="comment">-- GCS multipart upload ID</span></span><br><span class="line">    total_chunks <span class="type">INTEGER</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    completed_chunks <span class="type">INTEGER</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    chunk_size <span class="type">INTEGER</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">WITH</span> <span class="type">TIME</span> ZONE <span class="keyword">DEFAULT</span> NOW(),</span><br><span class="line">    expires_at <span class="type">TIMESTAMP</span> <span class="keyword">WITH</span> <span class="type">TIME</span> ZONE <span class="keyword">NOT NULL</span> <span class="comment">-- Cleanup incomplete uploads</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Chunks table for tracking individual chunk uploads</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> chunks (</span><br><span class="line">    id UUID <span class="keyword">PRIMARY KEY</span> <span class="keyword">DEFAULT</span> gen_random_uuid(),</span><br><span class="line">    chunked_upload_id UUID <span class="keyword">REFERENCES</span> chunked_uploads(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE,</span><br><span class="line">    chunk_number <span class="type">INTEGER</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    chunk_size <span class="type">INTEGER</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    etag <span class="type">VARCHAR</span>(<span class="number">255</span>), <span class="comment">-- GCS ETag for the chunk</span></span><br><span class="line">    uploaded_at <span class="type">TIMESTAMP</span> <span class="keyword">WITH</span> <span class="type">TIME</span> ZONE,</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">UNIQUE</span>(chunked_upload_id, chunk_number)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- File access logs for audit and analytics</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> file_access_logs (</span><br><span class="line">    id UUID <span class="keyword">PRIMARY KEY</span> <span class="keyword">DEFAULT</span> gen_random_uuid(),</span><br><span class="line">    file_id UUID <span class="keyword">REFERENCES</span> files(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">SET</span> <span class="keyword">NULL</span>,</span><br><span class="line">    access_type <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span>, <span class="comment">-- UPLOAD, DOWNLOAD, DELETE, VIEW</span></span><br><span class="line">    user_id UUID <span class="keyword">NOT NULL</span>,</span><br><span class="line">    ip_address INET,</span><br><span class="line">    user_agent TEXT,</span><br><span class="line">    accessed_at <span class="type">TIMESTAMP</span> <span class="keyword">WITH</span> <span class="type">TIME</span> ZONE <span class="keyword">DEFAULT</span> NOW()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Indexes for performance</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_files_project_id <span class="keyword">ON</span> files(project_id);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_files_created_by <span class="keyword">ON</span> files(created_by);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_files_file_hash <span class="keyword">ON</span> files(file_hash);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_files_upload_status <span class="keyword">ON</span> files(upload_status);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_files_created_at <span class="keyword">ON</span> files(created_at <span class="keyword">DESC</span>);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_chunked_uploads_file_id <span class="keyword">ON</span> chunked_uploads(file_id);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_chunks_chunked_upload_id <span class="keyword">ON</span> chunks(chunked_upload_id);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_file_access_logs_file_id <span class="keyword">ON</span> file_access_logs(file_id);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_file_access_logs_user_id <span class="keyword">ON</span> file_access_logs(user_id);</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>The schema design demonstrates understanding of ACID properties, referential integrity, and performance optimization. The JSONB fields provide flexibility while maintaining query performance.</em></p>
<h2 id="Core-Service-Implementation"><a href="#Core-Service-Implementation" class="headerlink" title="Core Service Implementation"></a>Core Service Implementation</h2><h3 id="File-Service-Interface"><a href="#File-Service-Interface" class="headerlink" title="File Service Interface"></a>File Service Interface</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FileStorageService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initiate a single file upload</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    FileUploadResponse <span class="title function_">uploadFile</span><span class="params">(FileUploadRequest request)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initiate a chunked upload for large files</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ChunkedUploadResponse <span class="title function_">initiateChunkedUpload</span><span class="params">(ChunkedUploadRequest request)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Upload a single chunk</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ChunkUploadResponse <span class="title function_">uploadChunk</span><span class="params">(ChunkUploadRequest request)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Complete chunked upload</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    FileUploadResponse <span class="title function_">completeChunkedUpload</span><span class="params">(CompleteChunkedUploadRequest request)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Generate signed download URL</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    FileDownloadResponse <span class="title function_">getDownloadUrl</span><span class="params">(String fileId, Duration expiration)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Query files with filtering and pagination</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    FileQueryResponse <span class="title function_">queryFiles</span><span class="params">(FileQueryRequest request)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Delete a file</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deleteFile</span><span class="params">(String fileId, String userId)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get file metadata</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    FileMetadata <span class="title function_">getFileMetadata</span><span class="params">(String fileId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="File-Storage-Service-Implementation"><a href="#File-Storage-Service-Implementation" class="headerlink" title="File Storage Service Implementation"></a>File Storage Service Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">FileStorageService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileRepository fileRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChunkedUploadRepository chunkedUploadRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GcsStorageClient gcsClient;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileAccessLogger accessLogger;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FileUploadResponse <span class="title function_">uploadFile</span><span class="params">(FileUploadRequest request)</span> &#123;</span><br><span class="line">        validateUploadRequest(request);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check for file deduplication</span></span><br><span class="line">        Optional&lt;FileEntity&gt; existingFile = fileRepository</span><br><span class="line">            .findByFileHashAndProjectId(request.getFileHash(), request.getProjectId());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (existingFile.isPresent() &amp;&amp; request.isAllowDeduplication()) &#123;</span><br><span class="line">            <span class="keyword">return</span> createDeduplicationResponse(existingFile.get());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Create file entity</span></span><br><span class="line">        <span class="type">FileEntity</span> <span class="variable">fileEntity</span> <span class="operator">=</span> FileEntity.builder()</span><br><span class="line">            .filename(generateUniqueFilename(request.getOriginalFilename()))</span><br><span class="line">            .originalFilename(request.getOriginalFilename())</span><br><span class="line">            .fileSize(request.getFileSize())</span><br><span class="line">            .mimeType(request.getMimeType())</span><br><span class="line">            .fileHash(request.getFileHash())</span><br><span class="line">            .gcsBucket(gcsClient.getDefaultBucket())</span><br><span class="line">            .gcsObjectKey(generateObjectKey(request))</span><br><span class="line">            .uploadStatus(UploadStatus.PENDING)</span><br><span class="line">            .createdBy(request.getUserId())</span><br><span class="line">            .projectId(request.getProjectId())</span><br><span class="line">            .tags(request.getTags())</span><br><span class="line">            .metadata(request.getMetadata())</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        fileEntity = fileRepository.save(fileEntity);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Generate signed upload URL</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">signedUrl</span> <span class="operator">=</span> gcsClient.generateSignedUploadUrl(</span><br><span class="line">                fileEntity.getGcsBucket(),</span><br><span class="line">                fileEntity.getGcsObjectKey(),</span><br><span class="line">                request.getMimeType(),</span><br><span class="line">                Duration.ofHours(<span class="number">1</span>)</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Cache upload session</span></span><br><span class="line">            cacheUploadSession(fileEntity.getId(), request.getUserId());</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> FileUploadResponse.builder()</span><br><span class="line">                .fileId(fileEntity.getId())</span><br><span class="line">                .uploadUrl(signedUrl)</span><br><span class="line">                .expiresAt(Instant.now().plus(Duration.ofHours(<span class="number">1</span>)))</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            fileEntity.setUploadStatus(UploadStatus.FAILED);</span><br><span class="line">            fileRepository.save(fileEntity);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileUploadException</span>(<span class="string">&quot;Failed to generate upload URL&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ChunkedUploadResponse <span class="title function_">initiateChunkedUpload</span><span class="params">(ChunkedUploadRequest request)</span> &#123;</span><br><span class="line">        validateChunkedUploadRequest(request);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Create file entity</span></span><br><span class="line">        <span class="type">FileEntity</span> <span class="variable">fileEntity</span> <span class="operator">=</span> createFileEntity(request);</span><br><span class="line">        fileEntity = fileRepository.save(fileEntity);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Initiate multipart upload in GCS</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">uploadId</span> <span class="operator">=</span> gcsClient.initiateMultipartUpload(</span><br><span class="line">                fileEntity.getGcsBucket(),</span><br><span class="line">                fileEntity.getGcsObjectKey(),</span><br><span class="line">                request.getMimeType()</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Create chunked upload entity</span></span><br><span class="line">            <span class="type">ChunkedUploadEntity</span> <span class="variable">chunkedUpload</span> <span class="operator">=</span> ChunkedUploadEntity.builder()</span><br><span class="line">                .fileId(fileEntity.getId())</span><br><span class="line">                .uploadId(uploadId)</span><br><span class="line">                .totalChunks(request.getTotalChunks())</span><br><span class="line">                .chunkSize(request.getChunkSize())</span><br><span class="line">                .expiresAt(Instant.now().plus(Duration.ofDays(<span class="number">1</span>)))</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">            chunkedUpload = chunkedUploadRepository.save(chunkedUpload);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> ChunkedUploadResponse.builder()</span><br><span class="line">                .fileId(fileEntity.getId())</span><br><span class="line">                .uploadId(chunkedUpload.getId())</span><br><span class="line">                .expiresAt(chunkedUpload.getExpiresAt())</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            fileEntity.setUploadStatus(UploadStatus.FAILED);</span><br><span class="line">            fileRepository.save(fileEntity);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileUploadException</span>(<span class="string">&quot;Failed to initiate chunked upload&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ChunkUploadResponse <span class="title function_">uploadChunk</span><span class="params">(ChunkUploadRequest request)</span> &#123;</span><br><span class="line">        <span class="type">ChunkedUploadEntity</span> <span class="variable">chunkedUpload</span> <span class="operator">=</span> chunkedUploadRepository</span><br><span class="line">            .findById(request.getUploadId())</span><br><span class="line">            .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">ChunkedUploadNotFoundException</span>(<span class="string">&quot;Upload not found&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        validateChunkUploadRequest(request, chunkedUpload);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Generate signed URL for chunk upload</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">signedUrl</span> <span class="operator">=</span> gcsClient.generateSignedChunkUploadUrl(</span><br><span class="line">                chunkedUpload.getUploadId(),</span><br><span class="line">                request.getChunkNumber(),</span><br><span class="line">                Duration.ofHours(<span class="number">1</span>)</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> ChunkUploadResponse.builder()</span><br><span class="line">                .chunkUploadUrl(signedUrl)</span><br><span class="line">                .expiresAt(Instant.now().plus(Duration.ofHours(<span class="number">1</span>)))</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ChunkUploadException</span>(<span class="string">&quot;Failed to generate chunk upload URL&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FileDownloadResponse <span class="title function_">getDownloadUrl</span><span class="params">(String fileId, Duration expiration)</span> &#123;</span><br><span class="line">        <span class="type">FileEntity</span> <span class="variable">fileEntity</span> <span class="operator">=</span> fileRepository.findById(UUID.fromString(fileId))</span><br><span class="line">            .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">FileNotFoundException</span>(<span class="string">&quot;File not found&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (fileEntity.getUploadStatus() != UploadStatus.COMPLETED) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileNotAvailableException</span>(<span class="string">&quot;File is not available for download&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">signedUrl</span> <span class="operator">=</span> gcsClient.generateSignedDownloadUrl(</span><br><span class="line">                fileEntity.getGcsBucket(),</span><br><span class="line">                fileEntity.getGcsObjectKey(),</span><br><span class="line">                expiration</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Log access</span></span><br><span class="line">            accessLogger.logAccess(fileId, AccessType.DOWNLOAD);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> FileDownloadResponse.builder()</span><br><span class="line">                .downloadUrl(signedUrl)</span><br><span class="line">                .filename(fileEntity.getOriginalFilename())</span><br><span class="line">                .fileSize(fileEntity.getFileSize())</span><br><span class="line">                .mimeType(fileEntity.getMimeType())</span><br><span class="line">                .expiresAt(Instant.now().plus(expiration))</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileDownloadException</span>(<span class="string">&quot;Failed to generate download URL&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>This implementation demonstrates proper error handling, transaction management, and separation of concerns. The use of signed URLs ensures security while offloading bandwidth from your servers.</em></p>
<h2 id="API-Endpoints-Design"><a href="#API-Endpoints-Design" class="headerlink" title="API Endpoints Design"></a>API Endpoints Design</h2><h3 id="REST-API-Specification"><a href="#REST-API-Specification" class="headerlink" title="REST API Specification"></a>REST API Specification</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/v1/files&quot;)</span></span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileStorageService fileStorageService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Upload a single file (&lt; 10MB)</span></span><br><span class="line"><span class="comment">     * POST /api/v1/files/upload</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;FileUploadResponse&gt; <span class="title function_">uploadFile</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@Valid</span> <span class="meta">@RequestBody</span> FileUploadRequest request)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">FileUploadResponse</span> <span class="variable">response</span> <span class="operator">=</span> fileStorageService.uploadFile(request);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initiate chunked upload for large files</span></span><br><span class="line"><span class="comment">     * POST /api/v1/files/upload/chunked</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload/chunked&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;ChunkedUploadResponse&gt; <span class="title function_">initiateChunkedUpload</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@Valid</span> <span class="meta">@RequestBody</span> ChunkedUploadRequest request)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">ChunkedUploadResponse</span> <span class="variable">response</span> <span class="operator">=</span> fileStorageService.initiateChunkedUpload(request);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.CREATED).body(response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get upload URL for a specific chunk</span></span><br><span class="line"><span class="comment">     * POST /api/v1/files/upload/chunked/&#123;uploadId&#125;/chunks/&#123;chunkNumber&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload/chunked/&#123;uploadId&#125;/chunks/&#123;chunkNumber&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;ChunkUploadResponse&gt; <span class="title function_">getChunkUploadUrl</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String uploadId,</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> Integer chunkNumber)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">ChunkUploadRequest</span> <span class="variable">request</span> <span class="operator">=</span> ChunkUploadRequest.builder()</span><br><span class="line">            .uploadId(uploadId)</span><br><span class="line">            .chunkNumber(chunkNumber)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="type">ChunkUploadResponse</span> <span class="variable">response</span> <span class="operator">=</span> fileStorageService.uploadChunk(request);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Complete chunked upload</span></span><br><span class="line"><span class="comment">     * POST /api/v1/files/upload/chunked/&#123;uploadId&#125;/complete</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload/chunked/&#123;uploadId&#125;/complete&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;FileUploadResponse&gt; <span class="title function_">completeChunkedUpload</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String uploadId,</span></span><br><span class="line"><span class="params">            <span class="meta">@Valid</span> <span class="meta">@RequestBody</span> CompleteChunkedUploadRequest request)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        request.setUploadId(uploadId);</span><br><span class="line">        <span class="type">FileUploadResponse</span> <span class="variable">response</span> <span class="operator">=</span> fileStorageService.completeChunkedUpload(request);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get file download URL</span></span><br><span class="line"><span class="comment">     * GET /api/v1/files/&#123;fileId&#125;/download</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;fileId&#125;/download&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;FileDownloadResponse&gt; <span class="title function_">getDownloadUrl</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String fileId,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(defaultValue = &quot;3600&quot;)</span> Long expirationSeconds)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">Duration</span> <span class="variable">expiration</span> <span class="operator">=</span> Duration.ofSeconds(expirationSeconds);</span><br><span class="line">        <span class="type">FileDownloadResponse</span> <span class="variable">response</span> <span class="operator">=</span> fileStorageService.getDownloadUrl(fileId, expiration);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Query files with filtering and pagination</span></span><br><span class="line"><span class="comment">     * GET /api/v1/files</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;FileQueryResponse&gt; <span class="title function_">queryFiles</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(required = false)</span> String projectId,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(required = false)</span> List&lt;String&gt; mimeTypes,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(required = false)</span> String createdBy,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(required = false)</span> <span class="meta">@DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME)</span> Instant createdAfter,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(required = false)</span> <span class="meta">@DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME)</span> Instant createdBefore,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(defaultValue = &quot;0&quot;)</span> Integer page,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(defaultValue = &quot;20&quot;)</span> Integer size,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(defaultValue = &quot;createdAt,desc&quot;)</span> String sort)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">FileQueryRequest</span> <span class="variable">request</span> <span class="operator">=</span> FileQueryRequest.builder()</span><br><span class="line">            .projectId(projectId)</span><br><span class="line">            .mimeTypes(mimeTypes)</span><br><span class="line">            .createdBy(createdBy)</span><br><span class="line">            .createdAfter(createdAfter)</span><br><span class="line">            .createdBefore(createdBefore)</span><br><span class="line">            .page(page)</span><br><span class="line">            .size(size)</span><br><span class="line">            .sort(sort)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="type">FileQueryResponse</span> <span class="variable">response</span> <span class="operator">=</span> fileStorageService.queryFiles(request);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get file metadata</span></span><br><span class="line"><span class="comment">     * GET /api/v1/files/&#123;fileId&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;fileId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;FileMetadata&gt; <span class="title function_">getFileMetadata</span><span class="params">(<span class="meta">@PathVariable</span> String fileId)</span> &#123;</span><br><span class="line">        <span class="type">FileMetadata</span> <span class="variable">metadata</span> <span class="operator">=</span> fileStorageService.getFileMetadata(fileId);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(metadata);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Delete file</span></span><br><span class="line"><span class="comment">     * DELETE /api/v1/files/&#123;fileId&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/&#123;fileId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Void&gt; <span class="title function_">deleteFile</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String fileId,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestHeader(&quot;X-User-Id&quot;)</span> String userId)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        fileStorageService.deleteFile(fileId, userId);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.noContent().build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="API-Request-Response-Models"><a href="#API-Request-Response-Models" class="headerlink" title="API Request&#x2F;Response Models"></a>API Request&#x2F;Response Models</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Request models</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileUploadRequest</span> &#123;</span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Size(min = 1, max = 255)</span></span><br><span class="line">    <span class="keyword">private</span> String originalFilename;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Min(1)</span></span><br><span class="line">    <span class="keyword">private</span> Long fileSize;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Size(min = 1, max = 100)</span></span><br><span class="line">    <span class="keyword">private</span> String mimeType;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Size(min = 64, max = 64)</span></span><br><span class="line">    <span class="keyword">private</span> String fileHash; <span class="comment">// SHA-256</span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="keyword">private</span> String userId;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String projectId;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Valid</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; tags;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Valid</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; metadata;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Builder</span>.Default</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Boolean</span> <span class="variable">allowDeduplication</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChunkedUploadRequest</span> &#123;</span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Size(min = 1, max = 255)</span></span><br><span class="line">    <span class="keyword">private</span> String originalFilename;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Min(1)</span></span><br><span class="line">    <span class="keyword">private</span> Long fileSize;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Size(min = 1, max = 100)</span></span><br><span class="line">    <span class="keyword">private</span> String mimeType;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Size(min = 64, max = 64)</span></span><br><span class="line">    <span class="keyword">private</span> String fileHash;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="keyword">private</span> String userId;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String projectId;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Min(2)</span></span><br><span class="line">    <span class="meta">@Max(10000)</span></span><br><span class="line">    <span class="keyword">private</span> Integer totalChunks;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Min(1048576)</span> <span class="comment">// 1MB minimum</span></span><br><span class="line">    <span class="meta">@Max(104857600)</span> <span class="comment">// 100MB maximum</span></span><br><span class="line">    <span class="keyword">private</span> Integer chunkSize;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; tags;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; metadata;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Response models</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileUploadResponse</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String fileId;</span><br><span class="line">    <span class="keyword">private</span> String uploadUrl;</span><br><span class="line">    <span class="keyword">private</span> Instant expiresAt;</span><br><span class="line">    <span class="keyword">private</span> Boolean isDuplicate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChunkedUploadResponse</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String fileId;</span><br><span class="line">    <span class="keyword">private</span> String uploadId;</span><br><span class="line">    <span class="keyword">private</span> Instant expiresAt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileDownloadResponse</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String downloadUrl;</span><br><span class="line">    <span class="keyword">private</span> String filename;</span><br><span class="line">    <span class="keyword">private</span> Long fileSize;</span><br><span class="line">    <span class="keyword">private</span> String mimeType;</span><br><span class="line">    <span class="keyword">private</span> Instant expiresAt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="File-Storage-SDK-Implementation"><a href="#File-Storage-SDK-Implementation" class="headerlink" title="File Storage SDK Implementation"></a>File Storage SDK Implementation</h2><h3 id="SDK-Architecture"><a href="#SDK-Architecture" class="headerlink" title="SDK Architecture"></a>SDK Architecture</h3><p>The SDK provides a clean abstraction layer for client applications, handling authentication, retries, and error handling automatically.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageSDK</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileStorageClient client;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RetryPolicy retryPolicy;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthenticationProvider authProvider;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FileStorageSDK</span><span class="params">(FileStorageConfig config)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.client = <span class="keyword">new</span> <span class="title class_">FileStorageClient</span>(config);</span><br><span class="line">        <span class="built_in">this</span>.retryPolicy = createRetryPolicy(config);</span><br><span class="line">        <span class="built_in">this</span>.authProvider = <span class="keyword">new</span> <span class="title class_">AuthenticationProvider</span>(config);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Upload a single file</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;FileUploadResult&gt; <span class="title function_">uploadFile</span><span class="params">(File file, UploadOptions options)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                validateFile(file);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (file.length() &gt; options.getChunkThreshold()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> uploadFileInChunks(file, options);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> uploadSingleFile(file, options);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileUploadException</span>(<span class="string">&quot;Upload failed&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Download a file</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;File&gt; <span class="title function_">downloadFile</span><span class="params">(String fileId, File destination)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">FileDownloadResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.getDownloadUrl(fileId);</span><br><span class="line">                <span class="keyword">return</span> downloadFromSignedUrl(response.getDownloadUrl(), destination);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileDownloadException</span>(<span class="string">&quot;Download failed&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Upload file with progress callback</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;FileUploadResult&gt; <span class="title function_">uploadFileWithProgress</span><span class="params">(</span></span><br><span class="line"><span class="params">            File file, </span></span><br><span class="line"><span class="params">            UploadOptions options, </span></span><br><span class="line"><span class="params">            ProgressCallback callback)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (file.length() &lt;= options.getChunkThreshold()) &#123;</span><br><span class="line">            <span class="keyword">return</span> uploadSingleFileWithProgress(file, options, callback);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> uploadFileInChunksWithProgress(file, options, callback);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> FileUploadResult <span class="title function_">uploadFileInChunksWithProgress</span><span class="params">(</span></span><br><span class="line"><span class="params">            File file, </span></span><br><span class="line"><span class="params">            UploadOptions options, </span></span><br><span class="line"><span class="params">            ProgressCallback callback)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Calculate file hash</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">fileHash</span> <span class="operator">=</span> calculateSHA256(file);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Calculate chunks</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">chunkSize</span> <span class="operator">=</span> options.getChunkSize();</span><br><span class="line">            <span class="type">int</span> <span class="variable">totalChunks</span> <span class="operator">=</span> (<span class="type">int</span>) Math.ceil((<span class="type">double</span>) file.length() / chunkSize);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Initiate chunked upload</span></span><br><span class="line">            <span class="type">ChunkedUploadRequest</span> <span class="variable">request</span> <span class="operator">=</span> ChunkedUploadRequest.builder()</span><br><span class="line">                .originalFilename(file.getName())</span><br><span class="line">                .fileSize(file.length())</span><br><span class="line">                .mimeType(detectMimeType(file))</span><br><span class="line">                .fileHash(fileHash)</span><br><span class="line">                .userId(options.getUserId())</span><br><span class="line">                .projectId(options.getProjectId())</span><br><span class="line">                .totalChunks(totalChunks)</span><br><span class="line">                .chunkSize((<span class="type">int</span>) chunkSize)</span><br><span class="line">                .tags(options.getTags())</span><br><span class="line">                .metadata(options.getMetadata())</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">            <span class="type">ChunkedUploadResponse</span> <span class="variable">uploadResponse</span> <span class="operator">=</span> client.initiateChunkedUpload(request);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Upload chunks</span></span><br><span class="line">            List&lt;ChunkInfo&gt; chunkInfos = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">RandomAccessFile</span> <span class="variable">raf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(file, <span class="string">&quot;r&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; totalChunks; i++) &#123;</span><br><span class="line">                    <span class="type">long</span> <span class="variable">offset</span> <span class="operator">=</span> (<span class="type">long</span>) i * chunkSize;</span><br><span class="line">                    <span class="type">long</span> <span class="variable">currentChunkSize</span> <span class="operator">=</span> Math.min(chunkSize, file.length() - offset);</span><br><span class="line">                    </span><br><span class="line">                    <span class="type">ChunkUploadResponse</span> <span class="variable">chunkResponse</span> <span class="operator">=</span> client.getChunkUploadUrl(</span><br><span class="line">                        uploadResponse.getUploadId(), i + <span class="number">1</span>);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// Upload chunk to GCS</span></span><br><span class="line">                    <span class="type">byte</span>[] chunkData = <span class="keyword">new</span> <span class="title class_">byte</span>[(<span class="type">int</span>) currentChunkSize];</span><br><span class="line">                    raf.seek(offset);</span><br><span class="line">                    raf.readFully(chunkData);</span><br><span class="line">                    </span><br><span class="line">                    <span class="type">String</span> <span class="variable">etag</span> <span class="operator">=</span> uploadChunkToGCS(chunkResponse.getChunkUploadUrl(), chunkData);</span><br><span class="line">                    </span><br><span class="line">                    chunkInfos.add(<span class="keyword">new</span> <span class="title class_">ChunkInfo</span>(i + <span class="number">1</span>, etag));</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// Update progress</span></span><br><span class="line">                    <span class="keyword">if</span> (callback != <span class="literal">null</span>) &#123;</span><br><span class="line">                        callback.onProgress((<span class="type">double</span>) (i + <span class="number">1</span>) / totalChunks);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Complete upload</span></span><br><span class="line">            <span class="type">CompleteChunkedUploadRequest</span> <span class="variable">completeRequest</span> <span class="operator">=</span> CompleteChunkedUploadRequest.builder()</span><br><span class="line">                .uploadId(uploadResponse.getUploadId())</span><br><span class="line">                .chunks(chunkInfos)</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">            <span class="type">FileUploadResponse</span> <span class="variable">finalResponse</span> <span class="operator">=</span> client.completeChunkedUpload(completeRequest);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (callback != <span class="literal">null</span>) &#123;</span><br><span class="line">                callback.onComplete();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> FileUploadResult.builder()</span><br><span class="line">                .fileId(finalResponse.getFileId())</span><br><span class="line">                .filename(file.getName())</span><br><span class="line">                .fileSize(file.length())</span><br><span class="line">                .uploadedAt(Instant.now())</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (callback != <span class="literal">null</span>) &#123;</span><br><span class="line">                callback.onError(e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileUploadException</span>(<span class="string">&quot;Chunked upload failed&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Query files with fluent API</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> FileQuery <span class="title function_">queryFiles</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FileQuery</span>(client);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Fluent query builder</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">FileQuery</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> FileStorageClient client;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> FileQueryRequest.FileQueryRequestBuilder builder;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">FileQuery</span><span class="params">(FileStorageClient client)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.client = client;</span><br><span class="line">            <span class="built_in">this</span>.builder = FileQueryRequest.builder();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> FileQuery <span class="title function_">inProject</span><span class="params">(String projectId)</span> &#123;</span><br><span class="line">            builder.projectId(projectId);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> FileQuery <span class="title function_">withMimeTypes</span><span class="params">(String... mimeTypes)</span> &#123;</span><br><span class="line">            builder.mimeTypes(Arrays.asList(mimeTypes));</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> FileQuery <span class="title function_">createdBy</span><span class="params">(String userId)</span> &#123;</span><br><span class="line">            builder.createdBy(userId);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> FileQuery <span class="title function_">createdAfter</span><span class="params">(Instant after)</span> &#123;</span><br><span class="line">            builder.createdAfter(after);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> FileQuery <span class="title function_">pageSize</span><span class="params">(<span class="type">int</span> size)</span> &#123;</span><br><span class="line">            builder.size(size);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> FileQuery <span class="title function_">page</span><span class="params">(<span class="type">int</span> page)</span> &#123;</span><br><span class="line">            builder.page(page);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> CompletableFuture&lt;FileQueryResult&gt; <span class="title function_">execute</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">FileQueryResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.queryFiles(builder.build());</span><br><span class="line">                    <span class="keyword">return</span> FileQueryResult.from(response);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileQueryException</span>(<span class="string">&quot;Query failed&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SDK-Usage-Examples"><a href="#SDK-Usage-Examples" class="headerlink" title="SDK Usage Examples"></a>SDK Usage Examples</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Initialize SDK</span></span><br><span class="line"><span class="type">FileStorageConfig</span> <span class="variable">config</span> <span class="operator">=</span> FileStorageConfig.builder()</span><br><span class="line">    .baseUrl(<span class="string">&quot;https://api.example.com&quot;</span>)</span><br><span class="line">    .apiKey(<span class="string">&quot;your-api-key&quot;</span>)</span><br><span class="line">    .timeout(Duration.ofMinutes(<span class="number">5</span>))</span><br><span class="line">    .chunkSize(<span class="number">5</span> * <span class="number">1024</span> * <span class="number">1024</span>) <span class="comment">// 5MB chunks</span></span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line"><span class="type">FileStorageSDK</span> <span class="variable">sdk</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileStorageSDK</span>(config);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Simple file upload</span></span><br><span class="line"><span class="type">File</span> <span class="variable">document</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;document.pdf&quot;</span>);</span><br><span class="line"><span class="type">UploadOptions</span> <span class="variable">options</span> <span class="operator">=</span> UploadOptions.builder()</span><br><span class="line">    .userId(<span class="string">&quot;user-123&quot;</span>)</span><br><span class="line">    .projectId(<span class="string">&quot;project-456&quot;</span>)</span><br><span class="line">    .tag(<span class="string">&quot;category&quot;</span>, <span class="string">&quot;documents&quot;</span>)</span><br><span class="line">    .metadata(<span class="string">&quot;department&quot;</span>, <span class="string">&quot;engineering&quot;</span>)</span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line">CompletableFuture&lt;FileUploadResult&gt; uploadFuture = sdk.uploadFile(document, options);</span><br><span class="line"><span class="type">FileUploadResult</span> <span class="variable">result</span> <span class="operator">=</span> uploadFuture.join();</span><br><span class="line">System.out.println(<span class="string">&quot;File uploaded: &quot;</span> + result.getFileId());</span><br><span class="line"></span><br><span class="line"><span class="comment">// Upload with progress tracking</span></span><br><span class="line">sdk.uploadFileWithProgress(document, options, <span class="keyword">new</span> <span class="title class_">ProgressCallback</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onProgress</span><span class="params">(<span class="type">double</span> progress)</span> &#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;Upload progress: %.2f%%\n&quot;</span>, progress * <span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onComplete</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Upload completed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Exception error)</span> &#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;Upload failed: &quot;</span> + error.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Query files</span></span><br><span class="line">CompletableFuture&lt;FileQueryResult&gt; queryFuture = sdk.queryFiles()</span><br><span class="line">    .inProject(<span class="string">&quot;project-456&quot;</span>)</span><br><span class="line">    .withMimeTypes(<span class="string">&quot;application/pdf&quot;</span>, <span class="string">&quot;image/jpeg&quot;</span>)</span><br><span class="line">    .createdAfter(Instant.now().minus(Duration.ofDays(<span class="number">30</span>)))</span><br><span class="line">    .pageSize(<span class="number">50</span>)</span><br><span class="line">    .execute();</span><br><span class="line"></span><br><span class="line"><span class="type">FileQueryResult</span> <span class="variable">queryResult</span> <span class="operator">=</span> queryFuture.join();</span><br><span class="line">queryResult.getFiles().forEach(file -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;File: &quot;</span> + file.getFilename() + <span class="string">&quot; (&quot;</span> + file.getFileSize() + <span class="string">&quot; bytes)&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Download file</span></span><br><span class="line">CompletableFuture&lt;File&gt; downloadFuture = sdk.downloadFile(</span><br><span class="line">    result.getFileId(), </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;downloads/document.pdf&quot;</span>)</span><br><span class="line">);</span><br><span class="line"><span class="type">File</span> <span class="variable">downloadedFile</span> <span class="operator">=</span> downloadFuture.join();</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>The SDK design demonstrates understanding of asynchronous programming, builder patterns, and clean API design. The fluent query interface shows advanced Java skills.</em></p>
<h2 id="Chunked-Upload-Flow"><a href="#Chunked-Upload-Flow" class="headerlink" title="Chunked Upload Flow"></a>Chunked Upload Flow</h2><p>The chunked upload mechanism handles large files efficiently by splitting them into manageable chunks and uploading them in parallel when possible.</p>
<pre>
<code class="mermaid">
sequenceDiagram
participant C as Client
participant API as File API
participant DB as PostgreSQL
participant GCS as Google Cloud Storage

Note over C,GCS: Large File Upload (&gt;10MB)

C-&gt;&gt;API: POST &#x2F;files&#x2F;upload&#x2F;chunked
API-&gt;&gt;DB: Create file metadata (PENDING)
API-&gt;&gt;GCS: Initiate multipart upload
GCS--&gt;&gt;API: Upload ID
API-&gt;&gt;DB: Create chunked_upload record
API--&gt;&gt;C: Return upload ID &amp; file ID

loop For each chunk
    C-&gt;&gt;API: POST &#x2F;upload&#x2F;chunked&#x2F;{uploadId}&#x2F;chunks&#x2F;{n}
    API--&gt;&gt;C: Return signed upload URL
    C-&gt;&gt;GCS: PUT chunk data to signed URL
    GCS--&gt;&gt;C: ETag response
    C-&gt;&gt;API: Notify chunk completion (ETag)
    API-&gt;&gt;DB: Update chunk status
end

C-&gt;&gt;API: POST &#x2F;upload&#x2F;chunked&#x2F;{uploadId}&#x2F;complete
API-&gt;&gt;GCS: Complete multipart upload
GCS--&gt;&gt;API: Final object info
API-&gt;&gt;DB: Update file status to COMPLETED
API--&gt;&gt;C: Return download URL
</code>
</pre>

<h3 id="Chunked-Upload-Implementation-Details"><a href="#Chunked-Upload-Implementation-Details" class="headerlink" title="Chunked Upload Implementation Details"></a>Chunked Upload Implementation Details</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChunkedUploadHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChunkedUploadRepository chunkedUploadRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChunkRepository chunkRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GcsStorageClient gcsClient;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TaskExecutor taskExecutor;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Process chunk completion asynchronously</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;Void&gt; <span class="title function_">handleChunkCompletion</span><span class="params">(</span></span><br><span class="line"><span class="params">            String uploadId, </span></span><br><span class="line"><span class="params">            Integer chunkNumber, </span></span><br><span class="line"><span class="params">            String etag)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">ChunkedUploadEntity</span> <span class="variable">upload</span> <span class="operator">=</span> chunkedUploadRepository.findById(uploadId)</span><br><span class="line">                    .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">ChunkedUploadNotFoundException</span>(<span class="string">&quot;Upload not found&quot;</span>));</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Update or create chunk record</span></span><br><span class="line">                <span class="type">ChunkEntity</span> <span class="variable">chunk</span> <span class="operator">=</span> chunkRepository</span><br><span class="line">                    .findByChunkedUploadIdAndChunkNumber(uploadId, chunkNumber)</span><br><span class="line">                    .orElse(ChunkEntity.builder()</span><br><span class="line">                        .chunkedUploadId(uploadId)</span><br><span class="line">                        .chunkNumber(chunkNumber)</span><br><span class="line">                        .build());</span><br><span class="line">                </span><br><span class="line">                chunk.setEtag(etag);</span><br><span class="line">                chunk.setUploadedAt(Instant.now());</span><br><span class="line">                chunkRepository.save(chunk);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Update completed chunks count</span></span><br><span class="line">                upload.setCompletedChunks(upload.getCompletedChunks() + <span class="number">1</span>);</span><br><span class="line">                chunkedUploadRepository.save(upload);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Check if all chunks are completed</span></span><br><span class="line">                <span class="keyword">if</span> (upload.getCompletedChunks().equals(upload.getTotalChunks())) &#123;</span><br><span class="line">                    notifyUploadCompletion(uploadId);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;Failed to handle chunk completion for upload: &#123;&#125;, chunk: &#123;&#125;&quot;</span>, </span><br><span class="line">                    uploadId, chunkNumber, e);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ChunkProcessingException</span>(<span class="string">&quot;Chunk processing failed&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, taskExecutor);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Auto-complete upload when all chunks are received</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">notifyUploadCompletion</span><span class="params">(String uploadId)</span> &#123;</span><br><span class="line">        <span class="comment">// Use event-driven approach for loose coupling</span></span><br><span class="line">        applicationEventPublisher.publishEvent(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ChunkedUploadCompletedEvent</span>(uploadId)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>The asynchronous processing of chunk completions demonstrates understanding of event-driven architecture and prevents blocking the upload API.</em></p>
<h2 id="Security-and-Authentication"><a href="#Security-and-Authentication" class="headerlink" title="Security and Authentication"></a>Security and Authentication</h2><h3 id="API-Security-Implementation"><a href="#API-Security-Implementation" class="headerlink" title="API Security Implementation"></a>API Security Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileSecurityService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtTokenProvider jwtTokenProvider;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PermissionService permissionService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RateLimitService rateLimitService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Validate file access permissions</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">validateFileAccess</span><span class="params">(String fileId, String userId, FileOperation operation)</span> &#123;</span><br><span class="line">        <span class="comment">// Check rate limits</span></span><br><span class="line">        <span class="keyword">if</span> (!rateLimitService.isAllowed(userId, operation)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RateLimitExceededException</span>(<span class="string">&quot;Rate limit exceeded&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Validate file ownership or permissions</span></span><br><span class="line">        <span class="type">FileEntity</span> <span class="variable">file</span> <span class="operator">=</span> fileRepository.findById(UUID.fromString(fileId))</span><br><span class="line">            .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">FileNotFoundException</span>(<span class="string">&quot;File not found&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!canUserAccessFile(file, userId, operation)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AccessDeniedException</span>(<span class="string">&quot;Insufficient permissions&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Validate file status for downloads</span></span><br><span class="line">        <span class="keyword">if</span> (operation == FileOperation.DOWNLOAD &amp;&amp; </span><br><span class="line">            file.getUploadStatus() != UploadStatus.COMPLETED) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileNotAvailableException</span>(<span class="string">&quot;File not available&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check file expiration</span></span><br><span class="line">        <span class="keyword">if</span> (file.getExpiresAt() != <span class="literal">null</span> &amp;&amp; </span><br><span class="line">            file.getExpiresAt().isBefore(Instant.now())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileExpiredException</span>(<span class="string">&quot;File has expired&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">canUserAccessFile</span><span class="params">(FileEntity file, String userId, FileOperation operation)</span> &#123;</span><br><span class="line">        <span class="comment">// Owner always has full access</span></span><br><span class="line">        <span class="keyword">if</span> (file.getCreatedBy().equals(UUID.fromString(userId))) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check project-level permissions</span></span><br><span class="line">        <span class="keyword">if</span> (file.getProjectId() != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> permissionService.hasProjectPermission(</span><br><span class="line">                userId, </span><br><span class="line">                file.getProjectId().toString(), </span><br><span class="line">                operation.toPermission()</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check organization-level permissions for non-project files</span></span><br><span class="line">        <span class="keyword">return</span> permissionService.hasOrganizationPermission(</span><br><span class="line">            userId, </span><br><span class="line">            operation.toPermission()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Generate secure signed URLs with additional validation</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generateSecureSignedUrl</span><span class="params">(String fileId, String userId, Duration expiration)</span> &#123;</span><br><span class="line">        validateFileAccess(fileId, userId, FileOperation.DOWNLOAD);</span><br><span class="line">        </span><br><span class="line">        <span class="type">FileEntity</span> <span class="variable">file</span> <span class="operator">=</span> fileRepository.findById(UUID.fromString(fileId))</span><br><span class="line">            .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">FileNotFoundException</span>(<span class="string">&quot;File not found&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Generate signed URL with custom headers for validation</span></span><br><span class="line">        Map&lt;String, String&gt; customHeaders = Map.of(</span><br><span class="line">            <span class="string">&quot;x-user-id&quot;</span>, userId,</span><br><span class="line">            <span class="string">&quot;x-file-id&quot;</span>, fileId,</span><br><span class="line">            <span class="string">&quot;x-timestamp&quot;</span>, String.valueOf(Instant.now().getEpochSecond())</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> gcsClient.generateSignedDownloadUrl(</span><br><span class="line">            file.getGcsBucket(),</span><br><span class="line">            file.getGcsObjectKey(),</span><br><span class="line">            expiration,</span><br><span class="line">            customHeaders</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Security interceptor for file operations</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileSecurityInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileSecurityService securityService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtTokenProvider jwtTokenProvider;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, </span></span><br><span class="line"><span class="params">                           HttpServletResponse response, </span></span><br><span class="line"><span class="params">                           Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> extractTokenFromRequest(request);</span><br><span class="line">        <span class="keyword">if</span> (token == <span class="literal">null</span> || !jwtTokenProvider.validateToken(token)) &#123;</span><br><span class="line">            response.setStatus(HttpStatus.UNAUTHORIZED.value());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> jwtTokenProvider.getUserIdFromToken(token);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Extract file ID from path</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileId</span> <span class="operator">=</span> extractFileIdFromPath(request.getRequestURI());</span><br><span class="line">        <span class="keyword">if</span> (fileId != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">FileOperation</span> <span class="variable">operation</span> <span class="operator">=</span> determineOperation(request.getMethod(), request.getRequestURI());</span><br><span class="line">            securityService.validateFileAccess(fileId, userId, operation);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Set user context for the request</span></span><br><span class="line">        SecurityContextHolder.getContext().setUserId(userId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Optimization"><a href="#Performance-Optimization" class="headerlink" title="Performance Optimization"></a>Performance Optimization</h2><h3 id="Caching-Strategy"><a href="#Caching-Strategy" class="headerlink" title="Caching Strategy"></a>Caching Strategy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileCacheService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CacheManager cacheManager;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">METADATA_CACHE_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;file:metadata:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DOWNLOAD_URL_CACHE_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;file:download:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Duration</span> <span class="variable">METADATA_CACHE_TTL</span> <span class="operator">=</span> Duration.ofMinutes(<span class="number">30</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Duration</span> <span class="variable">DOWNLOAD_URL_CACHE_TTL</span> <span class="operator">=</span> Duration.ofMinutes(<span class="number">5</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Cache file metadata with intelligent TTL</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Cacheable(value = &quot;fileMetadata&quot;, key = &quot;#fileId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> FileMetadata <span class="title function_">getFileMetadata</span><span class="params">(String fileId)</span> &#123;</span><br><span class="line">        <span class="comment">// Cache miss - load from database</span></span><br><span class="line">        <span class="type">FileEntity</span> <span class="variable">file</span> <span class="operator">=</span> fileRepository.findById(UUID.fromString(fileId))</span><br><span class="line">            .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">FileNotFoundException</span>(<span class="string">&quot;File not found&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="type">FileMetadata</span> <span class="variable">metadata</span> <span class="operator">=</span> FileMetadata.from(file);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Cache with adaptive TTL based on file age</span></span><br><span class="line">        <span class="type">Duration</span> <span class="variable">ttl</span> <span class="operator">=</span> calculateAdaptiveTTL(file.getCreatedAt());</span><br><span class="line">        cacheMetadataWithTTL(fileId, metadata, ttl);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> metadata;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Cache download URLs with short TTL for security</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCachedDownloadUrl</span><span class="params">(String fileId, String userId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cacheKey</span> <span class="operator">=</span> DOWNLOAD_URL_CACHE_PREFIX + fileId + <span class="string">&quot;:&quot;</span> + userId;</span><br><span class="line">        <span class="keyword">return</span> (String) redisTemplate.opsForValue().get(cacheKey);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cacheDownloadUrl</span><span class="params">(String fileId, String userId, String url, Duration expiration)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cacheKey</span> <span class="operator">=</span> DOWNLOAD_URL_CACHE_PREFIX + fileId + <span class="string">&quot;:&quot;</span> + userId;</span><br><span class="line">        <span class="type">Duration</span> <span class="variable">cacheTTL</span> <span class="operator">=</span> expiration.compareTo(DOWNLOAD_URL_CACHE_TTL) &lt; <span class="number">0</span> ? </span><br><span class="line">            expiration : DOWNLOAD_URL_CACHE_TTL;</span><br><span class="line">        </span><br><span class="line">        redisTemplate.opsForValue().set(cacheKey, url, cacheTTL);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Invalidate cache when file is updated or deleted</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@CacheEvict(value = &quot;fileMetadata&quot;, key = &quot;#fileId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invalidateFileCache</span><span class="params">(String fileId)</span> &#123;</span><br><span class="line">        <span class="comment">// Also clear download URL caches for this file</span></span><br><span class="line">        Set&lt;String&gt; keys = redisTemplate.keys(DOWNLOAD_URL_CACHE_PREFIX + fileId + <span class="string">&quot;:*&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!keys.isEmpty()) &#123;</span><br><span class="line">            redisTemplate.delete(keys);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Calculate adaptive TTL based on file characteristics</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Duration <span class="title function_">calculateAdaptiveTTL</span><span class="params">(Instant createdAt)</span> &#123;</span><br><span class="line">        <span class="type">Duration</span> <span class="variable">age</span> <span class="operator">=</span> Duration.between(createdAt, Instant.now());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Older files get longer cache TTL as they&#x27;re less likely to change</span></span><br><span class="line">        <span class="keyword">if</span> (age.toDays() &gt; <span class="number">30</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Duration.ofHours(<span class="number">2</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (age.toDays() &gt; <span class="number">7</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Duration.ofMinutes(<span class="number">60</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Duration.ofMinutes(<span class="number">15</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Database query optimization</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OptimizedFileRepository</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PersistenceContext</span></span><br><span class="line">    <span class="keyword">private</span> EntityManager entityManager;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Optimized query for file listing with filtering</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Query(value = &quot;&quot;&quot;</span></span><br><span class="line"><span class="meta">        SELECT f.*, </span></span><br><span class="line"><span class="meta">               COUNT(*) OVER() as total_count</span></span><br><span class="line"><span class="meta">        FROM files f</span></span><br><span class="line"><span class="meta">        WHERE (?1 IS NULL OR f.project_id = ?1::uuid)</span></span><br><span class="line"><span class="meta">          AND (?2 IS NULL OR f.mime_type = ANY(?2))</span></span><br><span class="line"><span class="meta">          AND (?3 IS NULL OR f.created_by = ?3::uuid)</span></span><br><span class="line"><span class="meta">          AND (?4 IS NULL OR f.created_at &gt;= ?4)</span></span><br><span class="line"><span class="meta">          AND (?5 IS NULL OR f.created_at &lt;= ?5)</span></span><br><span class="line"><span class="meta">          AND f.upload_status = &#x27;COMPLETED&#x27;</span></span><br><span class="line"><span class="meta">        ORDER BY f.created_at DESC</span></span><br><span class="line"><span class="meta">        LIMIT ?6 OFFSET ?7</span></span><br><span class="line"><span class="meta">        &quot;&quot;&quot;, nativeQuery = true)</span></span><br><span class="line">    List&lt;FileProjection&gt; <span class="title function_">findFilesOptimized</span><span class="params">(</span></span><br><span class="line"><span class="params">        String projectId,</span></span><br><span class="line"><span class="params">        String[] mimeTypes,</span></span><br><span class="line"><span class="params">        String createdBy,</span></span><br><span class="line"><span class="params">        Instant createdAfter,</span></span><br><span class="line"><span class="params">        Instant createdBefore,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> limit,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> offset</span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Bulk operations for cleanup</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Modifying</span></span><br><span class="line">    <span class="meta">@Query(&quot;DELETE FROM FileEntity f WHERE f.uploadStatus = &#x27;FAILED&#x27; AND f.createdAt &lt; :cutoffDate&quot;)</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">deleteFailedUploadsOlderThan</span><span class="params">(<span class="meta">@Param(&quot;cutoffDate&quot;)</span> Instant cutoffDate)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Modifying</span></span><br><span class="line">    <span class="meta">@Query(&quot;&quot;&quot;</span></span><br><span class="line"><span class="meta">        UPDATE FileEntity f </span></span><br><span class="line"><span class="meta">        SET f.uploadStatus = &#x27;EXPIRED&#x27; </span></span><br><span class="line"><span class="meta">        WHERE f.expiresAt &lt; :now AND f.uploadStatus = &#x27;COMPLETED&#x27;</span></span><br><span class="line"><span class="meta">        &quot;&quot;&quot;)</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">markExpiredFiles</span><span class="params">(<span class="meta">@Param(&quot;now&quot;)</span> Instant now)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Monitoring-and-Observability"><a href="#Monitoring-and-Observability" class="headerlink" title="Monitoring and Observability"></a>Monitoring and Observability</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageMetrics</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter uploadCounter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter downloadCounter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Timer uploadTimer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Gauge activeUploadsGauge;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DistributionSummary fileSizeDistribution;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FileStorageMetrics</span><span class="params">(MeterRegistry meterRegistry)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.meterRegistry = meterRegistry;</span><br><span class="line">        <span class="built_in">this</span>.uploadCounter = Counter.builder(<span class="string">&quot;file_uploads_total&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Total number of file uploads&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">this</span>.downloadCounter = Counter.builder(<span class="string">&quot;file_downloads_total&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Total number of file downloads&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">this</span>.uploadTimer = Timer.builder(<span class="string">&quot;file_upload_duration&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;File upload duration&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">this</span>.fileSizeDistribution = DistributionSummary.builder(<span class="string">&quot;file_size_bytes&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Distribution of file sizes&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordUpload</span><span class="params">(String mimeType, <span class="type">long</span> fileSize, Duration duration, <span class="type">boolean</span> successful)</span> &#123;</span><br><span class="line">        uploadCounter.increment(</span><br><span class="line">            Tags.of(</span><br><span class="line">                <span class="string">&quot;mime_type&quot;</span>, mimeType,</span><br><span class="line">                <span class="string">&quot;status&quot;</span>, successful ? <span class="string">&quot;success&quot;</span> : <span class="string">&quot;failure&quot;</span></span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (successful) &#123;</span><br><span class="line">            uploadTimer.record(duration);</span><br><span class="line">            fileSizeDistribution.record(fileSize);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordDownload</span><span class="params">(String mimeType)</span> &#123;</span><br><span class="line">        downloadCounter.increment(Tags.of(<span class="string">&quot;mime_type&quot;</span>, mimeType));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 30000)</span> <span class="comment">// Every 30 seconds</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateActiveUploadsGauge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">activeUploads</span> <span class="operator">=</span> chunkedUploadRepository.countByStatusIn(</span><br><span class="line">            Arrays.asList(UploadStatus.PENDING, UploadStatus.UPLOADING)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        Gauge.builder(<span class="string">&quot;file_uploads_active&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Number of active uploads&quot;</span>)</span><br><span class="line">            .register(meterRegistry, <span class="built_in">this</span>, unused -&gt; activeUploads);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Error-Handling-and-Resilience"><a href="#Error-Handling-and-Resilience" class="headerlink" title="Error Handling and Resilience"></a>Error Handling and Resilience</h2><h3 id="Comprehensive-Error-Handling"><a href="#Comprehensive-Error-Handling" class="headerlink" title="Comprehensive Error Handling"></a>Comprehensive Error Handling</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageExceptionHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(FileStorageExceptionHandler.class);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler(FileNotFoundException.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;ErrorResponse&gt; <span class="title function_">handleFileNotFound</span><span class="params">(FileNotFoundException e)</span> &#123;</span><br><span class="line">        log.warn(<span class="string">&quot;File not found: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.NOT_FOUND)</span><br><span class="line">            .body(ErrorResponse.builder()</span><br><span class="line">                .error(<span class="string">&quot;FILE_NOT_FOUND&quot;</span>)</span><br><span class="line">                .message(e.getMessage())</span><br><span class="line">                .timestamp(Instant.now())</span><br><span class="line">                .build());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler(FileUploadException.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;ErrorResponse&gt; <span class="title function_">handleUploadException</span><span class="params">(FileUploadException e)</span> &#123;</span><br><span class="line">        log.error(<span class="string">&quot;File upload failed&quot;</span>, e);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.BAD_REQUEST)</span><br><span class="line">            .body(ErrorResponse.builder()</span><br><span class="line">                .error(<span class="string">&quot;UPLOAD_FAILED&quot;</span>)</span><br><span class="line">                .message(<span class="string">&quot;File upload failed: &quot;</span> + e.getMessage())</span><br><span class="line">                .timestamp(Instant.now())</span><br><span class="line">                .details(extractErrorDetails(e))</span><br><span class="line">                .build());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler(RateLimitExceededException.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;ErrorResponse&gt; <span class="title function_">handleRateLimit</span><span class="params">(RateLimitExceededException e)</span> &#123;</span><br><span class="line">        log.warn(<span class="string">&quot;Rate limit exceeded: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.TOO_MANY_REQUESTS)</span><br><span class="line">            .header(<span class="string">&quot;Retry-After&quot;</span>, <span class="string">&quot;60&quot;</span>)</span><br><span class="line">            .body(ErrorResponse.builder()</span><br><span class="line">                .error(<span class="string">&quot;RATE_LIMIT_EXCEEDED&quot;</span>)</span><br><span class="line">                .message(<span class="string">&quot;Too many requests. Please try again later.&quot;</span>)</span><br><span class="line">                .timestamp(Instant.now())</span><br><span class="line">                .build());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler(StorageQuotaExceededException.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;ErrorResponse&gt; <span class="title function_">handleQuotaExceeded</span><span class="params">(StorageQuotaExceededException e)</span> &#123;</span><br><span class="line">        log.warn(<span class="string">&quot;Storage quota exceeded: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.INSUFFICIENT_STORAGE)</span><br><span class="line">            .body(ErrorResponse.builder()</span><br><span class="line">                .error(<span class="string">&quot;QUOTA_EXCEEDED&quot;</span>)</span><br><span class="line">                .message(<span class="string">&quot;Storage quota exceeded. Please upgrade your plan or delete some files.&quot;</span>)</span><br><span class="line">                .timestamp(Instant.now())</span><br><span class="line">                .build());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Circuit breaker for GCS operations</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResilientGcsClient</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Storage storage;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CircuitBreaker circuitBreaker;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RetryTemplate retryTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ResilientGcsClient</span><span class="params">(Storage storage)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.storage = storage;</span><br><span class="line">        <span class="built_in">this</span>.circuitBreaker = CircuitBreaker.builder(<span class="string">&quot;gcs-operations&quot;</span>)</span><br><span class="line">            .slidingWindow(<span class="number">10</span>, <span class="number">5</span>, CircuitBreaker.SlidingWindowType.COUNT_BASED)</span><br><span class="line">            .failureThreshold(<span class="number">50.0f</span>)</span><br><span class="line">            .waitInterval(Duration.ofSeconds(<span class="number">30</span>))</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">this</span>.retryTemplate = RetryTemplate.builder()</span><br><span class="line">            .maxAttempts(<span class="number">3</span>)</span><br><span class="line">            .exponentialBackoff(<span class="number">1000</span>, <span class="number">2</span>, <span class="number">10000</span>)</span><br><span class="line">            .retryOn(StorageException.class)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generateSignedUrl</span><span class="params">(String bucket, String objectName, Duration expiration)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> circuitBreaker.supply(() -&gt; </span><br><span class="line">            retryTemplate.execute(context -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">BlobInfo</span> <span class="variable">blobInfo</span> <span class="operator">=</span> BlobInfo.newBuilder(bucket, objectName).build();</span><br><span class="line">                    <span class="keyword">return</span> storage.signUrl(blobInfo, expiration.toMillis(), TimeUnit.MILLISECONDS)</span><br><span class="line">                        .toString();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (StorageException e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;Failed to generate signed URL for &#123;&#125;/&#123;&#125;&quot;</span>, bucket, objectName, e);</span><br><span class="line">                    <span class="keyword">throw</span> e;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Deployment-and-Infrastructure"><a href="#Deployment-and-Infrastructure" class="headerlink" title="Deployment and Infrastructure"></a>Deployment and Infrastructure</h2><h3 id="Docker-Configuration"><a href="#Docker-Configuration" class="headerlink" title="Docker Configuration"></a>Docker Configuration</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Multi-stage build for production optimization</span></span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">17</span>-jdk-slim AS builder</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> gradlew .</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> gradle gradle</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> build.gradle settings.gradle ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> src src</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> ./gradlew build -x <span class="built_in">test</span> --no-daemon</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">17</span>-jre-slim</span><br><span class="line"></span><br><span class="line"><span class="comment"># Security: Create non-root user</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> groupadd -r fileservice &amp;&amp; useradd -r -g fileservice fileservice</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Install required packages</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y \</span></span><br><span class="line"><span class="language-bash">    curl \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy application jar</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/build/libs/file-storage-service-*.jar app.jar</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy configuration files</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --<span class="built_in">chown</span>=fileservice:fileservice docker/application-docker.yml application.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Health check</span></span><br><span class="line"><span class="keyword">HEALTHCHECK</span><span class="language-bash"> --interval=30s --<span class="built_in">timeout</span>=10s --start-period=60s --retries=3 \</span></span><br><span class="line"><span class="language-bash">  CMD curl -f http://localhost:8080/actuator/health || <span class="built_in">exit</span> 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Switch to non-root user</span></span><br><span class="line"><span class="keyword">USER</span> fileservice</span><br><span class="line"></span><br><span class="line"><span class="comment"># JVM optimization for containers</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_OPTS=<span class="string">&quot;-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0 -XX:+UseG1GC&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;java <span class="variable">$JAVA_OPTS</span> -jar app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h3 id="Kubernetes-Deployment"><a href="#Kubernetes-Deployment" class="headerlink" title="Kubernetes Deployment"></a>Kubernetes Deployment</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">file-storage-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">file-storage</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">file-storage-service</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">file-storage-service</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">file-storage-service</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">file-storage-service:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_PROFILES_ACTIVE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;kubernetes&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_HOST</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">postgres-secret</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">host</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_PASSWORD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">postgres-secret</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">password</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GOOGLE_APPLICATION_CREDENTIALS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;/etc/gcp/service-account.json&quot;</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gcp-service-account</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/gcp</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;512Mi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;1000m&quot;</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/actuator/health/liveness</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">30</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/actuator/health/readiness</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gcp-service-account</span></span><br><span class="line">        <span class="attr">secret:</span></span><br><span class="line">          <span class="attr">secretName:</span> <span class="string">gcp-service-account</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># service.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">file-storage-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">file-storage</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">file-storage-service</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># hpa.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">file-storage-hpa</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">file-storage</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">file-storage-service</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cpu</span></span><br><span class="line">      <span class="attr">target:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">Utilization</span></span><br><span class="line">        <span class="attr">averageUtilization:</span> <span class="number">70</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">memory</span></span><br><span class="line">      <span class="attr">target:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">Utilization</span></span><br><span class="line">        <span class="attr">averageUtilization:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h2 id="Testing-Strategy"><a href="#Testing-Strategy" class="headerlink" title="Testing Strategy"></a>Testing Strategy</h2><h3 id="Integration-Testing"><a href="#Integration-Testing" class="headerlink" title="Integration Testing"></a>Integration Testing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)</span></span><br><span class="line"><span class="meta">@TestPropertySource(locations = &quot;classpath:application-test.properties&quot;)</span></span><br><span class="line"><span class="meta">@Testcontainers</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileStorageIntegrationTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Container</span></span><br><span class="line">    <span class="keyword">static</span> PostgreSQLContainer&lt;?&gt; postgres = <span class="keyword">new</span> <span class="title class_">PostgreSQLContainer</span>&lt;&gt;(<span class="string">&quot;postgres:13&quot;</span>)</span><br><span class="line">            .withDatabaseName(<span class="string">&quot;filetest&quot;</span>)</span><br><span class="line">            .withUsername(<span class="string">&quot;test&quot;</span>)</span><br><span class="line">            .withPassword(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Container</span></span><br><span class="line">    <span class="keyword">static</span> GenericContainer&lt;?&gt; redis = <span class="keyword">new</span> <span class="title class_">GenericContainer</span>&lt;&gt;(<span class="string">&quot;redis:6-alpine&quot;</span>)</span><br><span class="line">            .withExposedPorts(<span class="number">6379</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TestRestTemplate restTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@MockBean</span></span><br><span class="line">    <span class="keyword">private</span> GcsStorageClient gcsClient;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldUploadFileSuccessfully</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Given</span></span><br><span class="line">        <span class="type">FileUploadRequest</span> <span class="variable">request</span> <span class="operator">=</span> FileUploadRequest.builder()</span><br><span class="line">            .originalFilename(<span class="string">&quot;test.pdf&quot;</span>)</span><br><span class="line">            .fileSize(<span class="number">1024L</span>)</span><br><span class="line">            .mimeType(<span class="string">&quot;application/pdf&quot;</span>)</span><br><span class="line">            .fileHash(<span class="string">&quot;abcd1234&quot;</span>)</span><br><span class="line">            .userId(<span class="string">&quot;user-123&quot;</span>)</span><br><span class="line">            .projectId(<span class="string">&quot;project-456&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">when</span>(gcsClient.generateSignedUploadUrl(any(), any(), any(), any()))</span><br><span class="line">            .thenReturn(<span class="string">&quot;https://storage.googleapis.com/signed-url&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When</span></span><br><span class="line">        ResponseEntity&lt;FileUploadResponse&gt; response = restTemplate.postForEntity(</span><br><span class="line">            <span class="string">&quot;/api/v1/files/upload&quot;</span>,</span><br><span class="line">            request,</span><br><span class="line">            FileUploadResponse.class</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Then</span></span><br><span class="line">        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);</span><br><span class="line">        assertThat(response.getBody().getFileId()).isNotNull();</span><br><span class="line">        assertThat(response.getBody().getUploadUrl()).contains(<span class="string">&quot;signed-url&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldHandleChunkedUploadFlow</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Given</span></span><br><span class="line">        <span class="type">ChunkedUploadRequest</span> <span class="variable">request</span> <span class="operator">=</span> ChunkedUploadRequest.builder()</span><br><span class="line">            .originalFilename(<span class="string">&quot;large-file.zip&quot;</span>)</span><br><span class="line">            .fileSize(<span class="number">50_000_000L</span>)</span><br><span class="line">            .mimeType(<span class="string">&quot;application/zip&quot;</span>)</span><br><span class="line">            .fileHash(<span class="string">&quot;efgh5678&quot;</span>)</span><br><span class="line">            .userId(<span class="string">&quot;user-123&quot;</span>)</span><br><span class="line">            .totalChunks(<span class="number">10</span>)</span><br><span class="line">            .chunkSize(<span class="number">5_000_000</span>)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">when</span>(gcsClient.initiateMultipartUpload(any(), any(), any()))</span><br><span class="line">            .thenReturn(<span class="string">&quot;multipart-upload-id&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When - Initiate chunked upload</span></span><br><span class="line">        ResponseEntity&lt;ChunkedUploadResponse&gt; initResponse = restTemplate.postForEntity(</span><br><span class="line">            <span class="string">&quot;/api/v1/files/upload/chunked&quot;</span>,</span><br><span class="line">            request,</span><br><span class="line">            ChunkedUploadResponse.class</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Then</span></span><br><span class="line">        assertThat(initResponse.getStatusCode()).isEqualTo(HttpStatus.CREATED);</span><br><span class="line">        <span class="type">String</span> <span class="variable">uploadId</span> <span class="operator">=</span> initResponse.getBody().getUploadId();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When - Get chunk upload URLs</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">when</span>(gcsClient.generateSignedChunkUploadUrl(any(), eq(i), any()))</span><br><span class="line">                .thenReturn(<span class="string">&quot;https://storage.googleapis.com/chunk-&quot;</span> + i);</span><br><span class="line">            </span><br><span class="line">            ResponseEntity&lt;ChunkUploadResponse&gt; chunkResponse = restTemplate.postForEntity(</span><br><span class="line">                <span class="string">&quot;/api/v1/files/upload/chunked/&quot;</span> + uploadId + <span class="string">&quot;/chunks/&quot;</span> + i,</span><br><span class="line">                <span class="literal">null</span>,</span><br><span class="line">                ChunkUploadResponse.class</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            assertThat(chunkResponse.getStatusCode()).isEqualTo(HttpStatus.OK);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When - Complete upload</span></span><br><span class="line">        <span class="type">CompleteChunkedUploadRequest</span> <span class="variable">completeRequest</span> <span class="operator">=</span> CompleteChunkedUploadRequest.builder()</span><br><span class="line">            .uploadId(uploadId)</span><br><span class="line">            .chunks(IntStream.rangeClosed(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">                .mapToObj(i -&gt; <span class="keyword">new</span> <span class="title class_">ChunkInfo</span>(i, <span class="string">&quot;etag-&quot;</span> + i))</span><br><span class="line">                .collect(Collectors.toList()))</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">when</span>(gcsClient.completeMultipartUpload(any(), any()))</span><br><span class="line">            .thenReturn(<span class="string">&quot;final-object-key&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        ResponseEntity&lt;FileUploadResponse&gt; completeResponse = restTemplate.postForEntity(</span><br><span class="line">            <span class="string">&quot;/api/v1/files/upload/chunked/&quot;</span> + uploadId + <span class="string">&quot;/complete&quot;</span>,</span><br><span class="line">            completeRequest,</span><br><span class="line">            FileUploadResponse.class</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Then</span></span><br><span class="line">        assertThat(completeResponse.getStatusCode()).isEqualTo(HttpStatus.OK);</span><br><span class="line">        assertThat(completeResponse.getBody().getFileId()).isNotNull();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Common-Interview-Questions-Answers"><a href="#Common-Interview-Questions-Answers" class="headerlink" title="Common Interview Questions &amp; Answers"></a>Common Interview Questions &amp; Answers</h2><p><strong>Q: How do you handle concurrent uploads of the same file?</strong></p>
<p>A: We implement file deduplication using SHA-256 hashes. When a file upload request comes in, we first check if a file with the same hash already exists for that project. If deduplication is enabled and the file exists, we return a reference to the existing file instead of creating a duplicate. For concurrent uploads of different files, we use database transactions and optimistic locking to handle race conditions.</p>
<p><strong>Q: How do you ensure data consistency during chunked uploads?</strong></p>
<p>A: We use a multi-phase approach:</p>
<ol>
<li>Database transactions ensure atomicity of metadata operations</li>
<li>Each chunk upload is tracked individually with ETags from GCS</li>
<li>We implement a completion verification step that validates all chunks before finalizing</li>
<li>Failed uploads are automatically cleaned up using scheduled tasks</li>
<li>We use optimistic locking on the chunked_uploads table to prevent race conditions</li>
</ol>
<p><strong>Q: How do you handle failures during large file uploads?</strong></p>
<p>A: Our resilience strategy includes:</p>
<ol>
<li><strong>Retry mechanisms</strong>: Exponential backoff for transient failures</li>
<li><strong>Circuit breakers</strong>: Prevent cascading failures to GCS</li>
<li><strong>Cleanup jobs</strong>: Remove orphaned uploads after expiration</li>
<li><strong>Resume capability</strong>: Clients can query upload status and resume from the last successful chunk</li>
<li><strong>Monitoring</strong>: Real-time alerts for high failure rates</li>
</ol>
<p><strong>Q: How do you scale the service horizontally?</strong></p>
<p>A: The service is designed to be stateless and cloud-native:</p>
<ol>
<li><strong>Stateless design</strong>: All upload state is stored in PostgreSQL&#x2F;Redis</li>
<li><strong>Load balancing</strong>: Multiple service instances behind a load balancer</li>
<li><strong>Database connection pooling</strong>: Efficient resource utilization</li>
<li><strong>Caching</strong>: Redis for frequently accessed metadata</li>
<li><strong>Auto-scaling</strong>: Kubernetes HPA based on CPU&#x2F;memory metrics</li>
<li><strong>CDN integration</strong>: CloudFront for global file delivery</li>
</ol>
<p><strong>Q: How do you handle different file types and validation?</strong></p>
<p>A: We implement a comprehensive validation framework:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileValidator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, FileTypeValidator&gt; validators;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> VirusScanner virusScanner;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ValidationResult <span class="title function_">validateFile</span><span class="params">(FileUploadRequest request, InputStream fileStream)</span> &#123;</span><br><span class="line">        <span class="type">ValidationResult</span> <span class="variable">result</span> <span class="operator">=</span> ValidationResult.success();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Basic validations</span></span><br><span class="line">        result.merge(validateFileSize(request.getFileSize()));</span><br><span class="line">        result.merge(validateMimeType(request.getMimeType()));</span><br><span class="line">        result.merge(validateFilename(request.getOriginalFilename()));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Content-specific validation</span></span><br><span class="line">        <span class="type">FileTypeValidator</span> <span class="variable">validator</span> <span class="operator">=</span> validators.get(request.getMimeType());</span><br><span class="line">        <span class="keyword">if</span> (validator != <span class="literal">null</span>) &#123;</span><br><span class="line">            result.merge(validator.validate(fileStream));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Security scan</span></span><br><span class="line">        <span class="keyword">if</span> (result.isValid()) &#123;</span><br><span class="line">            result.merge(virusScanner.scan(fileStream));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Q: How do you implement file versioning?</strong></p>
<p>A: File versioning can be implemented by extending the schema:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Add version tracking to files table</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> files <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> version_number <span class="type">INTEGER</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">ALTER TABLE</span> files <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> parent_file_id UUID <span class="keyword">REFERENCES</span> files(id);</span><br><span class="line"><span class="keyword">ALTER TABLE</span> files <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> is_latest_version <span class="type">BOOLEAN</span> <span class="keyword">DEFAULT</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Index for efficient version queries</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_files_parent_version <span class="keyword">ON</span> files(parent_file_id, version_number);</span><br></pre></td></tr></table></figure>

<p>This allows tracking file history while maintaining backward compatibility with existing APIs.</p>
<h2 id="Best-Practices-and-Recommendations"><a href="#Best-Practices-and-Recommendations" class="headerlink" title="Best Practices and Recommendations"></a>Best Practices and Recommendations</h2><h3 id="Production-Deployment-Checklist"><a href="#Production-Deployment-Checklist" class="headerlink" title="Production Deployment Checklist"></a>Production Deployment Checklist</h3><ul>
<li><strong>Security</strong>: Implement proper authentication, authorization, and input validation</li>
<li><strong>Monitoring</strong>: Set up comprehensive logging, metrics, and alerting</li>
<li><strong>Performance</strong>: Implement caching, connection pooling, and query optimization</li>
<li><strong>Reliability</strong>: Use circuit breakers, retry mechanisms, and graceful degradation</li>
<li><strong>Scalability</strong>: Design for horizontal scaling with stateless services</li>
<li><strong>Data Protection</strong>: Implement backup strategies and disaster recovery</li>
<li><strong>Compliance</strong>: Ensure GDPR&#x2F;compliance requirements for file metadata and deletion</li>
</ul>
<h3 id="External-Resources"><a href="#External-Resources" class="headerlink" title="External Resources"></a>External Resources</h3><ul>
<li><a target="_blank" rel="noopener" href="https://cloud.google.com/storage/docs/best-practices">Google Cloud Storage Best Practices</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.postgresql.org/wiki/Performance_Optimization">PostgreSQL Performance Tuning</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html">Spring Boot Production Guidelines</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/storage/">Kubernetes File Storage Patterns</a></li>
<li><a target="_blank" rel="noopener" href="https://microservices.io/patterns/observability/audit-logging.html">Microservices Observability</a></li>
</ul>
<p>This comprehensive guide provides a production-ready foundation for building a scalable, secure, and maintainable file storage service. The modular design allows for easy extension and customization based on specific business requirements.</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/system-design/" rel="tag"># system-design</a>
              <a href="/tags/file-storage/" rel="tag"># file storage</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/09/11/Design-File-Storage-Service-with-GCS-and-Postgrel/" rel="prev" title="Design File Storage Service with GCS and PostgreSQL">
                  <i class="fa fa-angle-left"></i> Design File Storage Service with GCS and PostgreSQL
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Charlie Feng</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
