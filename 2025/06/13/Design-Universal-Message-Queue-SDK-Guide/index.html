<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"shayne007.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="Introduction to Universal Message Queue SDKThe Universal Message Queue Component SDK is a sophisticated middleware solution designed to abstract the complexity of different message queue implementatio">
<meta property="og:type" content="article">
<meta property="og:title" content="Design Universal Message Queue SDK">
<meta property="og:url" content="https://shayne007.github.io/2025/06/13/Design-Universal-Message-Queue-SDK-Guide/index.html">
<meta property="og:site_name" content="Charlie Feng&#39;s Tech Space">
<meta property="og:description" content="Introduction to Universal Message Queue SDKThe Universal Message Queue Component SDK is a sophisticated middleware solution designed to abstract the complexity of different message queue implementatio">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-06-13T10:12:54.000Z">
<meta property="article:modified_time" content="2025-06-27T08:43:31.078Z">
<meta property="article:author" content="Charlie Feng">
<meta property="article:tag" content="system-design">
<meta property="article:tag" content="async invocation">
<meta property="article:tag" content="universal mq">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://shayne007.github.io/2025/06/13/Design-Universal-Message-Queue-SDK-Guide/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://shayne007.github.io/2025/06/13/Design-Universal-Message-Queue-SDK-Guide/","path":"2025/06/13/Design-Universal-Message-Queue-SDK-Guide/","title":"Design Universal Message Queue SDK"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Design Universal Message Queue SDK | Charlie Feng's Tech Space</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"cdn":false,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.5.0/mermaid.min.js","integrity":"sha256-2obLuIPcceEhkE3G09G33hBdmE55ivVcZUlcKcGNHjU="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>





  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Charlie Feng's Tech Space</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">You will survive with skills</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Introduction-to-Universal-Message-Queue-SDK"><span class="nav-number">1.</span> <span class="nav-text">Introduction to Universal Message Queue SDK</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Core-Value-Proposition"><span class="nav-number">1.1.</span> <span class="nav-text">Core Value Proposition</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Architecture-Overview"><span class="nav-number">2.</span> <span class="nav-text">Architecture Overview</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Key-Components"><span class="nav-number">2.1.</span> <span class="nav-text">Key Components</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Service-Provider-Interface-SPI-Design"><span class="nav-number">3.</span> <span class="nav-text">Service Provider Interface (SPI) Design</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Provider-Implementation-Example-Kafka"><span class="nav-number">3.1.</span> <span class="nav-text">Provider Implementation Example - Kafka</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Asynchronous-RPC-Implementation"><span class="nav-number">4.</span> <span class="nav-text">Asynchronous RPC Implementation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Async-RPC-Manager-Implementation"><span class="nav-number">4.1.</span> <span class="nav-text">Async RPC Manager Implementation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Server-Side-Response-Handler"><span class="nav-number">4.2.</span> <span class="nav-text">Server-Side Response Handler</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Message-Producer-and-Consumer-Interfaces"><span class="nav-number">5.</span> <span class="nav-text">Message Producer and Consumer Interfaces</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-Streams-Implementation-Example"><span class="nav-number">5.1.</span> <span class="nav-text">Redis Streams Implementation Example</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Failure-Handling-and-Resilience-Patterns"><span class="nav-number">6.</span> <span class="nav-text">Failure Handling and Resilience Patterns</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Resilience-Implementation"><span class="nav-number">6.1.</span> <span class="nav-text">Resilience Implementation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Network-Partition-Handling"><span class="nav-number">6.2.</span> <span class="nav-text">Network Partition Handling</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Configuration-and-Best-Practices"><span class="nav-number">7.</span> <span class="nav-text">Configuration and Best Practices</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Configuration-Management"><span class="nav-number">7.1.</span> <span class="nav-text">Configuration Management</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Production-Best-Practices"><span class="nav-number">7.2.</span> <span class="nav-text">Production Best Practices</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Use-Cases-and-Examples"><span class="nav-number">8.</span> <span class="nav-text">Use Cases and Examples</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Use-Case-1-E-commerce-Order-Processing"><span class="nav-number">8.1.</span> <span class="nav-text">Use Case 1: E-commerce Order Processing</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Use-Case-2-Real-time-Analytics-Pipeline"><span class="nav-number">8.2.</span> <span class="nav-text">Use Case 2: Real-time Analytics Pipeline</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Use-Case-3-Microservice-Choreography"><span class="nav-number">8.3.</span> <span class="nav-text">Use Case 3: Microservice Choreography</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Performance-Optimization"><span class="nav-number">9.</span> <span class="nav-text">Performance Optimization</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Batching-and-Throughput-Optimization"><span class="nav-number">9.1.</span> <span class="nav-text">Batching and Throughput Optimization</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Connection-Pooling-and-Resource-Management"><span class="nav-number">9.2.</span> <span class="nav-text">Connection Pooling and Resource Management</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Testing-Strategies"><span class="nav-number">10.</span> <span class="nav-text">Testing Strategies</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Integration-Testing-with-Testcontainers"><span class="nav-number">10.1.</span> <span class="nav-text">Integration Testing with Testcontainers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Unit-Testing-with-Mocks"><span class="nav-number">10.2.</span> <span class="nav-text">Unit Testing with Mocks</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Security-Considerations"><span class="nav-number">11.</span> <span class="nav-text">Security Considerations</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Message-Encryption-and-Authentication"><span class="nav-number">11.1.</span> <span class="nav-text">Message Encryption and Authentication</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Access-Control-and-Topic-Security"><span class="nav-number">11.2.</span> <span class="nav-text">Access Control and Topic Security</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Monitoring-and-Observability"><span class="nav-number">12.</span> <span class="nav-text">Monitoring and Observability</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Distributed-Tracing-Integration"><span class="nav-number">12.1.</span> <span class="nav-text">Distributed Tracing Integration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Health-Checks-and-Metrics-Dashboard"><span class="nav-number">12.2.</span> <span class="nav-text">Health Checks and Metrics Dashboard</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Migration-and-Deployment-Strategies"><span class="nav-number">13.</span> <span class="nav-text">Migration and Deployment Strategies</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Blue-Green-Deployment-with-Message-Queue-Migration"><span class="nav-number">13.1.</span> <span class="nav-text">Blue-Green Deployment with Message Queue Migration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Migration-Implementation"><span class="nav-number">13.2.</span> <span class="nav-text">Migration Implementation</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Advanced-Topics"><span class="nav-number">14.</span> <span class="nav-text">Advanced Topics</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Message-Schema-Evolution"><span class="nav-number">14.1.</span> <span class="nav-text">Message Schema Evolution</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Event-Sourcing-Integration"><span class="nav-number">14.2.</span> <span class="nav-text">Event Sourcing Integration</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Interview-Questions-and-Expert-Insights"><span class="nav-number">15.</span> <span class="nav-text">Interview Questions and Expert Insights</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Q-How-would-you-handle-message-ordering-guarantees-across-different-MQ-providers"><span class="nav-number">15.1.</span> <span class="nav-text">Q: How would you handle message ordering guarantees across different MQ providers?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Q-What-are-the-performance-implications-of-your-SPI-based-approach"><span class="nav-number">15.2.</span> <span class="nav-text">Q: What are the performance implications of your SPI-based approach?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Q-How-do-you-ensure-exactly-once-delivery-semantics"><span class="nav-number">15.3.</span> <span class="nav-text">Q: How do you ensure exactly-once delivery semantics?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Q-How-would-you-handle-schema-evolution-in-a-microservices-environment"><span class="nav-number">15.4.</span> <span class="nav-text">Q: How would you handle schema evolution in a microservices environment?</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#External-References-and-Resources"><span class="nav-number">16.</span> <span class="nav-text">External References and Resources</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Official-Documentation"><span class="nav-number">16.1.</span> <span class="nav-text">Official Documentation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Best-Practices-and-Patterns"><span class="nav-number">16.2.</span> <span class="nav-text">Best Practices and Patterns</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Production-Operations"><span class="nav-number">16.3.</span> <span class="nav-text">Production Operations</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Testing-and-Development"><span class="nav-number">16.4.</span> <span class="nav-text">Testing and Development</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Conclusion"><span class="nav-number">17.</span> <span class="nav-text">Conclusion</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Charlie Feng</p>
  <div class="site-description" itemprop="description">This place is for thinking and sharing.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">52</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/13/Design-Universal-Message-Queue-SDK-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Design Universal Message Queue SDK | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Design Universal Message Queue SDK
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-13 18:12:54" itemprop="dateCreated datePublished" datetime="2025-06-13T18:12:54+08:00">2025-06-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-27 16:43:31" itemprop="dateModified" datetime="2025-06-27T16:43:31+08:00">2025-06-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system-design/" itemprop="url" rel="index"><span itemprop="name">system-design</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="Introduction-to-Universal-Message-Queue-SDK"><a href="#Introduction-to-Universal-Message-Queue-SDK" class="headerlink" title="Introduction to Universal Message Queue SDK"></a>Introduction to Universal Message Queue SDK</h2><p>The Universal Message Queue Component SDK is a sophisticated middleware solution designed to abstract the complexity of different message queue implementations while providing a unified interface for asynchronous communication patterns. This SDK addresses the critical need for vendor-agnostic messaging capabilities in distributed systems, enabling seamless integration with Kafka, Redis, and RocketMQ through a single, consistent API.</p>
<h3 id="Core-Value-Proposition"><a href="#Core-Value-Proposition" class="headerlink" title="Core Value Proposition"></a>Core Value Proposition</h3><p>Modern distributed systems require reliable asynchronous communication patterns to achieve scalability, resilience, and performance. The Universal MQ SDK provides:</p>
<ul>
<li><strong>Vendor Independence</strong>: Switch between Kafka, Redis, and RocketMQ without code changes</li>
<li><strong>Unified API</strong>: Single interface for all messaging operations</li>
<li><strong>Production Resilience</strong>: Built-in failure handling and recovery mechanisms</li>
<li><strong>Asynchronous RPC</strong>: Transform synchronous HTTP calls into asynchronous message-driven operations</li>
</ul>
<p><strong>Interview Insight</strong>: <em>Why use a universal SDK instead of direct MQ client libraries?</em><br><em>Answer: A universal SDK provides abstraction that enables vendor flexibility, reduces learning curve for developers, standardizes error handling patterns, and centralizes configuration management. It also allows for gradual migration between MQ technologies without application code changes.</em></p>
<h2 id="Architecture-Overview"><a href="#Architecture-Overview" class="headerlink" title="Architecture Overview"></a>Architecture Overview</h2><p>The SDK follows a layered architecture pattern with clear separation of concerns:</p>
<pre>
<code class="mermaid">
flowchart TB
subgraph &quot;Client Applications&quot;
    A[Service A] --&gt; B[Service B]
    C[Service C] --&gt; D[Service D]
end

subgraph &quot;Universal MQ SDK&quot;
    E[Unified API Layer]
    F[SPI Interface]
    G[Async RPC Manager]
    H[Message Serialization]
    I[Failure Handling]
end

subgraph &quot;MQ Implementations&quot;
    J[Kafka Provider]
    K[Redis Provider]
    L[RocketMQ Provider]
end

subgraph &quot;Message Brokers&quot;
    M[Apache Kafka]
    N[Redis Streams]
    O[Apache RocketMQ]
end

A --&gt; E
C --&gt; E
E --&gt; F
F --&gt; G
F --&gt; H
F --&gt; I
F --&gt; J
F --&gt; K
F --&gt; L
J --&gt; M
K --&gt; N
L --&gt; O
</code>
</pre>

<h3 id="Key-Components"><a href="#Key-Components" class="headerlink" title="Key Components"></a>Key Components</h3><p><strong>Unified API Layer</strong>: Provides consistent interface for all messaging operations<br><strong>SPI (Service Provider Interface)</strong>: Enables pluggable MQ implementations<br><strong>Async RPC Manager</strong>: Handles request-response correlation and callback execution<br><strong>Message Serialization</strong>: Manages data format conversion and schema evolution<br><strong>Failure Handling</strong>: Implements retry, circuit breaker, and dead letter queue patterns</p>
<h2 id="Service-Provider-Interface-SPI-Design"><a href="#Service-Provider-Interface-SPI-Design" class="headerlink" title="Service Provider Interface (SPI) Design"></a>Service Provider Interface (SPI) Design</h2><p>The SPI mechanism enables runtime discovery and loading of different MQ implementations without modifying core SDK code.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Core SPI Interface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MessageQueueProvider</span> &#123;</span><br><span class="line">    String <span class="title function_">getProviderName</span><span class="params">()</span>;</span><br><span class="line">    MessageProducer <span class="title function_">createProducer</span><span class="params">(ProducerConfig config)</span>;</span><br><span class="line">    MessageConsumer <span class="title function_">createConsumer</span><span class="params">(ConsumerConfig config)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">(Properties properties)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Health check capabilities</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isHealthy</span><span class="params">()</span>;</span><br><span class="line">    ProviderMetrics <span class="title function_">getMetrics</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SPI Configuration</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MQProviderFactory</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, MessageQueueProvider&gt; providers = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">loadProviders</span><span class="params">()</span> &#123;</span><br><span class="line">        ServiceLoader&lt;MessageQueueProvider&gt; loader = </span><br><span class="line">            ServiceLoader.load(MessageQueueProvider.class);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (MessageQueueProvider provider : loader) &#123;</span><br><span class="line">            providers.put(provider.getProviderName(), provider);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> MessageQueueProvider <span class="title function_">getProvider</span><span class="params">(String providerName)</span> &#123;</span><br><span class="line">        <span class="type">MessageQueueProvider</span> <span class="variable">provider</span> <span class="operator">=</span> providers.get(providerName);</span><br><span class="line">        <span class="keyword">if</span> (provider == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedMQProviderException</span>(</span><br><span class="line">                <span class="string">&quot;Provider not found: &quot;</span> + providerName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> provider;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Provider-Implementation-Example-Kafka"><a href="#Provider-Implementation-Example-Kafka" class="headerlink" title="Provider Implementation Example - Kafka"></a>Provider Implementation Example - Kafka</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// META-INF/services/com.example.mq.MessageQueueProvider</span></span><br><span class="line">com.example.mq.kafka.KafkaMessageQueueProvider</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KafkaMessageQueueProvider</span> <span class="keyword">implements</span> <span class="title class_">MessageQueueProvider</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> KafkaProducer&lt;String, Object&gt; kafkaProducer;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getProviderName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;kafka&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">(Properties properties)</span> &#123;</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">kafkaProps</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        kafkaProps.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, </span><br><span class="line">                      properties.getProperty(<span class="string">&quot;kafka.bootstrap.servers&quot;</span>));</span><br><span class="line">        kafkaProps.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, </span><br><span class="line">                      StringSerializer.class.getName());</span><br><span class="line">        kafkaProps.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, </span><br><span class="line">                      JsonSerializer.class.getName());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Production settings</span></span><br><span class="line">        kafkaProps.put(ProducerConfig.ACKS_CONFIG, <span class="string">&quot;all&quot;</span>);</span><br><span class="line">        kafkaProps.put(ProducerConfig.RETRIES_CONFIG, Integer.MAX_VALUE);</span><br><span class="line">        kafkaProps.put(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG, <span class="literal">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">this</span>.kafkaProducer = <span class="keyword">new</span> <span class="title class_">KafkaProducer</span>&lt;&gt;(kafkaProps);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MessageProducer <span class="title function_">createProducer</span><span class="params">(ProducerConfig config)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">KafkaMessageProducer</span>(kafkaProducer, config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>How does SPI improve maintainability compared to factory patterns?</em><br><em>Answer: SPI provides compile-time independence - new providers can be added without modifying existing code. It supports modular deployment where providers can be packaged separately, enables runtime provider discovery, and follows the Open&#x2F;Closed Principle by being open for extension but closed for modification.</em></p>
<h2 id="Asynchronous-RPC-Implementation"><a href="#Asynchronous-RPC-Implementation" class="headerlink" title="Asynchronous RPC Implementation"></a>Asynchronous RPC Implementation</h2><p>The Async RPC pattern transforms traditional synchronous HTTP calls into message-driven asynchronous operations, providing better scalability and fault tolerance.</p>
<pre>
<code class="mermaid">
sequenceDiagram
participant Client as Client Service
participant SDK as MQ SDK
participant Server as Server Service
participant MQ as Message Queue
participant Callback as Callback Handler

Client-&gt;&gt;SDK: asyncPost(url, data, callback)
SDK-&gt;&gt;SDK: Generate messageKey &amp; responseTopic
SDK-&gt;&gt;Server: Direct HTTP POST with MQ headers
Note over Server: X-Message-Key: uuid-12345&lt;br&#x2F;&gt;X-Response-Topic: client-responses
Server-&gt;&gt;Server: Process business logic asynchronously
Server-&gt;&gt;Server: HTTP 202 Accepted (immediate response)
Server-&gt;&gt;MQ: Publish response message when ready
MQ-&gt;&gt;SDK: SDK consumes response message
SDK-&gt;&gt;Callback: Execute callback(response)
</code>
</pre>

<h3 id="Async-RPC-Manager-Implementation"><a href="#Async-RPC-Manager-Implementation" class="headerlink" title="Async RPC Manager Implementation"></a>Async RPC Manager Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncRpcManager</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageQueueProvider mqProvider;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, CallbackContext&gt; pendingRequests = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService timeoutExecutor;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">asyncPost</span><span class="params">(String url, Object requestBody, </span></span><br><span class="line"><span class="params">                             AsyncCallback&lt;T&gt; callback, Class&lt;T&gt; responseType)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">messageKey</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        <span class="type">String</span> <span class="variable">responseTopic</span> <span class="operator">=</span> <span class="string">&quot;async-rpc-responses-&quot;</span> + getServiceName();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Store callback context</span></span><br><span class="line">        <span class="type">CallbackContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CallbackContext</span>(callback, responseType, </span><br><span class="line">                                                     System.currentTimeMillis());</span><br><span class="line">        pendingRequests.put(messageKey, context);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Schedule timeout handling</span></span><br><span class="line">        scheduleTimeout(messageKey);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Make direct HTTP request with MQ response headers</span></span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">        headers.set(<span class="string">&quot;X-Message-Key&quot;</span>, messageKey);</span><br><span class="line">        headers.set(<span class="string">&quot;X-Response-Topic&quot;</span>, responseTopic);</span><br><span class="line">        headers.set(<span class="string">&quot;X-Correlation-ID&quot;</span>, messageKey);</span><br><span class="line">        headers.set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Send HTTP request directly - expect 202 Accepted for async processing</span></span><br><span class="line">            ResponseEntity&lt;Void&gt; response = restTemplate.postForEntity(url, </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(requestBody, headers), Void.class);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (response.getStatusCode() != HttpStatus.ACCEPTED) &#123;</span><br><span class="line">                <span class="comment">// Server doesn&#x27;t support async processing</span></span><br><span class="line">                pendingRequests.remove(messageKey);</span><br><span class="line">                callback.onError(<span class="keyword">new</span> <span class="title class_">AsyncRpcException</span>(<span class="string">&quot;Server returned &quot;</span> + response.getStatusCode() + </span><br><span class="line">                                                     <span class="string">&quot; - async processing not supported&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// If 202 Accepted, we wait for MQ response</span></span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// Clean up on immediate HTTP failure</span></span><br><span class="line">            pendingRequests.remove(messageKey);</span><br><span class="line">            callback.onError(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleResponseMessage</span><span class="params">(MessageReceivedEvent event)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">messageKey</span> <span class="operator">=</span> event.getMessageKey();</span><br><span class="line">        <span class="type">CallbackContext</span> <span class="variable">context</span> <span class="operator">=</span> pendingRequests.remove(messageKey);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (context != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">response</span> <span class="operator">=</span> deserializeResponse(event.getPayload(), </span><br><span class="line">                                                    context.getResponseType());</span><br><span class="line">                context.getCallback().onSuccess(response);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                context.getCallback().onError(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">scheduleTimeout</span><span class="params">(String messageKey)</span> &#123;</span><br><span class="line">        timeoutExecutor.schedule(() -&gt; &#123;</span><br><span class="line">            <span class="type">CallbackContext</span> <span class="variable">context</span> <span class="operator">=</span> pendingRequests.remove(messageKey);</span><br><span class="line">            <span class="keyword">if</span> (context != <span class="literal">null</span>) &#123;</span><br><span class="line">                context.getCallback().onTimeout();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Server-Side-Response-Handler"><a href="#Server-Side-Response-Handler" class="headerlink" title="Server-Side Response Handler"></a>Server-Side Response Handler</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncRpcController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageQueueProvider mqProvider;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/api/process-async&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Void&gt; <span class="title function_">processAsync</span><span class="params">(<span class="meta">@RequestBody</span> ProcessRequest request,</span></span><br><span class="line"><span class="params">                                           HttpServletRequest httpRequest)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">messageKey</span> <span class="operator">=</span> httpRequest.getHeader(<span class="string">&quot;X-Message-Key&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">responseTopic</span> <span class="operator">=</span> httpRequest.getHeader(<span class="string">&quot;X-Response-Topic&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (messageKey == <span class="literal">null</span> || responseTopic == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.badRequest().build();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Return 202 Accepted immediately - process asynchronously</span></span><br><span class="line">        CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Long-running business logic</span></span><br><span class="line">                <span class="type">ProcessResponse</span> <span class="variable">response</span> <span class="operator">=</span> businessService.process(request);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Send response via MQ when processing is complete</span></span><br><span class="line">                <span class="type">MessageProducer</span> <span class="variable">producer</span> <span class="operator">=</span> mqProvider.createProducer(</span><br><span class="line">                    ProducerConfig.builder()</span><br><span class="line">                        .topic(responseTopic)</span><br><span class="line">                        .build());</span><br><span class="line">                        </span><br><span class="line">                <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> Message.builder()</span><br><span class="line">                    .key(messageKey)</span><br><span class="line">                    .payload(response)</span><br><span class="line">                    .header(<span class="string">&quot;correlation-id&quot;</span>, messageKey)</span><br><span class="line">                    .header(<span class="string">&quot;processing-time&quot;</span>, String.valueOf(System.currentTimeMillis()))</span><br><span class="line">                    .build();</span><br><span class="line">                    </span><br><span class="line">                producer.send(message);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// Send error response via MQ</span></span><br><span class="line">                sendErrorResponse(responseTopic, messageKey, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Client gets immediate acknowledgment that request was accepted</span></span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.accepted()</span><br><span class="line">                .header(<span class="string">&quot;X-Message-Key&quot;</span>, messageKey)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Why use direct HTTP for requests instead of publishing to MQ?</em><br><em>Answer: Direct HTTP for requests provides immediate feedback (request validation, routing errors), utilizes existing HTTP infrastructure (load balancers, proxies, security), maintains request traceability, and reduces latency. The MQ is only used for the response path where asynchronous benefits (decoupling, persistence, fault tolerance) are most valuable. This hybrid approach gets the best of both worlds - immediate request processing feedback and asynchronous response handling.</em></p>
<h2 id="Message-Producer-and-Consumer-Interfaces"><a href="#Message-Producer-and-Consumer-Interfaces" class="headerlink" title="Message Producer and Consumer Interfaces"></a>Message Producer and Consumer Interfaces</h2><p>The SDK defines unified interfaces for message production and consumption that abstract the underlying MQ implementation details.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MessageProducer</span> <span class="keyword">extends</span> <span class="title class_">AutoCloseable</span> &#123;</span><br><span class="line">    CompletableFuture&lt;SendResult&gt; <span class="title function_">send</span><span class="params">(Message message)</span>;</span><br><span class="line">    CompletableFuture&lt;SendResult&gt; <span class="title function_">send</span><span class="params">(String topic, Object payload)</span>;</span><br><span class="line">    CompletableFuture&lt;SendResult&gt; <span class="title function_">sendWithKey</span><span class="params">(String topic, String key, Object payload)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Batch operations for performance</span></span><br><span class="line">    CompletableFuture&lt;List&lt;SendResult&gt;&gt; <span class="title function_">sendBatch</span><span class="params">(List&lt;Message&gt; messages)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Transactional support</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">beginTransaction</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">commitTransaction</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">rollbackTransaction</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MessageConsumer</span> <span class="keyword">extends</span> <span class="title class_">AutoCloseable</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(String topic, MessageHandler handler)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(List&lt;String&gt; topics, MessageHandler handler)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">unsubscribe</span><span class="params">(String topic)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Manual acknowledgment control</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">acknowledge</span><span class="params">(Message message)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">reject</span><span class="params">(Message message, <span class="type">boolean</span> requeue)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Consumer group management</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">joinConsumerGroup</span><span class="params">(String groupId)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">leaveConsumerGroup</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Unified message format</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String key;</span><br><span class="line">    <span class="keyword">private</span> Object payload;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; headers;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> timestamp;</span><br><span class="line">    <span class="keyword">private</span> String topic;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> partition;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> offset;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Serialization metadata</span></span><br><span class="line">    <span class="keyword">private</span> String contentType;</span><br><span class="line">    <span class="keyword">private</span> String encoding;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Redis-Streams-Implementation-Example"><a href="#Redis-Streams-Implementation-Example" class="headerlink" title="Redis Streams Implementation Example"></a>Redis Streams Implementation Example</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisMessageConsumer</span> <span class="keyword">implements</span> <span class="title class_">MessageConsumer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String consumerGroup;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String consumerName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">consuming</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(String topic, MessageHandler handler)</span> &#123;</span><br><span class="line">        <span class="comment">// Create consumer group if not exists</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForStream().createGroup(topic, consumerGroup);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// Group might already exist</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        consuming = <span class="literal">true</span>;</span><br><span class="line">        CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (consuming) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    List&lt;MapRecord&lt;String, Object, Object&gt;&gt; records = </span><br><span class="line">                        redisTemplate.opsForStream().read(</span><br><span class="line">                            Consumer.from(consumerGroup, consumerName),</span><br><span class="line">                            StreamReadOptions.empty().count(<span class="number">10</span>).block(Duration.ofSeconds(<span class="number">1</span>)),</span><br><span class="line">                            StreamOffset.create(topic, ReadOffset.lastConsumed())</span><br><span class="line">                        );</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">for</span> (MapRecord&lt;String, Object, Object&gt; record : records) &#123;</span><br><span class="line">                        <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> convertToMessage(record);</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            handler.handle(message);</span><br><span class="line">                            <span class="comment">// Acknowledge message</span></span><br><span class="line">                            redisTemplate.opsForStream().acknowledge(topic, consumerGroup, </span><br><span class="line">                                                                   record.getId());</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                            <span class="comment">// Handle processing error</span></span><br><span class="line">                            handleProcessingError(message, e);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    handleConsumerError(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleProcessingError</span><span class="params">(Message message, Exception error)</span> &#123;</span><br><span class="line">        <span class="comment">// Implement retry logic or dead letter queue</span></span><br><span class="line">        <span class="type">RetryPolicy</span> <span class="variable">retryPolicy</span> <span class="operator">=</span> getRetryPolicy();</span><br><span class="line">        <span class="keyword">if</span> (retryPolicy.shouldRetry(message)) &#123;</span><br><span class="line">            scheduleRetry(message, retryPolicy.getNextDelay());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sendToDeadLetterQueue(message, error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Failure-Handling-and-Resilience-Patterns"><a href="#Failure-Handling-and-Resilience-Patterns" class="headerlink" title="Failure Handling and Resilience Patterns"></a>Failure Handling and Resilience Patterns</h2><p>Robust failure handling is crucial for production systems. The SDK implements multiple resilience patterns to handle various failure scenarios.</p>
<pre>
<code class="mermaid">
flowchart LR
A[Message Send] --&gt; B{Send Success?}
B --&gt;|Yes| C[Success]
B --&gt;|No| D[Retry Logic]
D --&gt; E{Max Retries?}
E --&gt;|No| F[Exponential Backoff]
F --&gt; A
E --&gt;|Yes| G[Circuit Breaker]
G --&gt; H{Circuit Open?}
H --&gt;|Yes| I[Fail Fast]
H --&gt;|No| J[Dead Letter Queue]
J --&gt; K[Alert&#x2F;Monitor]
</code>
</pre>

<h3 id="Resilience-Implementation"><a href="#Resilience-Implementation" class="headerlink" title="Resilience Implementation"></a>Resilience Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResilientMessageProducer</span> <span class="keyword">implements</span> <span class="title class_">MessageProducer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageProducer delegate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RetryTemplate retryTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CircuitBreaker circuitBreaker;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DeadLetterQueueManager dlqManager;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ResilientMessageProducer</span><span class="params">(MessageProducer delegate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.delegate = delegate;</span><br><span class="line">        <span class="built_in">this</span>.retryTemplate = buildRetryTemplate();</span><br><span class="line">        <span class="built_in">this</span>.circuitBreaker = buildCircuitBreaker();</span><br><span class="line">        <span class="built_in">this</span>.dlqManager = <span class="keyword">new</span> <span class="title class_">DeadLetterQueueManager</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;SendResult&gt; <span class="title function_">send</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> circuitBreaker.executeSupplier(() -&gt; &#123;</span><br><span class="line">                    <span class="keyword">return</span> retryTemplate.execute(context -&gt; &#123;</span><br><span class="line">                        <span class="keyword">return</span> delegate.send(message).get();</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// Send to dead letter queue after all retries exhausted</span></span><br><span class="line">                dlqManager.sendToDeadLetterQueue(message, e);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MessageSendException</span>(<span class="string">&quot;Failed to send message after retries&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> RetryTemplate <span class="title function_">buildRetryTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> RetryTemplate.builder()</span><br><span class="line">            .maxAttempts(<span class="number">3</span>)</span><br><span class="line">            .exponentialBackoff(<span class="number">1000</span>, <span class="number">2</span>, <span class="number">10000</span>)</span><br><span class="line">            .retryOn(MessageSendException.class)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> CircuitBreaker <span class="title function_">buildCircuitBreaker</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CircuitBreaker.ofDefaults(<span class="string">&quot;messageProducer&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Dead Letter Queue Management</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeadLetterQueueManager</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageProducer dlqProducer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> NotificationService notificationService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendToDeadLetterQueue</span><span class="params">(Message originalMessage, Exception error)</span> &#123;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">dlqMessage</span> <span class="operator">=</span> Message.builder()</span><br><span class="line">            .payload(originalMessage)</span><br><span class="line">            .headers(Map.of(</span><br><span class="line">                <span class="string">&quot;original-topic&quot;</span>, originalMessage.getTopic(),</span><br><span class="line">                <span class="string">&quot;error-message&quot;</span>, error.getMessage(),</span><br><span class="line">                <span class="string">&quot;error-type&quot;</span>, error.getClass().getSimpleName(),</span><br><span class="line">                <span class="string">&quot;failure-timestamp&quot;</span>, String.valueOf(System.currentTimeMillis())</span><br><span class="line">            ))</span><br><span class="line">            .topic(<span class="string">&quot;dead-letter-queue&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            dlqProducer.send(dlqMessage);</span><br><span class="line">            notificationService.alertDeadLetter(originalMessage, error);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception dlqError) &#123;</span><br><span class="line">            <span class="comment">// Log to persistent storage as last resort</span></span><br><span class="line">            persistentLogger.logFailedMessage(originalMessage, error, dlqError);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Network-Partition-Handling"><a href="#Network-Partition-Handling" class="headerlink" title="Network Partition Handling"></a>Network Partition Handling</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NetworkPartitionHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HealthCheckService healthCheckService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LocalMessageBuffer localBuffer;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleNetworkPartition</span><span class="params">(NetworkPartitionEvent event)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (event.isPartitioned()) &#123;</span><br><span class="line">            <span class="comment">// Switch to local buffering mode</span></span><br><span class="line">            localBuffer.enableBuffering();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Start health check monitoring</span></span><br><span class="line">            healthCheckService.startPartitionRecoveryMonitoring();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Network recovered - flush buffered messages</span></span><br><span class="line">            flushBufferedMessages();</span><br><span class="line">            localBuffer.disableBuffering();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">flushBufferedMessages</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Message&gt; bufferedMessages = localBuffer.getAllBufferedMessages();</span><br><span class="line">        </span><br><span class="line">        CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (Message message : bufferedMessages) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    delegate.send(message).get();</span><br><span class="line">                    localBuffer.removeBufferedMessage(message.getId());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="comment">// Keep in buffer for next flush attempt</span></span><br><span class="line">                    logger.warn(<span class="string">&quot;Failed to flush buffered message: &#123;&#125;&quot;</span>, message.getId(), e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>How do you handle message ordering in failure scenarios?</em><br><em>Answer: Message ordering can be maintained through partitioning strategies (same key goes to same partition), single-threaded consumers per partition, and implementing sequence numbers with gap detection. However, strict ordering often conflicts with high availability, so systems typically choose between strong ordering and high availability based on business requirements.</em></p>
<h2 id="Configuration-and-Best-Practices"><a href="#Configuration-and-Best-Practices" class="headerlink" title="Configuration and Best Practices"></a>Configuration and Best Practices</h2><h3 id="Configuration-Management"><a href="#Configuration-Management" class="headerlink" title="Configuration Management"></a>Configuration Management</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.yml</span></span><br><span class="line"><span class="attr">universal-mq:</span></span><br><span class="line">  <span class="attr">provider:</span> <span class="string">kafka</span>  <span class="comment"># kafka, redis, rocketmq</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Common configuration</span></span><br><span class="line">  <span class="attr">async-rpc:</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">30s</span></span><br><span class="line">    <span class="attr">max-pending-requests:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">response-topic-prefix:</span> <span class="string">&quot;async-rpc-responses&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">resilience:</span></span><br><span class="line">    <span class="attr">retry:</span></span><br><span class="line">      <span class="attr">max-attempts:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">initial-delay:</span> <span class="string">1s</span></span><br><span class="line">      <span class="attr">max-delay:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">multiplier:</span> <span class="number">2.0</span></span><br><span class="line">    <span class="attr">circuit-breaker:</span></span><br><span class="line">      <span class="attr">failure-rate-threshold:</span> <span class="number">50</span></span><br><span class="line">      <span class="attr">wait-duration-in-open-state:</span> <span class="string">60s</span></span><br><span class="line">      <span class="attr">sliding-window-size:</span> <span class="number">100</span></span><br><span class="line">    <span class="attr">dead-letter-queue:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">topic:</span> <span class="string">&quot;dead-letter-queue&quot;</span></span><br><span class="line">      </span><br><span class="line">  <span class="comment"># Provider-specific configuration</span></span><br><span class="line">  <span class="attr">kafka:</span></span><br><span class="line">    <span class="attr">bootstrap-servers:</span> <span class="string">&quot;localhost:9092&quot;</span></span><br><span class="line">    <span class="attr">producer:</span></span><br><span class="line">      <span class="attr">acks:</span> <span class="string">&quot;all&quot;</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">2147483647</span></span><br><span class="line">      <span class="attr">enable-idempotence:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">batch-size:</span> <span class="number">16384</span></span><br><span class="line">      <span class="attr">linger-ms:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">consumer:</span></span><br><span class="line">      <span class="attr">group-id:</span> <span class="string">&quot;universal-mq-consumers&quot;</span></span><br><span class="line">      <span class="attr">auto-offset-reset:</span> <span class="string">&quot;earliest&quot;</span></span><br><span class="line">      <span class="attr">enable-auto-commit:</span> <span class="literal">false</span></span><br><span class="line">      </span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">&quot;localhost&quot;</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">      <span class="attr">consumer-group:</span> <span class="string">&quot;universal-mq-group&quot;</span></span><br><span class="line">      <span class="attr">consumer-name:</span> <span class="string">&quot;$&#123;spring.application.name&#125;-$&#123;random.uuid&#125;&quot;</span></span><br><span class="line">      </span><br><span class="line">  <span class="attr">rocketmq:</span></span><br><span class="line">    <span class="attr">name-server:</span> <span class="string">&quot;localhost:9876&quot;</span></span><br><span class="line">    <span class="attr">producer:</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">&quot;universal-mq-producers&quot;</span></span><br><span class="line">      <span class="attr">send-msg-timeout:</span> <span class="number">3000</span></span><br><span class="line">    <span class="attr">consumer:</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">&quot;universal-mq-consumers&quot;</span></span><br><span class="line">      <span class="attr">consume-message-batch-max-size:</span> <span class="number">32</span></span><br></pre></td></tr></table></figure>

<h3 id="Production-Best-Practices"><a href="#Production-Best-Practices" class="headerlink" title="Production Best Practices"></a>Production Best Practices</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(UniversalMqProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UniversalMqConfiguration</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty(name = &quot;universal-mq.monitoring.enabled&quot;, havingValue = &quot;true&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> MqMetricsCollector <span class="title function_">metricsCollector</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MqMetricsCollector</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MessageQueueHealthIndicator <span class="title function_">healthIndicator</span><span class="params">(MessageQueueProvider provider)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MessageQueueHealthIndicator</span>(provider);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Production-ready thread pool configuration</span></span><br><span class="line">    <span class="meta">@Bean(&quot;mqExecutor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Executor <span class="title function_">taskExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">        executor.setCorePoolSize(<span class="number">10</span>);</span><br><span class="line">        executor.setMaxPoolSize(<span class="number">50</span>);</span><br><span class="line">        executor.setQueueCapacity(<span class="number">1000</span>);</span><br><span class="line">        executor.setKeepAliveSeconds(<span class="number">60</span>);</span><br><span class="line">        executor.setThreadNamePrefix(<span class="string">&quot;mq-&quot;</span>);</span><br><span class="line">        executor.setRejectedExecutionHandler(<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());</span><br><span class="line">        executor.initialize();</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Monitoring and Metrics</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqMetricsCollector</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter messagesProduced;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter messagesConsumed;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Timer messageProcessingTime;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MqMetricsCollector</span><span class="params">(MeterRegistry meterRegistry)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.meterRegistry = meterRegistry;</span><br><span class="line">        <span class="built_in">this</span>.messagesProduced = Counter.builder(<span class="string">&quot;mq.messages.produced&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Number of messages produced&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">        <span class="built_in">this</span>.messagesConsumed = Counter.builder(<span class="string">&quot;mq.messages.consumed&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Number of messages consumed&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">        <span class="built_in">this</span>.messageProcessingTime = Timer.builder(<span class="string">&quot;mq.message.processing.time&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Message processing time&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordMessageProduced</span><span class="params">(String topic, String provider)</span> &#123;</span><br><span class="line">        messagesProduced.increment(</span><br><span class="line">            Tags.of(<span class="string">&quot;topic&quot;</span>, topic, <span class="string">&quot;provider&quot;</span>, provider));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordMessageConsumed</span><span class="params">(String topic, String provider, <span class="type">long</span> processingTimeMs)</span> &#123;</span><br><span class="line">        messagesConsumed.increment(</span><br><span class="line">            Tags.of(<span class="string">&quot;topic&quot;</span>, topic, <span class="string">&quot;provider&quot;</span>, provider));</span><br><span class="line">        messageProcessingTime.record(processingTimeMs, TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Use-Cases-and-Examples"><a href="#Use-Cases-and-Examples" class="headerlink" title="Use Cases and Examples"></a>Use Cases and Examples</h2><h3 id="Use-Case-1-E-commerce-Order-Processing"><a href="#Use-Case-1-E-commerce-Order-Processing" class="headerlink" title="Use Case 1: E-commerce Order Processing"></a>Use Case 1: E-commerce Order Processing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Order processing with async notification</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AsyncRpcManager asyncRpcManager;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageProducer messageProducer;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processOrder</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">        <span class="comment">// Validate and save order</span></span><br><span class="line">        <span class="type">Order</span> <span class="variable">savedOrder</span> <span class="operator">=</span> orderRepository.save(order);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Async inventory check via direct HTTP + MQ response</span></span><br><span class="line">        asyncRpcManager.asyncPost(</span><br><span class="line">            <span class="string">&quot;http://inventory-service/check&quot;</span>, </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InventoryCheckRequest</span>(order.getItems()),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">AsyncCallback</span>&lt;InventoryCheckResponse&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(InventoryCheckResponse response)</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (response.isAvailable()) &#123;</span><br><span class="line">                        processPayment(savedOrder);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        cancelOrder(savedOrder, <span class="string">&quot;Insufficient inventory&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Exception error)</span> &#123;</span><br><span class="line">                    cancelOrder(savedOrder, <span class="string">&quot;Inventory check failed: &quot;</span> + error.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTimeout</span><span class="params">()</span> &#123;</span><br><span class="line">                    cancelOrder(savedOrder, <span class="string">&quot;Inventory check timeout&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            InventoryCheckResponse.class</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processPayment</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">        <span class="comment">// Async payment processing via direct HTTP + MQ response</span></span><br><span class="line">        asyncRpcManager.asyncPost(</span><br><span class="line">            <span class="string">&quot;http://payment-service/process&quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">PaymentRequest</span>(order.getTotalAmount(), order.getPaymentMethod()),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">PaymentCallback</span>(order),</span><br><span class="line">            PaymentResponse.class</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Inventory service response handler</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/check&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Void&gt; <span class="title function_">checkInventory</span><span class="params">(<span class="meta">@RequestBody</span> InventoryCheckRequest request,</span></span><br><span class="line"><span class="params">                                              HttpServletRequest httpRequest)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">messageKey</span> <span class="operator">=</span> httpRequest.getHeader(<span class="string">&quot;X-Message-Key&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">responseTopic</span> <span class="operator">=</span> httpRequest.getHeader(<span class="string">&quot;X-Response-Topic&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Process asynchronously and return 202 Accepted immediately</span></span><br><span class="line">        CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            <span class="type">InventoryCheckResponse</span> <span class="variable">response</span> <span class="operator">=</span> inventoryService.checkAvailability(request.getItems());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Send response via MQ after processing is complete</span></span><br><span class="line">            <span class="type">Message</span> <span class="variable">responseMessage</span> <span class="operator">=</span> Message.builder()</span><br><span class="line">                .key(messageKey)</span><br><span class="line">                .payload(response)</span><br><span class="line">                .topic(responseTopic)</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">                messageProducer.send(responseMessage);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.accepted()</span><br><span class="line">                .header(<span class="string">&quot;X-Message-Key&quot;</span>, messageKey)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Use-Case-2-Real-time-Analytics-Pipeline"><a href="#Use-Case-2-Real-time-Analytics-Pipeline" class="headerlink" title="Use Case 2: Real-time Analytics Pipeline"></a>Use Case 2: Real-time Analytics Pipeline</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Event streaming for analytics</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnalyticsEventProcessor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageConsumer eventConsumer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageProducer enrichedEventProducer;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startProcessing</span><span class="params">()</span> &#123;</span><br><span class="line">        eventConsumer.subscribe(<span class="string">&quot;user-events&quot;</span>, <span class="built_in">this</span>::processUserEvent);</span><br><span class="line">        eventConsumer.subscribe(<span class="string">&quot;system-events&quot;</span>, <span class="built_in">this</span>::processSystemEvent);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processUserEvent</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="type">UserEvent</span> <span class="variable">event</span> <span class="operator">=</span> (UserEvent) message.getPayload();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Enrich event with user profile data</span></span><br><span class="line">        <span class="type">UserProfile</span> <span class="variable">profile</span> <span class="operator">=</span> userProfileService.getProfile(event.getUserId());</span><br><span class="line">        <span class="type">EnrichedUserEvent</span> <span class="variable">enrichedEvent</span> <span class="operator">=</span> EnrichedUserEvent.builder()</span><br><span class="line">            .originalEvent(event)</span><br><span class="line">            .userProfile(profile)</span><br><span class="line">            .enrichmentTimestamp(System.currentTimeMillis())</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Send to analytics pipeline</span></span><br><span class="line">        enrichedEventProducer.send(<span class="string">&quot;enriched-user-events&quot;</span>, enrichedEvent);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Update real-time metrics</span></span><br><span class="line">        metricsService.updateUserMetrics(enrichedEvent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Use-Case-3-Microservice-Choreography"><a href="#Use-Case-3-Microservice-Choreography" class="headerlink" title="Use Case 3: Microservice Choreography"></a>Use Case 3: Microservice Choreography</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Saga pattern implementation</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderSagaOrchestrator</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, SagaState&gt; activeSagas = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleOrderCreated</span><span class="params">(OrderCreatedEvent event)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sagaId</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        <span class="type">SagaState</span> <span class="variable">saga</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SagaState</span>(sagaId, event.getOrder());</span><br><span class="line">        activeSagas.put(sagaId, saga);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Start saga - reserve inventory</span></span><br><span class="line">        asyncRpcManager.asyncPost(</span><br><span class="line">            <span class="string">&quot;http://inventory-service/reserve&quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ReserveInventoryRequest</span>(event.getOrder().getItems(), sagaId),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InventoryReservationCallback</span>(sagaId),</span><br><span class="line">            ReservationResponse.class</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryReservationCallback</span> <span class="keyword">implements</span> <span class="title class_">AsyncCallback</span>&lt;ReservationResponse&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String sagaId;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(ReservationResponse response)</span> &#123;</span><br><span class="line">            <span class="type">SagaState</span> <span class="variable">saga</span> <span class="operator">=</span> activeSagas.get(sagaId);</span><br><span class="line">            <span class="keyword">if</span> (response.isSuccess()) &#123;</span><br><span class="line">                saga.markInventoryReserved();</span><br><span class="line">                <span class="comment">// Next step - process payment</span></span><br><span class="line">                processPayment(saga);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Compensate - cancel order</span></span><br><span class="line">                compensateOrder(saga);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Exception error)</span> &#123;</span><br><span class="line">            compensateOrder(activeSagas.get(sagaId));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>How do you handle distributed transactions across multiple services?</em><br><em>Answer: Use saga patterns (orchestration or choreography) rather than two-phase commit. Implement compensating actions for each step, maintain saga state, and use event sourcing for audit trails. The Universal MQ SDK enables reliable event delivery needed for saga coordination.</em></p>
<h2 id="Performance-Optimization"><a href="#Performance-Optimization" class="headerlink" title="Performance Optimization"></a>Performance Optimization</h2><h3 id="Batching-and-Throughput-Optimization"><a href="#Batching-and-Throughput-Optimization" class="headerlink" title="Batching and Throughput Optimization"></a>Batching and Throughput Optimization</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BatchingMessageProducer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Message&gt; messageBuffer = <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">10000</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ScheduledExecutorService</span> <span class="variable">batchProcessor</span> <span class="operator">=</span> </span><br><span class="line">        Executors.newSingleThreadScheduledExecutor();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startBatchProcessing</span><span class="params">()</span> &#123;</span><br><span class="line">        batchProcessor.scheduleWithFixedDelay(<span class="built_in">this</span>::processBatch, <span class="number">100</span>, <span class="number">100</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;SendResult&gt; <span class="title function_">send</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        CompletableFuture&lt;SendResult&gt; future = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;&gt;();</span><br><span class="line">        message.setResultFuture(future);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!messageBuffer.offer(message)) &#123;</span><br><span class="line">            future.completeExceptionally(<span class="keyword">new</span> <span class="title class_">BufferFullException</span>(<span class="string">&quot;Message buffer is full&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> future;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processBatch</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Message&gt; batch = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        messageBuffer.drainTo(batch, <span class="number">100</span>); <span class="comment">// Max batch size</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!batch.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                List&lt;SendResult&gt; results = delegate.sendBatch(batch).get();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Complete futures</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; batch.size(); i++) &#123;</span><br><span class="line">                    batch.get(i).getResultFuture().complete(results.get(i));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// Complete all futures exceptionally</span></span><br><span class="line">                batch.forEach(msg -&gt; </span><br><span class="line">                    msg.getResultFuture().completeExceptionally(e));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Connection-Pooling-and-Resource-Management"><a href="#Connection-Pooling-and-Resource-Management" class="headerlink" title="Connection Pooling and Resource Management"></a>Connection Pooling and Resource Management</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqConnectionPool</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GenericObjectPool&lt;Connection&gt; connectionPool;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MqConnectionPool</span><span class="params">(ConnectionFactory factory)</span> &#123;</span><br><span class="line">        GenericObjectPoolConfig&lt;Connection&gt; config = <span class="keyword">new</span> <span class="title class_">GenericObjectPoolConfig</span>&lt;&gt;();</span><br><span class="line">        config.setMaxTotal(<span class="number">50</span>);</span><br><span class="line">        config.setMaxIdle(<span class="number">10</span>);</span><br><span class="line">        config.setMinIdle(<span class="number">5</span>);</span><br><span class="line">        config.setTestOnBorrow(<span class="literal">true</span>);</span><br><span class="line">        config.setTestWhileIdle(<span class="literal">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">this</span>.connectionPool = <span class="keyword">new</span> <span class="title class_">GenericObjectPool</span>&lt;&gt;(factory, config);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">executeWithConnection</span><span class="params">(ConnectionCallback&lt;T&gt; callback)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> connectionPool.borrowObject();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> callback.execute(connection);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            connectionPool.returnObject(connection);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Testing-Strategies"><a href="#Testing-Strategies" class="headerlink" title="Testing Strategies"></a>Testing Strategies</h2><h3 id="Integration-Testing-with-Testcontainers"><a href="#Integration-Testing-with-Testcontainers" class="headerlink" title="Integration Testing with Testcontainers"></a>Integration Testing with Testcontainers</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Testcontainers</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UniversalMqIntegrationTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Container</span></span><br><span class="line">    <span class="keyword">static</span> <span class="type">KafkaContainer</span> <span class="variable">kafka</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">KafkaContainer</span>(DockerImageName.parse(<span class="string">&quot;confluentinc/cp-kafka:latest&quot;</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Container</span></span><br><span class="line">    <span class="keyword">static</span> GenericContainer&lt;?&gt; redis = <span class="keyword">new</span> <span class="title class_">GenericContainer</span>&lt;&gt;(<span class="string">&quot;redis:7-alpine&quot;</span>)</span><br><span class="line">            .withExposedPorts(<span class="number">6379</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UniversalMqSDK mqSDK;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@DynamicPropertySource</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">configureProperties</span><span class="params">(DynamicPropertyRegistry registry)</span> &#123;</span><br><span class="line">        registry.add(<span class="string">&quot;universal-mq.kafka.bootstrap-servers&quot;</span>, kafka::getBootstrapServers);</span><br><span class="line">        registry.add(<span class="string">&quot;universal-mq.redis.host&quot;</span>, redis::getHost);</span><br><span class="line">        registry.add(<span class="string">&quot;universal-mq.redis.port&quot;</span>, () -&gt; redis.getMappedPort(<span class="number">6379</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testAsyncRpcWithKafka</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// Configure for Kafka</span></span><br><span class="line">        mqSDK.switchProvider(<span class="string">&quot;kafka&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">        AtomicReference&lt;String&gt; responseRef = <span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Mock HTTP server response</span></span><br><span class="line">        mockWebServer.enqueue(<span class="keyword">new</span> <span class="title class_">MockResponse</span>().setResponseCode(<span class="number">202</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Send async request</span></span><br><span class="line">        mqSDK.asyncPost(<span class="string">&quot;http://localhost:&quot;</span> + mockWebServer.getPort() + <span class="string">&quot;/test&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">TestRequest</span>(<span class="string">&quot;test data&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">AsyncCallback</span>&lt;TestResponse&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(TestResponse response)</span> &#123;</span><br><span class="line">                        responseRef.set(response.getMessage());</span><br><span class="line">                        latch.countDown();</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Exception error)</span> &#123;</span><br><span class="line">                        latch.countDown();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                TestResponse.class);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Simulate server response</span></span><br><span class="line">        simulateServerResponse(<span class="string">&quot;test-message-key&quot;</span>, <span class="string">&quot;Test response&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        assertTrue(latch.await(<span class="number">10</span>, TimeUnit.SECONDS));</span><br><span class="line">        assertEquals(<span class="string">&quot;Test response&quot;</span>, responseRef.get());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testProviderSwitching</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Test switching between providers</span></span><br><span class="line">        mqSDK.switchProvider(<span class="string">&quot;kafka&quot;</span>);</span><br><span class="line">        assertEquals(<span class="string">&quot;kafka&quot;</span>, mqSDK.getCurrentProvider());</span><br><span class="line">        </span><br><span class="line">        mqSDK.switchProvider(<span class="string">&quot;redis&quot;</span>);</span><br><span class="line">        assertEquals(<span class="string">&quot;redis&quot;</span>, mqSDK.getCurrentProvider());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Verify both providers work</span></span><br><span class="line">        assertDoesNotThrow(() -&gt; &#123;</span><br><span class="line">            mqSDK.send(<span class="string">&quot;test-topic&quot;</span>, <span class="string">&quot;test message&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testFailureRecovery</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// Test circuit breaker and retry mechanisms</span></span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">errorLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">3</span>); <span class="comment">// Expect 3 retries</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Mock server to fail initially then succeed</span></span><br><span class="line">        mockWebServer.enqueue(<span class="keyword">new</span> <span class="title class_">MockResponse</span>().setResponseCode(<span class="number">500</span>));</span><br><span class="line">        mockWebServer.enqueue(<span class="keyword">new</span> <span class="title class_">MockResponse</span>().setResponseCode(<span class="number">500</span>));</span><br><span class="line">        mockWebServer.enqueue(<span class="keyword">new</span> <span class="title class_">MockResponse</span>().setResponseCode(<span class="number">202</span>));</span><br><span class="line">        </span><br><span class="line">        mqSDK.asyncPost(<span class="string">&quot;http://localhost:&quot;</span> + mockWebServer.getPort() + <span class="string">&quot;/fail-test&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">TestRequest</span>(<span class="string">&quot;retry test&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">AsyncCallback</span>&lt;TestResponse&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(TestResponse response)</span> &#123;</span><br><span class="line">                        <span class="comment">// Should eventually succeed</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Exception error)</span> &#123;</span><br><span class="line">                        errorLatch.countDown();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                TestResponse.class);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Verify retry attempts</span></span><br><span class="line">        assertTrue(errorLatch.await(<span class="number">5</span>, TimeUnit.SECONDS));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Unit-Testing-with-Mocks"><a href="#Unit-Testing-with-Mocks" class="headerlink" title="Unit Testing with Mocks"></a>Unit Testing with Mocks</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExtendWith(MockitoExtension.class)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AsyncRpcManagerTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> MessageQueueProvider mqProvider;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> MessageProducer messageProducer;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@InjectMocks</span></span><br><span class="line">    <span class="keyword">private</span> AsyncRpcManager asyncRpcManager;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testSuccessfulAsyncCall</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Setup</span></span><br><span class="line">        <span class="keyword">when</span>(mqProvider.createProducer(any())).thenReturn(messageProducer);</span><br><span class="line">        <span class="keyword">when</span>(restTemplate.postForEntity(any(String.class), any(), eq(Void.class)))</span><br><span class="line">                .thenReturn(ResponseEntity.accepted().build());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Test</span></span><br><span class="line">        CompletableFuture&lt;String&gt; future = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;&gt;();</span><br><span class="line">        asyncRpcManager.asyncPost(<span class="string">&quot;http://test.com/api&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">TestRequest</span>(<span class="string">&quot;test&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">AsyncCallback</span>&lt;String&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(String response)</span> &#123;</span><br><span class="line">                        future.complete(response);</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Exception error)</span> &#123;</span><br><span class="line">                        future.completeExceptionally(error);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                String.class);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Simulate response</span></span><br><span class="line">        <span class="type">MessageReceivedEvent</span> <span class="variable">event</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageReceivedEvent</span>(<span class="string">&quot;test-message-key&quot;</span>, <span class="string">&quot;Success response&quot;</span>);</span><br><span class="line">        asyncRpcManager.handleResponseMessage(event);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Verify</span></span><br><span class="line">        assertDoesNotThrow(() -&gt; assertEquals(<span class="string">&quot;Success response&quot;</span>, future.get(<span class="number">1</span>, TimeUnit.SECONDS)));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testTimeoutHandling</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Configure short timeout for testing</span></span><br><span class="line">        asyncRpcManager.setTimeout(Duration.ofMillis(<span class="number">100</span>));</span><br><span class="line">        </span><br><span class="line">        CompletableFuture&lt;Boolean&gt; timeoutFuture = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        asyncRpcManager.asyncPost(<span class="string">&quot;http://test.com/api&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">TestRequest</span>(<span class="string">&quot;timeout test&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">AsyncCallback</span>&lt;String&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(String response)</span> &#123;</span><br><span class="line">                        timeoutFuture.complete(<span class="literal">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTimeout</span><span class="params">()</span> &#123;</span><br><span class="line">                        timeoutFuture.complete(<span class="literal">true</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Exception error)</span> &#123;</span><br><span class="line">                        timeoutFuture.completeExceptionally(error);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                String.class);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Verify timeout occurs</span></span><br><span class="line">        assertDoesNotThrow(() -&gt; assertTrue(timeoutFuture.get(<span class="number">1</span>, TimeUnit.SECONDS)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Security-Considerations"><a href="#Security-Considerations" class="headerlink" title="Security Considerations"></a>Security Considerations</h2><h3 id="Message-Encryption-and-Authentication"><a href="#Message-Encryption-and-Authentication" class="headerlink" title="Message Encryption and Authentication"></a>Message Encryption and Authentication</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecureMessageProducer</span> <span class="keyword">implements</span> <span class="title class_">MessageProducer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageProducer delegate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EncryptionService encryptionService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthenticationService authService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;SendResult&gt; <span class="title function_">send</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="comment">// Add authentication headers</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">authToken</span> <span class="operator">=</span> authService.generateToken();</span><br><span class="line">        message.getHeaders().put(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;Bearer &quot;</span> + authToken);</span><br><span class="line">        message.getHeaders().put(<span class="string">&quot;X-Client-ID&quot;</span>, authService.getClientId());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Encrypt sensitive payload</span></span><br><span class="line">        <span class="keyword">if</span> (isSensitiveMessage(message)) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">encryptedPayload</span> <span class="operator">=</span> encryptionService.encrypt(message.getPayload());</span><br><span class="line">            message = message.toBuilder()</span><br><span class="line">                    .payload(encryptedPayload)</span><br><span class="line">                    .header(<span class="string">&quot;Encrypted&quot;</span>, <span class="string">&quot;true&quot;</span>)</span><br><span class="line">                    .header(<span class="string">&quot;Encryption-Algorithm&quot;</span>, encryptionService.getAlgorithm())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> delegate.send(message);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isSensitiveMessage</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> message.getHeaders().containsKey(<span class="string">&quot;Sensitive&quot;</span>) ||</span><br><span class="line">               message.getPayload() <span class="keyword">instanceof</span> PersonalData ||</span><br><span class="line">               message.getTopic().contains(<span class="string">&quot;pii&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecureMessageConsumer</span> <span class="keyword">implements</span> <span class="title class_">MessageConsumer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageConsumer delegate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EncryptionService encryptionService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthenticationService authService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(String topic, MessageHandler handler)</span> &#123;</span><br><span class="line">        delegate.subscribe(topic, <span class="keyword">new</span> <span class="title class_">SecureMessageHandler</span>(handler));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">SecureMessageHandler</span> <span class="keyword">implements</span> <span class="title class_">MessageHandler</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> MessageHandler delegate;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">SecureMessageHandler</span><span class="params">(MessageHandler delegate)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.delegate = delegate;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">            <span class="comment">// Verify authentication</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">authHeader</span> <span class="operator">=</span> message.getHeaders().get(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!authService.validateToken(authHeader)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnauthorizedMessageException</span>(<span class="string">&quot;Invalid authentication token&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Decrypt if necessary</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;true&quot;</span>.equals(message.getHeaders().get(<span class="string">&quot;Encrypted&quot;</span>))) &#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">decryptedPayload</span> <span class="operator">=</span> encryptionService.decrypt(message.getPayload());</span><br><span class="line">                message = message.toBuilder().payload(decryptedPayload).build();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            delegate.handle(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Access-Control-and-Topic-Security"><a href="#Access-Control-and-Topic-Security" class="headerlink" title="Access Control and Topic Security"></a>Access Control and Topic Security</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TopicAccessController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AccessControlService accessControlService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">validateTopicAccess</span><span class="params">(String topic, String operation, String clientId)</span> &#123;</span><br><span class="line">        <span class="type">TopicPermission</span> <span class="variable">permission</span> <span class="operator">=</span> TopicPermission.valueOf(operation.toUpperCase());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!accessControlService.hasPermission(clientId, topic, permission)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AccessDeniedException</span>(</span><br><span class="line">                String.format(<span class="string">&quot;Client %s does not have %s permission for topic %s&quot;</span>, </span><br><span class="line">                             clientId, operation, topic));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasRole(&#x27;ADMIN&#x27;) or hasPermission(#topic, &#x27;WRITE&#x27;)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createTopic</span><span class="params">(String topic, TopicConfiguration config)</span> &#123;</span><br><span class="line">        <span class="comment">// Topic creation logic</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasPermission(#topic, &#x27;READ&#x27;)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">subscribeTo</span><span class="params">(String topic)</span> &#123;</span><br><span class="line">        <span class="comment">// Subscription logic</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Monitoring-and-Observability"><a href="#Monitoring-and-Observability" class="headerlink" title="Monitoring and Observability"></a>Monitoring and Observability</h2><h3 id="Distributed-Tracing-Integration"><a href="#Distributed-Tracing-Integration" class="headerlink" title="Distributed Tracing Integration"></a>Distributed Tracing Integration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TracingMessageProducer</span> <span class="keyword">implements</span> <span class="title class_">MessageProducer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageProducer delegate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Tracer tracer;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;SendResult&gt; <span class="title function_">send</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="type">Span</span> <span class="variable">span</span> <span class="operator">=</span> tracer.nextSpan()</span><br><span class="line">                .name(<span class="string">&quot;message-send&quot;</span>)</span><br><span class="line">                .tag(<span class="string">&quot;mq.topic&quot;</span>, message.getTopic())</span><br><span class="line">                .tag(<span class="string">&quot;mq.key&quot;</span>, message.getKey())</span><br><span class="line">                .start();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> (Tracer.<span class="type">SpanInScope</span> <span class="variable">ws</span> <span class="operator">=</span> tracer.withSpanInScope(span)) &#123;</span><br><span class="line">            <span class="comment">// Inject trace context into message headers</span></span><br><span class="line">            <span class="type">TraceContext</span> <span class="variable">traceContext</span> <span class="operator">=</span> span.context();</span><br><span class="line">            message.getHeaders().put(<span class="string">&quot;X-Trace-ID&quot;</span>, traceContext.traceId());</span><br><span class="line">            message.getHeaders().put(<span class="string">&quot;X-Span-ID&quot;</span>, traceContext.spanId());</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> delegate.send(message)</span><br><span class="line">                    .whenComplete((result, throwable) -&gt; &#123;</span><br><span class="line">                        <span class="keyword">if</span> (throwable != <span class="literal">null</span>) &#123;</span><br><span class="line">                            span.tag(<span class="string">&quot;error&quot;</span>, throwable.getMessage());</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            span.tag(<span class="string">&quot;mq.partition&quot;</span>, String.valueOf(result.getPartition()));</span><br><span class="line">                            span.tag(<span class="string">&quot;mq.offset&quot;</span>, String.valueOf(result.getOffset()));</span><br><span class="line">                        &#125;</span><br><span class="line">                        span.end();</span><br><span class="line">                    &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TracingMessageConsumer</span> <span class="keyword">implements</span> <span class="title class_">MessageConsumer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageConsumer delegate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Tracer tracer;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(String topic, MessageHandler handler)</span> &#123;</span><br><span class="line">        delegate.subscribe(topic, <span class="keyword">new</span> <span class="title class_">TracingMessageHandler</span>(handler));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">TracingMessageHandler</span> <span class="keyword">implements</span> <span class="title class_">MessageHandler</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> MessageHandler delegate;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">            <span class="comment">// Extract trace context from message headers</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">traceId</span> <span class="operator">=</span> message.getHeaders().get(<span class="string">&quot;X-Trace-ID&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">spanId</span> <span class="operator">=</span> message.getHeaders().get(<span class="string">&quot;X-Span-ID&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="type">SpanBuilder</span> <span class="variable">spanBuilder</span> <span class="operator">=</span> tracer.nextSpan()</span><br><span class="line">                    .name(<span class="string">&quot;message-consume&quot;</span>)</span><br><span class="line">                    .tag(<span class="string">&quot;mq.topic&quot;</span>, message.getTopic())</span><br><span class="line">                    .tag(<span class="string">&quot;mq.key&quot;</span>, message.getKey());</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (traceId != <span class="literal">null</span> &amp;&amp; spanId != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Continue trace from producer</span></span><br><span class="line">                spanBuilder = spanBuilder.asChildOf(createSpanContext(traceId, spanId));</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="type">Span</span> <span class="variable">span</span> <span class="operator">=</span> spanBuilder.start();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> (Tracer.<span class="type">SpanInScope</span> <span class="variable">ws</span> <span class="operator">=</span> tracer.withSpanInScope(span)) &#123;</span><br><span class="line">                delegate.handle(message);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                span.tag(<span class="string">&quot;error&quot;</span>, e.getMessage());</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                span.end();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Health-Checks-and-Metrics-Dashboard"><a href="#Health-Checks-and-Metrics-Dashboard" class="headerlink" title="Health Checks and Metrics Dashboard"></a>Health Checks and Metrics Dashboard</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqHealthIndicator</span> <span class="keyword">implements</span> <span class="title class_">HealthIndicator</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;MessageQueueProvider&gt; providers;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Health <span class="title function_">health</span><span class="params">()</span> &#123;</span><br><span class="line">        Health.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Health</span>.Builder();</span><br><span class="line">        </span><br><span class="line">        <span class="type">boolean</span> <span class="variable">allHealthy</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        Map&lt;String, Object&gt; details = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (MessageQueueProvider provider : providers) &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">healthy</span> <span class="operator">=</span> provider.isHealthy();</span><br><span class="line">            allHealthy &amp;= healthy;</span><br><span class="line">            </span><br><span class="line">            details.put(provider.getProviderName() + <span class="string">&quot;.status&quot;</span>, </span><br><span class="line">                       healthy ? <span class="string">&quot;UP&quot;</span> : <span class="string">&quot;DOWN&quot;</span>);</span><br><span class="line">            details.put(provider.getProviderName() + <span class="string">&quot;.metrics&quot;</span>, </span><br><span class="line">                       provider.getMetrics());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> allHealthy ? builder.up().withDetails(details).build() :</span><br><span class="line">                           builder.down().withDetails(details).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Custom metrics for business monitoring</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BusinessMetricsCollector</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Track message processing latency by business context</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordBusinessOperationLatency</span><span class="params">(String operation, <span class="type">long</span> latencyMs)</span> &#123;</span><br><span class="line">        Timer.builder(<span class="string">&quot;business.operation.latency&quot;</span>)</span><br><span class="line">                .tag(<span class="string">&quot;operation&quot;</span>, operation)</span><br><span class="line">                .register(meterRegistry)</span><br><span class="line">                .record(latencyMs, TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Track business-specific error rates</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordBusinessError</span><span class="params">(String errorType, String context)</span> &#123;</span><br><span class="line">        Counter.builder(<span class="string">&quot;business.errors&quot;</span>)</span><br><span class="line">                .tag(<span class="string">&quot;error.type&quot;</span>, errorType)</span><br><span class="line">                .tag(<span class="string">&quot;context&quot;</span>, context)</span><br><span class="line">                .register(meterRegistry)</span><br><span class="line">                .increment();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Migration-and-Deployment-Strategies"><a href="#Migration-and-Deployment-Strategies" class="headerlink" title="Migration and Deployment Strategies"></a>Migration and Deployment Strategies</h2><h3 id="Blue-Green-Deployment-with-Message-Queue-Migration"><a href="#Blue-Green-Deployment-with-Message-Queue-Migration" class="headerlink" title="Blue-Green Deployment with Message Queue Migration"></a>Blue-Green Deployment with Message Queue Migration</h3><pre>
<code class="mermaid">
flowchart TB
subgraph &quot;Blue Environment (Current)&quot;
    B1[Service A] --&gt; B2[Kafka Cluster]
    B3[Service B] --&gt; B2
end

subgraph &quot;Green Environment (New)&quot;
    G1[Service A] --&gt; G2[RocketMQ Cluster]
    G3[Service B] --&gt; G2
end

subgraph &quot;Migration Process&quot;
    M1[Dual Write Phase]
    M2[Consumer Migration]
    M3[Producer Migration]
    M4[Verification]
end

B2 --&gt; M1
G2 --&gt; M1
M1 --&gt; M2
M2 --&gt; M3
M3 --&gt; M4
</code>
</pre>

<h3 id="Migration-Implementation"><a href="#Migration-Implementation" class="headerlink" title="Migration Implementation"></a>Migration Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqMigrationManager</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, MessageQueueProvider&gt; providers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MigrationConfig migrationConfig;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startMigration</span><span class="params">(String fromProvider, String toProvider)</span> &#123;</span><br><span class="line">        <span class="type">MigrationPlan</span> <span class="variable">plan</span> <span class="operator">=</span> createMigrationPlan(fromProvider, toProvider);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Phase 1: Start dual write</span></span><br><span class="line">        enableDualWrite(fromProvider, toProvider);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Phase 2: Migrate consumers gradually</span></span><br><span class="line">        migrateConsumersGradually(fromProvider, toProvider, plan);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Phase 3: Stop old producer after lag verification</span></span><br><span class="line">        stopOldProducerAfterVerification(fromProvider, toProvider);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Phase 4: Clean up</span></span><br><span class="line">        cleanupOldInfrastructure(fromProvider);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">enableDualWrite</span><span class="params">(String fromProvider, String toProvider)</span> &#123;</span><br><span class="line">        <span class="comment">// Configure all producers to write to both systems</span></span><br><span class="line">        <span class="type">MessageProducer</span> <span class="variable">oldProducer</span> <span class="operator">=</span> providers.get(fromProvider).createProducer(getConfig());</span><br><span class="line">        <span class="type">MessageProducer</span> <span class="variable">newProducer</span> <span class="operator">=</span> providers.get(toProvider).createProducer(getConfig());</span><br><span class="line">        </span><br><span class="line">        <span class="type">DualWriteProducer</span> <span class="variable">dualProducer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DualWriteProducer</span>(oldProducer, newProducer);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Replace existing producers</span></span><br><span class="line">        applicationContext.getBean(MessageProducerFactory.class)</span><br><span class="line">                .setDefaultProducer(dualProducer);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">migrateConsumersGradually</span><span class="params">(String fromProvider, String toProvider, </span></span><br><span class="line"><span class="params">                                          MigrationPlan plan)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (ConsumerMigrationStep step : plan.getConsumerSteps()) &#123;</span><br><span class="line">            <span class="comment">// Stop percentage of old consumers</span></span><br><span class="line">            stopConsumers(fromProvider, step.getTopics(), step.getPercentage());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Start same percentage of new consumers</span></span><br><span class="line">            startConsumers(toProvider, step.getTopics(), step.getPercentage());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Wait and verify lag is manageable</span></span><br><span class="line">            waitAndVerifyLag(step.getVerificationTimeMs());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Dual write producer for zero-downtime migration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DualWriteProducer</span> <span class="keyword">implements</span> <span class="title class_">MessageProducer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageProducer primaryProducer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageProducer secondaryProducer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MigrationMetrics metrics;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;SendResult&gt; <span class="title function_">send</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="comment">// Send to primary (current) system</span></span><br><span class="line">        CompletableFuture&lt;SendResult&gt; primaryFuture = primaryProducer.send(message);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Send to secondary (new) system - don&#x27;t fail if this fails</span></span><br><span class="line">        CompletableFuture&lt;SendResult&gt; secondaryFuture = secondaryProducer.send(message)</span><br><span class="line">                .handle((result, throwable) -&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> (throwable != <span class="literal">null</span>) &#123;</span><br><span class="line">                        metrics.recordSecondaryWriteFailure(message.getTopic(), throwable);</span><br><span class="line">                        <span class="comment">// Log but don&#x27;t propagate error</span></span><br><span class="line">                        logger.warn(<span class="string">&quot;Secondary write failed for topic: &#123;&#125;&quot;</span>, </span><br><span class="line">                                   message.getTopic(), throwable);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> result;</span><br><span class="line">                &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Return primary result - migration is transparent to clients</span></span><br><span class="line">        <span class="keyword">return</span> primaryFuture;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Advanced-Topics"><a href="#Advanced-Topics" class="headerlink" title="Advanced Topics"></a>Advanced Topics</h2><h3 id="Message-Schema-Evolution"><a href="#Message-Schema-Evolution" class="headerlink" title="Message Schema Evolution"></a>Message Schema Evolution</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Schema registry integration</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SchemaAwareMessageProducer</span> <span class="keyword">implements</span> <span class="title class_">MessageProducer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageProducer delegate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SchemaRegistry schemaRegistry;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;SendResult&gt; <span class="title function_">send</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="comment">// Validate and evolve schema</span></span><br><span class="line">        <span class="type">Schema</span> <span class="variable">currentSchema</span> <span class="operator">=</span> schemaRegistry.getLatestSchema(message.getTopic());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (currentSchema != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Validate message against schema</span></span><br><span class="line">            <span class="type">SchemaValidationResult</span> <span class="variable">validation</span> <span class="operator">=</span> currentSchema.validate(message.getPayload());</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (!validation.isValid()) &#123;</span><br><span class="line">                <span class="comment">// Attempt automatic schema evolution</span></span><br><span class="line">                <span class="type">Object</span> <span class="variable">evolvedPayload</span> <span class="operator">=</span> schemaRegistry.evolvePayload(</span><br><span class="line">                        message.getPayload(), currentSchema);</span><br><span class="line">                message = message.toBuilder().payload(evolvedPayload).build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Add schema metadata to message</span></span><br><span class="line">        message.getHeaders().put(<span class="string">&quot;Schema-ID&quot;</span>, currentSchema.getId());</span><br><span class="line">        message.getHeaders().put(<span class="string">&quot;Schema-Version&quot;</span>, String.valueOf(currentSchema.getVersion()));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> delegate.send(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Backward compatibility handler</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BackwardCompatibilityConsumer</span> <span class="keyword">implements</span> <span class="title class_">MessageConsumer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageConsumer delegate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SchemaRegistry schemaRegistry;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(String topic, MessageHandler handler)</span> &#123;</span><br><span class="line">        delegate.subscribe(topic, <span class="keyword">new</span> <span class="title class_">CompatibilityMessageHandler</span>(handler, topic));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">CompatibilityMessageHandler</span> <span class="keyword">implements</span> <span class="title class_">MessageHandler</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> MessageHandler delegate;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String topic;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">schemaId</span> <span class="operator">=</span> message.getHeaders().get(<span class="string">&quot;Schema-ID&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (schemaId != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Get the schema used to produce this message</span></span><br><span class="line">                <span class="type">Schema</span> <span class="variable">producerSchema</span> <span class="operator">=</span> schemaRegistry.getSchema(schemaId);</span><br><span class="line">                <span class="type">Schema</span> <span class="variable">currentSchema</span> <span class="operator">=</span> schemaRegistry.getLatestSchema(topic);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (!producerSchema.equals(currentSchema)) &#123;</span><br><span class="line">                    <span class="comment">// Migrate message to current schema</span></span><br><span class="line">                    <span class="type">Object</span> <span class="variable">migratedPayload</span> <span class="operator">=</span> schemaRegistry.migratePayload(</span><br><span class="line">                            message.getPayload(), producerSchema, currentSchema);</span><br><span class="line">                    message = message.toBuilder().payload(migratedPayload).build();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            delegate.handle(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Event-Sourcing-Integration"><a href="#Event-Sourcing-Integration" class="headerlink" title="Event Sourcing Integration"></a>Event Sourcing Integration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Event store using Universal MQ SDK</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventStore</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageProducer eventProducer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageConsumer eventConsumer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EventRepository eventRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">storeEvent</span><span class="params">(DomainEvent event)</span> &#123;</span><br><span class="line">        <span class="comment">// Store in persistent event log</span></span><br><span class="line">        <span class="type">EventRecord</span> <span class="variable">record</span> <span class="operator">=</span> EventRecord.builder()</span><br><span class="line">                .eventId(event.getEventId())</span><br><span class="line">                .aggregateId(event.getAggregateId())</span><br><span class="line">                .eventType(event.getClass().getSimpleName())</span><br><span class="line">                .eventData(serialize(event))</span><br><span class="line">                .timestamp(event.getTimestamp())</span><br><span class="line">                .version(event.getVersion())</span><br><span class="line">                .build();</span><br><span class="line">        </span><br><span class="line">        eventRepository.save(record);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Publish for real-time processing</span></span><br><span class="line">        <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> Message.builder()</span><br><span class="line">                .key(event.getAggregateId())</span><br><span class="line">                .payload(event)</span><br><span class="line">                .topic(<span class="string">&quot;domain-events&quot;</span>)</span><br><span class="line">                .header(<span class="string">&quot;Event-Type&quot;</span>, event.getClass().getSimpleName())</span><br><span class="line">                .header(<span class="string">&quot;Aggregate-ID&quot;</span>, event.getAggregateId())</span><br><span class="line">                .build();</span><br><span class="line">        </span><br><span class="line">        eventProducer.send(message);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> List&lt;DomainEvent&gt; <span class="title function_">getEventHistory</span><span class="params">(String aggregateId, <span class="type">int</span> fromVersion)</span> &#123;</span><br><span class="line">        <span class="comment">// Replay events from persistent store</span></span><br><span class="line">        List&lt;EventRecord&gt; records = eventRepository.findByAggregateIdAndVersionGreaterThan(</span><br><span class="line">                aggregateId, fromVersion);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> records.stream()</span><br><span class="line">                .map(<span class="built_in">this</span>::deserializeEvent)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startEventProjections</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Subscribe to events for read model updates</span></span><br><span class="line">        eventConsumer.subscribe(<span class="string">&quot;domain-events&quot;</span>, <span class="built_in">this</span>::handleDomainEvent);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleDomainEvent</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="type">DomainEvent</span> <span class="variable">event</span> <span class="operator">=</span> (DomainEvent) message.getPayload();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Update read models/projections</span></span><br><span class="line">        projectionService.updateProjections(event);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Trigger side effects</span></span><br><span class="line">        sideEffectProcessor.processSideEffects(event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Interview-Questions-and-Expert-Insights"><a href="#Interview-Questions-and-Expert-Insights" class="headerlink" title="Interview Questions and Expert Insights"></a>Interview Questions and Expert Insights</h2><h3 id="Q-How-would-you-handle-message-ordering-guarantees-across-different-MQ-providers"><a href="#Q-How-would-you-handle-message-ordering-guarantees-across-different-MQ-providers" class="headerlink" title="Q: How would you handle message ordering guarantees across different MQ providers?"></a><strong>Q: How would you handle message ordering guarantees across different MQ providers?</strong></h3><p><strong>Expert Answer</strong>: Message ordering is achieved differently across providers:</p>
<ul>
<li><strong>Kafka</strong>: Uses partitioning - messages with the same key go to the same partition, maintaining order within that partition</li>
<li><strong>Redis Streams</strong>: Inherently ordered within a stream, use stream keys for partitioning</li>
<li><strong>RocketMQ</strong>: Supports both ordered and unordered messages, use MessageQueueSelector for ordering</li>
</ul>
<p>The Universal SDK abstracts this by implementing a consistent partitioning strategy based on message keys, ensuring the same ordering semantics regardless of the underlying provider.</p>
<h3 id="Q-What-are-the-performance-implications-of-your-SPI-based-approach"><a href="#Q-What-are-the-performance-implications-of-your-SPI-based-approach" class="headerlink" title="Q: What are the performance implications of your SPI-based approach?"></a><strong>Q: What are the performance implications of your SPI-based approach?</strong></h3><p><strong>Expert Answer</strong>: The SPI approach has minimal runtime overhead:</p>
<ul>
<li><strong>Initialization cost</strong>: Provider discovery happens once at startup</li>
<li><strong>Runtime cost</strong>: Single level of indirection (interface call)</li>
<li><strong>Memory overhead</strong>: Multiple providers loaded but only active one used</li>
<li><strong>Optimization</strong>: Use provider-specific optimizations under the unified interface</li>
</ul>
<p>Benefits outweigh costs: vendor flexibility, simplified testing, and operational consistency justify the slight performance trade-off.</p>
<h3 id="Q-How-do-you-ensure-exactly-once-delivery-semantics"><a href="#Q-How-do-you-ensure-exactly-once-delivery-semantics" class="headerlink" title="Q: How do you ensure exactly-once delivery semantics?"></a><strong>Q: How do you ensure exactly-once delivery semantics?</strong></h3><p><strong>Expert Answer</strong>: Exactly-once is challenging and provider-dependent:</p>
<ul>
<li><strong>Kafka</strong>: Use idempotent producers + transactional consumers</li>
<li><strong>Redis</strong>: Leverage Redis transactions and consumer group acknowledgments</li>
<li><strong>RocketMQ</strong>: Built-in transactional message support</li>
</ul>
<p>The SDK implements idempotency through:</p>
<ul>
<li>Message deduplication using correlation IDs</li>
<li>Idempotent message handlers</li>
<li>At-least-once delivery with deduplication at the application level</li>
</ul>
<h3 id="Q-How-would-you-handle-schema-evolution-in-a-microservices-environment"><a href="#Q-How-would-you-handle-schema-evolution-in-a-microservices-environment" class="headerlink" title="Q: How would you handle schema evolution in a microservices environment?"></a><strong>Q: How would you handle schema evolution in a microservices environment?</strong></h3><p><strong>Expert Answer</strong>: Schema evolution requires careful planning:</p>
<ol>
<li><strong>Forward Compatibility</strong>: New producers can write data that old consumers can read</li>
<li><strong>Backward Compatibility</strong>: Old producers can write data that new consumers can read</li>
<li><strong>Full Compatibility</strong>: Both forward and backward compatibility</li>
</ol>
<p>Implementation strategies:</p>
<ul>
<li>Use Avro or Protocol Buffers for schema definition</li>
<li>Implement schema registry for centralized schema management</li>
<li>Version schemas and maintain compatibility matrices</li>
<li>Gradual rollout of schema changes with monitoring</li>
</ul>
<h2 id="External-References-and-Resources"><a href="#External-References-and-Resources" class="headerlink" title="External References and Resources"></a>External References and Resources</h2><h3 id="Official-Documentation"><a href="#Official-Documentation" class="headerlink" title="Official Documentation"></a>Official Documentation</h3><ul>
<li><a target="_blank" rel="noopener" href="https://kafka.apache.org/documentation/">Apache Kafka Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://redis.io/docs/data-types/streams/">Redis Streams Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://rocketmq.apache.org/docs/quick-start/">Apache RocketMQ Documentation</a></li>
</ul>
<h3 id="Best-Practices-and-Patterns"><a href="#Best-Practices-and-Patterns" class="headerlink" title="Best Practices and Patterns"></a>Best Practices and Patterns</h3><ul>
<li><a target="_blank" rel="noopener" href="https://microservices.io/patterns/">Microservices Patterns by Chris Richardson</a></li>
<li><a target="_blank" rel="noopener" href="https://learning.oreilly.com/library/view/building-event-driven-microservices/9781492057888/">Building Event-Driven Microservices by Adam Bellemare</a></li>
<li><a target="_blank" rel="noopener" href="https://dataintensive.net/">Designing Data-Intensive Applications by Martin Kleppmann</a></li>
</ul>
<h3 id="Production-Operations"><a href="#Production-Operations" class="headerlink" title="Production Operations"></a>Production Operations</h3><ul>
<li><a target="_blank" rel="noopener" href="https://kafka.apache.org/documentation/#operations">Kafka Operations and Monitoring</a></li>
<li><a target="_blank" rel="noopener" href="https://redis.io/topics/sentinel">Redis High Availability</a></li>
<li><a target="_blank" rel="noopener" href="https://distributed-systems-observability-ebook.humio.com/">Distributed Systems Observability</a></li>
</ul>
<h3 id="Testing-and-Development"><a href="#Testing-and-Development" class="headerlink" title="Testing and Development"></a>Testing and Development</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.testcontainers.org/">Testcontainers Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://spring.io/guides/gs/testing-web/">Spring Boot Testing</a></li>
<li><a target="_blank" rel="noopener" href="https://principlesofchaos.org/">Chaos Engineering Principles</a></li>
</ul>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>The Universal Message Queue Component SDK provides a robust, production-ready solution for abstracting message queue implementations while maintaining high performance and reliability. By leveraging the SPI mechanism, implementing comprehensive failure handling, and supporting advanced patterns like async RPC, this SDK enables organizations to build resilient distributed systems that can evolve with changing technology requirements.</p>
<p>The key to success with this SDK lies in understanding the trade-offs between abstraction and performance, implementing proper monitoring and observability, and following established patterns for distributed system design. With careful attention to schema evolution, security, and operational concerns, this SDK can serve as a foundation for scalable microservices architectures.</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/system-design/" rel="tag"># system-design</a>
              <a href="/tags/async-invocation/" rel="tag"># async invocation</a>
              <a href="/tags/universal-mq/" rel="tag"># universal mq</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/06/13/Design-File-Storage-Service/" rel="prev" title="Design File Storage Service">
                  <i class="fa fa-angle-left"></i> Design File Storage Service
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/06/13/Design-Multi-Tenant-Database-SDK/" rel="next" title="Design Multi-Tenant Database SDK">
                  Design Multi-Tenant Database SDK <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Charlie Feng</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
