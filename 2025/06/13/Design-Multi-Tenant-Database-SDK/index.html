<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"shayne007.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="Overview and ArchitectureA Multi-Tenant Database SDK is a critical component in modern SaaS architectures that enables applications to dynamically manage database connections and operations across mul">
<meta property="og:type" content="article">
<meta property="og:title" content="Design Multi-Tenant Database SDK">
<meta property="og:url" content="https://shayne007.github.io/2025/06/13/Design-Multi-Tenant-Database-SDK/index.html">
<meta property="og:site_name" content="Charlie Feng&#39;s Tech Space">
<meta property="og:description" content="Overview and ArchitectureA Multi-Tenant Database SDK is a critical component in modern SaaS architectures that enables applications to dynamically manage database connections and operations across mul">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-06-13T10:40:02.000Z">
<meta property="article:modified_time" content="2025-06-29T05:36:32.850Z">
<meta property="article:author" content="Charlie Feng">
<meta property="article:tag" content="system-design">
<meta property="article:tag" content="async invocation">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://shayne007.github.io/2025/06/13/Design-Multi-Tenant-Database-SDK/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://shayne007.github.io/2025/06/13/Design-Multi-Tenant-Database-SDK/","path":"2025/06/13/Design-Multi-Tenant-Database-SDK/","title":"Design Multi-Tenant Database SDK"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Design Multi-Tenant Database SDK | Charlie Feng's Tech Space</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"cdn":false,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.5.0/mermaid.min.js","integrity":"sha256-2obLuIPcceEhkE3G09G33hBdmE55ivVcZUlcKcGNHjU="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>





  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Charlie Feng's Tech Space</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">You will survive with skills</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Overview-and-Architecture"><span class="nav-number">1.</span> <span class="nav-text">Overview and Architecture</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Core-Architecture-Components"><span class="nav-number">1.1.</span> <span class="nav-text">Core Architecture Components</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Tenant-Context-Management"><span class="nav-number">2.</span> <span class="nav-text">Tenant Context Management</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ThreadLocal-Implementation"><span class="nav-number">2.1.</span> <span class="nav-text">ThreadLocal Implementation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tenant-Context-Interceptor"><span class="nav-number">2.2.</span> <span class="nav-text">Tenant Context Interceptor</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Connection-Pool-Management"><span class="nav-number">3.</span> <span class="nav-text">Connection Pool Management</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Dynamic-DataSource-Configuration"><span class="nav-number">3.1.</span> <span class="nav-text">Dynamic DataSource Configuration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Connection-Pool-Manager-Implementation"><span class="nav-number">3.2.</span> <span class="nav-text">Connection Pool Manager Implementation</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Database-Provider-Implementation-via-SPI"><span class="nav-number">4.</span> <span class="nav-text">Database Provider Implementation via SPI</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Service-Provider-Interface"><span class="nav-number">4.1.</span> <span class="nav-text">Service Provider Interface</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL-Provider-Implementation"><span class="nav-number">4.2.</span> <span class="nav-text">MySQL Provider Implementation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PostgreSQL-Provider-Implementation"><span class="nav-number">4.3.</span> <span class="nav-text">PostgreSQL Provider Implementation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SPI-Registry-and-Factory"><span class="nav-number">4.4.</span> <span class="nav-text">SPI Registry and Factory</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Multi-Tenant-Database-Operations"><span class="nav-number">5.</span> <span class="nav-text">Multi-Tenant Database Operations</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Core-SDK-Interface"><span class="nav-number">5.1.</span> <span class="nav-text">Core SDK Interface</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SDK-Implementation"><span class="nav-number">5.2.</span> <span class="nav-text">SDK Implementation</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Production-Use-Cases-and-Examples"><span class="nav-number">6.</span> <span class="nav-text">Production Use Cases and Examples</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Use-Case-1-SaaS-CRM-System"><span class="nav-number">6.1.</span> <span class="nav-text">Use Case 1: SaaS CRM System</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Use-Case-2-Tenant-Onboarding-Process"><span class="nav-number">6.2.</span> <span class="nav-text">Use Case 2: Tenant Onboarding Process</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Use-Case-3-Data-Migration-Between-Tenants"><span class="nav-number">6.3.</span> <span class="nav-text">Use Case 3: Data Migration Between Tenants</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Runtime-Datasource-Switching"><span class="nav-number">7.</span> <span class="nav-text">Runtime Datasource Switching</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Dynamic-DataSource-Routing"><span class="nav-number">7.1.</span> <span class="nav-text">Dynamic DataSource Routing</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Request-Flow-Diagram"><span class="nav-number">7.2.</span> <span class="nav-text">Request Flow Diagram</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Performance-Optimization-Strategies"><span class="nav-number">8.</span> <span class="nav-text">Performance Optimization Strategies</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Connection-Pool-Tuning"><span class="nav-number">8.1.</span> <span class="nav-text">Connection Pool Tuning</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Connection-Pool-Monitoring"><span class="nav-number">8.2.</span> <span class="nav-text">Connection Pool Monitoring</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Caching-Strategy"><span class="nav-number">8.3.</span> <span class="nav-text">Caching Strategy</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Security-and-Compliance"><span class="nav-number">9.</span> <span class="nav-text">Security and Compliance</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Tenant-Isolation-Security"><span class="nav-number">9.1.</span> <span class="nav-text">Tenant Isolation Security</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Encryption-and-Data-Protection"><span class="nav-number">9.2.</span> <span class="nav-text">Encryption and Data Protection</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Error-Handling-and-Resilience"><span class="nav-number">10.</span> <span class="nav-text">Error Handling and Resilience</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Exception-Hierarchy"><span class="nav-number">10.1.</span> <span class="nav-text">Exception Hierarchy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Retry-Mechanism"><span class="nav-number">10.2.</span> <span class="nav-text">Retry Mechanism</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Circuit-Breaker-Implementation"><span class="nav-number">10.3.</span> <span class="nav-text">Circuit Breaker Implementation</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Testing-Strategies"><span class="nav-number">11.</span> <span class="nav-text">Testing Strategies</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Unit-Testing"><span class="nav-number">11.1.</span> <span class="nav-text">Unit Testing</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Integration-Testing"><span class="nav-number">11.2.</span> <span class="nav-text">Integration Testing</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Monitoring-and-Observability"><span class="nav-number">12.</span> <span class="nav-text">Monitoring and Observability</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Metrics-Collection"><span class="nav-number">12.1.</span> <span class="nav-text">Metrics Collection</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Health-Checks"><span class="nav-number">12.2.</span> <span class="nav-text">Health Checks</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Deployment-and-Configuration"><span class="nav-number">13.</span> <span class="nav-text">Deployment and Configuration</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Docker-Configuration"><span class="nav-number">13.1.</span> <span class="nav-text">Docker Configuration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kubernetes-Deployment"><span class="nav-number">13.2.</span> <span class="nav-text">Kubernetes Deployment</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Common-Interview-Questions-and-Answers"><span class="nav-number">14.</span> <span class="nav-text">Common Interview Questions and Answers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Advanced-Features-and-Extensions"><span class="nav-number">15.</span> <span class="nav-text">Advanced Features and Extensions</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Tenant-Database-Sharding"><span class="nav-number">15.1.</span> <span class="nav-text">Tenant Database Sharding</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tenant-Migration-and-Backup"><span class="nav-number">15.2.</span> <span class="nav-text">Tenant Migration and Backup</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Read-Replica-Support"><span class="nav-number">15.3.</span> <span class="nav-text">Read Replica Support</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Multi-Database-Transaction-Support"><span class="nav-number">15.4.</span> <span class="nav-text">Multi-Database Transaction Support</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Performance-Benchmarking-and-Optimization"><span class="nav-number">16.</span> <span class="nav-text">Performance Benchmarking and Optimization</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Benchmark-Results"><span class="nav-number">16.1.</span> <span class="nav-text">Benchmark Results</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Performance-Optimization-Recommendations"><span class="nav-number">16.2.</span> <span class="nav-text">Performance Optimization Recommendations</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Security-Best-Practices"><span class="nav-number">17.</span> <span class="nav-text">Security Best Practices</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Security-Architecture"><span class="nav-number">17.1.</span> <span class="nav-text">Security Architecture</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Advanced-Security-Features"><span class="nav-number">17.2.</span> <span class="nav-text">Advanced Security Features</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Data-Masking-and-Privacy"><span class="nav-number">17.3.</span> <span class="nav-text">Data Masking and Privacy</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Disaster-Recovery-and-High-Availability"><span class="nav-number">18.</span> <span class="nav-text">Disaster Recovery and High Availability</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Backup-and-Recovery-Strategy"><span class="nav-number">18.1.</span> <span class="nav-text">Backup and Recovery Strategy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#High-Availability-Configuration"><span class="nav-number">18.2.</span> <span class="nav-text">High Availability Configuration</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#External-References-and-Resources"><span class="nav-number">19.</span> <span class="nav-text">External References and Resources</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Documentation-and-Specifications"><span class="nav-number">19.1.</span> <span class="nav-text">Documentation and Specifications</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Performance-and-Monitoring"><span class="nav-number">19.2.</span> <span class="nav-text">Performance and Monitoring</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Security-Resources"><span class="nav-number">19.3.</span> <span class="nav-text">Security Resources</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Cloud-and-DevOps"><span class="nav-number">19.4.</span> <span class="nav-text">Cloud and DevOps</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Conclusion"><span class="nav-number">20.</span> <span class="nav-text">Conclusion</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Charlie Feng</p>
  <div class="site-description" itemprop="description">This place is for thinking and sharing.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">48</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/13/Design-Multi-Tenant-Database-SDK/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Design Multi-Tenant Database SDK | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Design Multi-Tenant Database SDK
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-13 18:40:02" itemprop="dateCreated datePublished" datetime="2025-06-13T18:40:02+08:00">2025-06-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-29 13:36:32" itemprop="dateModified" datetime="2025-06-29T13:36:32+08:00">2025-06-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system-design/" itemprop="url" rel="index"><span itemprop="name">system-design</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="Overview-and-Architecture"><a href="#Overview-and-Architecture" class="headerlink" title="Overview and Architecture"></a>Overview and Architecture</h2><p>A Multi-Tenant Database SDK is a critical component in modern SaaS architectures that enables applications to dynamically manage database connections and operations across multiple tenants. This SDK provides a unified interface for database operations while maintaining tenant isolation and optimizing resource utilization through connection pooling and runtime datasource switching.</p>
<h3 id="Core-Architecture-Components"><a href="#Core-Architecture-Components" class="headerlink" title="Core Architecture Components"></a>Core Architecture Components</h3><pre>
<code class="mermaid">
graph TB
A[SaaS Application] --&gt; B[Multi-Tenant SDK]
B --&gt; C[Tenant Context Manager]
B --&gt; D[Connection Pool Manager]
B --&gt; E[Database Provider Factory]

C --&gt; F[ThreadLocal Storage]
D --&gt; G[MySQL Connection Pool]
D --&gt; H[PostgreSQL Connection Pool]

E --&gt; I[MySQL Provider]
E --&gt; J[PostgreSQL Provider]

I --&gt; K[(MySQL Database)]
J --&gt; L[(PostgreSQL Database)]

B --&gt; M[SPI Registry]
M --&gt; N[Database Provider Interface]
N --&gt; I
N --&gt; J
</code>
</pre>

<p><strong>Interview Insight</strong>: <em>“How would you design a multi-tenant database architecture?”</em></p>
<p>The key is to balance tenant isolation with resource efficiency. Our SDK uses a <strong>database-per-tenant</strong> approach with dynamic datasource switching, which provides strong isolation while maintaining performance through connection pooling.</p>
<h2 id="Tenant-Context-Management"><a href="#Tenant-Context-Management" class="headerlink" title="Tenant Context Management"></a>Tenant Context Management</h2><h3 id="ThreadLocal-Implementation"><a href="#ThreadLocal-Implementation" class="headerlink" title="ThreadLocal Implementation"></a>ThreadLocal Implementation</h3><p>The tenant context is stored using ThreadLocal to ensure thread-safe tenant identification throughout the request lifecycle.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantContext</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; TENANT_ID = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; DATABASE_NAME = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setTenant</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        TENANT_ID.set(tenantId);</span><br><span class="line">        DATABASE_NAME.set(<span class="string">&quot;tenant_&quot;</span> + tenantId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getCurrentTenant</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> TENANT_ID.get();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getCurrentDatabase</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DATABASE_NAME.get();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span> &#123;</span><br><span class="line">        TENANT_ID.remove();</span><br><span class="line">        DATABASE_NAME.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Tenant-Context-Interceptor"><a href="#Tenant-Context-Interceptor" class="headerlink" title="Tenant Context Interceptor"></a>Tenant Context Interceptor</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantContextInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, </span></span><br><span class="line"><span class="params">                           HttpServletResponse response, </span></span><br><span class="line"><span class="params">                           Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> extractTenantId(request);</span><br><span class="line">        <span class="keyword">if</span> (tenantId != <span class="literal">null</span>) &#123;</span><br><span class="line">            TenantContext.setTenant(tenantId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, </span></span><br><span class="line"><span class="params">                              HttpServletResponse response, </span></span><br><span class="line"><span class="params">                              Object handler, Exception ex)</span> &#123;</span><br><span class="line">        TenantContext.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">extractTenantId</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="comment">// Extract from header, JWT token, or subdomain</span></span><br><span class="line">        <span class="keyword">return</span> request.getHeader(<span class="string">&quot;X-Tenant-ID&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“Why use ThreadLocal for tenant context?”</em></p>
<p>ThreadLocal ensures that each request thread maintains its own tenant context without interference from other concurrent requests. This is crucial in multi-threaded web applications where multiple tenants’ requests are processed simultaneously.</p>
<h2 id="Connection-Pool-Management"><a href="#Connection-Pool-Management" class="headerlink" title="Connection Pool Management"></a>Connection Pool Management</h2><h3 id="Dynamic-DataSource-Configuration"><a href="#Dynamic-DataSource-Configuration" class="headerlink" title="Dynamic DataSource Configuration"></a>Dynamic DataSource Configuration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiTenantDataSourceConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">multiTenantDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MultiTenantDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MultiTenantDataSource</span>();</span><br><span class="line">        dataSource.setDefaultTargetDataSource(createDefaultDataSource());</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ConnectionPoolManager <span class="title function_">connectionPoolManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConnectionPoolManager</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Connection-Pool-Manager-Implementation"><a href="#Connection-Pool-Manager-Implementation" class="headerlink" title="Connection Pool Manager Implementation"></a>Connection Pool Manager Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConnectionPoolManager</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, HikariDataSource&gt; dataSources = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DatabaseProviderFactory providerFactory;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ConnectionPoolManager</span><span class="params">(DatabaseProviderFactory providerFactory)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.providerFactory = providerFactory;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">getDataSource</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> dataSources.computeIfAbsent(tenantId, <span class="built_in">this</span>::createDataSource);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> HikariDataSource <span class="title function_">createDataSource</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="type">TenantConfig</span> <span class="variable">config</span> <span class="operator">=</span> getTenantConfig(tenantId);</span><br><span class="line">        <span class="type">DatabaseProvider</span> <span class="variable">provider</span> <span class="operator">=</span> providerFactory.getProvider(config.getDatabaseType());</span><br><span class="line">        </span><br><span class="line">        <span class="type">HikariConfig</span> <span class="variable">hikariConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HikariConfig</span>();</span><br><span class="line">        hikariConfig.setJdbcUrl(provider.buildJdbcUrl(config));</span><br><span class="line">        hikariConfig.setUsername(config.getUsername());</span><br><span class="line">        hikariConfig.setPassword(config.getPassword());</span><br><span class="line">        hikariConfig.setMaximumPoolSize(config.getMaxPoolSize());</span><br><span class="line">        hikariConfig.setMinimumIdle(config.getMinIdle());</span><br><span class="line">        hikariConfig.setConnectionTimeout(config.getConnectionTimeout());</span><br><span class="line">        hikariConfig.setIdleTimeout(config.getIdleTimeout());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HikariDataSource</span>(hikariConfig);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">closeTenantDataSource</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="type">HikariDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> dataSources.remove(tenantId);</span><br><span class="line">        <span class="keyword">if</span> (dataSource != <span class="literal">null</span>) &#123;</span><br><span class="line">            dataSource.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“How do you handle connection pool sizing for multiple tenants?”</em></p>
<p>We use adaptive pool sizing based on tenant usage patterns. Each tenant gets a dedicated connection pool with configurable min&#x2F;max connections. Monitor pool metrics and adjust dynamically based on tenant activity.</p>
<h2 id="Database-Provider-Implementation-via-SPI"><a href="#Database-Provider-Implementation-via-SPI" class="headerlink" title="Database Provider Implementation via SPI"></a>Database Provider Implementation via SPI</h2><h3 id="Service-Provider-Interface"><a href="#Service-Provider-Interface" class="headerlink" title="Service Provider Interface"></a>Service Provider Interface</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DatabaseProvider</span> &#123;</span><br><span class="line">    String <span class="title function_">getProviderName</span><span class="params">()</span>;</span><br><span class="line">    String <span class="title function_">buildJdbcUrl</span><span class="params">(TenantConfig config)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createTenantDatabase</span><span class="params">(TenantConfig config)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createTenantTables</span><span class="params">(String tenantId, List&lt;String&gt; tableSchemas)</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">supportsBatch</span><span class="params">()</span>;</span><br><span class="line">    String <span class="title function_">getDriverClassName</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="MySQL-Provider-Implementation"><a href="#MySQL-Provider-Implementation" class="headerlink" title="MySQL Provider Implementation"></a>MySQL Provider Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySQLDatabaseProvider</span> <span class="keyword">implements</span> <span class="title class_">DatabaseProvider</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getProviderName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;mysql&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">buildJdbcUrl</span><span class="params">(TenantConfig config)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;jdbc:mysql://%s:%d/%s?useSSL=true&amp;serverTimezone=UTC&quot;</span>,</span><br><span class="line">                config.getHost(), config.getPort(), config.getDatabaseName());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createTenantDatabase</span><span class="params">(TenantConfig config)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> getAdminConnection(config)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;CREATE DATABASE IF NOT EXISTS &quot;</span> + config.getDatabaseName() + </span><br><span class="line">                        <span class="string">&quot; CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci&quot;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> (<span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> connection.createStatement()) &#123;</span><br><span class="line">                stmt.execute(sql);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DatabaseException</span>(<span class="string">&quot;Failed to create MySQL database for tenant: &quot;</span> + </span><br><span class="line">                                      config.getTenantId(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createTenantTables</span><span class="params">(String tenantId, List&lt;String&gt; tableSchemas)</span> &#123;</span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> connectionPoolManager.getDataSource(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection()) &#123;</span><br><span class="line">            connection.setAutoCommit(<span class="literal">false</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (String schema : tableSchemas) &#123;</span><br><span class="line">                <span class="keyword">try</span> (<span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> connection.createStatement()) &#123;</span><br><span class="line">                    stmt.execute(schema);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            connection.commit();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DatabaseException</span>(<span class="string">&quot;Failed to create tables for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDriverClassName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PostgreSQL-Provider-Implementation"><a href="#PostgreSQL-Provider-Implementation" class="headerlink" title="PostgreSQL Provider Implementation"></a>PostgreSQL Provider Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PostgreSQLDatabaseProvider</span> <span class="keyword">implements</span> <span class="title class_">DatabaseProvider</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getProviderName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;postgresql&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">buildJdbcUrl</span><span class="params">(TenantConfig config)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;jdbc:postgresql://%s:%d/%s&quot;</span>,</span><br><span class="line">                config.getHost(), config.getPort(), config.getDatabaseName());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createTenantDatabase</span><span class="params">(TenantConfig config)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> getAdminConnection(config)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;CREATE DATABASE &quot;</span> + config.getDatabaseName() + </span><br><span class="line">                        <span class="string">&quot; WITH ENCODING &#x27;UTF8&#x27; LC_COLLATE=&#x27;en_US.UTF-8&#x27; LC_CTYPE=&#x27;en_US.UTF-8&#x27;&quot;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> (<span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> connection.createStatement()) &#123;</span><br><span class="line">                stmt.execute(sql);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DatabaseException</span>(<span class="string">&quot;Failed to create PostgreSQL database for tenant: &quot;</span> + </span><br><span class="line">                                      config.getTenantId(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createTenantTables</span><span class="params">(String tenantId, List&lt;String&gt; tableSchemas)</span> &#123;</span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> connectionPoolManager.getDataSource(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection()) &#123;</span><br><span class="line">            connection.setAutoCommit(<span class="literal">false</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (String schema : tableSchemas) &#123;</span><br><span class="line">                <span class="keyword">try</span> (<span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> connection.createStatement()) &#123;</span><br><span class="line">                    stmt.execute(schema);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            connection.commit();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DatabaseException</span>(<span class="string">&quot;Failed to create tables for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDriverClassName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;org.postgresql.Driver&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SPI-Registry-and-Factory"><a href="#SPI-Registry-and-Factory" class="headerlink" title="SPI Registry and Factory"></a>SPI Registry and Factory</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseProviderFactory</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, DatabaseProvider&gt; providers = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initializeProviders</span><span class="params">()</span> &#123;</span><br><span class="line">        ServiceLoader&lt;DatabaseProvider&gt; serviceLoader = ServiceLoader.load(DatabaseProvider.class);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (DatabaseProvider provider : serviceLoader) &#123;</span><br><span class="line">            providers.put(provider.getProviderName(), provider);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> DatabaseProvider <span class="title function_">getProvider</span><span class="params">(String providerName)</span> &#123;</span><br><span class="line">        <span class="type">DatabaseProvider</span> <span class="variable">provider</span> <span class="operator">=</span> providers.get(providerName.toLowerCase());</span><br><span class="line">        <span class="keyword">if</span> (provider == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedDatabaseException</span>(<span class="string">&quot;Database provider not found: &quot;</span> + providerName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> provider;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Set&lt;String&gt; <span class="title function_">getSupportedProviders</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> providers.keySet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“Why use SPI pattern for database providers?”</em></p>
<p>SPI (Service Provider Interface) enables loose coupling and extensibility. New database providers can be added without modifying existing code, following the Open&#x2F;Closed Principle. It also allows for plugin-based architecture where providers can be loaded dynamically.</p>
<h2 id="Multi-Tenant-Database-Operations"><a href="#Multi-Tenant-Database-Operations" class="headerlink" title="Multi-Tenant Database Operations"></a>Multi-Tenant Database Operations</h2><h3 id="Core-SDK-Interface"><a href="#Core-SDK-Interface" class="headerlink" title="Core SDK Interface"></a>Core SDK Interface</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MultiTenantDatabaseSDK</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createTenant</span><span class="params">(String tenantId, TenantConfig config)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deleteTenant</span><span class="params">(String tenantId)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">executeSql</span><span class="params">(String sql, Object... params)</span>;</span><br><span class="line">    &lt;T&gt; List&lt;T&gt; <span class="title function_">query</span><span class="params">(String sql, RowMapper&lt;T&gt; rowMapper, Object... params)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">executeBatch</span><span class="params">(List&lt;String&gt; sqlStatements)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">executeTransaction</span><span class="params">(TransactionCallback callback)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SDK-Implementation"><a href="#SDK-Implementation" class="headerlink" title="SDK Implementation"></a>SDK Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiTenantDatabaseSDKImpl</span> <span class="keyword">implements</span> <span class="title class_">MultiTenantDatabaseSDK</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConnectionPoolManager connectionPoolManager;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DatabaseProviderFactory providerFactory;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TenantConfigRepository tenantConfigRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createTenant</span><span class="params">(String tenantId, TenantConfig config)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Create database</span></span><br><span class="line">            <span class="type">DatabaseProvider</span> <span class="variable">provider</span> <span class="operator">=</span> providerFactory.getProvider(config.getDatabaseType());</span><br><span class="line">            provider.createTenantDatabase(config);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Create tables</span></span><br><span class="line">            List&lt;String&gt; tableSchemas = loadTableSchemas();</span><br><span class="line">            provider.createTenantTables(tenantId, tableSchemas);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Save tenant configuration</span></span><br><span class="line">            tenantConfigRepository.save(config);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Initialize connection pool</span></span><br><span class="line">            connectionPoolManager.getDataSource(tenantId);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TenantCreationException</span>(<span class="string">&quot;Failed to create tenant: &quot;</span> + tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeSql</span><span class="params">(String sql, Object... params)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> TenantContext.getCurrentTenant();</span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> connectionPoolManager.getDataSource(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection();</span><br><span class="line">             <span class="type">PreparedStatement</span> <span class="variable">stmt</span> <span class="operator">=</span> connection.prepareStatement(sql)) &#123;</span><br><span class="line">            </span><br><span class="line">            setParameters(stmt, params);</span><br><span class="line">            stmt.execute();</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DatabaseException</span>(<span class="string">&quot;Failed to execute SQL for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; List&lt;T&gt; <span class="title function_">query</span><span class="params">(String sql, RowMapper&lt;T&gt; rowMapper, Object... params)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> TenantContext.getCurrentTenant();</span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> connectionPoolManager.getDataSource(tenantId);</span><br><span class="line">        </span><br><span class="line">        List&lt;T&gt; results = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection();</span><br><span class="line">             <span class="type">PreparedStatement</span> <span class="variable">stmt</span> <span class="operator">=</span> connection.prepareStatement(sql)) &#123;</span><br><span class="line">            </span><br><span class="line">            setParameters(stmt, params);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> (<span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> stmt.executeQuery()) &#123;</span><br><span class="line">                <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">                    results.add(rowMapper.mapRow(rs));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DatabaseException</span>(<span class="string">&quot;Failed to query for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> results;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeTransaction</span><span class="params">(TransactionCallback callback)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> TenantContext.getCurrentTenant();</span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> connectionPoolManager.getDataSource(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection()) &#123;</span><br><span class="line">            connection.setAutoCommit(<span class="literal">false</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                callback.doInTransaction(connection);</span><br><span class="line">                connection.commit();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                connection.rollback();</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DatabaseException</span>(<span class="string">&quot;Transaction failed for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Production-Use-Cases-and-Examples"><a href="#Production-Use-Cases-and-Examples" class="headerlink" title="Production Use Cases and Examples"></a>Production Use Cases and Examples</h2><h3 id="Use-Case-1-SaaS-CRM-System"><a href="#Use-Case-1-SaaS-CRM-System" class="headerlink" title="Use Case 1: SaaS CRM System"></a>Use Case 1: SaaS CRM System</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/customers&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MultiTenantDatabaseSDK databaseSDK;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Customer&gt; <span class="title function_">getCustomers</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> databaseSDK.query(</span><br><span class="line">            <span class="string">&quot;SELECT * FROM customers WHERE active = ?&quot;</span>,</span><br><span class="line">            (rs) -&gt; <span class="keyword">new</span> <span class="title class_">Customer</span>(</span><br><span class="line">                rs.getLong(<span class="string">&quot;id&quot;</span>),</span><br><span class="line">                rs.getString(<span class="string">&quot;name&quot;</span>),</span><br><span class="line">                rs.getString(<span class="string">&quot;email&quot;</span>)</span><br><span class="line">            ),</span><br><span class="line">            <span class="literal">true</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createCustomer</span><span class="params">(<span class="meta">@RequestBody</span> Customer customer)</span> &#123;</span><br><span class="line">        databaseSDK.executeSql(</span><br><span class="line">            <span class="string">&quot;INSERT INTO customers (name, email, created_at) VALUES (?, ?, ?)&quot;</span>,</span><br><span class="line">            customer.getName(),</span><br><span class="line">            customer.getEmail(),</span><br><span class="line">            Timestamp.from(Instant.now())</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Use-Case-2-Tenant-Onboarding-Process"><a href="#Use-Case-2-Tenant-Onboarding-Process" class="headerlink" title="Use Case 2: Tenant Onboarding Process"></a>Use Case 2: Tenant Onboarding Process</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantOnboardingService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MultiTenantDatabaseSDK databaseSDK;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onboardNewTenant</span><span class="params">(TenantRegistration registration)</span> &#123;</span><br><span class="line">        <span class="type">TenantConfig</span> <span class="variable">config</span> <span class="operator">=</span> TenantConfig.builder()</span><br><span class="line">            .tenantId(registration.getTenantId())</span><br><span class="line">            .databaseType(<span class="string">&quot;mysql&quot;</span>)</span><br><span class="line">            .host(<span class="string">&quot;localhost&quot;</span>)</span><br><span class="line">            .port(<span class="number">3306</span>)</span><br><span class="line">            .databaseName(<span class="string">&quot;tenant_&quot;</span> + registration.getTenantId())</span><br><span class="line">            .username(<span class="string">&quot;tenant_user&quot;</span>)</span><br><span class="line">            .password(generateSecurePassword())</span><br><span class="line">            .maxPoolSize(<span class="number">10</span>)</span><br><span class="line">            .minIdle(<span class="number">2</span>)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Create tenant database and tables</span></span><br><span class="line">            databaseSDK.createTenant(registration.getTenantId(), config);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Insert initial data</span></span><br><span class="line">            insertInitialData(registration);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Send welcome email</span></span><br><span class="line">            sendWelcomeEmail(registration);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// Rollback tenant creation</span></span><br><span class="line">            databaseSDK.deleteTenant(registration.getTenantId());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TenantOnboardingException</span>(<span class="string">&quot;Failed to onboard tenant&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Use-Case-3-Data-Migration-Between-Tenants"><a href="#Use-Case-3-Data-Migration-Between-Tenants" class="headerlink" title="Use Case 3: Data Migration Between Tenants"></a>Use Case 3: Data Migration Between Tenants</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantDataMigrationService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MultiTenantDatabaseSDK databaseSDK;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">migrateTenantData</span><span class="params">(String sourceTenantId, String targetTenantId)</span> &#123;</span><br><span class="line">        <span class="comment">// Export data from source tenant</span></span><br><span class="line">        TenantContext.setTenant(sourceTenantId);</span><br><span class="line">        List&lt;Customer&gt; customers = databaseSDK.query(</span><br><span class="line">            <span class="string">&quot;SELECT * FROM customers&quot;</span>,</span><br><span class="line">            <span class="built_in">this</span>::mapCustomer</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Import data to target tenant</span></span><br><span class="line">        TenantContext.setTenant(targetTenantId);</span><br><span class="line">        databaseSDK.executeTransaction(connection -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (Customer customer : customers) &#123;</span><br><span class="line">                <span class="type">PreparedStatement</span> <span class="variable">stmt</span> <span class="operator">=</span> connection.prepareStatement(</span><br><span class="line">                    <span class="string">&quot;INSERT INTO customers (name, email, created_at) VALUES (?, ?, ?)&quot;</span></span><br><span class="line">                );</span><br><span class="line">                stmt.setString(<span class="number">1</span>, customer.getName());</span><br><span class="line">                stmt.setString(<span class="number">2</span>, customer.getEmail());</span><br><span class="line">                stmt.setTimestamp(<span class="number">3</span>, customer.getCreatedAt());</span><br><span class="line">                stmt.executeUpdate();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Runtime-Datasource-Switching"><a href="#Runtime-Datasource-Switching" class="headerlink" title="Runtime Datasource Switching"></a>Runtime Datasource Switching</h2><h3 id="Dynamic-DataSource-Routing"><a href="#Dynamic-DataSource-Routing" class="headerlink" title="Dynamic DataSource Routing"></a>Dynamic DataSource Routing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiTenantDataSource</span> <span class="keyword">extends</span> <span class="title class_">AbstractRoutingDataSource</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">determineCurrentLookupKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> TenantContext.getCurrentTenant();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> DataSource <span class="title function_">determineTargetDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> TenantContext.getCurrentTenant();</span><br><span class="line">        <span class="keyword">if</span> (tenantId == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> getDefaultDataSource();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> connectionPoolManager.getDataSource(tenantId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Request-Flow-Diagram"><a href="#Request-Flow-Diagram" class="headerlink" title="Request Flow Diagram"></a>Request Flow Diagram</h3><pre>
<code class="mermaid">
sequenceDiagram
participant Client
participant API Gateway
participant SaaS Service
participant SDK
participant Database

Client-&gt;&gt;API Gateway: Request with tenant info
API Gateway-&gt;&gt;SaaS Service: Forward request
SaaS Service-&gt;&gt;SDK: Set tenant context
SDK-&gt;&gt;SDK: Store in ThreadLocal
SaaS Service-&gt;&gt;SDK: Execute database operation
SDK-&gt;&gt;SDK: Determine datasource
SDK-&gt;&gt;Database: Execute query
Database-&gt;&gt;SDK: Return results
SDK-&gt;&gt;SaaS Service: Return results
SaaS Service-&gt;&gt;Client: Return response
</code>
</pre>

<p><strong>Interview Insight</strong>: <em>“How do you handle database connection switching at runtime?”</em></p>
<p>We use Spring’s AbstractRoutingDataSource combined with ThreadLocal tenant context. The routing happens transparently - when a database operation is requested, the SDK determines the appropriate datasource based on the current tenant context stored in ThreadLocal.</p>
<h2 id="Performance-Optimization-Strategies"><a href="#Performance-Optimization-Strategies" class="headerlink" title="Performance Optimization Strategies"></a>Performance Optimization Strategies</h2><h3 id="Connection-Pool-Tuning"><a href="#Connection-Pool-Tuning" class="headerlink" title="Connection Pool Tuning"></a>Connection Pool Tuning</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;multitenant.pool&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConnectionPoolConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">maxPoolSize</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">minIdle</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">connectionTimeout</span> <span class="operator">=</span> <span class="number">30000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">idleTimeout</span> <span class="operator">=</span> <span class="number">600000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">maxLifetime</span> <span class="operator">=</span> <span class="number">1800000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">leakDetectionThreshold</span> <span class="operator">=</span> <span class="number">60000</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Getters and setters</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Connection-Pool-Monitoring"><a href="#Connection-Pool-Monitoring" class="headerlink" title="Connection Pool Monitoring"></a>Connection Pool Monitoring</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConnectionPoolMonitor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConnectionPoolManager poolManager;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 30000)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">monitorConnectionPools</span><span class="params">()</span> &#123;</span><br><span class="line">        poolManager.getAllDataSources().forEach((tenantId, dataSource) -&gt; &#123;</span><br><span class="line">            <span class="type">HikariPoolMXBean</span> <span class="variable">poolMXBean</span> <span class="operator">=</span> dataSource.getHikariPoolMXBean();</span><br><span class="line">            </span><br><span class="line">            Gauge.builder(<span class="string">&quot;connection.pool.active&quot;</span>)</span><br><span class="line">                .tag(<span class="string">&quot;tenant&quot;</span>, tenantId)</span><br><span class="line">                .register(meterRegistry, poolMXBean, HikariPoolMXBean::getActiveConnections);</span><br><span class="line">                </span><br><span class="line">            Gauge.builder(<span class="string">&quot;connection.pool.idle&quot;</span>)</span><br><span class="line">                .tag(<span class="string">&quot;tenant&quot;</span>, tenantId)</span><br><span class="line">                .register(meterRegistry, poolMXBean, HikariPoolMXBean::getIdleConnections);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Caching-Strategy"><a href="#Caching-Strategy" class="headerlink" title="Caching Strategy"></a>Caching Strategy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantConfigCacheService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LoadingCache&lt;String, TenantConfig&gt; configCache;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TenantConfigCacheService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.configCache = Caffeine.newBuilder()</span><br><span class="line">            .maximumSize(<span class="number">1000</span>)</span><br><span class="line">            .expireAfterWrite(<span class="number">30</span>, TimeUnit.MINUTES)</span><br><span class="line">            .build(<span class="built_in">this</span>::loadTenantConfig);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> TenantConfig <span class="title function_">getTenantConfig</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> configCache.get(tenantId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> TenantConfig <span class="title function_">loadTenantConfig</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> tenantConfigRepository.findByTenantId(tenantId)</span><br><span class="line">            .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">TenantNotFoundException</span>(<span class="string">&quot;Tenant not found: &quot;</span> + tenantId));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Security-and-Compliance"><a href="#Security-and-Compliance" class="headerlink" title="Security and Compliance"></a>Security and Compliance</h2><h3 id="Tenant-Isolation-Security"><a href="#Tenant-Isolation-Security" class="headerlink" title="Tenant Isolation Security"></a>Tenant Isolation Security</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantSecurityValidator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">validateTenantAccess</span><span class="params">(String requestedTenantId, String authenticatedTenantId)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!requestedTenantId.equals(authenticatedTenantId)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TenantAccessDeniedException</span>(<span class="string">&quot;Cross-tenant access denied&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">validateSqlInjection</span><span class="params">(String sql)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (containsSqlInjectionPatterns(sql)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;Potential SQL injection detected&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">containsSqlInjectionPatterns</span><span class="params">(String sql)</span> &#123;</span><br><span class="line">        String[] patterns = &#123;<span class="string">&quot;&#x27;;&quot;</span>, <span class="string">&quot;DROP&quot;</span>, <span class="string">&quot;DELETE&quot;</span>, <span class="string">&quot;UPDATE&quot;</span>, <span class="string">&quot;INSERT&quot;</span>, <span class="string">&quot;UNION&quot;</span>&#125;;</span><br><span class="line">        <span class="type">String</span> <span class="variable">upperSql</span> <span class="operator">=</span> sql.toUpperCase();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> Arrays.stream(patterns)</span><br><span class="line">            .anyMatch(upperSql::contains);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Encryption-and-Data-Protection"><a href="#Encryption-and-Data-Protection" class="headerlink" title="Encryption and Data Protection"></a>Encryption and Data Protection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataEncryptionService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AESUtil aesUtil;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">encryptSensitiveData</span><span class="params">(String data, String tenantId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantKey</span> <span class="operator">=</span> generateTenantSpecificKey(tenantId);</span><br><span class="line">        <span class="keyword">return</span> aesUtil.encrypt(data, tenantKey);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">decryptSensitiveData</span><span class="params">(String encryptedData, String tenantId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantKey</span> <span class="operator">=</span> generateTenantSpecificKey(tenantId);</span><br><span class="line">        <span class="keyword">return</span> aesUtil.decrypt(encryptedData, tenantKey);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">generateTenantSpecificKey</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="comment">// Generate tenant-specific encryption key</span></span><br><span class="line">        <span class="keyword">return</span> keyDerivationService.deriveKey(tenantId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Error-Handling-and-Resilience"><a href="#Error-Handling-and-Resilience" class="headerlink" title="Error Handling and Resilience"></a>Error Handling and Resilience</h2><h3 id="Exception-Hierarchy"><a href="#Exception-Hierarchy" class="headerlink" title="Exception Hierarchy"></a>Exception Hierarchy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseException</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DatabaseException</span><span class="params">(String message, Throwable cause)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message, cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantNotFoundException</span> <span class="keyword">extends</span> <span class="title class_">DatabaseException</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TenantNotFoundException</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantCreationException</span> <span class="keyword">extends</span> <span class="title class_">DatabaseException</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TenantCreationException</span><span class="params">(String message, Throwable cause)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message, cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Retry-Mechanism"><a href="#Retry-Mechanism" class="headerlink" title="Retry Mechanism"></a>Retry Mechanism</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseRetryService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RetryTemplate retryTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DatabaseRetryService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.retryTemplate = RetryTemplate.builder()</span><br><span class="line">            .maxAttempts(<span class="number">3</span>)</span><br><span class="line">            .exponentialBackoff(<span class="number">1000</span>, <span class="number">2</span>, <span class="number">10000</span>)</span><br><span class="line">            .retryOn(SQLException.class, DataAccessException.class)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">executeWithRetry</span><span class="params">(Supplier&lt;T&gt; operation)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> retryTemplate.execute(context -&gt; operation.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Circuit-Breaker-Implementation"><a href="#Circuit-Breaker-Implementation" class="headerlink" title="Circuit Breaker Implementation"></a>Circuit Breaker Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseCircuitBreaker</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CircuitBreaker circuitBreaker;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DatabaseCircuitBreaker</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.circuitBreaker = CircuitBreaker.ofDefaults(<span class="string">&quot;database&quot;</span>);</span><br><span class="line">        circuitBreaker.getEventPublisher()</span><br><span class="line">            .onStateTransition(event -&gt; </span><br><span class="line">                log.info(<span class="string">&quot;Circuit breaker state transition: &#123;&#125;&quot;</span>, event));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">executeWithCircuitBreaker</span><span class="params">(Supplier&lt;T&gt; operation)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> circuitBreaker.executeSupplier(operation);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Testing-Strategies"><a href="#Testing-Strategies" class="headerlink" title="Testing Strategies"></a>Testing Strategies</h2><h3 id="Unit-Testing"><a href="#Unit-Testing" class="headerlink" title="Unit Testing"></a>Unit Testing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExtendWith(MockitoExtension.class)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MultiTenantDatabaseSDKTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> ConnectionPoolManager connectionPoolManager;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> DatabaseProviderFactory providerFactory;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@InjectMocks</span></span><br><span class="line">    <span class="keyword">private</span> MultiTenantDatabaseSDKImpl sdk;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldExecuteSqlForCurrentTenant</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Given</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> <span class="string">&quot;tenant-123&quot;</span>;</span><br><span class="line">        TenantContext.setTenant(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">mockDataSource</span> <span class="operator">=</span> mock(DataSource.class);</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">mockConnection</span> <span class="operator">=</span> mock(Connection.class);</span><br><span class="line">        <span class="type">PreparedStatement</span> <span class="variable">mockStatement</span> <span class="operator">=</span> mock(PreparedStatement.class);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">when</span>(connectionPoolManager.getDataSource(tenantId)).thenReturn(mockDataSource);</span><br><span class="line">        <span class="keyword">when</span>(mockDataSource.getConnection()).thenReturn(mockConnection);</span><br><span class="line">        <span class="keyword">when</span>(mockConnection.prepareStatement(anyString())).thenReturn(mockStatement);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When</span></span><br><span class="line">        sdk.executeSql(<span class="string">&quot;INSERT INTO users (name) VALUES (?)&quot;</span>, <span class="string">&quot;John&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Then</span></span><br><span class="line">        verify(mockStatement).setString(<span class="number">1</span>, <span class="string">&quot;John&quot;</span>);</span><br><span class="line">        verify(mockStatement).execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Integration-Testing"><a href="#Integration-Testing" class="headerlink" title="Integration Testing"></a>Integration Testing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@TestPropertySource(properties = &#123;</span></span><br><span class="line"><span class="meta">    &quot;spring.datasource.url=jdbc:h2:mem:testdb&quot;,</span></span><br><span class="line"><span class="meta">    &quot;spring.jpa.hibernate.ddl-auto=create-drop&quot;</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MultiTenantIntegrationTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MultiTenantDatabaseSDK sdk;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldCreateTenantAndExecuteOperations</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Given</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> <span class="string">&quot;test-tenant&quot;</span>;</span><br><span class="line">        <span class="type">TenantConfig</span> <span class="variable">config</span> <span class="operator">=</span> createTestTenantConfig(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When</span></span><br><span class="line">        sdk.createTenant(tenantId, config);</span><br><span class="line">        </span><br><span class="line">        TenantContext.setTenant(tenantId);</span><br><span class="line">        sdk.executeSql(<span class="string">&quot;INSERT INTO users (name, email) VALUES (?, ?)&quot;</span>, <span class="string">&quot;John&quot;</span>, <span class="string">&quot;john@example.com&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        List&lt;User&gt; users = sdk.query(<span class="string">&quot;SELECT * FROM users&quot;</span>, <span class="built_in">this</span>::mapUser);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Then</span></span><br><span class="line">        assertThat(users).hasSize(<span class="number">1</span>);</span><br><span class="line">        assertThat(users.get(<span class="number">0</span>).getName()).isEqualTo(<span class="string">&quot;John&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Monitoring-and-Observability"><a href="#Monitoring-and-Observability" class="headerlink" title="Monitoring and Observability"></a>Monitoring and Observability</h2><h3 id="Metrics-Collection"><a href="#Metrics-Collection" class="headerlink" title="Metrics Collection"></a>Metrics Collection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiTenantMetrics</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter tenantCreationCounter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Timer databaseOperationTimer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Gauge activeTenantGauge;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MultiTenantMetrics</span><span class="params">(MeterRegistry meterRegistry)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.tenantCreationCounter = Counter.builder(<span class="string">&quot;tenant.creation.count&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.databaseOperationTimer = Timer.builder(<span class="string">&quot;database.operation.time&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.activeTenantGauge = Gauge.builder(<span class="string">&quot;tenant.active.count&quot;</span>)</span><br><span class="line">            .register(meterRegistry, <span class="built_in">this</span>, MultiTenantMetrics::getActiveTenantCount);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordTenantCreation</span><span class="params">()</span> &#123;</span><br><span class="line">        tenantCreationCounter.increment();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordDatabaseOperation</span><span class="params">(Duration duration)</span> &#123;</span><br><span class="line">        databaseOperationTimer.record(duration);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> <span class="title function_">getActiveTenantCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> connectionPoolManager.getActiveTenantCount();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Health-Checks"><a href="#Health-Checks" class="headerlink" title="Health Checks"></a>Health Checks</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiTenantHealthIndicator</span> <span class="keyword">implements</span> <span class="title class_">HealthIndicator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConnectionPoolManager connectionPoolManager;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Health <span class="title function_">health</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">activeTenants</span> <span class="operator">=</span> connectionPoolManager.getActiveTenantCount();</span><br><span class="line">            <span class="type">int</span> <span class="variable">totalConnections</span> <span class="operator">=</span> connectionPoolManager.getTotalActiveConnections();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> Health.up()</span><br><span class="line">                .withDetail(<span class="string">&quot;activeTenants&quot;</span>, activeTenants)</span><br><span class="line">                .withDetail(<span class="string">&quot;totalConnections&quot;</span>, totalConnections)</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> Health.down()</span><br><span class="line">                .withException(e)</span><br><span class="line">                .build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Deployment-and-Configuration"><a href="#Deployment-and-Configuration" class="headerlink" title="Deployment and Configuration"></a>Deployment and Configuration</h2><h3 id="Docker-Configuration"><a href="#Docker-Configuration" class="headerlink" title="Docker Configuration"></a>Docker Configuration</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">11</span>-jre-slim</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> target/multi-tenant-sdk.jar app.jar</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> JAVA_OPTS=<span class="string">&quot;-Xmx2g -Xms1g&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> HIKARI_MAX_POOL_SIZE=<span class="number">20</span></span><br><span class="line"><span class="keyword">ENV</span> HIKARI_MIN_IDLE=<span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;java <span class="variable">$JAVA_OPTS</span> -jar /app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h3 id="Kubernetes-Deployment"><a href="#Kubernetes-Deployment" class="headerlink" title="Kubernetes Deployment"></a>Kubernetes Deployment</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">multi-tenant-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">multi-tenant-app</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">multi-tenant-app</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">multi-tenant-sdk:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_PROFILES_ACTIVE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;production&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DATABASE_MAX_POOL_SIZE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;20&quot;</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;2Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;1000m&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Common-Interview-Questions-and-Answers"><a href="#Common-Interview-Questions-and-Answers" class="headerlink" title="Common Interview Questions and Answers"></a>Common Interview Questions and Answers</h2><p><strong>Q: “How do you handle tenant data isolation?”</strong></p>
<p>A: We implement database-per-tenant isolation using dynamic datasource routing. Each tenant has its own database and connection pool, ensuring complete data isolation. The SDK uses ThreadLocal to maintain tenant context throughout the request lifecycle.</p>
<p><strong>Q: “What happens if a tenant’s database becomes unavailable?”</strong></p>
<p>A: We implement circuit breaker pattern and retry mechanisms. If a tenant’s database is unavailable, the circuit breaker opens, preventing cascading failures. We also have health checks that monitor each tenant’s database connectivity.</p>
<p><strong>Q: “How do you handle database migrations across multiple tenants?”</strong></p>
<p>A: We use a versioned migration system where each tenant’s database schema version is tracked. Migrations are applied tenant by tenant, with rollback capabilities. Critical migrations are tested in staging environments first.</p>
<p><strong>Q: “How do you optimize connection pool usage?”</strong></p>
<p>A: We use adaptive connection pool sizing based on tenant activity. Inactive tenants have smaller pools, while active tenants get more connections. We also implement connection</p>
<h2 id="Advanced-Features-and-Extensions"><a href="#Advanced-Features-and-Extensions" class="headerlink" title="Advanced Features and Extensions"></a>Advanced Features and Extensions</h2><h3 id="Tenant-Database-Sharding"><a href="#Tenant-Database-Sharding" class="headerlink" title="Tenant Database Sharding"></a>Tenant Database Sharding</h3><p>For high-scale scenarios, the SDK supports database sharding across multiple database servers:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantShardingManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ShardConfig&gt; shards;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConsistentHashing&lt;String&gt; hashRing;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TenantShardingManager</span><span class="params">(List&lt;ShardConfig&gt; shards)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.shards = shards;</span><br><span class="line">        <span class="built_in">this</span>.hashRing = <span class="keyword">new</span> <span class="title class_">ConsistentHashing</span>&lt;&gt;(</span><br><span class="line">            shards.stream().map(ShardConfig::getShardId).collect(Collectors.toList())</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ShardConfig <span class="title function_">getShardForTenant</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">shardId</span> <span class="operator">=</span> hashRing.getNode(tenantId);</span><br><span class="line">        <span class="keyword">return</span> shards.stream()</span><br><span class="line">            .filter(shard -&gt; shard.getShardId().equals(shardId))</span><br><span class="line">            .findFirst()</span><br><span class="line">            .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">ShardNotFoundException</span>(<span class="string">&quot;Shard not found for tenant: &quot;</span> + tenantId));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rebalanceShards</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Implement shard rebalancing logic</span></span><br><span class="line">        <span class="keyword">for</span> (ShardConfig shard : shards) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">currentLoad</span> <span class="operator">=</span> calculateShardLoad(shard);</span><br><span class="line">            <span class="keyword">if</span> (currentLoad &gt; shard.getMaxCapacity() * <span class="number">0.8</span>) &#123;</span><br><span class="line">                triggerShardSplit(shard);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Tenant-Migration-and-Backup"><a href="#Tenant-Migration-and-Backup" class="headerlink" title="Tenant Migration and Backup"></a>Tenant Migration and Backup</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantMigrationService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MultiTenantDatabaseSDK databaseSDK;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TenantBackupService backupService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">migrateTenant</span><span class="params">(String tenantId, TenantConfig newConfig)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Create backup before migration</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">backupId</span> <span class="operator">=</span> backupService.createBackup(tenantId);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Export tenant data</span></span><br><span class="line">            <span class="type">TenantData</span> <span class="variable">exportedData</span> <span class="operator">=</span> exportTenantData(tenantId);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Create new tenant database</span></span><br><span class="line">            databaseSDK.createTenant(tenantId + <span class="string">&quot;_new&quot;</span>, newConfig);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Import data to new database</span></span><br><span class="line">            importTenantData(tenantId + <span class="string">&quot;_new&quot;</span>, exportedData);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Validate migration</span></span><br><span class="line">            <span class="keyword">if</span> (validateMigration(tenantId, tenantId + <span class="string">&quot;_new&quot;</span>)) &#123;</span><br><span class="line">                <span class="comment">// Switch to new database</span></span><br><span class="line">                switchTenantDatabase(tenantId, newConfig);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Cleanup old database</span></span><br><span class="line">                databaseSDK.deleteTenant(tenantId + <span class="string">&quot;_old&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Rollback</span></span><br><span class="line">                restoreFromBackup(tenantId, backupId);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TenantMigrationException</span>(<span class="string">&quot;Migration failed for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> TenantData <span class="title function_">exportTenantData</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        TenantContext.setTenant(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="type">TenantData</span> <span class="variable">data</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TenantData</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Export all tables</span></span><br><span class="line">        List&lt;String&gt; tables = databaseSDK.query(</span><br><span class="line">            <span class="string">&quot;SELECT table_name FROM information_schema.tables WHERE table_schema = ?&quot;</span>,</span><br><span class="line">            rs -&gt; rs.getString(<span class="string">&quot;table_name&quot;</span>),</span><br><span class="line">            TenantContext.getCurrentDatabase()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String table : tables) &#123;</span><br><span class="line">            List&lt;Map&lt;String, Object&gt;&gt; tableData = databaseSDK.query(</span><br><span class="line">                <span class="string">&quot;SELECT * FROM &quot;</span> + table,</span><br><span class="line">                <span class="built_in">this</span>::mapRowToMap</span><br><span class="line">            );</span><br><span class="line">            data.addTableData(table, tableData);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Read-Replica-Support"><a href="#Read-Replica-Support" class="headerlink" title="Read Replica Support"></a>Read Replica Support</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReadReplicaManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, List&lt;DataSource&gt;&gt; readReplicas = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LoadBalancer loadBalancer;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">getReadDataSource</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        List&lt;DataSource&gt; replicas = readReplicas.get(tenantId);</span><br><span class="line">        <span class="keyword">if</span> (replicas == <span class="literal">null</span> || replicas.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> connectionPoolManager.getDataSource(tenantId); <span class="comment">// Fallback to master</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> loadBalancer.selectDataSource(replicas);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addReadReplica</span><span class="params">(String tenantId, TenantConfig replicaConfig)</span> &#123;</span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">replicaDataSource</span> <span class="operator">=</span> createDataSource(replicaConfig);</span><br><span class="line">        readReplicas.computeIfAbsent(tenantId, k -&gt; <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;()).add(replicaDataSource);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 30000)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">monitorReplicaHealth</span><span class="params">()</span> &#123;</span><br><span class="line">        readReplicas.forEach((tenantId, replicas) -&gt; &#123;</span><br><span class="line">            replicas.removeIf(replica -&gt; !isHealthy(replica));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Multi-Database-Transaction-Support"><a href="#Multi-Database-Transaction-Support" class="headerlink" title="Multi-Database Transaction Support"></a>Multi-Database Transaction Support</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiTenantTransactionManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PlatformTransactionManager transactionManager;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeMultiTenantTransaction</span><span class="params">(List&lt;String&gt; tenantIds, </span></span><br><span class="line"><span class="params">                                            MultiTenantTransactionCallback callback)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">TransactionStatus</span> <span class="variable">status</span> <span class="operator">=</span> transactionManager.getTransaction(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">DefaultTransactionDefinition</span>()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Map&lt;String, Connection&gt; connections = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Get connections for all tenants</span></span><br><span class="line">            <span class="keyword">for</span> (String tenantId : tenantIds) &#123;</span><br><span class="line">                <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> connectionPoolManager.getDataSource(tenantId);</span><br><span class="line">                connections.put(tenantId, dataSource.getConnection());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Execute callback with all connections</span></span><br><span class="line">            callback.doInTransaction(connections);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Commit all transactions</span></span><br><span class="line">            connections.values().forEach(conn -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    conn.commit();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            transactionManager.commit(status);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            transactionManager.rollback(status);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MultiTenantTransactionException</span>(<span class="string">&quot;Multi-tenant transaction failed&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Benchmarking-and-Optimization"><a href="#Performance-Benchmarking-and-Optimization" class="headerlink" title="Performance Benchmarking and Optimization"></a>Performance Benchmarking and Optimization</h2><h3 id="Benchmark-Results"><a href="#Benchmark-Results" class="headerlink" title="Benchmark Results"></a>Benchmark Results</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PerformanceBenchmark</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MultiTenantDatabaseSDK sdk;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">benchmarkOnStartup</span><span class="params">(ApplicationReadyEvent event)</span> &#123;</span><br><span class="line">        runConnectionPoolBenchmark();</span><br><span class="line">        runTenantSwitchingBenchmark();</span><br><span class="line">        runConcurrentAccessBenchmark();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">runConnectionPoolBenchmark</span><span class="params">()</span> &#123;</span><br><span class="line">        Timer.<span class="type">Sample</span> <span class="variable">sample</span> <span class="operator">=</span> Timer.start(meterRegistry);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Test connection acquisition time</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> <span class="string">&quot;tenant-&quot;</span> + (i % <span class="number">10</span>);</span><br><span class="line">            TenantContext.setTenant(tenantId);</span><br><span class="line">            </span><br><span class="line">            sdk.query(<span class="string">&quot;SELECT 1&quot;</span>, rs -&gt; rs.getInt(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        sample.stop(Timer.builder(<span class="string">&quot;benchmark.connection.pool&quot;</span>).register(meterRegistry));</span><br><span class="line">        </span><br><span class="line">        log.info(<span class="string">&quot;Connection pool benchmark: &#123;&#125; ms&quot;</span>, (endTime - startTime) / <span class="number">1_000_000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">runTenantSwitchingBenchmark</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">iterations</span> <span class="operator">=</span> <span class="number">10000</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; iterations; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> <span class="string">&quot;tenant-&quot;</span> + (i % <span class="number">100</span>);</span><br><span class="line">            TenantContext.setTenant(tenantId);</span><br><span class="line">            <span class="comment">// Simulate tenant switching overhead</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        <span class="type">double</span> <span class="variable">avgSwitchTime</span> <span class="operator">=</span> (endTime - startTime) / <span class="number">1_000_000.0</span> / iterations;</span><br><span class="line">        </span><br><span class="line">        log.info(<span class="string">&quot;Average tenant switching time: &#123;&#125; ms&quot;</span>, avgSwitchTime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Performance-Optimization-Recommendations"><a href="#Performance-Optimization-Recommendations" class="headerlink" title="Performance Optimization Recommendations"></a>Performance Optimization Recommendations</h3><pre>
<code class="mermaid">
graph LR
A[Performance Optimization] --&gt; B[Connection Pooling]
A --&gt; C[Caching Strategy]
A --&gt; D[Query Optimization]
A --&gt; E[Resource Management]

B --&gt; B1[HikariCP Configuration]
B --&gt; B2[Pool Size Tuning]
B --&gt; B3[Connection Validation]

C --&gt; C1[Tenant Config Cache]
C --&gt; C2[Query Result Cache]
C --&gt; C3[Schema Cache]

D --&gt; D1[Prepared Statements]
D --&gt; D2[Batch Operations]
D --&gt; D3[Index Optimization]

E --&gt; E1[Memory Management]
E --&gt; E2[Thread Pool Tuning]
E --&gt; E3[GC Optimization]
</code>
</pre>

<h2 id="Security-Best-Practices"><a href="#Security-Best-Practices" class="headerlink" title="Security Best Practices"></a>Security Best Practices</h2><h3 id="Security-Architecture"><a href="#Security-Architecture" class="headerlink" title="Security Architecture"></a>Security Architecture</h3><pre>
<code class="mermaid">
graph TB
A[Client Request] --&gt; B[API Gateway]
B --&gt; C[Authentication Service]
C --&gt; D[Tenant Authorization]
D --&gt; E[Multi-Tenant SDK]
E --&gt; F[Security Validator]
F --&gt; G[Encrypted Connection]
G --&gt; H[Tenant Database]

I[Security Layers]
I --&gt; J[Network Security]
I --&gt; K[Application Security]
I --&gt; L[Database Security]
I --&gt; M[Data Encryption]
</code>
</pre>

<h3 id="Advanced-Security-Features"><a href="#Advanced-Security-Features" class="headerlink" title="Advanced Security Features"></a>Advanced Security Features</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantSecurityEnforcer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TenantPermissionService permissionService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuditLogService auditService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Around(&quot;@annotation(SecureTenantOperation)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">enforceSecurityz</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> TenantContext.getCurrentTenant();</span><br><span class="line">        <span class="type">String</span> <span class="variable">operation</span> <span class="operator">=</span> joinPoint.getSignature().getName();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Validate tenant access</span></span><br><span class="line">        <span class="keyword">if</span> (!permissionService.hasPermission(tenantId, operation)) &#123;</span><br><span class="line">            auditService.logUnauthorizedAccess(tenantId, operation);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TenantAccessDeniedException</span>(<span class="string">&quot;Access denied for operation: &quot;</span> + operation);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Rate limiting</span></span><br><span class="line">        <span class="keyword">if</span> (!rateLimiter.tryAcquire(tenantId)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RateLimitExceededException</span>(<span class="string">&quot;Rate limit exceeded for tenant: &quot;</span> + tenantId);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> joinPoint.proceed();</span><br><span class="line">            auditService.logSuccessfulOperation(tenantId, operation);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            auditService.logFailedOperation(tenantId, operation, e);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Data-Masking-and-Privacy"><a href="#Data-Masking-and-Privacy" class="headerlink" title="Data Masking and Privacy"></a>Data Masking and Privacy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataPrivacyManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, DataMaskingRule&gt; maskingRules;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ResultSet <span class="title function_">maskSensitiveData</span><span class="params">(ResultSet resultSet, String tenantId)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="type">TenantPrivacyConfig</span> <span class="variable">config</span> <span class="operator">=</span> getPrivacyConfig(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> (resultSet.next()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (DataMaskingRule rule : config.getMaskingRules()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">columnName</span> <span class="operator">=</span> rule.getColumnName();</span><br><span class="line">                <span class="type">String</span> <span class="variable">originalValue</span> <span class="operator">=</span> resultSet.getString(columnName);</span><br><span class="line">                <span class="type">String</span> <span class="variable">maskedValue</span> <span class="operator">=</span> applyMasking(originalValue, rule.getMaskingType());</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Update result set with masked value</span></span><br><span class="line">                ((UpdatableResultSet) resultSet).updateString(columnName, maskedValue);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> resultSet;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">applyMasking</span><span class="params">(String value, MaskingType type)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">            <span class="keyword">case</span> EMAIL:</span><br><span class="line">                <span class="keyword">return</span> maskEmail(value);</span><br><span class="line">            <span class="keyword">case</span> PHONE:</span><br><span class="line">                <span class="keyword">return</span> maskPhone(value);</span><br><span class="line">            <span class="keyword">case</span> CREDIT_CARD:</span><br><span class="line">                <span class="keyword">return</span> maskCreditCard(value);</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Disaster-Recovery-and-High-Availability"><a href="#Disaster-Recovery-and-High-Availability" class="headerlink" title="Disaster Recovery and High Availability"></a>Disaster Recovery and High Availability</h2><h3 id="Backup-and-Recovery-Strategy"><a href="#Backup-and-Recovery-Strategy" class="headerlink" title="Backup and Recovery Strategy"></a>Backup and Recovery Strategy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantBackupService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CloudStorageService storageService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DatabaseProvider databaseProvider;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0 0 2 * * *&quot;)</span> <span class="comment">// Daily at 2 AM</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performScheduledBackups</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;String&gt; activeTenants = getActiveTenants();</span><br><span class="line">        </span><br><span class="line">        activeTenants.parallelStream().forEach(tenantId -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">BackupResult</span> <span class="variable">result</span> <span class="operator">=</span> createBackup(tenantId);</span><br><span class="line">                storageService.uploadBackup(result);</span><br><span class="line">                cleanupOldBackups(tenantId);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;Backup failed for tenant: &#123;&#125;&quot;</span>, tenantId, e);</span><br><span class="line">                alertService.sendBackupFailureAlert(tenantId, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">createBackup</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">backupId</span> <span class="operator">=</span> generateBackupId(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TenantContext.setTenant(tenantId);</span><br><span class="line">            <span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> connectionPoolManager.getDataSource(tenantId);</span><br><span class="line">            </span><br><span class="line">            <span class="type">BackupConfig</span> <span class="variable">config</span> <span class="operator">=</span> BackupConfig.builder()</span><br><span class="line">                .tenantId(tenantId)</span><br><span class="line">                .backupId(backupId)</span><br><span class="line">                .timestamp(Instant.now())</span><br><span class="line">                .compressionEnabled(<span class="literal">true</span>)</span><br><span class="line">                .encryptionEnabled(<span class="literal">true</span>)</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">            databaseProvider.createBackup(dataSource, config);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> backupId;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BackupException</span>(<span class="string">&quot;Backup creation failed for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">restoreFromBackup</span><span class="params">(String tenantId, String backupId)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">BackupMetadata</span> <span class="variable">metadata</span> <span class="operator">=</span> getBackupMetadata(tenantId, backupId);</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">backupStream</span> <span class="operator">=</span> storageService.downloadBackup(metadata.getStoragePath());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Create temporary database for restoration</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">tempTenantId</span> <span class="operator">=</span> tenantId + <span class="string">&quot;_restore_&quot;</span> + System.currentTimeMillis();</span><br><span class="line">            databaseProvider.restoreFromBackup(tempTenantId, backupStream);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Validate restoration</span></span><br><span class="line">            <span class="keyword">if</span> (validateRestoration(tenantId, tempTenantId)) &#123;</span><br><span class="line">                <span class="comment">// Switch to restored database</span></span><br><span class="line">                switchTenantDatabase(tenantId, tempTenantId);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RestoreException</span>(<span class="string">&quot;Backup validation failed&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RestoreException</span>(<span class="string">&quot;Restoration failed for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="High-Availability-Configuration"><a href="#High-Availability-Configuration" class="headerlink" title="High Availability Configuration"></a>High Availability Configuration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HighAvailabilityConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LoadBalancer <span class="title function_">databaseLoadBalancer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> LoadBalancer.builder()</span><br><span class="line">            .algorithm(LoadBalancingAlgorithm.ROUND_ROBIN)</span><br><span class="line">            .healthCheckInterval(Duration.ofSeconds(<span class="number">30</span>))</span><br><span class="line">            .failoverTimeout(Duration.ofSeconds(<span class="number">5</span>))</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FailoverManager <span class="title function_">failoverManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FailoverManager</span>(databaseProviderFactory, alertService);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FailoverManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, List&lt;TenantConfig&gt;&gt; replicaConfigs = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDatabaseFailure</span><span class="params">(DatabaseFailureEvent event)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> event.getTenantId();</span><br><span class="line">        </span><br><span class="line">        log.warn(<span class="string">&quot;Database failure detected for tenant: &#123;&#125;&quot;</span>, tenantId);</span><br><span class="line">        </span><br><span class="line">        List&lt;TenantConfig&gt; replicas = replicaConfigs.get(tenantId);</span><br><span class="line">        <span class="keyword">if</span> (replicas != <span class="literal">null</span> &amp;&amp; !replicas.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (TenantConfig replica : replicas) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isHealthy(replica)) &#123;</span><br><span class="line">                    performFailover(tenantId, replica);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            alertService.sendCriticalAlert(<span class="string">&quot;No healthy replicas available for tenant: &quot;</span> + tenantId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">performFailover</span><span class="params">(String tenantId, TenantConfig replicaConfig)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Update connection pool to use replica</span></span><br><span class="line">            connectionPoolManager.updateDataSource(tenantId, replicaConfig);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Update tenant configuration</span></span><br><span class="line">            tenantConfigRepository.updateConfig(tenantId, replicaConfig);</span><br><span class="line">            </span><br><span class="line">            log.info(<span class="string">&quot;Failover completed for tenant: &#123;&#125;&quot;</span>, tenantId);</span><br><span class="line">            alertService.sendFailoverAlert(tenantId, replicaConfig.getHost());</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Failover failed for tenant: &#123;&#125;&quot;</span>, tenantId, e);</span><br><span class="line">            alertService.sendFailoverFailureAlert(tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="External-References-and-Resources"><a href="#External-References-and-Resources" class="headerlink" title="External References and Resources"></a>External References and Resources</h2><h3 id="Documentation-and-Specifications"><a href="#Documentation-and-Specifications" class="headerlink" title="Documentation and Specifications"></a>Documentation and Specifications</h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/brettwooldridge/HikariCP#configuration-knobs-baby">HikariCP Configuration Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/tutorial/ext/basics/spi.html">Java SPI Tutorial</a></li>
<li><a target="_blank" rel="noopener" href="https://spring.io/blog/2022/07/31/how-to-integrate-hibernates-multitenant-feature-with-spring-data-jpa-in-a-spring-boot-application">Spring Boot Multi-Tenancy</a></li>
<li><a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/current/ddl-schemas.html">PostgreSQL Multi-Tenant Patterns</a></li>
<li><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/multiple-servers.html">MySQL Multi-Tenancy Best Practices</a></li>
</ul>
<h3 id="Performance-and-Monitoring"><a href="#Performance-and-Monitoring" class="headerlink" title="Performance and Monitoring"></a>Performance and Monitoring</h3><ul>
<li><a target="_blank" rel="noopener" href="https://micrometer.io/docs">Micrometer Metrics</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/brettwooldridge/HikariCP/wiki/MBean-(JMX)-Monitoring-and-Management">Connection Pool Monitoring</a></li>
<li><a target="_blank" rel="noopener" href="https://use-the-index-luke.com/">Database Performance Tuning</a></li>
</ul>
<h3 id="Security-Resources"><a href="#Security-Resources" class="headerlink" title="Security Resources"></a>Security Resources</h3><ul>
<li><a target="_blank" rel="noopener" href="https://owasp.org/www-project-database-security/">OWASP Database Security</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/architecture/guide/multitenant/considerations/data-partitioning">Multi-Tenant Security Patterns</a></li>
<li><a target="_blank" rel="noopener" href="https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html">SQL Injection Prevention</a></li>
</ul>
<h3 id="Cloud-and-DevOps"><a href="#Cloud-and-DevOps" class="headerlink" title="Cloud and DevOps"></a>Cloud and DevOps</h3><ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/extend-kubernetes/operator/">Kubernetes Database Operators</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/develop/dev-best-practices/">Docker Multi-Stage Builds</a></li>
<li><a target="_blank" rel="noopener" href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/db_instance">Terraform Database Provisioning</a></li>
</ul>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>This Multi-Tenant Database SDK provides a comprehensive solution for managing database operations across multiple tenants in a SaaS environment. The design emphasizes security, performance, and scalability while maintaining simplicity for developers.</p>
<p>Key benefits of this architecture include:</p>
<ul>
<li><strong>Strong tenant isolation</strong> through database-per-tenant approach</li>
<li><strong>High performance</strong> via connection pooling and caching strategies</li>
<li><strong>Extensibility</strong> through SPI pattern for database providers</li>
<li><strong>Production readiness</strong> with monitoring, backup, and failover capabilities</li>
<li><strong>Security</strong> with encryption, audit logging, and access controls</li>
</ul>
<p>The SDK can be extended to support additional database providers, implement more sophisticated sharding strategies, or integrate with cloud-native services. Regular monitoring and performance tuning ensure optimal operation in production environments.</p>
<p>Remember to adapt the configuration and implementation details based on your specific requirements, such as tenant scale, database types, and compliance needs. The provided examples serve as a solid foundation for building a robust multi-tenant database solution.</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/system-design/" rel="tag"># system-design</a>
              <a href="/tags/async-invocation/" rel="tag"># async invocation</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/06/13/Design-Universal-Message-Queue-SDK-Guide/" rel="prev" title="Design Universal Message Queue SDK">
                  <i class="fa fa-angle-left"></i> Design Universal Message Queue SDK
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/06/13/Design-Message-Notification-Service/" rel="next" title="Design Message Notification Service">
                  Design Message Notification Service <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Charlie Feng</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
