<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"shayne007.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="Executive SummaryThis document outlines a comprehensive Database SDK design for a multi-tenant SaaS platform that supports dynamic database creation, runtime datasource switching, and multi-database b">
<meta property="og:type" content="article">
<meta property="og:title" content="Design Multi-Tenant Database SDK">
<meta property="og:url" content="https://shayne007.github.io/2025/06/13/Design-Multi-Tenant-Database-SDK/index.html">
<meta property="og:site_name" content="Charlie Feng&#39;s Tech Space">
<meta property="og:description" content="Executive SummaryThis document outlines a comprehensive Database SDK design for a multi-tenant SaaS platform that supports dynamic database creation, runtime datasource switching, and multi-database b">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-06-13T10:40:02.000Z">
<meta property="article:modified_time" content="2025-06-13T10:42:54.213Z">
<meta property="article:author" content="Charlie Feng">
<meta property="article:tag" content="system-design">
<meta property="article:tag" content="async invocation">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://shayne007.github.io/2025/06/13/Design-Multi-Tenant-Database-SDK/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://shayne007.github.io/2025/06/13/Design-Multi-Tenant-Database-SDK/","path":"2025/06/13/Design-Multi-Tenant-Database-SDK/","title":"Design Multi-Tenant Database SDK"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Design Multi-Tenant Database SDK | Charlie Feng's Tech Space</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"cdn":false,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.5.0/mermaid.min.js","integrity":"sha256-2obLuIPcceEhkE3G09G33hBdmE55ivVcZUlcKcGNHjU="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>





  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Charlie Feng's Tech Space</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">You will survive with skills</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Executive-Summary"><span class="nav-number">1.</span> <span class="nav-text">Executive Summary</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Architecture-Overview"><span class="nav-number">2.</span> <span class="nav-text">Architecture Overview</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#High-Level-Architecture"><span class="nav-number">2.1.</span> <span class="nav-text">High-Level Architecture</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Core-Components"><span class="nav-number">2.2.</span> <span class="nav-text">Core Components</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Database-SDK-Core-Design"><span class="nav-number">3.</span> <span class="nav-text">Database SDK Core Design</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Main-SDK-Interface"><span class="nav-number">3.1.</span> <span class="nav-text">Main SDK Interface</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tenant-Context-Management"><span class="nav-number">3.2.</span> <span class="nav-text">Tenant Context Management</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SPI-Service-Provider-Interface-Implementation"><span class="nav-number">4.</span> <span class="nav-text">SPI (Service Provider Interface) Implementation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Provider-Architecture"><span class="nav-number">4.1.</span> <span class="nav-text">Provider Architecture</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL-Provider-Implementation"><span class="nav-number">4.2.</span> <span class="nav-text">MySQL Provider Implementation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PostgreSQL-Provider-Implementation"><span class="nav-number">4.3.</span> <span class="nav-text">PostgreSQL Provider Implementation</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Connection-Management-Pooling"><span class="nav-number">5.</span> <span class="nav-text">Connection Management &amp; Pooling</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Multi-Tenant-Connection-Architecture"><span class="nav-number">5.1.</span> <span class="nav-text">Multi-Tenant Connection Architecture</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Connection-Pool-Implementation"><span class="nav-number">5.2.</span> <span class="nav-text">Connection Pool Implementation</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Runtime-Datasource-Switching"><span class="nav-number">6.</span> <span class="nav-text">Runtime Datasource Switching</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Switching-Mechanism-Flow"><span class="nav-number">6.1.</span> <span class="nav-text">Switching Mechanism Flow</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Implementation-Example"><span class="nav-number">6.2.</span> <span class="nav-text">Implementation Example</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Schema-Management-Migrations"><span class="nav-number">7.</span> <span class="nav-text">Schema Management &amp; Migrations</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Migration-System-Architecture"><span class="nav-number">7.1.</span> <span class="nav-text">Migration System Architecture</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Migration-Implementation"><span class="nav-number">7.2.</span> <span class="nav-text">Migration Implementation</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Performance-Optimization"><span class="nav-number">8.</span> <span class="nav-text">Performance Optimization</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Query-Optimization-Strategies"><span class="nav-number">8.1.</span> <span class="nav-text">Query Optimization Strategies</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Connection-Pool-Monitoring"><span class="nav-number">8.2.</span> <span class="nav-text">Connection Pool Monitoring</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Security-Isolation"><span class="nav-number">9.</span> <span class="nav-text">Security &amp; Isolation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Tenant-Isolation-Strategies"><span class="nav-number">9.1.</span> <span class="nav-text">Tenant Isolation Strategies</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Security-Implementation"><span class="nav-number">9.2.</span> <span class="nav-text">Security Implementation</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Monitoring-Observability"><span class="nav-number">10.</span> <span class="nav-text">Monitoring &amp; Observability</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Metrics-Collection"><span class="nav-number">10.1.</span> <span class="nav-text">Metrics Collection</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Health-Checks"><span class="nav-number">10.2.</span> <span class="nav-text">Health Checks</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Best-Practices-Patterns"><span class="nav-number">11.</span> <span class="nav-text">Best Practices &amp; Patterns</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Configuration-Management"><span class="nav-number">11.1.</span> <span class="nav-text">Configuration Management</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Error-Handling-Strategy"><span class="nav-number">11.2.</span> <span class="nav-text">Error Handling Strategy</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Testing-Strategy"><span class="nav-number">12.</span> <span class="nav-text">Testing Strategy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Unit-Testing"><span class="nav-number">12.1.</span> <span class="nav-text">Unit Testing</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Integration-Testing"><span class="nav-number">12.2.</span> <span class="nav-text">Integration Testing</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Deployment-Operations"><span class="nav-number">13.</span> <span class="nav-text">Deployment &amp; Operations</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Deployment-Architecture"><span class="nav-number">13.1.</span> <span class="nav-text">Deployment Architecture</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Configuration-Management-1"><span class="nav-number">13.2.</span> <span class="nav-text">Configuration Management</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Graceful-Shutdown"><span class="nav-number">13.3.</span> <span class="nav-text">Graceful Shutdown</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Scalability-Considerations"><span class="nav-number">14.</span> <span class="nav-text">Scalability Considerations</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Horizontal-Scaling-Strategy"><span class="nav-number">14.1.</span> <span class="nav-text">Horizontal Scaling Strategy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sharding-Implementation"><span class="nav-number">14.2.</span> <span class="nav-text">Sharding Implementation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Read-Replica-Support"><span class="nav-number">14.3.</span> <span class="nav-text">Read Replica Support</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Advanced-Features"><span class="nav-number">15.</span> <span class="nav-text">Advanced Features</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Query-Result-Caching"><span class="nav-number">15.1.</span> <span class="nav-text">Query Result Caching</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Database-Connection-Failover"><span class="nav-number">15.2.</span> <span class="nav-text">Database Connection Failover</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Multi-Region-Support"><span class="nav-number">15.3.</span> <span class="nav-text">Multi-Region Support</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Interview-Questions-Answers"><span class="nav-number">16.</span> <span class="nav-text">Interview Questions &amp; Answers</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Architecture-Design-Questions"><span class="nav-number">16.1.</span> <span class="nav-text">Architecture &amp; Design Questions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Performance-Scalability-Questions"><span class="nav-number">16.2.</span> <span class="nav-text">Performance &amp; Scalability Questions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Security-Compliance-Questions"><span class="nav-number">16.3.</span> <span class="nav-text">Security &amp; Compliance Questions</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Conclusion"><span class="nav-number">17.</span> <span class="nav-text">Conclusion</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Key-Advantages"><span class="nav-number">17.1.</span> <span class="nav-text">Key Advantages</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Implementation-Roadmap"><span class="nav-number">17.2.</span> <span class="nav-text">Implementation Roadmap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Success-Metrics"><span class="nav-number">17.3.</span> <span class="nav-text">Success Metrics</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Charlie Feng</p>
  <div class="site-description" itemprop="description">This place is for thinking and sharing.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">35</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/13/Design-Multi-Tenant-Database-SDK/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Design Multi-Tenant Database SDK | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Design Multi-Tenant Database SDK
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-13 18:40:02 / Modified: 18:42:54" itemprop="dateCreated datePublished" datetime="2025-06-13T18:40:02+08:00">2025-06-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system-design/" itemprop="url" rel="index"><span itemprop="name">system-design</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="Executive-Summary"><a href="#Executive-Summary" class="headerlink" title="Executive Summary"></a>Executive Summary</h2><p>This document outlines a comprehensive Database SDK design for a multi-tenant SaaS platform that supports dynamic database creation, runtime datasource switching, and multi-database backends through an SPI (Service Provider Interface) mechanism.</p>
<p><strong>Key Features:</strong></p>
<ul>
<li>Dynamic database and table creation per tenant</li>
<li>Runtime datasource switching</li>
<li>MySQL and PostgreSQL support via SPI</li>
<li>Connection pooling and performance optimization</li>
<li>Schema migration management</li>
<li>Security and isolation guarantees</li>
</ul>
<hr>
<h2 id="Architecture-Overview"><a href="#Architecture-Overview" class="headerlink" title="Architecture Overview"></a>Architecture Overview</h2><h3 id="High-Level-Architecture"><a href="#High-Level-Architecture" class="headerlink" title="High-Level Architecture"></a>High-Level Architecture</h3><pre>
<code class="mermaid">
graph TB
subgraph &quot;Application Layer&quot;
    A[SaaS Services] --&gt; B[Database SDK]
end

subgraph &quot;SDK Core&quot;
    B --&gt; C[Connection Manager]
    B --&gt; D[Schema Manager]
    B --&gt; E[Query Builder]
    B --&gt; F[Migration Engine]
end

subgraph &quot;SPI Layer&quot;
    C --&gt; G[MySQL Provider]
    C --&gt; H[PostgreSQL Provider]
    D --&gt; G
    D --&gt; H
end

subgraph &quot;Database Layer&quot;
    G --&gt; I[(MySQL Clusters)]
    H --&gt; J[(PostgreSQL Clusters)]
end

subgraph &quot;Configuration&quot;
    K[Tenant Registry] --&gt; C
    L[Connection Pools] --&gt; C
end
</code>
</pre>

<h3 id="Core-Components"><a href="#Core-Components" class="headerlink" title="Core Components"></a>Core Components</h3><p>The SDK architecture follows a layered approach with clear separation of concerns:</p>
<ol>
<li><strong>API Layer</strong>: Provides high-level abstractions for database operations</li>
<li><strong>Core Engine</strong>: Handles connection management, schema operations, and query execution</li>
<li><strong>SPI Layer</strong>: Enables pluggable database providers</li>
<li><strong>Provider Implementations</strong>: Database-specific implementations for MySQL and PostgreSQL</li>
</ol>
<p><strong>Interview Insight</strong>: <em>When discussing architecture, emphasize the importance of abstraction layers. This design allows adding new database types without changing client code, demonstrating understanding of the Open&#x2F;Closed Principle.</em></p>
<hr>
<h2 id="Database-SDK-Core-Design"><a href="#Database-SDK-Core-Design" class="headerlink" title="Database SDK Core Design"></a>Database SDK Core Design</h2><h3 id="Main-SDK-Interface"><a href="#Main-SDK-Interface" class="headerlink" title="Main SDK Interface"></a>Main SDK Interface</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DatabaseSDK</span> &#123;</span><br><span class="line">    <span class="comment">// Tenant management</span></span><br><span class="line">    TenantContext <span class="title function_">createTenant</span><span class="params">(String tenantId, DatabaseConfig config)</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">switchToTenant</span><span class="params">(String tenantId)</span>;</span><br><span class="line">    TenantContext <span class="title function_">getCurrentTenant</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Schema operations</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createDatabase</span><span class="params">(String databaseName)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createTable</span><span class="params">(String tableName, TableSchema schema)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">dropTable</span><span class="params">(String tableName)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Query operations</span></span><br><span class="line">    QueryBuilder <span class="title function_">query</span><span class="params">()</span>;</span><br><span class="line">    &lt;T&gt; List&lt;T&gt; <span class="title function_">executeQuery</span><span class="params">(String sql, Class&lt;T&gt; resultType, Object... params)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">executeUpdate</span><span class="params">(String sql, Object... params)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Transaction management</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">beginTransaction</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">rollback</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Migration support</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">runMigrations</span><span class="params">(String migrationsPath)</span>;</span><br><span class="line">    MigrationStatus <span class="title function_">getMigrationStatus</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Tenant-Context-Management"><a href="#Tenant-Context-Management" class="headerlink" title="Tenant Context Management"></a>Tenant Context Management</h3><pre>
<code class="mermaid">
sequenceDiagram
participant Client
participant SDK
participant TenantManager
participant ConnectionPool
participant Database

Client-&gt;&gt;SDK: createTenant(&quot;tenant-123&quot;, config)
SDK-&gt;&gt;TenantManager: registerTenant(tenantId, config)
TenantManager-&gt;&gt;Database: CREATE DATABASE tenant_123_db
TenantManager-&gt;&gt;ConnectionPool: createPool(tenantId, config)
SDK-&gt;&gt;Client: TenantContext

Client-&gt;&gt;SDK: switchToTenant(&quot;tenant-123&quot;)
SDK-&gt;&gt;TenantManager: setCurrentTenant(tenantId)
TenantManager-&gt;&gt;ConnectionPool: getConnection(tenantId)
SDK-&gt;&gt;Client: success
</code>
</pre>

<p><strong>Interview Insight</strong>: <em>Discuss the importance of thread-local storage for tenant context. This prevents cross-tenant data leakage in multi-threaded environments.</em></p>
<hr>
<h2 id="SPI-Service-Provider-Interface-Implementation"><a href="#SPI-Service-Provider-Interface-Implementation" class="headerlink" title="SPI (Service Provider Interface) Implementation"></a>SPI (Service Provider Interface) Implementation</h2><h3 id="Provider-Architecture"><a href="#Provider-Architecture" class="headerlink" title="Provider Architecture"></a>Provider Architecture</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Core SPI interface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DatabaseProvider</span> &#123;</span><br><span class="line">    String <span class="title function_">getProviderName</span><span class="params">()</span>;</span><br><span class="line">    String[] getSupportedVersions();</span><br><span class="line">    </span><br><span class="line">    Connection <span class="title function_">createConnection</span><span class="params">(DatabaseConfig config)</span>;</span><br><span class="line">    SchemaManager <span class="title function_">getSchemaManager</span><span class="params">()</span>;</span><br><span class="line">    QueryExecutor <span class="title function_">getQueryExecutor</span><span class="params">()</span>;</span><br><span class="line">    MigrationEngine <span class="title function_">getMigrationEngine</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">supportsFeature</span><span class="params">(DatabaseFeature feature)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Provider registration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProviderRegistry</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, DatabaseProvider&gt; providers = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerProvider</span><span class="params">(DatabaseProvider provider)</span> &#123;</span><br><span class="line">        providers.put(provider.getProviderName().toLowerCase(), provider);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> DatabaseProvider <span class="title function_">getProvider</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> providers.get(name.toLowerCase());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="MySQL-Provider-Implementation"><a href="#MySQL-Provider-Implementation" class="headerlink" title="MySQL Provider Implementation"></a>MySQL Provider Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Provider(&quot;mysql&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySQLProvider</span> <span class="keyword">implements</span> <span class="title class_">DatabaseProvider</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Connection <span class="title function_">createConnection</span><span class="params">(DatabaseConfig config)</span> &#123;</span><br><span class="line">        <span class="type">HikariConfig</span> <span class="variable">hikariConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HikariConfig</span>();</span><br><span class="line">        hikariConfig.setJdbcUrl(buildJdbcUrl(config));</span><br><span class="line">        hikariConfig.setUsername(config.getUsername());</span><br><span class="line">        hikariConfig.setPassword(config.getPassword());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// MySQL-specific optimizations</span></span><br><span class="line">        hikariConfig.addDataSourceProperty(<span class="string">&quot;cachePrepStmts&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        hikariConfig.addDataSourceProperty(<span class="string">&quot;prepStmtCacheSize&quot;</span>, <span class="string">&quot;250&quot;</span>);</span><br><span class="line">        hikariConfig.addDataSourceProperty(<span class="string">&quot;prepStmtCacheSqlLimit&quot;</span>, <span class="string">&quot;2048&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HikariDataSource</span>(hikariConfig).getConnection();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SchemaManager <span class="title function_">getSchemaManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MySQLSchemaManager</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">MySQLSchemaManager</span> <span class="keyword">implements</span> <span class="title class_">SchemaManager</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createDatabase</span><span class="params">(String name)</span> &#123;</span><br><span class="line">            executeUpdate(<span class="string">&quot;CREATE DATABASE IF NOT EXISTS `&quot;</span> + name + <span class="string">&quot;` &quot;</span> +</span><br><span class="line">                         <span class="string">&quot;CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createTable</span><span class="params">(String name, TableSchema schema)</span> &#123;</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot;CREATE TABLE IF NOT EXISTS `&quot;</span>)</span><br><span class="line">                .append(name).append(<span class="string">&quot;` (&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Build column definitions with MySQL-specific types</span></span><br><span class="line">            schema.getColumns().forEach(col -&gt; &#123;</span><br><span class="line">                sql.append(<span class="string">&quot;`&quot;</span>).append(col.getName()).append(<span class="string">&quot;` &quot;</span>);</span><br><span class="line">                sql.append(mapToMySQLType(col.getType()));</span><br><span class="line">                <span class="keyword">if</span> (col.isPrimaryKey()) sql.append(<span class="string">&quot; PRIMARY KEY&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (col.isAutoIncrement()) sql.append(<span class="string">&quot; AUTO_INCREMENT&quot;</span>);</span><br><span class="line">                sql.append(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            sql.setLength(sql.length() - <span class="number">2</span>); <span class="comment">// Remove last comma</span></span><br><span class="line">            sql.append(<span class="string">&quot;) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            executeUpdate(sql.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PostgreSQL-Provider-Implementation"><a href="#PostgreSQL-Provider-Implementation" class="headerlink" title="PostgreSQL Provider Implementation"></a>PostgreSQL Provider Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Provider(&quot;postgresql&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PostgreSQLProvider</span> <span class="keyword">implements</span> <span class="title class_">DatabaseProvider</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SchemaManager <span class="title function_">getSchemaManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PostgreSQLSchemaManager</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">PostgreSQLSchemaManager</span> <span class="keyword">implements</span> <span class="title class_">SchemaManager</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createDatabase</span><span class="params">(String name)</span> &#123;</span><br><span class="line">            executeUpdate(<span class="string">&quot;CREATE DATABASE \&quot;&quot;</span> + name + <span class="string">&quot;\&quot; &quot;</span> +</span><br><span class="line">                         <span class="string">&quot;WITH ENCODING=&#x27;UTF8&#x27; LC_COLLATE=&#x27;en_US.UTF-8&#x27; LC_CTYPE=&#x27;en_US.UTF-8&#x27;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createTable</span><span class="params">(String name, TableSchema schema)</span> &#123;</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot;CREATE TABLE IF NOT EXISTS \&quot;&quot;</span>)</span><br><span class="line">                .append(name).append(<span class="string">&quot;\&quot; (&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            schema.getColumns().forEach(col -&gt; &#123;</span><br><span class="line">                sql.append(<span class="string">&quot;\&quot;&quot;</span>).append(col.getName()).append(<span class="string">&quot;\&quot; &quot;</span>);</span><br><span class="line">                sql.append(mapToPostgreSQLType(col.getType()));</span><br><span class="line">                <span class="keyword">if</span> (col.isPrimaryKey()) sql.append(<span class="string">&quot; PRIMARY KEY&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (col.isAutoIncrement()) sql.append(<span class="string">&quot; GENERATED ALWAYS AS IDENTITY&quot;</span>);</span><br><span class="line">                sql.append(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            sql.setLength(sql.length() - <span class="number">2</span>);</span><br><span class="line">            sql.append(<span class="string">&quot;)&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            executeUpdate(sql.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Explain how SPI promotes loose coupling and enables runtime provider discovery. This is crucial for enterprise applications that need to support multiple database vendors.</em></p>
<hr>
<h2 id="Connection-Management-Pooling"><a href="#Connection-Management-Pooling" class="headerlink" title="Connection Management &amp; Pooling"></a>Connection Management &amp; Pooling</h2><h3 id="Multi-Tenant-Connection-Architecture"><a href="#Multi-Tenant-Connection-Architecture" class="headerlink" title="Multi-Tenant Connection Architecture"></a>Multi-Tenant Connection Architecture</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    subgraph &quot;Application Threads&quot;</span><br><span class="line">        T1[Thread 1&lt;br/&gt;Tenant A]</span><br><span class="line">        T2[Thread 2&lt;br/&gt;Tenant B]</span><br><span class="line">        T3[Thread 3&lt;br/&gt;Tenant A]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph &quot;Connection Manager&quot;</span><br><span class="line">        CM[Connection Manager]</span><br><span class="line">        TLS[ThreadLocal&lt;br/&gt;TenantContext]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph &quot;Connection Pools&quot;</span><br><span class="line">        PA[Pool A&lt;br/&gt;MySQL]</span><br><span class="line">        PB[Pool B&lt;br/&gt;PostgreSQL]</span><br><span class="line">        PC[Pool C&lt;br/&gt;MySQL]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    T1 --&gt; CM</span><br><span class="line">    T2 --&gt; CM</span><br><span class="line">    T3 --&gt; CM</span><br><span class="line">    CM --&gt; TLS</span><br><span class="line">    CM --&gt; PA</span><br><span class="line">    CM --&gt; PB</span><br><span class="line">    CM --&gt; PC</span><br></pre></td></tr></table></figure>

<h3 id="Connection-Pool-Implementation"><a href="#Connection-Pool-Implementation" class="headerlink" title="Connection Pool Implementation"></a>Connection Pool Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantConnectionManager</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, HikariDataSource&gt; tenantPools = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; currentTenant = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createTenantPool</span><span class="params">(String tenantId, DatabaseConfig config)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (tenantPools.containsKey(tenantId)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Tenant pool already exists: &quot;</span> + tenantId);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">HikariConfig</span> <span class="variable">hikariConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HikariConfig</span>();</span><br><span class="line">        hikariConfig.setJdbcUrl(config.getJdbcUrl());</span><br><span class="line">        hikariConfig.setUsername(config.getUsername());</span><br><span class="line">        hikariConfig.setPassword(config.getPassword());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Pool sizing based on tenant tier</span></span><br><span class="line">        <span class="type">TenantTier</span> <span class="variable">tier</span> <span class="operator">=</span> config.getTier();</span><br><span class="line">        hikariConfig.setMaximumPoolSize(tier.getMaxConnections());</span><br><span class="line">        hikariConfig.setMinimumIdle(tier.getMinConnections());</span><br><span class="line">        hikariConfig.setConnectionTimeout(tier.getConnectionTimeoutMs());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Monitoring and health checks</span></span><br><span class="line">        hikariConfig.setRegisterMbeans(<span class="literal">true</span>);</span><br><span class="line">        hikariConfig.setHealthCheckRegistry(HealthCheckRegistry.getInstance());</span><br><span class="line">        </span><br><span class="line">        tenantPools.put(tenantId, <span class="keyword">new</span> <span class="title class_">HikariDataSource</span>(hikariConfig));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Connection <span class="title function_">getConnection</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> currentTenant.get();</span><br><span class="line">        <span class="keyword">if</span> (tenantId == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;No tenant context set for current thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">HikariDataSource</span> <span class="variable">pool</span> <span class="operator">=</span> tenantPools.get(tenantId);</span><br><span class="line">        <span class="keyword">if</span> (pool == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;No connection pool for tenant: &quot;</span> + tenantId);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> pool.getConnection();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DatabaseException</span>(<span class="string">&quot;Failed to get connection for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">switchTenant</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!tenantPools.containsKey(tenantId)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unknown tenant: &quot;</span> + tenantId);</span><br><span class="line">        &#125;</span><br><span class="line">        currentTenant.set(tenantId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Discuss connection pool tuning strategies. Different tenant tiers might need different pool configurations based on their usage patterns and SLA requirements.</em></p>
<hr>
<h2 id="Runtime-Datasource-Switching"><a href="#Runtime-Datasource-Switching" class="headerlink" title="Runtime Datasource Switching"></a>Runtime Datasource Switching</h2><h3 id="Switching-Mechanism-Flow"><a href="#Switching-Mechanism-Flow" class="headerlink" title="Switching Mechanism Flow"></a>Switching Mechanism Flow</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">flowchart TD</span><br><span class="line">    A[Service Request] --&gt; B&#123;Tenant ID Available?&#125;</span><br><span class="line">    B --&gt;|No| C[Extract from JWT/Header]</span><br><span class="line">    B --&gt;|Yes| D[Set Thread Context]</span><br><span class="line">    C --&gt; D</span><br><span class="line">    D --&gt; E[Lookup Tenant Config]</span><br><span class="line">    E --&gt; F&#123;Pool Exists?&#125;</span><br><span class="line">    F --&gt;|No| G[Create New Pool]</span><br><span class="line">    F --&gt;|Yes| H[Get Connection]</span><br><span class="line">    G --&gt; H</span><br><span class="line">    H --&gt; I[Execute Database Operation]</span><br><span class="line">    I --&gt; J[Return Connection to Pool]</span><br><span class="line">    J --&gt; K[Clear Thread Context]</span><br></pre></td></tr></table></figure>

<h3 id="Implementation-Example"><a href="#Implementation-Example" class="headerlink" title="Implementation Example"></a>Implementation Example</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseSDKImpl</span> <span class="keyword">implements</span> <span class="title class_">DatabaseSDK</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TenantConnectionManager connectionManager;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TenantRegistry tenantRegistry;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">switchToTenant</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">TenantConfig</span> <span class="variable">config</span> <span class="operator">=</span> tenantRegistry.getTenantConfig(tenantId);</span><br><span class="line">            <span class="keyword">if</span> (config == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Ensure connection pool exists</span></span><br><span class="line">            <span class="keyword">if</span> (!connectionManager.hasPool(tenantId)) &#123;</span><br><span class="line">                connectionManager.createTenantPool(tenantId, config.getDatabaseConfig());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Switch context</span></span><br><span class="line">            connectionManager.switchTenant(tenantId);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Verify connection</span></span><br><span class="line">            <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> connectionManager.getConnection()) &#123;</span><br><span class="line">                <span class="keyword">return</span> conn.isValid(<span class="number">5</span>); <span class="comment">// 5 second timeout</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Failed to switch to tenant: &quot;</span> + tenantId, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createDatabase</span><span class="params">(String databaseName)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> getCurrentTenantId();</span><br><span class="line">        <span class="type">TenantConfig</span> <span class="variable">config</span> <span class="operator">=</span> tenantRegistry.getTenantConfig(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="type">DatabaseProvider</span> <span class="variable">provider</span> <span class="operator">=</span> ProviderRegistry.getProvider(config.getDatabaseType());</span><br><span class="line">        <span class="type">SchemaManager</span> <span class="variable">schemaManager</span> <span class="operator">=</span> provider.getSchemaManager();</span><br><span class="line">        </span><br><span class="line">        schemaManager.createDatabase(databaseName);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Update tenant configuration</span></span><br><span class="line">        config.addDatabase(databaseName);</span><br><span class="line">        tenantRegistry.updateTenantConfig(tenantId, config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Emphasize the importance of connection validation and proper error handling during tenant switching. Discuss how to handle scenarios where a tenant’s database becomes unavailable.</em></p>
<hr>
<h2 id="Schema-Management-Migrations"><a href="#Schema-Management-Migrations" class="headerlink" title="Schema Management &amp; Migrations"></a>Schema Management &amp; Migrations</h2><h3 id="Migration-System-Architecture"><a href="#Migration-System-Architecture" class="headerlink" title="Migration System Architecture"></a>Migration System Architecture</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line">    subgraph &quot;Migration Management&quot;</span><br><span class="line">        A[Migration Files] --&gt; B[Migration Parser]</span><br><span class="line">        B --&gt; C[Version Tracker]</span><br><span class="line">        C --&gt; D[Execution Engine]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph &quot;Per-Tenant Execution&quot;</span><br><span class="line">        D --&gt; E[Tenant 1&lt;br/&gt;Migration]</span><br><span class="line">        D --&gt; F[Tenant 2&lt;br/&gt;Migration]</span><br><span class="line">        D --&gt; G[Tenant N&lt;br/&gt;Migration]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph &quot;Database-Specific&quot;</span><br><span class="line">        E --&gt; H[MySQL Executor]</span><br><span class="line">        F --&gt; I[PostgreSQL Executor]</span><br><span class="line">        G --&gt; H</span><br><span class="line">    end</span><br></pre></td></tr></table></figure>

<h3 id="Migration-Implementation"><a href="#Migration-Implementation" class="headerlink" title="Migration Implementation"></a>Migration Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MigrationEngine</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">runMigrations</span><span class="params">(String tenantId, String migrationsPath)</span> &#123;</span><br><span class="line">        List&lt;Migration&gt; pendingMigrations = findPendingMigrations(tenantId, migrationsPath);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (Migration migration : pendingMigrations) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                beginTransaction();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Execute migration for current provider</span></span><br><span class="line">                <span class="type">DatabaseProvider</span> <span class="variable">provider</span> <span class="operator">=</span> getCurrentProvider();</span><br><span class="line">                <span class="type">MigrationExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> provider.getMigrationExecutor();</span><br><span class="line">                </span><br><span class="line">                executor.execute(migration);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Record migration completion</span></span><br><span class="line">                recordMigrationCompletion(tenantId, migration);</span><br><span class="line">                </span><br><span class="line">                commit();</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                rollback();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MigrationException</span>(<span class="string">&quot;Failed to execute migration: &quot;</span> + </span><br><span class="line">                    migration.getVersion(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> List&lt;Migration&gt; <span class="title function_">findPendingMigrations</span><span class="params">(String tenantId, String path)</span> &#123;</span><br><span class="line">        Set&lt;String&gt; appliedVersions = getAppliedMigrations(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> loadMigrationsFromPath(path)</span><br><span class="line">            .stream()</span><br><span class="line">            .filter(m -&gt; !appliedVersions.contains(m.getVersion()))</span><br><span class="line">            .sorted(Comparator.comparing(Migration::getVersion))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Database-specific migration example</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySQLMigrationExecutor</span> <span class="keyword">implements</span> <span class="title class_">MigrationExecutor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Migration migration)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> migration.getSql();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Handle MySQL-specific syntax transformations</span></span><br><span class="line">        sql = transformForMySQL(sql);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> getConnection();</span><br><span class="line">             <span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> conn.createStatement()) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Execute migration SQL</span></span><br><span class="line">            stmt.execute(sql);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MigrationException</span>(<span class="string">&quot;MySQL migration failed&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">transformForMySQL</span><span class="params">(String sql)</span> &#123;</span><br><span class="line">        <span class="comment">// Transform generic SQL to MySQL-specific syntax</span></span><br><span class="line">        <span class="keyword">return</span> sql.replaceAll(<span class="string">&quot;SERIAL&quot;</span>, <span class="string">&quot;INT AUTO_INCREMENT&quot;</span>)</span><br><span class="line">                 .replaceAll(<span class="string">&quot;BOOLEAN&quot;</span>, <span class="string">&quot;TINYINT(1)&quot;</span>)</span><br><span class="line">                 .replaceAll(<span class="string">&quot;NOW\\(\\)&quot;</span>, <span class="string">&quot;CURRENT_TIMESTAMP&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Discuss migration rollback strategies and how to handle schema changes that affect multiple tenants. Consider blue-green deployment scenarios.</em></p>
<hr>
<h2 id="Performance-Optimization"><a href="#Performance-Optimization" class="headerlink" title="Performance Optimization"></a>Performance Optimization</h2><h3 id="Query-Optimization-Strategies"><a href="#Query-Optimization-Strategies" class="headerlink" title="Query Optimization Strategies"></a>Query Optimization Strategies</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueryOptimizer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">QueryCache</span> <span class="variable">queryCache</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryCache</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">StatementCache</span> <span class="variable">preparedStatements</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StatementCache</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; List&lt;T&gt; <span class="title function_">executeOptimizedQuery</span><span class="params">(String sql, Class&lt;T&gt; resultType, Object... params)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. Check query cache first</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">cacheKey</span> <span class="operator">=</span> generateCacheKey(sql, params);</span><br><span class="line">        List&lt;T&gt; cached = queryCache.get(cacheKey);</span><br><span class="line">        <span class="keyword">if</span> (cached != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> cached;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. Use prepared statement cache</span></span><br><span class="line">        <span class="type">PreparedStatement</span> <span class="variable">stmt</span> <span class="operator">=</span> preparedStatements.get(sql);</span><br><span class="line">        <span class="keyword">if</span> (stmt == <span class="literal">null</span>) &#123;</span><br><span class="line">            stmt = getConnection().prepareStatement(sql);</span><br><span class="line">            preparedStatements.put(sql, stmt);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. Execute with parameters</span></span><br><span class="line">        setParameters(stmt, params);</span><br><span class="line">        List&lt;T&gt; results = executeAndMap(stmt, resultType);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. Cache results if appropriate</span></span><br><span class="line">        <span class="keyword">if</span> (isCacheable(sql)) &#123;</span><br><span class="line">            queryCache.put(cacheKey, results, getCacheTTL(sql));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> results;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Connection-Pool-Monitoring"><a href="#Connection-Pool-Monitoring" class="headerlink" title="Connection Pool Monitoring"></a>Connection Pool Monitoring</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PoolMonitor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 30000)</span> <span class="comment">// Every 30 seconds</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">monitorPools</span><span class="params">()</span> &#123;</span><br><span class="line">        tenantPools.forEach((tenantId, pool) -&gt; &#123;</span><br><span class="line">            <span class="type">HikariPoolMXBean</span> <span class="variable">mxBean</span> <span class="operator">=</span> pool.getHikariPoolMXBean();</span><br><span class="line">            </span><br><span class="line">            <span class="type">PoolMetrics</span> <span class="variable">metrics</span> <span class="operator">=</span> PoolMetrics.builder()</span><br><span class="line">                .tenantId(tenantId)</span><br><span class="line">                .activeConnections(mxBean.getActiveConnections())</span><br><span class="line">                .idleConnections(mxBean.getIdleConnections())</span><br><span class="line">                .totalConnections(mxBean.getTotalConnections())</span><br><span class="line">                .threadsAwaitingConnection(mxBean.getThreadsAwaitingConnection())</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Check for potential issues</span></span><br><span class="line">            <span class="keyword">if</span> (metrics.getThreadsAwaitingConnection() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                alertingService.sendAlert(</span><br><span class="line">                    <span class="string">&quot;Connection pool exhaustion detected for tenant: &quot;</span> + tenantId);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (metrics.getActiveConnections() &gt; (metrics.getTotalConnections() * <span class="number">0.8</span>)) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;High connection usage for tenant &#123;&#125;: &#123;&#125;%&quot;</span>, </span><br><span class="line">                    tenantId, (metrics.getActiveConnections() * <span class="number">100</span> / metrics.getTotalConnections()));</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            metricsCollector.record(metrics);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Discuss how to balance between connection pool efficiency and memory usage. Explain the trade-offs between having many small pools vs. fewer large pools.</em></p>
<hr>
<h2 id="Security-Isolation"><a href="#Security-Isolation" class="headerlink" title="Security &amp; Isolation"></a>Security &amp; Isolation</h2><h3 id="Tenant-Isolation-Strategies"><a href="#Tenant-Isolation-Strategies" class="headerlink" title="Tenant Isolation Strategies"></a>Tenant Isolation Strategies</h3><pre>
<code class="mermaid">
graph TB
subgraph &quot;Isolation Levels&quot;
    A[Database Level&lt;br&#x2F;&gt;Separate DB per tenant]
    B[Schema Level&lt;br&#x2F;&gt;Separate schema per tenant]
    C[Row Level&lt;br&#x2F;&gt;Tenant ID in each row]
end

subgraph &quot;Security Measures&quot;
    D[Connection Encryption]
    E[Access Control Lists]
    F[Query Validation]
    G[Audit Logging]
end

A --&gt; D
B --&gt; E
C --&gt; F
A --&gt; G
B --&gt; G
C --&gt; G
</code>
</pre>

<h3 id="Security-Implementation"><a href="#Security-Implementation" class="headerlink" title="Security Implementation"></a>Security Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">validateTenantAccess</span><span class="params">(String tenantId, String userId)</span> &#123;</span><br><span class="line">        <span class="type">TenantAccessControl</span> <span class="variable">acl</span> <span class="operator">=</span> getTenantACL(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!acl.hasAccess(userId)) &#123;</span><br><span class="line">            auditLogger.logUnauthorizedAccess(tenantId, userId);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnauthorizedAccessException</span>(<span class="string">&quot;User &quot;</span> + userId + </span><br><span class="line">                <span class="string">&quot; does not have access to tenant &quot;</span> + tenantId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sanitizeQuery</span><span class="params">(String sql)</span> &#123;</span><br><span class="line">        <span class="comment">// Prevent SQL injection</span></span><br><span class="line">        <span class="keyword">if</span> (containsDangerousPatterns(sql)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;Potentially dangerous SQL detected&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Ensure tenant context is properly applied</span></span><br><span class="line">        <span class="keyword">if</span> (!containsTenantFilter(sql)) &#123;</span><br><span class="line">            sql = addTenantFilter(sql);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> sql;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">containsDangerousPatterns</span><span class="params">(String sql)</span> &#123;</span><br><span class="line">        String[] dangerousPatterns = &#123;</span><br><span class="line">            <span class="string">&quot;DROP\\s+TABLE&quot;</span>, <span class="string">&quot;DELETE\\s+FROM.*WHERE\\s+1=1&quot;</span>, </span><br><span class="line">            <span class="string">&quot;UNION\\s+SELECT&quot;</span>, <span class="string">&quot;INTO\\s+OUTFILE&quot;</span></span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> Arrays.stream(dangerousPatterns)</span><br><span class="line">            .anyMatch(pattern -&gt; sql.toUpperCase().matches(<span class="string">&quot;.*&quot;</span> + pattern + <span class="string">&quot;.*&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Discuss the CAP theorem implications for multi-tenant databases and how to choose between consistency, availability, and partition tolerance based on business requirements.</em></p>
<hr>
<h2 id="Monitoring-Observability"><a href="#Monitoring-Observability" class="headerlink" title="Monitoring &amp; Observability"></a>Monitoring &amp; Observability</h2><h3 id="Metrics-Collection"><a href="#Metrics-Collection" class="headerlink" title="Metrics Collection"></a>Metrics Collection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseMetricsCollector</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Timer&gt; queryTimers = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordQueryExecution</span><span class="params">(String tenantId, String queryType, Duration duration)</span> &#123;</span><br><span class="line">        <span class="type">Timer</span> <span class="variable">timer</span> <span class="operator">=</span> Timer.builder(<span class="string">&quot;database.query.duration&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;tenant&quot;</span>, tenantId)</span><br><span class="line">            .tag(<span class="string">&quot;query_type&quot;</span>, queryType)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">        </span><br><span class="line">        timer.record(duration);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordConnectionPoolMetrics</span><span class="params">(String tenantId, PoolMetrics metrics)</span> &#123;</span><br><span class="line">        Gauge.builder(<span class="string">&quot;database.pool.active_connections&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;tenant&quot;</span>, tenantId)</span><br><span class="line">            .register(meterRegistry, metrics, PoolMetrics::getActiveConnections);</span><br><span class="line">            </span><br><span class="line">        Gauge.builder(<span class="string">&quot;database.pool.idle_connections&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;tenant&quot;</span>, tenantId)</span><br><span class="line">            .register(meterRegistry, metrics, PoolMetrics::getIdleConnections);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Health-Checks"><a href="#Health-Checks" class="headerlink" title="Health Checks"></a>Health Checks</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseHealthIndicator</span> <span class="keyword">implements</span> <span class="title class_">HealthIndicator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Health <span class="title function_">health</span><span class="params">()</span> &#123;</span><br><span class="line">        Health.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Health</span>.Builder();</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, Object&gt; details = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">allHealthy</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String tenantId : tenantRegistry.getAllTenantIds()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">healthy</span> <span class="operator">=</span> checkTenantHealth(tenantId);</span><br><span class="line">                details.put(<span class="string">&quot;tenant_&quot;</span> + tenantId, healthy ? <span class="string">&quot;UP&quot;</span> : <span class="string">&quot;DOWN&quot;</span>);</span><br><span class="line">                allHealthy = allHealthy &amp;&amp; healthy;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                details.put(<span class="string">&quot;tenant_&quot;</span> + tenantId, <span class="string">&quot;ERROR: &quot;</span> + e.getMessage());</span><br><span class="line">                allHealthy = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        details.put(<span class="string">&quot;total_tenants&quot;</span>, tenantRegistry.getTenantCount());</span><br><span class="line">        details.put(<span class="string">&quot;healthy_tenants&quot;</span>, details.values().stream()</span><br><span class="line">            .mapToInt(v -&gt; <span class="string">&quot;UP&quot;</span>.equals(v) ? <span class="number">1</span> : <span class="number">0</span>).sum());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> allHealthy ? builder.up().withDetails(details).build() </span><br><span class="line">                         : builder.down().withDetails(details).build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkTenantHealth</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> connectionManager.getConnection(tenantId)) &#123;</span><br><span class="line">            <span class="keyword">return</span> conn.isValid(<span class="number">5</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Explain how to implement circuit breakers for database connections and discuss strategies for graceful degradation when database issues occur.</em></p>
<hr>
<h2 id="Best-Practices-Patterns"><a href="#Best-Practices-Patterns" class="headerlink" title="Best Practices &amp; Patterns"></a>Best Practices &amp; Patterns</h2><h3 id="Configuration-Management"><a href="#Configuration-Management" class="headerlink" title="Configuration Management"></a>Configuration Management</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.yml</span></span><br><span class="line"><span class="attr">database-sdk:</span></span><br><span class="line">  <span class="attr">default-provider:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">connection-pools:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">maximum-pool-size:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">minimum-idle:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">connection-timeout:</span> <span class="number">30000</span></span><br><span class="line">      <span class="attr">idle-timeout:</span> <span class="number">600000</span></span><br><span class="line">      <span class="attr">max-lifetime:</span> <span class="number">1800000</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">tenant-tiers:</span></span><br><span class="line">    <span class="attr">basic:</span></span><br><span class="line">      <span class="attr">max-connections:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">connection-timeout:</span> <span class="number">10000</span></span><br><span class="line">    <span class="attr">premium:</span></span><br><span class="line">      <span class="attr">max-connections:</span> <span class="number">20</span></span><br><span class="line">      <span class="attr">connection-timeout:</span> <span class="number">30000</span></span><br><span class="line">    <span class="attr">enterprise:</span></span><br><span class="line">      <span class="attr">max-connections:</span> <span class="number">50</span></span><br><span class="line">      <span class="attr">connection-timeout:</span> <span class="number">60000</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">providers:</span></span><br><span class="line">    <span class="attr">mysql:</span></span><br><span class="line">      <span class="attr">driver-class:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">      <span class="attr">validation-query:</span> <span class="string">&quot;SELECT 1&quot;</span></span><br><span class="line">      <span class="attr">properties:</span></span><br><span class="line">        <span class="attr">cachePrepStmts:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">prepStmtCacheSize:</span> <span class="number">250</span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">postgresql:</span></span><br><span class="line">      <span class="attr">driver-class:</span> <span class="string">org.postgresql.Driver</span></span><br><span class="line">      <span class="attr">validation-query:</span> <span class="string">&quot;SELECT 1&quot;</span></span><br><span class="line">      <span class="attr">properties:</span></span><br><span class="line">        <span class="attr">prepareThreshold:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">preparedStatementCacheQueries:</span> <span class="number">256</span></span><br></pre></td></tr></table></figure>

<h3 id="Error-Handling-Strategy"><a href="#Error-Handling-Strategy" class="headerlink" title="Error Handling Strategy"></a>Error Handling Strategy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseExceptionHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleException</span><span class="params">(Exception e, String operation, String tenantId)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> SQLException) &#123;</span><br><span class="line">            <span class="type">SQLException</span> <span class="variable">sqlEx</span> <span class="operator">=</span> (SQLException) e;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">switch</span> (sqlEx.getErrorCode()) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1062</span>: <span class="comment">// MySQL duplicate key</span></span><br><span class="line">                <span class="keyword">case</span> <span class="number">23505</span>: <span class="comment">// PostgreSQL unique violation</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DuplicateKeyException</span>(<span class="string">&quot;Duplicate key violation&quot;</span>, sqlEx);</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> <span class="number">1205</span>: <span class="comment">// MySQL lock timeout</span></span><br><span class="line">                <span class="keyword">case</span> 55P03: <span class="comment">// PostgreSQL lock timeout  </span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LockTimeoutException</span>(<span class="string">&quot;Database lock timeout&quot;</span>, sqlEx);</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">case</span> <span class="number">2006</span>: <span class="comment">// MySQL server gone away</span></span><br><span class="line">                <span class="keyword">case</span> 57P01: <span class="comment">// PostgreSQL connection failure</span></span><br><span class="line">                    handleConnectionFailure(tenantId, sqlEx);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    log.error(<span class="string">&quot;Unhandled SQL exception for tenant &#123;&#125;: &#123;&#125;&quot;</span>, </span><br><span class="line">                        tenantId, sqlEx.getMessage(), sqlEx);</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DatabaseException</span>(<span class="string">&quot;Database operation failed&quot;</span>, sqlEx);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Handle other exception types</span></span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ConnectionPoolException) &#123;</span><br><span class="line">            handlePoolExhaustion(tenantId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleConnectionFailure</span><span class="params">(String tenantId, SQLException e)</span> &#123;</span><br><span class="line">        <span class="comment">// Mark connection pool as unhealthy</span></span><br><span class="line">        connectionManager.markPoolUnhealthy(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Trigger reconnection attempt</span></span><br><span class="line">        scheduledExecutor.schedule(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                connectionManager.validateAndRepairPool(tenantId);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;Failed to repair connection pool for tenant: &quot;</span> + tenantId, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DatabaseConnectionException</span>(<span class="string">&quot;Database connection failed&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Discuss the importance of proper exception handling in database layers and how it affects the overall system reliability. Mention strategies for handling transient vs. permanent failures.</em></p>
<hr>
<h2 id="Testing-Strategy"><a href="#Testing-Strategy" class="headerlink" title="Testing Strategy"></a>Testing Strategy</h2><h3 id="Unit-Testing"><a href="#Unit-Testing" class="headerlink" title="Unit Testing"></a>Unit Testing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExtendWith(MockitoExtension.class)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DatabaseSDKTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> TenantConnectionManager connectionManager;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> TenantRegistry tenantRegistry;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@InjectMocks</span></span><br><span class="line">    <span class="keyword">private</span> DatabaseSDKImpl databaseSDK;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldCreateTenantSuccessfully</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Given</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> <span class="string">&quot;test-tenant&quot;</span>;</span><br><span class="line">        <span class="type">DatabaseConfig</span> <span class="variable">config</span> <span class="operator">=</span> DatabaseConfig.builder()</span><br><span class="line">            .provider(<span class="string">&quot;mysql&quot;</span>)</span><br><span class="line">            .host(<span class="string">&quot;localhost&quot;</span>)</span><br><span class="line">            .port(<span class="number">3306</span>)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">when</span>(tenantRegistry.getTenantConfig(tenantId)).thenReturn(<span class="literal">null</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When</span></span><br><span class="line">        <span class="type">TenantContext</span> <span class="variable">context</span> <span class="operator">=</span> databaseSDK.createTenant(tenantId, config);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Then</span></span><br><span class="line">        assertThat(context.getTenantId()).isEqualTo(tenantId);</span><br><span class="line">        verify(connectionManager).createTenantPool(eq(tenantId), any(DatabaseConfig.class));</span><br><span class="line">        verify(tenantRegistry).registerTenant(eq(tenantId), any(TenantConfig.class));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldSwitchTenantSuccessfully</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Given</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> <span class="string">&quot;existing-tenant&quot;</span>;</span><br><span class="line">        <span class="type">TenantConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TenantConfig</span>(tenantId, mock(DatabaseConfig.class));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">when</span>(tenantRegistry.getTenantConfig(tenantId)).thenReturn(config);</span><br><span class="line">        <span class="keyword">when</span>(connectionManager.hasPool(tenantId)).thenReturn(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">when</span>(connectionManager.getConnection()).thenReturn(mock(Connection.class));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> databaseSDK.switchToTenant(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Then</span></span><br><span class="line">        assertThat(result).isTrue();</span><br><span class="line">        verify(connectionManager).switchTenant(tenantId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Integration-Testing"><a href="#Integration-Testing" class="headerlink" title="Integration Testing"></a>Integration Testing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TestContainers</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DatabaseSDKIntegrationTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Container</span></span><br><span class="line">    <span class="keyword">static</span> MySQLContainer&lt;?&gt; mysql = <span class="keyword">new</span> <span class="title class_">MySQLContainer</span>&lt;&gt;(<span class="string">&quot;mysql:8.0&quot;</span>)</span><br><span class="line">            .withDatabaseName(<span class="string">&quot;test_db&quot;</span>)</span><br><span class="line">            .withUsername(<span class="string">&quot;test&quot;</span>)</span><br><span class="line">            .withPassword(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Container</span></span><br><span class="line">    <span class="keyword">static</span> PostgreSQLContainer&lt;?&gt; postgres = <span class="keyword">new</span> <span class="title class_">PostgreSQLContainer</span>&lt;&gt;(<span class="string">&quot;postgres:13&quot;</span>)</span><br><span class="line">            .withDatabaseName(<span class="string">&quot;test_db&quot;</span>)</span><br><span class="line">            .withUsername(<span class="string">&quot;test&quot;</span>)</span><br><span class="line">            .withPassword(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DatabaseSDK databaseSDK;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldWorkWithMySQLProvider</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Given</span></span><br><span class="line">        <span class="type">DatabaseConfig</span> <span class="variable">config</span> <span class="operator">=</span> DatabaseConfig.builder()</span><br><span class="line">            .provider(<span class="string">&quot;mysql&quot;</span>)</span><br><span class="line">            .jdbcUrl(mysql.getJdbcUrl())</span><br><span class="line">            .username(mysql.getUsername())</span><br><span class="line">            .password(mysql.getPassword())</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When</span></span><br><span class="line">        <span class="type">TenantContext</span> <span class="variable">context</span> <span class="operator">=</span> databaseSDK.createTenant(<span class="string">&quot;mysql-tenant&quot;</span>, config);</span><br><span class="line">        databaseSDK.switchToTenant(<span class="string">&quot;mysql-tenant&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Then</span></span><br><span class="line">        databaseSDK.createTable(<span class="string">&quot;users&quot;</span>, UserTableSchema.create());</span><br><span class="line">        </span><br><span class="line">        List&lt;String&gt; tables = databaseSDK.query()</span><br><span class="line">            .select(<span class="string">&quot;table_name&quot;</span>)</span><br><span class="line">            .from(<span class="string">&quot;information_schema.tables&quot;</span>)</span><br><span class="line">            .where(<span class="string">&quot;table_schema = ?&quot;</span>, <span class="string">&quot;test_db&quot;</span>)</span><br><span class="line">            .executeList(String.class);</span><br><span class="line">        </span><br><span class="line">        assertThat(tables).contains(<span class="string">&quot;users&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Emphasize the importance of testing with real databases using testcontainers. Discuss how to create comprehensive test suites that cover both happy path and failure scenarios, including network partitions and database failovers.</em></p>
<hr>
<h2 id="Deployment-Operations"><a href="#Deployment-Operations" class="headerlink" title="Deployment &amp; Operations"></a>Deployment &amp; Operations</h2><h3 id="Deployment-Architecture"><a href="#Deployment-Architecture" class="headerlink" title="Deployment Architecture"></a>Deployment Architecture</h3><pre>
<code class="mermaid">
graph TB
subgraph &quot;Load Balancer&quot;
    LB[Application Load Balancer]
end

subgraph &quot;Application Tier&quot;
    A1[App Instance 1&lt;br&#x2F;&gt;Database SDK]
    A2[App Instance 2&lt;br&#x2F;&gt;Database SDK]
    A3[App Instance N&lt;br&#x2F;&gt;Database SDK]
end

subgraph &quot;Database Tier&quot;
    subgraph &quot;MySQL Cluster&quot;
        M1[(MySQL Master)]
        M2[(MySQL Replica 1)]
        M3[(MySQL Replica 2)]
    end
    
    subgraph &quot;PostgreSQL Cluster&quot;
        P1[(PostgreSQL Master)]
        P2[(PostgreSQL Replica 1)]
        P3[(PostgreSQL Replica 2)]
    end
end

subgraph &quot;Configuration&quot;
    C1[Config Server]
    C2[Service Discovery]
    C3[Tenant Registry]
end

LB --&gt; A1
LB --&gt; A2
LB --&gt; A3

A1 --&gt; M1
A1 --&gt; P1
A2 --&gt; M1
A2 --&gt; P1
A3 --&gt; M1
A3 --&gt; P1

M1 --&gt; M2
M1 --&gt; M3
P1 --&gt; P2
P1 --&gt; P3

A1 --&gt; C1
A2 --&gt; C2
A3 --&gt; C3
</code>
</pre>

<h3 id="Configuration-Management-1"><a href="#Configuration-Management-1" class="headerlink" title="Configuration Management"></a>Configuration Management</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(DatabaseSDKProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseSDKAutoConfiguration</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> DatabaseSDK <span class="title function_">databaseSDK</span><span class="params">(DatabaseSDKProperties properties)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DatabaseSDKBuilder.builder()</span><br><span class="line">            .withProperties(properties)</span><br><span class="line">            .withProviders(discoverProviders())</span><br><span class="line">            .withMetrics(meterRegistry())</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TenantConnectionManager <span class="title function_">tenantConnectionManager</span><span class="params">(</span></span><br><span class="line"><span class="params">            DatabaseSDKProperties properties)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TenantConnectionManager</span>(properties.getConnectionPools());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DatabaseHealthIndicator <span class="title function_">databaseHealthIndicator</span><span class="params">(</span></span><br><span class="line"><span class="params">            DatabaseSDK databaseSDK)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DatabaseHealthIndicator</span>(databaseSDK);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> List&lt;DatabaseProvider&gt; <span class="title function_">discoverProviders</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ServiceLoader.load(DatabaseProvider.class)</span><br><span class="line">            .stream()</span><br><span class="line">            .map(ServiceLoader.Provider::get)</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Graceful-Shutdown"><a href="#Graceful-Shutdown" class="headerlink" title="Graceful Shutdown"></a>Graceful Shutdown</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseSDKShutdownHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TenantConnectionManager connectionManager;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PreDestroy</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;Initiating graceful database SDK shutdown...&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. Stop accepting new connections</span></span><br><span class="line">            connectionManager.stopAcceptingNewConnections();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. Wait for active transactions to complete</span></span><br><span class="line">            waitForActiveTransactions(Duration.ofSeconds(<span class="number">30</span>));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 3. Close all connection pools</span></span><br><span class="line">            connectionManager.closeAllPools();</span><br><span class="line">            </span><br><span class="line">            log.info(<span class="string">&quot;Database SDK shutdown completed successfully&quot;</span>);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Error during database SDK shutdown&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">waitForActiveTransactions</span><span class="params">(Duration timeout)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis() + timeout.toMillis();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> (System.currentTimeMillis() &lt; endTime) &#123;</span><br><span class="line">            <span class="keyword">if</span> (connectionManager.getActiveTransactionCount() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Discuss the importance of graceful shutdown in distributed systems. Explain how improper shutdown can lead to data corruption or transaction rollbacks.</em></p>
<hr>
<h2 id="Scalability-Considerations"><a href="#Scalability-Considerations" class="headerlink" title="Scalability Considerations"></a>Scalability Considerations</h2><h3 id="Horizontal-Scaling-Strategy"><a href="#Horizontal-Scaling-Strategy" class="headerlink" title="Horizontal Scaling Strategy"></a>Horizontal Scaling Strategy</h3><pre>
<code class="mermaid">
flowchart TD
A[Incoming Request] --&gt; B{Load Balancer}
B --&gt; C[App Instance 1]
B --&gt; D[App Instance 2]
B --&gt; E[App Instance N]

C --&gt; F{Tenant Router}
D --&gt; F
E --&gt; F

F --&gt; G[Tenant Shard 1&lt;br&#x2F;&gt;MySQL]
F --&gt; H[Tenant Shard 2&lt;br&#x2F;&gt;PostgreSQL]
F --&gt; I[Tenant Shard N&lt;br&#x2F;&gt;Mixed]

J[Tenant Registry] --&gt; F
K[Shard Manager] --&gt; F
</code>
</pre>

<h3 id="Sharding-Implementation"><a href="#Sharding-Implementation" class="headerlink" title="Sharding Implementation"></a>Sharding Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantShardManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ShardConfiguration&gt; shardConfigurations;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConsistentHashRing&lt;String&gt; hashRing;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TenantShardManager</span><span class="params">(List&lt;ShardConfiguration&gt; shards)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.shardConfigurations = shards.stream()</span><br><span class="line">            .collect(Collectors.toMap(ShardConfiguration::getShardId, Function.identity()));</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">this</span>.hashRing = <span class="keyword">new</span> <span class="title class_">ConsistentHashRing</span>&lt;&gt;(</span><br><span class="line">            shards.stream().map(ShardConfiguration::getShardId).collect(Collectors.toList()),</span><br><span class="line">            <span class="number">160</span> <span class="comment">// virtual nodes per shard</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getShardForTenant</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> hashRing.get(tenantId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addShard</span><span class="params">(ShardConfiguration shard)</span> &#123;</span><br><span class="line">        shardConfigurations.put(shard.getShardId(), shard);</span><br><span class="line">        hashRing.add(shard.getShardId());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Trigger rebalancing if needed</span></span><br><span class="line">        scheduleRebalancing();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeShard</span><span class="params">(String shardId)</span> &#123;</span><br><span class="line">        <span class="type">ShardConfiguration</span> <span class="variable">shard</span> <span class="operator">=</span> shardConfigurations.remove(shardId);</span><br><span class="line">        <span class="keyword">if</span> (shard != <span class="literal">null</span>) &#123;</span><br><span class="line">            hashRing.remove(shardId);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Migrate tenants to other shards</span></span><br><span class="line">            migrateTenants(shardId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">migrateTenants</span><span class="params">(String fromShard)</span> &#123;</span><br><span class="line">        List&lt;String&gt; tenantsToMigrate = getTenantsByShardId(fromShard);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String tenantId : tenantsToMigrate) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">newShard</span> <span class="operator">=</span> getShardForTenant(tenantId);</span><br><span class="line">            migrateTenant(tenantId, fromShard, newShard);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Read-Replica-Support"><a href="#Read-Replica-Support" class="headerlink" title="Read Replica Support"></a>Read Replica Support</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReadWriteSplitConnectionManager</span> <span class="keyword">extends</span> <span class="title class_">TenantConnectionManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, List&lt;HikariDataSource&gt;&gt; readReplicas = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LoadBalancer&lt;HikariDataSource&gt; replicaLoadBalancer;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Connection <span class="title function_">getConnection</span><span class="params">(AccessType accessType)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> getCurrentTenantId();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (accessType == AccessType.READ_ONLY) &#123;</span><br><span class="line">            <span class="keyword">return</span> getReadOnlyConnection(tenantId);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> getWriteConnection(tenantId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Connection <span class="title function_">getReadOnlyConnection</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        List&lt;HikariDataSource&gt; replicas = readReplicas.get(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (replicas == <span class="literal">null</span> || replicas.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// Fallback to master if no replicas available</span></span><br><span class="line">            <span class="keyword">return</span> getWriteConnection(tenantId);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">HikariDataSource</span> <span class="variable">selectedReplica</span> <span class="operator">=</span> replicaLoadBalancer.select(replicas);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> selectedReplica.getConnection();</span><br><span class="line">            conn.setReadOnly(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> conn;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="comment">// If replica fails, fallback to master</span></span><br><span class="line">            log.warn(<span class="string">&quot;Failed to get read replica connection for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">            <span class="keyword">return</span> getWriteConnection(tenantId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addReadReplica</span><span class="params">(String tenantId, DatabaseConfig replicaConfig)</span> &#123;</span><br><span class="line">        <span class="type">HikariDataSource</span> <span class="variable">replicaPool</span> <span class="operator">=</span> createDataSource(replicaConfig);</span><br><span class="line">        </span><br><span class="line">        readReplicas.computeIfAbsent(tenantId, k -&gt; <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;()).add(replicaPool);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Health check for the new replica</span></span><br><span class="line">        scheduleHealthCheck(tenantId, replicaPool);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Explain the CAP theorem implications when designing read replicas. Discuss eventual consistency vs. strong consistency trade-offs and when to use each approach.</em></p>
<hr>
<h2 id="Advanced-Features"><a href="#Advanced-Features" class="headerlink" title="Advanced Features"></a>Advanced Features</h2><h3 id="Query-Result-Caching"><a href="#Query-Result-Caching" class="headerlink" title="Query Result Caching"></a>Query Result Caching</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueryCacheManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Cache&lt;String, CachedResult&gt; cache;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> QueryAnalyzer queryAnalyzer;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">QueryCacheManager</span><span class="params">(CacheConfiguration config)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cache = Caffeine.newBuilder()</span><br><span class="line">            .maximumSize(config.getMaxSize())</span><br><span class="line">            .expireAfterWrite(config.getTtl())</span><br><span class="line">            .recordStats()</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">this</span>.queryAnalyzer = <span class="keyword">new</span> <span class="title class_">QueryAnalyzer</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; List&lt;T&gt; <span class="title function_">executeWithCache</span><span class="params">(String sql, Class&lt;T&gt; resultType, Object... params)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!queryAnalyzer.isCacheable(sql)) &#123;</span><br><span class="line">            <span class="keyword">return</span> executeDirectly(sql, resultType, params);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">cacheKey</span> <span class="operator">=</span> generateCacheKey(sql, params);</span><br><span class="line">        <span class="type">CachedResult</span> <span class="variable">cached</span> <span class="operator">=</span> cache.getIfPresent(cacheKey);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (cached != <span class="literal">null</span> &amp;&amp; !cached.isExpired()) &#123;</span><br><span class="line">            cacheHitCounter.increment();</span><br><span class="line">            <span class="keyword">return</span> (List&lt;T&gt;) cached.getResults();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        List&lt;T&gt; results = executeDirectly(sql, resultType, params);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Cache the results</span></span><br><span class="line">        cache.put(cacheKey, <span class="keyword">new</span> <span class="title class_">CachedResult</span>(results, System.currentTimeMillis()));</span><br><span class="line">        cacheMissCounter.increment();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> results;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invalidateCache</span><span class="params">(String pattern)</span> &#123;</span><br><span class="line">        <span class="comment">// Invalidate cache entries matching the pattern</span></span><br><span class="line">        cache.asMap().keySet().stream()</span><br><span class="line">            .filter(key -&gt; key.matches(pattern))</span><br><span class="line">            .forEach(cache::invalidate);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Smart cache invalidation based on table changes</span></span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleTableModification</span><span class="params">(TableModificationEvent event)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tableName</span> <span class="operator">=</span> event.getTableName();</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> event.getTenantId();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Invalidate all cache entries for this table and tenant</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">pattern</span> <span class="operator">=</span> String.format(<span class="string">&quot;.*%s.*%s.*&quot;</span>, tenantId, tableName);</span><br><span class="line">        invalidateCache(pattern);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Database-Connection-Failover"><a href="#Database-Connection-Failover" class="headerlink" title="Database Connection Failover"></a>Database Connection Failover</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FailoverConnectionManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, DatabaseCluster&gt; clusters = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CircuitBreakerRegistry circuitBreakerRegistry;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Connection <span class="title function_">getConnection</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="type">DatabaseCluster</span> <span class="variable">cluster</span> <span class="operator">=</span> clusters.get(tenantId);</span><br><span class="line">        <span class="keyword">if</span> (cluster == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;No cluster found for tenant: &quot;</span> + tenantId);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Try primary first</span></span><br><span class="line">        <span class="type">CircuitBreaker</span> <span class="variable">primaryCircuitBreaker</span> <span class="operator">=</span> circuitBreakerRegistry</span><br><span class="line">            .circuitBreaker(<span class="string">&quot;primary-&quot;</span> + tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> primaryCircuitBreaker.executeSupplier(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> cluster.getPrimaryDataSource().getConnection();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DatabaseConnectionException</span>(<span class="string">&quot;Primary connection failed&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).recover(throwable -&gt; &#123;</span><br><span class="line">            <span class="comment">// Failover to secondary</span></span><br><span class="line">            log.warn(<span class="string">&quot;Primary database failed for tenant &#123;&#125;, failing over to secondary&quot;</span>, </span><br><span class="line">                tenantId, throwable);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> getSecondaryConnection(cluster);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Connection <span class="title function_">getSecondaryConnection</span><span class="params">(DatabaseCluster cluster)</span> &#123;</span><br><span class="line">        List&lt;HikariDataSource&gt; secondaries = cluster.getSecondaryDataSources();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (HikariDataSource secondary : secondaries) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> secondary.getConnection();</span><br><span class="line">                <span class="keyword">if</span> (conn.isValid(<span class="number">5</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> conn;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;Secondary database connection failed&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DatabaseConnectionException</span>(<span class="string">&quot;All database connections failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 30000)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">healthCheck</span><span class="params">()</span> &#123;</span><br><span class="line">        clusters.forEach((tenantId, cluster) -&gt; &#123;</span><br><span class="line">            checkClusterHealth(tenantId, cluster);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkClusterHealth</span><span class="params">(String tenantId, DatabaseCluster cluster)</span> &#123;</span><br><span class="line">        <span class="comment">// Check primary health</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">primaryHealthy</span> <span class="operator">=</span> checkDataSourceHealth(cluster.getPrimaryDataSource());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!primaryHealthy) &#123;</span><br><span class="line">            <span class="comment">// Try to recover primary</span></span><br><span class="line">            tryRecoverPrimary(tenantId, cluster);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check secondary health</span></span><br><span class="line">        cluster.getSecondaryDataSources().forEach(secondary -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (!checkDataSourceHealth(secondary)) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;Secondary database unhealthy for tenant: &#123;&#125;&quot;</span>, tenantId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Multi-Region-Support"><a href="#Multi-Region-Support" class="headerlink" title="Multi-Region Support"></a>Multi-Region Support</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiRegionDatabaseManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, RegionConfig&gt; regions;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TenantRegionMapper tenantRegionMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createTenantInRegion</span><span class="params">(String tenantId, String regionId, DatabaseConfig config)</span> &#123;</span><br><span class="line">        <span class="type">RegionConfig</span> <span class="variable">region</span> <span class="operator">=</span> regions.get(regionId);</span><br><span class="line">        <span class="keyword">if</span> (region == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unknown region: &quot;</span> + regionId);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Create database in the specified region</span></span><br><span class="line">        <span class="type">DatabaseProvider</span> <span class="variable">provider</span> <span class="operator">=</span> getProviderForRegion(regionId, config.getProvider());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Adjust config for region-specific settings</span></span><br><span class="line">        <span class="type">DatabaseConfig</span> <span class="variable">regionConfig</span> <span class="operator">=</span> config.toBuilder()</span><br><span class="line">            .host(region.getDatabaseHost())</span><br><span class="line">            .port(region.getDatabasePort())</span><br><span class="line">            .additionalProperties(region.getProviderProperties())</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Create tenant database</span></span><br><span class="line">        createTenantDatabase(tenantId, regionConfig, provider);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Register tenant-region mapping</span></span><br><span class="line">        tenantRegionMapper.mapTenantToRegion(tenantId, regionId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Setup cross-region replication if required</span></span><br><span class="line">        <span class="keyword">if</span> (config.isReplicationEnabled()) &#123;</span><br><span class="line">            setupCrossRegionReplication(tenantId, regionId, config);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Connection <span class="title function_">getConnection</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">regionId</span> <span class="operator">=</span> tenantRegionMapper.getRegionForTenant(tenantId);</span><br><span class="line">        <span class="keyword">if</span> (regionId == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;No region mapping found for tenant: &quot;</span> + tenantId);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> getConnectionForRegion(tenantId, regionId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setupCrossRegionReplication</span><span class="params">(String tenantId, String primaryRegion, </span></span><br><span class="line"><span class="params">                                           DatabaseConfig config)</span> &#123;</span><br><span class="line">        List&lt;String&gt; replicaRegions = config.getReplicaRegions();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String replicaRegion : replicaRegions) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!replicaRegion.equals(primaryRegion)) &#123;</span><br><span class="line">                createReplicaInRegion(tenantId, primaryRegion, replicaRegion);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Discuss data sovereignty and compliance requirements when implementing multi-region support. Explain how GDPR, data residency laws, and cross-border data transfer regulations affect database architecture decisions.</em></p>
<hr>
<h2 id="Interview-Questions-Answers"><a href="#Interview-Questions-Answers" class="headerlink" title="Interview Questions &amp; Answers"></a>Interview Questions &amp; Answers</h2><h3 id="Architecture-Design-Questions"><a href="#Architecture-Design-Questions" class="headerlink" title="Architecture &amp; Design Questions"></a>Architecture &amp; Design Questions</h3><p><strong>Q: How would you handle database schema evolution across multiple tenants?</strong></p>
<p><strong>A:</strong> I would implement a versioned migration system with the following approach:</p>
<ol>
<li><strong>Migration Versioning</strong>: Each migration has a version number and is applied in order</li>
<li><strong>Tenant-Specific Tracking</strong>: Track migration status per tenant in a dedicated <code>schema_migrations</code> table</li>
<li><strong>Rollback Support</strong>: Design migrations to be reversible when possible</li>
<li><strong>Batch Processing</strong>: Apply migrations to tenants in batches to avoid overwhelming the system</li>
<li><strong>Validation</strong>: Validate schema consistency after migrations complete</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Example migration tracking</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MigrationTracker</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">trackMigration</span><span class="params">(String tenantId, String version, MigrationStatus status)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;INSERT INTO schema_migrations (tenant_id, version, status, applied_at) VALUES (?, ?, ?, ?)&quot;</span>;</span><br><span class="line">        executeUpdate(sql, tenantId, version, status.name(), Timestamp.now());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Q: How do you prevent connection pool exhaustion in a multi-tenant environment?</strong></p>
<p><strong>A:</strong> Several strategies can be employed:</p>
<ol>
<li><strong>Tier-based Pool Sizing</strong>: Different tenant tiers get different pool sizes</li>
<li><strong>Dynamic Pool Adjustment</strong>: Monitor usage patterns and adjust pool sizes</li>
<li><strong>Connection Timeouts</strong>: Set appropriate timeouts to prevent connection leaks</li>
<li><strong>Circuit Breakers</strong>: Implement circuit breakers to fail fast when pools are exhausted</li>
<li><strong>Monitoring &amp; Alerting</strong>: Set up alerts for high pool utilization</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Example dynamic pool adjustment</span></span><br><span class="line"><span class="meta">@Scheduled(fixedRate = 60000)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">adjustPoolSizes</span><span class="params">()</span> &#123;</span><br><span class="line">    tenantPools.forEach((tenantId, pool) -&gt; &#123;</span><br><span class="line">        <span class="type">PoolMetrics</span> <span class="variable">metrics</span> <span class="operator">=</span> getPoolMetrics(pool);</span><br><span class="line">        <span class="keyword">if</span> (metrics.getUtilization() &gt; <span class="number">0.8</span>) &#123;</span><br><span class="line">            scaleUpPool(tenantId, pool);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (metrics.getUtilization() &lt; <span class="number">0.2</span>) &#123;</span><br><span class="line">            scaleDownPool(tenantId, pool);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Performance-Scalability-Questions"><a href="#Performance-Scalability-Questions" class="headerlink" title="Performance &amp; Scalability Questions"></a>Performance &amp; Scalability Questions</h3><p><strong>Q: How would you optimize database queries across different database providers?</strong></p>
<p><strong>A:</strong> Query optimization requires a multi-layered approach:</p>
<ol>
<li><strong>Provider-Specific Optimizations</strong>: Each database provider has its own optimizer hints and features</li>
<li><strong>Query Analysis</strong>: Analyze query patterns to identify optimization opportunities</li>
<li><strong>Index Management</strong>: Automatically suggest and create indexes based on query patterns</li>
<li><strong>Query Rewriting</strong>: Transform queries to use database-specific optimizations</li>
<li><strong>Caching Strategy</strong>: Implement intelligent caching at multiple levels</li>
</ol>
<p><strong>Q: How do you handle database failover without losing data?</strong></p>
<p><strong>A:</strong> Implement a robust failover mechanism:</p>
<ol>
<li><strong>Synchronous Replication</strong>: Use synchronous replication for critical data</li>
<li><strong>Health Monitoring</strong>: Continuous health checks with rapid failure detection</li>
<li><strong>Automatic Failover</strong>: Implement automatic failover with proper coordination</li>
<li><strong>Connection Draining</strong>: Gracefully drain connections during failover</li>
<li><strong>Consistency Checks</strong>: Verify data consistency after failover</li>
</ol>
<h3 id="Security-Compliance-Questions"><a href="#Security-Compliance-Questions" class="headerlink" title="Security &amp; Compliance Questions"></a>Security &amp; Compliance Questions</h3><p><strong>Q: How do you ensure tenant data isolation in a shared database environment?</strong></p>
<p><strong>A:</strong> Multiple isolation strategies can be implemented:</p>
<ol>
<li><strong>Database-Level Isolation</strong>: Separate databases per tenant (strongest isolation)</li>
<li><strong>Schema-Level Isolation</strong>: Separate schemas within the same database</li>
<li><strong>Row-Level Security</strong>: Use database row-level security features</li>
<li><strong>Application-Level Filtering</strong>: Ensure all queries include tenant filters</li>
<li><strong>Access Control</strong>: Implement strict access controls and audit logging</li>
</ol>
<p><strong>Q: How would you implement audit logging for compliance requirements?</strong></p>
<p><strong>A:</strong> Comprehensive audit logging includes:</p>
<ol>
<li><strong>Data Access Logging</strong>: Log all data access with user context</li>
<li><strong>Schema Change Tracking</strong>: Track all DDL operations</li>
<li><strong>Connection Logging</strong>: Log connection events and authentication</li>
<li><strong>Query Logging</strong>: Log sensitive query operations</li>
<li><strong>Tamper-Proof Storage</strong>: Store audit logs in immutable storage</li>
</ol>
<hr>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>This Database SDK design provides a comprehensive solution for multi-tenant SaaS applications with the following key benefits:</p>
<h3 id="Key-Advantages"><a href="#Key-Advantages" class="headerlink" title="Key Advantages"></a>Key Advantages</h3><ol>
<li><strong>Flexibility</strong>: Support for multiple database providers through SPI</li>
<li><strong>Scalability</strong>: Horizontal scaling through sharding and connection pooling</li>
<li><strong>Isolation</strong>: Strong tenant isolation with multiple strategies</li>
<li><strong>Performance</strong>: Optimized connection management and query caching</li>
<li><strong>Observability</strong>: Comprehensive monitoring and health checking</li>
<li><strong>Reliability</strong>: Failover support and graceful degradation</li>
</ol>
<h3 id="Implementation-Roadmap"><a href="#Implementation-Roadmap" class="headerlink" title="Implementation Roadmap"></a>Implementation Roadmap</h3><p><strong>Phase 1: Core Infrastructure</strong></p>
<ul>
<li>Implement basic SDK structure and SPI framework</li>
<li>Create MySQL and PostgreSQL providers</li>
<li>Set up connection pooling and tenant management</li>
</ul>
<p><strong>Phase 2: Advanced Features</strong></p>
<ul>
<li>Add migration engine and schema management</li>
<li>Implement query optimization and caching</li>
<li>Add monitoring and health checks</li>
</ul>
<p><strong>Phase 3: Enterprise Features</strong></p>
<ul>
<li>Implement sharding and multi-region support</li>
<li>Add advanced security features</li>
<li>Complete performance optimization</li>
</ul>
<p><strong>Phase 4: Operations &amp; Maintenance</strong></p>
<ul>
<li>Automated deployment and configuration</li>
<li>Advanced monitoring and alerting</li>
<li>Documentation and training</li>
</ul>
<h3 id="Success-Metrics"><a href="#Success-Metrics" class="headerlink" title="Success Metrics"></a>Success Metrics</h3><ul>
<li><strong>Performance</strong>: Sub-100ms query response times</li>
<li><strong>Scalability</strong>: Support for 10,000+ concurrent tenants</li>
<li><strong>Reliability</strong>: 99.9% uptime with automatic failover</li>
<li><strong>Security</strong>: Zero data breaches with complete audit trails</li>
</ul>
<p>This architecture provides a solid foundation for building scalable, secure, and maintainable multi-tenant database solutions that can grow with your SaaS platform’s needs.</p>
<hr>
<p><em>This document serves as a comprehensive guide for implementing a production-ready Database SDK. Each section can be expanded based on specific requirements and constraints of your particular use case.</em></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/system-design/" rel="tag"># system-design</a>
              <a href="/tags/async-invocation/" rel="tag"># async invocation</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/06/13/Design-Async-Invocation-SDK/" rel="prev" title="Design Async Invocation SDK">
                  <i class="fa fa-angle-left"></i> Design Async Invocation SDK
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Charlie Feng</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
