<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"shayne007.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="System OverviewThe privilege system combines Role-Based Access Control (RBAC) with Attribute-Based Access Control (ABAC) to provide fine-grained authorization capabilities. This hybrid approach levera">
<meta property="og:type" content="article">
<meta property="og:title" content="Design Privilege Systems: RBAC + ABAC Integration Guide">
<meta property="og:url" content="https://shayne007.github.io/2025/06/12/Design-Privilege-Systems-RBAC-ABAC-Integration-Guide/index.html">
<meta property="og:site_name" content="Charlie Feng&#39;s Tech Space">
<meta property="og:description" content="System OverviewThe privilege system combines Role-Based Access Control (RBAC) with Attribute-Based Access Control (ABAC) to provide fine-grained authorization capabilities. This hybrid approach levera">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-06-12T09:52:06.000Z">
<meta property="article:modified_time" content="2025-06-30T12:45:47.126Z">
<meta property="article:author" content="Charlie Feng">
<meta property="article:tag" content="system-design">
<meta property="article:tag" content="privilege system">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://shayne007.github.io/2025/06/12/Design-Privilege-Systems-RBAC-ABAC-Integration-Guide/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://shayne007.github.io/2025/06/12/Design-Privilege-Systems-RBAC-ABAC-Integration-Guide/","path":"2025/06/12/Design-Privilege-Systems-RBAC-ABAC-Integration-Guide/","title":"Design Privilege Systems: RBAC + ABAC Integration Guide"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Design Privilege Systems: RBAC + ABAC Integration Guide | Charlie Feng's Tech Space</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"cdn":false,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.5.0/mermaid.min.js","integrity":"sha256-2obLuIPcceEhkE3G09G33hBdmE55ivVcZUlcKcGNHjU="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>





  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Charlie Feng's Tech Space</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">You will survive with skills</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#System-Overview"><span class="nav-number">1.</span> <span class="nav-text">System Overview</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Architecture-Components"><span class="nav-number">2.</span> <span class="nav-text">Architecture Components</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#PrivilegeService-Backend-Core"><span class="nav-number">2.1.</span> <span class="nav-text">PrivilegeService (Backend Core)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PrivilegeWebUI-Administrative-Interface"><span class="nav-number">2.2.</span> <span class="nav-text">PrivilegeWebUI (Administrative Interface)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PrivilegeFilterSDK-Integration-Component"><span class="nav-number">2.3.</span> <span class="nav-text">PrivilegeFilterSDK (Integration Component)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Three-Tier-Caching-Architecture"><span class="nav-number">3.</span> <span class="nav-text">Three-Tier Caching Architecture</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Layer-1-Local-Cache-Caffeine"><span class="nav-number">3.1.</span> <span class="nav-text">Layer 1: Local Cache (Caffeine)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Layer-2-Distributed-Cache-Redis"><span class="nav-number">3.2.</span> <span class="nav-text">Layer 2: Distributed Cache (Redis)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Layer-3-Database-PostgreSQL"><span class="nav-number">3.3.</span> <span class="nav-text">Layer 3: Database (PostgreSQL)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Database-Design"><span class="nav-number">4.</span> <span class="nav-text">Database Design</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Schema-Overview"><span class="nav-number">4.1.</span> <span class="nav-text">Schema Overview</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Detailed-Table-Schemas"><span class="nav-number">4.2.</span> <span class="nav-text">Detailed Table Schemas</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Indexing-Strategy"><span class="nav-number">4.3.</span> <span class="nav-text">Indexing Strategy</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RBAC-Engine-Implementation"><span class="nav-number">5.</span> <span class="nav-text">RBAC Engine Implementation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Role-Hierarchy-Support"><span class="nav-number">5.1.</span> <span class="nav-text">Role Hierarchy Support</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ABAC-Engine-Implementation"><span class="nav-number">6.</span> <span class="nav-text">ABAC Engine Implementation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Policy-Structure"><span class="nav-number">6.1.</span> <span class="nav-text">Policy Structure</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Policy-Evaluation-Engine"><span class="nav-number">6.2.</span> <span class="nav-text">Policy Evaluation Engine</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Security-Considerations"><span class="nav-number">7.</span> <span class="nav-text">Security Considerations</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Principle-of-Least-Privilege"><span class="nav-number">7.1.</span> <span class="nav-text">Principle of Least Privilege</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Audit-and-Compliance"><span class="nav-number">7.2.</span> <span class="nav-text">Audit and Compliance</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Performance-Optimization"><span class="nav-number">8.</span> <span class="nav-text">Performance Optimization</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Batch-Processing-for-Role-Assignments"><span class="nav-number">8.1.</span> <span class="nav-text">Batch Processing for Role Assignments</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Query-Optimization"><span class="nav-number">8.2.</span> <span class="nav-text">Query Optimization</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Monitoring-and-Observability"><span class="nav-number">9.</span> <span class="nav-text">Monitoring and Observability</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Metrics-Collection"><span class="nav-number">9.1.</span> <span class="nav-text">Metrics Collection</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Health-Checks"><span class="nav-number">9.2.</span> <span class="nav-text">Health Checks</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Testing-Strategy"><span class="nav-number">10.</span> <span class="nav-text">Testing Strategy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Unit-Testing"><span class="nav-number">10.1.</span> <span class="nav-text">Unit Testing</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Integration-Testing"><span class="nav-number">10.2.</span> <span class="nav-text">Integration Testing</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Deployment-Considerations"><span class="nav-number">11.</span> <span class="nav-text">Deployment Considerations</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Kubernetes-Deployment"><span class="nav-number">11.1.</span> <span class="nav-text">Kubernetes Deployment</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Database-Migration-Strategy"><span class="nav-number">11.2.</span> <span class="nav-text">Database Migration Strategy</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Real-World-Use-Cases"><span class="nav-number">12.</span> <span class="nav-text">Real-World Use Cases</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Enterprise-SaaS-Platform"><span class="nav-number">12.1.</span> <span class="nav-text">Enterprise SaaS Platform</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Healthcare-System-HIPAA-Compliance"><span class="nav-number">12.2.</span> <span class="nav-text">Healthcare System HIPAA Compliance</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Financial-Services-Regulatory-Compliance"><span class="nav-number">12.3.</span> <span class="nav-text">Financial Services Regulatory Compliance</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Advanced-Features"><span class="nav-number">13.</span> <span class="nav-text">Advanced Features</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Dynamic-Permission-Discovery"><span class="nav-number">13.1.</span> <span class="nav-text">Dynamic Permission Discovery</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Policy-Templates"><span class="nav-number">13.2.</span> <span class="nav-text">Policy Templates</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Machine-Learning-Integration"><span class="nav-number">13.3.</span> <span class="nav-text">Machine Learning Integration</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Performance-Benchmarks"><span class="nav-number">14.</span> <span class="nav-text">Performance Benchmarks</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Load-Testing-Results"><span class="nav-number">14.1.</span> <span class="nav-text">Load Testing Results</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Memory-Usage-Optimization"><span class="nav-number">14.2.</span> <span class="nav-text">Memory Usage Optimization</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Interview-Questions-and-Answers"><span class="nav-number">15.</span> <span class="nav-text">Interview Questions and Answers</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Architecture-Questions"><span class="nav-number">15.1.</span> <span class="nav-text">Architecture Questions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Security-Questions"><span class="nav-number">15.2.</span> <span class="nav-text">Security Questions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Performance-Questions"><span class="nav-number">15.3.</span> <span class="nav-text">Performance Questions</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Troubleshooting-Guide"><span class="nav-number">16.</span> <span class="nav-text">Troubleshooting Guide</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Common-Issues-and-Solutions"><span class="nav-number">16.1.</span> <span class="nav-text">Common Issues and Solutions</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#External-Resources"><span class="nav-number">17.</span> <span class="nav-text">External Resources</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Standards-and-Specifications"><span class="nav-number">17.1.</span> <span class="nav-text">Standards and Specifications</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Implementation-References"><span class="nav-number">17.2.</span> <span class="nav-text">Implementation References</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Performance-and-Monitoring"><span class="nav-number">17.3.</span> <span class="nav-text">Performance and Monitoring</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Charlie Feng</p>
  <div class="site-description" itemprop="description">This place is for thinking and sharing.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">50</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/12/Design-Privilege-Systems-RBAC-ABAC-Integration-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Design Privilege Systems: RBAC + ABAC Integration Guide | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Design Privilege Systems: RBAC + ABAC Integration Guide
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-12 17:52:06" itemprop="dateCreated datePublished" datetime="2025-06-12T17:52:06+08:00">2025-06-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-30 20:45:47" itemprop="dateModified" datetime="2025-06-30T20:45:47+08:00">2025-06-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system-design/" itemprop="url" rel="index"><span itemprop="name">system-design</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="System-Overview"><a href="#System-Overview" class="headerlink" title="System Overview"></a>System Overview</h2><p>The privilege system combines Role-Based Access Control (RBAC) with Attribute-Based Access Control (ABAC) to provide fine-grained authorization capabilities. This hybrid approach leverages the simplicity of RBAC for common scenarios while utilizing ABAC’s flexibility for complex, context-aware access decisions.</p>
<pre>
<code class="mermaid">
flowchart TB
A[Client Request] --&gt; B[PrivilegeFilterSDK]
B --&gt; C{Cache Check}
C --&gt;|Hit| D[Return Cached Result]
C --&gt;|Miss| E[PrivilegeService]
E --&gt; F[RBAC Engine]
E --&gt; G[ABAC Engine]
F --&gt; H[Role Evaluation]
G --&gt; I[Attribute Evaluation]
H --&gt; J[Access Decision]
I --&gt; J
J --&gt; K[Update Cache]
K --&gt; L[Return Result]

M[PrivilegeWebUI] --&gt; E
N[Database] --&gt; E
O[Redis Cache] --&gt; C
P[Local Cache] --&gt; C
</code>
</pre>

<p><strong>Interview Question</strong>: <em>Why combine RBAC and ABAC instead of using one approach?</em></p>
<p><strong>Answer</strong>: RBAC provides simplicity and performance for common role-based scenarios (90% of use cases), while ABAC handles complex, context-dependent decisions (10% of use cases). This hybrid approach balances performance, maintainability, and flexibility. Pure ABAC would be overkill for simple role checks, while pure RBAC lacks the granularity needed for dynamic, context-aware decisions.</p>
<h2 id="Architecture-Components"><a href="#Architecture-Components" class="headerlink" title="Architecture Components"></a>Architecture Components</h2><h3 id="PrivilegeService-Backend-Core"><a href="#PrivilegeService-Backend-Core" class="headerlink" title="PrivilegeService (Backend Core)"></a>PrivilegeService (Backend Core)</h3><p>The PrivilegeService acts as the central authority for all privilege-related operations, implementing both RBAC and ABAC engines.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrivilegeService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RbacEngine rbacEngine;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AbacEngine abacEngine;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PrivilegeCacheManager cacheManager;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> AccessDecision <span class="title function_">evaluateAccess</span><span class="params">(AccessRequest request)</span> &#123;</span><br><span class="line">        <span class="comment">// Check cache first</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">cacheKey</span> <span class="operator">=</span> generateCacheKey(request);</span><br><span class="line">        <span class="type">AccessDecision</span> <span class="variable">cached</span> <span class="operator">=</span> cacheManager.get(cacheKey);</span><br><span class="line">        <span class="keyword">if</span> (cached != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> cached;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// RBAC evaluation (fast path)</span></span><br><span class="line">        <span class="type">AccessDecision</span> <span class="variable">rbacDecision</span> <span class="operator">=</span> rbacEngine.evaluate(request);</span><br><span class="line">        <span class="keyword">if</span> (rbacDecision.isExplicitDeny()) &#123;</span><br><span class="line">            cacheManager.put(cacheKey, rbacDecision, <span class="number">300</span>); <span class="comment">// 5 min cache</span></span><br><span class="line">            <span class="keyword">return</span> rbacDecision;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ABAC evaluation (context-aware path)</span></span><br><span class="line">        <span class="type">AccessDecision</span> <span class="variable">abacDecision</span> <span class="operator">=</span> abacEngine.evaluate(request);</span><br><span class="line">        <span class="type">AccessDecision</span> <span class="variable">finalDecision</span> <span class="operator">=</span> combineDecisions(rbacDecision, abacDecision);</span><br><span class="line">        </span><br><span class="line">        cacheManager.put(cacheKey, finalDecision, <span class="number">300</span>);</span><br><span class="line">        <span class="keyword">return</span> finalDecision;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Key APIs</strong>:</p>
<ul>
<li><code>POST /api/v1/privileges/evaluate</code> - Evaluate access permissions</li>
<li><code>GET /api/v1/roles/&#123;userId&#125;</code> - Get user roles</li>
<li><code>POST /api/v1/roles/&#123;userId&#125;</code> - Assign roles to user</li>
<li><code>GET /api/v1/permissions/&#123;roleId&#125;</code> - Get role permissions</li>
<li><code>POST /api/v1/policies</code> - Create ABAC policies</li>
</ul>
<h3 id="PrivilegeWebUI-Administrative-Interface"><a href="#PrivilegeWebUI-Administrative-Interface" class="headerlink" title="PrivilegeWebUI (Administrative Interface)"></a>PrivilegeWebUI (Administrative Interface)</h3><p>A React-based administrative interface for managing users, roles, and permissions.</p>
<pre>
<code class="mermaid">
graph LR
A[User Management] --&gt; B[Role Assignment]
B --&gt; C[Permission Matrix]
C --&gt; D[Policy Editor]
D --&gt; E[Audit Logs]

F[Dashboard] --&gt; G[Real-time Metrics]
G --&gt; H[Access Patterns]
H --&gt; I[Security Alerts]
</code>
</pre>

<p><strong>Key Features</strong>:</p>
<ul>
<li><strong>User Management</strong>: Search, filter, and manage user accounts</li>
<li><strong>Role Matrix</strong>: Visual representation of role-permission mappings</li>
<li><strong>Policy Builder</strong>: Drag-and-drop interface for creating ABAC policies</li>
<li><strong>Audit Dashboard</strong>: Real-time access logs and security metrics</li>
<li><strong>Bulk Operations</strong>: Import&#x2F;export users and roles via CSV</li>
</ul>
<p><strong>Use Case Example</strong>: An administrator needs to grant temporary access to a contractor for a specific project. Using the WebUI, they can:</p>
<ol>
<li>Create a time-bound role “Project_Contractor_Q2”</li>
<li>Assign specific permissions (read project files, submit reports)</li>
<li>Set expiration date and IP restrictions</li>
<li>Monitor access patterns through the dashboard</li>
</ol>
<h3 id="PrivilegeFilterSDK-Integration-Component"><a href="#PrivilegeFilterSDK-Integration-Component" class="headerlink" title="PrivilegeFilterSDK (Integration Component)"></a>PrivilegeFilterSDK (Integration Component)</h3><p>A lightweight SDK that integrates with microservices to provide seamless privilege checking.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrivilegeFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PrivilegeClient privilegeClient;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, </span></span><br><span class="line"><span class="params">                        FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">httpRequest</span> <span class="operator">=</span> (HttpServletRequest) request;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Extract user context</span></span><br><span class="line">        <span class="type">UserContext</span> <span class="variable">userContext</span> <span class="operator">=</span> extractUserContext(httpRequest);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Build access request</span></span><br><span class="line">        <span class="type">AccessRequest</span> <span class="variable">accessRequest</span> <span class="operator">=</span> AccessRequest.builder()</span><br><span class="line">            .userId(userContext.getUserId())</span><br><span class="line">            .resource(httpRequest.getRequestURI())</span><br><span class="line">            .action(httpRequest.getMethod())</span><br><span class="line">            .environment(buildEnvironmentAttributes(httpRequest))</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check privileges</span></span><br><span class="line">        <span class="type">AccessDecision</span> <span class="variable">decision</span> <span class="operator">=</span> privilegeClient.evaluateAccess(accessRequest);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (decision.isPermitted()) &#123;</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sendUnauthorizedResponse(response, decision.getReason());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; <span class="title function_">buildEnvironmentAttributes</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Map.of(</span><br><span class="line">            <span class="string">&quot;ip_address&quot;</span>, getClientIP(request),</span><br><span class="line">            <span class="string">&quot;user_agent&quot;</span>, request.getHeader(<span class="string">&quot;User-Agent&quot;</span>),</span><br><span class="line">            <span class="string">&quot;time_of_day&quot;</span>, LocalTime.now().getHour(),</span><br><span class="line">            <span class="string">&quot;request_size&quot;</span>, request.getContentLength()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Question</strong>: <em>How do you handle the performance impact of privilege checking on every request?</em></p>
<p><strong>Answer</strong>: We implement a three-tier caching strategy: local cache (L1) for frequently accessed decisions, Redis (L2) for shared cache across instances, and database (L3) as the source of truth. Additionally, we use async batch loading for role hierarchies and implement circuit breakers to fail-open during service degradation.</p>
<h2 id="Three-Tier-Caching-Architecture"><a href="#Three-Tier-Caching-Architecture" class="headerlink" title="Three-Tier Caching Architecture"></a>Three-Tier Caching Architecture</h2><pre>
<code class="mermaid">
flowchart TD
A[Request] --&gt; B[L1: Local Cache]
B --&gt;|Miss| C[L2: Redis Cache]
C --&gt;|Miss| D[L3: Database]
D --&gt; E[Privilege Calculation]
E --&gt; F[Update All Cache Layers]
F --&gt; G[Return Result]

H[Cache Invalidation] --&gt; I[Event-Driven Updates]
I --&gt; J[L1 Invalidation]
I --&gt; K[L2 Invalidation]
</code>
</pre>

<h3 id="Layer-1-Local-Cache-Caffeine"><a href="#Layer-1-Local-Cache-Caffeine" class="headerlink" title="Layer 1: Local Cache (Caffeine)"></a>Layer 1: Local Cache (Caffeine)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LocalCacheConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Cache&lt;String, AccessDecision&gt; <span class="title function_">localPrivilegeCache</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Caffeine.newBuilder()</span><br><span class="line">            .maximumSize(<span class="number">10000</span>)</span><br><span class="line">            .expireAfterWrite(Duration.ofMinutes(<span class="number">5</span>))</span><br><span class="line">            .recordStats()</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Characteristics</strong>:</p>
<ul>
<li><strong>Capacity</strong>: 10,000 entries per instance</li>
<li><strong>TTL</strong>: 5 minutes</li>
<li><strong>Hit Ratio</strong>: ~85% for frequent operations</li>
<li><strong>Latency</strong>: &lt;1ms</li>
</ul>
<h3 id="Layer-2-Distributed-Cache-Redis"><a href="#Layer-2-Distributed-Cache-Redis" class="headerlink" title="Layer 2: Distributed Cache (Redis)"></a>Layer 2: Distributed Cache (Redis)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisPrivilegeCache</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, AccessDecision&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cacheUserRoles</span><span class="params">(String userId, Set&lt;Role&gt; roles)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;user:roles:&quot;</span> + userId;</span><br><span class="line">        redisTemplate.opsForValue().set(key, roles, Duration.ofMinutes(<span class="number">30</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invalidateUserCache</span><span class="params">(String userId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">pattern</span> <span class="operator">=</span> <span class="string">&quot;user:*:&quot;</span> + userId;</span><br><span class="line">        Set&lt;String&gt; keys = redisTemplate.keys(pattern);</span><br><span class="line">        <span class="keyword">if</span> (!keys.isEmpty()) &#123;</span><br><span class="line">            redisTemplate.delete(keys);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Characteristics</strong>:</p>
<ul>
<li><strong>Capacity</strong>: 1M entries cluster-wide</li>
<li><strong>TTL</strong>: 30 minutes</li>
<li><strong>Hit Ratio</strong>: ~70% for cache misses from L1</li>
<li><strong>Latency</strong>: 1-5ms</li>
</ul>
<h3 id="Layer-3-Database-PostgreSQL"><a href="#Layer-3-Database-PostgreSQL" class="headerlink" title="Layer 3: Database (PostgreSQL)"></a>Layer 3: Database (PostgreSQL)</h3><p>Persistent storage with optimized queries and indexing strategies.</p>
<p><strong>Performance Metrics</strong>:</p>
<ul>
<li><strong>Overall Cache Hit Ratio</strong>: 95%</li>
<li><strong>Average Response Time</strong>: 2ms (cached), 50ms (uncached)</li>
<li><strong>Throughput</strong>: 10,000 requests&#x2F;second per instance</li>
</ul>
<h2 id="Database-Design"><a href="#Database-Design" class="headerlink" title="Database Design"></a>Database Design</h2><h3 id="Schema-Overview"><a href="#Schema-Overview" class="headerlink" title="Schema Overview"></a>Schema Overview</h3><pre>
<code class="mermaid">
erDiagram
USER {
    uuid id PK
    string username UK
    string email UK
    timestamp created_at
    timestamp updated_at
    boolean is_active
}

ROLE {
    uuid id PK
    string name UK
    string description
    json attributes
    timestamp created_at
    boolean is_active
}

PERMISSION {
    uuid id PK
    string name UK
    string resource
    string action
    json constraints
}

USER_ROLE {
    uuid user_id FK
    uuid role_id FK
    timestamp assigned_at
    timestamp expires_at
    string assigned_by
}

ROLE_PERMISSION {
    uuid role_id FK
    uuid permission_id FK
}

ABAC_POLICY {
    uuid id PK
    string name UK
    json policy_document
    integer priority
    boolean is_active
    timestamp created_at
}

PRIVILEGE_AUDIT {
    uuid id PK
    uuid user_id FK
    string resource
    string action
    string decision
    json context
    timestamp timestamp
}

USER ||--o{ USER_ROLE : has
ROLE ||--o{ USER_ROLE : assigned_to
ROLE ||--o{ ROLE_PERMISSION : has
PERMISSION ||--o{ ROLE_PERMISSION : granted_by
</code>
</pre>

<h3 id="Detailed-Table-Schemas"><a href="#Detailed-Table-Schemas" class="headerlink" title="Detailed Table Schemas"></a>Detailed Table Schemas</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Users table with audit fields</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    id UUID <span class="keyword">PRIMARY KEY</span> <span class="keyword">DEFAULT</span> gen_random_uuid(),</span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">UNIQUE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">UNIQUE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    password_hash <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    last_login <span class="type">TIMESTAMP</span>,</span><br><span class="line">    is_active <span class="type">BOOLEAN</span> <span class="keyword">DEFAULT</span> <span class="literal">true</span>,</span><br><span class="line">    attributes JSONB <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#123;&#125;&#x27;</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> users_username_check <span class="keyword">CHECK</span> (length(username) <span class="operator">&gt;=</span> <span class="number">3</span>),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> users_email_check <span class="keyword">CHECK</span> (email <span class="operator">~</span><span class="operator">*</span> <span class="string">&#x27;^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]&#123;2,&#125;$&#x27;</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Roles table with hierarchical support</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> roles (</span><br><span class="line">    id UUID <span class="keyword">PRIMARY KEY</span> <span class="keyword">DEFAULT</span> gen_random_uuid(),</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">UNIQUE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    description TEXT,</span><br><span class="line">    parent_role_id UUID <span class="keyword">REFERENCES</span> roles(id),</span><br><span class="line">    attributes JSONB <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#123;&#125;&#x27;</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    is_active <span class="type">BOOLEAN</span> <span class="keyword">DEFAULT</span> <span class="literal">true</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> roles_name_check <span class="keyword">CHECK</span> (length(name) <span class="operator">&gt;=</span> <span class="number">2</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Permissions with resource-action pattern</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> permissions (</span><br><span class="line">    id UUID <span class="keyword">PRIMARY KEY</span> <span class="keyword">DEFAULT</span> gen_random_uuid(),</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">UNIQUE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    resource <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    action <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    constraints JSONB <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#123;&#125;&#x27;</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    <span class="keyword">UNIQUE</span>(resource, action)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- User-Role assignments with temporal constraints</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> user_roles (</span><br><span class="line">    user_id UUID <span class="keyword">NOT NULL</span> <span class="keyword">REFERENCES</span> users(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE,</span><br><span class="line">    role_id UUID <span class="keyword">NOT NULL</span> <span class="keyword">REFERENCES</span> roles(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE,</span><br><span class="line">    assigned_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    expires_at <span class="type">TIMESTAMP</span>,</span><br><span class="line">    assigned_by UUID <span class="keyword">REFERENCES</span> users(id),</span><br><span class="line">    is_active <span class="type">BOOLEAN</span> <span class="keyword">DEFAULT</span> <span class="literal">true</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (user_id, role_id),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> user_roles_expiry_check <span class="keyword">CHECK</span> (expires_at <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">OR</span> expires_at <span class="operator">&gt;</span> assigned_at)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ABAC Policies</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> abac_policies (</span><br><span class="line">    id UUID <span class="keyword">PRIMARY KEY</span> <span class="keyword">DEFAULT</span> gen_random_uuid(),</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">UNIQUE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    policy_document JSONB <span class="keyword">NOT NULL</span>,</span><br><span class="line">    priority <span class="type">INTEGER</span> <span class="keyword">DEFAULT</span> <span class="number">100</span>,</span><br><span class="line">    is_active <span class="type">BOOLEAN</span> <span class="keyword">DEFAULT</span> <span class="literal">true</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    created_by UUID <span class="keyword">REFERENCES</span> users(id),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> abac_policies_priority_check <span class="keyword">CHECK</span> (priority <span class="operator">&gt;=</span> <span class="number">0</span> <span class="keyword">AND</span> priority <span class="operator">&lt;=</span> <span class="number">1000</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Performance-optimized audit table</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> privilege_audit (</span><br><span class="line">    id UUID <span class="keyword">PRIMARY KEY</span> <span class="keyword">DEFAULT</span> gen_random_uuid(),</span><br><span class="line">    user_id UUID <span class="keyword">NOT NULL</span> <span class="keyword">REFERENCES</span> users(id),</span><br><span class="line">    resource <span class="type">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    action <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    decision <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> <span class="keyword">CHECK</span> (decision <span class="keyword">IN</span> (<span class="string">&#x27;PERMIT&#x27;</span>, <span class="string">&#x27;DENY&#x27;</span>, <span class="string">&#x27;INDETERMINATE&#x27;</span>)),</span><br><span class="line">    context JSONB <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#123;&#125;&#x27;</span>,</span><br><span class="line">    <span class="type">timestamp</span> <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    processing_time_ms <span class="type">INTEGER</span></span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span> (<span class="type">timestamp</span>);</span><br></pre></td></tr></table></figure>

<h3 id="Indexing-Strategy"><a href="#Indexing-Strategy" class="headerlink" title="Indexing Strategy"></a>Indexing Strategy</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Primary lookup indexes</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_users_username <span class="keyword">ON</span> users(username);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_users_email <span class="keyword">ON</span> users(email);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_users_active <span class="keyword">ON</span> users(is_active) <span class="keyword">WHERE</span> is_active <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Role hierarchy and permissions</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_roles_parent <span class="keyword">ON</span> roles(parent_role_id);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_user_roles_user <span class="keyword">ON</span> user_roles(user_id);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_user_roles_active <span class="keyword">ON</span> user_roles(user_id, is_active) <span class="keyword">WHERE</span> is_active <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_role_permissions_role <span class="keyword">ON</span> role_permissions(role_id);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ABAC policy lookup</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_abac_policies_active <span class="keyword">ON</span> abac_policies(is_active, priority) <span class="keyword">WHERE</span> is_active <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Audit queries</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_audit_user_time <span class="keyword">ON</span> privilege_audit(user_id, <span class="type">timestamp</span> <span class="keyword">DESC</span>);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_audit_resource <span class="keyword">ON</span> privilege_audit(resource, <span class="type">timestamp</span> <span class="keyword">DESC</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Composite indexes for complex queries</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_user_roles_expiry <span class="keyword">ON</span> user_roles(user_id, expires_at) </span><br><span class="line">    <span class="keyword">WHERE</span> expires_at <span class="keyword">IS</span> <span class="keyword">NOT NULL</span> <span class="keyword">AND</span> expires_at <span class="operator">&gt;</span> <span class="built_in">CURRENT_TIMESTAMP</span>;</span><br></pre></td></tr></table></figure>

<h2 id="RBAC-Engine-Implementation"><a href="#RBAC-Engine-Implementation" class="headerlink" title="RBAC Engine Implementation"></a>RBAC Engine Implementation</h2><h3 id="Role-Hierarchy-Support"><a href="#Role-Hierarchy-Support" class="headerlink" title="Role Hierarchy Support"></a>Role Hierarchy Support</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RbacEngine</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Set&lt;Role&gt; <span class="title function_">getEffectiveRoles</span><span class="params">(String userId)</span> &#123;</span><br><span class="line">        Set&lt;Role&gt; directRoles = userRoleRepository.findActiveRolesByUserId(userId);</span><br><span class="line">        Set&lt;Role&gt; allRoles = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(directRoles);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Resolve role hierarchy</span></span><br><span class="line">        <span class="keyword">for</span> (Role role : directRoles) &#123;</span><br><span class="line">            allRoles.addAll(getParentRoles(role));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> allRoles;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Set&lt;Role&gt; <span class="title function_">getParentRoles</span><span class="params">(Role role)</span> &#123;</span><br><span class="line">        Set&lt;Role&gt; parents = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Role</span> <span class="variable">current</span> <span class="operator">=</span> role;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> (current.getParentRole() != <span class="literal">null</span>) &#123;</span><br><span class="line">            current = current.getParentRole();</span><br><span class="line">            parents.add(current);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> parents;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> AccessDecision <span class="title function_">evaluate</span><span class="params">(AccessRequest request)</span> &#123;</span><br><span class="line">        Set&lt;Role&gt; userRoles = getEffectiveRoles(request.getUserId());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (Role role : userRoles) &#123;</span><br><span class="line">            <span class="keyword">if</span> (roleHasPermission(role, request.getResource(), request.getAction())) &#123;</span><br><span class="line">                <span class="keyword">return</span> AccessDecision.permit(<span class="string">&quot;RBAC: Role &quot;</span> + role.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> AccessDecision.deny(<span class="string">&quot;RBAC: No matching role permissions&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Use Case Example</strong>: In a corporate environment, a “Senior Developer” role inherits permissions from “Developer” role, which inherits from “Employee” role. This hierarchy allows for efficient permission management without duplicating permissions across roles.</p>
<h2 id="ABAC-Engine-Implementation"><a href="#ABAC-Engine-Implementation" class="headerlink" title="ABAC Engine Implementation"></a>ABAC Engine Implementation</h2><h3 id="Policy-Structure"><a href="#Policy-Structure" class="headerlink" title="Policy Structure"></a>Policy Structure</h3><p>ABAC policies are stored as JSON documents following the XACML-inspired structure:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time-based-access-policy&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Business Hours Access Policy&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;target&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;resources&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;api/financial/*&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;GET&quot;</span><span class="punctuation">,</span> <span class="string">&quot;POST&quot;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;business-hours-rule&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Permit&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;condition&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;and&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;timeOfDay&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="string">&quot;09:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;lte&quot;</span><span class="punctuation">:</span> <span class="string">&quot;17:00&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;dayOfWeek&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;in&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;MONDAY&quot;</span><span class="punctuation">,</span> <span class="string">&quot;TUESDAY&quot;</span><span class="punctuation">,</span> <span class="string">&quot;WEDNESDAY&quot;</span><span class="punctuation">,</span> <span class="string">&quot;THURSDAY&quot;</span><span class="punctuation">,</span> <span class="string">&quot;FRIDAY&quot;</span><span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;userAttribute.department&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;equals&quot;</span><span class="punctuation">:</span> <span class="string">&quot;FINANCE&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Policy-Evaluation-Engine"><a href="#Policy-Evaluation-Engine" class="headerlink" title="Policy Evaluation Engine"></a>Policy Evaluation Engine</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AbacEngine</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PolicyRepository policyRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> AccessDecision <span class="title function_">evaluate</span><span class="params">(AccessRequest request)</span> &#123;</span><br><span class="line">        List&lt;AbacPolicy&gt; applicablePolicies = findApplicablePolicies(request);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Sort by priority (higher number = higher priority)</span></span><br><span class="line">        applicablePolicies.sort((p1, p2) -&gt; Integer.compare(p2.getPriority(), p1.getPriority()));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (AbacPolicy policy : applicablePolicies) &#123;</span><br><span class="line">            <span class="type">PolicyDecision</span> <span class="variable">decision</span> <span class="operator">=</span> evaluatePolicy(policy, request);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">switch</span> (decision.getEffect()) &#123;</span><br><span class="line">                <span class="keyword">case</span> PERMIT:</span><br><span class="line">                    <span class="keyword">return</span> AccessDecision.permit(<span class="string">&quot;ABAC: &quot;</span> + policy.getName());</span><br><span class="line">                <span class="keyword">case</span> DENY:</span><br><span class="line">                    <span class="keyword">return</span> AccessDecision.deny(<span class="string">&quot;ABAC: &quot;</span> + policy.getName());</span><br><span class="line">                <span class="keyword">case</span> INDETERMINATE:</span><br><span class="line">                    <span class="keyword">continue</span>; <span class="comment">// Try next policy</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> AccessDecision.deny(<span class="string">&quot;ABAC: No applicable policies&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> PolicyDecision <span class="title function_">evaluatePolicy</span><span class="params">(AbacPolicy policy, AccessRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">PolicyDocument</span> <span class="variable">document</span> <span class="operator">=</span> policy.getPolicyDocument();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Check if policy target matches request</span></span><br><span class="line">            <span class="keyword">if</span> (!matchesTarget(document.getTarget(), request)) &#123;</span><br><span class="line">                <span class="keyword">return</span> PolicyDecision.indeterminate();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Evaluate all rules</span></span><br><span class="line">            <span class="keyword">for</span> (PolicyRule rule : document.getRules()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (evaluateCondition(rule.getCondition(), request)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> PolicyDecision.of(rule.getEffect());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> PolicyDecision.indeterminate();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Error evaluating policy: &quot;</span> + policy.getId(), e);</span><br><span class="line">            <span class="keyword">return</span> PolicyDecision.indeterminate();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Question</strong>: <em>How do you handle policy conflicts in ABAC?</em></p>
<p><strong>Answer</strong>: We use a priority-based approach where policies are evaluated in order of priority. The first policy that returns a definitive decision (PERMIT or DENY) wins. For same-priority policies, we use policy combining algorithms like “deny-overrides” or “permit-overrides” based on the security requirements. We also implement policy validation to detect potential conflicts at creation time.</p>
<h2 id="Security-Considerations"><a href="#Security-Considerations" class="headerlink" title="Security Considerations"></a>Security Considerations</h2><h3 id="Principle-of-Least-Privilege"><a href="#Principle-of-Least-Privilege" class="headerlink" title="Principle of Least Privilege"></a>Principle of Least Privilege</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrivilegeAnalyzer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> PrivilegeAnalysisReport <span class="title function_">analyzeUserPrivileges</span><span class="params">(String userId)</span> &#123;</span><br><span class="line">        Set&lt;Permission&gt; grantedPermissions = getAllUserPermissions(userId);</span><br><span class="line">        Set&lt;Permission&gt; usedPermissions = getUsedPermissions(userId, Duration.ofDays(<span class="number">30</span>));</span><br><span class="line">        </span><br><span class="line">        Set&lt;Permission&gt; unusedPermissions = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(grantedPermissions);</span><br><span class="line">        unusedPermissions.removeAll(usedPermissions);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> PrivilegeAnalysisReport.builder()</span><br><span class="line">            .userId(userId)</span><br><span class="line">            .totalGranted(grantedPermissions.size())</span><br><span class="line">            .totalUsed(usedPermissions.size())</span><br><span class="line">            .unusedPermissions(unusedPermissions)</span><br><span class="line">            .riskScore(calculateRiskScore(unusedPermissions))</span><br><span class="line">            .recommendations(generateRecommendations(unusedPermissions))</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Audit-and-Compliance"><a href="#Audit-and-Compliance" class="headerlink" title="Audit and Compliance"></a>Audit and Compliance</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EventListener</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrivilegeAuditListener</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleAccessDecision</span><span class="params">(AccessDecisionEvent event)</span> &#123;</span><br><span class="line">        <span class="type">PrivilegeAuditRecord</span> <span class="variable">record</span> <span class="operator">=</span> PrivilegeAuditRecord.builder()</span><br><span class="line">            .userId(event.getUserId())</span><br><span class="line">            .resource(event.getResource())</span><br><span class="line">            .action(event.getAction())</span><br><span class="line">            .decision(event.getDecision())</span><br><span class="line">            .context(event.getContext())</span><br><span class="line">            .timestamp(Instant.now())</span><br><span class="line">            .processingTimeMs(event.getProcessingTime())</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        auditRepository.save(record);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Real-time alerting for suspicious activities</span></span><br><span class="line">        <span class="keyword">if</span> (isSuspiciousActivity(record)) &#123;</span><br><span class="line">            alertService.sendSecurityAlert(record);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Optimization"><a href="#Performance-Optimization" class="headerlink" title="Performance Optimization"></a>Performance Optimization</h2><h3 id="Batch-Processing-for-Role-Assignments"><a href="#Batch-Processing-for-Role-Assignments" class="headerlink" title="Batch Processing for Role Assignments"></a>Batch Processing for Role Assignments</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BulkPrivilegeService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bulkAssignRoles</span><span class="params">(List&lt;UserRoleAssignment&gt; assignments)</span> &#123;</span><br><span class="line">        <span class="comment">// Validate all assignments first</span></span><br><span class="line">        validateAssignments(assignments);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Group by user for efficient processing</span></span><br><span class="line">        Map&lt;String, List&lt;UserRoleAssignment&gt;&gt; byUser = assignments.stream()</span><br><span class="line">            .collect(Collectors.groupingBy(UserRoleAssignment::getUserId));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Process in batches to avoid memory issues</span></span><br><span class="line">        Lists.partition(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(byUser.entrySet()), <span class="number">100</span>)</span><br><span class="line">            .forEach(batch -&gt; processBatch(batch));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Invalidate cache for affected users</span></span><br><span class="line">        Set&lt;String&gt; affectedUsers = assignments.stream()</span><br><span class="line">            .map(UserRoleAssignment::getUserId)</span><br><span class="line">            .collect(Collectors.toSet());</span><br><span class="line">        </span><br><span class="line">        cacheManager.invalidateUsers(affectedUsers);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Query-Optimization"><a href="#Query-Optimization" class="headerlink" title="Query Optimization"></a>Query Optimization</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OptimizedUserRoleRepository</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Query(value = &quot;&quot;&quot;</span></span><br><span class="line"><span class="meta">        SELECT r.* FROM roles r</span></span><br><span class="line"><span class="meta">        JOIN user_roles ur ON r.id = ur.role_id</span></span><br><span class="line"><span class="meta">        WHERE ur.user_id = :userId</span></span><br><span class="line"><span class="meta">        AND ur.is_active = true</span></span><br><span class="line"><span class="meta">        AND (ur.expires_at IS NULL OR ur.expires_at &gt; CURRENT_TIMESTAMP)</span></span><br><span class="line"><span class="meta">        AND r.is_active = true</span></span><br><span class="line"><span class="meta">        &quot;&quot;&quot;, nativeQuery = true)</span></span><br><span class="line">    List&lt;Role&gt; <span class="title function_">findActiveRolesByUserId</span><span class="params">(<span class="meta">@Param(&quot;userId&quot;)</span> String userId)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Query(value = &quot;&quot;&quot;</span></span><br><span class="line"><span class="meta">        WITH RECURSIVE role_hierarchy AS (</span></span><br><span class="line"><span class="meta">            SELECT id, name, parent_role_id, 0 as level</span></span><br><span class="line"><span class="meta">            FROM roles</span></span><br><span class="line"><span class="meta">            WHERE id IN :roleIds</span></span><br><span class="line"><span class="meta">            </span></span><br><span class="line"><span class="meta">            UNION ALL</span></span><br><span class="line"><span class="meta">            </span></span><br><span class="line"><span class="meta">            SELECT r.id, r.name, r.parent_role_id, rh.level + 1</span></span><br><span class="line"><span class="meta">            FROM roles r</span></span><br><span class="line"><span class="meta">            JOIN role_hierarchy rh ON r.id = rh.parent_role_id</span></span><br><span class="line"><span class="meta">            WHERE rh.level &lt; 10</span></span><br><span class="line"><span class="meta">        )</span></span><br><span class="line"><span class="meta">        SELECT DISTINCT * FROM role_hierarchy</span></span><br><span class="line"><span class="meta">        &quot;&quot;&quot;, nativeQuery = true)</span></span><br><span class="line">    List&lt;Role&gt; <span class="title function_">findRoleHierarchy</span><span class="params">(<span class="meta">@Param(&quot;roleIds&quot;)</span> Set&lt;String&gt; roleIds)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Monitoring-and-Observability"><a href="#Monitoring-and-Observability" class="headerlink" title="Monitoring and Observability"></a>Monitoring and Observability</h2><h3 id="Metrics-Collection"><a href="#Metrics-Collection" class="headerlink" title="Metrics Collection"></a>Metrics Collection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrivilegeMetrics</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Counter</span> <span class="variable">accessDecisions</span> <span class="operator">=</span> Counter.build()</span><br><span class="line">        .name(<span class="string">&quot;privilege_access_decisions_total&quot;</span>)</span><br><span class="line">        .help(<span class="string">&quot;Total number of access decisions&quot;</span>)</span><br><span class="line">        .labelNames(<span class="string">&quot;decision&quot;</span>, <span class="string">&quot;engine&quot;</span>)</span><br><span class="line">        .register();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Histogram</span> <span class="variable">decisionLatency</span> <span class="operator">=</span> Histogram.build()</span><br><span class="line">        .name(<span class="string">&quot;privilege_decision_duration_seconds&quot;</span>)</span><br><span class="line">        .help(<span class="string">&quot;Time spent on access decisions&quot;</span>)</span><br><span class="line">        .labelNames(<span class="string">&quot;engine&quot;</span>)</span><br><span class="line">        .register();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Gauge</span> <span class="variable">cacheHitRatio</span> <span class="operator">=</span> Gauge.build()</span><br><span class="line">        .name(<span class="string">&quot;privilege_cache_hit_ratio&quot;</span>)</span><br><span class="line">        .help(<span class="string">&quot;Cache hit ratio for privilege decisions&quot;</span>)</span><br><span class="line">        .labelNames(<span class="string">&quot;cache_layer&quot;</span>)</span><br><span class="line">        .register();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordDecision</span><span class="params">(String decision, String engine, Duration duration)</span> &#123;</span><br><span class="line">        accessDecisions.labels(decision, engine).inc();</span><br><span class="line">        decisionLatency.labels(engine).observe(duration.toMillis() / <span class="number">1000.0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Health-Checks"><a href="#Health-Checks" class="headerlink" title="Health Checks"></a>Health Checks</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrivilegeHealthIndicator</span> <span class="keyword">implements</span> <span class="title class_">HealthIndicator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Health <span class="title function_">health</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Check database connectivity</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">dbResponseTime</span> <span class="operator">=</span> measureDatabaseHealth();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Check cache performance</span></span><br><span class="line">            <span class="type">double</span> <span class="variable">cacheHitRatio</span> <span class="operator">=</span> measureCacheHealth();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Check policy evaluation performance</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">avgDecisionTime</span> <span class="operator">=</span> measureDecisionPerformance();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (dbResponseTime &gt; <span class="number">100</span> || cacheHitRatio &lt; <span class="number">0.8</span> || avgDecisionTime &gt; <span class="number">50</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> Health.down()</span><br><span class="line">                    .withDetail(<span class="string">&quot;database_response_time&quot;</span>, dbResponseTime)</span><br><span class="line">                    .withDetail(<span class="string">&quot;cache_hit_ratio&quot;</span>, cacheHitRatio)</span><br><span class="line">                    .withDetail(<span class="string">&quot;avg_decision_time&quot;</span>, avgDecisionTime)</span><br><span class="line">                    .build();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> Health.up()</span><br><span class="line">                .withDetail(<span class="string">&quot;database_response_time&quot;</span>, dbResponseTime)</span><br><span class="line">                .withDetail(<span class="string">&quot;cache_hit_ratio&quot;</span>, cacheHitRatio)</span><br><span class="line">                .withDetail(<span class="string">&quot;avg_decision_time&quot;</span>, avgDecisionTime)</span><br><span class="line">                .build();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> Health.down().withException(e).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Testing-Strategy"><a href="#Testing-Strategy" class="headerlink" title="Testing Strategy"></a>Testing Strategy</h2><h3 id="Unit-Testing"><a href="#Unit-Testing" class="headerlink" title="Unit Testing"></a>Unit Testing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExtendWith(MockitoExtension.class)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RbacEngineTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> UserRoleRepository userRoleRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@InjectMocks</span></span><br><span class="line">    <span class="keyword">private</span> RbacEngine rbacEngine;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldPermitAccessWhenUserHasRequiredRole</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Given</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> <span class="string">&quot;user123&quot;</span>;</span><br><span class="line">        <span class="type">Role</span> <span class="variable">developerRole</span> <span class="operator">=</span> createRole(<span class="string">&quot;DEVELOPER&quot;</span>);</span><br><span class="line">        <span class="type">Permission</span> <span class="variable">readCodePermission</span> <span class="operator">=</span> createPermission(<span class="string">&quot;code&quot;</span>, <span class="string">&quot;read&quot;</span>);</span><br><span class="line">        developerRole.addPermission(readCodePermission);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">when</span>(userRoleRepository.findActiveRolesByUserId(userId))</span><br><span class="line">            .thenReturn(Set.of(developerRole));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When</span></span><br><span class="line">        <span class="type">AccessRequest</span> <span class="variable">request</span> <span class="operator">=</span> AccessRequest.builder()</span><br><span class="line">            .userId(userId)</span><br><span class="line">            .resource(<span class="string">&quot;code&quot;</span>)</span><br><span class="line">            .action(<span class="string">&quot;read&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="type">AccessDecision</span> <span class="variable">decision</span> <span class="operator">=</span> rbacEngine.evaluate(request);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Then</span></span><br><span class="line">        assertThat(decision.isPermitted()).isTrue();</span><br><span class="line">        assertThat(decision.getReason()).contains(<span class="string">&quot;RBAC: Role DEVELOPER&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldInheritPermissionsFromParentRole</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Given</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> <span class="string">&quot;user123&quot;</span>;</span><br><span class="line">        <span class="type">Role</span> <span class="variable">employeeRole</span> <span class="operator">=</span> createRole(<span class="string">&quot;EMPLOYEE&quot;</span>);</span><br><span class="line">        <span class="type">Role</span> <span class="variable">managerRole</span> <span class="operator">=</span> createRole(<span class="string">&quot;MANAGER&quot;</span>, employeeRole);</span><br><span class="line">        </span><br><span class="line">        <span class="type">Permission</span> <span class="variable">basePermission</span> <span class="operator">=</span> createPermission(<span class="string">&quot;dashboard&quot;</span>, <span class="string">&quot;read&quot;</span>);</span><br><span class="line">        employeeRole.addPermission(basePermission);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">when</span>(userRoleRepository.findActiveRolesByUserId(userId))</span><br><span class="line">            .thenReturn(Set.of(managerRole));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When</span></span><br><span class="line">        <span class="type">AccessRequest</span> <span class="variable">request</span> <span class="operator">=</span> AccessRequest.builder()</span><br><span class="line">            .userId(userId)</span><br><span class="line">            .resource(<span class="string">&quot;dashboard&quot;</span>)</span><br><span class="line">            .action(<span class="string">&quot;read&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="type">AccessDecision</span> <span class="variable">decision</span> <span class="operator">=</span> rbacEngine.evaluate(request);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Then</span></span><br><span class="line">        assertThat(decision.isPermitted()).isTrue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Integration-Testing"><a href="#Integration-Testing" class="headerlink" title="Integration Testing"></a>Integration Testing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Testcontainers</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PrivilegeServiceIntegrationTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Container</span></span><br><span class="line">    <span class="keyword">static</span> PostgreSQLContainer&lt;?&gt; postgres = <span class="keyword">new</span> <span class="title class_">PostgreSQLContainer</span>&lt;&gt;(<span class="string">&quot;postgres:13&quot;</span>)</span><br><span class="line">            .withDatabaseName(<span class="string">&quot;privilege_test&quot;</span>)</span><br><span class="line">            .withUsername(<span class="string">&quot;test&quot;</span>)</span><br><span class="line">            .withPassword(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Container</span></span><br><span class="line">    <span class="keyword">static</span> GenericContainer&lt;?&gt; redis = <span class="keyword">new</span> <span class="title class_">GenericContainer</span>&lt;&gt;(<span class="string">&quot;redis:6&quot;</span>)</span><br><span class="line">            .withExposedPorts(<span class="number">6379</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldCacheAccessDecisions</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Given</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> createTestUser();</span><br><span class="line">        <span class="type">String</span> <span class="variable">roleId</span> <span class="operator">=</span> createTestRole();</span><br><span class="line">        assignRoleToUser(userId, roleId);</span><br><span class="line">        </span><br><span class="line">        <span class="type">AccessRequest</span> <span class="variable">request</span> <span class="operator">=</span> AccessRequest.builder()</span><br><span class="line">            .userId(userId)</span><br><span class="line">            .resource(<span class="string">&quot;test-resource&quot;</span>)</span><br><span class="line">            .action(<span class="string">&quot;read&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When - First call</span></span><br><span class="line">        <span class="type">Instant</span> <span class="variable">start1</span> <span class="operator">=</span> Instant.now();</span><br><span class="line">        <span class="type">AccessDecision</span> <span class="variable">decision1</span> <span class="operator">=</span> privilegeService.evaluateAccess(request);</span><br><span class="line">        <span class="type">Duration</span> <span class="variable">duration1</span> <span class="operator">=</span> Duration.between(start1, Instant.now());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When - Second call (should be cached)</span></span><br><span class="line">        <span class="type">Instant</span> <span class="variable">start2</span> <span class="operator">=</span> Instant.now();</span><br><span class="line">        <span class="type">AccessDecision</span> <span class="variable">decision2</span> <span class="operator">=</span> privilegeService.evaluateAccess(request);</span><br><span class="line">        <span class="type">Duration</span> <span class="variable">duration2</span> <span class="operator">=</span> Duration.between(start2, Instant.now());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Then</span></span><br><span class="line">        assertThat(decision1).isEqualTo(decision2);</span><br><span class="line">        assertThat(duration2).isLessThan(duration1.dividedBy(<span class="number">2</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Deployment-Considerations"><a href="#Deployment-Considerations" class="headerlink" title="Deployment Considerations"></a>Deployment Considerations</h2><h3 id="Kubernetes-Deployment"><a href="#Kubernetes-Deployment" class="headerlink" title="Kubernetes Deployment"></a>Kubernetes Deployment</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">privilege-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">privilege-service</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">privilege-service</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">privilege-service</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">privilege-service:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_PROFILES_ACTIVE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;production&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DATABASE_URL</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">db-secret</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">url</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">REDIS_URL</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">redis-secret</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">url</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;512Mi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/actuator/health</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/actuator/health/readiness</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>

<h3 id="Database-Migration-Strategy"><a href="#Database-Migration-Strategy" class="headerlink" title="Database Migration Strategy"></a>Database Migration Strategy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrivilegeMigrationService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="meta">@Order(1)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationReady</span><span class="params">(ApplicationReadyEvent event)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isNewDeployment()) &#123;</span><br><span class="line">            createDefaultRolesAndPermissions();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (requiresDataMigration()) &#123;</span><br><span class="line">            migrateExistingData();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        validateSystemIntegrity();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">createDefaultRolesAndPermissions</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Create system administrator role</span></span><br><span class="line">        <span class="type">Role</span> <span class="variable">adminRole</span> <span class="operator">=</span> roleService.createRole(<span class="string">&quot;SYSTEM_ADMIN&quot;</span>, <span class="string">&quot;System Administrator&quot;</span>);</span><br><span class="line">        <span class="type">Permission</span> <span class="variable">allPermissions</span> <span class="operator">=</span> permissionService.createPermission(<span class="string">&quot;*&quot;</span>, <span class="string">&quot;*&quot;</span>);</span><br><span class="line">        roleService.assignPermission(adminRole.getId(), allPermissions.getId());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Create default user role</span></span><br><span class="line">        <span class="type">Role</span> <span class="variable">userRole</span> <span class="operator">=</span> roleService.createRole(<span class="string">&quot;USER&quot;</span>, <span class="string">&quot;Default User&quot;</span>);</span><br><span class="line">        <span class="type">Permission</span> <span class="variable">readProfile</span> <span class="operator">=</span> permissionService.createPermission(<span class="string">&quot;profile&quot;</span>, <span class="string">&quot;read&quot;</span>);</span><br><span class="line">        roleService.assignPermission(userRole.getId(), readProfile.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Real-World-Use-Cases"><a href="#Real-World-Use-Cases" class="headerlink" title="Real-World Use Cases"></a>Real-World Use Cases</h2><h3 id="Enterprise-SaaS-Platform"><a href="#Enterprise-SaaS-Platform" class="headerlink" title="Enterprise SaaS Platform"></a>Enterprise SaaS Platform</h3><p><strong>Scenario</strong>: A multi-tenant SaaS platform needs to support different organizations with varying access control requirements.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantAwarePrivilegeService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> AccessDecision <span class="title function_">evaluateTenantAccess</span><span class="params">(AccessRequest request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> request.getContext().get(<span class="string">&quot;tenant_id&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// RBAC: Check user roles within tenant</span></span><br><span class="line">        Set&lt;Role&gt; tenantRoles = getUserRolesInTenant(request.getUserId(), tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ABAC: Apply tenant-specific policies</span></span><br><span class="line">        <span class="type">AbacContext</span> <span class="variable">context</span> <span class="operator">=</span> AbacContext.builder()</span><br><span class="line">            .userAttributes(getUserAttributes(request.getUserId()))</span><br><span class="line">            .resourceAttributes(getResourceAttributes(request.getResource()))</span><br><span class="line">            .environmentAttributes(Map.of(</span><br><span class="line">                <span class="string">&quot;tenant_id&quot;</span>, tenantId,</span><br><span class="line">                <span class="string">&quot;subscription_level&quot;</span>, getTenantSubscription(tenantId),</span><br><span class="line">                <span class="string">&quot;data_residency&quot;</span>, getTenantDataResidency(tenantId)</span><br><span class="line">            ))</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> evaluateWithContext(request, context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ABAC Policy Example for Tenant Isolation</strong>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tenant-data-isolation-policy&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;target&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;resources&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;api/data/*&quot;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Deny&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;condition&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;not&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;equals&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span><span class="attr">&quot;var&quot;</span><span class="punctuation">:</span> <span class="string">&quot;resource.tenant_id&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span><span class="attr">&quot;var&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user.tenant_id&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Healthcare-System-HIPAA-Compliance"><a href="#Healthcare-System-HIPAA-Compliance" class="headerlink" title="Healthcare System HIPAA Compliance"></a>Healthcare System HIPAA Compliance</h3><p><strong>Scenario</strong>: A healthcare system requires strict access controls with audit trails for HIPAA compliance.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HipaaPrivilegeEnforcer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PatientConsentService consentService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> AccessDecision <span class="title function_">evaluatePatientDataAccess</span><span class="params">(AccessRequest request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">patientId</span> <span class="operator">=</span> extractPatientId(request.getResource());</span><br><span class="line">        <span class="type">String</span> <span class="variable">providerId</span> <span class="operator">=</span> request.getUserId();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check if provider has active treatment relationship</span></span><br><span class="line">        <span class="keyword">if</span> (!hasActiveTreatmentRelationship(providerId, patientId)) &#123;</span><br><span class="line">            <span class="keyword">return</span> AccessDecision.deny(<span class="string">&quot;No active treatment relationship&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check patient consent</span></span><br><span class="line">        <span class="keyword">if</span> (!consentService.hasValidConsent(patientId, providerId)) &#123;</span><br><span class="line">            <span class="keyword">return</span> AccessDecision.deny(<span class="string">&quot;Patient consent required&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Apply break-glass emergency access</span></span><br><span class="line">        <span class="keyword">if</span> (isEmergencyAccess(request)) &#123;</span><br><span class="line">            auditService.recordEmergencyAccess(request);</span><br><span class="line">            <span class="keyword">return</span> AccessDecision.permit(<span class="string">&quot;Emergency access granted&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.evaluate(request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Financial-Services-Regulatory-Compliance"><a href="#Financial-Services-Regulatory-Compliance" class="headerlink" title="Financial Services Regulatory Compliance"></a>Financial Services Regulatory Compliance</h3><p><strong>Scenario</strong>: A financial institution needs to implement segregation of duties and time-bound access for regulatory compliance.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FinancialPrivilegeService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> AccessDecision <span class="title function_">evaluateFinancialTransaction</span><span class="params">(AccessRequest request)</span> &#123;</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">amount</span> <span class="operator">=</span> extractTransactionAmount(request);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Four-eyes principle for high-value transactions</span></span><br><span class="line">        <span class="keyword">if</span> (amount.compareTo(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;10000&quot;</span>)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> evaluateDualApproval(request);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Time-based trading restrictions</span></span><br><span class="line">        <span class="keyword">if</span> (isTradingResource(request.getResource())) &#123;</span><br><span class="line">            <span class="keyword">return</span> evaluateTradingHours(request);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.evaluate(request);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> AccessDecision <span class="title function_">evaluateDualApproval</span><span class="params">(AccessRequest request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">transactionId</span> <span class="operator">=</span> request.getContext().get(<span class="string">&quot;transaction_id&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check if another user has already approved</span></span><br><span class="line">        Optional&lt;Approval&gt; existingApproval = approvalService</span><br><span class="line">            .findPendingApproval(transactionId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (existingApproval.isPresent() &amp;&amp; </span><br><span class="line">            !existingApproval.get().getApproverId().equals(request.getUserId())) &#123;</span><br><span class="line">            <span class="keyword">return</span> AccessDecision.permit(<span class="string">&quot;Dual approval satisfied&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Create pending approval</span></span><br><span class="line">        approvalService.createPendingApproval(transactionId, request.getUserId());</span><br><span class="line">        <span class="keyword">return</span> AccessDecision.deny(<span class="string">&quot;Awaiting second approval&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Advanced-Features"><a href="#Advanced-Features" class="headerlink" title="Advanced Features"></a>Advanced Features</h2><h3 id="Dynamic-Permission-Discovery"><a href="#Dynamic-Permission-Discovery" class="headerlink" title="Dynamic Permission Discovery"></a>Dynamic Permission Discovery</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicPermissionService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Automatically discovers and registers permissions from controller annotations</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">discoverPermissions</span><span class="params">(ApplicationReadyEvent event)</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> event.getApplicationContext();</span><br><span class="line">        </span><br><span class="line">        context.getBeansWithAnnotation(RestController.class).values()</span><br><span class="line">            .forEach(<span class="built_in">this</span>::scanControllerForPermissions);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">scanControllerForPermissions</span><span class="params">(Object controller)</span> &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = AopUtils.getTargetClass(controller);</span><br><span class="line">        <span class="type">RequestMapping</span> <span class="variable">classMapping</span> <span class="operator">=</span> clazz.getAnnotation(RequestMapping.class);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (Method method : clazz.getDeclaredMethods()) &#123;</span><br><span class="line">            <span class="type">RequiresPermission</span> <span class="variable">permissionAnnotation</span> <span class="operator">=</span> </span><br><span class="line">                method.getAnnotation(RequiresPermission.class);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (permissionAnnotation != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">resource</span> <span class="operator">=</span> buildResourcePath(classMapping, method);</span><br><span class="line">                <span class="type">String</span> <span class="variable">action</span> <span class="operator">=</span> extractAction(method);</span><br><span class="line">                </span><br><span class="line">                permissionService.registerPermission(</span><br><span class="line">                    permissionAnnotation.value(),</span><br><span class="line">                    resource,</span><br><span class="line">                    action,</span><br><span class="line">                    permissionAnnotation.description()</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> RequiresPermission &#123;</span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span>;</span><br><span class="line">    String <span class="title function_">description</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    String[] conditions() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Policy-Templates"><a href="#Policy-Templates" class="headerlink" title="Policy Templates"></a>Policy Templates</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PolicyTemplateService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, PolicyTemplate&gt; TEMPLATES = Map.of(</span><br><span class="line">        <span class="string">&quot;time_restricted&quot;</span>, <span class="keyword">new</span> <span class="title class_">TimeRestrictedTemplate</span>(),</span><br><span class="line">        <span class="string">&quot;ip_restricted&quot;</span>, <span class="keyword">new</span> <span class="title class_">IpRestrictedTemplate</span>(),</span><br><span class="line">        <span class="string">&quot;department_scoped&quot;</span>, <span class="keyword">new</span> <span class="title class_">DepartmentScopedTemplate</span>(),</span><br><span class="line">        <span class="string">&quot;temporary_access&quot;</span>, <span class="keyword">new</span> <span class="title class_">TemporaryAccessTemplate</span>()</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> AbacPolicy <span class="title function_">createPolicyFromTemplate</span><span class="params">(String templateName, </span></span><br><span class="line"><span class="params">                                               Map&lt;String, Object&gt; parameters)</span> &#123;</span><br><span class="line">        <span class="type">PolicyTemplate</span> <span class="variable">template</span> <span class="operator">=</span> TEMPLATES.get(templateName);</span><br><span class="line">        <span class="keyword">if</span> (template == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unknown template: &quot;</span> + templateName);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> template.generatePolicy(parameters);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimeRestrictedTemplate</span> <span class="keyword">implements</span> <span class="title class_">PolicyTemplate</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AbacPolicy <span class="title function_">generatePolicy</span><span class="params">(Map&lt;String, Object&gt; params)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">startTime</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;start_time&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">endTime</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;end_time&quot;</span>);</span><br><span class="line">        List&lt;String&gt; allowedDays = (List&lt;String&gt;) params.get(<span class="string">&quot;allowed_days&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">PolicyDocument</span> <span class="variable">document</span> <span class="operator">=</span> PolicyDocument.builder()</span><br><span class="line">            .rule(PolicyRule.builder()</span><br><span class="line">                .effect(Effect.PERMIT)</span><br><span class="line">                .condition(buildTimeCondition(startTime, endTime, allowedDays))</span><br><span class="line">                .build())</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> AbacPolicy.builder()</span><br><span class="line">            .name(<span class="string">&quot;time-restricted-&quot;</span> + UUID.randomUUID())</span><br><span class="line">            .policyDocument(document)</span><br><span class="line">            .priority(<span class="number">100</span>)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Machine-Learning-Integration"><a href="#Machine-Learning-Integration" class="headerlink" title="Machine Learning Integration"></a>Machine Learning Integration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnomalousAccessDetector</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccessPatternAnalyzer patternAnalyzer;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">analyzeAccessPattern</span><span class="params">(AccessDecisionEvent event)</span> &#123;</span><br><span class="line">        <span class="type">AccessPattern</span> <span class="variable">pattern</span> <span class="operator">=</span> AccessPattern.builder()</span><br><span class="line">            .userId(event.getUserId())</span><br><span class="line">            .resource(event.getResource())</span><br><span class="line">            .action(event.getAction())</span><br><span class="line">            .timestamp(event.getTimestamp())</span><br><span class="line">            .ipAddress(event.getContext().get(<span class="string">&quot;ip_address&quot;</span>))</span><br><span class="line">            .userAgent(event.getContext().get(<span class="string">&quot;user_agent&quot;</span>))</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="type">double</span> <span class="variable">anomalyScore</span> <span class="operator">=</span> patternAnalyzer.calculateAnomalyScore(pattern);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (anomalyScore &gt; <span class="number">0.8</span>) &#123;</span><br><span class="line">            <span class="type">SecurityAlert</span> <span class="variable">alert</span> <span class="operator">=</span> SecurityAlert.builder()</span><br><span class="line">                .userId(event.getUserId())</span><br><span class="line">                .alertType(<span class="string">&quot;ANOMALOUS_ACCESS&quot;</span>)</span><br><span class="line">                .severity(Severity.HIGH)</span><br><span class="line">                .description(<span class="string">&quot;Unusual access pattern detected&quot;</span>)</span><br><span class="line">                .anomalyScore(anomalyScore)</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">            alertService.sendAlert(alert);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Temporarily increase scrutiny for this user</span></span><br><span class="line">            privilegeService.enableEnhancedMonitoring(event.getUserId(), </span><br><span class="line">                Duration.ofHours(<span class="number">24</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Benchmarks"><a href="#Performance-Benchmarks" class="headerlink" title="Performance Benchmarks"></a>Performance Benchmarks</h2><h3 id="Load-Testing-Results"><a href="#Load-Testing-Results" class="headerlink" title="Load Testing Results"></a>Load Testing Results</h3><p><strong>Test Environment</strong>:</p>
<ul>
<li>3 application instances (2 CPU, 4GB RAM each)</li>
<li>PostgreSQL (4 CPU, 8GB RAM)</li>
<li>Redis Cluster (3 nodes, 2GB RAM each)</li>
</ul>
<p><strong>Results</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Scenario: Mixed RBAC/ABAC evaluation</span><br><span class="line">├── Concurrent Users: 1000</span><br><span class="line">├── Test Duration: 10 minutes</span><br><span class="line">├── Total Requests: 2,847,293</span><br><span class="line">├── Average Response Time: 3.2ms</span><br><span class="line">├── 95th Percentile: 8.5ms</span><br><span class="line">├── 99th Percentile: 15.2ms</span><br><span class="line">├── Error Rate: 0.02%</span><br><span class="line">└── Throughput: 4,745 RPS</span><br><span class="line"></span><br><span class="line">Cache Performance:</span><br><span class="line">├── L1 Cache Hit Rate: 87.3%</span><br><span class="line">├── L2 Cache Hit Rate: 11.8%</span><br><span class="line">├── Database Queries: 0.9%</span><br><span class="line">└── Average Decision Time: 1.8ms (cached), 45ms (uncached)</span><br></pre></td></tr></table></figure>

<h3 id="Memory-Usage-Optimization"><a href="#Memory-Usage-Optimization" class="headerlink" title="Memory Usage Optimization"></a>Memory Usage Optimization</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemoryOptimizationConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty(name = &quot;privilege.optimization.memory&quot;, havingValue = &quot;true&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> PrivilegeService <span class="title function_">optimizedPrivilegeService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MemoryOptimizedPrivilegeService</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemoryOptimizedPrivilegeService</span> <span class="keyword">extends</span> <span class="title class_">PrivilegeService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Use flyweight pattern for common permissions</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Permission&gt; permissionFlyweights = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Weak references for rarely accessed data</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WeakHashMap&lt;String, Set&lt;Role&gt;&gt; userRoleCache = <span class="keyword">new</span> <span class="title class_">WeakHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Compressed storage for policy documents</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">PolicyCompressor</span> <span class="variable">policyCompressor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PolicyCompressor</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Set&lt;Permission&gt; <span class="title function_">getUserPermissions</span><span class="params">(String userId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userRoleCache.computeIfAbsent(userId, <span class="built_in">this</span>::loadUserRoles)</span><br><span class="line">            .stream()</span><br><span class="line">            .flatMap(role -&gt; role.getPermissions().stream())</span><br><span class="line">            .map(<span class="built_in">this</span>::getFlyweightPermission)</span><br><span class="line">            .collect(Collectors.toSet());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Interview-Questions-and-Answers"><a href="#Interview-Questions-and-Answers" class="headerlink" title="Interview Questions and Answers"></a>Interview Questions and Answers</h2><h3 id="Architecture-Questions"><a href="#Architecture-Questions" class="headerlink" title="Architecture Questions"></a>Architecture Questions</h3><p><strong>Q: How would you handle a situation where the privilege service becomes unavailable?</strong></p>
<p><strong>A</strong>: Implement a circuit breaker pattern with graceful degradation:</p>
<ol>
<li><strong>Circuit Breaker</strong>: Use Hystrix or Resilience4j to detect service failures</li>
<li><strong>Fallback Strategy</strong>: Cache recent decisions locally and apply “fail-secure” or “fail-open” policies based on criticality</li>
<li><strong>Emergency Roles</strong>: Pre-configure emergency access roles that work offline</li>
<li><strong>Async Recovery</strong>: Queue privilege decisions for later verification when service recovers</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResilientPrivilegeService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@CircuitBreaker(name = &quot;privilege-service&quot;, fallbackMethod = &quot;fallbackEvaluate&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> AccessDecision <span class="title function_">evaluate</span><span class="params">(AccessRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> privilegeService.evaluateAccess(request);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> AccessDecision <span class="title function_">fallbackEvaluate</span><span class="params">(AccessRequest request, Exception ex)</span> &#123;</span><br><span class="line">        <span class="comment">// Check local emergency cache</span></span><br><span class="line">        <span class="type">AccessDecision</span> <span class="variable">cached</span> <span class="operator">=</span> emergencyCache.get(request);</span><br><span class="line">        <span class="keyword">if</span> (cached != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> cached;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Apply default policy based on resource criticality</span></span><br><span class="line">        <span class="keyword">if</span> (isCriticalResource(request.getResource())) &#123;</span><br><span class="line">            <span class="keyword">return</span> AccessDecision.deny(<span class="string">&quot;Service unavailable - fail secure&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> AccessDecision.permit(<span class="string">&quot;Service unavailable - fail open&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Q: How do you ensure consistency across multiple instances of the privilege service?</strong></p>
<p><strong>A</strong>: Use distributed caching with event-driven invalidation:</p>
<ol>
<li><strong>Distributed Cache</strong>: Redis cluster for shared state</li>
<li><strong>Event Sourcing</strong>: Publish privilege change events</li>
<li><strong>Cache Invalidation</strong>: Listen to events and invalidate affected cache entries</li>
<li><strong>Database Consistency</strong>: Use database transactions for critical updates</li>
<li><strong>Eventual Consistency</strong>: Accept temporary inconsistency for better performance</li>
</ol>
<h3 id="Security-Questions"><a href="#Security-Questions" class="headerlink" title="Security Questions"></a>Security Questions</h3><p><strong>Q: How would you prevent privilege escalation attacks?</strong></p>
<p><strong>A</strong>: Implement multiple defense layers:</p>
<ol>
<li><strong>Principle of Least Privilege</strong>: Regular audits to remove unused permissions</li>
<li><strong>Approval Workflows</strong>: Require approval for sensitive role assignments</li>
<li><strong>Temporal Constraints</strong>: Time-bound permissions with automatic expiration</li>
<li><strong>Delegation Restrictions</strong>: Prevent users from granting permissions they don’t have</li>
<li><strong>Audit Monitoring</strong>: Real-time detection of unusual privilege changes</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrivilegeEscalationDetector</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">detectEscalation</span><span class="params">(RoleAssignmentEvent event)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isPrivilegeEscalation(event)) &#123;</span><br><span class="line">            <span class="comment">// Block the assignment</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;Potential privilege escalation detected&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isPrivilegeEscalation</span><span class="params">(RoleAssignmentEvent event)</span> &#123;</span><br><span class="line">        Set&lt;Permission&gt; assignerPermissions = getEffectivePermissions(event.getAssignerId());</span><br><span class="line">        Set&lt;Permission&gt; targetPermissions = getRolePermissions(event.getRoleId());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Assigner cannot grant permissions they don&#x27;t have</span></span><br><span class="line">        <span class="keyword">return</span> !assignerPermissions.containsAll(targetPermissions);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Performance-Questions"><a href="#Performance-Questions" class="headerlink" title="Performance Questions"></a>Performance Questions</h3><p><strong>Q: How would you optimize the system for 100,000+ concurrent users?</strong></p>
<p><strong>A</strong>: Multi-layered optimization approach:</p>
<ol>
<li><strong>Horizontal Scaling</strong>: Auto-scaling groups with load balancers</li>
<li><strong>Caching Strategy</strong>: 4-tier caching (Browser → CDN → App Cache → Database)</li>
<li><strong>Database Optimization</strong>: Read replicas, connection pooling, query optimization</li>
<li><strong>Async Processing</strong>: Queue heavy operations like audit logging</li>
<li><strong>Pre-computation</strong>: Background jobs to pre-calculate common decisions</li>
</ol>
<h2 id="Troubleshooting-Guide"><a href="#Troubleshooting-Guide" class="headerlink" title="Troubleshooting Guide"></a>Troubleshooting Guide</h2><h3 id="Common-Issues-and-Solutions"><a href="#Common-Issues-and-Solutions" class="headerlink" title="Common Issues and Solutions"></a>Common Issues and Solutions</h3><p><strong>Issue</strong>: High latency on privilege decisions</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Check cache hit ratios</span></span><br><span class="line">curl http://localhost:8080/actuator/metrics/cache.gets | jq</span><br><span class="line"></span><br><span class="line"><span class="comment"># Monitor database query performance</span></span><br><span class="line">EXPLAIN ANALYZE SELECT * FROM user_roles WHERE user_id = <span class="string">&#x27;user123&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check for cache stampede</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/privilege-service.log | grep <span class="string">&quot;Cache miss&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>Solution</strong>: Implement cache warming and query optimization</p>
<p><strong>Issue</strong>: Memory leaks in long-running instances</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add heap dump analysis</span></span><br><span class="line">-XX:+HeapDumpOnOutOfMemoryError </span><br><span class="line">-XX:HeapDumpPath=/<span class="keyword">var</span>/log/heapdumps/</span><br><span class="line"></span><br><span class="line"><span class="comment">// Monitor with JProfiler or similar</span></span><br><span class="line">jcmd &lt;pid&gt; GC.run_finalization</span><br></pre></td></tr></table></figure>

<p><strong>Solution</strong>: Use weak references for rarely accessed data and implement cache size limits</p>
<h2 id="External-Resources"><a href="#External-Resources" class="headerlink" title="External Resources"></a>External Resources</h2><h3 id="Standards-and-Specifications"><a href="#Standards-and-Specifications" class="headerlink" title="Standards and Specifications"></a>Standards and Specifications</h3><ul>
<li><a target="_blank" rel="noopener" href="https://csrc.nist.gov/publications/detail/sp/800-162/final">NIST RBAC Model</a> - Foundational RBAC principles</li>
<li><a target="_blank" rel="noopener" href="http://docs.oasis-open.org/xacml/3.0/xacml-3.0-core-spec-os-en.html">XACML 3.0 Specification</a> - ABAC policy language</li>
<li><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc7662">OAuth 2.0 Token Introspection</a> - Token-based authorization</li>
<li><a target="_blank" rel="noopener" href="https://cheatsheetseries.owasp.org/cheatsheets/Access_Control_Cheat_Sheet.html">OWASP Access Control Cheat Sheet</a> - Security best practices</li>
</ul>
<h3 id="Implementation-References"><a href="#Implementation-References" class="headerlink" title="Implementation References"></a>Implementation References</h3><ul>
<li><a target="_blank" rel="noopener" href="https://spring.io/guides/topicals/spring-security-architecture/">Spring Security Architecture</a> - Framework integration</li>
<li><a target="_blank" rel="noopener" href="https://shiro.apache.org/documentation.html">Apache Shiro Documentation</a> - Alternative authorization framework</li>
<li><a target="_blank" rel="noopener" href="https://auth0.com/docs/manage-users/access-control/rbac">Auth0 RBAC Guide</a> - Commercial implementation examples</li>
<li><a target="_blank" rel="noopener" href="https://casbin.org/">Casbin Authorization Library</a> - Open-source authorization library</li>
</ul>
<h3 id="Performance-and-Monitoring"><a href="#Performance-and-Monitoring" class="headerlink" title="Performance and Monitoring"></a>Performance and Monitoring</h3><ul>
<li><a target="_blank" rel="noopener" href="https://micrometer.io/docs">Micrometer Documentation</a> - Metrics collection</li>
<li><a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards/">Grafana Dashboard Templates</a> - Monitoring visualization</li>
<li><a target="_blank" rel="noopener" href="https://redis.io/documentation">Redis Performance Tuning</a> - Cache optimization</li>
</ul>
<p>This comprehensive design provides a production-ready privilege system that balances security, performance, and maintainability while addressing real-world enterprise requirements.</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/system-design/" rel="tag"># system-design</a>
              <a href="/tags/privilege-system/" rel="tag"># privilege system</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/06/12/Java-Interview-Guide-Core-Concepts/" rel="prev" title="Java Interview Guide - Core Concepts">
                  <i class="fa fa-angle-left"></i> Java Interview Guide - Core Concepts
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/06/12/Design-Grey-Service-Router-Guide/" rel="next" title="Design Grey Service Router Guide">
                  Design Grey Service Router Guide <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Charlie Feng</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
