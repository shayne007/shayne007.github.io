<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"shayne007.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="System OverviewThe Grey Service Router System is a sophisticated multi-tenant service mesh solution that enables granular version control and database schema management across different tenants. It pr">
<meta property="og:type" content="article">
<meta property="og:title" content="Design Grey Service Router Guide">
<meta property="og:url" content="https://shayne007.github.io/2025/06/12/Design-Grey-Service-Router-Guide/index.html">
<meta property="og:site_name" content="Charlie Feng&#39;s Tech Space">
<meta property="og:description" content="System OverviewThe Grey Service Router System is a sophisticated multi-tenant service mesh solution that enables granular version control and database schema management across different tenants. It pr">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-06-12T14:04:26.000Z">
<meta property="article:modified_time" content="2025-06-13T17:51:22.806Z">
<meta property="article:author" content="Charlie Feng">
<meta property="article:tag" content="system-design">
<meta property="article:tag" content="grey service router">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://shayne007.github.io/2025/06/12/Design-Grey-Service-Router-Guide/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://shayne007.github.io/2025/06/12/Design-Grey-Service-Router-Guide/","path":"2025/06/12/Design-Grey-Service-Router-Guide/","title":"Design Grey Service Router Guide"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Design Grey Service Router Guide | Charlie Feng's Tech Space</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"cdn":false,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.5.0/mermaid.min.js","integrity":"sha256-2obLuIPcceEhkE3G09G33hBdmE55ivVcZUlcKcGNHjU="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>





  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Charlie Feng's Tech Space</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">You will survive with skills</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#System-Overview"><span class="nav-number">1.</span> <span class="nav-text">System Overview</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Architecture-Components"><span class="nav-number">2.</span> <span class="nav-text">Architecture Components</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GreyServiceRouter-Service"><span class="nav-number">2.1.</span> <span class="nav-text">GreyServiceRouter Service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GreyServiceManageUI"><span class="nav-number">2.2.</span> <span class="nav-text">GreyServiceManageUI</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Data-Architecture-in-Redis"><span class="nav-number">3.</span> <span class="nav-text">Data Architecture in Redis</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-Data-Structures"><span class="nav-number">3.1.</span> <span class="nav-text">Redis Data Structures</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lua-Script-for-Version-Resolution"><span class="nav-number">3.2.</span> <span class="nav-text">Lua Script for Version Resolution</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Service-Discovery-Integration"><span class="nav-number">4.</span> <span class="nav-text">Service Discovery Integration</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Nacos-Integration-Pattern"><span class="nav-number">4.1.</span> <span class="nav-text">Nacos Integration Pattern</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Service-Version-Discovery"><span class="nav-number">4.2.</span> <span class="nav-text">Service Version Discovery</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Database-Schema-Management"><span class="nav-number">5.</span> <span class="nav-text">Database Schema Management</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Schema-Versioning-Strategy"><span class="nav-number">5.1.</span> <span class="nav-text">Schema Versioning Strategy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Schema-Upgrade-Process"><span class="nav-number">5.2.</span> <span class="nav-text">Schema Upgrade Process</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Request-Routing-Implementation"><span class="nav-number">6.</span> <span class="nav-text">Request Routing Implementation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Router-Gateway-Logic"><span class="nav-number">6.1.</span> <span class="nav-text">Router Gateway Logic</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Monitoring-and-Observability"><span class="nav-number">7.</span> <span class="nav-text">Monitoring and Observability</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Metrics-Collection"><span class="nav-number">7.1.</span> <span class="nav-text">Metrics Collection</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#High-Availability-Considerations"><span class="nav-number">8.</span> <span class="nav-text">High Availability Considerations</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-Clustering-Strategy"><span class="nav-number">8.1.</span> <span class="nav-text">Redis Clustering Strategy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Circuit-Breaker-Pattern"><span class="nav-number">8.2.</span> <span class="nav-text">Circuit Breaker Pattern</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Security-Considerations"><span class="nav-number">9.</span> <span class="nav-text">Security Considerations</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Tenant-Isolation"><span class="nav-number">9.1.</span> <span class="nav-text">Tenant Isolation</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Performance-Optimization"><span class="nav-number">10.</span> <span class="nav-text">Performance Optimization</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Caching-Strategy"><span class="nav-number">10.1.</span> <span class="nav-text">Caching Strategy</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Testing-Strategies"><span class="nav-number">11.</span> <span class="nav-text">Testing Strategies</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Integration-Testing"><span class="nav-number">11.1.</span> <span class="nav-text">Integration Testing</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Production-Deployment"><span class="nav-number">12.</span> <span class="nav-text">Production Deployment</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Docker-Configuration"><span class="nav-number">12.1.</span> <span class="nav-text">Docker Configuration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kubernetes-Deployment"><span class="nav-number">12.2.</span> <span class="nav-text">Kubernetes Deployment</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#External-References"><span class="nav-number">13.</span> <span class="nav-text">External References</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Charlie Feng</p>
  <div class="site-description" itemprop="description">This place is for thinking and sharing.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">36</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/12/Design-Grey-Service-Router-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Design Grey Service Router Guide | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Design Grey Service Router Guide
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-12 22:04:26" itemprop="dateCreated datePublished" datetime="2025-06-12T22:04:26+08:00">2025-06-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-14 01:51:22" itemprop="dateModified" datetime="2025-06-14T01:51:22+08:00">2025-06-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system-design/" itemprop="url" rel="index"><span itemprop="name">system-design</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="System-Overview"><a href="#System-Overview" class="headerlink" title="System Overview"></a>System Overview</h2><p>The Grey Service Router System is a sophisticated multi-tenant service mesh solution that enables granular version control and database schema management across different tenants. It provides a centralized routing mechanism with tenant-specific service version assignments, allowing for controlled rollouts and independent database schema evolution.</p>
<p><strong>Interview Insight</strong>: <em>When discussing grey deployment systems, emphasize the separation of concerns between routing logic, version management, and database schema evolution. This demonstrates understanding of microservices architecture principles.</em></p>
<pre>
<code class="mermaid">
graph TB
A[Client Request] --&gt; B[GreyServiceRouter]
B --&gt; C[Redis Cache]
C --&gt; D[Lua Script Router]
D --&gt; E[Service Instance v1.0]
D --&gt; F[Service Instance v1.1]
D --&gt; G[Service Instance v2.0]

H[GreyServiceManageUI] --&gt; B
B --&gt; I[Project Management Service]
B --&gt; J[Nacos Registry]

K[Tenant A DB] --&gt; L[Schema v1.0]
M[Tenant B DB] --&gt; N[Schema v1.1]
O[Tenant C DB] --&gt; P[Schema v2.0]
</code>
</pre>

<h2 id="Architecture-Components"><a href="#Architecture-Components" class="headerlink" title="Architecture Components"></a>Architecture Components</h2><h3 id="GreyServiceRouter-Service"><a href="#GreyServiceRouter-Service" class="headerlink" title="GreyServiceRouter Service"></a>GreyServiceRouter Service</h3><p>The core routing service acts as an intelligent proxy that directs tenant requests to appropriate service versions based on predefined rules stored in Redis.</p>
<p><strong>Core Responsibilities:</strong></p>
<ul>
<li>Request interception and tenant identification</li>
<li>Version resolution through Redis lookup</li>
<li>Dynamic service discovery integration</li>
<li>Database schema compatibility validation</li>
<li>Metrics collection and monitoring</li>
</ul>
<p><strong>Key APIs:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET  /api/v1/tenants/&#123;tenantId&#125;/services</span><br><span class="line">POST /api/v1/tenants/&#123;tenantId&#125;/services/&#123;serviceId&#125;/upgrade</span><br><span class="line">GET  /api/v1/tenants/&#123;tenantId&#125;/services/&#123;serviceId&#125;/schema-status</span><br><span class="line">POST /api/v1/tenants/&#123;tenantId&#125;/services/&#123;serviceId&#125;/schema-upgrade</span><br><span class="line">GET  /api/v1/health</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Discuss how the router maintains high availability through stateless design and Redis clustering. Mention circuit breaker patterns for handling service discovery failures.</em></p>
<h3 id="GreyServiceManageUI"><a href="#GreyServiceManageUI" class="headerlink" title="GreyServiceManageUI"></a>GreyServiceManageUI</h3><p>A React-based management interface providing administrators with tenant-specific service version control and database schema management capabilities.</p>
<p><strong>Core Features:</strong></p>
<ul>
<li>Tenant selection and service version matrix display</li>
<li>Real-time service health monitoring</li>
<li>Database schema upgrade progress tracking</li>
<li>Rollback capabilities for failed upgrades</li>
<li>Audit logging for compliance requirements</li>
</ul>
<p><strong>UI Components Structure:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- TenantSelector</span><br><span class="line">- ServiceVersionMatrix</span><br><span class="line">- SchemaUpgradePanel</span><br><span class="line">- VersionComparisonView</span><br><span class="line">- AuditLogViewer</span><br></pre></td></tr></table></figure>

<h2 id="Data-Architecture-in-Redis"><a href="#Data-Architecture-in-Redis" class="headerlink" title="Data Architecture in Redis"></a>Data Architecture in Redis</h2><h3 id="Redis-Data-Structures"><a href="#Redis-Data-Structures" class="headerlink" title="Redis Data Structures"></a>Redis Data Structures</h3><p><strong>Interview Insight</strong>: <em>When designing Redis schemas, consider data access patterns first. Hash structures provide O(1) lookup for tenant-service mappings, while sorted sets enable efficient version ordering.</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># Tenant-Service Version Mapping</span><br><span class="line">HSET tenant:&#123;tenantId&#125;:services &#123;serviceId&#125; &#123;version&#125;</span><br><span class="line">HSET tenant:1001:services user-service &quot;v1.2.0&quot;</span><br><span class="line">HSET tenant:1001:services order-service &quot;v2.1.0&quot;</span><br><span class="line"></span><br><span class="line"># Service Version Metadata</span><br><span class="line">HSET service:&#123;serviceId&#125;:version:&#123;version&#125; schema_version compatible_versions deployment_time</span><br><span class="line">HSET service:user-service:version:v1.2.0 schema_version &quot;1.2&quot; compatible_versions &quot;1.1,1.2&quot; deployment_time &quot;2025-06-01T10:00:00Z&quot;</span><br><span class="line"></span><br><span class="line"># Tenant Database Schema Status</span><br><span class="line">HSET tenant:&#123;tenantId&#125;:schema &#123;serviceId&#125; &#123;schemaVersion&#125;</span><br><span class="line">HSET tenant:1001:schema user-service &quot;1.2&quot;</span><br><span class="line"></span><br><span class="line"># Available Service Versions (Sorted Set for version ordering)</span><br><span class="line">ZADD service:&#123;serviceId&#125;:versions &#123;timestamp&#125; &#123;version&#125;</span><br><span class="line">ZADD service:user-service:versions 1717200000 &quot;v1.2.0&quot;</span><br></pre></td></tr></table></figure>

<h3 id="Lua-Script-for-Version-Resolution"><a href="#Lua-Script-for-Version-Resolution" class="headerlink" title="Lua Script for Version Resolution"></a>Lua Script for Version Resolution</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- version_router.lua</span></span><br><span class="line"><span class="keyword">local</span> tenant_id = ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">local</span> service_id = ARGV[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Get tenant&#x27;s assigned version</span></span><br><span class="line"><span class="keyword">local</span> version = redis.call(<span class="string">&#x27;HGET&#x27;</span>, <span class="string">&#x27;tenant:&#x27;</span> .. tenant_id .. <span class="string">&#x27;:services&#x27;</span>, service_id)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> version <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- Fallback to default version</span></span><br><span class="line">    version = redis.call(<span class="string">&#x27;HGET&#x27;</span>, <span class="string">&#x27;service:&#x27;</span> .. service_id .. <span class="string">&#x27;:default&#x27;</span>, <span class="string">&#x27;version&#x27;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Validate schema compatibility</span></span><br><span class="line"><span class="keyword">local</span> schema_version = redis.call(<span class="string">&#x27;HGET&#x27;</span>, <span class="string">&#x27;tenant:&#x27;</span> .. tenant_id .. <span class="string">&#x27;:schema&#x27;</span>, service_id)</span><br><span class="line"><span class="keyword">local</span> required_schema = redis.call(<span class="string">&#x27;HGET&#x27;</span>, <span class="string">&#x27;service:&#x27;</span> .. service_id .. <span class="string">&#x27;:version:&#x27;</span> .. version, <span class="string">&#x27;schema_version&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> schema_version <span class="keyword">and</span> required_schema <span class="keyword">and</span> schema_version &lt; required_schema <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="literal">nil</span>, <span class="string">&#x27;SCHEMA_INCOMPATIBLE&#x27;</span>&#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &#123;version, <span class="string">&#x27;OK&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Lua scripts in Redis provide atomicity for complex operations. This pattern is crucial for maintaining consistency in distributed systems without distributed locks.</em></p>
<h2 id="Service-Discovery-Integration"><a href="#Service-Discovery-Integration" class="headerlink" title="Service Discovery Integration"></a>Service Discovery Integration</h2><h3 id="Nacos-Integration-Pattern"><a href="#Nacos-Integration-Pattern" class="headerlink" title="Nacos Integration Pattern"></a>Nacos Integration Pattern</h3><pre>
<code class="mermaid">
sequenceDiagram
participant UI as ManageUI
participant GR as GreyRouter
participant Redis as Redis Cache
participant Nacos as Nacos Registry
participant PM as Project Mgmt

UI-&gt;&gt;GR: Get tenant services
GR-&gt;&gt;PM: Fetch tenant list
GR-&gt;&gt;Nacos: Query service versions
GR-&gt;&gt;Redis: Update cache
GR-&gt;&gt;UI: Return service matrix

UI-&gt;&gt;GR: Upgrade tenant service
GR-&gt;&gt;Redis: Update version mapping
GR-&gt;&gt;GR: Trigger schema upgrade
GR-&gt;&gt;UI: Confirm upgrade
</code>
</pre>

<h3 id="Service-Version-Discovery"><a href="#Service-Version-Discovery" class="headerlink" title="Service Version Discovery"></a>Service Version Discovery</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceVersionDiscovery</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> NacosNamingService namingService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 30000)</span> <span class="comment">// 30 seconds</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">syncServiceVersions</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;String&gt; services = namingService.getServicesOfServer(<span class="number">1</span>, Integer.MAX_VALUE).getData();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (String serviceName : services) &#123;</span><br><span class="line">                List&lt;Instance&gt; instances = namingService.getAllInstances(serviceName);</span><br><span class="line">                Set&lt;String&gt; versions = instances.stream()</span><br><span class="line">                    .map(instance -&gt; instance.getMetadata().get(<span class="string">&quot;version&quot;</span>))</span><br><span class="line">                    .filter(Objects::nonNull)</span><br><span class="line">                    .collect(Collectors.toSet());</span><br><span class="line">                </span><br><span class="line">                updateRedisVersions(serviceName, versions);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Failed to sync service versions&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Database-Schema-Management"><a href="#Database-Schema-Management" class="headerlink" title="Database Schema Management"></a>Database Schema Management</h2><h3 id="Schema-Versioning-Strategy"><a href="#Schema-Versioning-Strategy" class="headerlink" title="Schema Versioning Strategy"></a>Schema Versioning Strategy</h3><p><strong>Interview Insight</strong>: <em>Database schema evolution in multi-tenant systems requires careful consideration of backward compatibility and tenant isolation. Discuss migration strategies like blue-green deployments for schema changes.</em></p>
<pre>
<code class="mermaid">
graph LR
A[Schema v1.0] --&gt; B[Schema v1.1]
B --&gt; C[Schema v1.2]
C --&gt; D[Schema v2.0]

E[Tenant A] --&gt; A
F[Tenant B] --&gt; B
G[Tenant C] --&gt; C
H[Tenant D] --&gt; D

subgraph &quot;Compatibility Matrix&quot;
    I[Service v1.0 → Schema v1.0-1.1]
    J[Service v1.1 → Schema v1.1-1.2] 
    K[Service v2.0 → Schema v2.0+]
end
</code>
</pre>

<h3 id="Schema-Upgrade-Process"><a href="#Schema-Upgrade-Process" class="headerlink" title="Schema Upgrade Process"></a>Schema Upgrade Process</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SchemaUpgradeService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;UpgradeResult&gt; <span class="title function_">upgradeTenantSchema</span><span class="params">(</span></span><br><span class="line"><span class="params">            String tenantId, String serviceId, String targetVersion)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 1. Validate upgrade path</span></span><br><span class="line">                validateUpgradePath(tenantId, serviceId, targetVersion);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 2. Create database backup</span></span><br><span class="line">                <span class="type">BackupResult</span> <span class="variable">backup</span> <span class="operator">=</span> createSchemaBackup(tenantId, serviceId);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 3. Execute schema migrations</span></span><br><span class="line">                <span class="type">MigrationResult</span> <span class="variable">migration</span> <span class="operator">=</span> executeMigrations(tenantId, serviceId, targetVersion);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 4. Update Redis cache</span></span><br><span class="line">                updateSchemaVersion(tenantId, serviceId, targetVersion);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 5. Verify schema integrity</span></span><br><span class="line">                verifySchemaIntegrity(tenantId, serviceId);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> UpgradeResult.success(migration, backup);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// Rollback on failure</span></span><br><span class="line">                rollbackSchema(tenantId, serviceId);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SchemaUpgradeException</span>(<span class="string">&quot;Schema upgrade failed&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Request-Routing-Implementation"><a href="#Request-Routing-Implementation" class="headerlink" title="Request Routing Implementation"></a>Request Routing Implementation</h2><h3 id="Router-Gateway-Logic"><a href="#Router-Gateway-Logic" class="headerlink" title="Router Gateway Logic"></a>Router Gateway Logic</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreyRouterController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/route/&#123;tenantId&#125;/&#123;serviceId&#125;/**&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;?&gt; routeRequest(</span><br><span class="line">            <span class="meta">@PathVariable</span> String tenantId,</span><br><span class="line">            <span class="meta">@PathVariable</span> String serviceId,</span><br><span class="line">            HttpServletRequest request) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Execute Lua script for version resolution</span></span><br><span class="line">            DefaultRedisScript&lt;List&gt; script = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;();</span><br><span class="line">            script.setScriptText(loadLuaScript(<span class="string">&quot;version_router.lua&quot;</span>));</span><br><span class="line">            script.setResultType(List.class);</span><br><span class="line">            </span><br><span class="line">            List&lt;String&gt; result = redisTemplate.execute(script, </span><br><span class="line">                Collections.emptyList(), tenantId, serviceId);</span><br><span class="line">            </span><br><span class="line">            <span class="type">String</span> <span class="variable">version</span> <span class="operator">=</span> result.get(<span class="number">0</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> result.get(<span class="number">1</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (!<span class="string">&quot;OK&quot;</span>.equals(status)) &#123;</span><br><span class="line">                <span class="keyword">return</span> ResponseEntity.badRequest()</span><br><span class="line">                    .body(<span class="keyword">new</span> <span class="title class_">ErrorResponse</span>(status, <span class="string">&quot;Version resolution failed&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Route to appropriate service instance</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">targetUrl</span> <span class="operator">=</span> buildServiceUrl(serviceId, version, request);</span><br><span class="line">            <span class="keyword">return</span> forwardRequest(targetUrl, request);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Routing failed for tenant: &#123;&#125;, service: &#123;&#125;&quot;</span>, tenantId, serviceId, e);</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.status(HttpStatus.SERVICE_UNAVAILABLE)</span><br><span class="line">                .body(<span class="keyword">new</span> <span class="title class_">ErrorResponse</span>(<span class="string">&quot;ROUTING_ERROR&quot;</span>, e.getMessage()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Monitoring-and-Observability"><a href="#Monitoring-and-Observability" class="headerlink" title="Monitoring and Observability"></a>Monitoring and Observability</h2><h3 id="Metrics-Collection"><a href="#Metrics-Collection" class="headerlink" title="Metrics Collection"></a>Metrics Collection</h3><p><strong>Interview Insight</strong>: <em>In production systems, observability is crucial. Discuss metrics like request latency, error rates, and version distribution. Mention tools like Prometheus, Grafana, and distributed tracing.</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreyRouterMetrics</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Counter</span> <span class="variable">routingRequests</span> <span class="operator">=</span> Counter.build()</span><br><span class="line">        .name(<span class="string">&quot;grey_router_requests_total&quot;</span>)</span><br><span class="line">        .help(<span class="string">&quot;Total routing requests&quot;</span>)</span><br><span class="line">        .labelNames(<span class="string">&quot;tenant_id&quot;</span>, <span class="string">&quot;service_id&quot;</span>, <span class="string">&quot;version&quot;</span>, <span class="string">&quot;status&quot;</span>)</span><br><span class="line">        .register();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Histogram</span> <span class="variable">routingLatency</span> <span class="operator">=</span> Histogram.build()</span><br><span class="line">        .name(<span class="string">&quot;grey_router_latency_seconds&quot;</span>)</span><br><span class="line">        .help(<span class="string">&quot;Routing request latency&quot;</span>)</span><br><span class="line">        .labelNames(<span class="string">&quot;tenant_id&quot;</span>, <span class="string">&quot;service_id&quot;</span>)</span><br><span class="line">        .register();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordRouting</span><span class="params">(String tenantId, String serviceId, </span></span><br><span class="line"><span class="params">                            String version, String status, <span class="type">double</span> latency)</span> &#123;</span><br><span class="line">        routingRequests.labels(tenantId, serviceId, version, status).inc();</span><br><span class="line">        routingLatency.labels(tenantId, serviceId).observe(latency);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="High-Availability-Considerations"><a href="#High-Availability-Considerations" class="headerlink" title="High Availability Considerations"></a>High Availability Considerations</h2><h3 id="Redis-Clustering-Strategy"><a href="#Redis-Clustering-Strategy" class="headerlink" title="Redis Clustering Strategy"></a>Redis Clustering Strategy</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Redis Sentinel Configuration</span></span><br><span class="line"><span class="string">sentinel</span> <span class="string">monitor</span> <span class="string">grey-router-master</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">6379 </span><span class="number">2</span></span><br><span class="line"><span class="string">sentinel</span> <span class="string">down-after-milliseconds</span> <span class="string">grey-router-master</span> <span class="number">5000</span></span><br><span class="line"><span class="string">sentinel</span> <span class="string">failover-timeout</span> <span class="string">grey-router-master</span> <span class="number">10000</span></span><br><span class="line"><span class="string">sentinel</span> <span class="string">parallel-syncs</span> <span class="string">grey-router-master</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="Circuit-Breaker-Pattern"><a href="#Circuit-Breaker-Pattern" class="headerlink" title="Circuit Breaker Pattern"></a>Circuit Breaker Pattern</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceDiscoveryCircuitBreaker</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">CircuitBreaker</span> <span class="variable">circuitBreaker</span> <span class="operator">=</span> CircuitBreaker.ofDefaults(<span class="string">&quot;serviceDiscovery&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;List&lt;ServiceInstance&gt;&gt; <span class="title function_">getServiceInstances</span><span class="params">(String serviceName)</span> &#123;</span><br><span class="line">        Supplier&lt;CompletableFuture&lt;List&lt;ServiceInstance&gt;&gt;&gt; decoratedSupplier = </span><br><span class="line">            CircuitBreaker.decorateSupplier(circuitBreaker, () -&gt; &#123;</span><br><span class="line">                <span class="keyword">return</span> nacosDiscovery.getInstances(serviceName);</span><br><span class="line">            &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> decoratedSupplier.get()</span><br><span class="line">            .exceptionally(throwable -&gt; &#123;</span><br><span class="line">                <span class="comment">// Fallback to cached instances</span></span><br><span class="line">                <span class="keyword">return</span> getCachedInstances(serviceName);</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Security-Considerations"><a href="#Security-Considerations" class="headerlink" title="Security Considerations"></a>Security Considerations</h2><h3 id="Tenant-Isolation"><a href="#Tenant-Isolation" class="headerlink" title="Tenant Isolation"></a>Tenant Isolation</h3><p><strong>Interview Insight</strong>: <em>Multi-tenant security requires defense in depth. Discuss network isolation, data encryption, and access control mechanisms. Mention zero-trust principles.</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantSecurityFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, </span></span><br><span class="line"><span class="params">                        FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">httpRequest</span> <span class="operator">=</span> (HttpServletRequest) request;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> extractTenantId(httpRequest);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Validate tenant access</span></span><br><span class="line">        <span class="keyword">if</span> (!isValidTenant(tenantId)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnauthorizedException</span>(<span class="string">&quot;Invalid tenant access&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Set tenant context</span></span><br><span class="line">        TenantContext.setCurrentTenant(tenantId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            TenantContext.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Optimization"><a href="#Performance-Optimization" class="headerlink" title="Performance Optimization"></a>Performance Optimization</h2><h3 id="Caching-Strategy"><a href="#Caching-Strategy" class="headerlink" title="Caching Strategy"></a>Caching Strategy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VersionCacheService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Cacheable(value = &quot;tenant-versions&quot;, key = &quot;#tenantId + &#x27;:&#x27; + #serviceId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ServiceVersion <span class="title function_">getTenantServiceVersion</span><span class="params">(String tenantId, String serviceId)</span> &#123;</span><br><span class="line">        <span class="comment">// Redis lookup with fallback to service discovery</span></span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash()</span><br><span class="line">            .get(<span class="string">&quot;tenant:&quot;</span> + tenantId + <span class="string">&quot;:services&quot;</span>, serviceId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@CacheEvict(value = &quot;tenant-versions&quot;, key = &quot;#tenantId + &#x27;:&#x27; + #serviceId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">evictTenantServiceVersion</span><span class="params">(String tenantId, String serviceId)</span> &#123;</span><br><span class="line">        <span class="comment">// Cache invalidation after version updates</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Testing-Strategies"><a href="#Testing-Strategies" class="headerlink" title="Testing Strategies"></a>Testing Strategies</h2><h3 id="Integration-Testing"><a href="#Integration-Testing" class="headerlink" title="Integration Testing"></a>Integration Testing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@TestPropertySource(properties = &#123;</span></span><br><span class="line"><span class="meta">    &quot;spring.redis.host=localhost&quot;,</span></span><br><span class="line"><span class="meta">    &quot;spring.redis.port=6379&quot;</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GreyRouterIntegrationTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldRouteToCorrectServiceVersion</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Given</span></span><br><span class="line">        setupTenantServiceMapping(<span class="string">&quot;tenant1&quot;</span>, <span class="string">&quot;user-service&quot;</span>, <span class="string">&quot;v1.2.0&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When</span></span><br><span class="line">        ResponseEntity&lt;String&gt; response = restTemplate.postForEntity(</span><br><span class="line">            <span class="string">&quot;/route/tenant1/user-service/users&quot;</span>, requestBody, String.class);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Then</span></span><br><span class="line">        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);</span><br><span class="line">        verifyServiceVersionCalled(<span class="string">&quot;user-service&quot;</span>, <span class="string">&quot;v1.2.0&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Production-Deployment"><a href="#Production-Deployment" class="headerlink" title="Production Deployment"></a>Production Deployment</h2><h3 id="Docker-Configuration"><a href="#Docker-Configuration" class="headerlink" title="Docker Configuration"></a>Docker Configuration</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">17</span>-jre-slim</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> target/grey-service-router-*.jar app.jar</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> JAVA_OPTS=<span class="string">&quot;-Xmx2g -Xms1g -XX:+UseG1GC&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> REDIS_HOST=redis-cluster</span><br><span class="line"><span class="keyword">ENV</span> NACOS_HOST=nacos-server</span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;java <span class="variable">$JAVA_OPTS</span> -jar /app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h3 id="Kubernetes-Deployment"><a href="#Kubernetes-Deployment" class="headerlink" title="Kubernetes Deployment"></a>Kubernetes Deployment</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grey-service-router</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">grey-service-router</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">grey-service-router</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">router</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">grey-service-router:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">REDIS_HOST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;redis-cluster&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NACOS_HOST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;nacos-server&quot;</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;2Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;1000m&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="External-References"><a href="#External-References" class="headerlink" title="External References"></a>External References</h2><ul>
<li><strong>Redis Lua Scripting</strong>: <a target="_blank" rel="noopener" href="https://redis.io/docs/manual/programmability/lua-api/">Redis Lua Scripts Documentation</a></li>
<li><strong>Nacos Service Discovery</strong>: <a target="_blank" rel="noopener" href="https://nacos.io/en-us/docs/discovery-concepts.html">Nacos Discovery Configuration</a></li>
<li><strong>Circuit Breaker Pattern</strong>: <a target="_blank" rel="noopener" href="https://resilience4j.readme.io/docs/circuitbreaker">Resilience4j Documentation</a></li>
<li><strong>Multi-tenant Architecture</strong>: <a target="_blank" rel="noopener" href="https://aws.amazon.com/blogs/apn/building-a-multi-tenant-saas-application-with-aws-serverless-services/">AWS Multi-Tenant SaaS Architecture</a></li>
<li><strong>Database Schema Evolution</strong>: <a target="_blank" rel="noopener" href="https://martinfowler.com/articles/evodb.html">Evolutionary Database Design</a></li>
</ul>
<p>This grey service router system provides a robust foundation for managing multi-tenant service deployments with granular version control and database schema evolution capabilities. The architecture emphasizes scalability, reliability, and operational excellence through comprehensive monitoring and testing strategies.</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/system-design/" rel="tag"># system-design</a>
              <a href="/tags/grey-service-router/" rel="tag"># grey service router</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/06/12/Design-Privilege-Systems-RBAC-ABAC-Integration-Guide/" rel="prev" title="Design Privilege Systems: RBAC + ABAC Integration Guide">
                  <i class="fa fa-angle-left"></i> Design Privilege Systems: RBAC + ABAC Integration Guide
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/06/12/Design-User-Login-Systems-with-SSO-Feature/" rel="next" title="Design User Login Systems with SSO Feature">
                  Design User Login Systems with SSO Feature <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Charlie Feng</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
