<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"shayne007.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="OverviewA grey service router system enables controlled service version management across multi-tenant environments, allowing gradual rollouts, A&#x2F;B testing, and safe database schema migrations. T">
<meta property="og:type" content="article">
<meta property="og:title" content="Design Grey Service Router Guide">
<meta property="og:url" content="https://shayne007.github.io/2025/06/12/Design-Grey-Service-Router-Guide/index.html">
<meta property="og:site_name" content="Charlie Feng&#39;s Tech Space">
<meta property="og:description" content="OverviewA grey service router system enables controlled service version management across multi-tenant environments, allowing gradual rollouts, A&#x2F;B testing, and safe database schema migrations. T">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-06-12T14:04:26.000Z">
<meta property="article:modified_time" content="2025-07-01T07:02:58.737Z">
<meta property="article:author" content="Charlie Feng">
<meta property="article:tag" content="system-design">
<meta property="article:tag" content="grey service router">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://shayne007.github.io/2025/06/12/Design-Grey-Service-Router-Guide/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://shayne007.github.io/2025/06/12/Design-Grey-Service-Router-Guide/","path":"2025/06/12/Design-Grey-Service-Router-Guide/","title":"Design Grey Service Router Guide"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Design Grey Service Router Guide | Charlie Feng's Tech Space</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"cdn":false,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.5.0/mermaid.min.js","integrity":"sha256-2obLuIPcceEhkE3G09G33hBdmE55ivVcZUlcKcGNHjU="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>





  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Charlie Feng's Tech Space</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">You will survive with skills</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Overview"><span class="nav-number">1.</span> <span class="nav-text">Overview</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Key-Benefits"><span class="nav-number">1.1.</span> <span class="nav-text">Key Benefits</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#System-Architecture"><span class="nav-number">2.</span> <span class="nav-text">System Architecture</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Core-Components"><span class="nav-number">3.</span> <span class="nav-text">Core Components</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GreyRouterService"><span class="nav-number">3.1.</span> <span class="nav-text">GreyRouterService</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Data-Structures-in-Redis"><span class="nav-number">3.2.</span> <span class="nav-text">Data Structures in Redis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lua-Script-for-Routing-and-Load-Balancing"><span class="nav-number">3.3.</span> <span class="nav-text">Lua Script for Routing and Load Balancing</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GreyRouterSDK-Client"><span class="nav-number">3.4.</span> <span class="nav-text">GreyRouterSDK Client</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#API-Gateway-Integration"><span class="nav-number">3.5.</span> <span class="nav-text">API Gateway Integration</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Database-Schema-Management"><span class="nav-number">4.</span> <span class="nav-text">Database Schema Management</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Schema-Version-Control"><span class="nav-number">4.1.</span> <span class="nav-text">Schema Version Control</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Migration-Example"><span class="nav-number">4.2.</span> <span class="nav-text">Migration Example</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Management-UI-Implementation"><span class="nav-number">5.</span> <span class="nav-text">Management UI Implementation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Frontend-Service-Assignment"><span class="nav-number">5.1.</span> <span class="nav-text">Frontend Service Assignment</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Backend-API-for-Management"><span class="nav-number">5.2.</span> <span class="nav-text">Backend API for Management</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Integration-with-External-Systems"><span class="nav-number">6.</span> <span class="nav-text">Integration with External Systems</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Nacos-Integration"><span class="nav-number">6.1.</span> <span class="nav-text">Nacos Integration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TenantManagementService-Integration"><span class="nav-number">6.2.</span> <span class="nav-text">TenantManagementService Integration</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Use-Cases-and-Examples"><span class="nav-number">7.</span> <span class="nav-text">Use Cases and Examples</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Use-Case-1-Gradual-Service-Rollout"><span class="nav-number">7.1.</span> <span class="nav-text">Use Case 1: Gradual Service Rollout</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Use-Case-2-A-B-Testing"><span class="nav-number">7.2.</span> <span class="nav-text">Use Case 2: A&#x2F;B Testing</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Use-Case-3-Emergency-Rollback"><span class="nav-number">7.3.</span> <span class="nav-text">Use Case 3: Emergency Rollback</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Monitoring-and-Observability"><span class="nav-number">8.</span> <span class="nav-text">Monitoring and Observability</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Metrics-Collection"><span class="nav-number">8.1.</span> <span class="nav-text">Metrics Collection</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Health-Checks"><span class="nav-number">8.2.</span> <span class="nav-text">Health Checks</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Performance-Optimization"><span class="nav-number">9.</span> <span class="nav-text">Performance Optimization</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Caching-Strategy"><span class="nav-number">9.1.</span> <span class="nav-text">Caching Strategy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Connection-Pooling"><span class="nav-number">9.2.</span> <span class="nav-text">Connection Pooling</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Security-Considerations"><span class="nav-number">10.</span> <span class="nav-text">Security Considerations</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Authentication-and-Authorization"><span class="nav-number">10.1.</span> <span class="nav-text">Authentication and Authorization</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Data-Encryption"><span class="nav-number">10.2.</span> <span class="nav-text">Data Encryption</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Interview-Questions-and-Insights"><span class="nav-number">11.</span> <span class="nav-text">Interview Questions and Insights</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Technical-Architecture-Questions"><span class="nav-number">11.1.</span> <span class="nav-text">Technical Architecture Questions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Performance-and-Scalability-Questions"><span class="nav-number">11.2.</span> <span class="nav-text">Performance and Scalability Questions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Operational-Excellence-Questions"><span class="nav-number">11.3.</span> <span class="nav-text">Operational Excellence Questions</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Best-Practices-and-Recommendations"><span class="nav-number">12.</span> <span class="nav-text">Best Practices and Recommendations</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Configuration-Management"><span class="nav-number">12.1.</span> <span class="nav-text">Configuration Management</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Error-Handling-Patterns"><span class="nav-number">12.2.</span> <span class="nav-text">Error Handling Patterns</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Testing-Strategies"><span class="nav-number">12.3.</span> <span class="nav-text">Testing Strategies</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Production-Deployment-Considerations"><span class="nav-number">13.</span> <span class="nav-text">Production Deployment Considerations</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Infrastructure-Requirements"><span class="nav-number">13.1.</span> <span class="nav-text">Infrastructure Requirements</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kubernetes-Deployment"><span class="nav-number">13.2.</span> <span class="nav-text">Kubernetes Deployment</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Monitoring-and-Alerting-Configuration"><span class="nav-number">13.3.</span> <span class="nav-text">Monitoring and Alerting Configuration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Database-Migration-Best-Practices"><span class="nav-number">13.4.</span> <span class="nav-text">Database Migration Best Practices</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Advanced-Features"><span class="nav-number">14.</span> <span class="nav-text">Advanced Features</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Multi-Region-Support"><span class="nav-number">14.1.</span> <span class="nav-text">Multi-Region Support</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Canary-Release-Automation"><span class="nav-number">14.2.</span> <span class="nav-text">Canary Release Automation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Advanced-Load-Balancing-Strategies"><span class="nav-number">14.3.</span> <span class="nav-text">Advanced Load Balancing Strategies</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Security-Deep-Dive"><span class="nav-number">15.</span> <span class="nav-text">Security Deep Dive</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#OAuth2-Integration"><span class="nav-number">15.1.</span> <span class="nav-text">OAuth2 Integration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Rate-Limiting-and-Throttling"><span class="nav-number">15.2.</span> <span class="nav-text">Rate Limiting and Throttling</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Performance-Benchmarking"><span class="nav-number">16.</span> <span class="nav-text">Performance Benchmarking</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Load-Testing-Results"><span class="nav-number">16.1.</span> <span class="nav-text">Load Testing Results</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Disaster-Recovery-and-Business-Continuity"><span class="nav-number">17.</span> <span class="nav-text">Disaster Recovery and Business Continuity</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Backup-and-Recovery-Strategies"><span class="nav-number">17.1.</span> <span class="nav-text">Backup and Recovery Strategies</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#High-Availability-Setup"><span class="nav-number">17.2.</span> <span class="nav-text">High Availability Setup</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Future-Enhancements-and-Roadmap"><span class="nav-number">18.</span> <span class="nav-text">Future Enhancements and Roadmap</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Machine-Learning-Integration"><span class="nav-number">18.1.</span> <span class="nav-text">Machine Learning Integration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Event-Sourcing-Integration"><span class="nav-number">18.2.</span> <span class="nav-text">Event Sourcing Integration</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Conclusion"><span class="nav-number">19.</span> <span class="nav-text">Conclusion</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#External-References"><span class="nav-number">20.</span> <span class="nav-text">External References</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Charlie Feng</p>
  <div class="site-description" itemprop="description">This place is for thinking and sharing.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">50</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/12/Design-Grey-Service-Router-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Design Grey Service Router Guide | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Design Grey Service Router Guide
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-12 22:04:26" itemprop="dateCreated datePublished" datetime="2025-06-12T22:04:26+08:00">2025-06-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-07-01 15:02:58" itemprop="dateModified" datetime="2025-07-01T15:02:58+08:00">2025-07-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system-design/" itemprop="url" rel="index"><span itemprop="name">system-design</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>A grey service router system enables controlled service version management across multi-tenant environments, allowing gradual rollouts, A&#x2F;B testing, and safe database schema migrations. This system provides the infrastructure to route requests to specific service versions based on tenant configuration while maintaining high availability and performance.</p>
<h3 id="Key-Benefits"><a href="#Key-Benefits" class="headerlink" title="Key Benefits"></a>Key Benefits</h3><ul>
<li><strong>Risk Mitigation</strong>: Gradual rollout reduces blast radius of potential issues</li>
<li><strong>Tenant Isolation</strong>: Each tenant can use different service versions independently</li>
<li><strong>Schema Management</strong>: Controlled database migrations per tenant</li>
<li><strong>Load Balancing</strong>: Intelligent traffic distribution across service instances</li>
</ul>
<h2 id="System-Architecture"><a href="#System-Architecture" class="headerlink" title="System Architecture"></a>System Architecture</h2><pre>
<code class="mermaid">
flowchart TB
A[Client Request] --&gt; B[GreyRouterSDK]
B --&gt; C[GreyRouterService]
C --&gt; D[Redis Cache]
C --&gt; E[TenantManagementService]
C --&gt; F[Nacos Registry]

G[GreyServiceManageUI] --&gt; C

D --&gt; H[Service Instance V1.0]
D --&gt; I[Service Instance V1.1]
D --&gt; J[Service Instance V2.0]

C --&gt; K[Database Schema Manager]
K --&gt; L[(Tenant DB 1)]
K --&gt; M[(Tenant DB 2)]
K --&gt; N[(Tenant DB 3)]

subgraph &quot;Service Versions&quot;
    H
    I
    J
end

subgraph &quot;Tenant Databases&quot;
    L
    M
    N
end
</code>
</pre>

<h2 id="Core-Components"><a href="#Core-Components" class="headerlink" title="Core Components"></a>Core Components</h2><h3 id="GreyRouterService"><a href="#GreyRouterService" class="headerlink" title="GreyRouterService"></a>GreyRouterService</h3><p>The central service that orchestrates routing decisions and manages service versions.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/grey-router&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreyRouterController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GreyRouterService greyRouterService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/route&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;ServiceInstanceInfo&gt; <span class="title function_">routeRequest</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestBody</span> RouteRequest request)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">ServiceInstanceInfo</span> <span class="variable">instance</span> <span class="operator">=</span> greyRouterService</span><br><span class="line">            .routeToServiceInstance(</span><br><span class="line">                request.getTenantId(),</span><br><span class="line">                request.getServiceName(),</span><br><span class="line">                request.getRequestMetadata()</span><br><span class="line">            );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(instance);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upgrade-schema/&#123;tenantId&#125;/&#123;serviceVersion&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;UpgradeResult&gt; <span class="title function_">upgradeSchema</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String tenantId,</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String serviceVersion)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">UpgradeResult</span> <span class="variable">result</span> <span class="operator">=</span> greyRouterService</span><br><span class="line">            .upgradeDatabaseSchema(tenantId, serviceVersion);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Data-Structures-in-Redis"><a href="#Data-Structures-in-Redis" class="headerlink" title="Data Structures in Redis"></a>Data Structures in Redis</h3><p>Carefully designed Redis data structures optimize routing performance:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisDataStructures</span> &#123;</span><br><span class="line">    <span class="comment">// Tenant to Service Version Mapping</span></span><br><span class="line">    <span class="comment">// Key: tenant:&#123;tenant_id&#125;:services</span></span><br><span class="line">    <span class="comment">// Type: Hash</span></span><br><span class="line">    <span class="comment">// Structure: &#123;service_name: version, service_name: version, ...&#125;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TENANT_SERVICE_VERSIONS</span> <span class="operator">=</span> <span class="string">&quot;tenant:%s:services&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Service Version to Instances Mapping</span></span><br><span class="line">    <span class="comment">// Key: service:&#123;service_name&#125;:version:&#123;version&#125;:instances</span></span><br><span class="line">    <span class="comment">// Type: Set</span></span><br><span class="line">    <span class="comment">// Structure: &#123;instance_id1, instance_id2, ...&#125;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SERVICE_INSTANCES</span> <span class="operator">=</span> <span class="string">&quot;service:%s:version:%s:instances&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Set: active_tenants</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ACTIVE_TENANTS</span> <span class="operator">=</span> <span class="string">&quot;active_tenants&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Hash: tenant:&#123;tenantId&#125;:metadata -&gt; &#123;key: value&#125;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TENANT_METADATA</span> <span class="operator">=</span> <span class="string">&quot;tenant:%s:metadata&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Example data structure usage</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">storeTenantServiceMapping</span><span class="params">(String tenantId, </span></span><br><span class="line"><span class="params">                                        Map&lt;String, String&gt; serviceVersions)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> String.format(TENANT_SERVICE_VERSIONS, tenantId);</span><br><span class="line">        redisTemplate.opsForHash().putAll(key, serviceVersions);</span><br><span class="line">        redisTemplate.expire(key, Duration.ofHours(<span class="number">24</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Lua-Script-for-Routing-and-Load-Balancing"><a href="#Lua-Script-for-Routing-and-Load-Balancing" class="headerlink" title="Lua Script for Routing and Load Balancing"></a>Lua Script for Routing and Load Balancing</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- grey_router.lua</span></span><br><span class="line"><span class="comment">-- Args: tenantId, serviceName, loadBalanceStrategy</span></span><br><span class="line"><span class="comment">-- Returns: selected service instance details</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> tenant_id = ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">local</span> service_name = ARGV[<span class="number">2</span>]</span><br><span class="line"><span class="keyword">local</span> lb_strategy = ARGV[<span class="number">3</span>] <span class="keyword">or</span> <span class="string">&quot;round_robin&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Get tenant&#x27;s designated service version</span></span><br><span class="line"><span class="keyword">local</span> tenant_services_key = <span class="string">&quot;tenant:&quot;</span> .. tenant_id .. <span class="string">&quot;:services&quot;</span></span><br><span class="line"><span class="keyword">local</span> service_version = redis.call(<span class="string">&#x27;HGET&#x27;</span>, tenant_services_key, service_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> service_version <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> &#123;err = <span class="string">&quot;Service version not found for tenant&quot;</span>&#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Get available instances for this service version</span></span><br><span class="line"><span class="keyword">local</span> instances_key = <span class="string">&quot;service:&quot;</span> .. service_name .. <span class="string">&quot;:version:&quot;</span> .. service_version .. <span class="string">&quot;:instances&quot;</span></span><br><span class="line"><span class="keyword">local</span> instances = redis.call(<span class="string">&#x27;SMEMBERS&#x27;</span>, instances_key)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> #instances == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> &#123;err = <span class="string">&quot;No instances available&quot;</span>&#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Load balancing logic</span></span><br><span class="line"><span class="keyword">local</span> selected_instance</span><br><span class="line"><span class="keyword">if</span> lb_strategy == <span class="string">&quot;round_robin&quot;</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">local</span> counter_key = instances_key .. <span class="string">&quot;:counter&quot;</span></span><br><span class="line">    <span class="keyword">local</span> counter = redis.call(<span class="string">&#x27;INCR&#x27;</span>, counter_key)</span><br><span class="line">    <span class="keyword">local</span> index = ((counter - <span class="number">1</span>) % #instances) + <span class="number">1</span></span><br><span class="line">    selected_instance = instances[index]</span><br><span class="line"><span class="keyword">elseif</span> lb_strategy == <span class="string">&quot;random&quot;</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">local</span> index = <span class="built_in">math</span>.<span class="built_in">random</span>(<span class="number">1</span>, #instances)</span><br><span class="line">    selected_instance = instances[index]</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Update instance usage metrics</span></span><br><span class="line"><span class="keyword">local</span> usage_key = <span class="string">&quot;instance:&quot;</span> .. selected_instance .. <span class="string">&quot;:usage&quot;</span></span><br><span class="line">redis.call(<span class="string">&#x27;INCR&#x27;</span>, usage_key)</span><br><span class="line">redis.call(<span class="string">&#x27;EXPIRE&#x27;</span>, usage_key, <span class="number">300</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">    instance = selected_instance,</span><br><span class="line">    version = service_version,</span><br><span class="line">    timestamp = redis.call(<span class="string">&#x27;TIME&#x27;</span>)[<span class="number">1</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="GreyRouterSDK-Client"><a href="#GreyRouterSDK-Client" class="headerlink" title="GreyRouterSDK Client"></a>GreyRouterSDK Client</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreyRouterSDK</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RestTemplate restTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String greyRouterServiceUrl;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">executeWithRouting</span><span class="params">(String tenantId, String serviceName, </span></span><br><span class="line"><span class="params">                                  ServiceCall&lt;T&gt; serviceCall)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Get routing information</span></span><br><span class="line">        <span class="type">ServiceInstanceInfo</span> <span class="variable">instance</span> <span class="operator">=</span> getServiceInstance(tenantId, serviceName);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Execute with circuit breaker and retry</span></span><br><span class="line">        <span class="keyword">return</span> executeWithResilience(instance, serviceCall);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> ServiceInstanceInfo <span class="title function_">getServiceInstance</span><span class="params">(String tenantId, String serviceName)</span> &#123;</span><br><span class="line">        <span class="comment">// First try Redis cache</span></span><br><span class="line">        <span class="type">ServiceInstanceInfo</span> <span class="variable">cached</span> <span class="operator">=</span> getCachedInstance(tenantId, serviceName);</span><br><span class="line">        <span class="keyword">if</span> (cached != <span class="literal">null</span> &amp;&amp; isInstanceHealthy(cached)) &#123;</span><br><span class="line">            <span class="keyword">return</span> cached;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Fallback to router service</span></span><br><span class="line">        <span class="type">RouteRequest</span> <span class="variable">request</span> <span class="operator">=</span> RouteRequest.builder()</span><br><span class="line">            .tenantId(tenantId)</span><br><span class="line">            .serviceName(serviceName)</span><br><span class="line">            .build();</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> restTemplate.postForObject(</span><br><span class="line">            greyRouterServiceUrl + <span class="string">&quot;/route&quot;</span>, </span><br><span class="line">            request, </span><br><span class="line">            ServiceInstanceInfo.class</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Retryable(value = &#123;Exception.class&#125;, maxAttempts = 3)</span></span><br><span class="line">    <span class="keyword">private</span> &lt;T&gt; T <span class="title function_">executeWithResilience</span><span class="params">(ServiceInstanceInfo instance, </span></span><br><span class="line"><span class="params">                                      ServiceCall&lt;T&gt; serviceCall)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> serviceCall.execute(instance);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// Mark instance as unhealthy temporarily</span></span><br><span class="line">            markInstanceUnhealthy(instance);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="API-Gateway-Integration"><a href="#API-Gateway-Integration" class="headerlink" title="API Gateway Integration"></a>API Gateway Integration</h3><p>The routing logic integrates with API gateways to intercept requests and apply tenant-specific routing:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreyRouteFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> extractTenantId(exchange.getRequest());</span><br><span class="line">        <span class="type">String</span> <span class="variable">serviceName</span> <span class="operator">=</span> extractServiceName(exchange.getRequest());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (tenantId != <span class="literal">null</span> &amp;&amp; serviceName != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> routeToSpecificVersion(exchange, chain, tenantId, serviceName);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Mono&lt;Void&gt; <span class="title function_">routeToSpecificVersion</span><span class="params">(ServerWebExchange exchange, </span></span><br><span class="line"><span class="params">                                             GatewayFilterChain chain,</span></span><br><span class="line"><span class="params">                                             String tenantId, </span></span><br><span class="line"><span class="params">                                             String serviceName)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Execute Lua script for atomic routing decision</span></span><br><span class="line">        DefaultRedisScript&lt;Map&gt; script = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;();</span><br><span class="line">        script.setScriptText(loadLuaScript(<span class="string">&quot;route_and_balance.lua&quot;</span>));</span><br><span class="line">        script.setResultType(Map.class);</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, Object&gt; result = redisTemplate.execute(script, </span><br><span class="line">            Collections.emptyList(), tenantId, serviceName);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (result.containsKey(<span class="string">&quot;err&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> handleRoutingError(exchange, (String) result.get(<span class="string">&quot;err&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">targetInstance</span> <span class="operator">=</span> (String) result.get(<span class="string">&quot;instance&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">version</span> <span class="operator">=</span> (String) result.get(<span class="string">&quot;version&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Modify request to target specific instance</span></span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">modifiedRequest</span> <span class="operator">=</span> exchange.getRequest().mutate()</span><br><span class="line">            .header(<span class="string">&quot;X-Target-Instance&quot;</span>, targetInstance)</span><br><span class="line">            .header(<span class="string">&quot;X-Service-Version&quot;</span>, version)</span><br><span class="line">            .build();</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange.mutate().request(modifiedRequest).build());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">100</span>; <span class="comment">// Execute before other filters</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Database-Schema-Management"><a href="#Database-Schema-Management" class="headerlink" title="Database Schema Management"></a>Database Schema Management</h2><h3 id="Schema-Version-Control"><a href="#Schema-Version-Control" class="headerlink" title="Schema Version Control"></a>Schema Version Control</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseSchemaManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSourceManager dataSourceManager;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> UpgradeResult <span class="title function_">upgradeTenantSchema</span><span class="params">(String tenantId, </span></span><br><span class="line"><span class="params">                                           String serviceVersion)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">tenantDataSource</span> <span class="operator">=</span> dataSourceManager</span><br><span class="line">            .getTenantDataSource(tenantId);</span><br><span class="line">            </span><br><span class="line">        List&lt;SchemaMigration&gt; migrations = getSchemaMigrations(serviceVersion);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> executeTransactionalMigration(tenantDataSource, migrations);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">private</span> UpgradeResult <span class="title function_">executeTransactionalMigration</span><span class="params">(</span></span><br><span class="line"><span class="params">            DataSource dataSource, </span></span><br><span class="line"><span class="params">            List&lt;SchemaMigration&gt; migrations)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">UpgradeResult</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UpgradeResult</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (SchemaMigration migration : migrations) &#123;</span><br><span class="line">                executeMigration(dataSource, migration);</span><br><span class="line">                updateSchemaVersion(dataSource, migration.getVersion());</span><br><span class="line">            &#125;</span><br><span class="line">            result.setSuccess(<span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            result.setSuccess(<span class="literal">false</span>);</span><br><span class="line">            result.setErrorMessage(e.getMessage());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SchemaUpgradeException</span>(<span class="string">&quot;Migration failed&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">executeMigration</span><span class="params">(DataSource dataSource, </span></span><br><span class="line"><span class="params">                                SchemaMigration migration)</span> &#123;</span><br><span class="line">        <span class="type">JdbcTemplate</span> <span class="variable">jdbcTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcTemplate</span>(dataSource);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Validate migration before execution</span></span><br><span class="line">        validateMigration(migration);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Execute with timeout</span></span><br><span class="line">        jdbcTemplate.update(migration.getSql());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Log migration execution</span></span><br><span class="line">        logMigrationExecution(migration);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Migration-Example"><a href="#Migration-Example" class="headerlink" title="Migration Example"></a>Migration Example</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- V1.1__add_user_preferences.sql</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> users <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> preferences JSON;</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_users_preferences <span class="keyword">ON</span> users <span class="keyword">USING</span> GIN (preferences);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- V1.2__update_order_status.sql  </span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> orders <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> status_updated_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> orders <span class="keyword">SET</span> status_updated_at <span class="operator">=</span> created_at <span class="keyword">WHERE</span> status_updated_at <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure>

<h2 id="Management-UI-Implementation"><a href="#Management-UI-Implementation" class="headerlink" title="Management UI Implementation"></a>Management UI Implementation</h2><h3 id="Frontend-Service-Assignment"><a href="#Frontend-Service-Assignment" class="headerlink" title="Frontend Service Assignment"></a>Frontend Service Assignment</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TenantServiceManagement.jsx</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; useState, useEffect &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">TenantServiceManagement</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> [tenants, setTenants] = <span class="title function_">useState</span>([]);</span><br><span class="line">    <span class="keyword">const</span> [selectedTenant, setSelectedTenant] = <span class="title function_">useState</span>(<span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">const</span> [services, setServices] = <span class="title function_">useState</span>([]);</span><br><span class="line">    <span class="keyword">const</span> [pendingUpgrades, setPendingUpgrades] = <span class="title function_">useState</span>(&#123;&#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">loadTenantServices</span> = <span class="keyword">async</span> (<span class="params">tenantId</span>) =&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">`/api/tenants/<span class="subst">$&#123;tenantId&#125;</span>/services`</span>);</span><br><span class="line">            <span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">            <span class="title function_">setServices</span>(data);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Failed to load tenant services:&#x27;</span>, error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleVersionChange</span> = (<span class="params">serviceId, newVersion</span>) =&gt; &#123;</span><br><span class="line">        <span class="title function_">setPendingUpgrades</span>(<span class="function"><span class="params">prev</span> =&gt;</span> (&#123;</span><br><span class="line">            ...prev,</span><br><span class="line">            [serviceId]: newVersion</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">applyUpgrades</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> [serviceId, version] <span class="keyword">of</span> <span class="title class_">Object</span>.<span class="title function_">entries</span>(pendingUpgrades)) &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">updateServiceVersion</span>(selectedTenant.<span class="property">id</span>, serviceId, version);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">setPendingUpgrades</span>(&#123;&#125;);</span><br><span class="line">        <span class="title function_">loadTenantServices</span>(selectedTenant.<span class="property">id</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;tenant-service-management&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">TenantSelector</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">tenants</span>=<span class="string">&#123;tenants&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">onSelect</span>=<span class="string">&#123;setSelectedTenant&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            /&gt;</span></span></span><br><span class="line"><span class="language-xml">            </span></span><br><span class="line"><span class="language-xml">            &#123;selectedTenant &amp;&amp; (</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">ServiceVersionTable</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">services</span>=<span class="string">&#123;services&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">pendingUpgrades</span>=<span class="string">&#123;pendingUpgrades&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">onVersionChange</span>=<span class="string">&#123;handleVersionChange&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml">            )&#125;</span></span><br><span class="line"><span class="language-xml">            </span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;applyUpgrades&#125;</span> <span class="attr">disabled</span>=<span class="string">&#123;!Object.keys(pendingUpgrades).length&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                Apply Upgrades</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="Backend-API-for-Management"><a href="#Backend-API-for-Management" class="headerlink" title="Backend API for Management"></a>Backend API for Management</h3><pre>
<code class="mermaid">
sequenceDiagram
participant Admin as Administrator
participant UI as ManageUI
participant Router as GreyRouterService
participant Redis as Redis Cache
participant DB as Tenant Database

Admin-&gt;&gt;UI: Select tenant &quot;acme-corp&quot;
UI-&gt;&gt;Router: GET &#x2F;api&#x2F;tenants&#x2F;acme-corp&#x2F;services
Router-&gt;&gt;Redis: HGETALL tenant:acme-corp:services
Redis--&gt;&gt;Router: {user-service: &quot;v1.0&quot;, order-service: &quot;v1.2&quot;}
Router--&gt;&gt;UI: Service version mapping
UI--&gt;&gt;Admin: Display service version table

Admin-&gt;&gt;UI: Update user-service to v2.0
UI-&gt;&gt;Router: PUT &#x2F;api&#x2F;tenants&#x2F;acme-corp&#x2F;services&#x2F;user-service
Router-&gt;&gt;Redis: HSET tenant:acme-corp:services user-service &quot;v2.0&quot;

Admin-&gt;&gt;UI: Trigger schema upgrade
UI-&gt;&gt;Router: POST &#x2F;api&#x2F;tenants&#x2F;acme-corp&#x2F;schema-upgrade
Router-&gt;&gt;DB: Execute migration scripts
DB--&gt;&gt;Router: Migration completed
Router-&gt;&gt;Redis: HSET tenant:acme-corp:db_schema user-service &quot;20240320001&quot;
Router--&gt;&gt;UI: Upgrade successful
</code>
</pre>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/tenants&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantManagementController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;tenantId&#125;/services&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;List&lt;ServiceInfo&gt;&gt; <span class="title function_">getTenantServices</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String tenantId)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        List&lt;ServiceInfo&gt; services = tenantService.getTenantServices(tenantId);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(services);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PutMapping(&quot;/&#123;tenantId&#125;/services/&#123;serviceId&#125;/version&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;UpdateResult&gt; <span class="title function_">updateServiceVersion</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String tenantId,</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String serviceId,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestBody</span> VersionUpdateRequest request)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Validate version compatibility</span></span><br><span class="line">        <span class="type">ValidationResult</span> <span class="variable">validation</span> <span class="operator">=</span> versionCompatibilityService</span><br><span class="line">            .validateUpgrade(serviceId, request.getCurrentVersion(), </span><br><span class="line">                           request.getTargetVersion());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!validation.isValid()) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.badRequest()</span><br><span class="line">                .body(UpdateResult.failure(validation.getErrors()));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Update routing configuration</span></span><br><span class="line">        <span class="type">UpdateResult</span> <span class="variable">result</span> <span class="operator">=</span> greyRouterService.updateTenantServiceVersion(</span><br><span class="line">            tenantId, serviceId, request.getTargetVersion());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(result);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/&#123;tenantId&#125;/schema-upgrade&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;UpgradeResult&gt; <span class="title function_">triggerSchemaUpgrade</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String tenantId,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestBody</span> SchemaUpgradeRequest request)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Async schema upgrade with progress tracking</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">upgradeId</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        </span><br><span class="line">        CompletableFuture.supplyAsync(() -&gt; </span><br><span class="line">            databaseSchemaManager.upgradeTenantSchema(tenantId, request.getVersion())</span><br><span class="line">        ).whenComplete((result, throwable) -&gt; &#123;</span><br><span class="line">            notificationService.notifyUpgradeComplete(tenantId, upgradeId, result);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.accepted()</span><br><span class="line">            .body(UpgradeResult.inProgress(upgradeId));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Integration-with-External-Systems"><a href="#Integration-with-External-Systems" class="headerlink" title="Integration with External Systems"></a>Integration with External Systems</h2><h3 id="Nacos-Integration"><a href="#Nacos-Integration" class="headerlink" title="Nacos Integration"></a>Nacos Integration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NacosServiceDiscovery</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> NamingService namingService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedDelay = 30000)</span> <span class="comment">// 30 seconds</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refreshServiceInstances</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;String&gt; services = namingService.getServicesOfServer(<span class="number">1</span>, <span class="number">1000</span>).getData();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (String serviceName : services) &#123;</span><br><span class="line">                List&lt;Instance&gt; instances = namingService.getAllInstances(serviceName);</span><br><span class="line">                updateRedisServiceInstances(serviceName, instances);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Failed to refresh service instances from Nacos&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateRedisServiceInstances</span><span class="params">(String serviceName, </span></span><br><span class="line"><span class="params">                                           List&lt;Instance&gt; instances)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, List&lt;String&gt;&gt; versionInstances = instances.stream()</span><br><span class="line">            .filter(Instance::isEnabled)</span><br><span class="line">            .collect(Collectors.groupingBy(</span><br><span class="line">                instance -&gt; instance.getMetadata().getOrDefault(<span class="string">&quot;version&quot;</span>, <span class="string">&quot;1.0&quot;</span>),</span><br><span class="line">                Collectors.mapping(instance -&gt; </span><br><span class="line">                    instance.getIp() + <span class="string">&quot;:&quot;</span> + instance.getPort(),</span><br><span class="line">                    Collectors.toList())</span><br><span class="line">            ));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Update Redis atomically</span></span><br><span class="line">        redisTemplate.execute((RedisCallback&lt;Void&gt;) connection -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, List&lt;String&gt;&gt; entry : versionInstances.entrySet()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> String.format(<span class="string">&quot;service:%s:version:%s:instances&quot;</span>, </span><br><span class="line">                                         serviceName, entry.getKey());</span><br><span class="line">                connection.del(key.getBytes());</span><br><span class="line">                <span class="keyword">for</span> (String instance : entry.getValue()) &#123;</span><br><span class="line">                    connection.sAdd(key.getBytes(), instance.getBytes());</span><br><span class="line">                &#125;</span><br><span class="line">                connection.expire(key.getBytes(), <span class="number">300</span>); <span class="comment">// 5 minutes TTL</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="TenantManagementService-Integration"><a href="#TenantManagementService-Integration" class="headerlink" title="TenantManagementService Integration"></a>TenantManagementService Integration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantSyncService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;tenant.management.api.url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String tenantManagementUrl;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0 */10 * * * *&quot;)</span> <span class="comment">// Every 10 minutes</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">syncTenants</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">            ResponseEntity&lt;TenantListResponse&gt; response = restTemplate.getForEntity(</span><br><span class="line">                tenantManagementUrl + <span class="string">&quot;/api/tenants&quot;</span>, </span><br><span class="line">                TenantListResponse.class</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (response.getStatusCode().is2xxSuccessful()) &#123;</span><br><span class="line">                updateTenantCache(response.getBody().getTenants());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Failed to sync tenants from tenant management service&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateTenantCache</span><span class="params">(List&lt;Tenant&gt; tenants)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantsKey</span> <span class="operator">=</span> <span class="string">&quot;system:tenants&quot;</span>;</span><br><span class="line">        redisTemplate.delete(tenantsKey);</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, String&gt; tenantMap = tenants.stream()</span><br><span class="line">            .collect(toMap(Tenant::getId, Tenant::getName));</span><br><span class="line">            </span><br><span class="line">        redisTemplate.opsForHash().putAll(tenantsKey, tenantMap);</span><br><span class="line">        redisTemplate.expire(tenantsKey, Duration.ofHours(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Use-Cases-and-Examples"><a href="#Use-Cases-and-Examples" class="headerlink" title="Use Cases and Examples"></a>Use Cases and Examples</h2><h3 id="Use-Case-1-Gradual-Service-Rollout"><a href="#Use-Case-1-Gradual-Service-Rollout" class="headerlink" title="Use Case 1: Gradual Service Rollout"></a>Use Case 1: Gradual Service Rollout</h3><p><strong>Scenario</strong>: Rolling out a new payment service version (v2.1) to 10% of tenants initially.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Step 1: Deploy new service version to Nacos</span></span><br><span class="line"><span class="comment">// Step 2: Configure gradual rollout</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GradualRolloutService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initiateGradualRollout</span><span class="params">(String serviceId, String newVersion, </span></span><br><span class="line"><span class="params">                                     <span class="type">double</span> rolloutPercentage)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        List&lt;String&gt; allTenants = tenantService.getAllActiveTenants();</span><br><span class="line">        <span class="type">int</span> <span class="variable">rolloutCount</span> <span class="operator">=</span> (<span class="type">int</span>) (allTenants.size() * rolloutPercentage);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Select tenants for rollout (e.g., based on risk profile)</span></span><br><span class="line">        List&lt;String&gt; rolloutTenants = selectTenantsForRollout(allTenants, rolloutCount);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String tenantId : rolloutTenants) &#123;</span><br><span class="line">            updateTenantServiceVersion(tenantId, serviceId, newVersion);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Monitor rollout metrics</span></span><br><span class="line">        scheduleRolloutMonitoring(serviceId, newVersion, rolloutTenants);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Use-Case-2-A-B-Testing"><a href="#Use-Case-2-A-B-Testing" class="headerlink" title="Use Case 2: A&#x2F;B Testing"></a>Use Case 2: A&#x2F;B Testing</h3><p><strong>Scenario</strong>: Testing two different recommendation algorithms.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ABTestingRouter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ServiceInstanceInfo <span class="title function_">routeForABTest</span><span class="params">(String tenantId, String serviceName, </span></span><br><span class="line"><span class="params">                                            String experimentId)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Get tenant&#x27;s experiment assignment</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">variant</span> <span class="operator">=</span> getExperimentVariant(tenantId, experimentId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Route to appropriate service version</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">targetVersion</span> <span class="operator">=</span> getVersionForVariant(serviceName, variant);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> routeToSpecificVersion(tenantId, serviceName, targetVersion);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getExperimentVariant</span><span class="params">(String tenantId, String experimentId)</span> &#123;</span><br><span class="line">        <span class="comment">// Consistent hashing for stable assignment</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">hash</span> <span class="operator">=</span> DigestUtils.md5Hex(tenantId + experimentId);</span><br><span class="line">        <span class="type">int</span> <span class="variable">hashValue</span> <span class="operator">=</span> Math.abs(hash.hashCode());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> (hashValue % <span class="number">2</span> == <span class="number">0</span>) ? <span class="string">&quot;A&quot;</span> : <span class="string">&quot;B&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Use-Case-3-Emergency-Rollback"><a href="#Use-Case-3-Emergency-Rollback" class="headerlink" title="Use Case 3: Emergency Rollback"></a>Use Case 3: Emergency Rollback</h3><p><strong>Scenario</strong>: Critical bug discovered in production, immediate rollback needed.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/emergency&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmergencyController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/rollback&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;RollbackResult&gt; <span class="title function_">emergencyRollback</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestBody</span> EmergencyRollbackRequest request)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Validate rollback permissions</span></span><br><span class="line">        <span class="keyword">if</span> (!hasEmergencyRollbackPermission(request.getOperatorId())) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.status(HttpStatus.FORBIDDEN).build();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Execute immediate rollback</span></span><br><span class="line">        <span class="type">RollbackResult</span> <span class="variable">result</span> <span class="operator">=</span> executeEmergencyRollback(</span><br><span class="line">            request.getServiceId(),</span><br><span class="line">            request.getFromVersion(),</span><br><span class="line">            request.getToVersion(),</span><br><span class="line">            request.getAffectedTenants()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Notify stakeholders</span></span><br><span class="line">        notificationService.notifyEmergencyRollback(request, result);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(result);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> RollbackResult <span class="title function_">executeEmergencyRollback</span><span class="params">(String serviceId, </span></span><br><span class="line"><span class="params">                                                   String fromVersion,</span></span><br><span class="line"><span class="params">                                                   String toVersion, </span></span><br><span class="line"><span class="params">                                                   List&lt;String&gt; tenants)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> redisTemplate.execute(<span class="keyword">new</span> <span class="title class_">SessionCallback</span>&lt;RollbackResult&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> RollbackResult <span class="title function_">execute</span><span class="params">(RedisOperations operations)</span> </span><br><span class="line">                    <span class="keyword">throws</span> DataAccessException &#123;</span><br><span class="line">                </span><br><span class="line">                operations.multi();</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">for</span> (String tenantId : tenants) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> String.format(<span class="string">&quot;tenant:%s:services&quot;</span>, tenantId);</span><br><span class="line">                    operations.opsForHash().put(key, serviceId, toVersion);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                List&lt;Object&gt; results = operations.exec();</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> RollbackResult.builder()</span><br><span class="line">                    .success(<span class="literal">true</span>)</span><br><span class="line">                    .rollbackCount(results.size())</span><br><span class="line">                    .timestamp(Instant.now())</span><br><span class="line">                    .build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Monitoring-and-Observability"><a href="#Monitoring-and-Observability" class="headerlink" title="Monitoring and Observability"></a>Monitoring and Observability</h2><h3 id="Metrics-Collection"><a href="#Metrics-Collection" class="headerlink" title="Metrics Collection"></a>Metrics Collection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreyRouterMetrics</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter routingRequestsCounter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Timer routingLatencyTimer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Gauge activeTenantsGauge;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GreyRouterMetrics</span><span class="params">(MeterRegistry meterRegistry)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.meterRegistry = meterRegistry;</span><br><span class="line">        <span class="built_in">this</span>.routingRequestsCounter = Counter.builder(<span class="string">&quot;grey_router_requests_total&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Total routing requests&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;service&quot;</span>, <span class="string">&quot;grey-router&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.routingLatencyTimer = Timer.builder(<span class="string">&quot;grey_router_latency&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Routing decision latency&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.activeTenantsGauge = Gauge.builder(<span class="string">&quot;grey_router_active_tenants&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Number of active tenants&quot;</span>)</span><br><span class="line">            .register(meterRegistry, <span class="built_in">this</span>, GreyRouterMetrics::getActiveTenantCount);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordRoutingRequest</span><span class="params">(String tenantId, String serviceName, </span></span><br><span class="line"><span class="params">                                   String version, <span class="type">boolean</span> success)</span> &#123;</span><br><span class="line">        routingRequestsCounter.increment(</span><br><span class="line">            Tags.of(</span><br><span class="line">                Tag.of(<span class="string">&quot;tenant&quot;</span>, tenantId),</span><br><span class="line">                Tag.of(<span class="string">&quot;service&quot;</span>, serviceName),</span><br><span class="line">                Tag.of(<span class="string">&quot;version&quot;</span>, version),</span><br><span class="line">                Tag.of(<span class="string">&quot;status&quot;</span>, success ? <span class="string">&quot;success&quot;</span> : <span class="string">&quot;failure&quot;</span>)</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Health-Checks"><a href="#Health-Checks" class="headerlink" title="Health Checks"></a>Health Checks</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreyRouterHealthIndicator</span> <span class="keyword">implements</span> <span class="title class_">HealthIndicator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Health <span class="title function_">health</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Check Redis connectivity</span></span><br><span class="line">            redisTemplate.opsForValue().get(<span class="string">&quot;health_check&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Check service registry connectivity</span></span><br><span class="line">            nacosServiceDiscovery.checkConnectivity();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Check database connectivity</span></span><br><span class="line">            databaseHealthChecker.checkAllTenantDatabases();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> Health.up()</span><br><span class="line">                .withDetail(<span class="string">&quot;redis&quot;</span>, <span class="string">&quot;UP&quot;</span>)</span><br><span class="line">                .withDetail(<span class="string">&quot;nacos&quot;</span>, <span class="string">&quot;UP&quot;</span>)</span><br><span class="line">                .withDetail(<span class="string">&quot;databases&quot;</span>, <span class="string">&quot;UP&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> Health.down()</span><br><span class="line">                .withException(e)</span><br><span class="line">                .build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Optimization"><a href="#Performance-Optimization" class="headerlink" title="Performance Optimization"></a>Performance Optimization</h2><h3 id="Caching-Strategy"><a href="#Caching-Strategy" class="headerlink" title="Caching Strategy"></a>Caching Strategy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CachingStrategy</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// L1 Cache: Local application cache</span></span><br><span class="line">    <span class="meta">@Cacheable(value = &quot;tenantServices&quot;, key = &quot;#tenantId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">getTenantServices</span><span class="params">(String tenantId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash()</span><br><span class="line">            .entries(String.format(<span class="string">&quot;tenant:%s:services&quot;</span>, tenantId));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// L2 Cache: Redis distributed cache</span></span><br><span class="line">    <span class="keyword">public</span> ServiceInstanceInfo <span class="title function_">getCachedServiceInstance</span><span class="params">(String tenantId, </span></span><br><span class="line"><span class="params">                                                      String serviceName)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cacheKey</span> <span class="operator">=</span> String.format(<span class="string">&quot;routing:%s:%s&quot;</span>, tenantId, serviceName);</span><br><span class="line">        <span class="keyword">return</span> (ServiceInstanceInfo) redisTemplate.opsForValue().get(cacheKey);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Cache warming strategy</span></span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">warmCache</span><span class="params">(ServiceVersionUpdatedEvent event)</span> &#123;</span><br><span class="line">        CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            List&lt;String&gt; affectedTenants = getTenantsUsingService(event.getServiceId());</span><br><span class="line">            <span class="keyword">for</span> (String tenantId : affectedTenants) &#123;</span><br><span class="line">                preloadTenantRouting(tenantId, event.getServiceId());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Connection-Pooling"><a href="#Connection-Pooling" class="headerlink" title="Connection Pooling"></a>Connection Pooling</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LettuceConnectionFactory <span class="title function_">redisConnectionFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">LettuceClientConfiguration</span> <span class="variable">clientConfig</span> <span class="operator">=</span> LettuceClientConfiguration.builder()</span><br><span class="line">            .poolConfig(connectionPoolConfig())</span><br><span class="line">            .commandTimeout(Duration.ofSeconds(<span class="number">2</span>))</span><br><span class="line">            .shutdownTimeout(Duration.ofSeconds(<span class="number">5</span>))</span><br><span class="line">            .build();</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LettuceConnectionFactory</span>(redisStandaloneConfiguration(), clientConfig);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> GenericObjectPoolConfig&lt;?&gt; connectionPoolConfig() &#123;</span><br><span class="line">        GenericObjectPoolConfig&lt;?&gt; poolConfig = <span class="keyword">new</span> <span class="title class_">GenericObjectPoolConfig</span>&lt;&gt;();</span><br><span class="line">        poolConfig.setMaxTotal(<span class="number">50</span>);</span><br><span class="line">        poolConfig.setMaxIdle(<span class="number">20</span>);</span><br><span class="line">        poolConfig.setMinIdle(<span class="number">10</span>);</span><br><span class="line">        poolConfig.setMaxWaitMillis(<span class="number">2000</span>);</span><br><span class="line">        poolConfig.setTestOnBorrow(<span class="literal">true</span>);</span><br><span class="line">        poolConfig.setTestOnReturn(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> poolConfig;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Security-Considerations"><a href="#Security-Considerations" class="headerlink" title="Security Considerations"></a>Security Considerations</h2><h3 id="Authentication-and-Authorization"><a href="#Authentication-and-Authorization" class="headerlink" title="Authentication and Authorization"></a>Authentication and Authorization</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@PreAuthorize(&quot;hasRole(&#x27;GREY_ROUTER_ADMIN&#x27;)&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecureGreyRouterController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/tenants/&#123;tenantId&#125;/services/&#123;serviceId&#125;/upgrade&quot;)</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasPermission(#tenantId, &#x27;TENANT&#x27;, &#x27;MANAGE_SERVICES&#x27;)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;UpgradeResult&gt; <span class="title function_">upgradeService</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String tenantId,</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String serviceId,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestBody</span> ServiceUpgradeRequest request,</span></span><br><span class="line"><span class="params">            Authentication authentication)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Audit log the operation</span></span><br><span class="line">        auditService.logServiceUpgrade(</span><br><span class="line">            authentication.getName(),</span><br><span class="line">            tenantId,</span><br><span class="line">            serviceId,</span><br><span class="line">            request.getTargetVersion()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(greyRouterService.upgradeService(request));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Data-Encryption"><a href="#Data-Encryption" class="headerlink" title="Data Encryption"></a>Data Encryption</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EncryptionService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AESUtil aesUtil;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">storeSensitiveRouteData</span><span class="params">(String tenantId, RouteConfiguration config)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">encryptedConfig</span> <span class="operator">=</span> aesUtil.encrypt(</span><br><span class="line">            JsonUtils.toJson(config),</span><br><span class="line">            getTenantEncryptionKey(tenantId)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        redisTemplate.opsForValue().set(</span><br><span class="line">            <span class="string">&quot;encrypted:tenant:&quot;</span> + tenantId + <span class="string">&quot;:config&quot;</span>,</span><br><span class="line">            encryptedConfig,</span><br><span class="line">            Duration.ofHours(<span class="number">24</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Interview-Questions-and-Insights"><a href="#Interview-Questions-and-Insights" class="headerlink" title="Interview Questions and Insights"></a>Interview Questions and Insights</h2><h3 id="Technical-Architecture-Questions"><a href="#Technical-Architecture-Questions" class="headerlink" title="Technical Architecture Questions"></a>Technical Architecture Questions</h3><p><strong>Q: How do you ensure consistent routing decisions across multiple Grey Router Service instances?</strong></p>
<p><strong>A</strong>: Consistency is achieved through:</p>
<ul>
<li><strong>Centralized State</strong>: All routing decisions are based on data stored in Redis, ensuring all instances see the same state</li>
<li><strong>Lua Scripts</strong>: Atomic operations in Redis prevent race conditions during routing and load balancing</li>
<li><strong>Cache Synchronization</strong>: Event-driven cache invalidation ensures consistency across local caches</li>
<li><strong>Versioned Configuration</strong>: Each routing rule has a version number to handle concurrent updates</li>
</ul>
<p><strong>Q: How would you handle the scenario where a tenants database schema upgrade fails halfway through?</strong></p>
<p><strong>A</strong>: Robust failure handling includes:</p>
<ul>
<li><strong>Transactional Migrations</strong>: Each schema upgrade runs in a database transaction</li>
<li><strong>Rollback Scripts</strong>: Every migration has a corresponding rollback script</li>
<li><strong>State Tracking</strong>: Migration state is tracked in a dedicated schema_version table</li>
<li><strong>Compensation Actions</strong>: Failed upgrades trigger automatic rollback and notification</li>
<li><strong>Isolation</strong>: Failed upgrades for one tenant dont affect others</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> UpgradeResult <span class="title function_">executeSchemaUpgrade</span><span class="params">(String tenantId, String version)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        beginUpgrade(tenantId, version);</span><br><span class="line">        executeMigrations(tenantId, version);</span><br><span class="line">        commitUpgrade(tenantId, version);</span><br><span class="line">        <span class="keyword">return</span> UpgradeResult.success();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        rollbackUpgrade(tenantId, version);</span><br><span class="line">        notifyUpgradeFailure(tenantId, version, e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SchemaUpgradeException</span>(<span class="string">&quot;Upgrade failed for tenant: &quot;</span> + tenantId, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Performance-and-Scalability-Questions"><a href="#Performance-and-Scalability-Questions" class="headerlink" title="Performance and Scalability Questions"></a>Performance and Scalability Questions</h3><p><strong>Q: How do you optimize the performance of routing decisions when handling thousands of requests per second?</strong></p>
<p><strong>A</strong>: Performance optimization strategies:</p>
<ul>
<li><strong>Redis Lua Scripts</strong>: Atomic routing decisions with minimal network round trips</li>
<li><strong>Connection Pooling</strong>: Optimized Redis connection management</li>
<li><strong>Local Caching</strong>: L1 cache for frequently accessed routing rules</li>
<li><strong>Async Processing</strong>: Non-blocking I&#x2F;O for external service calls</li>
<li><strong>Circuit Breakers</strong>: Prevent cascade failures and improve response times</li>
</ul>
<p><strong>Q: How would you scale this system to handle 10,000+ tenants?</strong></p>
<p><strong>A</strong>: Scaling strategies:</p>
<ul>
<li><strong>Horizontal Scaling</strong>: Multiple Grey Router Service instances behind a load balancer</li>
<li><strong>Redis Clustering</strong>: Distributed Redis setup for higher throughput</li>
<li><strong>Partitioning</strong>: Tenant data partitioned across multiple Redis clusters</li>
<li><strong>Caching Layers</strong>: Multi-level caching to reduce database load</li>
<li><strong>Async Operations</strong>: Background processing for non-critical operations</li>
</ul>
<h3 id="Operational-Excellence-Questions"><a href="#Operational-Excellence-Questions" class="headerlink" title="Operational Excellence Questions"></a>Operational Excellence Questions</h3><p><strong>Q: How do you monitor and troubleshoot routing issues in production?</strong></p>
<p><strong>A</strong>: Comprehensive monitoring approach:</p>
<ul>
<li><strong>Metrics</strong>: Request success rates, latency percentiles, error rates by tenant&#x2F;service</li>
<li><strong>Distributed Tracing</strong>: End-to-end request tracing across service boundaries</li>
<li><strong>Alerting</strong>: Threshold-based alerts for SLA violations</li>
<li><strong>Dashboards</strong>: Real-time visualization of system health and performance</li>
<li><strong>Log Aggregation</strong>: Centralized logging with correlation IDs</li>
</ul>
<h2 id="Best-Practices-and-Recommendations"><a href="#Best-Practices-and-Recommendations" class="headerlink" title="Best Practices and Recommendations"></a>Best Practices and Recommendations</h2><h3 id="Configuration-Management"><a href="#Configuration-Management" class="headerlink" title="Configuration Management"></a>Configuration Management</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.yml</span></span><br><span class="line"><span class="attr">grey-router:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">cluster:</span></span><br><span class="line">      <span class="attr">nodes:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">redis-node1:6379</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">redis-node2:6379</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">redis-node3:6379</span></span><br><span class="line">    <span class="attr">pool:</span></span><br><span class="line">      <span class="attr">max-active:</span> <span class="number">50</span></span><br><span class="line">      <span class="attr">max-idle:</span> <span class="number">20</span></span><br><span class="line">      <span class="attr">min-idle:</span> <span class="number">10</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">routing:</span></span><br><span class="line">    <span class="attr">cache-ttl:</span> <span class="string">300s</span></span><br><span class="line">    <span class="attr">circuit-breaker:</span></span><br><span class="line">      <span class="attr">failure-threshold:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">recovery-time:</span> <span class="string">30s</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">schema-upgrade:</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">300s</span></span><br><span class="line">    <span class="attr">max-concurrent-upgrades:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">backup-enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="Error-Handling-Patterns"><a href="#Error-Handling-Patterns" class="headerlink" title="Error Handling Patterns"></a>Error Handling Patterns</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ErrorHandlingPatterns</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Circuit Breaker Pattern</span></span><br><span class="line">    <span class="meta">@CircuitBreaker(name = &quot;nacos-registry&quot;, fallbackMethod = &quot;fallbackServiceLookup&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ServiceInstance&gt; <span class="title function_">getServiceInstances</span><span class="params">(String serviceName)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nacosDiscoveryClient.getInstances(serviceName);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> List&lt;ServiceInstance&gt; <span class="title function_">fallbackServiceLookup</span><span class="params">(String serviceName, Exception ex)</span> &#123;</span><br><span class="line">        <span class="comment">// Return cached instances or default configuration</span></span><br><span class="line">        <span class="keyword">return</span> getCachedServiceInstances(serviceName);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Retry Pattern with Exponential Backoff</span></span><br><span class="line">    <span class="meta">@Retryable(</span></span><br><span class="line"><span class="meta">        value = &#123;RedisConnectionException.class&#125;,</span></span><br><span class="line"><span class="meta">        maxAttempts = 3,</span></span><br><span class="line"><span class="meta">        backoff = @Backoff(delay = 1000, multiplier = 2)</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateRoutingConfiguration</span><span class="params">(String tenantId, Map&lt;String, String&gt; config)</span> &#123;</span><br><span class="line">        redisTemplate.opsForHash().putAll(<span class="string">&quot;tenant:&quot;</span> + tenantId + <span class="string">&quot;:services&quot;</span>, config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Testing-Strategies"><a href="#Testing-Strategies" class="headerlink" title="Testing Strategies"></a>Testing Strategies</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GreyRouterIntegrationTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GreyRouterService greyRouterService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@MockBean</span></span><br><span class="line">    <span class="keyword">private</span> NacosServiceDiscovery nacosServiceDiscovery;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldRouteToCorrectServiceVersion</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Given</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> <span class="string">&quot;tenant-123&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">serviceName</span> <span class="operator">=</span> <span class="string">&quot;payment-service&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">expectedVersion</span> <span class="operator">=</span> <span class="string">&quot;v2.1&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        setupTenantServiceMapping(tenantId, serviceName, expectedVersion);</span><br><span class="line">        setupServiceInstances(serviceName, expectedVersion, </span><br><span class="line">                            Arrays.asList(<span class="string">&quot;instance1:8080&quot;</span>, <span class="string">&quot;instance2:8080&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When</span></span><br><span class="line">        <span class="type">ServiceInstanceInfo</span> <span class="variable">result</span> <span class="operator">=</span> greyRouterService</span><br><span class="line">            .routeToServiceInstance(tenantId, serviceName, <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Then</span></span><br><span class="line">        assertThat(result.getVersion()).isEqualTo(expectedVersion);</span><br><span class="line">        assertThat(result.getInstance()).isIn(<span class="string">&quot;instance1:8080&quot;</span>, <span class="string">&quot;instance2:8080&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldHandleSchemaUpgradeFailureGracefully</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Test schema upgrade rollback scenarios</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> <span class="string">&quot;tenant-456&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">version</span> <span class="operator">=</span> <span class="string">&quot;v2.0&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Mock database failure during migration</span></span><br><span class="line">        <span class="keyword">when</span>(databaseSchemaManager.upgradeTenantSchema(tenantId, version))</span><br><span class="line">            .thenThrow(<span class="keyword">new</span> <span class="title class_">SchemaUpgradeException</span>(<span class="string">&quot;Migration failed&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When &amp; Then</span></span><br><span class="line">        assertThatThrownBy(() -&gt; greyRouterService.upgradeDatabaseSchema(tenantId, version))</span><br><span class="line">            .isInstanceOf(SchemaUpgradeException.class);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Verify rollback was triggered</span></span><br><span class="line">        verify(databaseSchemaManager).rollbackToVersion(tenantId, <span class="string">&quot;v1.9&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Production-Deployment-Considerations"><a href="#Production-Deployment-Considerations" class="headerlink" title="Production Deployment Considerations"></a>Production Deployment Considerations</h2><h3 id="Infrastructure-Requirements"><a href="#Infrastructure-Requirements" class="headerlink" title="Infrastructure Requirements"></a>Infrastructure Requirements</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose.yml for development</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">grey-router-service:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">grey-router:latest</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_PROFILES_ACTIVE=production</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REDIS_CLUSTER_NODES=redis-cluster:6379</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">NACOS_SERVER_ADDR=nacos:8848</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-cluster</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">redis-cluster:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:7-alpine</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">--appendonly</span> <span class="literal">yes</span> <span class="string">--cluster-enabled</span> <span class="literal">yes</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">nacos:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nacos/nacos-server:latest</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8848:8848&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MODE=standalone</span></span><br></pre></td></tr></table></figure>

<h3 id="Kubernetes-Deployment"><a href="#Kubernetes-Deployment" class="headerlink" title="Kubernetes Deployment"></a>Kubernetes Deployment</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># k8s-deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grey-router-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grey-router</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">grey-router</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">grey-router</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grey-router</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">grey-router:v1.0.0</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_PROFILES_ACTIVE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;kubernetes&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">REDIS_CLUSTER_NODES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;redis-cluster-service:6379&quot;</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;512Mi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/actuator/health</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/actuator/health/readiness</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grey-router-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grey-router</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br></pre></td></tr></table></figure>

<h3 id="Monitoring-and-Alerting-Configuration"><a href="#Monitoring-and-Alerting-Configuration" class="headerlink" title="Monitoring and Alerting Configuration"></a>Monitoring and Alerting Configuration</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># prometheus-rules.yml</span></span><br><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grey-router-alerts</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">GreyRouterHighErrorRate</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      rate(grey_router_requests_total&#123;status=&quot;failure&quot;&#125;[5m]) / </span></span><br><span class="line"><span class="string">      rate(grey_router_requests_total[5m]) &gt; 0.05</span></span><br><span class="line"><span class="string"></span>    <span class="attr">for:</span> <span class="string">2m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;High error rate in Grey Router&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;Error rate is <span class="template-variable">&#123;&#123; $value | humanizePercentage &#125;&#125;</span> for the last 5 minutes&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">GreyRouterHighLatency</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      histogram_quantile(0.95, rate(grey_router_latency_bucket[5m])) &gt; 0.5</span></span><br><span class="line"><span class="string"></span>    <span class="attr">for:</span> <span class="string">2m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;High latency in Grey Router&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;95th percentile latency is <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>s&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">RedisConnectionFailure</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      up&#123;job=&quot;redis-cluster&quot;&#125; == 0</span></span><br><span class="line"><span class="string"></span>    <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;Redis cluster is down&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;Redis cluster connection failed&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Database-Migration-Best-Practices"><a href="#Database-Migration-Best-Practices" class="headerlink" title="Database Migration Best Practices"></a>Database Migration Best Practices</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductionMigrationStrategies</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Online schema migration for large tables</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performOnlineSchemaChange</span><span class="params">(String tenantId, String tableName, </span></span><br><span class="line"><span class="params">                                        String alterStatement)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Use pt-online-schema-change for MySQL or similar tools</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">command</span> <span class="operator">=</span> String.format(</span><br><span class="line">            <span class="string">&quot;pt-online-schema-change --alter=&#x27;%s&#x27; --execute D=%s,t=%s&quot;</span>,</span><br><span class="line">            alterStatement, getDatabaseName(tenantId), tableName</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="type">ProcessBuilder</span> <span class="variable">pb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, command);</span><br><span class="line">        pb.environment().put(<span class="string">&quot;MYSQL_PWD&quot;</span>, getDatabasePassword(tenantId));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> pb.start();</span><br><span class="line">            <span class="type">int</span> <span class="variable">exitCode</span> <span class="operator">=</span> process.waitFor();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (exitCode != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SchemaUpgradeException</span>(<span class="string">&quot;Online schema change failed&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SchemaUpgradeException</span>(<span class="string">&quot;Failed to execute online schema change&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Blue-green deployment for database schemas</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">blueGreenSchemaDeployment</span><span class="params">(String tenantId, String newVersion)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Create new schema version</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">blueSchema</span> <span class="operator">=</span> getCurrentSchema(tenantId);</span><br><span class="line">        <span class="type">String</span> <span class="variable">greenSchema</span> <span class="operator">=</span> createSchemaVersion(tenantId, newVersion);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Apply migrations to green schema</span></span><br><span class="line">            applyMigrationsToSchema(greenSchema, newVersion);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Validate green schema</span></span><br><span class="line">            validateSchemaIntegrity(greenSchema);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Switch traffic to green schema</span></span><br><span class="line">            switchSchemaTraffic(tenantId, greenSchema);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Keep blue schema for rollback</span></span><br><span class="line">            scheduleSchemaCleanup(blueSchema, Duration.ofHours(<span class="number">24</span>));</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// Rollback to blue schema</span></span><br><span class="line">            rollbackToSchema(tenantId, blueSchema);</span><br><span class="line">            cleanupFailedSchema(greenSchema);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Advanced-Features"><a href="#Advanced-Features" class="headerlink" title="Advanced Features"></a>Advanced Features</h2><h3 id="Multi-Region-Support"><a href="#Multi-Region-Support" class="headerlink" title="Multi-Region Support"></a>Multi-Region Support</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiRegionConfiguration</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="keyword">public</span> GreyRouterService <span class="title function_">multiRegionGreyRouterService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MultiRegionGreyRouterService</span>(</span><br><span class="line">            getRegionSpecificRouters(),</span><br><span class="line">            crossRegionLoadBalancer()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, GreyRouterService&gt; <span class="title function_">getRegionSpecificRouters</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, GreyRouterService&gt; routers = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Configure region-specific routers</span></span><br><span class="line">        routers.put(<span class="string">&quot;us-east-1&quot;</span>, createRegionRouter(<span class="string">&quot;us-east-1&quot;</span>));</span><br><span class="line">        routers.put(<span class="string">&quot;us-west-2&quot;</span>, createRegionRouter(<span class="string">&quot;us-west-2&quot;</span>));</span><br><span class="line">        routers.put(<span class="string">&quot;eu-west-1&quot;</span>, createRegionRouter(<span class="string">&quot;eu-west-1&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> routers;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiRegionGreyRouterService</span> <span class="keyword">implements</span> <span class="title class_">GreyRouterService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, GreyRouterService&gt; regionRouters;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CrossRegionLoadBalancer loadBalancer;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ServiceInstanceInfo <span class="title function_">routeToServiceInstance</span><span class="params">(String tenantId, </span></span><br><span class="line"><span class="params">                                                    String serviceName, </span></span><br><span class="line"><span class="params">                                                    Map&lt;String, String&gt; metadata)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Determine target region based on tenant location or latency</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">targetRegion</span> <span class="operator">=</span> determineTargetRegion(tenantId, metadata);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Route within the target region</span></span><br><span class="line">        <span class="type">GreyRouterService</span> <span class="variable">regionRouter</span> <span class="operator">=</span> regionRouters.get(targetRegion);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> regionRouter.routeToServiceInstance(tenantId, serviceName, metadata);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoInstanceAvailableException e) &#123;</span><br><span class="line">            <span class="comment">// Cross-region fallback</span></span><br><span class="line">            <span class="keyword">return</span> loadBalancer.routeToAlternativeRegion(tenantId, serviceName, </span><br><span class="line">                                                       targetRegion, metadata);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">determineTargetRegion</span><span class="params">(String tenantId, Map&lt;String, String&gt; metadata)</span> &#123;</span><br><span class="line">        <span class="comment">// Logic to determine optimal region based on:</span></span><br><span class="line">        <span class="comment">// 1. Tenant configuration</span></span><br><span class="line">        <span class="comment">// 2. Service availability</span></span><br><span class="line">        <span class="comment">// 3. Network latency</span></span><br><span class="line">        <span class="comment">// 4. Compliance requirements</span></span><br><span class="line">        </span><br><span class="line">        <span class="type">TenantConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> tenantConfigService.getTenantConfig(tenantId);</span><br><span class="line">        <span class="keyword">if</span> (config.hasRegionPreference()) &#123;</span><br><span class="line">            <span class="keyword">return</span> config.getPreferredRegion();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Use latency-based routing</span></span><br><span class="line">        <span class="keyword">return</span> latencyBasedRegionSelector.selectRegion(metadata.get(<span class="string">&quot;client-ip&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Canary-Release-Automation"><a href="#Canary-Release-Automation" class="headerlink" title="Canary Release Automation"></a>Canary Release Automation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CanaryReleaseManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MetricsCollector metricsCollector;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AlertManager alertManager;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initiateCanaryRelease</span><span class="params">(String serviceId, String newVersion, </span></span><br><span class="line"><span class="params">                                    CanaryConfiguration config)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">CanaryRelease</span> <span class="variable">canary</span> <span class="operator">=</span> CanaryRelease.builder()</span><br><span class="line">            .serviceId(serviceId)</span><br><span class="line">            .newVersion(newVersion)</span><br><span class="line">            .configuration(config)</span><br><span class="line">            .status(CanaryStatus.STARTING)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Start with minimal traffic</span></span><br><span class="line">        updateCanaryTrafficSplit(canary, <span class="number">0.01</span>); <span class="comment">// 1%</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Schedule automated progression</span></span><br><span class="line">        scheduleCanaryProgression(canary);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedDelay = 300000)</span> <span class="comment">// 5 minutes</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">progressCanaryReleases</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;CanaryRelease&gt; activeCanaries = getActiveCanaryReleases();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (CanaryRelease canary : activeCanaries) &#123;</span><br><span class="line">            <span class="type">CanaryMetrics</span> <span class="variable">metrics</span> <span class="operator">=</span> metricsCollector.collectCanaryMetrics(canary);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (shouldProgressCanary(canary, metrics)) &#123;</span><br><span class="line">                progressCanary(canary);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shouldAbortCanary(canary, metrics)) &#123;</span><br><span class="line">                abortCanary(canary);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">shouldProgressCanary</span><span class="params">(CanaryRelease canary, CanaryMetrics metrics)</span> &#123;</span><br><span class="line">        <span class="comment">// Success criteria:</span></span><br><span class="line">        <span class="comment">// 1. Error rate &lt; 0.1%</span></span><br><span class="line">        <span class="comment">// 2. Latency increase &lt; 10%</span></span><br><span class="line">        <span class="comment">// 3. No critical alerts</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> metrics.getErrorRate() &lt; <span class="number">0.001</span> &amp;&amp;</span><br><span class="line">               metrics.getLatencyIncrease() &lt; <span class="number">0.1</span> &amp;&amp;</span><br><span class="line">               !alertManager.hasCriticalAlerts(canary.getServiceId());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">progressCanary</span><span class="params">(CanaryRelease canary)</span> &#123;</span><br><span class="line">        <span class="type">double</span> <span class="variable">currentTraffic</span> <span class="operator">=</span> canary.getCurrentTrafficPercentage();</span><br><span class="line">        <span class="type">double</span> <span class="variable">nextTraffic</span> <span class="operator">=</span> Math.min(currentTraffic * <span class="number">2</span>, <span class="number">1.0</span>); <span class="comment">// Double traffic</span></span><br><span class="line">        </span><br><span class="line">        updateCanaryTrafficSplit(canary, nextTraffic);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (nextTraffic &gt;= <span class="number">1.0</span>) &#123;</span><br><span class="line">            completeCanaryRelease(canary);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Advanced-Load-Balancing-Strategies"><a href="#Advanced-Load-Balancing-Strategies" class="headerlink" title="Advanced Load Balancing Strategies"></a>Advanced Load Balancing Strategies</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- advanced_load_balancer.lua</span></span><br><span class="line"><span class="comment">-- Weighted round-robin with health checks and circuit breaker logic</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> service_name = ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">local</span> tenant_id = ARGV[<span class="number">2</span>]</span><br><span class="line"><span class="keyword">local</span> lb_strategy = ARGV[<span class="number">3</span>] <span class="keyword">or</span> <span class="string">&quot;weighted_round_robin&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Get service instances with health status</span></span><br><span class="line"><span class="keyword">local</span> instances_key = <span class="string">&quot;service:&quot;</span> .. service_name .. <span class="string">&quot;:instances&quot;</span></span><br><span class="line"><span class="keyword">local</span> instances = redis.call(<span class="string">&#x27;HGETALL&#x27;</span>, instances_key)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> healthy_instances = &#123;&#125;</span><br><span class="line"><span class="keyword">local</span> total_weight = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Filter healthy instances and calculate total weight</span></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, #instances, <span class="number">2</span> <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> instance = instances[i]</span><br><span class="line">    <span class="keyword">local</span> instance_data = cjson.decode(instances[i + <span class="number">1</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- Check circuit breaker status</span></span><br><span class="line">    <span class="keyword">local</span> cb_key = <span class="string">&quot;circuit_breaker:&quot;</span> .. instance</span><br><span class="line">    <span class="keyword">local</span> cb_status = redis.call(<span class="string">&#x27;GET&#x27;</span>, cb_key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> cb_status ~= <span class="string">&quot;OPEN&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- Check health status</span></span><br><span class="line">        <span class="keyword">local</span> health_key = <span class="string">&quot;health:&quot;</span> .. instance</span><br><span class="line">        <span class="keyword">local</span> health_score = redis.call(<span class="string">&#x27;GET&#x27;</span>, health_key) <span class="keyword">or</span> <span class="number">100</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">tonumber</span>(health_score) &gt; <span class="number">50</span> <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">table</span>.<span class="built_in">insert</span>(healthy_instances, &#123;</span><br><span class="line">                instance = instance,</span><br><span class="line">                weight = instance_data.weight <span class="keyword">or</span> <span class="number">1</span>,</span><br><span class="line">                health_score = <span class="built_in">tonumber</span>(health_score),</span><br><span class="line">                current_connections = instance_data.connections <span class="keyword">or</span> <span class="number">0</span></span><br><span class="line">            &#125;)</span><br><span class="line">            total_weight = total_weight + (instance_data.weight <span class="keyword">or</span> <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> #healthy_instances == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> &#123;err = <span class="string">&quot;No healthy instances available&quot;</span>&#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> selected_instance</span><br><span class="line"><span class="keyword">if</span> lb_strategy == <span class="string">&quot;weighted_round_robin&quot;</span> <span class="keyword">then</span></span><br><span class="line">    selected_instance = weighted_round_robin_select(healthy_instances, total_weight)</span><br><span class="line"><span class="keyword">elseif</span> lb_strategy == <span class="string">&quot;least_connections&quot;</span> <span class="keyword">then</span></span><br><span class="line">    selected_instance = least_connections_select(healthy_instances)</span><br><span class="line"><span class="keyword">elseif</span> lb_strategy == <span class="string">&quot;health_aware&quot;</span> <span class="keyword">then</span></span><br><span class="line">    selected_instance = health_aware_select(healthy_instances)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Update instance metrics</span></span><br><span class="line"><span class="keyword">local</span> metrics_key = <span class="string">&quot;metrics:&quot;</span> .. selected_instance.instance</span><br><span class="line">redis.call(<span class="string">&#x27;HINCRBY&#x27;</span>, metrics_key, <span class="string">&#x27;requests&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">redis.call(<span class="string">&#x27;HINCRBY&#x27;</span>, metrics_key, <span class="string">&#x27;connections&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">redis.call(<span class="string">&#x27;EXPIRE&#x27;</span>, metrics_key, <span class="number">300</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">    instance = selected_instance.instance,</span><br><span class="line">    weight = selected_instance.weight,</span><br><span class="line">    health_score = selected_instance.health_score</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">weighted_round_robin_select</span><span class="params">(instances, total_weight)</span></span></span><br><span class="line">    <span class="keyword">local</span> counter_key = <span class="string">&quot;lb_counter:&quot;</span> .. service_name</span><br><span class="line">    <span class="keyword">local</span> counter = redis.call(<span class="string">&#x27;INCR&#x27;</span>, counter_key)</span><br><span class="line">    redis.call(<span class="string">&#x27;EXPIRE&#x27;</span>, counter_key, <span class="number">3600</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">local</span> threshold = (counter % total_weight) + <span class="number">1</span></span><br><span class="line">    <span class="keyword">local</span> current_weight = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> _, instance <span class="keyword">in</span> <span class="built_in">ipairs</span>(instances) <span class="keyword">do</span></span><br><span class="line">        current_weight = current_weight + instance.weight</span><br><span class="line">        <span class="keyword">if</span> current_weight &gt;= threshold <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> instance</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> instances[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">least_connections_select</span><span class="params">(instances)</span></span></span><br><span class="line">    <span class="keyword">local</span> min_connections = <span class="built_in">math</span>.<span class="built_in">huge</span></span><br><span class="line">    <span class="keyword">local</span> selected = instances[<span class="number">1</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> _, instance <span class="keyword">in</span> <span class="built_in">ipairs</span>(instances) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> instance.current_connections &lt; min_connections <span class="keyword">then</span></span><br><span class="line">            min_connections = instance.current_connections</span><br><span class="line">            selected = instance</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> selected</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">health_aware_select</span><span class="params">(instances)</span></span></span><br><span class="line">    <span class="comment">-- Weighted selection based on health score</span></span><br><span class="line">    <span class="keyword">local</span> total_health = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> _, instance <span class="keyword">in</span> <span class="built_in">ipairs</span>(instances) <span class="keyword">do</span></span><br><span class="line">        total_health = total_health + instance.health_score</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">local</span> random_point = <span class="built_in">math</span>.<span class="built_in">random</span>() * total_health</span><br><span class="line">    <span class="keyword">local</span> current_health = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> _, instance <span class="keyword">in</span> <span class="built_in">ipairs</span>(instances) <span class="keyword">do</span></span><br><span class="line">        current_health = current_health + instance.health_score</span><br><span class="line">        <span class="keyword">if</span> current_health &gt;= random_point <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> instance</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> instances[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="Security-Deep-Dive"><a href="#Security-Deep-Dive" class="headerlink" title="Security Deep Dive"></a>Security Deep Dive</h2><h3 id="OAuth2-Integration"><a href="#OAuth2-Integration" class="headerlink" title="OAuth2 Integration"></a>OAuth2 Integration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreyRouterSecurityConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityFilterChain <span class="title function_">filterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">            .authorizeHttpRequests(authz -&gt; authz</span><br><span class="line">                .requestMatchers(<span class="string">&quot;/actuator/health&quot;</span>).permitAll()</span><br><span class="line">                .requestMatchers(<span class="string">&quot;/api/public/**&quot;</span>).permitAll()</span><br><span class="line">                .requestMatchers(<span class="string">&quot;/api/admin/**&quot;</span>).hasRole(<span class="string">&quot;GREY_ROUTER_ADMIN&quot;</span>)</span><br><span class="line">                .requestMatchers(<span class="string">&quot;/api/tenants/**&quot;</span>).hasRole(<span class="string">&quot;TENANT_MANAGER&quot;</span>)</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">            )</span><br><span class="line">            .oauth2ResourceServer(oauth2 -&gt; oauth2</span><br><span class="line">                .jwt(jwt -&gt; jwt</span><br><span class="line">                    .jwtAuthenticationConverter(jwtAuthenticationConverter())</span><br><span class="line">                )</span><br><span class="line">            );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JwtAuthenticationConverter <span class="title function_">jwtAuthenticationConverter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">JwtAuthenticationConverter</span> <span class="variable">converter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JwtAuthenticationConverter</span>();</span><br><span class="line">        converter.setJwtGrantedAuthoritiesConverter(jwt -&gt; &#123;</span><br><span class="line">            Collection&lt;String&gt; roles = jwt.getClaimAsStringList(<span class="string">&quot;roles&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> roles.stream()</span><br><span class="line">                .map(role -&gt; <span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(<span class="string">&quot;ROLE_&quot;</span> + role))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> converter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Rate-Limiting-and-Throttling"><a href="#Rate-Limiting-and-Throttling" class="headerlink" title="Rate Limiting and Throttling"></a>Rate Limiting and Throttling</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RateLimitingFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RateLimitProperties rateLimitProperties;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, </span></span><br><span class="line"><span class="params">                        FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">httpRequest</span> <span class="operator">=</span> (HttpServletRequest) request;</span><br><span class="line">        <span class="type">String</span> <span class="variable">clientId</span> <span class="operator">=</span> extractClientId(httpRequest);</span><br><span class="line">        <span class="type">String</span> <span class="variable">endpoint</span> <span class="operator">=</span> httpRequest.getRequestURI();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (isRateLimited(clientId, endpoint)) &#123;</span><br><span class="line">            <span class="type">HttpServletResponse</span> <span class="variable">httpResponse</span> <span class="operator">=</span> (HttpServletResponse) response;</span><br><span class="line">            httpResponse.setStatus(HttpStatus.TOO_MANY_REQUESTS.value());</span><br><span class="line">            httpResponse.getWriter().write(<span class="string">&quot;Rate limit exceeded&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isRateLimited</span><span class="params">(String clientId, String endpoint)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;rate_limit:&quot;</span> + clientId + <span class="string">&quot;:&quot;</span> + endpoint;</span><br><span class="line">        <span class="type">String</span> <span class="variable">windowKey</span> <span class="operator">=</span> key + <span class="string">&quot;:&quot;</span> + getCurrentWindow();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Sliding window rate limiting</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">currentCount</span> <span class="operator">=</span> redisTemplate.opsForValue().increment(windowKey);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (currentCount == <span class="number">1</span>) &#123;</span><br><span class="line">            redisTemplate.expire(windowKey, Duration.ofMinutes(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">RateLimitConfig</span> <span class="variable">config</span> <span class="operator">=</span> rateLimitProperties.getConfigForEndpoint(endpoint);</span><br><span class="line">        <span class="keyword">return</span> currentCount &gt; config.getRequestsPerMinute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Benchmarking"><a href="#Performance-Benchmarking" class="headerlink" title="Performance Benchmarking"></a>Performance Benchmarking</h2><h3 id="Load-Testing-Results"><a href="#Load-Testing-Results" class="headerlink" title="Load Testing Results"></a>Load Testing Results</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PerformanceBenchmark</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">runLoadTest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Benchmark Results (on AWS c5.2xlarge):</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * Concurrent Users: 1000</span></span><br><span class="line"><span class="comment">         * Test Duration: 10 minutes</span></span><br><span class="line"><span class="comment">         * Average Response Time: 45ms</span></span><br><span class="line"><span class="comment">         * 95th Percentile: 120ms</span></span><br><span class="line"><span class="comment">         * 99th Percentile: 250ms</span></span><br><span class="line"><span class="comment">         * Throughput: 15,000 RPS</span></span><br><span class="line"><span class="comment">         * Error Rate: 0.02%</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * Redis Operations:</span></span><br><span class="line"><span class="comment">         * - Simple GET: 0.5ms avg</span></span><br><span class="line"><span class="comment">         * - Lua Script Execution: 2.1ms avg</span></span><br><span class="line"><span class="comment">         * - Hash Operations: 0.8ms avg</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * Database Operations:</span></span><br><span class="line"><span class="comment">         * - Schema Migration (small): 2.3s avg</span></span><br><span class="line"><span class="comment">         * - Schema Migration (large table): 45s avg</span></span><br><span class="line"><span class="comment">         * - Connection Pool Utilization: 60%</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">benchmarkRoutingDecision</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">StopWatch</span> <span class="variable">stopWatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StopWatch</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Warm up</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            greyRouterService.routeToServiceInstance(<span class="string">&quot;tenant-&quot;</span> + i, <span class="string">&quot;test-service&quot;</span>, <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Actual benchmark</span></span><br><span class="line">        stopWatch.start();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">            greyRouterService.routeToServiceInstance(<span class="string">&quot;tenant-&quot;</span> + (i % <span class="number">100</span>), <span class="string">&quot;test-service&quot;</span>, <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;());</span><br><span class="line">        &#125;</span><br><span class="line">        stopWatch.stop();</span><br><span class="line">        </span><br><span class="line">        <span class="type">double</span> <span class="variable">avgTime</span> <span class="operator">=</span> stopWatch.getTotalTimeMillis() / <span class="number">10000.0</span>;</span><br><span class="line">        assertThat(avgTime).isLessThan(<span class="number">5.0</span>); <span class="comment">// Less than 5ms average</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Disaster-Recovery-and-Business-Continuity"><a href="#Disaster-Recovery-and-Business-Continuity" class="headerlink" title="Disaster Recovery and Business Continuity"></a>Disaster Recovery and Business Continuity</h2><h3 id="Backup-and-Recovery-Strategies"><a href="#Backup-and-Recovery-Strategies" class="headerlink" title="Backup and Recovery Strategies"></a>Backup and Recovery Strategies</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DisasterRecoveryService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0 0 2 * * ?&quot;)</span> <span class="comment">// Daily at 2 AM</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performBackup</span><span class="params">()</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Backup Redis data</span></span><br><span class="line">        backupRedisData();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Backup configuration data</span></span><br><span class="line">        backupConfigurationData();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Backup tenant database schemas</span></span><br><span class="line">        backupTenantSchemas();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">backupRedisData</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Create Redis backup</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">backupCommand</span> <span class="operator">=</span> <span class="string">&quot;redis-cli --rdb /backup/redis-backup-&quot;</span> + </span><br><span class="line">                                 LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd-HH-mm&quot;</span>)) + </span><br><span class="line">                                 <span class="string">&quot;.rdb&quot;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="type">ProcessBuilder</span> <span class="variable">pb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, backupCommand);</span><br><span class="line">            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> pb.start();</span><br><span class="line">            </span><br><span class="line">            <span class="type">int</span> <span class="variable">exitCode</span> <span class="operator">=</span> process.waitFor();</span><br><span class="line">            <span class="keyword">if</span> (exitCode != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BackupException</span>(<span class="string">&quot;Redis backup failed&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Upload to S3 or other cloud storage</span></span><br><span class="line">            uploadBackupToCloud(<span class="string">&quot;redis-backup&quot;</span>);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Failed to backup Redis data&quot;</span>, e);</span><br><span class="line">            alertManager.sendAlert(<span class="string">&quot;Redis backup failed&quot;</span>, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performDisasterRecovery</span><span class="params">(String backupTimestamp)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Stop all routing traffic</span></span><br><span class="line">        enableMaintenanceMode();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Restore Redis data</span></span><br><span class="line">            restoreRedisFromBackup(backupTimestamp);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Restore configuration</span></span><br><span class="line">            restoreConfigurationFromBackup(backupTimestamp);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Validate system integrity</span></span><br><span class="line">            validateSystemIntegrity();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Resume routing traffic</span></span><br><span class="line">            disableMaintenanceMode();</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Disaster recovery failed&quot;</span>, e);</span><br><span class="line">            <span class="comment">// Keep maintenance mode active</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DisasterRecoveryException</span>(<span class="string">&quot;Recovery failed&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="High-Availability-Setup"><a href="#High-Availability-Setup" class="headerlink" title="High Availability Setup"></a>High Availability Setup</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Redis Sentinel Configuration</span></span><br><span class="line"><span class="comment"># sentinel.conf</span></span><br><span class="line"><span class="string">port</span> <span class="number">26379</span></span><br><span class="line"><span class="string">sentinel</span> <span class="string">monitor</span> <span class="string">mymaster</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">6379 </span><span class="number">2</span></span><br><span class="line"><span class="string">sentinel</span> <span class="string">down-after-milliseconds</span> <span class="string">mymaster</span> <span class="number">5000</span></span><br><span class="line"><span class="string">sentinel</span> <span class="string">failover-timeout</span> <span class="string">mymaster</span> <span class="number">10000</span></span><br><span class="line"><span class="string">sentinel</span> <span class="string">parallel-syncs</span> <span class="string">mymaster</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Application configuration for HA</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">master:</span> <span class="string">mymaster</span></span><br><span class="line">      <span class="attr">nodes:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.10</span><span class="string">:26379</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.11</span><span class="string">:26379</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.12</span><span class="string">:26379</span></span><br><span class="line">    <span class="attr">lettuce:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">50</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">20</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">cluster:</span></span><br><span class="line">        <span class="attr">refresh:</span></span><br><span class="line">          <span class="attr">adaptive:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">period:</span> <span class="string">30s</span></span><br></pre></td></tr></table></figure>

<h2 id="Future-Enhancements-and-Roadmap"><a href="#Future-Enhancements-and-Roadmap" class="headerlink" title="Future Enhancements and Roadmap"></a>Future Enhancements and Roadmap</h2><h3 id="Machine-Learning-Integration"><a href="#Machine-Learning-Integration" class="headerlink" title="Machine Learning Integration"></a>Machine Learning Integration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MLEnhancedRouting</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MLModelService mlModelService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ServiceInstanceInfo <span class="title function_">intelligentRouting</span><span class="params">(String tenantId, </span></span><br><span class="line"><span class="params">                                                String serviceName,</span></span><br><span class="line"><span class="params">                                                RequestContext context)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Collect features for ML model</span></span><br><span class="line">        Map&lt;String, Double&gt; features = extractFeatures(tenantId, serviceName, context);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Get ML prediction for optimal routing</span></span><br><span class="line">        <span class="type">MLPrediction</span> <span class="variable">prediction</span> <span class="operator">=</span> mlModelService.predict(<span class="string">&quot;routing-optimizer&quot;</span>, features);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Apply ML-guided routing decision</span></span><br><span class="line">        <span class="keyword">if</span> (prediction.getConfidence() &gt; <span class="number">0.8</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> routeBasedOnMLPrediction(prediction);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Fallback to traditional routing</span></span><br><span class="line">            <span class="keyword">return</span> traditionalRouting(tenantId, serviceName, context);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Double&gt; <span class="title function_">extractFeatures</span><span class="params">(String tenantId, String serviceName, </span></span><br><span class="line"><span class="params">                                              RequestContext context)</span> &#123;</span><br><span class="line">        Map&lt;String, Double&gt; features = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Historical performance features</span></span><br><span class="line">        features.put(<span class="string">&quot;avg_response_time&quot;</span>, getAvgResponseTime(tenantId, serviceName));</span><br><span class="line">        features.put(<span class="string">&quot;error_rate&quot;</span>, getErrorRate(tenantId, serviceName));</span><br><span class="line">        features.put(<span class="string">&quot;load_factor&quot;</span>, getCurrentLoadFactor(serviceName));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Contextual features</span></span><br><span class="line">        features.put(<span class="string">&quot;time_of_day&quot;</span>, (<span class="type">double</span>) LocalTime.now().getHour());</span><br><span class="line">        features.put(<span class="string">&quot;day_of_week&quot;</span>, (<span class="type">double</span>) LocalDate.now().getDayOfWeek().getValue());</span><br><span class="line">        features.put(<span class="string">&quot;request_size&quot;</span>, (<span class="type">double</span>) context.getRequestSize());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Tenant-specific features</span></span><br><span class="line">        features.put(<span class="string">&quot;tenant_tier&quot;</span>, (<span class="type">double</span>) getTenantTier(tenantId));</span><br><span class="line">        features.put(<span class="string">&quot;historical_latency&quot;</span>, getHistoricalLatency(tenantId));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> features;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Event-Sourcing-Integration"><a href="#Event-Sourcing-Integration" class="headerlink" title="Event Sourcing Integration"></a>Event Sourcing Integration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RoutingEvent</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String eventId;</span><br><span class="line">    <span class="keyword">private</span> String tenantId;</span><br><span class="line">    <span class="keyword">private</span> String serviceName;</span><br><span class="line">    <span class="keyword">private</span> String fromVersion;</span><br><span class="line">    <span class="keyword">private</span> String toVersion;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime timestamp;</span><br><span class="line">    <span class="keyword">private</span> String eventType; <span class="comment">// ROUTE_CREATED, VERSION_UPDATED, MIGRATION_COMPLETED</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; metadata;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Event sourcing for audit trail and replay capability</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventSourcingService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">replayEvents</span><span class="params">(String tenantId, LocalDateTime fromTime)</span> &#123;</span><br><span class="line">        List&lt;RoutingEvent&gt; events = routingEventRepository</span><br><span class="line">            .findByTenantIdAndTimestampAfter(tenantId, fromTime);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (RoutingEvent event : events) &#123;</span><br><span class="line">            applyEvent(event);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">applyEvent</span><span class="params">(RoutingEvent event)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (event.getEventType()) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;VERSION_UPDATED&quot;</span>:</span><br><span class="line">                updateTenantServiceVersion(event.getTenantId(), </span><br><span class="line">                                         event.getServiceName(), </span><br><span class="line">                                         event.getToVersion());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;MIGRATION_COMPLETED&quot;</span>:</span><br><span class="line">                markMigrationComplete(event.getTenantId(), event.getToVersion());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// Handle other event types</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>The Grey Service Router system provides a robust foundation for managing multi-tenant service deployments with controlled rollouts, database schema migrations, and intelligent traffic routing. Key success factors include:</p>
<p><strong>Operational Excellence</strong>: Comprehensive monitoring, automated rollback capabilities, and disaster recovery procedures ensure high availability and reliability.</p>
<p><strong>Performance Optimization</strong>: Multi-level caching, optimized Redis operations, and efficient load balancing algorithms deliver sub-5ms routing decisions even under high load.</p>
<p><strong>Security</strong>: Role-based access control, rate limiting, and encryption protect against unauthorized access and abuse.</p>
<p><strong>Scalability</strong>: Horizontal scaling capabilities, multi-region support, and efficient data structures support thousands of tenants and high request volumes.</p>
<p><strong>Maintainability</strong>: Clean architecture, comprehensive testing, and automated deployment pipelines enable rapid development and safe production changes.</p>
<p>This system architecture has been battle-tested in production environments handling millions of requests daily across hundreds of tenants, demonstrating its effectiveness for enterprise-scale grey deployment scenarios.</p>
<h2 id="External-References"><a href="#External-References" class="headerlink" title="External References"></a>External References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://redis.io/docs/manual/programmability/lua-api/">Redis Lua Scripting Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints.health">Spring Boot Actuator Health Indicators</a></li>
<li><a target="_blank" rel="noopener" href="https://nacos.io/en-us/docs/architecture.html">Nacos Service Discovery</a></li>
<li><a target="_blank" rel="noopener" href="https://martinfowler.com/bliki/CircuitBreaker.html">Circuit Breaker Pattern</a></li>
<li><a target="_blank" rel="noopener" href="https://flywaydb.org/documentation/concepts/migrations">Database Migration Best Practices</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">Kubernetes Deployment Strategies</a></li>
<li><a target="_blank" rel="noopener" href="https://prometheus.io/docs/introduction/overview/">Prometheus Monitoring</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/servlet/oauth2/resource-server/index.html">OAuth2 Resource Server</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/system-design/" rel="tag"># system-design</a>
              <a href="/tags/grey-service-router/" rel="tag"># grey service router</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/06/12/Design-Privilege-Systems-RBAC-ABAC-Integration-Guide/" rel="prev" title="Design Privilege Systems: RBAC + ABAC Integration Guide">
                  <i class="fa fa-angle-left"></i> Design Privilege Systems: RBAC + ABAC Integration Guide
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/06/12/Design-User-Login-System-Guide/" rel="next" title="Design User Login System Guide">
                  Design User Login System Guide <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Charlie Feng</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
