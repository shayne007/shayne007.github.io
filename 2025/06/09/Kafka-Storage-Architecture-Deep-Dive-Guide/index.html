<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"shayne007.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="IntroductionApache Kafka’s storage architecture is designed for high-throughput, fault-tolerant, and scalable distributed streaming. Understanding its storage mechanics is crucial for system design, p">
<meta property="og:type" content="article">
<meta property="og:title" content="Kafka Storage Architecture: Deep Dive Guide">
<meta property="og:url" content="https://shayne007.github.io/2025/06/09/Kafka-Storage-Architecture-Deep-Dive-Guide/index.html">
<meta property="og:site_name" content="Charlie Feng&#39;s Tech Space">
<meta property="og:description" content="IntroductionApache Kafka’s storage architecture is designed for high-throughput, fault-tolerant, and scalable distributed streaming. Understanding its storage mechanics is crucial for system design, p">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-06-09T09:14:18.000Z">
<meta property="article:modified_time" content="2025-06-09T09:19:52.411Z">
<meta property="article:author" content="Charlie Feng">
<meta property="article:tag" content="kafka">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://shayne007.github.io/2025/06/09/Kafka-Storage-Architecture-Deep-Dive-Guide/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://shayne007.github.io/2025/06/09/Kafka-Storage-Architecture-Deep-Dive-Guide/","path":"2025/06/09/Kafka-Storage-Architecture-Deep-Dive-Guide/","title":"Kafka Storage Architecture: Deep Dive Guide"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Kafka Storage Architecture: Deep Dive Guide | Charlie Feng's Tech Space</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"cdn":false,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.5.0/mermaid.min.js","integrity":"sha256-2obLuIPcceEhkE3G09G33hBdmE55ivVcZUlcKcGNHjU="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>





  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Charlie Feng's Tech Space</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">You will survive with skills</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Introduction"><span class="nav-number">1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Core-Storage-Components"><span class="nav-number">2.</span> <span class="nav-text">Core Storage Components</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Log-Structure-Overview"><span class="nav-number">2.1.</span> <span class="nav-text">Log Structure Overview</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#File-Types-and-Their-Purposes"><span class="nav-number">2.2.</span> <span class="nav-text">File Types and Their Purposes</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Log-Segments-and-File-Structure"><span class="nav-number">3.</span> <span class="nav-text">Log Segments and File Structure</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Segment-Lifecycle"><span class="nav-number">3.1.</span> <span class="nav-text">Segment Lifecycle</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Internal-File-Structure-Example"><span class="nav-number">3.2.</span> <span class="nav-text">Internal File Structure Example</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Message-Format-Deep-Dive"><span class="nav-number">3.3.</span> <span class="nav-text">Message Format Deep Dive</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Partition-Distribution-and-Replication"><span class="nav-number">4.</span> <span class="nav-text">Partition Distribution and Replication</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Replica-Placement-Strategy"><span class="nav-number">4.1.</span> <span class="nav-text">Replica Placement Strategy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ISR-In-Sync-Replicas-Management"><span class="nav-number">4.2.</span> <span class="nav-text">ISR (In-Sync Replicas) Management</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Storage-Best-Practices"><span class="nav-number">5.</span> <span class="nav-text">Storage Best Practices</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Disk-Configuration"><span class="nav-number">5.1.</span> <span class="nav-text">Disk Configuration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Retention-Policies-Showcase"><span class="nav-number">5.2.</span> <span class="nav-text">Retention Policies Showcase</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Performance-Tuning-Configuration"><span class="nav-number">5.3.</span> <span class="nav-text">Performance Tuning Configuration</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Performance-Optimization"><span class="nav-number">6.</span> <span class="nav-text">Performance Optimization</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Throughput-Optimization-Strategies"><span class="nav-number">6.1.</span> <span class="nav-text">Throughput Optimization Strategies</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Capacity-Planning-Formula"><span class="nav-number">6.2.</span> <span class="nav-text">Capacity Planning Formula</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Monitoring-and-Troubleshooting"><span class="nav-number">7.</span> <span class="nav-text">Monitoring and Troubleshooting</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Key-Metrics-Dashboard"><span class="nav-number">7.1.</span> <span class="nav-text">Key Metrics Dashboard</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Common-Storage-Issues-and-Solutions"><span class="nav-number">7.2.</span> <span class="nav-text">Common Storage Issues and Solutions</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Interview-Questions-Real-World-Scenarios"><span class="nav-number">8.</span> <span class="nav-text">Interview Questions &amp; Real-World Scenarios</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Scenario-Based-Questions"><span class="nav-number">8.1.</span> <span class="nav-text">Scenario-Based Questions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Deep-Technical-Questions"><span class="nav-number">8.2.</span> <span class="nav-text">Deep Technical Questions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Production-Scenarios"><span class="nav-number">8.3.</span> <span class="nav-text">Production Scenarios</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Best-Practices-Summary"><span class="nav-number">8.4.</span> <span class="nav-text">Best Practices Summary</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Charlie Feng</p>
  <div class="site-description" itemprop="description">This place is for thinking and sharing.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">48</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/09/Kafka-Storage-Architecture-Deep-Dive-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Kafka Storage Architecture: Deep Dive Guide | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Kafka Storage Architecture: Deep Dive Guide
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-09 17:14:18 / Modified: 17:19:52" itemprop="dateCreated datePublished" datetime="2025-06-09T17:14:18+08:00">2025-06-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/kafka/" itemprop="url" rel="index"><span itemprop="name">kafka</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Apache Kafka’s storage architecture is designed for high-throughput, fault-tolerant, and scalable distributed streaming. Understanding its storage mechanics is crucial for system design, performance tuning, and operational excellence.</p>
<p><strong>Key Design Principles:</strong></p>
<ul>
<li><strong>Append-only logs</strong>: Sequential writes for maximum performance</li>
<li><strong>Immutable records</strong>: Once written, messages are never modified</li>
<li><strong>Distributed partitioning</strong>: Horizontal scaling across brokers</li>
<li><strong>Configurable retention</strong>: Time and size-based cleanup policies</li>
</ul>
<h2 id="Core-Storage-Components"><a href="#Core-Storage-Components" class="headerlink" title="Core Storage Components"></a>Core Storage Components</h2><h3 id="Log-Structure-Overview"><a href="#Log-Structure-Overview" class="headerlink" title="Log Structure Overview"></a>Log Structure Overview</h3><pre>
<code class="mermaid">
graph TD
A[Topic] --&gt; B[Partition 0]
A --&gt; C[Partition 1]
A --&gt; D[Partition 2]

B --&gt; E[Segment 0]
B --&gt; F[Segment 1]
B --&gt; G[Active Segment]

E --&gt; H[.log file]
E --&gt; I[.index file]
E --&gt; J[.timeindex file]

subgraph &quot;Broker File System&quot;
    H
    I
    J
    K[.snapshot files]
    L[leader-epoch-checkpoint]
end
</code>
</pre>

<h3 id="File-Types-and-Their-Purposes"><a href="#File-Types-and-Their-Purposes" class="headerlink" title="File Types and Their Purposes"></a>File Types and Their Purposes</h3><table>
<thead>
<tr>
<th>File Type</th>
<th>Extension</th>
<th>Purpose</th>
<th>Size Limit</th>
</tr>
</thead>
<tbody><tr>
<td>Log Segment</td>
<td><code>.log</code></td>
<td>Actual message data</td>
<td><code>log.segment.bytes</code> (1GB default)</td>
</tr>
<tr>
<td>Offset Index</td>
<td><code>.index</code></td>
<td>Maps logical offset to physical position</td>
<td><code>log.index.size.max.bytes</code> (10MB default)</td>
</tr>
<tr>
<td>Time Index</td>
<td><code>.timeindex</code></td>
<td>Maps timestamp to offset</td>
<td><code>log.index.size.max.bytes</code></td>
</tr>
<tr>
<td>Snapshot</td>
<td><code>.snapshot</code></td>
<td>Compacted topic state snapshots</td>
<td>Variable</td>
</tr>
<tr>
<td>Leader Epoch</td>
<td><code>leader-epoch-checkpoint</code></td>
<td>Tracks leadership changes</td>
<td>Small</td>
</tr>
</tbody></table>
<h2 id="Log-Segments-and-File-Structure"><a href="#Log-Segments-and-File-Structure" class="headerlink" title="Log Segments and File Structure"></a>Log Segments and File Structure</h2><h3 id="Segment-Lifecycle"><a href="#Segment-Lifecycle" class="headerlink" title="Segment Lifecycle"></a>Segment Lifecycle</h3><pre>
<code class="mermaid">
sequenceDiagram
participant Producer
participant ActiveSegment
participant ClosedSegment
participant CleanupThread

Producer-&gt;&gt;ActiveSegment: Write messages
Note over ActiveSegment: Grows until segment.bytes limit
ActiveSegment-&gt;&gt;ClosedSegment: Roll to new segment
Note over ClosedSegment: Becomes immutable
CleanupThread-&gt;&gt;ClosedSegment: Apply retention policy
ClosedSegment-&gt;&gt;CleanupThread: Delete when expired
</code>
</pre>

<h3 id="Internal-File-Structure-Example"><a href="#Internal-File-Structure-Example" class="headerlink" title="Internal File Structure Example"></a>Internal File Structure Example</h3><p><strong>Directory Structure:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/var/kafka-logs/</span><br><span class="line">├── my-topic-0/</span><br><span class="line">│   ├── 00000000000000000000.log      # Messages 0-999</span><br><span class="line">│   ├── 00000000000000000000.index    # Offset index</span><br><span class="line">│   ├── 00000000000000000000.timeindex # Time index</span><br><span class="line">│   ├── 00000000000000001000.log      # Messages 1000-1999</span><br><span class="line">│   ├── 00000000000000001000.index</span><br><span class="line">│   ├── 00000000000000001000.timeindex</span><br><span class="line">│   └── leader-epoch-checkpoint</span><br><span class="line">└── my-topic-1/</span><br><span class="line">    └── ... (similar structure)</span><br></pre></td></tr></table></figure>

<h3 id="Message-Format-Deep-Dive"><a href="#Message-Format-Deep-Dive" class="headerlink" title="Message Format Deep Dive"></a>Message Format Deep Dive</h3><p><strong>Record Batch Structure (v2):</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Record Batch Header:</span><br><span class="line">├── First Offset (8 bytes)</span><br><span class="line">├── Batch Length (4 bytes)</span><br><span class="line">├── Partition Leader Epoch (4 bytes)</span><br><span class="line">├── Magic Byte (1 byte)</span><br><span class="line">├── CRC (4 bytes)</span><br><span class="line">├── Attributes (2 bytes)</span><br><span class="line">├── Last Offset Delta (4 bytes)</span><br><span class="line">├── First Timestamp (8 bytes)</span><br><span class="line">├── Max Timestamp (8 bytes)</span><br><span class="line">├── Producer ID (8 bytes)</span><br><span class="line">├── Producer Epoch (2 bytes)</span><br><span class="line">├── Base Sequence (4 bytes)</span><br><span class="line">└── Records Array</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight:</strong> <em>Why does Kafka use batch compression instead of individual message compression?</em></p>
<ul>
<li>Reduces CPU overhead by compressing multiple messages together</li>
<li>Better compression ratios due to similarity between adjacent messages</li>
<li>Maintains high throughput by amortizing compression costs</li>
</ul>
<h2 id="Partition-Distribution-and-Replication"><a href="#Partition-Distribution-and-Replication" class="headerlink" title="Partition Distribution and Replication"></a>Partition Distribution and Replication</h2><h3 id="Replica-Placement-Strategy"><a href="#Replica-Placement-Strategy" class="headerlink" title="Replica Placement Strategy"></a>Replica Placement Strategy</h3><pre>
<code class="mermaid">
graph LR
subgraph &quot;Broker 1&quot;
    A[Topic-A-P0 Leader]
    B[Topic-A-P1 Follower]
    C[Topic-A-P2 Follower]
end

subgraph &quot;Broker 2&quot;
    D[Topic-A-P0 Follower]
    E[Topic-A-P1 Leader]
    F[Topic-A-P2 Follower]
end

subgraph &quot;Broker 3&quot;
    G[Topic-A-P0 Follower]
    H[Topic-A-P1 Follower]
    I[Topic-A-P2 Leader]
end

A -.-&gt;|Replication| D
A -.-&gt;|Replication| G
E -.-&gt;|Replication| B
E -.-&gt;|Replication| H
I -.-&gt;|Replication| C
I -.-&gt;|Replication| F
</code>
</pre>

<h3 id="ISR-In-Sync-Replicas-Management"><a href="#ISR-In-Sync-Replicas-Management" class="headerlink" title="ISR (In-Sync Replicas) Management"></a>ISR (In-Sync Replicas) Management</h3><p><strong>Critical Configuration Parameters:</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Replica lag tolerance</span></span><br><span class="line"><span class="attr">replica.lag.time.max.ms</span>=<span class="string">30000</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Minimum ISR required for writes</span></span><br><span class="line"><span class="attr">min.insync.replicas</span>=<span class="string">2</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Unclean leader election (data loss risk)</span></span><br><span class="line"><span class="attr">unclean.leader.election.enable</span>=<span class="string">false</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Question:</strong> <em>What happens when ISR shrinks below min.insync.replicas?</em></p>
<ul>
<li>Producers with <code>acks=all</code> will receive <code>NotEnoughReplicasException</code></li>
<li>Topic becomes read-only until ISR is restored</li>
<li>This prevents data loss but reduces availability</li>
</ul>
<h2 id="Storage-Best-Practices"><a href="#Storage-Best-Practices" class="headerlink" title="Storage Best Practices"></a>Storage Best Practices</h2><h3 id="Disk-Configuration"><a href="#Disk-Configuration" class="headerlink" title="Disk Configuration"></a>Disk Configuration</h3><p><strong>Optimal Setup:</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Storage Strategy:</span></span><br><span class="line">  <span class="attr">Primary:</span> <span class="string">SSD</span> <span class="string">for</span> <span class="string">active</span> <span class="string">segments</span> <span class="string">(faster</span> <span class="string">writes)</span></span><br><span class="line">  <span class="attr">Secondary:</span> <span class="string">HDD</span> <span class="string">for</span> <span class="string">older</span> <span class="string">segments</span> <span class="string">(cost-effective)</span></span><br><span class="line">  <span class="attr">RAID:</span> <span class="string">RAID-10</span> <span class="string">for</span> <span class="string">balance</span> <span class="string">of</span> <span class="string">performance</span> <span class="string">and</span> <span class="string">redundancy</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">File System:</span></span><br><span class="line">  <span class="attr">Recommended:</span> <span class="string">XFS</span> <span class="string">or</span> <span class="string">ext4</span></span><br><span class="line">  <span class="attr">Mount Options:</span> <span class="string">noatime,nodiratime</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">Directory Layout:</span></span><br><span class="line">  <span class="string">/var/kafka-logs-1/</span>  <span class="comment"># SSD</span></span><br><span class="line">  <span class="string">/var/kafka-logs-2/</span>  <span class="comment"># SSD  </span></span><br><span class="line">  <span class="string">/var/kafka-logs-3/</span>  <span class="comment"># HDD (archive)</span></span><br></pre></td></tr></table></figure>

<h3 id="Retention-Policies-Showcase"><a href="#Retention-Policies-Showcase" class="headerlink" title="Retention Policies Showcase"></a>Retention Policies Showcase</h3><pre>
<code class="mermaid">
flowchart TD
A[Message Arrives] --&gt; B{Check Active Segment Size}
B --&gt;|&lt; segment.bytes| C[Append to Active Segment]
B --&gt;|&gt;&#x3D; segment.bytes| D[Roll New Segment]

D --&gt; E[Close Previous Segment]
E --&gt; F{Apply Retention Policy}

F --&gt; G[Time-based: log.retention.hours]
F --&gt; H[Size-based: log.retention.bytes]
F --&gt; I[Compaction: log.cleanup.policy&#x3D;compact]

G --&gt; J{Segment Age &gt; Retention?}
H --&gt; K{Total Size &gt; Limit?}
I --&gt; L[Run Log Compaction]

J --&gt;|Yes| M[Delete Segment]
K --&gt;|Yes| M
L --&gt; N[Keep Latest Value per Key]
</code>
</pre>

<h3 id="Performance-Tuning-Configuration"><a href="#Performance-Tuning-Configuration" class="headerlink" title="Performance Tuning Configuration"></a>Performance Tuning Configuration</h3><p><strong>Producer Optimizations:</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Batching for throughput</span></span><br><span class="line"><span class="attr">batch.size</span>=<span class="string">32768</span></span><br><span class="line"><span class="attr">linger.ms</span>=<span class="string">10</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Compression</span></span><br><span class="line"><span class="attr">compression.type</span>=<span class="string">lz4</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Memory allocation</span></span><br><span class="line"><span class="attr">buffer.memory</span>=<span class="string">67108864</span></span><br></pre></td></tr></table></figure>

<p><strong>Broker Storage Optimizations:</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Segment settings</span></span><br><span class="line"><span class="attr">log.segment.bytes</span>=<span class="string">268435456        # 256MB segments</span></span><br><span class="line"><span class="attr">log.roll.hours</span>=<span class="string">168                 # Weekly rolls</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Flush settings (let OS handle)</span></span><br><span class="line"><span class="attr">log.flush.interval.messages</span>=<span class="string">Long.MAX_VALUE</span></span><br><span class="line"><span class="attr">log.flush.interval.ms</span>=<span class="string">Long.MAX_VALUE</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Index settings</span></span><br><span class="line"><span class="attr">log.index.interval.bytes</span>=<span class="string">4096</span></span><br><span class="line"><span class="attr">log.index.size.max.bytes</span>=<span class="string">10485760  # 10MB</span></span><br></pre></td></tr></table></figure>

<h2 id="Performance-Optimization"><a href="#Performance-Optimization" class="headerlink" title="Performance Optimization"></a>Performance Optimization</h2><h3 id="Throughput-Optimization-Strategies"><a href="#Throughput-Optimization-Strategies" class="headerlink" title="Throughput Optimization Strategies"></a>Throughput Optimization Strategies</h3><p><strong>Read Path Optimization:</strong></p>
<pre>
<code class="mermaid">
graph LR
A[Consumer Request] --&gt; B[Check Page Cache]
B --&gt;|Hit| C[Return from Memory]
B --&gt;|Miss| D[Read from Disk]
D --&gt; E[Zero-Copy Transfer]
E --&gt; F[sendfile System Call]
F --&gt; G[Direct Disk-to-Network]
</code>
</pre>

<p><strong>Write Path Optimization:</strong></p>
<pre>
<code class="mermaid">
graph TD
A[Producer Batch] --&gt; B[Memory Buffer]
B --&gt; C[Page Cache]
C --&gt; D[Async Flush to Disk]
D --&gt; E[Sequential Write]

F[OS Background] --&gt; G[Periodic fsync]
G --&gt; H[Durability Guarantee]
</code>
</pre>

<h3 id="Capacity-Planning-Formula"><a href="#Capacity-Planning-Formula" class="headerlink" title="Capacity Planning Formula"></a>Capacity Planning Formula</h3><p><strong>Storage Requirements Calculation:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Daily Storage = (Messages/day × Avg Message Size × Replication Factor) / Compression Ratio</span><br><span class="line"></span><br><span class="line">Retention Storage = Daily Storage × Retention Days × Growth Factor</span><br><span class="line"></span><br><span class="line">Example:</span><br><span class="line">- 1M messages/day × 1KB × 3 replicas = 3GB/day</span><br><span class="line">- 7 days retention × 1.2 growth factor = 25.2GB total</span><br></pre></td></tr></table></figure>

<h2 id="Monitoring-and-Troubleshooting"><a href="#Monitoring-and-Troubleshooting" class="headerlink" title="Monitoring and Troubleshooting"></a>Monitoring and Troubleshooting</h2><h3 id="Key-Metrics-Dashboard"><a href="#Key-Metrics-Dashboard" class="headerlink" title="Key Metrics Dashboard"></a>Key Metrics Dashboard</h3><table>
<thead>
<tr>
<th>Metric Category</th>
<th>Key Indicators</th>
<th>Alert Thresholds</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Storage</strong></td>
<td><code>kafka.log.size</code>, <code>disk.free</code></td>
<td>&lt; 15% free space</td>
</tr>
<tr>
<td><strong>Replication</strong></td>
<td><code>UnderReplicatedPartitions</code></td>
<td>&gt; 0</td>
</tr>
<tr>
<td><strong>Performance</strong></td>
<td><code>MessagesInPerSec</code>, <code>BytesInPerSec</code></td>
<td>Baseline deviation</td>
</tr>
<tr>
<td><strong>Lag</strong></td>
<td><code>ConsumerLag</code>, <code>ReplicaLag</code></td>
<td>&gt; 1000 messages</td>
</tr>
</tbody></table>
<h3 id="Common-Storage-Issues-and-Solutions"><a href="#Common-Storage-Issues-and-Solutions" class="headerlink" title="Common Storage Issues and Solutions"></a>Common Storage Issues and Solutions</h3><p><strong>Issue 1: Disk Space Exhaustion</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Emergency cleanup - increase log cleanup frequency</span></span><br><span class="line">kafka-configs.sh --alter --entity-type brokers --entity-name 0 \</span><br><span class="line">  --add-config log.cleaner.min.cleanable.ratio=0.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Temporary retention reduction</span></span><br><span class="line">kafka-configs.sh --alter --entity-type topics --entity-name my-topic \</span><br><span class="line">  --add-config retention.ms=3600000  <span class="comment"># 1 hour</span></span><br></pre></td></tr></table></figure>

<p><strong>Issue 2: Slow Consumer Performance</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Check if issue is disk I/O or network</span></span><br><span class="line">iostat -x 1</span><br><span class="line">iftop</span><br><span class="line"></span><br><span class="line"><span class="comment"># Verify zero-copy is working</span></span><br><span class="line">strace -p &lt;kafka-pid&gt; | grep sendfile</span><br></pre></td></tr></table></figure>

<h2 id="Interview-Questions-Real-World-Scenarios"><a href="#Interview-Questions-Real-World-Scenarios" class="headerlink" title="Interview Questions &amp; Real-World Scenarios"></a>Interview Questions &amp; Real-World Scenarios</h2><h3 id="Scenario-Based-Questions"><a href="#Scenario-Based-Questions" class="headerlink" title="Scenario-Based Questions"></a>Scenario-Based Questions</h3><p><strong>Q1: Design Challenge</strong><br><em>“You have a Kafka cluster handling 100GB&#x2F;day with 7-day retention. One broker is running out of disk space. Walk me through your troubleshooting and resolution strategy.”</em></p>
<p><strong>Answer Framework:</strong></p>
<ol>
<li><strong>Immediate Actions</strong>: Check partition distribution, identify large partitions</li>
<li><strong>Short-term</strong>: Reduce retention temporarily, enable log compaction if applicable</li>
<li><strong>Long-term</strong>: Rebalance partitions, add storage capacity, implement tiered storage</li>
</ol>
<p><strong>Q2: Performance Analysis</strong><br><em>“Your Kafka cluster shows decreasing write throughput over time. What could be the causes and how would you investigate?”</em></p>
<p><strong>Investigation Checklist:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Check segment distribution</span></span><br><span class="line"><span class="built_in">ls</span> -la /var/kafka-logs/*/</span><br><span class="line"></span><br><span class="line"><span class="comment"># Monitor I/O patterns</span></span><br><span class="line">iotop -ao</span><br><span class="line"></span><br><span class="line"><span class="comment"># Analyze JVM garbage collection</span></span><br><span class="line">jstat -gc &lt;kafka-pid&gt; 1s</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check network utilization</span></span><br><span class="line">netstat -i</span><br></pre></td></tr></table></figure>

<p><strong>Q3: Data Consistency</strong><br><em>“Explain the trade-offs between <code>acks=0</code>, <code>acks=1</code>, and <code>acks=all</code> in terms of storage and durability.”</em></p>
<table>
<thead>
<tr>
<th>Setting</th>
<th>Durability</th>
<th>Performance</th>
<th>Use Case</th>
</tr>
</thead>
<tbody><tr>
<td><code>acks=0</code></td>
<td>Lowest</td>
<td>Highest</td>
<td>Metrics, logs where some loss is acceptable</td>
</tr>
<tr>
<td><code>acks=1</code></td>
<td>Medium</td>
<td>Medium</td>
<td>General purpose, balanced approach</td>
</tr>
<tr>
<td><code>acks=all</code></td>
<td>Highest</td>
<td>Lowest</td>
<td>Financial transactions, critical data</td>
</tr>
</tbody></table>
<h3 id="Deep-Technical-Questions"><a href="#Deep-Technical-Questions" class="headerlink" title="Deep Technical Questions"></a>Deep Technical Questions</h3><p><strong>Q4: Memory Management</strong><br><em>“How does Kafka leverage the OS page cache, and why doesn’t it implement its own caching mechanism?”</em></p>
<p><strong>Answer Points:</strong></p>
<ul>
<li>Kafka relies on OS page cache for read performance</li>
<li>Avoids double caching (JVM heap + OS cache)</li>
<li>Sequential access patterns work well with OS prefetching</li>
<li>Zero-copy transfers (sendfile) possible only with OS cache</li>
</ul>
<p><strong>Q5: Log Compaction Deep Dive</strong><br><em>“Explain how log compaction works and when it might cause issues in production.”</em></p>
<pre>
<code class="mermaid">
graph TD
A[Original Log] --&gt; B[Compaction Process]
B --&gt; C[Compacted Log]

subgraph &quot;Before Compaction&quot;
    D[Key1:V1] --&gt; E[Key2:V1] --&gt; F[Key1:V2] --&gt; G[Key3:V1] --&gt; H[Key1:V3]
end

subgraph &quot;After Compaction&quot;
    I[Key2:V1] --&gt; J[Key3:V1] --&gt; K[Key1:V3]
end
</code>
</pre>

<p><strong>Potential Issues:</strong></p>
<ul>
<li>Compaction lag during high-write periods</li>
<li>Tombstone records not cleaned up properly</li>
<li>Consumer offset management with compacted topics</li>
</ul>
<h3 id="Production-Scenarios"><a href="#Production-Scenarios" class="headerlink" title="Production Scenarios"></a>Production Scenarios</h3><p><strong>Q6: Disaster Recovery</strong><br><em>“A data center hosting 2 out of 3 Kafka brokers goes offline. Describe the impact and recovery process.”</em></p>
<p><strong>Impact Analysis:</strong></p>
<ul>
<li>Partitions with <code>min.insync.replicas=2</code>: Unavailable for writes</li>
<li>Partitions with replicas in surviving broker: Continue operating</li>
<li>Consumer lag increases rapidly</li>
</ul>
<p><strong>Recovery Strategy:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. Assess cluster state</span></span><br><span class="line">kafka-topics.sh --bootstrap-server localhost:9092 --describe</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Temporarily reduce min.insync.replicas if necessary</span></span><br><span class="line">kafka-configs.sh --alter --entity-type topics --entity-name critical-topic \</span><br><span class="line">  --add-config min.insync.replicas=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Monitor under-replicated partitions</span></span><br><span class="line">kafka-run-class.sh kafka.tools.ClusterTool --bootstrap-server localhost:9092</span><br></pre></td></tr></table></figure>

<h3 id="Best-Practices-Summary"><a href="#Best-Practices-Summary" class="headerlink" title="Best Practices Summary"></a>Best Practices Summary</h3><p><strong>Storage Design Principles:</strong></p>
<ol>
<li><strong>Separate data and logs</strong>: Use different disks for Kafka data and application logs</li>
<li><strong>Monitor disk usage trends</strong>: Set up automated alerts at 80% capacity</li>
<li><strong>Plan for growth</strong>: Account for replication factor and retention policies</li>
<li><strong>Test disaster recovery</strong>: Regular drills for broker failures and data corruption</li>
<li><strong>Optimize for access patterns</strong>: Hot data on SSD, cold data on HDD</li>
</ol>
<p><strong>Configuration Management:</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Production-ready storage configuration</span></span><br><span class="line"><span class="attr">log.dirs</span>=<span class="string">/var/kafka-logs-1,/var/kafka-logs-2</span></span><br><span class="line"><span class="attr">log.segment.bytes</span>=<span class="string">536870912          # 512MB</span></span><br><span class="line"><span class="attr">log.retention.hours</span>=<span class="string">168              # 1 week</span></span><br><span class="line"><span class="attr">log.retention.check.interval.ms</span>=<span class="string">300000</span></span><br><span class="line"><span class="attr">log.cleanup.policy</span>=<span class="string">delete</span></span><br><span class="line"><span class="attr">min.insync.replicas</span>=<span class="string">2</span></span><br><span class="line"><span class="attr">unclean.leader.election.enable</span>=<span class="string">false</span></span><br><span class="line"><span class="attr">auto.create.topics.enable</span>=<span class="string">false</span></span><br></pre></td></tr></table></figure>

<p>This comprehensive guide provides the foundation for understanding Kafka’s storage architecture while preparing you for both operational challenges and technical interviews. The key is to understand not just the “what” but the “why” behind each design decision.</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/kafka/" rel="tag"># kafka</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/06/09/MySQL-Performance-Optimization-Complete-Guide/" rel="prev" title="MySQL Performance Optimization: Complete Guide">
                  <i class="fa fa-angle-left"></i> MySQL Performance Optimization: Complete Guide
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/06/09/Kafka-ISR-High-Watermark-Leader-Epoch-Deep-Dive-Guide/" rel="next" title="Kafka ISR, High Watermark &amp; Leader Epoch - Deep Dive Guide">
                  Kafka ISR, High Watermark & Leader Epoch - Deep Dive Guide <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Charlie Feng</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
