<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"shayne007.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="IntroductionDatabase sharding is a horizontal scaling technique that distributes data across multiple database instances. As applications grow and face increasing data volumes and user loads, traditio">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL Database Sharding: Complete Guide">
<meta property="og:url" content="https://shayne007.github.io/2025/06/08/MySQL-Database-Sharding-Complete-Guide/index.html">
<meta property="og:site_name" content="Charlie Feng&#39;s Tech Space">
<meta property="og:description" content="IntroductionDatabase sharding is a horizontal scaling technique that distributes data across multiple database instances. As applications grow and face increasing data volumes and user loads, traditio">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-06-08T09:38:40.000Z">
<meta property="article:modified_time" content="2025-06-08T09:39:25.647Z">
<meta property="article:author" content="Charlie Feng">
<meta property="article:tag" content="mysql">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://shayne007.github.io/2025/06/08/MySQL-Database-Sharding-Complete-Guide/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://shayne007.github.io/2025/06/08/MySQL-Database-Sharding-Complete-Guide/","path":"2025/06/08/MySQL-Database-Sharding-Complete-Guide/","title":"MySQL Database Sharding: Complete Guide"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>MySQL Database Sharding: Complete Guide | Charlie Feng's Tech Space</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"cdn":false,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.5.0/mermaid.min.js","integrity":"sha256-2obLuIPcceEhkE3G09G33hBdmE55ivVcZUlcKcGNHjU="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>





  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Charlie Feng's Tech Space</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">You will survive with skills</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Introduction"><span class="nav-number">1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Understanding-Database-Sharding"><span class="nav-number">2.</span> <span class="nav-text">Understanding Database Sharding</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#What-is-Sharding"><span class="nav-number">2.1.</span> <span class="nav-text">What is Sharding?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sharding-vs-Other-Scaling-Techniques"><span class="nav-number">2.2.</span> <span class="nav-text">Sharding vs. Other Scaling Techniques</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sharding-Strategies"><span class="nav-number">3.</span> <span class="nav-text">Sharding Strategies</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Range-Based-Sharding"><span class="nav-number">3.1.</span> <span class="nav-text">1. Range-Based Sharding</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Hash-Based-Sharding"><span class="nav-number">3.2.</span> <span class="nav-text">2. Hash-Based Sharding</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Directory-Based-Sharding"><span class="nav-number">3.3.</span> <span class="nav-text">3. Directory-Based Sharding</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-Geographic-Sharding"><span class="nav-number">3.4.</span> <span class="nav-text">4. Geographic Sharding</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Implementation-Approaches"><span class="nav-number">4.</span> <span class="nav-text">Implementation Approaches</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Application-Level-Sharding"><span class="nav-number">4.1.</span> <span class="nav-text">Application-Level Sharding</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Middleware-Proxy-Based-Sharding"><span class="nav-number">4.2.</span> <span class="nav-text">Middleware&#x2F;Proxy-Based Sharding</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Database-Level-Sharding"><span class="nav-number">4.3.</span> <span class="nav-text">Database-Level Sharding</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Best-Practices"><span class="nav-number">5.</span> <span class="nav-text">Best Practices</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Choosing-the-Right-Sharding-Key"><span class="nav-number">5.1.</span> <span class="nav-text">Choosing the Right Sharding Key</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Data-Modeling-for-Sharded-Systems"><span class="nav-number">5.2.</span> <span class="nav-text">Data Modeling for Sharded Systems</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Connection-Management"><span class="nav-number">5.3.</span> <span class="nav-text">Connection Management</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Transaction-Management"><span class="nav-number">5.4.</span> <span class="nav-text">Transaction Management</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Challenges-and-Solutions"><span class="nav-number">6.</span> <span class="nav-text">Challenges and Solutions</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Cross-Shard-Queries"><span class="nav-number">6.1.</span> <span class="nav-text">Cross-Shard Queries</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Rebalancing-and-Resharding"><span class="nav-number">6.2.</span> <span class="nav-text">Rebalancing and Resharding</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hotspots-and-Load-Balancing"><span class="nav-number">6.3.</span> <span class="nav-text">Hotspots and Load Balancing</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Performance-Considerations"><span class="nav-number">7.</span> <span class="nav-text">Performance Considerations</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Query-Optimization-for-Sharded-Systems"><span class="nav-number">7.1.</span> <span class="nav-text">Query Optimization for Sharded Systems</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Caching-Strategies"><span class="nav-number">7.2.</span> <span class="nav-text">Caching Strategies</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Monitoring-and-Maintenance"><span class="nav-number">8.</span> <span class="nav-text">Monitoring and Maintenance</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Key-Metrics-to-Monitor"><span class="nav-number">8.1.</span> <span class="nav-text">Key Metrics to Monitor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Backup-and-Recovery"><span class="nav-number">8.2.</span> <span class="nav-text">Backup and Recovery</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Real-World-Examples"><span class="nav-number">9.</span> <span class="nav-text">Real-World Examples</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#E-commerce-Platform-Sharding"><span class="nav-number">9.1.</span> <span class="nav-text">E-commerce Platform Sharding</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Social-Media-Platform-Sharding"><span class="nav-number">9.2.</span> <span class="nav-text">Social Media Platform Sharding</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Interview-Insights"><span class="nav-number">10.</span> <span class="nav-text">Interview Insights</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Common-Interview-Questions-and-Answers"><span class="nav-number">10.1.</span> <span class="nav-text">Common Interview Questions and Answers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Technical-Deep-Dive-Questions"><span class="nav-number">10.2.</span> <span class="nav-text">Technical Deep-Dive Questions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Advanced-Sharding-Patterns"><span class="nav-number">10.3.</span> <span class="nav-text">Advanced Sharding Patterns</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Performance-Optimization-Strategies"><span class="nav-number">10.4.</span> <span class="nav-text">Performance Optimization Strategies</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Disaster-Recovery-and-High-Availability"><span class="nav-number">10.5.</span> <span class="nav-text">Disaster Recovery and High Availability</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Security-Considerations"><span class="nav-number">10.6.</span> <span class="nav-text">Security Considerations</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Conclusion"><span class="nav-number">11.</span> <span class="nav-text">Conclusion</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Key-Takeaways"><span class="nav-number">11.1.</span> <span class="nav-text">Key Takeaways</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Final-Interview-Advice"><span class="nav-number">11.2.</span> <span class="nav-text">Final Interview Advice</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Charlie Feng</p>
  <div class="site-description" itemprop="description">This place is for thinking and sharing.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">28</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/08/MySQL-Database-Sharding-Complete-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="MySQL Database Sharding: Complete Guide | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          MySQL Database Sharding: Complete Guide
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-08 17:38:40 / Modified: 17:39:25" itemprop="dateCreated datePublished" datetime="2025-06-08T17:38:40+08:00">2025-06-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Database sharding is a horizontal scaling technique that distributes data across multiple database instances. As applications grow and face increasing data volumes and user loads, traditional vertical scaling (adding more CPU, RAM, or storage) becomes insufficient and cost-prohibitive. Sharding addresses this by partitioning data horizontally across multiple database servers, allowing for linear scalability and improved performance.</p>
<p><strong>Key Interview Question</strong>: <em>“When would you consider implementing database sharding over other scaling solutions?”</em></p>
<p>The decision to implement sharding typically occurs when:</p>
<ul>
<li>Single database performance degrades despite optimization</li>
<li>Data volume exceeds single server capacity</li>
<li>Read&#x2F;write throughput requirements exceed single instance limits</li>
<li>Geographic distribution of users requires localized data access</li>
<li>Compliance requirements mandate data locality</li>
</ul>
<h2 id="Understanding-Database-Sharding"><a href="#Understanding-Database-Sharding" class="headerlink" title="Understanding Database Sharding"></a>Understanding Database Sharding</h2><h3 id="What-is-Sharding"><a href="#What-is-Sharding" class="headerlink" title="What is Sharding?"></a>What is Sharding?</h3><p>Sharding partitions a large database into smaller, more manageable pieces called “shards.” Each shard contains a subset of the total data and operates as an independent database. The collection of shards together represents the complete dataset.</p>
<h3 id="Sharding-vs-Other-Scaling-Techniques"><a href="#Sharding-vs-Other-Scaling-Techniques" class="headerlink" title="Sharding vs. Other Scaling Techniques"></a>Sharding vs. Other Scaling Techniques</h3><p><strong>Vertical Scaling (Scale Up)</strong></p>
<ul>
<li>Increases hardware resources on a single server</li>
<li>Limited by hardware constraints</li>
<li>Single point of failure</li>
<li>Eventually becomes cost-prohibitive</li>
</ul>
<p><strong>Read Replicas</strong></p>
<ul>
<li>Multiple read-only copies of the master database</li>
<li>Improves read performance but doesn’t help with write scaling</li>
<li>All writes still go to the master</li>
</ul>
<p><strong>Sharding (Horizontal Scaling)</strong></p>
<ul>
<li>Distributes both reads and writes across multiple servers</li>
<li>Theoretically unlimited scalability</li>
<li>Eliminates single points of failure</li>
<li>Introduces complexity in application logic</li>
</ul>
<p><strong>Interview Insight</strong>: Candidates should understand that sharding is typically the last resort due to its complexity. Always explore vertical scaling, read replicas, caching, and query optimization first.</p>
<h2 id="Sharding-Strategies"><a href="#Sharding-Strategies" class="headerlink" title="Sharding Strategies"></a>Sharding Strategies</h2><h3 id="1-Range-Based-Sharding"><a href="#1-Range-Based-Sharding" class="headerlink" title="1. Range-Based Sharding"></a>1. Range-Based Sharding</h3><p>Data is partitioned based on ranges of a specific column value, typically a primary key or timestamp.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Example: User data sharded by user ID ranges</span></span><br><span class="line"><span class="comment">-- Shard 1: user_id 1-10000</span></span><br><span class="line"><span class="comment">-- Shard 2: user_id 10001-20000</span></span><br><span class="line"><span class="comment">-- Shard 3: user_id 20001-30000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> user_id <span class="keyword">BETWEEN</span> <span class="number">10001</span> <span class="keyword">AND</span> <span class="number">20000</span>;</span><br><span class="line"><span class="comment">-- Routes to Shard 2</span></span><br></pre></td></tr></table></figure>

<p><strong>Advantages:</strong></p>
<ul>
<li>Simple to understand and implement</li>
<li>Range queries are efficient</li>
<li>Easy to add new shards for new ranges</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li>Potential for hotspots if data distribution is uneven</li>
<li>Difficult to rebalance existing shards</li>
<li>Sequential IDs can create write hotspots</li>
</ul>
<h3 id="2-Hash-Based-Sharding"><a href="#2-Hash-Based-Sharding" class="headerlink" title="2. Hash-Based Sharding"></a>2. Hash-Based Sharding</h3><p>Data is distributed using a hash function applied to a sharding key.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Example hash-based sharding logic</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_shard</span>(<span class="params">user_id, num_shards</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">hash</span>(user_id) % num_shards</span><br><span class="line"></span><br><span class="line"><span class="comment"># user_id 12345 -&gt; hash(12345) % 4 = shard_2</span></span><br></pre></td></tr></table></figure>

<p><strong>Advantages:</strong></p>
<ul>
<li>Even data distribution</li>
<li>No hotspots with good hash function</li>
<li>Predictable shard routing</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li>Range queries require checking all shards</li>
<li>Difficult to add&#x2F;remove shards (resharding required)</li>
<li>Hash function changes affect all data</li>
</ul>
<h3 id="3-Directory-Based-Sharding"><a href="#3-Directory-Based-Sharding" class="headerlink" title="3. Directory-Based Sharding"></a>3. Directory-Based Sharding</h3><p>A lookup service maintains a mapping of sharding keys to specific shards.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Sharding directory table</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> shard_directory (</span><br><span class="line">    shard_key <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    shard_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Example mappings</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> shard_directory <span class="keyword">VALUES</span> </span><br><span class="line">(<span class="string">&#x27;user_region_us_east&#x27;</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="string">&#x27;user_region_us_west&#x27;</span>, <span class="number">2</span>),</span><br><span class="line">(<span class="string">&#x27;user_region_europe&#x27;</span>, <span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<p><strong>Advantages:</strong></p>
<ul>
<li>Flexible shard assignment</li>
<li>Easy to rebalance and migrate data</li>
<li>Supports complex sharding logic</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li>Additional lookup overhead</li>
<li>Directory service becomes a potential bottleneck</li>
<li>More complex to implement and maintain</li>
</ul>
<h3 id="4-Geographic-Sharding"><a href="#4-Geographic-Sharding" class="headerlink" title="4. Geographic Sharding"></a>4. Geographic Sharding</h3><p>Data is partitioned based on geographic location, often for compliance or performance reasons.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Users table with geographic sharding</span></span><br><span class="line"><span class="comment">-- US Shard</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users_us (</span><br><span class="line">    user_id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">    region ENUM(<span class="string">&#x27;US&#x27;</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;US&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- EU Shard  </span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users_eu (</span><br><span class="line">    user_id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">    region ENUM(<span class="string">&#x27;EU&#x27;</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;EU&#x27;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><strong>Interview Question</strong>: <em>“How would you handle a user who moves from one geographic region to another in a geographically sharded system?”</em></p>
<p><strong>Answer</strong>: This requires careful planning including data migration procedures, temporary dual-write strategies during migration, and handling of cross-shard relationships. Consider implementing a migration workflow that can move user data between shards while maintaining data consistency.</p>
<h2 id="Implementation-Approaches"><a href="#Implementation-Approaches" class="headerlink" title="Implementation Approaches"></a>Implementation Approaches</h2><h3 id="Application-Level-Sharding"><a href="#Application-Level-Sharding" class="headerlink" title="Application-Level Sharding"></a>Application-Level Sharding</h3><p>The application handles shard routing, query distribution, and result aggregation.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ShardManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, shards</span>):</span><br><span class="line">        <span class="variable language_">self</span>.shards = shards</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_connection</span>(<span class="params">self, shard_key</span>):</span><br><span class="line">        shard_id = <span class="variable language_">self</span>.calculate_shard(shard_key)</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.shards[shard_id].get_connection()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">calculate_shard</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">hash</span>(key) % <span class="built_in">len</span>(<span class="variable language_">self</span>.shards)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute_query</span>(<span class="params">self, shard_key, query</span>):</span><br><span class="line">        conn = <span class="variable language_">self</span>.get_connection(shard_key)</span><br><span class="line">        <span class="keyword">return</span> conn.execute(query)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute_cross_shard_query</span>(<span class="params">self, query</span>):</span><br><span class="line">        results = []</span><br><span class="line">        <span class="keyword">for</span> shard <span class="keyword">in</span> <span class="variable language_">self</span>.shards:</span><br><span class="line">            result = shard.execute(query)</span><br><span class="line">            results.extend(result)</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.aggregate_results(results)</span><br></pre></td></tr></table></figure>

<p><strong>Advantages:</strong></p>
<ul>
<li>Full control over sharding logic</li>
<li>Can optimize for specific use cases</li>
<li>No additional infrastructure components</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li>Increases application complexity</li>
<li>Requires handling connection pooling per shard</li>
<li>Cross-shard operations become complex</li>
</ul>
<h3 id="Middleware-Proxy-Based-Sharding"><a href="#Middleware-Proxy-Based-Sharding" class="headerlink" title="Middleware&#x2F;Proxy-Based Sharding"></a>Middleware&#x2F;Proxy-Based Sharding</h3><p>A middleware layer handles shard routing transparently to the application.</p>
<p>Popular solutions include:</p>
<ul>
<li><strong>ProxySQL</strong>: MySQL-compatible proxy with sharding capabilities</li>
<li><strong>Vitess</strong>: Kubernetes-native MySQL sharding solution</li>
<li><strong>MySQL Router</strong>: Official MySQL proxy with limited sharding support</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Example Vitess configuration</span></span><br><span class="line"><span class="attr">keyspaces:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">user_data</span></span><br><span class="line">    <span class="attr">sharded:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">vindexes:</span></span><br><span class="line">      <span class="attr">hash:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">hash</span></span><br><span class="line">    <span class="attr">tables:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">users</span></span><br><span class="line">        <span class="attr">column_vindexes:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">column:</span> <span class="string">user_id</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">hash</span></span><br></pre></td></tr></table></figure>

<p><strong>Advantages:</strong></p>
<ul>
<li>Transparent to application</li>
<li>Centralized shard management</li>
<li>Built-in connection pooling and load balancing</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li>Additional infrastructure complexity</li>
<li>Potential single point of failure</li>
<li>Learning curve for specific tools</li>
</ul>
<h3 id="Database-Level-Sharding"><a href="#Database-Level-Sharding" class="headerlink" title="Database-Level Sharding"></a>Database-Level Sharding</h3><p>Some databases provide built-in sharding capabilities.</p>
<p><strong>MySQL Cluster (NDB)</strong></p>
<ul>
<li>Automatic data distribution</li>
<li>Built-in redundancy</li>
<li>Different storage engine with limitations</li>
</ul>
<p><strong>MySQL with Partitioning</strong></p>
<ul>
<li>Table-level partitioning within single instance</li>
<li>Not true sharding but can help with some use cases</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- MySQL table partitioning example</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    user_id <span class="type">INT</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">    created_at <span class="type">DATE</span></span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span>(user_id) (</span><br><span class="line">    <span class="keyword">PARTITION</span> p1 <span class="keyword">VALUES</span> LESS THAN (<span class="number">10000</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p2 <span class="keyword">VALUES</span> LESS THAN (<span class="number">20000</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p3 <span class="keyword">VALUES</span> LESS THAN (<span class="number">30000</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h2 id="Best-Practices"><a href="#Best-Practices" class="headerlink" title="Best Practices"></a>Best Practices</h2><h3 id="Choosing-the-Right-Sharding-Key"><a href="#Choosing-the-Right-Sharding-Key" class="headerlink" title="Choosing the Right Sharding Key"></a>Choosing the Right Sharding Key</h3><p>The sharding key is crucial for system performance and maintainability.</p>
<p><strong>Characteristics of a Good Sharding Key:</strong></p>
<ul>
<li>High cardinality (many unique values)</li>
<li>Even distribution of access patterns</li>
<li>Rarely changes or never changes</li>
<li>Present in most queries</li>
<li>Allows for efficient routing</li>
</ul>
<p><strong>Common Interview Question</strong>: <em>“What would you use as a sharding key for a social media application?”</em></p>
<p><strong>Answer</strong>: User ID is often the best choice because:</p>
<ul>
<li>High cardinality (millions of users)</li>
<li>Present in most queries (posts, likes, follows)</li>
<li>Immutable once assigned</li>
<li>Enables user-centric data locality</li>
</ul>
<p>However, consider the trade-offs:</p>
<ul>
<li>Cross-user analytics become complex</li>
<li>Friend relationships span shards</li>
<li>Popular users might create hotspots</li>
</ul>
<h3 id="Data-Modeling-for-Sharded-Systems"><a href="#Data-Modeling-for-Sharded-Systems" class="headerlink" title="Data Modeling for Sharded Systems"></a>Data Modeling for Sharded Systems</h3><p><strong>Denormalization Strategy</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Instead of normalized tables across shards</span></span><br><span class="line"><span class="comment">-- Users table (shard by user_id)</span></span><br><span class="line"><span class="comment">-- Posts table (shard by user_id) </span></span><br><span class="line"><span class="comment">-- Comments table (shard by user_id)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Consider denormalized approach</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> user_timeline (</span><br><span class="line">    user_id <span class="type">INT</span>,</span><br><span class="line">    post_id <span class="type">INT</span>,</span><br><span class="line">    post_content TEXT,</span><br><span class="line">    post_timestamp <span class="type">TIMESTAMP</span>,</span><br><span class="line">    comment_count <span class="type">INT</span>,</span><br><span class="line">    like_count <span class="type">INT</span>,</span><br><span class="line">    <span class="comment">-- Denormalized data for efficient queries</span></span><br><span class="line">    author_name <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">    author_avatar_url <span class="type">VARCHAR</span>(<span class="number">500</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><strong>Avoiding Cross-Shard Joins</strong></p>
<ul>
<li>Denormalize frequently joined data</li>
<li>Use application-level joins when necessary</li>
<li>Consider data duplication for read performance</li>
<li>Implement eventual consistency patterns</li>
</ul>
<h3 id="Connection-Management"><a href="#Connection-Management" class="headerlink" title="Connection Management"></a>Connection Management</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ShardConnectionPool</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, shard_configs</span>):</span><br><span class="line">        <span class="variable language_">self</span>.pools = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> shard_id, config <span class="keyword">in</span> shard_configs.items():</span><br><span class="line">            <span class="variable language_">self</span>.pools[shard_id] = mysql.connector.pooling.MySQLConnectionPool(</span><br><span class="line">                pool_name=<span class="string">f&quot;shard_<span class="subst">&#123;shard_id&#125;</span>&quot;</span>,</span><br><span class="line">                pool_size=config[<span class="string">&#x27;pool_size&#x27;</span>],</span><br><span class="line">                **config[<span class="string">&#x27;connection_params&#x27;</span>]</span><br><span class="line">            )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_connection</span>(<span class="params">self, shard_id</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.pools[shard_id].get_connection()</span><br></pre></td></tr></table></figure>

<p><strong>Best Practices:</strong></p>
<ul>
<li>Maintain separate connection pools per shard</li>
<li>Monitor pool utilization and adjust sizes</li>
<li>Implement circuit breakers for failed shards</li>
<li>Use connection health checks</li>
</ul>
<h3 id="Transaction-Management"><a href="#Transaction-Management" class="headerlink" title="Transaction Management"></a>Transaction Management</h3><p><strong>Single-Shard Transactions</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">transfer_within_shard</span>(<span class="params">shard_key, from_account, to_account, amount</span>):</span><br><span class="line">    conn = get_shard_connection(shard_key)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        conn.begin()</span><br><span class="line">        <span class="comment"># Debit from_account</span></span><br><span class="line">        conn.execute(<span class="string">&quot;UPDATE accounts SET balance = balance - %s WHERE id = %s&quot;</span>, </span><br><span class="line">                    (amount, from_account))</span><br><span class="line">        <span class="comment"># Credit to_account  </span></span><br><span class="line">        conn.execute(<span class="string">&quot;UPDATE accounts SET balance = balance + %s WHERE id = %s&quot;</span>, </span><br><span class="line">                    (amount, to_account))</span><br><span class="line">        conn.commit()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        conn.rollback()</span><br><span class="line">        <span class="keyword">raise</span> e</span><br></pre></td></tr></table></figure>

<p><strong>Cross-Shard Transactions</strong><br>Implement distributed transaction patterns like Two-Phase Commit (2PC) or Saga pattern:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">transfer_cross_shard</span>(<span class="params">from_shard_key, to_shard_key, from_account, to_account, amount</span>):</span><br><span class="line">    <span class="comment"># Saga pattern implementation</span></span><br><span class="line">    steps = [</span><br><span class="line">        (<span class="string">&quot;debit&quot;</span>, from_shard_key, from_account, amount),</span><br><span class="line">        (<span class="string">&quot;credit&quot;</span>, to_shard_key, to_account, amount)</span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    completed_steps = []</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">for</span> step_type, shard_key, account, amt <span class="keyword">in</span> steps:</span><br><span class="line">            execute_step(step_type, shard_key, account, amt)</span><br><span class="line">            completed_steps.append((step_type, shard_key, account, amt))</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># Compensate completed steps</span></span><br><span class="line">        <span class="keyword">for</span> step <span class="keyword">in</span> <span class="built_in">reversed</span>(completed_steps):</span><br><span class="line">            compensate_step(step)</span><br><span class="line">        <span class="keyword">raise</span> e</span><br></pre></td></tr></table></figure>

<h2 id="Challenges-and-Solutions"><a href="#Challenges-and-Solutions" class="headerlink" title="Challenges and Solutions"></a>Challenges and Solutions</h2><h3 id="Cross-Shard-Queries"><a href="#Cross-Shard-Queries" class="headerlink" title="Cross-Shard Queries"></a>Cross-Shard Queries</h3><p><strong>Challenge</strong>: Aggregating data across multiple shards efficiently.</p>
<p><strong>Solutions:</strong></p>
<ol>
<li><strong>Application-Level Aggregation</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_user_stats_across_shards</span>(<span class="params">user_id_list</span>):</span><br><span class="line">    shard_queries = defaultdict(<span class="built_in">list</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Group users by shard</span></span><br><span class="line">    <span class="keyword">for</span> user_id <span class="keyword">in</span> user_id_list:</span><br><span class="line">        shard_id = calculate_shard(user_id)</span><br><span class="line">        shard_queries[shard_id].append(user_id)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Execute parallel queries</span></span><br><span class="line">    results = []</span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor() <span class="keyword">as</span> executor:</span><br><span class="line">        futures = []</span><br><span class="line">        <span class="keyword">for</span> shard_id, user_ids <span class="keyword">in</span> shard_queries.items():</span><br><span class="line">            future = executor.submit(query_shard_users, shard_id, user_ids)</span><br><span class="line">            futures.append(future)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> future <span class="keyword">in</span> futures:</span><br><span class="line">            results.extend(future.result())</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> aggregate_user_stats(results)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>Materialized Views&#x2F;ETL</strong></li>
</ol>
<ul>
<li>Pre-aggregate data in separate analytical databases</li>
<li>Use ETL processes to combine shard data</li>
<li>Implement near real-time data pipelines</li>
</ul>
<h3 id="Rebalancing-and-Resharding"><a href="#Rebalancing-and-Resharding" class="headerlink" title="Rebalancing and Resharding"></a>Rebalancing and Resharding</h3><p><strong>Challenge</strong>: Adding new shards or rebalancing existing ones without downtime.</p>
<p><strong>Solutions:</strong></p>
<ol>
<li><strong>Consistent Hashing</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> bisect</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConsistentHash</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, nodes=<span class="literal">None</span>, replicas=<span class="number">150</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.replicas = replicas</span><br><span class="line">        <span class="variable language_">self</span>.ring = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.sorted_keys = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> nodes:</span><br><span class="line">            <span class="keyword">for</span> node <span class="keyword">in</span> nodes:</span><br><span class="line">                <span class="variable language_">self</span>.add_node(node)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_node</span>(<span class="params">self, node</span>):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="variable language_">self</span>.replicas):</span><br><span class="line">            key = <span class="variable language_">self</span>.<span class="built_in">hash</span>(<span class="string">f&quot;<span class="subst">&#123;node&#125;</span>:<span class="subst">&#123;i&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.ring[key] = node</span><br><span class="line">            bisect.insort(<span class="variable language_">self</span>.sorted_keys, key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_node</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.ring:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        hash_key = <span class="variable language_">self</span>.<span class="built_in">hash</span>(key)</span><br><span class="line">        idx = bisect.bisect_right(<span class="variable language_">self</span>.sorted_keys, hash_key)</span><br><span class="line">        <span class="keyword">if</span> idx == <span class="built_in">len</span>(<span class="variable language_">self</span>.sorted_keys):</span><br><span class="line">            idx = <span class="number">0</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.ring[<span class="variable language_">self</span>.sorted_keys[idx]]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>Live Migration Strategy</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">migrate_shard_data</span>(<span class="params">source_shard, target_shard, migration_key_range</span>):</span><br><span class="line">    <span class="comment"># 1. Start dual-write to both shards</span></span><br><span class="line">    enable_dual_write(source_shard, target_shard, migration_key_range)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. Copy existing data</span></span><br><span class="line">    copy_data_batch(source_shard, target_shard, migration_key_range)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3. Verify data consistency</span></span><br><span class="line">    verify_data_consistency(source_shard, target_shard, migration_key_range)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 4. Switch reads to target shard</span></span><br><span class="line">    switch_reads(target_shard, migration_key_range)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 5. Stop dual-write, switch writes to target</span></span><br><span class="line">    switch_writes(target_shard, migration_key_range)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 6. Clean up source shard data</span></span><br><span class="line">    cleanup_source_data(source_shard, migration_key_range)</span><br></pre></td></tr></table></figure>

<h3 id="Hotspots-and-Load-Balancing"><a href="#Hotspots-and-Load-Balancing" class="headerlink" title="Hotspots and Load Balancing"></a>Hotspots and Load Balancing</h3><p><strong>Interview Question</strong>: <em>“How would you handle a situation where one shard is receiving significantly more traffic than others?”</em></p>
<p><strong>Solutions:</strong></p>
<ol>
<li><strong>Hotspot Detection</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HotspotMonitor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.shard_metrics = defaultdict(<span class="keyword">lambda</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;queries_per_second&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;cpu_usage&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;connection_count&#x27;</span>: <span class="number">0</span></span><br><span class="line">        &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">detect_hotspots</span>(<span class="params">self, threshold_multiplier=<span class="number">2.0</span></span>):</span><br><span class="line">        avg_qps = <span class="built_in">sum</span>(m[<span class="string">&#x27;queries_per_second&#x27;</span>] <span class="keyword">for</span> m <span class="keyword">in</span> <span class="variable language_">self</span>.shard_metrics.values()) / <span class="built_in">len</span>(<span class="variable language_">self</span>.shard_metrics)</span><br><span class="line">        </span><br><span class="line">        hotspots = []</span><br><span class="line">        <span class="keyword">for</span> shard_id, metrics <span class="keyword">in</span> <span class="variable language_">self</span>.shard_metrics.items():</span><br><span class="line">            <span class="keyword">if</span> metrics[<span class="string">&#x27;queries_per_second&#x27;</span>] &gt; avg_qps * threshold_multiplier:</span><br><span class="line">                hotspots.append(shard_id)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> hotspots</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>Load Balancing Strategies</strong></li>
</ol>
<ul>
<li><strong>Split hot shards</strong>: Divide heavily loaded shard ranges</li>
<li><strong>Read replicas</strong>: Add read replicas for hot shards</li>
<li><strong>Caching</strong>: Implement application-level caching for hot data</li>
<li><strong>Request throttling</strong>: Rate limit requests to hot shards</li>
</ul>
<h2 id="Performance-Considerations"><a href="#Performance-Considerations" class="headerlink" title="Performance Considerations"></a>Performance Considerations</h2><h3 id="Query-Optimization-for-Sharded-Systems"><a href="#Query-Optimization-for-Sharded-Systems" class="headerlink" title="Query Optimization for Sharded Systems"></a>Query Optimization for Sharded Systems</h3><p><strong>Efficient Query Patterns:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Good: Single shard query with shard key</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> user_id <span class="operator">=</span> <span class="number">12345</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Good: Single shard range query</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> posts <span class="keyword">WHERE</span> user_id <span class="operator">=</span> <span class="number">12345</span> <span class="keyword">AND</span> created_at <span class="operator">&gt;</span> <span class="string">&#x27;2023-01-01&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Avoid: Cross-shard queries without shard key</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> age <span class="operator">&gt;</span> <span class="number">25</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Better: Use application-level aggregation</span></span><br><span class="line"><span class="comment">-- Query each shard separately and combine results</span></span><br></pre></td></tr></table></figure>

<p><strong>Indexing Strategy:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Ensure shard key is part of compound indexes</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_user_posts <span class="keyword">ON</span> posts(user_id, created_at, post_type);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Include shard key in all WHERE clauses</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> posts </span><br><span class="line"><span class="keyword">WHERE</span> user_id <span class="operator">=</span> <span class="number">12345</span> <span class="comment">-- Shard key</span></span><br><span class="line">  <span class="keyword">AND</span> post_type <span class="operator">=</span> <span class="string">&#x27;public&#x27;</span> </span><br><span class="line">  <span class="keyword">AND</span> created_at <span class="operator">&gt;</span> <span class="string">&#x27;2023-01-01&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Caching-Strategies"><a href="#Caching-Strategies" class="headerlink" title="Caching Strategies"></a>Caching Strategies</h3><p><strong>Multi-Level Caching:</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ShardedCache</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.l1_cache = &#123;&#125;  <span class="comment"># Application memory cache</span></span><br><span class="line">        <span class="variable language_">self</span>.l2_cache = redis.Redis()  <span class="comment"># Shared Redis cache</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="comment"># Try L1 cache first</span></span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">in</span> <span class="variable language_">self</span>.l1_cache:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.l1_cache[key]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Try L2 cache</span></span><br><span class="line">        value = <span class="variable language_">self</span>.l2_cache.get(key)</span><br><span class="line">        <span class="keyword">if</span> value:</span><br><span class="line">            <span class="variable language_">self</span>.l1_cache[key] = value</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Fallback to database</span></span><br><span class="line">        shard_key = extract_shard_key(key)</span><br><span class="line">        value = query_shard(shard_key, key)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Cache the result</span></span><br><span class="line">        <span class="variable language_">self</span>.l2_cache.setex(key, <span class="number">3600</span>, value)</span><br><span class="line">        <span class="variable language_">self</span>.l1_cache[key] = value</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> value</span><br></pre></td></tr></table></figure>

<h2 id="Monitoring-and-Maintenance"><a href="#Monitoring-and-Maintenance" class="headerlink" title="Monitoring and Maintenance"></a>Monitoring and Maintenance</h2><h3 id="Key-Metrics-to-Monitor"><a href="#Key-Metrics-to-Monitor" class="headerlink" title="Key Metrics to Monitor"></a>Key Metrics to Monitor</h3><p><strong>Per-Shard Metrics:</strong></p>
<ul>
<li>Query response time (P50, P95, P99)</li>
<li>Queries per second</li>
<li>Connection pool utilization</li>
<li>Disk I&#x2F;O and CPU usage</li>
<li>Error rates and timeouts</li>
</ul>
<p><strong>Cross-Shard Metrics:</strong></p>
<ul>
<li>Query distribution across shards</li>
<li>Cross-shard query frequency</li>
<li>Data migration progress</li>
<li>Replication lag (if using replicas)</li>
</ul>
<p><strong>Monitoring Implementation:</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ShardMonitor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.metrics_collector = MetricsCollector()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">collect_shard_metrics</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> shard_id <span class="keyword">in</span> <span class="variable language_">self</span>.shards:</span><br><span class="line">            metrics = &#123;</span><br><span class="line">                <span class="string">&#x27;shard_id&#x27;</span>: shard_id,</span><br><span class="line">                <span class="string">&#x27;timestamp&#x27;</span>: time.time(),</span><br><span class="line">                <span class="string">&#x27;active_connections&#x27;</span>: <span class="variable language_">self</span>.get_active_connections(shard_id),</span><br><span class="line">                <span class="string">&#x27;queries_per_second&#x27;</span>: <span class="variable language_">self</span>.get_qps(shard_id),</span><br><span class="line">                <span class="string">&#x27;avg_response_time&#x27;</span>: <span class="variable language_">self</span>.get_avg_response_time(shard_id),</span><br><span class="line">                <span class="string">&#x27;error_rate&#x27;</span>: <span class="variable language_">self</span>.get_error_rate(shard_id)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">self</span>.metrics_collector.send(metrics)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_shard_health</span>(<span class="params">self</span>):</span><br><span class="line">        unhealthy_shards = []</span><br><span class="line">        <span class="keyword">for</span> shard_id <span class="keyword">in</span> <span class="variable language_">self</span>.shards:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                conn = <span class="variable language_">self</span>.get_connection(shard_id)</span><br><span class="line">                conn.execute(<span class="string">&quot;SELECT 1&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                unhealthy_shards.append((shard_id, <span class="built_in">str</span>(e)))</span><br><span class="line">        <span class="keyword">return</span> unhealthy_shards</span><br></pre></td></tr></table></figure>

<h3 id="Backup-and-Recovery"><a href="#Backup-and-Recovery" class="headerlink" title="Backup and Recovery"></a>Backup and Recovery</h3><p><strong>Shard-Level Backups:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Backup script for individual shards</span></span><br><span class="line"></span><br><span class="line">SHARD_ID=<span class="variable">$1</span></span><br><span class="line">BACKUP_DIR=<span class="string">&quot;/backups/shard_<span class="variable">$&#123;SHARD_ID&#125;</span>&quot;</span></span><br><span class="line">DATE=$(<span class="built_in">date</span> +%Y%m%d_%H%M%S)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create consistent backup</span></span><br><span class="line">mysqldump --single-transaction \</span><br><span class="line">          --routines \</span><br><span class="line">          --triggers \</span><br><span class="line">          --host=<span class="variable">$&#123;SHARD_HOST&#125;</span> \</span><br><span class="line">          --user=<span class="variable">$&#123;SHARD_USER&#125;</span> \</span><br><span class="line">          --password=<span class="variable">$&#123;SHARD_PASS&#125;</span> \</span><br><span class="line">          <span class="variable">$&#123;SHARD_DATABASE&#125;</span> &gt; <span class="variable">$&#123;BACKUP_DIR&#125;</span>/backup_<span class="variable">$&#123;DATE&#125;</span>.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># Compress backup</span></span><br><span class="line">gzip <span class="variable">$&#123;BACKUP_DIR&#125;</span>/backup_<span class="variable">$&#123;DATE&#125;</span>.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># Upload to cloud storage</span></span><br><span class="line">aws s3 <span class="built_in">cp</span> <span class="variable">$&#123;BACKUP_DIR&#125;</span>/backup_<span class="variable">$&#123;DATE&#125;</span>.sql.gz \</span><br><span class="line">          s3://db-backups/shard_<span class="variable">$&#123;SHARD_ID&#125;</span>/</span><br></pre></td></tr></table></figure>

<p><strong>Point-in-Time Recovery:</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">restore_shard_to_point_in_time</span>(<span class="params">shard_id, target_timestamp</span>):</span><br><span class="line">    <span class="comment"># 1. Find appropriate backup before target time</span></span><br><span class="line">    backup_file = find_backup_before_timestamp(shard_id, target_timestamp)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. Restore from backup</span></span><br><span class="line">    restore_from_backup(shard_id, backup_file)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3. Apply binary logs up to target timestamp</span></span><br><span class="line">    apply_binary_logs(shard_id, backup_file.timestamp, target_timestamp)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 4. Verify data integrity</span></span><br><span class="line">    verify_shard_integrity(shard_id)</span><br></pre></td></tr></table></figure>

<h2 id="Real-World-Examples"><a href="#Real-World-Examples" class="headerlink" title="Real-World Examples"></a>Real-World Examples</h2><h3 id="E-commerce-Platform-Sharding"><a href="#E-commerce-Platform-Sharding" class="headerlink" title="E-commerce Platform Sharding"></a>E-commerce Platform Sharding</h3><p><strong>Scenario</strong>: An e-commerce platform with millions of users and orders.</p>
<p><strong>Sharding Strategy:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Shard by user_id for user-centric data</span></span><br><span class="line"><span class="comment">-- Shard 1: user_id % 4 = 0</span></span><br><span class="line"><span class="comment">-- Shard 2: user_id % 4 = 1  </span></span><br><span class="line"><span class="comment">-- Shard 3: user_id % 4 = 2</span></span><br><span class="line"><span class="comment">-- Shard 4: user_id % 4 = 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Users table (sharded by user_id)</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    user_id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">UNIQUE</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Orders table (sharded by user_id for co-location)</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders (</span><br><span class="line">    order_id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    user_id <span class="type">INT</span>,  <span class="comment">-- Shard key</span></span><br><span class="line">    total_amount <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">    status ENUM(<span class="string">&#x27;pending&#x27;</span>, <span class="string">&#x27;completed&#x27;</span>, <span class="string">&#x27;cancelled&#x27;</span>),</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span>,</span><br><span class="line">    INDEX idx_user_orders (user_id, created_at)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Order items (sharded by user_id via order relationship)</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> order_items (</span><br><span class="line">    item_id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    order_id <span class="type">INT</span>,</span><br><span class="line">    product_id <span class="type">INT</span>,</span><br><span class="line">    quantity <span class="type">INT</span>,</span><br><span class="line">    price <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><strong>Challenges Addressed:</strong></p>
<ul>
<li>Product catalog remains unsharded (reference data)</li>
<li>Order analytics aggregated via ETL processes</li>
<li>Cross-user features (recommendations) use separate service</li>
</ul>
<h3 id="Social-Media-Platform-Sharding"><a href="#Social-Media-Platform-Sharding" class="headerlink" title="Social Media Platform Sharding"></a>Social Media Platform Sharding</h3><p><strong>Scenario</strong>: Social media platform with user feeds, posts, and relationships.</p>
<p><strong>Multi-Dimensional Sharding:</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SocialMediaSharding</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.user_shards = <span class="number">8</span>  <span class="comment"># User data sharded by user_id</span></span><br><span class="line">        <span class="variable language_">self</span>.timeline_shards = <span class="number">16</span>  <span class="comment"># Timeline data sharded by user_id</span></span><br><span class="line">        <span class="variable language_">self</span>.content_shards = <span class="number">4</span>  <span class="comment"># Content sharded by content_id</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_user_shard</span>(<span class="params">self, user_id</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;user_shard_<span class="subst">&#123;user_id % self.user_shards&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_timeline_shard</span>(<span class="params">self, user_id</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;timeline_shard_<span class="subst">&#123;user_id % self.timeline_shards&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_content_shard</span>(<span class="params">self, content_id</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;content_shard_<span class="subst">&#123;content_id % self.content_shards&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>Feed Generation Strategy:</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">generate_user_feed</span>(<span class="params">user_id</span>):</span><br><span class="line">    <span class="comment"># 1. Get user&#x27;s following list (from user shard)</span></span><br><span class="line">    following_list = get_user_following(user_id)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. Fetch recent posts from followed users (distributed query)</span></span><br><span class="line">    recent_posts = []</span><br><span class="line">    <span class="keyword">for</span> followed_user_id <span class="keyword">in</span> following_list:</span><br><span class="line">        content_shard = get_content_shard_for_user(followed_user_id)</span><br><span class="line">        posts = fetch_recent_posts(content_shard, followed_user_id, limit=<span class="number">10</span>)</span><br><span class="line">        recent_posts.extend(posts)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3. Rank and personalize feed</span></span><br><span class="line">    ranked_feed = rank_posts(recent_posts, user_id)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 4. Cache generated feed</span></span><br><span class="line">    cache_user_feed(user_id, ranked_feed)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ranked_feed</span><br></pre></td></tr></table></figure>

<h2 id="Interview-Insights"><a href="#Interview-Insights" class="headerlink" title="Interview Insights"></a>Interview Insights</h2><h3 id="Common-Interview-Questions-and-Answers"><a href="#Common-Interview-Questions-and-Answers" class="headerlink" title="Common Interview Questions and Answers"></a>Common Interview Questions and Answers</h3><p><strong>Q: “How do you handle database schema changes in a sharded environment?”</strong></p>
<p><strong>A:</strong> Schema changes in sharded systems require careful planning:</p>
<ol>
<li><strong>Backward-compatible changes first</strong>: Add new columns with default values, create new indexes</li>
<li><strong>Rolling deployment</strong>: Apply changes to one shard at a time to minimize downtime</li>
<li><strong>Application compatibility</strong>: Ensure application can handle both old and new schemas during transition</li>
<li><strong>Automated tooling</strong>: Use migration tools that can apply changes across all shards consistently</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">deploy_schema_change</span>(<span class="params">migration_script</span>):</span><br><span class="line">    <span class="keyword">for</span> shard_id <span class="keyword">in</span> get_all_shards():</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># Apply migration to shard</span></span><br><span class="line">            apply_migration(shard_id, migration_script)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Verify migration success</span></span><br><span class="line">            verify_schema(shard_id)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Update deployment status</span></span><br><span class="line">            mark_shard_migrated(shard_id)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># Rollback and alert</span></span><br><span class="line">            rollback_migration(shard_id)</span><br><span class="line">            alert_migration_failure(shard_id, e)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p><strong>Q: “What are the trade-offs between different sharding strategies?”</strong></p>
<p><strong>A:</strong> Each strategy has specific trade-offs:</p>
<table>
<thead>
<tr>
<th>Strategy</th>
<th>Pros</th>
<th>Cons</th>
<th>Best For</th>
</tr>
</thead>
<tbody><tr>
<td>Range-based</td>
<td>Simple, efficient range queries</td>
<td>Hotspots, hard to rebalance</td>
<td>Time-series data, sequential access</td>
</tr>
<tr>
<td>Hash-based</td>
<td>Even distribution, no hotspots</td>
<td>No range queries, resharding complex</td>
<td>User data, even access patterns</td>
</tr>
<tr>
<td>Directory-based</td>
<td>Flexible, easy rebalancing</td>
<td>Lookup overhead, complexity</td>
<td>Dynamic requirements, frequent rebalancing</td>
</tr>
<tr>
<td>Geographic</td>
<td>Compliance, latency optimization</td>
<td>Cross-region complexity</td>
<td>Global applications, data locality requirements</td>
</tr>
</tbody></table>
<p><strong>Q: “How would you test a sharded database system?”</strong></p>
<p><strong>A:</strong> Comprehensive testing strategy includes:</p>
<ol>
<li><strong>Unit Testing</strong>: Test shard routing logic, connection management</li>
<li><strong>Integration Testing</strong>: Test cross-shard operations, transaction handling</li>
<li><strong>Load Testing</strong>: Simulate realistic traffic patterns across shards</li>
<li><strong>Failure Testing</strong>: Test behavior with shard failures, network partitions</li>
<li><strong>Migration Testing</strong>: Test resharding and rebalancing procedures</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ShardTestSuite</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_shard_routing</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Test that queries route to correct shards</span></span><br><span class="line">        <span class="keyword">for</span> user_id <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">            expected_shard = calculate_expected_shard(user_id)</span><br><span class="line">            actual_shard = shard_router.get_shard(user_id)</span><br><span class="line">            <span class="keyword">assert</span> expected_shard == actual_shard</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_cross_shard_transaction</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Test distributed transaction handling</span></span><br><span class="line">        result = transfer_between_shards(</span><br><span class="line">            from_shard=<span class="number">1</span>, to_shard=<span class="number">2</span>, </span><br><span class="line">            amount=<span class="number">100</span>, user1=<span class="number">123</span>, user2=<span class="number">456</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">assert</span> result.success</span><br><span class="line">        <span class="keyword">assert</span> verify_balance_consistency()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_shard_failure_handling</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Simulate shard failure and test fallback</span></span><br><span class="line">        <span class="keyword">with</span> mock_shard_failure(shard_id=<span class="number">2</span>):</span><br><span class="line">            response = query_with_fallback(user_id=<span class="number">456</span>)</span><br><span class="line">            <span class="keyword">assert</span> response.from_replica <span class="keyword">or</span> response.cached</span><br></pre></td></tr></table></figure>

<p><strong>Q: “When would you not recommend sharding?”</strong></p>
<p><strong>A:</strong> Avoid sharding when:</p>
<ul>
<li>Current database size is manageable (&lt; 100GB)</li>
<li>Query patterns don’t align with sharding keys</li>
<li>Application heavily relies on complex joins and transactions</li>
<li>Team lacks expertise in distributed systems</li>
<li>Alternative solutions (caching, read replicas, optimization) haven’t been fully explored</li>
</ul>
<p><strong>Red flags for sharding:</strong></p>
<ul>
<li>Premature optimization without clear bottlenecks</li>
<li>Complex reporting requirements across all data</li>
<li>Strong consistency requirements for all operations</li>
<li>Limited operational resources for maintaining distributed system</li>
</ul>
<h3 id="Technical-Deep-Dive-Questions"><a href="#Technical-Deep-Dive-Questions" class="headerlink" title="Technical Deep-Dive Questions"></a>Technical Deep-Dive Questions</h3><p><strong>Q: “Explain how you would implement consistent hashing for shard rebalancing.”</strong></p>
<p><strong>A:</strong> Consistent hashing minimizes data movement during resharding:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ConsistentHashingShardManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, initial_shards, virtual_nodes=<span class="number">150</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.virtual_nodes = virtual_nodes</span><br><span class="line">        <span class="variable language_">self</span>.ring = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.sorted_keys = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> shard <span class="keyword">in</span> initial_shards:</span><br><span class="line">            <span class="variable language_">self</span>.add_shard(shard)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">hash_function</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>(hashlib.md5(<span class="built_in">str</span>(key).encode()).hexdigest(), <span class="number">16</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_shard</span>(<span class="params">self, shard_id</span>):</span><br><span class="line">        <span class="comment"># Add multiple virtual nodes for each physical shard</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="variable language_">self</span>.virtual_nodes):</span><br><span class="line">            virtual_key = <span class="string">f&quot;<span class="subst">&#123;shard_id&#125;</span>:<span class="subst">&#123;i&#125;</span>&quot;</span></span><br><span class="line">            hash_key = <span class="variable language_">self</span>.hash_function(virtual_key)</span><br><span class="line">            <span class="variable language_">self</span>.ring[hash_key] = shard_id</span><br><span class="line">            bisect.insort(<span class="variable language_">self</span>.sorted_keys, hash_key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">remove_shard</span>(<span class="params">self, shard_id</span>):</span><br><span class="line">        <span class="comment"># Remove all virtual nodes for this shard</span></span><br><span class="line">        keys_to_remove = []</span><br><span class="line">        <span class="keyword">for</span> hash_key, shard <span class="keyword">in</span> <span class="variable language_">self</span>.ring.items():</span><br><span class="line">            <span class="keyword">if</span> shard == shard_id:</span><br><span class="line">                keys_to_remove.append(hash_key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> keys_to_remove:</span><br><span class="line">            <span class="keyword">del</span> <span class="variable language_">self</span>.ring[key]</span><br><span class="line">            <span class="variable language_">self</span>.sorted_keys.remove(key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_shard</span>(<span class="params">self, data_key</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.ring:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        hash_key = <span class="variable language_">self</span>.hash_function(data_key)</span><br><span class="line">        idx = bisect.bisect_right(<span class="variable language_">self</span>.sorted_keys, hash_key)</span><br><span class="line">        <span class="keyword">if</span> idx == <span class="built_in">len</span>(<span class="variable language_">self</span>.sorted_keys):</span><br><span class="line">            idx = <span class="number">0</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.ring[<span class="variable language_">self</span>.sorted_keys[idx]]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_affected_keys_for_new_shard</span>(<span class="params">self, new_shard_id</span>):</span><br><span class="line">        <span class="comment"># Determine which keys need to be moved to new shard</span></span><br><span class="line">        old_ring = <span class="variable language_">self</span>.ring.copy()</span><br><span class="line">        old_sorted_keys = <span class="variable language_">self</span>.sorted_keys.copy()</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.add_shard(new_shard_id)</span><br><span class="line">        </span><br><span class="line">        affected_keys = []</span><br><span class="line">        <span class="comment"># Sample key space to find affected ranges</span></span><br><span class="line">        <span class="keyword">for</span> sample_key <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">2</span>**<span class="number">32</span>, <span class="number">1000</span>):  <span class="comment"># Sample every 1000</span></span><br><span class="line">            old_shard = <span class="variable language_">self</span>._get_shard_from_ring(sample_key, old_ring, old_sorted_keys)</span><br><span class="line">            new_shard = <span class="variable language_">self</span>.get_shard(sample_key)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> old_shard != new_shard <span class="keyword">and</span> new_shard == new_shard_id:</span><br><span class="line">                affected_keys.append(sample_key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> affected_keys</span><br></pre></td></tr></table></figure>

<p><strong>Q: “How do you handle foreign key relationships in a sharded environment?”</strong></p>
<p><strong>A:</strong> Foreign key relationships require special handling in sharded systems:</p>
<ol>
<li><strong>Co-location Strategy</strong>: Keep related data in the same shard</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Both users and orders use user_id as shard key</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    user_id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">255</span>)</span><br><span class="line">) SHARD <span class="keyword">BY</span> user_id;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders (</span><br><span class="line">    order_id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    user_id <span class="type">INT</span>,  <span class="comment">-- Foreign key, same shard key</span></span><br><span class="line">    total_amount <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">    <span class="keyword">FOREIGN KEY</span> (user_id) <span class="keyword">REFERENCES</span> users(user_id)</span><br><span class="line">) SHARD <span class="keyword">BY</span> user_id;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>Denormalization Approach</strong>: Duplicate reference data</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Instead of foreign key to products table</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> order_items (</span><br><span class="line">    item_id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    order_id <span class="type">INT</span>,</span><br><span class="line">    product_id <span class="type">INT</span>,</span><br><span class="line">    <span class="comment">-- Denormalized product data</span></span><br><span class="line">    product_name <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">    product_price <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">    user_id <span class="type">INT</span>  <span class="comment">-- Shard key</span></span><br><span class="line">) SHARD <span class="keyword">BY</span> user_id;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>Application-Level Referential Integrity</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ShardedReferentialIntegrity</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_order_with_items</span>(<span class="params">self, user_id, order_data, items_data</span>):</span><br><span class="line">        <span class="comment"># Validate references before creating</span></span><br><span class="line">        <span class="variable language_">self</span>.validate_user_exists(user_id)</span><br><span class="line">        <span class="variable language_">self</span>.validate_products_exist([item[<span class="string">&#x27;product_id&#x27;</span>] <span class="keyword">for</span> item <span class="keyword">in</span> items_data])</span><br><span class="line">        </span><br><span class="line">        shard = <span class="variable language_">self</span>.get_shard(user_id)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            shard.begin_transaction()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Create order</span></span><br><span class="line">            order_id = shard.insert_order(order_data)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Create order items with denormalized product data</span></span><br><span class="line">            <span class="keyword">for</span> item <span class="keyword">in</span> items_data:</span><br><span class="line">                product_info = <span class="variable language_">self</span>.get_product_info(item[<span class="string">&#x27;product_id&#x27;</span>])</span><br><span class="line">                item_data = &#123;</span><br><span class="line">                    **item,</span><br><span class="line">                    <span class="string">&#x27;order_id&#x27;</span>: order_id,</span><br><span class="line">                    <span class="string">&#x27;product_name&#x27;</span>: product_info[<span class="string">&#x27;name&#x27;</span>],</span><br><span class="line">                    <span class="string">&#x27;product_price&#x27;</span>: product_info[<span class="string">&#x27;price&#x27;</span>]</span><br><span class="line">                &#125;</span><br><span class="line">                shard.insert_order_item(item_data)</span><br><span class="line">            </span><br><span class="line">            shard.commit()</span><br><span class="line">            <span class="keyword">return</span> order_id</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            shard.rollback()</span><br><span class="line">            <span class="keyword">raise</span> e</span><br></pre></td></tr></table></figure>

<p><strong>Q: “Describe your approach to handling eventual consistency in a sharded system.”</strong></p>
<p><strong>A:</strong> Eventual consistency management requires multiple strategies:</p>
<ol>
<li><strong>Event-Driven Architecture</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">EventDrivenConsistency</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.event_bus = EventBus()</span><br><span class="line">        <span class="variable language_">self</span>.event_handlers = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">publish_user_update</span>(<span class="params">self, user_id, updated_fields</span>):</span><br><span class="line">        event = &#123;</span><br><span class="line">            <span class="string">&#x27;event_type&#x27;</span>: <span class="string">&#x27;user_updated&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;user_id&#x27;</span>: user_id,</span><br><span class="line">            <span class="string">&#x27;fields&#x27;</span>: updated_fields,</span><br><span class="line">            <span class="string">&#x27;timestamp&#x27;</span>: time.time(),</span><br><span class="line">            <span class="string">&#x27;event_id&#x27;</span>: uuid.uuid4()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">self</span>.event_bus.publish(<span class="string">&#x27;user_events&#x27;</span>, event)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">handle_user_update</span>(<span class="params">self, event</span>):</span><br><span class="line">        <span class="comment"># Update denormalized user data across relevant shards</span></span><br><span class="line">        affected_shards = <span class="variable language_">self</span>.find_shards_with_user_data(event[<span class="string">&#x27;user_id&#x27;</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> shard_id <span class="keyword">in</span> affected_shards:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="variable language_">self</span>.update_denormalized_user_data(shard_id, event)</span><br><span class="line">                <span class="variable language_">self</span>.mark_event_processed(shard_id, event[<span class="string">&#x27;event_id&#x27;</span>])</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="comment"># Retry mechanism for failed updates</span></span><br><span class="line">                <span class="variable language_">self</span>.schedule_retry(shard_id, event, delay=<span class="number">60</span>)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>Read-After-Write Consistency</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ReadAfterWriteConsistency</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.write_cache = &#123;&#125;  <span class="comment"># Track recent writes per user</span></span><br><span class="line">        <span class="variable language_">self</span>.cache_ttl = <span class="number">300</span>   <span class="comment"># 5 minutes</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">write_user_data</span>(<span class="params">self, user_id, data</span>):</span><br><span class="line">        shard = <span class="variable language_">self</span>.get_shard(user_id)</span><br><span class="line">        result = shard.update_user(user_id, data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Cache the write for read consistency</span></span><br><span class="line">        <span class="variable language_">self</span>.write_cache[user_id] = &#123;</span><br><span class="line">            <span class="string">&#x27;data&#x27;</span>: data,</span><br><span class="line">            <span class="string">&#x27;timestamp&#x27;</span>: time.time(),</span><br><span class="line">            <span class="string">&#x27;version&#x27;</span>: result.version</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read_user_data</span>(<span class="params">self, user_id</span>):</span><br><span class="line">        <span class="comment"># Check if we have recent write data</span></span><br><span class="line">        <span class="keyword">if</span> user_id <span class="keyword">in</span> <span class="variable language_">self</span>.write_cache:</span><br><span class="line">            cache_entry = <span class="variable language_">self</span>.write_cache[user_id]</span><br><span class="line">            <span class="keyword">if</span> time.time() - cache_entry[<span class="string">&#x27;timestamp&#x27;</span>] &lt; <span class="variable language_">self</span>.cache_ttl:</span><br><span class="line">                <span class="keyword">return</span> cache_entry[<span class="string">&#x27;data&#x27;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Read from appropriate shard</span></span><br><span class="line">        shard = <span class="variable language_">self</span>.get_shard(user_id)</span><br><span class="line">        <span class="keyword">return</span> shard.get_user(user_id)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>Saga Pattern for Distributed Transactions</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SagaOrchestrator</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.saga_store = SagaStateStore()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute_cross_shard_operation</span>(<span class="params">self, saga_id, steps</span>):</span><br><span class="line">        saga_state = &#123;</span><br><span class="line">            <span class="string">&#x27;saga_id&#x27;</span>: saga_id,</span><br><span class="line">            <span class="string">&#x27;steps&#x27;</span>: steps,</span><br><span class="line">            <span class="string">&#x27;completed_steps&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;status&#x27;</span>: <span class="string">&#x27;running&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.saga_store.save_saga_state(saga_state)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">for</span> step_index, step <span class="keyword">in</span> <span class="built_in">enumerate</span>(steps):</span><br><span class="line">                <span class="variable language_">self</span>.execute_step(saga_id, step_index, step)</span><br><span class="line">                saga_state[<span class="string">&#x27;completed_steps&#x27;</span>].append(step_index)</span><br><span class="line">                <span class="variable language_">self</span>.saga_store.update_saga_state(saga_state)</span><br><span class="line">            </span><br><span class="line">            saga_state[<span class="string">&#x27;status&#x27;</span>] = <span class="string">&#x27;completed&#x27;</span></span><br><span class="line">            <span class="variable language_">self</span>.saga_store.update_saga_state(saga_state)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># Compensate completed steps</span></span><br><span class="line">            <span class="variable language_">self</span>.compensate_saga(saga_id, saga_state[<span class="string">&#x27;completed_steps&#x27;</span>])</span><br><span class="line">            saga_state[<span class="string">&#x27;status&#x27;</span>] = <span class="string">&#x27;compensated&#x27;</span></span><br><span class="line">            <span class="variable language_">self</span>.saga_store.update_saga_state(saga_state)</span><br><span class="line">            <span class="keyword">raise</span> e</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">compensate_saga</span>(<span class="params">self, saga_id, completed_steps</span>):</span><br><span class="line">        <span class="keyword">for</span> step_index <span class="keyword">in</span> <span class="built_in">reversed</span>(completed_steps):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="variable language_">self</span>.execute_compensation(saga_id, step_index)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="comment"># Log compensation failure - may need manual intervention</span></span><br><span class="line">                <span class="variable language_">self</span>.log_compensation_failure(saga_id, step_index, e)</span><br></pre></td></tr></table></figure>

<h3 id="Advanced-Sharding-Patterns"><a href="#Advanced-Sharding-Patterns" class="headerlink" title="Advanced Sharding Patterns"></a>Advanced Sharding Patterns</h3><p><strong>Q: “How would you implement multi-tenant sharding where each tenant’s data needs to be isolated?”</strong></p>
<p><strong>A:</strong> Multi-tenant sharding requires additional isolation considerations:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MultiTenantShardManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.tenant_shard_mapping = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.shard_tenant_mapping = defaultdict(<span class="built_in">set</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">assign_tenant_to_shard</span>(<span class="params">self, tenant_id, shard_preference=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="keyword">if</span> shard_preference <span class="keyword">and</span> <span class="variable language_">self</span>.has_capacity(shard_preference):</span><br><span class="line">            assigned_shard = shard_preference</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            assigned_shard = <span class="variable language_">self</span>.find_optimal_shard(tenant_id)</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.tenant_shard_mapping[tenant_id] = assigned_shard</span><br><span class="line">        <span class="variable language_">self</span>.shard_tenant_mapping[assigned_shard].add(tenant_id)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Create tenant-specific database/schema</span></span><br><span class="line">        <span class="variable language_">self</span>.create_tenant_schema(assigned_shard, tenant_id)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> assigned_shard</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_tenant_connection</span>(<span class="params">self, tenant_id</span>):</span><br><span class="line">        shard_id = <span class="variable language_">self</span>.tenant_shard_mapping.get(tenant_id)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> shard_id:</span><br><span class="line">            <span class="keyword">raise</span> TenantNotFoundError(<span class="string">f&quot;Tenant <span class="subst">&#123;tenant_id&#125;</span> not assigned to any shard&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Return connection with tenant context</span></span><br><span class="line">        conn = <span class="variable language_">self</span>.get_shard_connection(shard_id)</span><br><span class="line">        conn.execute(<span class="string">f&quot;USE tenant_<span class="subst">&#123;tenant_id&#125;</span>_db&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> conn</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">migrate_tenant</span>(<span class="params">self, tenant_id, target_shard</span>):</span><br><span class="line">        source_shard = <span class="variable language_">self</span>.tenant_shard_mapping[tenant_id]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 1. Create tenant schema on target shard</span></span><br><span class="line">        <span class="variable language_">self</span>.create_tenant_schema(target_shard, tenant_id)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. Copy tenant data</span></span><br><span class="line">        <span class="variable language_">self</span>.copy_tenant_data(source_shard, target_shard, tenant_id)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. Enable dual-write mode</span></span><br><span class="line">        <span class="variable language_">self</span>.enable_dual_write(tenant_id, source_shard, target_shard)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 4. Switch reads to target shard</span></span><br><span class="line">        <span class="variable language_">self</span>.tenant_shard_mapping[tenant_id] = target_shard</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 5. Verify consistency and cleanup</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.verify_tenant_data_consistency(tenant_id, source_shard, target_shard):</span><br><span class="line">            <span class="variable language_">self</span>.cleanup_tenant_data(source_shard, tenant_id)</span><br><span class="line">            <span class="variable language_">self</span>.shard_tenant_mapping[source_shard].remove(tenant_id)</span><br><span class="line">            <span class="variable language_">self</span>.shard_tenant_mapping[target_shard].add(tenant_id)</span><br></pre></td></tr></table></figure>

<p><strong>Multi-tenant Schema Patterns:</strong></p>
<ol>
<li><strong>Schema-per-Tenant</strong></li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Each tenant gets their own database schema</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE tenant_123_db;</span><br><span class="line">USE tenant_123_db;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    user_id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">255</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders (</span><br><span class="line">    order_id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    user_id <span class="type">INT</span>,</span><br><span class="line">    total_amount <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>Shared Schema with Tenant ID</strong></li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Shared tables with tenant_id column</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    tenant_id <span class="type">INT</span>,</span><br><span class="line">    user_id <span class="type">INT</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (tenant_id, user_id),</span><br><span class="line">    INDEX idx_tenant_users (tenant_id)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Row-level security policies</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> tenant_users <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> user_id, name, email</span><br><span class="line"><span class="keyword">FROM</span> users</span><br><span class="line"><span class="keyword">WHERE</span> tenant_id <span class="operator">=</span> GET_CURRENT_TENANT_ID();</span><br></pre></td></tr></table></figure>

<h3 id="Performance-Optimization-Strategies"><a href="#Performance-Optimization-Strategies" class="headerlink" title="Performance Optimization Strategies"></a>Performance Optimization Strategies</h3><p><strong>Q: “How do you optimize query performance across shards?”</strong></p>
<p><strong>A:</strong> Multi-faceted approach to query optimization:</p>
<ol>
<li><strong>Query Routing Optimization</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">QueryOptimizer</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.query_stats = QueryStatistics()</span><br><span class="line">        <span class="variable language_">self</span>.shard_metadata = ShardMetadata()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">optimize_query_plan</span>(<span class="params">self, query, params</span>):</span><br><span class="line">        <span class="comment"># Analyze query to determine optimal execution strategy</span></span><br><span class="line">        query_analysis = <span class="variable language_">self</span>.analyze_query(query)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> query_analysis.is_single_shard_query():</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.execute_single_shard(query, params)</span><br><span class="line">        <span class="keyword">elif</span> query_analysis.can_be_parallelized():</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.execute_parallel_query(query, params)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.execute_sequential_query(query, params)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute_parallel_query</span>(<span class="params">self, query, params</span>):</span><br><span class="line">        <span class="comment"># Execute query on multiple shards concurrently</span></span><br><span class="line">        <span class="keyword">with</span> ThreadPoolExecutor(max_workers=<span class="built_in">len</span>(<span class="variable language_">self</span>.shards)) <span class="keyword">as</span> executor:</span><br><span class="line">            futures = []</span><br><span class="line">            <span class="keyword">for</span> shard_id <span class="keyword">in</span> <span class="variable language_">self</span>.get_relevant_shards(query):</span><br><span class="line">                future = executor.submit(<span class="variable language_">self</span>.execute_on_shard, shard_id, query, params)</span><br><span class="line">                futures.append((shard_id, future))</span><br><span class="line">            </span><br><span class="line">            results = []</span><br><span class="line">            <span class="keyword">for</span> shard_id, future <span class="keyword">in</span> futures:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    result = future.result(timeout=<span class="number">30</span>)  <span class="comment"># 30 second timeout</span></span><br><span class="line">                    results.append((shard_id, result))</span><br><span class="line">                <span class="keyword">except</span> TimeoutError:</span><br><span class="line">                    <span class="variable language_">self</span>.log_slow_shard_query(shard_id, query)</span><br><span class="line">                    <span class="comment"># Continue without this shard&#x27;s results</span></span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.merge_shard_results(results)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>Intelligent Caching</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ShardedCacheManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.local_cache = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.distributed_cache = RedisCluster()</span><br><span class="line">        <span class="variable language_">self</span>.cache_stats = CacheStatistics()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_with_cache</span>(<span class="params">self, cache_key, query_func, ttl=<span class="number">3600</span></span>):</span><br><span class="line">        <span class="comment"># L1: Local cache</span></span><br><span class="line">        <span class="keyword">if</span> cache_key <span class="keyword">in</span> <span class="variable language_">self</span>.local_cache:</span><br><span class="line">            <span class="variable language_">self</span>.cache_stats.record_hit(<span class="string">&#x27;local&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.local_cache[cache_key]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># L2: Distributed cache</span></span><br><span class="line">        cached_value = <span class="variable language_">self</span>.distributed_cache.get(cache_key)</span><br><span class="line">        <span class="keyword">if</span> cached_value:</span><br><span class="line">            <span class="variable language_">self</span>.cache_stats.record_hit(<span class="string">&#x27;distributed&#x27;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.local_cache[cache_key] = cached_value</span><br><span class="line">            <span class="keyword">return</span> cached_value</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># L3: Database query</span></span><br><span class="line">        <span class="variable language_">self</span>.cache_stats.record_miss()</span><br><span class="line">        value = query_func()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Cache the result</span></span><br><span class="line">        <span class="variable language_">self</span>.distributed_cache.setex(cache_key, ttl, value)</span><br><span class="line">        <span class="variable language_">self</span>.local_cache[cache_key] = value</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">invalidate_pattern</span>(<span class="params">self, pattern</span>):</span><br><span class="line">        <span class="comment"># Invalidate cache entries matching pattern</span></span><br><span class="line">        keys_to_delete = <span class="variable language_">self</span>.distributed_cache.keys(pattern)</span><br><span class="line">        <span class="keyword">if</span> keys_to_delete:</span><br><span class="line">            <span class="variable language_">self</span>.distributed_cache.delete(*keys_to_delete)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Clear local cache entries</span></span><br><span class="line">        local_keys_to_delete = [k <span class="keyword">for</span> k <span class="keyword">in</span> <span class="variable language_">self</span>.local_cache.keys() <span class="keyword">if</span> fnmatch.fnmatch(k, pattern)]</span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> local_keys_to_delete:</span><br><span class="line">            <span class="keyword">del</span> <span class="variable language_">self</span>.local_cache[key]</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>Connection Pool Optimization</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">OptimizedConnectionPool</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, shard_configs</span>):</span><br><span class="line">        <span class="variable language_">self</span>.pools = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.pool_stats = defaultdict(<span class="keyword">lambda</span>: &#123;<span class="string">&#x27;active&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;idle&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;wait_time&#x27;</span>: <span class="number">0</span>&#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> shard_id, config <span class="keyword">in</span> shard_configs.items():</span><br><span class="line">            <span class="variable language_">self</span>.pools[shard_id] = <span class="variable language_">self</span>.create_optimized_pool(shard_id, config)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_optimized_pool</span>(<span class="params">self, shard_id, config</span>):</span><br><span class="line">        <span class="comment"># Dynamic pool sizing based on shard load</span></span><br><span class="line">        base_size = config.get(<span class="string">&#x27;base_pool_size&#x27;</span>, <span class="number">10</span>)</span><br><span class="line">        max_size = config.get(<span class="string">&#x27;max_pool_size&#x27;</span>, <span class="number">50</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Adjust pool size based on historical usage</span></span><br><span class="line">        avg_concurrent_queries = <span class="variable language_">self</span>.get_avg_concurrent_queries(shard_id)</span><br><span class="line">        optimal_size = <span class="built_in">min</span>(max_size, <span class="built_in">max</span>(base_size, <span class="built_in">int</span>(avg_concurrent_queries * <span class="number">1.2</span>)))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> mysql.connector.pooling.MySQLConnectionPool(</span><br><span class="line">            pool_name=<span class="string">f&quot;optimized_shard_<span class="subst">&#123;shard_id&#125;</span>&quot;</span>,</span><br><span class="line">            pool_size=optimal_size,</span><br><span class="line">            pool_reset_session=<span class="literal">True</span>,</span><br><span class="line">            autocommit=<span class="literal">True</span>,</span><br><span class="line">            **config[<span class="string">&#x27;connection_params&#x27;</span>]</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_connection_with_monitoring</span>(<span class="params">self, shard_id</span>):</span><br><span class="line">        start_time = time.time()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            conn = <span class="variable language_">self</span>.pools[shard_id].get_connection()</span><br><span class="line">            wait_time = time.time() - start_time</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">self</span>.pool_stats[shard_id][<span class="string">&#x27;wait_time&#x27;</span>] += wait_time</span><br><span class="line">            <span class="variable language_">self</span>.pool_stats[shard_id][<span class="string">&#x27;active&#x27;</span>] += <span class="number">1</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> ConnectionWrapper(conn, shard_id, <span class="variable language_">self</span>.pool_stats)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> mysql.connector.pooling.PoolError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># Pool exhausted - consider scaling up</span></span><br><span class="line">            <span class="variable language_">self</span>.alert_pool_exhaustion(shard_id)</span><br><span class="line">            <span class="keyword">raise</span> e</span><br></pre></td></tr></table></figure>

<h3 id="Disaster-Recovery-and-High-Availability"><a href="#Disaster-Recovery-and-High-Availability" class="headerlink" title="Disaster Recovery and High Availability"></a>Disaster Recovery and High Availability</h3><p><strong>Q: “How do you design disaster recovery for a sharded MySQL environment?”</strong></p>
<p><strong>A:</strong> Comprehensive disaster recovery strategy:</p>
<ol>
<li><strong>Multi-Region Shard Replication</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DisasterRecoveryManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.primary_region = <span class="string">&quot;us-east-1&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.backup_regions = [<span class="string">&quot;us-west-2&quot;</span>, <span class="string">&quot;eu-west-1&quot;</span>]</span><br><span class="line">        <span class="variable language_">self</span>.replication_lag_threshold = <span class="number">5</span>  <span class="comment"># seconds</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setup_cross_region_replication</span>(<span class="params">self, shard_id</span>):</span><br><span class="line">        primary_shard = <span class="variable language_">self</span>.get_shard(<span class="variable language_">self</span>.primary_region, shard_id)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> backup_region <span class="keyword">in</span> <span class="variable language_">self</span>.backup_regions:</span><br><span class="line">            backup_shard = <span class="variable language_">self</span>.get_shard(backup_region, shard_id)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Configure MySQL replication</span></span><br><span class="line">            <span class="variable language_">self</span>.configure_replication(</span><br><span class="line">                master=primary_shard,</span><br><span class="line">                slave=backup_shard,</span><br><span class="line">                replication_mode=<span class="string">&#x27;GTID&#x27;</span></span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Monitor replication health</span></span><br><span class="line">            <span class="variable language_">self</span>.monitor_replication_lag(primary_shard, backup_shard)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">failover_to_backup_region</span>(<span class="params">self, failed_region, backup_region</span>):</span><br><span class="line">        affected_shards = <span class="variable language_">self</span>.get_shards_in_region(failed_region)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> shard_id <span class="keyword">in</span> affected_shards:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># Promote backup shard to primary</span></span><br><span class="line">                backup_shard = <span class="variable language_">self</span>.get_shard(backup_region, shard_id)</span><br><span class="line">                <span class="variable language_">self</span>.promote_to_primary(backup_shard)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># Update shard routing</span></span><br><span class="line">                <span class="variable language_">self</span>.update_shard_routing(shard_id, backup_region)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># Notify applications of failover</span></span><br><span class="line">                <span class="variable language_">self</span>.notify_failover(shard_id, failed_region, backup_region)</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="variable language_">self</span>.log_failover_error(shard_id, e)</span><br><span class="line">                <span class="comment"># Continue with other shards</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>Automated Backup Strategy</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ShardBackupManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.backup_schedule = BackupScheduler()</span><br><span class="line">        <span class="variable language_">self</span>.storage_backends = &#123;</span><br><span class="line">            <span class="string">&#x27;local&#x27;</span>: LocalStorage(<span class="string">&#x27;/backups&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;s3&#x27;</span>: S3Storage(<span class="string">&#x27;db-backups-bucket&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;gcs&#x27;</span>: GCSStorage(<span class="string">&#x27;db-backups-bucket&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_consistent_backup</span>(<span class="params">self, shard_id</span>):</span><br><span class="line">        shard = <span class="variable language_">self</span>.get_shard(shard_id)</span><br><span class="line">        timestamp = datetime.now().strftime(<span class="string">&#x27;%Y%m%d_%H%M%S&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Create consistent point-in-time backup</span></span><br><span class="line">        backup_info = &#123;</span><br><span class="line">            <span class="string">&#x27;shard_id&#x27;</span>: shard_id,</span><br><span class="line">            <span class="string">&#x27;timestamp&#x27;</span>: timestamp,</span><br><span class="line">            <span class="string">&#x27;gtid_position&#x27;</span>: shard.get_gtid_position(),</span><br><span class="line">            <span class="string">&#x27;binlog_position&#x27;</span>: shard.get_binlog_position()</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Physical backup using Percona XtraBackup</span></span><br><span class="line">        backup_path = <span class="string">f&quot;/tmp/backup_<span class="subst">&#123;shard_id&#125;</span>_<span class="subst">&#123;timestamp&#125;</span>&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.execute_xtrabackup(shard, backup_path)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Upload to multiple storage backends</span></span><br><span class="line">        <span class="keyword">for</span> storage_name, storage <span class="keyword">in</span> <span class="variable language_">self</span>.storage_backends.items():</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                storage.upload(backup_path, <span class="string">f&quot;shard_<span class="subst">&#123;shard_id&#125;</span>/<span class="subst">&#123;timestamp&#125;</span>&quot;</span>)</span><br><span class="line">                backup_info[<span class="string">f&#x27;<span class="subst">&#123;storage_name&#125;</span>_uploaded&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="variable language_">self</span>.log_backup_upload_error(storage_name, shard_id, e)</span><br><span class="line">                backup_info[<span class="string">f&#x27;<span class="subst">&#123;storage_name&#125;</span>_uploaded&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Store backup metadata</span></span><br><span class="line">        <span class="variable language_">self</span>.store_backup_metadata(backup_info)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> backup_info</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">restore_from_backup</span>(<span class="params">self, shard_id, target_timestamp, target_shard=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="comment"># Find appropriate backup</span></span><br><span class="line">        backup_info = <span class="variable language_">self</span>.find_backup_before_timestamp(shard_id, target_timestamp)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> backup_info:</span><br><span class="line">            <span class="keyword">raise</span> BackupNotFoundError(<span class="string">f&quot;No backup found for shard <span class="subst">&#123;shard_id&#125;</span> before <span class="subst">&#123;target_timestamp&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        target_shard = target_shard <span class="keyword">or</span> <span class="variable language_">self</span>.get_shard(shard_id)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Download and restore backup</span></span><br><span class="line">        backup_path = <span class="variable language_">self</span>.download_backup(backup_info)</span><br><span class="line">        <span class="variable language_">self</span>.restore_xtrabackup(target_shard, backup_path)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Apply point-in-time recovery if needed</span></span><br><span class="line">        <span class="keyword">if</span> target_timestamp &gt; backup_info[<span class="string">&#x27;timestamp&#x27;</span>]:</span><br><span class="line">            <span class="variable language_">self</span>.apply_binlog_recovery(</span><br><span class="line">                target_shard, </span><br><span class="line">                backup_info[<span class="string">&#x27;binlog_position&#x27;</span>],</span><br><span class="line">                target_timestamp</span><br><span class="line">            )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>

<h3 id="Security-Considerations"><a href="#Security-Considerations" class="headerlink" title="Security Considerations"></a>Security Considerations</h3><p><strong>Q: “What security measures should be implemented in a sharded MySQL environment?”</strong></p>
<p><strong>A:</strong> Multi-layered security approach:</p>
<ol>
<li><strong>Network Security</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ShardSecurityManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.vpc_config = VPCConfiguration()</span><br><span class="line">        <span class="variable language_">self</span>.firewall_rules = FirewallManager()</span><br><span class="line">        <span class="variable language_">self</span>.encryption_manager = EncryptionManager()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setup_network_security</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># VPC configuration for shard isolation</span></span><br><span class="line">        <span class="keyword">for</span> region <span class="keyword">in</span> <span class="variable language_">self</span>.regions:</span><br><span class="line">            vpc = <span class="variable language_">self</span>.vpc_config.create_vpc(</span><br><span class="line">                region=region,</span><br><span class="line">                cidr_block=<span class="string">&quot;10.0.0.0/16&quot;</span>,</span><br><span class="line">                enable_dns_hostnames=<span class="literal">True</span></span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Private subnets for database shards</span></span><br><span class="line">            <span class="keyword">for</span> az_index, availability_zone <span class="keyword">in</span> <span class="built_in">enumerate</span>(<span class="variable language_">self</span>.get_availability_zones(region)):</span><br><span class="line">                subnet = <span class="variable language_">self</span>.vpc_config.create_private_subnet(</span><br><span class="line">                    vpc=vpc,</span><br><span class="line">                    cidr_block=<span class="string">f&quot;10.0.<span class="subst">&#123;az_index + <span class="number">1</span>&#125;</span>.0/24&quot;</span>,</span><br><span class="line">                    availability_zone=availability_zone</span><br><span class="line">                )</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># Security groups for shard access</span></span><br><span class="line">                <span class="variable language_">self</span>.create_shard_security_group(vpc, subnet)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_shard_security_group</span>(<span class="params">self, vpc, subnet</span>):</span><br><span class="line">        security_group = <span class="variable language_">self</span>.firewall_rules.create_security_group(</span><br><span class="line">            name=<span class="string">f&quot;shard-sg-<span class="subst">&#123;subnet.<span class="built_in">id</span>&#125;</span>&quot;</span>,</span><br><span class="line">            vpc=vpc,</span><br><span class="line">            rules=[</span><br><span class="line">                <span class="comment"># MySQL port access only from application tier</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&#x27;protocol&#x27;</span>: <span class="string">&#x27;tcp&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;port&#x27;</span>: <span class="number">3306</span>,</span><br><span class="line">                    <span class="string">&#x27;source&#x27;</span>: <span class="string">&#x27;application-sg&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;description&#x27;</span>: <span class="string">&#x27;MySQL access from application servers&#x27;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="comment"># Replication port for cross-region replication</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&#x27;protocol&#x27;</span>: <span class="string">&#x27;tcp&#x27;</span>, </span><br><span class="line">                    <span class="string">&#x27;port&#x27;</span>: <span class="number">3307</span>,</span><br><span class="line">                    <span class="string">&#x27;source&#x27;</span>: <span class="string">&#x27;replication-sg&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;description&#x27;</span>: <span class="string">&#x27;MySQL replication traffic&#x27;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="comment"># Monitoring access</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&#x27;protocol&#x27;</span>: <span class="string">&#x27;tcp&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;port&#x27;</span>: <span class="number">9104</span>,</span><br><span class="line">                    <span class="string">&#x27;source&#x27;</span>: <span class="string">&#x27;monitoring-sg&#x27;</span>, </span><br><span class="line">                    <span class="string">&#x27;description&#x27;</span>: <span class="string">&#x27;MySQL exporter for monitoring&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> security_group</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>Authentication and Authorization</strong></li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Shard-specific user management</span></span><br><span class="line"><span class="comment">-- Create dedicated users for different access patterns</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Application read-write user</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;app_rw&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;secure_password_123&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>, <span class="keyword">INSERT</span>, <span class="keyword">UPDATE</span>, <span class="keyword">DELETE</span> <span class="keyword">ON</span> shard_db.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;app_rw&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Application read-only user  </span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;app_ro&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;secure_password_456&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> shard_db.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;app_ro&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Replication user</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;repl_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;replication_password_789&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> REPLICATION SLAVE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Monitoring user</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;monitor&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;monitor_password_abc&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> PROCESS, REPLICATION CLIENT, <span class="keyword">SELECT</span> <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;monitor&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Backup user</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;backup&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;backup_password_def&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>, LOCK TABLES, <span class="keyword">SHOW</span> <span class="keyword">VIEW</span>, EVENT, <span class="keyword">TRIGGER</span> <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;backup&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>Encryption Implementation</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ShardEncryptionManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.kms_client = KMSClient()</span><br><span class="line">        <span class="variable language_">self</span>.encryption_keys = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setup_shard_encryption</span>(<span class="params">self, shard_id</span>):</span><br><span class="line">        <span class="comment"># Generate shard-specific encryption key</span></span><br><span class="line">        key_id = <span class="variable language_">self</span>.kms_client.create_key(</span><br><span class="line">            description=<span class="string">f&quot;Encryption key for shard <span class="subst">&#123;shard_id&#125;</span>&quot;</span>,</span><br><span class="line">            key_usage=<span class="string">&#x27;ENCRYPT_DECRYPT&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.encryption_keys[shard_id] = key_id</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Configure MySQL encryption at rest</span></span><br><span class="line">        shard = <span class="variable language_">self</span>.get_shard(shard_id)</span><br><span class="line">        shard.execute(<span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            SET GLOBAL default_table_encryption = ON;</span></span><br><span class="line"><span class="string">            SET GLOBAL table_encryption_privilege_check = ON;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Configure binlog encryption</span></span><br><span class="line">        shard.execute(<span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            SET GLOBAL binlog_encryption = ON;</span></span><br><span class="line"><span class="string">            SET GLOBAL binlog_rotate_encryption_master_key_at_startup = ON;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> key_id</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encrypt_sensitive_data</span>(<span class="params">self, shard_id, data</span>):</span><br><span class="line">        key_id = <span class="variable language_">self</span>.encryption_keys[shard_id]</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.kms_client.encrypt(key_id, data)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decrypt_sensitive_data</span>(<span class="params">self, shard_id, encrypted_data</span>):</span><br><span class="line">        key_id = <span class="variable language_">self</span>.encryption_keys[shard_id]</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.kms_client.decrypt(key_id, encrypted_data)</span><br></pre></td></tr></table></figure>

<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Database sharding is a powerful scaling technique that enables applications to handle massive datasets and high-throughput workloads. However, it introduces significant complexity that must be carefully managed through proper planning, implementation, and operational practices.</p>
<h3 id="Key-Takeaways"><a href="#Key-Takeaways" class="headerlink" title="Key Takeaways"></a>Key Takeaways</h3><p><strong>When to Consider Sharding:</strong></p>
<ul>
<li>Single database performance becomes a bottleneck despite optimization</li>
<li>Data volume exceeds single server capacity</li>
<li>Geographic distribution requirements</li>
<li>Compliance and data locality needs</li>
</ul>
<p><strong>Success Factors:</strong></p>
<ul>
<li>Choose the right sharding strategy for your access patterns</li>
<li>Implement comprehensive monitoring and alerting</li>
<li>Plan for failure scenarios and disaster recovery</li>
<li>Maintain operational expertise in distributed systems</li>
<li>Start simple and evolve complexity gradually</li>
</ul>
<p><strong>Common Pitfalls to Avoid:</strong></p>
<ul>
<li>Premature sharding before exploring alternatives</li>
<li>Poor sharding key selection leading to hotspots</li>
<li>Insufficient testing of failure scenarios</li>
<li>Neglecting operational complexity</li>
<li>Inadequate monitoring and observability</li>
</ul>
<h3 id="Final-Interview-Advice"><a href="#Final-Interview-Advice" class="headerlink" title="Final Interview Advice"></a>Final Interview Advice</h3><p>When discussing sharding in interviews, demonstrate:</p>
<ol>
<li><strong>Understanding of Trade-offs</strong>: Show that you understand sharding is not a silver bullet and comes with significant complexity</li>
<li><strong>Practical Experience</strong>: Discuss real-world challenges you’ve faced and how you solved them</li>
<li><strong>Operational Thinking</strong>: Consider monitoring, maintenance, and disaster recovery from the start</li>
<li><strong>Gradual Approach</strong>: Advocate for incremental adoption rather than big-bang migrations</li>
<li><strong>Alternative Awareness</strong>: Mention other scaling techniques and when they might be more appropriate</li>
</ol>
<p>The key to successful sharding lies not just in the technical implementation, but in the operational discipline and organizational readiness to manage distributed data systems effectively.</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/mysql/" rel="tag"># mysql</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/06/08/MySQL-Buffer-Pool-Complete-Theory-and-Best-Practices-Guide/" rel="prev" title="MySQL Buffer Pool: Complete Theory and Best Practices Guide">
                  <i class="fa fa-angle-left"></i> MySQL Buffer Pool: Complete Theory and Best Practices Guide
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/06/08/MySQL-Distributed-Transactions-2PC-and-SAGA-Patterns/" rel="next" title="MySQL Distributed Transactions: 2PC and SAGA Patterns">
                  MySQL Distributed Transactions: 2PC and SAGA Patterns <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Charlie Feng</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
