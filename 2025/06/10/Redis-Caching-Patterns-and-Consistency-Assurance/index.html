<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"shayne007.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="IntroductionRedis serves as a high-performance in-memory data structure store, commonly used as a cache, database, and message broker. Understanding caching patterns and consistency mechanisms is cruc">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis Caching Patterns and Consistency Assurance">
<meta property="og:url" content="https://shayne007.github.io/2025/06/10/Redis-Caching-Patterns-and-Consistency-Assurance/index.html">
<meta property="og:site_name" content="Charlie Feng&#39;s Tech Space">
<meta property="og:description" content="IntroductionRedis serves as a high-performance in-memory data structure store, commonly used as a cache, database, and message broker. Understanding caching patterns and consistency mechanisms is cruc">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-06-10T10:47:55.000Z">
<meta property="article:modified_time" content="2025-06-11T16:17:42.373Z">
<meta property="article:author" content="Charlie Feng">
<meta property="article:tag" content="redis">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://shayne007.github.io/2025/06/10/Redis-Caching-Patterns-and-Consistency-Assurance/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://shayne007.github.io/2025/06/10/Redis-Caching-Patterns-and-Consistency-Assurance/","path":"2025/06/10/Redis-Caching-Patterns-and-Consistency-Assurance/","title":"Redis Caching Patterns and Consistency Assurance"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Redis Caching Patterns and Consistency Assurance | Charlie Feng's Tech Space</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"cdn":false,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.5.0/mermaid.min.js","integrity":"sha256-2obLuIPcceEhkE3G09G33hBdmE55ivVcZUlcKcGNHjU="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>





  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Charlie Feng's Tech Space</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">You will survive with skills</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Introduction"><span class="nav-number">1.</span> <span class="nav-text">Introduction</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Why-Caching-Matters"><span class="nav-number">1.1.</span> <span class="nav-text">Why Caching Matters</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Key-Benefits-of-Redis-Caching"><span class="nav-number">1.2.</span> <span class="nav-text">Key Benefits of Redis Caching</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Core-Caching-Patterns"><span class="nav-number">2.</span> <span class="nav-text">Core Caching Patterns</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Cache-Aside-Lazy-Loading"><span class="nav-number">2.1.</span> <span class="nav-text">1. Cache-Aside (Lazy Loading)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Write-Through"><span class="nav-number">2.2.</span> <span class="nav-text">2. Write-Through</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Write-Behind-Write-Back"><span class="nav-number">2.3.</span> <span class="nav-text">3. Write-Behind (Write-Back)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-Refresh-Ahead"><span class="nav-number">2.4.</span> <span class="nav-text">4. Refresh-Ahead</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Consistency-Models-and-Strategies"><span class="nav-number">3.</span> <span class="nav-text">Consistency Models and Strategies</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Strong-Consistency-with-Distributed-Locks"><span class="nav-number">3.1.</span> <span class="nav-text">1. Strong Consistency with Distributed Locks</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Eventual-Consistency"><span class="nav-number">3.2.</span> <span class="nav-text">2. Eventual Consistency</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Read-Your-Writes-Consistency"><span class="nav-number">3.3.</span> <span class="nav-text">3. Read-Your-Writes Consistency</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Advanced-Patterns"><span class="nav-number">4.</span> <span class="nav-text">Advanced Patterns</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Cache-Warming"><span class="nav-number">4.1.</span> <span class="nav-text">1. Cache Warming</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Multi-Level-Caching"><span class="nav-number">4.2.</span> <span class="nav-text">2. Multi-Level Caching</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Data-Invalidation-Strategies"><span class="nav-number">5.</span> <span class="nav-text">Data Invalidation Strategies</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-TTL-Based-Expiration"><span class="nav-number">5.1.</span> <span class="nav-text">1. TTL-Based Expiration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Event-Driven-Invalidation"><span class="nav-number">5.2.</span> <span class="nav-text">2. Event-Driven Invalidation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Cache-Tags-and-Dependencies"><span class="nav-number">5.3.</span> <span class="nav-text">3. Cache Tags and Dependencies</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Performance-Optimization"><span class="nav-number">6.</span> <span class="nav-text">Performance Optimization</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Connection-Pooling-and-Pipelining"><span class="nav-number">6.1.</span> <span class="nav-text">1. Connection Pooling and Pipelining</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Memory-Optimization"><span class="nav-number">6.2.</span> <span class="nav-text">2. Memory Optimization</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Hot-Key-Detection-and-Mitigation"><span class="nav-number">6.3.</span> <span class="nav-text">3. Hot Key Detection and Mitigation</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Monitoring-and-Troubleshooting"><span class="nav-number">7.</span> <span class="nav-text">Monitoring and Troubleshooting</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Performance-Monitoring"><span class="nav-number">7.1.</span> <span class="nav-text">1. Performance Monitoring</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Advanced-Debugging-and-Profiling"><span class="nav-number">7.2.</span> <span class="nav-text">2. Advanced Debugging and Profiling</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Production-Best-Practices"><span class="nav-number">8.</span> <span class="nav-text">Production Best Practices</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-High-Availability-Setup"><span class="nav-number">8.1.</span> <span class="nav-text">1. High Availability Setup</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Security-Best-Practices"><span class="nav-number">8.2.</span> <span class="nav-text">2. Security Best Practices</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Operational-Excellence"><span class="nav-number">8.3.</span> <span class="nav-text">3. Operational Excellence</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Charlie Feng</p>
  <div class="site-description" itemprop="description">This place is for thinking and sharing.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">26</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/10/Redis-Caching-Patterns-and-Consistency-Assurance/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Redis Caching Patterns and Consistency Assurance | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Redis Caching Patterns and Consistency Assurance
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-10 18:47:55" itemprop="dateCreated datePublished" datetime="2025-06-10T18:47:55+08:00">2025-06-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-12 00:17:42" itemprop="dateModified" datetime="2025-06-12T00:17:42+08:00">2025-06-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Redis serves as a high-performance in-memory data structure store, commonly used as a cache, database, and message broker. Understanding caching patterns and consistency mechanisms is crucial for building scalable, reliable systems.</p>
<p><strong>🎯 Interview Insight</strong>: <em>Interviewers often ask about the trade-offs between performance and consistency. Be prepared to discuss CAP theorem implications and when to choose eventual consistency over strong consistency.</em></p>
<h3 id="Why-Caching-Matters"><a href="#Why-Caching-Matters" class="headerlink" title="Why Caching Matters"></a>Why Caching Matters</h3><ul>
<li><strong>Reduced Latency</strong>: Sub-millisecond response times for cached data</li>
<li><strong>Decreased Database Load</strong>: Offloads read operations from primary databases</li>
<li><strong>Improved Scalability</strong>: Handles higher concurrent requests</li>
<li><strong>Cost Efficiency</strong>: Reduces expensive database operations</li>
<li></li>
</ul>
<h3 id="Key-Benefits-of-Redis-Caching"><a href="#Key-Benefits-of-Redis-Caching" class="headerlink" title="Key Benefits of Redis Caching"></a>Key Benefits of Redis Caching</h3><ul>
<li><strong>Performance</strong>: Sub-millisecond latency for most operations</li>
<li><strong>Scalability</strong>: Handles millions of requests per second</li>
<li><strong>Flexibility</strong>: Rich data structures (strings, hashes, lists, sets, sorted sets)</li>
<li><strong>Persistence</strong>: Optional durability with RDB&#x2F;AOF</li>
<li><strong>High Availability</strong>: Redis Sentinel and Cluster support</li>
</ul>
<h2 id="Core-Caching-Patterns"><a href="#Core-Caching-Patterns" class="headerlink" title="Core Caching Patterns"></a>Core Caching Patterns</h2><h3 id="1-Cache-Aside-Lazy-Loading"><a href="#1-Cache-Aside-Lazy-Loading" class="headerlink" title="1. Cache-Aside (Lazy Loading)"></a>1. Cache-Aside (Lazy Loading)</h3><p>The application manages the cache directly, loading data on cache misses.</p>
<pre>
<code class="mermaid">
sequenceDiagram
participant App as Application
participant Cache as Redis Cache
participant DB as Database

App-&gt;&gt;Cache: GET user:123
Cache--&gt;&gt;App: Cache Miss (null)
App-&gt;&gt;DB: SELECT * FROM users WHERE id&#x3D;123
DB--&gt;&gt;App: User data
App-&gt;&gt;Cache: SET user:123 {user_data} EX 3600
Cache--&gt;&gt;App: OK
App--&gt;&gt;App: Return user data
</code>
</pre>

<p><strong>Implementation Example:</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CacheAsidePattern</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.cache_ttl = <span class="number">3600</span>  <span class="comment"># 1 hour</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">self, user_id</span>):</span><br><span class="line">        cache_key = <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Try cache first</span></span><br><span class="line">        cached_data = <span class="variable language_">self</span>.redis_client.get(cache_key)</span><br><span class="line">        <span class="keyword">if</span> cached_data:</span><br><span class="line">            <span class="keyword">return</span> json.loads(cached_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Cache miss - fetch from database</span></span><br><span class="line">        user_data = <span class="variable language_">self</span>.fetch_user_from_db(user_id)</span><br><span class="line">        <span class="keyword">if</span> user_data:</span><br><span class="line">            <span class="comment"># Store in cache with TTL</span></span><br><span class="line">            <span class="variable language_">self</span>.redis_client.setex(</span><br><span class="line">                cache_key, </span><br><span class="line">                <span class="variable language_">self</span>.cache_ttl, </span><br><span class="line">                json.dumps(user_data)</span><br><span class="line">            )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> user_data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update_user</span>(<span class="params">self, user_id, user_data</span>):</span><br><span class="line">        <span class="comment"># Update database</span></span><br><span class="line">        <span class="variable language_">self</span>.update_user_in_db(user_id, user_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Invalidate cache</span></span><br><span class="line">        cache_key = <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.redis_client.delete(cache_key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> user_data</span><br></pre></td></tr></table></figure>
<p><strong>Pros:</strong></p>
<ul>
<li>Simple to implement and understand</li>
<li>Cache only contains requested data</li>
<li>Resilient to cache failures</li>
</ul>
<p><strong>Cons:</strong></p>
<ul>
<li>Cache miss penalty (extra database call)</li>
<li>Potential cache stampede issues</li>
<li>Data staleness between updates</li>
</ul>
<p><strong>💡 Interview Insight</strong>: <em>Discuss cache stampede scenarios: multiple requests hitting the same missing key simultaneously. Solutions include distributed locking or probabilistic refresh.</em></p>
<h3 id="2-Write-Through"><a href="#2-Write-Through" class="headerlink" title="2. Write-Through"></a>2. Write-Through</h3><p>Data is written to both cache and database simultaneously.</p>
<pre>
<code class="mermaid">
sequenceDiagram
participant App as Application
participant Cache as Redis Cache
participant DB as Database

App-&gt;&gt;Cache: SET key data
Cache-&gt;&gt;DB: UPDATE data
DB--&gt;&gt;Cache: Success
Cache--&gt;&gt;App: Success

Note over App,DB: Read requests served directly from cache
</code>
</pre>

<p><strong>Implementation Example:</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">WriteThroughPattern</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_user</span>(<span class="params">self, user_id, user_data</span>):</span><br><span class="line">        cache_key = <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># Write to database first</span></span><br><span class="line">            <span class="variable language_">self</span>.save_user_to_db(user_id, user_data)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Then write to cache</span></span><br><span class="line">            <span class="variable language_">self</span>.redis_client.<span class="built_in">set</span>(cache_key, json.dumps(user_data))</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># Rollback cache if database write fails</span></span><br><span class="line">            <span class="variable language_">self</span>.redis_client.delete(cache_key)</span><br><span class="line">            <span class="keyword">raise</span> e</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">self, user_id</span>):</span><br><span class="line">        cache_key = <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">        cached_data = <span class="variable language_">self</span>.redis_client.get(cache_key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> cached_data:</span><br><span class="line">            <span class="keyword">return</span> json.loads(cached_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># This should rarely happen in write-through</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.fetch_user_from_db(user_id)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>Pros:</strong></p>
<ul>
<li>Data consistency between cache and database</li>
<li>Fast read performance</li>
<li>No cache miss penalty for written data</li>
</ul>
<p><strong>Cons:</strong></p>
<ul>
<li>Higher write latency</li>
<li>Writes to cache even for data that may never be read</li>
<li>More complex error handling</li>
</ul>
<h3 id="3-Write-Behind-Write-Back"><a href="#3-Write-Behind-Write-Back" class="headerlink" title="3. Write-Behind (Write-Back)"></a>3. Write-Behind (Write-Back)</h3><p>Data is written to cache immediately and to the database asynchronously.</p>
<pre>
<code class="mermaid">
sequenceDiagram
participant App as Application
participant Cache as Redis Cache
participant Queue as Write Queue
participant DB as Database

App-&gt;&gt;Cache: SET user:123 {updated_data}
Cache--&gt;&gt;App: OK (immediate)
Cache-&gt;&gt;Queue: Enqueue write operation
Queue-&gt;&gt;DB: Async UPDATE users
DB--&gt;&gt;Queue: Success
</code>
</pre>
<p><strong>Implementation Example:</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WriteBehindPattern</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.write_queue = Queue()</span><br><span class="line">        <span class="variable language_">self</span>.start_background_writer()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_user</span>(<span class="params">self, user_id, user_data</span>):</span><br><span class="line">        cache_key = <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Immediate cache update</span></span><br><span class="line">        <span class="variable language_">self</span>.redis_client.<span class="built_in">set</span>(cache_key, json.dumps(user_data))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Queue for database write</span></span><br><span class="line">        <span class="variable language_">self</span>.write_queue.put(&#123;</span><br><span class="line">            <span class="string">&#x27;action&#x27;</span>: <span class="string">&#x27;update&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;user_id&#x27;</span>: user_id,</span><br><span class="line">            <span class="string">&#x27;data&#x27;</span>: user_data,</span><br><span class="line">            <span class="string">&#x27;timestamp&#x27;</span>: time.time()</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> user_data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start_background_writer</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">worker</span>():</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    item = <span class="variable language_">self</span>.write_queue.get(timeout=<span class="number">1</span>)</span><br><span class="line">                    <span class="variable language_">self</span>.process_write(item)</span><br><span class="line">                    <span class="variable language_">self</span>.write_queue.task_done()</span><br><span class="line">                <span class="keyword">except</span>:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">        thread = threading.Thread(target=worker, daemon=<span class="literal">True</span>)</span><br><span class="line">        thread.start()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_write</span>(<span class="params">self, item</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>.save_user_to_db(item[<span class="string">&#x27;user_id&#x27;</span>], item[<span class="string">&#x27;data&#x27;</span>])</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># Implement retry logic or dead letter queue</span></span><br><span class="line">            <span class="variable language_">self</span>.handle_write_failure(item, e)</span><br></pre></td></tr></table></figure>

<p><strong>Pros:</strong></p>
<ul>
<li>Excellent write performance</li>
<li>Reduced database load</li>
<li>Can batch writes for efficiency</li>
</ul>
<p><strong>Cons:</strong></p>
<ul>
<li>Risk of data loss on cache failure</li>
<li>Complex failure handling</li>
<li>Eventual consistency only</li>
</ul>
<p><strong>🎯 Interview Insight</strong>: <em>Write-behind offers better write performance but introduces complexity and potential data loss risks. Discuss scenarios where this pattern is appropriate (high write volume, acceptable eventual consistency,some data loss is acceptable, like analytics or logging systems).</em></p>
<h3 id="4-Refresh-Ahead"><a href="#4-Refresh-Ahead" class="headerlink" title="4. Refresh-Ahead"></a>4. Refresh-Ahead</h3><p>Proactively refresh cache entries before they expire.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RefreshAheadCache</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.refresh_threshold = <span class="number">0.8</span>  <span class="comment"># Refresh when 80% of TTL is reached</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_with_refresh_ahead</span>(<span class="params">self, key: <span class="built_in">str</span></span>):</span><br><span class="line">        data = <span class="variable language_">self</span>.redis.get(key)</span><br><span class="line">        ttl = <span class="variable language_">self</span>.redis.ttl(key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> data <span class="keyword">and</span> ttl &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># Check if refresh is needed</span></span><br><span class="line">            <span class="keyword">if</span> ttl &lt; (<span class="variable language_">self</span>.cache_ttl * (<span class="number">1</span> - <span class="variable language_">self</span>.refresh_threshold)):</span><br><span class="line">                <span class="comment"># Trigger async refresh</span></span><br><span class="line">                asyncio.create_task(<span class="variable language_">self</span>.refresh_cache_entry(key))</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> json.loads(data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Cache miss or expired</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> <span class="variable language_">self</span>.load_and_cache(key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">refresh_cache_entry</span>(<span class="params">self, key: <span class="built_in">str</span></span>):</span><br><span class="line">        fresh_data = <span class="keyword">await</span> <span class="variable language_">self</span>.fetch_fresh_data(key)</span><br><span class="line">        <span class="keyword">if</span> fresh_data:</span><br><span class="line">            <span class="variable language_">self</span>.redis.setex(key, <span class="variable language_">self</span>.cache_ttl, json.dumps(fresh_data))</span><br></pre></td></tr></table></figure>

<h2 id="Consistency-Models-and-Strategies"><a href="#Consistency-Models-and-Strategies" class="headerlink" title="Consistency Models and Strategies"></a>Consistency Models and Strategies</h2><h3 id="1-Strong-Consistency-with-Distributed-Locks"><a href="#1-Strong-Consistency-with-Distributed-Locks" class="headerlink" title="1. Strong Consistency with Distributed Locks"></a>1. Strong Consistency with Distributed Locks</h3><p>Ensures all reads receive the most recent write. Implemented using distributed locks or transactions.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DistributedLock</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client, key, timeout=<span class="number">10</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis_client</span><br><span class="line">        <span class="variable language_">self</span>.key = <span class="string">f&quot;lock:<span class="subst">&#123;key&#125;</span>&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.timeout = timeout</span><br><span class="line">        <span class="variable language_">self</span>.identifier = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">acquire</span>(<span class="params">self</span>):</span><br><span class="line">        end = time.time() + <span class="variable language_">self</span>.timeout</span><br><span class="line">        <span class="keyword">while</span> time.time() &lt; end:</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.redis.setnx(<span class="variable language_">self</span>.key, <span class="variable language_">self</span>.identifier):</span><br><span class="line">                <span class="variable language_">self</span>.redis.expire(<span class="variable language_">self</span>.key, <span class="variable language_">self</span>.timeout)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            time.sleep(<span class="number">0.001</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">release</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Lua script ensures atomicity</span></span><br><span class="line">        lua_script = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        if redis.call(&quot;get&quot;, KEYS[1]) == ARGV[1] then</span></span><br><span class="line"><span class="string">            return redis.call(&quot;del&quot;, KEYS[1])</span></span><br><span class="line"><span class="string">        else</span></span><br><span class="line"><span class="string">            return 0</span></span><br><span class="line"><span class="string">        end</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.redis.<span class="built_in">eval</span>(lua_script, <span class="number">1</span>, <span class="variable language_">self</span>.key, <span class="variable language_">self</span>.identifier)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage in cache update</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update_user_with_lock</span>(<span class="params">user_id, user_data</span>):</span><br><span class="line">    lock = DistributedLock(redis_client, <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> lock.acquire():</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># Update database</span></span><br><span class="line">            update_user_in_db(user_id, user_data)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Update cache</span></span><br><span class="line">            cache_key = <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">            redis_client.<span class="built_in">set</span>(cache_key, json.dumps(user_data))</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            lock.release()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;Could not acquire lock&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>🎯 Interview Insight</strong>: <em>Strong consistency comes with performance costs. Discuss scenarios where it’s necessary (financial transactions, inventory management) vs. where eventual consistency is acceptable (user profiles, social media posts).</em></p>
<h3 id="2-Eventual-Consistency"><a href="#2-Eventual-Consistency" class="headerlink" title="2. Eventual Consistency"></a>2. Eventual Consistency</h3><p>Updates propagate through the system over time, allowing temporary inconsistencies.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EventualConsistencyHandler</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.update_queue = Queue()</span><br><span class="line">        <span class="variable language_">self</span>.worker_thread = Thread(target=<span class="variable language_">self</span>._process_updates, daemon=<span class="literal">True</span>)</span><br><span class="line">        <span class="variable language_">self</span>.worker_thread.start()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update_user_async</span>(<span class="params">self, user_id: <span class="built_in">int</span>, updates: <span class="type">Dict</span></span>):</span><br><span class="line">        <span class="comment"># Immediate cache update for read performance</span></span><br><span class="line">        cache_key = <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">        current_cached = <span class="variable language_">self</span>.redis.get(cache_key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> current_cached:</span><br><span class="line">            current_data = json.loads(current_cached)</span><br><span class="line">            updated_data = &#123;**current_data, **updates&#125;</span><br><span class="line">            <span class="variable language_">self</span>.redis.setex(cache_key, <span class="number">3600</span>, json.dumps(updated_data))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Queue database update</span></span><br><span class="line">        <span class="variable language_">self</span>.update_queue.put((user_id, updates, time.time()))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_process_updates</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                user_id, updates, timestamp = <span class="variable language_">self</span>.update_queue.get(timeout=<span class="number">1</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># Process database update</span></span><br><span class="line">                <span class="variable language_">self</span>.update_database_with_retry(user_id, updates, timestamp)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># Verify cache consistency</span></span><br><span class="line">                <span class="variable language_">self</span>._verify_consistency(user_id)</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="comment"># Handle failed updates (DLQ, alerts, etc.)</span></span><br><span class="line">                <span class="variable language_">self</span>.handle_update_failure(user_id, updates, e)</span><br></pre></td></tr></table></figure>

<h3 id="3-Read-Your-Writes-Consistency"><a href="#3-Read-Your-Writes-Consistency" class="headerlink" title="3. Read-Your-Writes Consistency"></a>3. Read-Your-Writes Consistency</h3><p>Guarantees that a user will see their own writes immediately.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ReadYourWritesCache</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.user_versions = &#123;&#125;  <span class="comment"># Track user-specific versions</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">write_user_data</span>(<span class="params">self, user_id: <span class="built_in">int</span>, data: <span class="type">Dict</span>, session_id: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="comment"># Increment version for this user</span></span><br><span class="line">        version = <span class="variable language_">self</span>.redis.incr(<span class="string">f&quot;user_version:<span class="subst">&#123;user_id&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Store data with version</span></span><br><span class="line">        cache_key = <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">        versioned_data = &#123;**data, <span class="string">&quot;_version&quot;</span>: version, <span class="string">&quot;_updated_by&quot;</span>: session_id&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Write to cache and database</span></span><br><span class="line">        <span class="variable language_">self</span>.redis.setex(cache_key, <span class="number">3600</span>, json.dumps(versioned_data))</span><br><span class="line">        <span class="variable language_">self</span>.update_database(user_id, data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Track version for this session</span></span><br><span class="line">        <span class="variable language_">self</span>.user_versions[session_id] = version</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read_user_data</span>(<span class="params">self, user_id: <span class="built_in">int</span>, session_id: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        cache_key = <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">        cached_data = <span class="variable language_">self</span>.redis.get(cache_key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> cached_data:</span><br><span class="line">            data = json.loads(cached_data)</span><br><span class="line">            cached_version = data.get(<span class="string">&quot;_version&quot;</span>, <span class="number">0</span>)</span><br><span class="line">            expected_version = <span class="variable language_">self</span>.user_versions.get(session_id, <span class="number">0</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Ensure user sees their own writes</span></span><br><span class="line">            <span class="keyword">if</span> cached_version &gt;= expected_version:</span><br><span class="line">                <span class="keyword">return</span> data</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Fallback to database for consistency</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.fetch_from_database(user_id)</span><br></pre></td></tr></table></figure>

<h2 id="Advanced-Patterns"><a href="#Advanced-Patterns" class="headerlink" title="Advanced Patterns"></a>Advanced Patterns</h2><h3 id="1-Cache-Warming"><a href="#1-Cache-Warming" class="headerlink" title="1. Cache Warming"></a>1. Cache Warming</h3><p>Pre-populate cache with frequently accessed data.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CacheWarmer</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client, batch_size=<span class="number">100</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis_client</span><br><span class="line">        <span class="variable language_">self</span>.batch_size = batch_size</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">warm_user_cache</span>(<span class="params">self, user_ids: <span class="type">List</span>[<span class="built_in">int</span>]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Warm cache for multiple users concurrently&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">warm_single_user</span>(<span class="params">user_id: <span class="built_in">int</span></span>):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                user_data = <span class="keyword">await</span> <span class="variable language_">self</span>.fetch_user_from_db(user_id)</span><br><span class="line">                <span class="keyword">if</span> user_data:</span><br><span class="line">                    cache_key = <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">                    <span class="variable language_">self</span>.redis.setex(</span><br><span class="line">                        cache_key,</span><br><span class="line">                        <span class="number">3600</span>,</span><br><span class="line">                        json.dumps(user_data)</span><br><span class="line">                    )</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Failed to warm cache for user <span class="subst">&#123;user_id&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Process in batches to avoid overwhelming the system</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(user_ids), <span class="variable language_">self</span>.batch_size):</span><br><span class="line">            batch = user_ids[i:i + <span class="variable language_">self</span>.batch_size]</span><br><span class="line">            tasks = [warm_single_user(uid) <span class="keyword">for</span> uid <span class="keyword">in</span> batch]</span><br><span class="line">            results = <span class="keyword">await</span> asyncio.gather(*tasks, return_exceptions=<span class="literal">True</span>)</span><br><span class="line">            </span><br><span class="line">            success_count = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> r <span class="keyword">in</span> results <span class="keyword">if</span> r <span class="keyword">is</span> <span class="literal">True</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Warmed <span class="subst">&#123;success_count&#125;</span>/<span class="subst">&#123;<span class="built_in">len</span>(batch)&#125;</span> cache entries&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Small delay between batches</span></span><br><span class="line">            <span class="keyword">await</span> asyncio.sleep(<span class="number">0.1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">warm_on_startup</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Warm cache with most accessed data on application startup&quot;&quot;&quot;</span></span><br><span class="line">        popular_users = <span class="variable language_">self</span>.get_popular_user_ids()</span><br><span class="line">        asyncio.run(<span class="variable language_">self</span>.warm_user_cache(popular_users))</span><br></pre></td></tr></table></figure>

<h3 id="2-Multi-Level-Caching"><a href="#2-Multi-Level-Caching" class="headerlink" title="2. Multi-Level Caching"></a>2. Multi-Level Caching</h3><p>Implement multiple cache layers for optimal performance.</p>
<pre>
<code class="mermaid">
graph TD
A[Application] --&gt; B[L1 Cache - Local Memory]
B --&gt; C[L2 Cache - Redis]
C --&gt; D[L3 Cache - CDN]
D --&gt; E[Database]

style B fill:#e1f5fe
style C fill:#f3e5f5
style D fill:#e8f5e8
style E fill:#fff3e0
</code>
</pre>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> lru_cache</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MultiLevelCache</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># L1: Local memory cache (LRU)</span></span><br><span class="line">        <span class="variable language_">self</span>.l1_cache = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.l1_access_times = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.l1_max_size = <span class="number">1000</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># L2: Redis cache</span></span><br><span class="line">        <span class="variable language_">self</span>.redis = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># L3: Persistent cache (database cache table)</span></span><br><span class="line">        <span class="variable language_">self</span>.db_cache = DatabaseCacheLayer()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, key: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">any</span>]:</span><br><span class="line">        <span class="comment"># L1 Cache check</span></span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">in</span> <span class="variable language_">self</span>.l1_cache:</span><br><span class="line">            <span class="variable language_">self</span>.l1_access_times[key] = time.time()</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.l1_cache[key]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># L2 Cache check (Redis)</span></span><br><span class="line">        l2_data = <span class="variable language_">self</span>.redis.get(key)</span><br><span class="line">        <span class="keyword">if</span> l2_data:</span><br><span class="line">            value = json.loads(l2_data)</span><br><span class="line">            <span class="variable language_">self</span>._store_in_l1(key, value)</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># L3 Cache check (Database cache)</span></span><br><span class="line">        l3_data = <span class="variable language_">self</span>.db_cache.get(key)</span><br><span class="line">        <span class="keyword">if</span> l3_data:</span><br><span class="line">            <span class="comment"># Populate upper levels</span></span><br><span class="line">            <span class="variable language_">self</span>.redis.setex(key, <span class="number">3600</span>, json.dumps(l3_data))</span><br><span class="line">            <span class="variable language_">self</span>._store_in_l1(key, l3_data)</span><br><span class="line">            <span class="keyword">return</span> l3_data</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Cache miss - fetch from origin</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set</span>(<span class="params">self, key: <span class="built_in">str</span>, value: <span class="built_in">any</span>, ttl: <span class="built_in">int</span> = <span class="number">3600</span></span>):</span><br><span class="line">        <span class="comment"># Store in all levels</span></span><br><span class="line">        <span class="variable language_">self</span>._store_in_l1(key, value)</span><br><span class="line">        <span class="variable language_">self</span>.redis.setex(key, ttl, json.dumps(value))</span><br><span class="line">        <span class="variable language_">self</span>.db_cache.<span class="built_in">set</span>(key, value, ttl)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_store_in_l1</span>(<span class="params">self, key: <span class="built_in">str</span>, value: <span class="built_in">any</span></span>):</span><br><span class="line">        <span class="comment"># Implement LRU eviction</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(<span class="variable language_">self</span>.l1_cache) &gt;= <span class="variable language_">self</span>.l1_max_size:</span><br><span class="line">            <span class="variable language_">self</span>._evict_lru()</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.l1_cache[key] = value</span><br><span class="line">        <span class="variable language_">self</span>.l1_access_times[key] = time.time()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_evict_lru</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Remove least recently used item</span></span><br><span class="line">        lru_key = <span class="built_in">min</span>(<span class="variable language_">self</span>.l1_access_times, key=<span class="variable language_">self</span>.l1_access_times.get)</span><br><span class="line">        <span class="keyword">del</span> <span class="variable language_">self</span>.l1_cache[lru_key]</span><br><span class="line">        <span class="keyword">del</span> <span class="variable language_">self</span>.l1_access_times[lru_key]</span><br></pre></td></tr></table></figure>

<p><strong>🎯 Interview Insight</strong>: <em>Multi-level caching questions often focus on cache coherence. Discuss strategies for maintaining consistency across levels and the trade-offs between complexity and performance.</em></p>
<h2 id="Data-Invalidation-Strategies"><a href="#Data-Invalidation-Strategies" class="headerlink" title="Data Invalidation Strategies"></a>Data Invalidation Strategies</h2><h3 id="1-TTL-Based-Expiration"><a href="#1-TTL-Based-Expiration" class="headerlink" title="1. TTL-Based Expiration"></a>1. TTL-Based Expiration</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TTLInvalidationStrategy</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Different TTL strategies for different data types</span></span><br><span class="line">        <span class="variable language_">self</span>.ttl_config = &#123;</span><br><span class="line">            <span class="string">&#x27;user_profile&#x27;</span>: <span class="number">3600</span>,      <span class="comment"># 1 hour</span></span><br><span class="line">            <span class="string">&#x27;user_preferences&#x27;</span>: <span class="number">86400</span>,  <span class="comment"># 24 hours</span></span><br><span class="line">            <span class="string">&#x27;session_data&#x27;</span>: <span class="number">1800</span>,       <span class="comment"># 30 minutes</span></span><br><span class="line">            <span class="string">&#x27;product_catalog&#x27;</span>: <span class="number">300</span>,     <span class="comment"># 5 minutes</span></span><br><span class="line">            <span class="string">&#x27;real_time_data&#x27;</span>: <span class="number">60</span>        <span class="comment"># 1 minute</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_with_appropriate_ttl</span>(<span class="params">self, key: <span class="built_in">str</span>, value: <span class="built_in">any</span>, data_type: <span class="built_in">str</span></span>):</span><br><span class="line">        ttl = <span class="variable language_">self</span>.ttl_config.get(data_type, <span class="number">3600</span>)  <span class="comment"># Default 1 hour</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Add jitter to prevent thundering herd</span></span><br><span class="line">        jitter = random.randint(-<span class="number">60</span>, <span class="number">60</span>)  <span class="comment"># ±1 minute</span></span><br><span class="line">        final_ttl = <span class="built_in">max</span>(ttl + jitter, <span class="number">60</span>)  <span class="comment"># Minimum 1 minute</span></span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.redis.setex(key, final_ttl, json.dumps(value))</span><br></pre></td></tr></table></figure>

<h3 id="2-Event-Driven-Invalidation"><a href="#2-Event-Driven-Invalidation" class="headerlink" title="2. Event-Driven Invalidation"></a>2. Event-Driven Invalidation</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pika</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EventDrivenInvalidation</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.connection = pika.BlockingConnection(</span><br><span class="line">            pika.ConnectionParameters(<span class="string">&#x27;localhost&#x27;</span>)</span><br><span class="line">        )</span><br><span class="line">        <span class="variable language_">self</span>.channel = <span class="variable language_">self</span>.connection.channel()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Set up exchange and queue</span></span><br><span class="line">        <span class="variable language_">self</span>.channel.exchange_declare(</span><br><span class="line">            exchange=<span class="string">&#x27;cache_invalidation&#x27;</span>,</span><br><span class="line">            exchange_type=<span class="string">&#x27;topic&#x27;</span></span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">invalidate_user_cache</span>(<span class="params">self, user_id: <span class="built_in">int</span>, event_type: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Invalidate cache based on user events&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        patterns_to_invalidate = &#123;</span><br><span class="line">            <span class="string">&#x27;user_updated&#x27;</span>: [<span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span>, <span class="string">f&quot;user_profile:<span class="subst">&#123;user_id&#125;</span>&quot;</span>],</span><br><span class="line">            <span class="string">&#x27;user_preferences_changed&#x27;</span>: [<span class="string">f&quot;user_prefs:<span class="subst">&#123;user_id&#125;</span>&quot;</span>],</span><br><span class="line">            <span class="string">&#x27;user_deleted&#x27;</span>: [<span class="string">f&quot;user:*:<span class="subst">&#123;user_id&#125;</span>&quot;</span>, <span class="string">f&quot;session:*:<span class="subst">&#123;user_id&#125;</span>&quot;</span>],</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        keys_to_invalidate = patterns_to_invalidate.get(event_type, [])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> pattern <span class="keyword">in</span> keys_to_invalidate:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;*&#x27;</span> <span class="keyword">in</span> pattern:</span><br><span class="line">                <span class="comment"># Handle wildcard patterns</span></span><br><span class="line">                matching_keys = <span class="variable language_">self</span>.redis.keys(pattern)</span><br><span class="line">                <span class="keyword">if</span> matching_keys:</span><br><span class="line">                    <span class="variable language_">self</span>.redis.delete(*matching_keys)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="variable language_">self</span>.redis.delete(pattern)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Publish invalidation event</span></span><br><span class="line">        <span class="variable language_">self</span>.channel.basic_publish(</span><br><span class="line">            exchange=<span class="string">&#x27;cache_invalidation&#x27;</span>,</span><br><span class="line">            routing_key=<span class="string">f&#x27;user.<span class="subst">&#123;event_type&#125;</span>&#x27;</span>,</span><br><span class="line">            body=json.dumps(&#123;</span><br><span class="line">                <span class="string">&#x27;user_id&#x27;</span>: user_id,</span><br><span class="line">                <span class="string">&#x27;event_type&#x27;</span>: event_type,</span><br><span class="line">                <span class="string">&#x27;timestamp&#x27;</span>: time.time(),</span><br><span class="line">                <span class="string">&#x27;invalidated_keys&#x27;</span>: keys_to_invalidate</span><br><span class="line">            &#125;)</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setup_invalidation_listener</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Listen for cache invalidation events&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">callback</span>(<span class="params">ch, method, properties, body</span>):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                event = json.loads(body)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Cache invalidation event: <span class="subst">&#123;event&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="comment"># Additional processing if needed</span></span><br><span class="line">                </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Error processing invalidation event: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        queue = <span class="variable language_">self</span>.channel.queue_declare(queue=<span class="string">&#x27;cache_invalidation_processor&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.channel.queue_bind(</span><br><span class="line">            exchange=<span class="string">&#x27;cache_invalidation&#x27;</span>,</span><br><span class="line">            queue=queue.method.queue,</span><br><span class="line">            routing_key=<span class="string">&#x27;user.*&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.channel.basic_consume(</span><br><span class="line">            queue=queue.method.queue,</span><br><span class="line">            on_message_callback=callback,</span><br><span class="line">            auto_ack=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.channel.start_consuming()</span><br></pre></td></tr></table></figure>

<h3 id="3-Cache-Tags-and-Dependencies"><a href="#3-Cache-Tags-and-Dependencies" class="headerlink" title="3. Cache Tags and Dependencies"></a>3. Cache Tags and Dependencies</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TagBasedInvalidation</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_with_tags</span>(<span class="params">self, key: <span class="built_in">str</span>, value: <span class="built_in">any</span>, tags: <span class="type">List</span>[<span class="built_in">str</span>], ttl: <span class="built_in">int</span> = <span class="number">3600</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Store data with associated tags for bulk invalidation&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Store the actual data</span></span><br><span class="line">        <span class="variable language_">self</span>.redis.setex(key, ttl, json.dumps(value))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Associate key with tags</span></span><br><span class="line">        <span class="keyword">for</span> tag <span class="keyword">in</span> tags:</span><br><span class="line">            tag_key = <span class="string">f&quot;tag:<span class="subst">&#123;tag&#125;</span>&quot;</span></span><br><span class="line">            <span class="variable language_">self</span>.redis.sadd(tag_key, key)</span><br><span class="line">            <span class="variable language_">self</span>.redis.expire(tag_key, ttl + <span class="number">300</span>)  <span class="comment"># Tags live longer than data</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">invalidate_by_tag</span>(<span class="params">self, tag: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Invalidate all cache entries associated with a tag&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        tag_key = <span class="string">f&quot;tag:<span class="subst">&#123;tag&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Get all keys associated with this tag</span></span><br><span class="line">        keys_to_invalidate = <span class="variable language_">self</span>.redis.smembers(tag_key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> keys_to_invalidate:</span><br><span class="line">            <span class="comment"># Delete all associated keys</span></span><br><span class="line">            <span class="variable language_">self</span>.redis.delete(*keys_to_invalidate)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Clean up tag associations</span></span><br><span class="line">            <span class="keyword">for</span> key <span class="keyword">in</span> keys_to_invalidate:</span><br><span class="line">                <span class="variable language_">self</span>._remove_key_from_all_tags(key.decode())</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Remove the tag itself</span></span><br><span class="line">        <span class="variable language_">self</span>.redis.delete(tag_key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_remove_key_from_all_tags</span>(<span class="params">self, key: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Remove a key from all tag associations&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># This could be expensive - consider background cleanup</span></span><br><span class="line">        tag_pattern = <span class="string">&quot;tag:*&quot;</span></span><br><span class="line">        <span class="keyword">for</span> tag_key <span class="keyword">in</span> <span class="variable language_">self</span>.redis.scan_iter(<span class="keyword">match</span>=tag_pattern):</span><br><span class="line">            <span class="variable language_">self</span>.redis.srem(tag_key, key)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage example</span></span><br><span class="line">cache = TagBasedInvalidation()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Store user data with tags</span></span><br><span class="line">user_data = &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;John&quot;</span>, <span class="string">&quot;department&quot;</span>: <span class="string">&quot;Engineering&quot;</span>&#125;</span><br><span class="line">cache.set_with_tags(</span><br><span class="line">    key=<span class="string">&quot;user:123&quot;</span>,</span><br><span class="line">    value=user_data,</span><br><span class="line">    tags=[<span class="string">&quot;user&quot;</span>, <span class="string">&quot;department:engineering&quot;</span>, <span class="string">&quot;active_users&quot;</span>]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Invalidate all engineering department data</span></span><br><span class="line">cache.invalidate_by_tag(<span class="string">&quot;department:engineering&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>🎯 Interview Insight</strong>: <em>Tag-based invalidation is a sophisticated pattern. Discuss the trade-offs between granular control and storage overhead. Mention alternatives like dependency graphs for complex invalidation scenarios.</em></p>
<h2 id="Performance-Optimization"><a href="#Performance-Optimization" class="headerlink" title="Performance Optimization"></a>Performance Optimization</h2><h3 id="1-Connection-Pooling-and-Pipelining"><a href="#1-Connection-Pooling-and-Pipelining" class="headerlink" title="1. Connection Pooling and Pipelining"></a>1. Connection Pooling and Pipelining</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis.connection</span><br><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"><span class="keyword">from</span> redis.connection <span class="keyword">import</span> ConnectionPool</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OptimizedRedisClient</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Connection pool for better resource management</span></span><br><span class="line">        <span class="variable language_">self</span>.pool = ConnectionPool(</span><br><span class="line">            host=<span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">            port=<span class="number">6379</span>,</span><br><span class="line">            db=<span class="number">0</span>,</span><br><span class="line">            max_connections=<span class="number">20</span>,</span><br><span class="line">            socket_connect_timeout=<span class="number">5</span>,</span><br><span class="line">            socket_timeout=<span class="number">5</span>,</span><br><span class="line">            retry_on_timeout=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        <span class="variable language_">self</span>.redis = Redis(connection_pool=<span class="variable language_">self</span>.pool)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">batch_get_users</span>(<span class="params">self, user_ids: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">int</span>, <span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Efficiently fetch multiple users using pipelining&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        pipe = <span class="variable language_">self</span>.redis.pipeline()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Queue multiple commands</span></span><br><span class="line">        cache_keys = [<span class="string">f&quot;user:<span class="subst">&#123;uid&#125;</span>&quot;</span> <span class="keyword">for</span> uid <span class="keyword">in</span> user_ids]</span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> cache_keys:</span><br><span class="line">            pipe.get(key)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Execute all commands at once</span></span><br><span class="line">        results = pipe.execute()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Process results</span></span><br><span class="line">        user_data = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> i, result <span class="keyword">in</span> <span class="built_in">enumerate</span>(results):</span><br><span class="line">            <span class="keyword">if</span> result:</span><br><span class="line">                user_data[user_ids[i]] = json.loads(result)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> user_data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">batch_set_users</span>(<span class="params">self, user_data_map: <span class="type">Dict</span>[<span class="built_in">int</span>, <span class="type">Dict</span>]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Efficiently store multiple users using pipelining&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        pipe = <span class="variable language_">self</span>.redis.pipeline()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> user_id, data <span class="keyword">in</span> user_data_map.items():</span><br><span class="line">            cache_key = <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">            pipe.setex(cache_key, <span class="number">3600</span>, json.dumps(data))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Execute all commands</span></span><br><span class="line">        pipe.execute()</span><br></pre></td></tr></table></figure>

<h3 id="2-Memory-Optimization"><a href="#2-Memory-Optimization" class="headerlink" title="2. Memory Optimization"></a>2. Memory Optimization</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MemoryOptimizedCache</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">store_user_efficiently</span>(<span class="params">self, user_id: <span class="built_in">int</span>, user_data: <span class="type">Dict</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Use Redis hashes for memory efficiency with structured data&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        hash_key = <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Store as hash instead of JSON string</span></span><br><span class="line">        <span class="comment"># This is more memory efficient for structured data</span></span><br><span class="line">        mapping = &#123;</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>: user_data.get(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;email&#x27;</span>: user_data.get(<span class="string">&#x27;email&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;created_at&#x27;</span>: <span class="built_in">str</span>(user_data.get(<span class="string">&#x27;created_at&#x27;</span>, <span class="string">&#x27;&#x27;</span>)),</span><br><span class="line">            <span class="string">&#x27;is_active&#x27;</span>: <span class="string">&#x27;1&#x27;</span> <span class="keyword">if</span> user_data.get(<span class="string">&#x27;is_active&#x27;</span>) <span class="keyword">else</span> <span class="string">&#x27;0&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.redis.hset(hash_key, mapping=mapping)</span><br><span class="line">        <span class="variable language_">self</span>.redis.expire(hash_key, <span class="number">3600</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_user_efficiently</span>(<span class="params">self, user_id: <span class="built_in">int</span></span>) -&gt; <span class="type">Optional</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Retrieve user data from hash&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        hash_key = <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">        user_hash = <span class="variable language_">self</span>.redis.hgetall(hash_key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user_hash:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Convert back to proper types</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>: user_hash.get(<span class="string">b&#x27;name&#x27;</span>, <span class="string">b&#x27;&#x27;</span>).decode(),</span><br><span class="line">            <span class="string">&#x27;email&#x27;</span>: user_hash.get(<span class="string">b&#x27;email&#x27;</span>, <span class="string">b&#x27;&#x27;</span>).decode(),</span><br><span class="line">            <span class="string">&#x27;created_at&#x27;</span>: user_hash.get(<span class="string">b&#x27;created_at&#x27;</span>, <span class="string">b&#x27;&#x27;</span>).decode(),</span><br><span class="line">            <span class="string">&#x27;is_active&#x27;</span>: user_hash.get(<span class="string">b&#x27;is_active&#x27;</span>) == <span class="string">b&#x27;1&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">compress_large_data</span>(<span class="params">self, key: <span class="built_in">str</span>, data: <span class="built_in">any</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Compress large data before storing&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">import</span> gzip</span><br><span class="line">        </span><br><span class="line">        json_data = json.dumps(data)</span><br><span class="line">        compressed_data = gzip.compress(json_data.encode())</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Store with compression flag</span></span><br><span class="line">        <span class="variable language_">self</span>.redis.hset(<span class="string">f&quot;compressed:<span class="subst">&#123;key&#125;</span>&quot;</span>, mapping=&#123;</span><br><span class="line">            <span class="string">&#x27;data&#x27;</span>: compressed_data,</span><br><span class="line">            <span class="string">&#x27;compressed&#x27;</span>: <span class="string">&#x27;1&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_compressed_data</span>(<span class="params">self, key: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Retrieve and decompress data&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">import</span> gzip</span><br><span class="line">        </span><br><span class="line">        result = <span class="variable language_">self</span>.redis.hgetall(<span class="string">f&quot;compressed:<span class="subst">&#123;key&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> result:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> result.get(<span class="string">b&#x27;compressed&#x27;</span>) == <span class="string">b&#x27;1&#x27;</span>:</span><br><span class="line">            compressed_data = result.get(<span class="string">b&#x27;data&#x27;</span>)</span><br><span class="line">            json_data = gzip.decompress(compressed_data).decode()</span><br><span class="line">            <span class="keyword">return</span> json.loads(json_data)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<h3 id="3-Hot-Key-Detection-and-Mitigation"><a href="#3-Hot-Key-Detection-and-Mitigation" class="headerlink" title="3. Hot Key Detection and Mitigation"></a>3. Hot Key Detection and Mitigation</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict, deque</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HotKeyDetector</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, threshold=<span class="number">100</span>, window_seconds=<span class="number">60</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.threshold = threshold</span><br><span class="line">        <span class="variable language_">self</span>.window_seconds = window_seconds</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Track key access patterns</span></span><br><span class="line">        <span class="variable language_">self</span>.access_counts = defaultdict(deque)</span><br><span class="line">        <span class="variable language_">self</span>.lock = threading.RLock()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Hot key mitigation strategies</span></span><br><span class="line">        <span class="variable language_">self</span>.hot_keys = <span class="built_in">set</span>()</span><br><span class="line">        <span class="variable language_">self</span>.local_cache = &#123;&#125;  <span class="comment"># Local caching for hot keys</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">track_access</span>(<span class="params">self, key: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Track key access for hot key detection&quot;&quot;&quot;</span></span><br><span class="line">        current_time = time.time()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">with</span> <span class="variable language_">self</span>.lock:</span><br><span class="line">            <span class="comment"># Add current access</span></span><br><span class="line">            <span class="variable language_">self</span>.access_counts[key].append(current_time)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Remove old accesses outside the window</span></span><br><span class="line">            cutoff_time = current_time - <span class="variable language_">self</span>.window_seconds</span><br><span class="line">            <span class="keyword">while</span> (<span class="variable language_">self</span>.access_counts[key] <span class="keyword">and</span> </span><br><span class="line">                   <span class="variable language_">self</span>.access_counts[key][<span class="number">0</span>] &lt; cutoff_time):</span><br><span class="line">                <span class="variable language_">self</span>.access_counts[key].popleft()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Check if key is hot</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(<span class="variable language_">self</span>.access_counts[key]) &gt; <span class="variable language_">self</span>.threshold:</span><br><span class="line">                <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> <span class="variable language_">self</span>.hot_keys:</span><br><span class="line">                    <span class="variable language_">self</span>.hot_keys.add(key)</span><br><span class="line">                    <span class="variable language_">self</span>._handle_hot_key(key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_with_hot_key_handling</span>(<span class="params">self, key: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get data with hot key optimization&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.track_access(key)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># If it&#x27;s a hot key, try local cache first</span></span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">in</span> <span class="variable language_">self</span>.hot_keys:</span><br><span class="line">            local_data = <span class="variable language_">self</span>.local_cache.get(key)</span><br><span class="line">            <span class="keyword">if</span> local_data <span class="keyword">and</span> local_data[<span class="string">&#x27;expires&#x27;</span>] &gt; time.time():</span><br><span class="line">                <span class="keyword">return</span> local_data[<span class="string">&#x27;value&#x27;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Get from Redis</span></span><br><span class="line">        data = <span class="variable language_">self</span>.redis.get(key)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Cache locally if hot key</span></span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">in</span> <span class="variable language_">self</span>.hot_keys <span class="keyword">and</span> data:</span><br><span class="line">            <span class="variable language_">self</span>.local_cache[key] = &#123;</span><br><span class="line">                <span class="string">&#x27;value&#x27;</span>: data,</span><br><span class="line">                <span class="string">&#x27;expires&#x27;</span>: time.time() + <span class="number">30</span>  <span class="comment"># Short local cache TTL</span></span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_handle_hot_key</span>(<span class="params">self, key: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Implement hot key mitigation strategies&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Strategy 1: Add local caching</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Hot key detected: <span class="subst">&#123;key&#125;</span> - enabling local caching&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Strategy 2: Create multiple copies with random distribution</span></span><br><span class="line">        original_data = <span class="variable language_">self</span>.redis.get(key)</span><br><span class="line">        <span class="keyword">if</span> original_data:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):  <span class="comment"># Create 3 copies</span></span><br><span class="line">                copy_key = <span class="string">f&quot;<span class="subst">&#123;key&#125;</span>:copy:<span class="subst">&#123;i&#125;</span>&quot;</span></span><br><span class="line">                <span class="variable language_">self</span>.redis.setex(copy_key, <span class="number">300</span>, original_data)  <span class="comment"># 5 min TTL</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Strategy 3: Use read replicas (if available)</span></span><br><span class="line">        <span class="comment"># This would involve routing reads to replica nodes</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_distributed_hot_key</span>(<span class="params">self, key: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get hot key data using distribution strategy&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> <span class="variable language_">self</span>.hot_keys:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.redis.get(key)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Random selection from copies</span></span><br><span class="line">        <span class="keyword">import</span> random</span><br><span class="line">        copy_index = random.randint(<span class="number">0</span>, <span class="number">2</span>)</span><br><span class="line">        copy_key = <span class="string">f&quot;<span class="subst">&#123;key&#125;</span>:copy:<span class="subst">&#123;copy_index&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        data = <span class="variable language_">self</span>.redis.get(copy_key)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            <span class="comment"># Fallback to original</span></span><br><span class="line">            data = <span class="variable language_">self</span>.redis.get(key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure>

<p><strong>🎯 Interview Insight</strong>: <em>Hot key problems are common in production. Discuss identification techniques (monitoring access patterns), mitigation strategies (local caching, key distribution), and prevention approaches (better key design, load balancing).</em></p>
<h2 id="Monitoring-and-Troubleshooting"><a href="#Monitoring-and-Troubleshooting" class="headerlink" title="Monitoring and Troubleshooting"></a>Monitoring and Troubleshooting</h2><h3 id="1-Performance-Monitoring"><a href="#1-Performance-Monitoring" class="headerlink" title="1. Performance Monitoring"></a>1. Performance Monitoring</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RedisMonitor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.metrics = &#123;</span><br><span class="line">            <span class="string">&#x27;hits&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;misses&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;errors&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;total_requests&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;total_latency&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;slow_queries&#x27;</span>: <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">self</span>.slow_query_threshold = <span class="number">0.1</span>  <span class="comment"># 100ms</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Setup logging</span></span><br><span class="line">        <span class="variable language_">self</span>.logger = logging.getLogger(<span class="string">&#x27;redis_monitor&#x27;</span>)</span><br><span class="line">        handler = logging.StreamHandler()</span><br><span class="line">        formatter = logging.Formatter(</span><br><span class="line">            <span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        handler.setFormatter(formatter)</span><br><span class="line">        <span class="variable language_">self</span>.logger.addHandler(handler)</span><br><span class="line">        <span class="variable language_">self</span>.logger.setLevel(logging.INFO)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">monitor_operation</span>(<span class="params">self, operation_name=<span class="string">&#x27;redis_op&#x27;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Decorator to monitor Redis operations&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">decorator</span>(<span class="params">func</span>):</span><br><span class="line"><span class="meta">            @wraps(<span class="params">func</span>)</span></span><br><span class="line">            <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">                start_time = time.time()</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    result = func(*args, **kwargs)</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># Track hit/miss</span></span><br><span class="line">                    <span class="keyword">if</span> result <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                        <span class="variable language_">self</span>.metrics[<span class="string">&#x27;hits&#x27;</span>] += <span class="number">1</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="variable language_">self</span>.metrics[<span class="string">&#x27;misses&#x27;</span>] += <span class="number">1</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">return</span> result</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    <span class="variable language_">self</span>.metrics[<span class="string">&#x27;errors&#x27;</span>] += <span class="number">1</span></span><br><span class="line">                    <span class="variable language_">self</span>.logger.error(<span class="string">f&quot;Redis operation failed: <span class="subst">&#123;operation_name&#125;</span> - <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="keyword">raise</span></span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">finally</span>:</span><br><span class="line">                    <span class="comment"># Track latency</span></span><br><span class="line">                    end_time = time.time()</span><br><span class="line">                    latency = end_time - start_time</span><br><span class="line">                    <span class="variable language_">self</span>.metrics[<span class="string">&#x27;total_requests&#x27;</span>] += <span class="number">1</span></span><br><span class="line">                    <span class="variable language_">self</span>.metrics[<span class="string">&#x27;total_latency&#x27;</span>] += latency</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># Log slow queries</span></span><br><span class="line">                    <span class="keyword">if</span> latency &gt; <span class="variable language_">self</span>.slow_query_threshold:</span><br><span class="line">                        <span class="variable language_">self</span>.metrics[<span class="string">&#x27;slow_queries&#x27;</span>] += <span class="number">1</span></span><br><span class="line">                        <span class="variable language_">self</span>.logger.warning(</span><br><span class="line">                            <span class="string">f&quot;Slow Redis operation: <span class="subst">&#123;operation_name&#125;</span> - <span class="subst">&#123;latency:<span class="number">.3</span>f&#125;</span>s&quot;</span></span><br><span class="line">                        )</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> wrapper</span><br><span class="line">        <span class="keyword">return</span> decorator</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @monitor_operation(<span class="params"><span class="string">&#x27;get&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">monitored_get</span>(<span class="params">self, key: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.redis.get(key)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @monitor_operation(<span class="params"><span class="string">&#x27;set&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">monitored_set</span>(<span class="params">self, key: <span class="built_in">str</span>, value: <span class="built_in">str</span>, ex: <span class="built_in">int</span> = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.redis.<span class="built_in">set</span>(key, value, ex=ex)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_performance_stats</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get current performance statistics&quot;&quot;&quot;</span></span><br><span class="line">        total_requests = <span class="variable language_">self</span>.metrics[<span class="string">&#x27;total_requests&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> total_requests == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;No requests recorded&#x27;</span>&#125;</span><br><span class="line">        </span><br><span class="line">        hit_rate = <span class="variable language_">self</span>.metrics[<span class="string">&#x27;hits&#x27;</span>] / total_requests * <span class="number">100</span></span><br><span class="line">        avg_latency = <span class="variable language_">self</span>.metrics[<span class="string">&#x27;total_latency&#x27;</span>] / total_requests * <span class="number">1000</span>  <span class="comment"># ms</span></span><br><span class="line">        error_rate = <span class="variable language_">self</span>.metrics[<span class="string">&#x27;errors&#x27;</span>] / total_requests * <span class="number">100</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;hit_rate&#x27;</span>: <span class="string">f&quot;<span class="subst">&#123;hit_rate:<span class="number">.2</span>f&#125;</span>%&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;miss_rate&#x27;</span>: <span class="string">f&quot;<span class="subst">&#123;<span class="number">100</span> - hit_rate:<span class="number">.2</span>f&#125;</span>%&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;error_rate&#x27;</span>: <span class="string">f&quot;<span class="subst">&#123;error_rate:<span class="number">.2</span>f&#125;</span>%&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;avg_latency_ms&#x27;</span>: <span class="string">f&quot;<span class="subst">&#123;avg_latency:<span class="number">.2</span>f&#125;</span>&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;total_requests&#x27;</span>: total_requests,</span><br><span class="line">            <span class="string">&#x27;slow_queries&#x27;</span>: <span class="variable language_">self</span>.metrics[<span class="string">&#x27;slow_queries&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;slow_query_rate&#x27;</span>: <span class="string">f&quot;<span class="subst">&#123;self.metrics[<span class="string">&#x27;slow_queries&#x27;</span>] / total_requests * <span class="number">100</span>:<span class="number">.2</span>f&#125;</span>%&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_redis_info</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get Redis server information&quot;&quot;&quot;</span></span><br><span class="line">        info = <span class="variable language_">self</span>.redis.info()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;version&#x27;</span>: info.get(<span class="string">&#x27;redis_version&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;uptime&#x27;</span>: info.get(<span class="string">&#x27;uptime_in_seconds&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;connected_clients&#x27;</span>: info.get(<span class="string">&#x27;connected_clients&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;used_memory&#x27;</span>: info.get(<span class="string">&#x27;used_memory_human&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;used_memory_peak&#x27;</span>: info.get(<span class="string">&#x27;used_memory_peak_human&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;keyspace_hits&#x27;</span>: info.get(<span class="string">&#x27;keyspace_hits&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;keyspace_misses&#x27;</span>: info.get(<span class="string">&#x27;keyspace_misses&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;expired_keys&#x27;</span>: info.get(<span class="string">&#x27;expired_keys&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;evicted_keys&#x27;</span>: info.get(<span class="string">&#x27;evicted_keys&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">health_check</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Comprehensive health check&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># Test basic connectivity</span></span><br><span class="line">            start_time = time.time()</span><br><span class="line">            ping_result = <span class="variable language_">self</span>.redis.ping()</span><br><span class="line">            ping_latency = (time.time() - start_time) * <span class="number">1000</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Get memory info</span></span><br><span class="line">            info = <span class="variable language_">self</span>.redis.info(<span class="string">&#x27;memory&#x27;</span>)</span><br><span class="line">            used_memory_pct = (info[<span class="string">&#x27;used_memory&#x27;</span>] / info[<span class="string">&#x27;maxmemory&#x27;</span>] * <span class="number">100</span> </span><br><span class="line">                             <span class="keyword">if</span> info.get(<span class="string">&#x27;maxmemory&#x27;</span>, <span class="number">0</span>) &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Check for concerning patterns</span></span><br><span class="line">            warnings = []</span><br><span class="line">            <span class="keyword">if</span> ping_latency &gt; <span class="number">10</span>:  <span class="comment"># 10ms</span></span><br><span class="line">                warnings.append(<span class="string">f&quot;High ping latency: <span class="subst">&#123;ping_latency:<span class="number">.2</span>f&#125;</span>ms&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> used_memory_pct &gt; <span class="number">80</span>:</span><br><span class="line">                warnings.append(<span class="string">f&quot;High memory usage: <span class="subst">&#123;used_memory_pct:<span class="number">.1</span>f&#125;</span>%&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.metrics[<span class="string">&#x27;errors&#x27;</span>] &gt; <span class="variable language_">self</span>.metrics[<span class="string">&#x27;total_requests&#x27;</span>] * <span class="number">0.01</span>:  <span class="comment"># &gt;1% error rate</span></span><br><span class="line">                warnings.append(<span class="string">&quot;High error rate detected&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;status&#x27;</span>: <span class="string">&#x27;healthy&#x27;</span> <span class="keyword">if</span> <span class="keyword">not</span> warnings <span class="keyword">else</span> <span class="string">&#x27;warning&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;ping_latency_ms&#x27;</span>: <span class="string">f&quot;<span class="subst">&#123;ping_latency:<span class="number">.2</span>f&#125;</span>&quot;</span>,</span><br><span class="line">                <span class="string">&#x27;memory_usage_pct&#x27;</span>: <span class="string">f&quot;<span class="subst">&#123;used_memory_pct:<span class="number">.1</span>f&#125;</span>%&quot;</span>,</span><br><span class="line">                <span class="string">&#x27;warnings&#x27;</span>: warnings,</span><br><span class="line">                <span class="string">&#x27;performance_stats&#x27;</span>: <span class="variable language_">self</span>.get_performance_stats()</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;status&#x27;</span>: <span class="string">&#x27;unhealthy&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;error&#x27;</span>: <span class="built_in">str</span>(e)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage example</span></span><br><span class="line">monitor = RedisMonitor()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use monitored operations</span></span><br><span class="line">data = monitor.monitored_get(<span class="string">&quot;user:123&quot;</span>)</span><br><span class="line">monitor.monitored_set(<span class="string">&quot;user:123&quot;</span>, json.dumps(&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;John&quot;</span>&#125;), ex=<span class="number">3600</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check performance</span></span><br><span class="line"><span class="built_in">print</span>(monitor.get_performance_stats())</span><br><span class="line"><span class="built_in">print</span>(monitor.health_check())</span><br></pre></td></tr></table></figure>

<h3 id="2-Advanced-Debugging-and-Profiling"><a href="#2-Advanced-Debugging-and-Profiling" class="headerlink" title="2. Advanced Debugging and Profiling"></a>2. Advanced Debugging and Profiling</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RedisDebugger</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.command_history = deque(maxlen=<span class="number">1000</span>)  <span class="comment"># Keep last 1000 commands</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">debug_key_access_pattern</span>(<span class="params">self, key_pattern: <span class="built_in">str</span>, duration: <span class="built_in">int</span> = <span class="number">60</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Monitor access patterns for keys matching a pattern&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Monitoring key pattern: <span class="subst">&#123;key_pattern&#125;</span> for <span class="subst">&#123;duration&#125;</span> seconds&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Use Redis MONITOR command (use with caution in production)</span></span><br><span class="line">        pubsub = <span class="variable language_">self</span>.redis.pubsub()</span><br><span class="line">        </span><br><span class="line">        access_stats = defaultdict(<span class="built_in">int</span>)</span><br><span class="line">        start_time = time.time()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># Note: MONITOR is expensive and should not be used in production</span></span><br><span class="line">            <span class="comment"># This is for debugging purposes only</span></span><br><span class="line">            <span class="keyword">with</span> <span class="variable language_">self</span>.redis.monitor() <span class="keyword">as</span> monitor:</span><br><span class="line">                <span class="keyword">for</span> command <span class="keyword">in</span> monitor.listen():</span><br><span class="line">                    <span class="keyword">if</span> time.time() - start_time &gt; duration:</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> command[<span class="string">&#x27;command&#x27;</span>]:</span><br><span class="line">                        cmd_parts = command[<span class="string">&#x27;command&#x27;</span>].split()</span><br><span class="line">                        <span class="keyword">if</span> <span class="built_in">len</span>(cmd_parts) &gt;= <span class="number">2</span>:</span><br><span class="line">                            operation = cmd_parts[<span class="number">0</span>].upper()</span><br><span class="line">                            key = cmd_parts[<span class="number">1</span>]</span><br><span class="line">                            </span><br><span class="line">                            <span class="keyword">if</span> key_pattern <span class="keyword">in</span> key:</span><br><span class="line">                                access_stats[<span class="string">f&quot;<span class="subst">&#123;operation&#125;</span>:<span class="subst">&#123;key&#125;</span>&quot;</span>] += <span class="number">1</span></span><br><span class="line">                                </span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Analyze patterns</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\nAccess Pattern Analysis:&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> pattern, count <span class="keyword">in</span> <span class="built_in">sorted</span>(access_stats.items(), key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;pattern&#125;</span>: <span class="subst">&#123;count&#125;</span> accesses&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> access_stats</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">analyze_memory_usage</span>(<span class="params">self, sample_size: <span class="built_in">int</span> = <span class="number">100</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Analyze memory usage of different key patterns&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        memory_stats = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Get random sample of keys</span></span><br><span class="line">        keys = []</span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> <span class="variable language_">self</span>.redis.scan_iter(count=sample_size):</span><br><span class="line">            keys.append(key.decode())</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Analyzing memory usage for <span class="subst">&#123;<span class="built_in">len</span>(keys)&#125;</span> keys...&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> keys:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># Get memory usage for this key</span></span><br><span class="line">                memory_usage = <span class="variable language_">self</span>.redis.memory_usage(key)</span><br><span class="line">                key_type = <span class="variable language_">self</span>.redis.<span class="built_in">type</span>(key).decode()</span><br><span class="line">                </span><br><span class="line">                pattern = <span class="variable language_">self</span>._extract_key_pattern(key)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> pattern <span class="keyword">not</span> <span class="keyword">in</span> memory_stats:</span><br><span class="line">                    memory_stats[pattern] = &#123;</span><br><span class="line">                        <span class="string">&#x27;total_memory&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">                        <span class="string">&#x27;count&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">                        <span class="string">&#x27;avg_memory&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">                        <span class="string">&#x27;type&#x27;</span>: key_type</span><br><span class="line">                    &#125;</span><br><span class="line">                </span><br><span class="line">                memory_stats[pattern][<span class="string">&#x27;total_memory&#x27;</span>] += memory_usage</span><br><span class="line">                memory_stats[pattern][<span class="string">&#x27;count&#x27;</span>] += <span class="number">1</span></span><br><span class="line">                memory_stats[pattern][<span class="string">&#x27;avg_memory&#x27;</span>] = (</span><br><span class="line">                    memory_stats[pattern][<span class="string">&#x27;total_memory&#x27;</span>] / </span><br><span class="line">                    memory_stats[pattern][<span class="string">&#x27;count&#x27;</span>]</span><br><span class="line">                )</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Error analyzing key <span class="subst">&#123;key&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Sort by total memory usage</span></span><br><span class="line">        sorted_stats = <span class="built_in">sorted</span>(</span><br><span class="line">            memory_stats.items(), </span><br><span class="line">            key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>][<span class="string">&#x27;total_memory&#x27;</span>], </span><br><span class="line">            reverse=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\nMemory Usage Analysis:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;<span class="string">&#x27;Pattern&#x27;</span>:&lt;<span class="number">30</span>&#125;</span> <span class="subst">&#123;<span class="string">&#x27;Type&#x27;</span>:&lt;<span class="number">10</span>&#125;</span> <span class="subst">&#123;<span class="string">&#x27;Count&#x27;</span>:&lt;<span class="number">8</span>&#125;</span> <span class="subst">&#123;<span class="string">&#x27;Total (bytes)&#x27;</span>:&lt;<span class="number">15</span>&#125;</span> <span class="subst">&#123;<span class="string">&#x27;Avg (bytes)&#x27;</span>:&lt;<span class="number">12</span>&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">85</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> pattern, stats <span class="keyword">in</span> sorted_stats:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;pattern:&lt;<span class="number">30</span>&#125;</span> <span class="subst">&#123;stats[<span class="string">&#x27;type&#x27;</span>]:&lt;<span class="number">10</span>&#125;</span> <span class="subst">&#123;stats[<span class="string">&#x27;count&#x27;</span>]:&lt;<span class="number">8</span>&#125;</span> &quot;</span></span><br><span class="line">                  <span class="string">f&quot;<span class="subst">&#123;stats[<span class="string">&#x27;total_memory&#x27;</span>]:&lt;<span class="number">15</span>&#125;</span> <span class="subst">&#123;stats[<span class="string">&#x27;avg_memory&#x27;</span>]:&lt;<span class="number">12.1</span>f&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> memory_stats</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_extract_key_pattern</span>(<span class="params">self, key: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Extract pattern from key (e.g., user:123 -&gt; user:*&quot;&quot;&quot;</span></span><br><span class="line">        parts = key.split(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(parts) &gt; <span class="number">1</span>:</span><br><span class="line">            <span class="comment"># Replace numeric parts with *</span></span><br><span class="line">            pattern_parts = []</span><br><span class="line">            <span class="keyword">for</span> part <span class="keyword">in</span> parts:</span><br><span class="line">                <span class="keyword">if</span> part.isdigit():</span><br><span class="line">                    pattern_parts.append(<span class="string">&#x27;*&#x27;</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    pattern_parts.append(part)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;:&#x27;</span>.join(pattern_parts)</span><br><span class="line">        <span class="keyword">return</span> key</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_large_keys</span>(<span class="params">self, threshold_bytes: <span class="built_in">int</span> = <span class="number">1024</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Find keys that consume more memory than threshold&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        large_keys = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> <span class="variable language_">self</span>.redis.scan_iter():</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                key_str = key.decode()</span><br><span class="line">                memory_usage = <span class="variable language_">self</span>.redis.memory_usage(key)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> memory_usage &gt; threshold_bytes:</span><br><span class="line">                    key_info = &#123;</span><br><span class="line">                        <span class="string">&#x27;key&#x27;</span>: key_str,</span><br><span class="line">                        <span class="string">&#x27;memory_bytes&#x27;</span>: memory_usage,</span><br><span class="line">                        <span class="string">&#x27;type&#x27;</span>: <span class="variable language_">self</span>.redis.<span class="built_in">type</span>(key).decode(),</span><br><span class="line">                        <span class="string">&#x27;ttl&#x27;</span>: <span class="variable language_">self</span>.redis.ttl(key)</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># Additional info based on type</span></span><br><span class="line">                    key_type = key_info[<span class="string">&#x27;type&#x27;</span>]</span><br><span class="line">                    <span class="keyword">if</span> key_type == <span class="string">&#x27;string&#x27;</span>:</span><br><span class="line">                        key_info[<span class="string">&#x27;length&#x27;</span>] = <span class="variable language_">self</span>.redis.strlen(key)</span><br><span class="line">                    <span class="keyword">elif</span> key_type == <span class="string">&#x27;list&#x27;</span>:</span><br><span class="line">                        key_info[<span class="string">&#x27;length&#x27;</span>] = <span class="variable language_">self</span>.redis.llen(key)</span><br><span class="line">                    <span class="keyword">elif</span> key_type == <span class="string">&#x27;set&#x27;</span>:</span><br><span class="line">                        key_info[<span class="string">&#x27;length&#x27;</span>] = <span class="variable language_">self</span>.redis.scard(key)</span><br><span class="line">                    <span class="keyword">elif</span> key_type == <span class="string">&#x27;hash&#x27;</span>:</span><br><span class="line">                        key_info[<span class="string">&#x27;length&#x27;</span>] = <span class="variable language_">self</span>.redis.hlen(key)</span><br><span class="line">                    <span class="keyword">elif</span> key_type == <span class="string">&#x27;zset&#x27;</span>:</span><br><span class="line">                        key_info[<span class="string">&#x27;length&#x27;</span>] = <span class="variable language_">self</span>.redis.zcard(key)</span><br><span class="line">                    </span><br><span class="line">                    large_keys.append(key_info)</span><br><span class="line">                    </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Error checking key <span class="subst">&#123;key&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Sort by memory usage</span></span><br><span class="line">        large_keys.sort(key=<span class="keyword">lambda</span> x: x[<span class="string">&#x27;memory_bytes&#x27;</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\nFound <span class="subst">&#123;<span class="built_in">len</span>(large_keys)&#125;</span> keys larger than <span class="subst">&#123;threshold_bytes&#125;</span> bytes:&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> key_info <span class="keyword">in</span> large_keys[:<span class="number">10</span>]:  <span class="comment"># Show top 10</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Key: <span class="subst">&#123;key_info[<span class="string">&#x27;key&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  Memory: <span class="subst">&#123;key_info[<span class="string">&#x27;memory_bytes&#x27;</span>]&#125;</span> bytes&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  Type: <span class="subst">&#123;key_info[<span class="string">&#x27;type&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  Length: <span class="subst">&#123;key_info.get(<span class="string">&#x27;length&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  TTL: <span class="subst">&#123;key_info[<span class="string">&#x27;ttl&#x27;</span>]&#125;</span> seconds&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> large_keys</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">connection_pool_stats</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get connection pool statistics&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(<span class="variable language_">self</span>.redis, <span class="string">&#x27;connection_pool&#x27;</span>):</span><br><span class="line">            pool = <span class="variable language_">self</span>.redis.connection_pool</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;created_connections&#x27;</span>: pool.created_connections,</span><br><span class="line">                <span class="string">&#x27;available_connections&#x27;</span>: <span class="built_in">len</span>(pool._available_connections),</span><br><span class="line">                <span class="string">&#x27;in_use_connections&#x27;</span>: <span class="built_in">len</span>(pool._in_use_connections),</span><br><span class="line">                <span class="string">&#x27;max_connections&#x27;</span>: pool.max_connections</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;Connection pool info not available&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage example</span></span><br><span class="line">debugger = RedisDebugger()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Analyze memory usage</span></span><br><span class="line">memory_stats = debugger.analyze_memory_usage(sample_size=<span class="number">500</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Find large keys</span></span><br><span class="line">large_keys = debugger.find_large_keys(threshold_bytes=<span class="number">10240</span>)  <span class="comment"># 10KB threshold</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Check connection pool</span></span><br><span class="line">pool_stats = debugger.connection_pool_stats()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Connection pool stats: <span class="subst">&#123;pool_stats&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>🎯 Interview Insight</strong>: <em>Debugging questions often focus on production issues. Discuss tools like Redis MONITOR (and its performance impact), MEMORY USAGE command, and the importance of having proper monitoring in place before issues occur.</em></p>
<h2 id="Production-Best-Practices"><a href="#Production-Best-Practices" class="headerlink" title="Production Best Practices"></a>Production Best Practices</h2><h3 id="1-High-Availability-Setup"><a href="#1-High-Availability-Setup" class="headerlink" title="1. High Availability Setup"></a>1. High Availability Setup</h3><pre>
<code class="mermaid">
graph TB
subgraph &quot;Redis Sentinel Cluster&quot;
    S1[Sentinel 1]
    S2[Sentinel 2] 
    S3[Sentinel 3]
end

subgraph &quot;Redis Instances&quot;
    M[Master]
    R1[Replica 1]
    R2[Replica 2]
end

subgraph &quot;Application Layer&quot;
    A1[App Instance 1]
    A2[App Instance 2]
    A3[App Instance 3]
end

S1 -.-&gt; M
S1 -.-&gt; R1
S1 -.-&gt; R2
S2 -.-&gt; M
S2 -.-&gt; R1
S2 -.-&gt; R2
S3 -.-&gt; M
S3 -.-&gt; R1
S3 -.-&gt; R2

A1 --&gt; S1
A2 --&gt; S2
A3 --&gt; S3

M --&gt; R1
M --&gt; R2

style M fill:#ff6b6b
style R1 fill:#4ecdc4
style R2 fill:#4ecdc4
style S1 fill:#ffe66d
style S2 fill:#ffe66d
style S3 fill:#ffe66d
</code>
</pre>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis.sentinel</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HighAvailabilityRedisClient</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Redis Sentinel configuration</span></span><br><span class="line">        <span class="variable language_">self</span>.sentinels = [</span><br><span class="line">            (<span class="string">&#x27;sentinel1.example.com&#x27;</span>, <span class="number">26379</span>),</span><br><span class="line">            (<span class="string">&#x27;sentinel2.example.com&#x27;</span>, <span class="number">26379</span>),</span><br><span class="line">            (<span class="string">&#x27;sentinel3.example.com&#x27;</span>, <span class="number">26379</span>)</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.sentinel = redis.sentinel.Sentinel(</span><br><span class="line">            <span class="variable language_">self</span>.sentinels,</span><br><span class="line">            socket_timeout=<span class="number">0.5</span>,</span><br><span class="line">            socket_connect_timeout=<span class="number">0.5</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.master_name = <span class="string">&#x27;mymaster&#x27;</span></span><br><span class="line">        <span class="variable language_">self</span>.master = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.slaves = []</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>._initialize_connections()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_initialize_connections</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Initialize master and slave connections&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># Get master connection</span></span><br><span class="line">            <span class="variable language_">self</span>.master = <span class="variable language_">self</span>.sentinel.master_for(</span><br><span class="line">                <span class="variable language_">self</span>.master_name,</span><br><span class="line">                socket_timeout=<span class="number">0.5</span>,</span><br><span class="line">                socket_connect_timeout=<span class="number">0.5</span>,</span><br><span class="line">                retry_on_timeout=<span class="literal">True</span>,</span><br><span class="line">                db=<span class="number">0</span></span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Get slave connections for read operations</span></span><br><span class="line">            <span class="variable language_">self</span>.slave = <span class="variable language_">self</span>.sentinel.slave_for(</span><br><span class="line">                <span class="variable language_">self</span>.master_name,</span><br><span class="line">                socket_timeout=<span class="number">0.5</span>,</span><br><span class="line">                socket_connect_timeout=<span class="number">0.5</span>,</span><br><span class="line">                retry_on_timeout=<span class="literal">True</span>,</span><br><span class="line">                db=<span class="number">0</span></span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Redis HA connections initialized successfully&quot;</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Failed to initialize Redis HA connections: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, key: <span class="built_in">str</span>, use_slave: <span class="built_in">bool</span> = <span class="literal">True</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get data, optionally from slave for read scaling&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> use_slave <span class="keyword">and</span> <span class="variable language_">self</span>.slave:</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">self</span>.slave.get(key)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">self</span>.master.get(key)</span><br><span class="line">        <span class="keyword">except</span> redis.ConnectionError:</span><br><span class="line">            <span class="comment"># Failover handling</span></span><br><span class="line">            <span class="variable language_">self</span>._handle_connection_error()</span><br><span class="line">            <span class="comment"># Retry with master</span></span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.master.get(key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set</span>(<span class="params">self, key: <span class="built_in">str</span>, value: <span class="built_in">str</span>, ex: <span class="built_in">int</span> = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Set data (always use master for writes)&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.master.<span class="built_in">set</span>(key, value, ex=ex)</span><br><span class="line">        <span class="keyword">except</span> redis.ConnectionError:</span><br><span class="line">            <span class="variable language_">self</span>._handle_connection_error()</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.master.<span class="built_in">set</span>(key, value, ex=ex)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_handle_connection_error</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Handle connection errors and potential failover&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Redis connection error detected, reinitializing connections...&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>._initialize_connections()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Failed to reinitialize connections: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">health_check</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Check health of Redis cluster&quot;&quot;&quot;</span></span><br><span class="line">        health_status = &#123;</span><br><span class="line">            <span class="string">&#x27;master_available&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">            <span class="string">&#x27;slaves_available&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;sentinel_status&#x27;</span>: [],</span><br><span class="line">            <span class="string">&#x27;overall_status&#x27;</span>: <span class="string">&#x27;unhealthy&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Check master</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>.master.ping()</span><br><span class="line">            health_status[<span class="string">&#x27;master_available&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Check slaves</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>.slave.ping()</span><br><span class="line">            health_status[<span class="string">&#x27;slaves_available&#x27;</span>] = <span class="number">1</span>  <span class="comment"># Simplified</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Check sentinels</span></span><br><span class="line">        <span class="keyword">for</span> sentinel_host, sentinel_port <span class="keyword">in</span> <span class="variable language_">self</span>.sentinels:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                sentinel_conn = redis.Redis(host=sentinel_host, port=sentinel_port)</span><br><span class="line">                sentinel_conn.ping()</span><br><span class="line">                health_status[<span class="string">&#x27;sentinel_status&#x27;</span>].append(&#123;</span><br><span class="line">                    <span class="string">&#x27;host&#x27;</span>: sentinel_host,</span><br><span class="line">                    <span class="string">&#x27;port&#x27;</span>: sentinel_port,</span><br><span class="line">                    <span class="string">&#x27;status&#x27;</span>: <span class="string">&#x27;healthy&#x27;</span></span><br><span class="line">                &#125;)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                health_status[<span class="string">&#x27;sentinel_status&#x27;</span>].append(&#123;</span><br><span class="line">                    <span class="string">&#x27;host&#x27;</span>: sentinel_host,</span><br><span class="line">                    <span class="string">&#x27;port&#x27;</span>: sentinel_port,</span><br><span class="line">                    <span class="string">&#x27;status&#x27;</span>: <span class="string">&#x27;unhealthy&#x27;</span></span><br><span class="line">                &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Determine overall status</span></span><br><span class="line">        healthy_sentinels = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> s <span class="keyword">in</span> health_status[<span class="string">&#x27;sentinel_status&#x27;</span>] </span><br><span class="line">                              <span class="keyword">if</span> s[<span class="string">&#x27;status&#x27;</span>] == <span class="string">&#x27;healthy&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (health_status[<span class="string">&#x27;master_available&#x27;</span>] <span class="keyword">and</span> </span><br><span class="line">            healthy_sentinels &gt;= <span class="number">2</span>):  <span class="comment"># Quorum</span></span><br><span class="line">            health_status[<span class="string">&#x27;overall_status&#x27;</span>] = <span class="string">&#x27;healthy&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> healthy_sentinels &gt;= <span class="number">2</span>:</span><br><span class="line">            health_status[<span class="string">&#x27;overall_status&#x27;</span>] = <span class="string">&#x27;degraded&#x27;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> health_status</span><br></pre></td></tr></table></figure>

<h3 id="2-Security-Best-Practices"><a href="#2-Security-Best-Practices" class="headerlink" title="2. Security Best Practices"></a>2. Security Best Practices</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> hmac</span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"><span class="keyword">from</span> cryptography.fernet <span class="keyword">import</span> Fernet</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SecureRedisClient</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># SSL/TLS configuration</span></span><br><span class="line">        <span class="variable language_">self</span>.redis = redis.Redis(</span><br><span class="line">            host=<span class="string">&#x27;redis.example.com&#x27;</span>,</span><br><span class="line">            port=<span class="number">6380</span>,  <span class="comment"># TLS port</span></span><br><span class="line">            password=<span class="string">&#x27;your-strong-password&#x27;</span>,</span><br><span class="line">            ssl=<span class="literal">True</span>,</span><br><span class="line">            ssl_cert_reqs=ssl.CERT_REQUIRED,</span><br><span class="line">            ssl_ca_certs=<span class="string">&#x27;/path/to/ca-cert.pem&#x27;</span>,</span><br><span class="line">            ssl_certfile=<span class="string">&#x27;/path/to/client-cert.pem&#x27;</span>,</span><br><span class="line">            ssl_keyfile=<span class="string">&#x27;/path/to/client-key.pem&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Encryption for sensitive data</span></span><br><span class="line">        <span class="variable language_">self</span>.encryption_key = Fernet.generate_key()</span><br><span class="line">        <span class="variable language_">self</span>.cipher = Fernet(<span class="variable language_">self</span>.encryption_key)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Rate limiting</span></span><br><span class="line">        <span class="variable language_">self</span>.rate_limiter = RateLimiter()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_encrypted</span>(<span class="params">self, key: <span class="built_in">str</span>, value: <span class="built_in">str</span>, ex: <span class="built_in">int</span> = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Store encrypted data&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Encrypt sensitive data</span></span><br><span class="line">        encrypted_value = <span class="variable language_">self</span>.cipher.encrypt(value.encode())</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Add integrity check</span></span><br><span class="line">        checksum = hashlib.sha256(value.encode()).hexdigest()</span><br><span class="line">        </span><br><span class="line">        data_with_checksum = &#123;</span><br><span class="line">            <span class="string">&#x27;data&#x27;</span>: encrypted_value.decode(),</span><br><span class="line">            <span class="string">&#x27;checksum&#x27;</span>: checksum</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.redis.<span class="built_in">set</span>(key, json.dumps(data_with_checksum), ex=ex)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_encrypted</span>(<span class="params">self, key: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Retrieve and decrypt data&quot;&quot;&quot;</span></span><br><span class="line">        encrypted_data = <span class="variable language_">self</span>.redis.get(key)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> encrypted_data:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data_dict = json.loads(encrypted_data)</span><br><span class="line">            encrypted_value = data_dict[<span class="string">&#x27;data&#x27;</span>].encode()</span><br><span class="line">            stored_checksum = data_dict[<span class="string">&#x27;checksum&#x27;</span>]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Decrypt</span></span><br><span class="line">            decrypted_value = <span class="variable language_">self</span>.cipher.decrypt(encrypted_value).decode()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Verify integrity</span></span><br><span class="line">            computed_checksum = hashlib.sha256(decrypted_value.encode()).hexdigest()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> hmac.compare_digest(stored_checksum, computed_checksum):</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&quot;Data integrity check failed&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> decrypted_value</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Failed to decrypt data: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">secure_session_management</span>(<span class="params">self, session_id: <span class="built_in">str</span>, user_id: <span class="built_in">int</span>, </span></span><br><span class="line"><span class="params">                                 session_data: <span class="type">Dict</span>, ttl: <span class="built_in">int</span> = <span class="number">3600</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Secure session management with Redis&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Create secure session key</span></span><br><span class="line">        session_key = <span class="string">f&quot;session:<span class="subst">&#123;hashlib.sha256(session_id.encode()).hexdigest()&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Session data with security metadata</span></span><br><span class="line">        secure_session_data = &#123;</span><br><span class="line">            <span class="string">&#x27;user_id&#x27;</span>: user_id,</span><br><span class="line">            <span class="string">&#x27;created_at&#x27;</span>: time.time(),</span><br><span class="line">            <span class="string">&#x27;ip_address&#x27;</span>: session_data.get(<span class="string">&#x27;ip_address&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;user_agent_hash&#x27;</span>: hashlib.sha256(</span><br><span class="line">                session_data.get(<span class="string">&#x27;user_agent&#x27;</span>, <span class="string">&#x27;&#x27;</span>).encode()</span><br><span class="line">            ).hexdigest(),</span><br><span class="line">            <span class="string">&#x27;data&#x27;</span>: session_data.get(<span class="string">&#x27;data&#x27;</span>, &#123;&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Store encrypted session</span></span><br><span class="line">        <span class="variable language_">self</span>.set_encrypted(session_key, json.dumps(secure_session_data), ex=ttl)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Track active sessions for user</span></span><br><span class="line">        user_sessions_key = <span class="string">f&quot;user_sessions:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.redis.sadd(user_sessions_key, session_key)</span><br><span class="line">        <span class="variable language_">self</span>.redis.expire(user_sessions_key, ttl)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> session_key</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">validate_session</span>(<span class="params">self, session_id: <span class="built_in">str</span>, ip_address: <span class="built_in">str</span>, </span></span><br><span class="line"><span class="params">                        user_agent: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Validate session with security checks&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        session_key = <span class="string">f&quot;session:<span class="subst">&#123;hashlib.sha256(session_id.encode()).hexdigest()&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        session_data_str = <span class="variable language_">self</span>.get_encrypted(session_key)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> session_data_str:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            session_data = json.loads(session_data_str)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Security validations</span></span><br><span class="line">            user_agent_hash = hashlib.sha256(user_agent.encode()).hexdigest()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> session_data.get(<span class="string">&#x27;user_agent_hash&#x27;</span>) != user_agent_hash:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Session validation failed: User agent mismatch&quot;</span>)</span><br><span class="line">                <span class="variable language_">self</span>.invalidate_session(session_id)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Optional: IP address validation (be careful with load balancers)</span></span><br><span class="line">            <span class="keyword">if</span> session_data.get(<span class="string">&#x27;ip_address&#x27;</span>) != ip_address:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Session validation failed: IP address changed&quot;</span>)</span><br><span class="line">                <span class="comment"># You might want to require re-authentication instead of invalidating</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> session_data</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Session validation error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">invalidate_session</span>(<span class="params">self, session_id: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Securely invalidate a session&quot;&quot;&quot;</span></span><br><span class="line">        session_key = <span class="string">f&quot;session:<span class="subst">&#123;hashlib.sha256(session_id.encode()).hexdigest()&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Get user ID before deleting session</span></span><br><span class="line">        session_data_str = <span class="variable language_">self</span>.get_encrypted(session_key)</span><br><span class="line">        <span class="keyword">if</span> session_data_str:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                session_data = json.loads(session_data_str)</span><br><span class="line">                user_id = session_data.get(<span class="string">&#x27;user_id&#x27;</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># Remove from user&#x27;s active sessions</span></span><br><span class="line">                <span class="keyword">if</span> user_id:</span><br><span class="line">                    user_sessions_key = <span class="string">f&quot;user_sessions:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">                    <span class="variable language_">self</span>.redis.srem(user_sessions_key, session_key)</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Error during session cleanup: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Delete the session</span></span><br><span class="line">        <span class="variable language_">self</span>.redis.delete(session_key)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RateLimiter</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis_client</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_allowed</span>(<span class="params">self, identifier: <span class="built_in">str</span>, limit: <span class="built_in">int</span>, window: <span class="built_in">int</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Sliding window rate limiter&quot;&quot;&quot;</span></span><br><span class="line">        current_time = <span class="built_in">int</span>(time.time())</span><br><span class="line">        window_start = current_time - window</span><br><span class="line">        </span><br><span class="line">        key = <span class="string">f&quot;rate_limit:<span class="subst">&#123;identifier&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Remove old entries</span></span><br><span class="line">        <span class="variable language_">self</span>.redis.zremrangebyscore(key, <span class="number">0</span>, window_start)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Count current requests</span></span><br><span class="line">        current_requests = <span class="variable language_">self</span>.redis.zcard(key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> current_requests &gt;= limit:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Add current request</span></span><br><span class="line">        <span class="variable language_">self</span>.redis.zadd(key, &#123;<span class="built_in">str</span>(current_time): current_time&#125;)</span><br><span class="line">        <span class="variable language_">self</span>.redis.expire(key, window)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>

<p><strong>🎯 Interview Insight</strong>: <em>Security questions often cover data encryption, session management, and rate limiting. Discuss the balance between security and performance, and mention compliance requirements (GDPR, HIPAA) that might affect caching strategies.</em></p>
<h3 id="3-Operational-Excellence"><a href="#3-Operational-Excellence" class="headerlink" title="3. Operational Excellence"></a>3. Operational Excellence</h3><pre><code class="language-python">class RedisOperationalExcellence:
    def __init__(self):
        self.redis = Redis(host=&#39;localhost&#39;, port=6379, db=0)
        self.backup_location = &#39;/var/backups/redis&#39;
        
    def automated_backup(self):
        &quot;&quot;&quot;Automated backup with rotation&quot;&quot;&quot;
        import subprocess
        from datetime import datetime
        
        timestamp = datetime.now().strftime(&#39;%Y%m%d_%H%M%S&#39;)
        backup_file = f&quot;&#123;self.backup_location&#125;/redis_backup_&#123;timestamp&#125;.rdb&quot;
        
        try:
            # Trigger background save
            self.redis.bgsave()
            
            # Wait for background save to complete
            while self.redis.lastsave() == self.redis.lastsave():
                time.sleep(1)
            
            # Copy RDB file
            subprocess.run([
                &#39;cp&#39;, &#39;/var/lib/redis/dump.rdb&#39;, backup_file
            ], check=True)
            
            # Compress backup
            subprocess.run([
                &#39;gzip&#39;, backup_file
            ], check=True)
            
            # Cleanup old backups (keep last 7 days)
            self._cleanup_old_backups()
            
            print(f&quot;Backup completed: &#123;backup_file&#125;.gz&quot;)
            
        except Exception as e:
            print(f&quot;Backup failed: &#123;e&#125;&quot;)
            # Send alert to monitoring system
            self._send_alert(&quot;Redis backup failed&quot;, str(e))
    
    def _cleanup_old_backups(self):
        &quot;&quot;&quot;Remove backups older than 7 days&quot;&quot;&quot;
        import os
        import glob
        from datetime import datetime, timedelta
        
        cutoff_date = datetime.now() - timedelta(days=7)
        pattern = f&quot;&#123;self.backup_location&#125;/redis_backup_*.rdb.gz&quot;
        
        for backup_file in glob.glob(pattern):
            file_time = datetime.fromtimestamp(os.path.getctime(backup_file))
            if file_time &lt; cutoff_date:
                os.remove(backup_file)
                print(f&quot;Removed old backup: &#123;backup_file&#125;&quot;)
    
    def capacity_planning_analysis(self) -&gt; Dict:
        &quot;&quot;&quot;Analyze Redis usage for capacity planning&quot;&quot;&quot;
        info = self.redis.info()
        
        # Memory analysis
        used_memory = info[&#39;used_memory&#39;]
        used_memory_peak = info[&#39;used_memory_peak&#39;]
        max_memory = info.get(&#39;maxmemory&#39;, 0)
        
        # Connection analysis
        connected_clients = info[&#39;connected_clients&#39;]
        
        # Key analysis
        total_keys = sum(info.get(f&#39;db&#123;i&#125;&#39;, &#123;&#125;).get(&#39;keys&#39;, 0) for i in range(16))
        
        # Performance metrics
        ops_per_sec = info.get(&#39;instantaneous_ops_per_sec&#39;, 0)
        
        # Calculate trends (simplified - in production, use time series data)
        memory_growth_rate = self._calculate_memory_growth_rate()
        
        recommendations = []
        
        # Memory recommendations
        if max_memory &gt; 0:
            memory_usage_pct = (used_memory / max_memory) * 100
            if memory_usage_pct &gt; 80:
                recommendations.append(&quot;Memory usage is high - consider scaling up&quot;)
        
        # Connection recommendations
        if connected_clients &gt; 1000:
            recommendations.append(&quot;High connection count - review connection pooling&quot;)
        
        # Performance recommendations
        if ops_per_sec &gt; 100000:
            recommendations.append(&quot;High operation rate - consider read replicas&quot;)
        
        return &#123;
            &#39;memory&#39;: &#123;
                &#39;used_bytes&#39;: used_memory,
                &#39;used_human&#39;: info[&#39;used_memory_human&#39;],
                &#39;peak_bytes&#39;: used_memory_peak,
                &#39;peak_human&#39;: info[&#39;used_memory_peak_human&#39;],
                &#39;max_bytes&#39;: max_memory,
                &#39;usage_percentage&#39;: (used_memory / max_memory * 100) if max_memory &gt; 0 else 0,
                &#39;growth_rate_mb_per_day&#39;: memory_growth_rate
            &#125;,
            &#39;connections&#39;: &#123;
                &#39;current&#39;: connected_clients,
                &#39;max_input&#39;: info.get(&#39;maxclients&#39;, &#39;unlimited&#39;)
            &#125;,
            &#39;keys&#39;: &#123;
                &#39;total&#39;: total_keys,
                &#39;expired&#39;: info.get(&#39;expired_keys&#39;, 0),
                &#39;evicted&#39;: info.get(&#39;evicted_keys&#39;, 0)
            &#125;,
            &#39;performance&#39;: &#123;
                &#39;ops_per_second&#39;: ops_per_sec,
                &#39;keyspace_hits&#39;: info.get(&#39;keyspace_hits&#39;, 0),
                &#39;keyspace_misses&#39;: info.get(&#39;keyspace_misses&#39;, 0),
                &#39;hit_rate&#39;: self._calculate_hit_rate(info)
            &#125;,
            &#39;recommendations&#39;: recommendations
        &#125;
    
    def _calculate_memory_growth_rate(self) -&gt; float:
        &quot;&quot;&quot;Calculate memory growth rate (simplified)&quot;&quot;&quot;
        # In production, this would analyze historical data
        # For demo purposes, return a placeholder
        return 50.0
</code></pre>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/redis/" rel="tag"># redis</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/06/10/Redis-Cache-Problems-Penetration-Breakdown-and-Avalanche/" rel="prev" title="Redis Cache Problems:Penetration,Breakdown and Avalanche">
                  <i class="fa fa-angle-left"></i> Redis Cache Problems:Penetration,Breakdown and Avalanche
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/06/12/Redis-Distributed-Locking-Complete-Guide/" rel="next" title="Redis Distributed Locking: Complete Guide">
                  Redis Distributed Locking: Complete Guide <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Charlie Feng</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
