<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"shayne007.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="Redis Cache Problems: Penetration, Breakdown &amp; AvalancheTable of Contents Introduction Cache Penetration Cache Breakdown Cache Avalanche Monitoring and Alerting Best Practices Summary  Introductio">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis Cache Problems:Penetration,Breakdown and Avalanche">
<meta property="og:url" content="https://shayne007.github.io/2025/06/10/Redis-Cache-Problems-Penetration-Breakdown-and-Avalanche/index.html">
<meta property="og:site_name" content="Charlie Feng&#39;s Tech Space">
<meta property="og:description" content="Redis Cache Problems: Penetration, Breakdown &amp; AvalancheTable of Contents Introduction Cache Penetration Cache Breakdown Cache Avalanche Monitoring and Alerting Best Practices Summary  Introductio">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-06-10T10:43:56.000Z">
<meta property="article:modified_time" content="2025-06-12T05:47:15.532Z">
<meta property="article:author" content="Charlie Feng">
<meta property="article:tag" content="redis">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://shayne007.github.io/2025/06/10/Redis-Cache-Problems-Penetration-Breakdown-and-Avalanche/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://shayne007.github.io/2025/06/10/Redis-Cache-Problems-Penetration-Breakdown-and-Avalanche/","path":"2025/06/10/Redis-Cache-Problems-Penetration-Breakdown-and-Avalanche/","title":"Redis Cache Problems:Penetration,Breakdown and Avalanche"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Redis Cache Problems:Penetration,Breakdown and Avalanche | Charlie Feng's Tech Space</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"cdn":false,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.5.0/mermaid.min.js","integrity":"sha256-2obLuIPcceEhkE3G09G33hBdmE55ivVcZUlcKcGNHjU="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>





  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Charlie Feng's Tech Space</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">You will survive with skills</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Redis-Cache-Problems-Penetration-Breakdown-Avalanche"><span class="nav-number">1.</span> <span class="nav-text">Redis Cache Problems: Penetration, Breakdown &amp; Avalanche</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Table-of-Contents"><span class="nav-number">1.1.</span> <span class="nav-text">Table of Contents</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Introduction"><span class="nav-number">1.2.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cache-Penetration"><span class="nav-number">1.3.</span> <span class="nav-text">Cache Penetration</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#What-is-Cache-Penetration"><span class="nav-number">1.3.1.</span> <span class="nav-text">What is Cache Penetration?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Common-Scenarios"><span class="nav-number">1.3.2.</span> <span class="nav-text">Common Scenarios</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Solution-1-Null-Value-Caching"><span class="nav-number">1.3.3.</span> <span class="nav-text">Solution 1: Null Value Caching</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Solution-2-Bloom-Filter"><span class="nav-number">1.3.4.</span> <span class="nav-text">Solution 2: Bloom Filter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Solution-3-Request-Validation"><span class="nav-number">1.3.5.</span> <span class="nav-text">Solution 3: Request Validation</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cache-Breakdown"><span class="nav-number">1.4.</span> <span class="nav-text">Cache Breakdown</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#What-is-Cache-Breakdown"><span class="nav-number">1.4.1.</span> <span class="nav-text">What is Cache Breakdown?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Solution-1-Distributed-Locking"><span class="nav-number">1.4.2.</span> <span class="nav-text">Solution 1: Distributed Locking</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Solution-2-Logical-Expiration"><span class="nav-number">1.4.3.</span> <span class="nav-text">Solution 2: Logical Expiration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Solution-3-Semaphore-based-Approach"><span class="nav-number">1.4.4.</span> <span class="nav-text">Solution 3: Semaphore-based Approach</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cache-Avalanche"><span class="nav-number">1.5.</span> <span class="nav-text">Cache Avalanche</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#What-is-Cache-Avalanche"><span class="nav-number">1.5.1.</span> <span class="nav-text">What is Cache Avalanche?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Solution-1-Randomized-TTL"><span class="nav-number">1.5.2.</span> <span class="nav-text">Solution 1: Randomized TTL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Solution-2-Multi-level-Caching"><span class="nav-number">1.5.3.</span> <span class="nav-text">Solution 2: Multi-level Caching</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Solution-3-Circuit-Breaker-Pattern"><span class="nav-number">1.5.4.</span> <span class="nav-text">Solution 3: Circuit Breaker Pattern</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Monitoring-and-Alerting"><span class="nav-number">1.6.</span> <span class="nav-text">Monitoring and Alerting</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Key-Metrics-to-Monitor"><span class="nav-number">1.6.1.</span> <span class="nav-text">Key Metrics to Monitor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-Specific-Monitoring"><span class="nav-number">1.6.2.</span> <span class="nav-text">Redis-Specific Monitoring</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Best-Practices-Summary"><span class="nav-number">1.7.</span> <span class="nav-text">Best Practices Summary</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Prevention-Strategies"><span class="nav-number">1.7.1.</span> <span class="nav-text">1. Prevention Strategies</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Operational-Excellence"><span class="nav-number">1.7.2.</span> <span class="nav-text">2. Operational Excellence</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Interview-Questions-and-Answers"><span class="nav-number">1.7.3.</span> <span class="nav-text">3. Interview Questions and Answers</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Conclusion"><span class="nav-number">1.8.</span> <span class="nav-text">Conclusion</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Charlie Feng</p>
  <div class="site-description" itemprop="description">This place is for thinking and sharing.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">36</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/10/Redis-Cache-Problems-Penetration-Breakdown-and-Avalanche/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Redis Cache Problems:Penetration,Breakdown and Avalanche | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Redis Cache Problems:Penetration,Breakdown and Avalanche
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-10 18:43:56" itemprop="dateCreated datePublished" datetime="2025-06-10T18:43:56+08:00">2025-06-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-12 13:47:15" itemprop="dateModified" datetime="2025-06-12T13:47:15+08:00">2025-06-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="Redis-Cache-Problems-Penetration-Breakdown-Avalanche"><a href="#Redis-Cache-Problems-Penetration-Breakdown-Avalanche" class="headerlink" title="Redis Cache Problems: Penetration, Breakdown &amp; Avalanche"></a>Redis Cache Problems: Penetration, Breakdown &amp; Avalanche</h1><h2 id="Table-of-Contents"><a href="#Table-of-Contents" class="headerlink" title="Table of Contents"></a>Table of Contents</h2><ol>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#cache-penetration">Cache Penetration</a></li>
<li><a href="#cache-breakdown">Cache Breakdown</a></li>
<li><a href="#cache-avalanche">Cache Avalanche</a></li>
<li><a href="#monitoring-and-alerting">Monitoring and Alerting</a></li>
<li><a href="#best-practices-summary">Best Practices Summary</a></li>
</ol>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Cache problems are among the most critical challenges in distributed systems, capable of bringing down entire applications within seconds. Understanding these problems isn’t just about knowing Redis commands—it’s about system design, failure modes, and building resilient architectures that can handle millions of requests per second.<br>This guide explores three fundamental cache problems through the lens of Redis, the most widely-used in-memory data structure store. We’ll cover not just the “what” and “how,” but the “why” behind each solution, helping you make informed architectural decisions.<br><strong>Interview Reality Check</strong>: <em>Senior engineers are expected to know these problems intimately. You’ll likely face questions like “Walk me through what happens when 1 million users hit your cache simultaneously and it fails” or “How would you design a cache system for Black Friday traffic?” This guide prepares you for those conversations.</em></p>
<h2 id="Cache-Penetration"><a href="#Cache-Penetration" class="headerlink" title="Cache Penetration"></a>Cache Penetration</h2><h3 id="What-is-Cache-Penetration"><a href="#What-is-Cache-Penetration" class="headerlink" title="What is Cache Penetration?"></a>What is Cache Penetration?</h3><p>Cache penetration(&#x2F;ˌpenəˈtreɪʃn&#x2F;) occurs when queries for non-existent data repeatedly bypass the cache and hit the database directly. This happens because the cache doesn’t store null or empty results, allowing malicious or accidental queries to overwhelm the database.</p>
<pre>
<code class="mermaid">
sequenceDiagram
participant Attacker
participant LoadBalancer
participant AppServer
participant Redis
participant Database
participant Monitor

Note over Attacker: Launches penetration attack

loop Every 10ms for 1000 requests
    Attacker-&gt;&gt;LoadBalancer: GET &#x2F;user&#x2F;999999999
    LoadBalancer-&gt;&gt;AppServer: Route request
    AppServer-&gt;&gt;Redis: GET user:999999999
    Redis--&gt;&gt;AppServer: null (cache miss)
    AppServer-&gt;&gt;Database: SELECT * FROM users WHERE id&#x3D;999999999
    Database--&gt;&gt;AppServer: Empty result
    AppServer--&gt;&gt;LoadBalancer: 404 Not Found
    LoadBalancer--&gt;&gt;Attacker: 404 Not Found
end

Database-&gt;&gt;Monitor: High CPU&#x2F;Memory Alert
Monitor-&gt;&gt;AppServer: Database overload detected

Note over Database: Database performance degrades
Note over AppServer: Legitimate requests start failing
</code>
</pre>

<h3 id="Common-Scenarios"><a href="#Common-Scenarios" class="headerlink" title="Common Scenarios"></a>Common Scenarios</h3><ol>
<li><strong>Malicious Attacks</strong>: Attackers deliberately query non-existent data</li>
<li><strong>Client Bugs</strong>: Application bugs causing queries for invalid IDs</li>
<li><strong>Data Inconsistency</strong>: Race conditions where data is deleted but cache isn’t updated</li>
</ol>
<h3 id="Solution-1-Null-Value-Caching"><a href="#Solution-1-Null-Value-Caching" class="headerlink" title="Solution 1: Null Value Caching"></a>Solution 1: Null Value Caching</h3><p>Cache null results with a shorter TTL to prevent repeated database queries.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.null_cache_ttl = <span class="number">60</span>  <span class="comment"># 1 minute for null values</span></span><br><span class="line">        <span class="variable language_">self</span>.normal_cache_ttl = <span class="number">3600</span>  <span class="comment"># 1 hour for normal data</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">self, user_id: <span class="built_in">int</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        cache_key = <span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Check cache first</span></span><br><span class="line">        cached_result = <span class="variable language_">self</span>.redis_client.get(cache_key)</span><br><span class="line">        <span class="keyword">if</span> cached_result <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">if</span> cached_result == <span class="string">b&quot;NULL&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">            <span class="keyword">return</span> json.loads(cached_result)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Query database</span></span><br><span class="line">        user = <span class="variable language_">self</span>.query_database(user_id)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># Cache null result with shorter TTL</span></span><br><span class="line">            <span class="variable language_">self</span>.redis_client.setex(cache_key, <span class="variable language_">self</span>.null_cache_ttl, <span class="string">&quot;NULL&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># Cache normal result</span></span><br><span class="line">            <span class="variable language_">self</span>.redis_client.setex(cache_key, <span class="variable language_">self</span>.normal_cache_ttl, json.dumps(user))</span><br><span class="line">            <span class="keyword">return</span> user</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">query_database</span>(<span class="params">self, user_id: <span class="built_in">int</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="comment"># Simulate database query</span></span><br><span class="line">        <span class="comment"># In real implementation, this would be your database call</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>  <span class="comment"># Simulating user not found</span></span><br></pre></td></tr></table></figure>

<h3 id="Solution-2-Bloom-Filter"><a href="#Solution-2-Bloom-Filter" class="headerlink" title="Solution 2: Bloom Filter"></a>Solution 2: Bloom Filter</h3><p>Use Bloom filters to quickly check if data might exist before querying the cache or database.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> mmh3</span><br><span class="line"><span class="keyword">from</span> bitarray <span class="keyword">import</span> bitarray</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BloomFilter</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, capacity: <span class="built_in">int</span>, error_rate: <span class="built_in">float</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.capacity = capacity</span><br><span class="line">        <span class="variable language_">self</span>.error_rate = error_rate</span><br><span class="line">        <span class="variable language_">self</span>.bit_array_size = <span class="variable language_">self</span>._get_size(capacity, error_rate)</span><br><span class="line">        <span class="variable language_">self</span>.hash_count = <span class="variable language_">self</span>._get_hash_count(<span class="variable language_">self</span>.bit_array_size, capacity)</span><br><span class="line">        <span class="variable language_">self</span>.bit_array = bitarray(<span class="variable language_">self</span>.bit_array_size)</span><br><span class="line">        <span class="variable language_">self</span>.bit_array.setall(<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_size</span>(<span class="params">self, n: <span class="built_in">int</span>, p: <span class="built_in">float</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="keyword">import</span> math</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>(-(n * math.log(p)) / (math.log(<span class="number">2</span>) ** <span class="number">2</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_hash_count</span>(<span class="params">self, m: <span class="built_in">int</span>, n: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="keyword">import</span> math</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>((m / n) * math.log(<span class="number">2</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">self, item: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="variable language_">self</span>.hash_count):</span><br><span class="line">            index = mmh3.<span class="built_in">hash</span>(item, i) % <span class="variable language_">self</span>.bit_array_size</span><br><span class="line">            <span class="variable language_">self</span>.bit_array[index] = <span class="number">1</span></span><br><span class="line">        <span class="comment"># Also store in Redis for persistence</span></span><br><span class="line">        <span class="variable language_">self</span>.redis_client.setbit(<span class="string">f&quot;bloom_filter&quot;</span>, index, <span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">contains</span>(<span class="params">self, item: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="variable language_">self</span>.hash_count):</span><br><span class="line">            index = mmh3.<span class="built_in">hash</span>(item, i) % <span class="variable language_">self</span>.bit_array_size</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.redis_client.getbit(<span class="string">f&quot;bloom_filter&quot;</span>, index):</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserServiceWithBloom</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.bloom_filter = BloomFilter(capacity=<span class="number">1000000</span>, error_rate=<span class="number">0.01</span>)</span><br><span class="line">        <span class="variable language_">self</span>.initialize_bloom_filter()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">initialize_bloom_filter</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Populate bloom filter with existing user IDs</span></span><br><span class="line">        existing_user_ids = <span class="variable language_">self</span>.get_all_user_ids_from_db()</span><br><span class="line">        <span class="keyword">for</span> user_id <span class="keyword">in</span> existing_user_ids:</span><br><span class="line">            <span class="variable language_">self</span>.bloom_filter.add(<span class="built_in">str</span>(user_id))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">self, user_id: <span class="built_in">int</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="comment"># Check bloom filter first</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.bloom_filter.contains(<span class="built_in">str</span>(user_id)):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span>  <span class="comment"># Definitely doesn&#x27;t exist</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Proceed with normal cache logic</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._get_user_from_cache_or_db(user_id)</span><br></pre></td></tr></table></figure>

<h3 id="Solution-3-Request-Validation"><a href="#Solution-3-Request-Validation" class="headerlink" title="Solution 3: Request Validation"></a>Solution 3: Request Validation</h3><p>Implement strict input validation to prevent invalid queries.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RequestValidator</span>:</span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">validate_user_id</span>(<span class="params">user_id: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="comment"># Validate user ID format</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user_id.isdigit():</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        user_id_int = <span class="built_in">int</span>(user_id)</span><br><span class="line">        <span class="comment"># Check reasonable range</span></span><br><span class="line">        <span class="keyword">if</span> user_id_int &lt;= <span class="number">0</span> <span class="keyword">or</span> user_id_int &gt; <span class="number">999999999</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">validate_email</span>(<span class="params">email: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        pattern = <span class="string">r&#x27;^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]&#123;2,&#125;$&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> re.<span class="keyword">match</span>(pattern, email) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SecureUserService</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">self, user_id: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="comment"># Validate input first</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> RequestValidator.validate_user_id(user_id):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;Invalid user ID format&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Proceed with normal logic</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._get_user_internal(<span class="built_in">int</span>(user_id))</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>When discussing cache penetration, mention the trade-offs: Null caching uses memory but reduces DB load, Bloom filters are memory-efficient but have false positives, and input validation prevents attacks but requires careful implementation.</em></p>
<h2 id="Cache-Breakdown"><a href="#Cache-Breakdown" class="headerlink" title="Cache Breakdown"></a>Cache Breakdown</h2><h3 id="What-is-Cache-Breakdown"><a href="#What-is-Cache-Breakdown" class="headerlink" title="What is Cache Breakdown?"></a>What is Cache Breakdown?</h3><p>Cache breakdown occurs when a popular cache key expires and multiple concurrent requests simultaneously try to rebuild the cache, causing a “thundering herd” effect on the database.</p>
<pre>
<code class="mermaid">
graph
A[Popular Cache Key Expires] --&gt; B[Multiple Concurrent Requests]
B --&gt; C[All Requests Miss Cache]
C --&gt; D[All Requests Hit Database]
D --&gt; E[Database Overload]
E --&gt; F[Performance Degradation]

style A fill:#ff6b6b
style E fill:#ff6b6b
style F fill:#ff6b6b
</code>
</pre>

<h3 id="Solution-1-Distributed-Locking"><a href="#Solution-1-Distributed-Locking" class="headerlink" title="Solution 1: Distributed Locking"></a>Solution 1: Distributed Locking</h3><p>Use Redis distributed locks to ensure only one process rebuilds the cache.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Callable</span></span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DistributedLock</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client: redis.Redis, key: <span class="built_in">str</span>, timeout: <span class="built_in">int</span> = <span class="number">10</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis_client</span><br><span class="line">        <span class="variable language_">self</span>.key = <span class="string">f&quot;lock:<span class="subst">&#123;key&#125;</span>&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.timeout = timeout</span><br><span class="line">        <span class="variable language_">self</span>.identifier = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">acquire</span>(<span class="params">self</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        end = time.time() + <span class="variable language_">self</span>.timeout</span><br><span class="line">        <span class="keyword">while</span> time.time() &lt; end:</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.redis.<span class="built_in">set</span>(<span class="variable language_">self</span>.key, <span class="variable language_">self</span>.identifier, nx=<span class="literal">True</span>, ex=<span class="variable language_">self</span>.timeout):</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            time.sleep(<span class="number">0.001</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">release</span>(<span class="params">self</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        pipe = <span class="variable language_">self</span>.redis.pipeline(<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                pipe.watch(<span class="variable language_">self</span>.key)</span><br><span class="line">                <span class="keyword">if</span> pipe.get(<span class="variable language_">self</span>.key) == <span class="variable language_">self</span>.identifier.encode():</span><br><span class="line">                    pipe.multi()</span><br><span class="line">                    pipe.delete(<span class="variable language_">self</span>.key)</span><br><span class="line">                    pipe.execute()</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">                pipe.unwatch()</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span> redis.WatchError:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CacheService</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.cache_ttl = <span class="number">3600</span></span><br><span class="line">        <span class="variable language_">self</span>.lock_timeout = <span class="number">10</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_with_lock</span>(<span class="params">self, key: <span class="built_in">str</span>, data_loader: <span class="type">Callable</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="comment"># Try to get from cache first</span></span><br><span class="line">        cached_data = <span class="variable language_">self</span>.redis_client.get(key)</span><br><span class="line">        <span class="keyword">if</span> cached_data:</span><br><span class="line">            <span class="keyword">return</span> json.loads(cached_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Cache miss - try to acquire lock</span></span><br><span class="line">        lock = DistributedLock(<span class="variable language_">self</span>.redis_client, key, <span class="variable language_">self</span>.lock_timeout)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> lock.acquire():</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># Double-check cache after acquiring lock</span></span><br><span class="line">                cached_data = <span class="variable language_">self</span>.redis_client.get(key)</span><br><span class="line">                <span class="keyword">if</span> cached_data:</span><br><span class="line">                    <span class="keyword">return</span> json.loads(cached_data)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># Load data from source</span></span><br><span class="line">                data = data_loader()</span><br><span class="line">                <span class="keyword">if</span> data:</span><br><span class="line">                    <span class="comment"># Cache the result</span></span><br><span class="line">                    <span class="variable language_">self</span>.redis_client.setex(key, <span class="variable language_">self</span>.cache_ttl, json.dumps(data))</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> data</span><br><span class="line">            <span class="keyword">finally</span>:</span><br><span class="line">                lock.release()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># Couldn&#x27;t acquire lock, return stale data or wait</span></span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>._handle_lock_failure(key, data_loader)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_handle_lock_failure</span>(<span class="params">self, key: <span class="built_in">str</span>, data_loader: <span class="type">Callable</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="comment"># Strategy 1: Return stale data if available</span></span><br><span class="line">        stale_data = <span class="variable language_">self</span>.redis_client.get(<span class="string">f&quot;stale:<span class="subst">&#123;key&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> stale_data:</span><br><span class="line">            <span class="keyword">return</span> json.loads(stale_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Strategy 2: Wait briefly and retry</span></span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        cached_data = <span class="variable language_">self</span>.redis_client.get(key)</span><br><span class="line">        <span class="keyword">if</span> cached_data:</span><br><span class="line">            <span class="keyword">return</span> json.loads(cached_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Strategy 3: Load from source as fallback</span></span><br><span class="line">        <span class="keyword">return</span> data_loader()</span><br></pre></td></tr></table></figure>

<h3 id="Solution-2-Logical-Expiration"><a href="#Solution-2-Logical-Expiration" class="headerlink" title="Solution 2: Logical Expiration"></a>Solution 2: Logical Expiration</h3><p>Use logical expiration to refresh cache asynchronously while serving stale data.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Callable</span>, <span class="type">Any</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CacheEntry</span>:</span><br><span class="line">    data: <span class="type">Any</span></span><br><span class="line">    logical_expire_time: <span class="built_in">float</span></span><br><span class="line">    is_refreshing: <span class="built_in">bool</span> = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LogicalExpirationCache</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.cache_ttl = <span class="number">3600</span>  <span class="comment"># 1 hour</span></span><br><span class="line">        <span class="variable language_">self</span>.logical_ttl = <span class="number">1800</span>  <span class="comment"># 30 minutes</span></span><br><span class="line">        <span class="variable language_">self</span>.refresh_locks = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.lock = threading.Lock()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, key: <span class="built_in">str</span>, data_loader: <span class="type">Callable</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        cached_value = <span class="variable language_">self</span>.redis_client.get(key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> cached_value:</span><br><span class="line">            <span class="comment"># Cache miss - load and cache data</span></span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>._load_and_cache(key, data_loader)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cache_entry = json.loads(cached_value)</span><br><span class="line">            current_time = time.time()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Check if logically expired</span></span><br><span class="line">            <span class="keyword">if</span> current_time &gt; cache_entry[<span class="string">&#x27;logical_expire_time&#x27;</span>]:</span><br><span class="line">                <span class="comment"># Start async refresh if not already refreshing</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> cache_entry.get(<span class="string">&#x27;is_refreshing&#x27;</span>, <span class="literal">False</span>):</span><br><span class="line">                    <span class="variable language_">self</span>._async_refresh(key, data_loader)</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># Mark as refreshing</span></span><br><span class="line">                    cache_entry[<span class="string">&#x27;is_refreshing&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">                    <span class="variable language_">self</span>.redis_client.setex(key, <span class="variable language_">self</span>.cache_ttl, json.dumps(cache_entry))</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> cache_entry[<span class="string">&#x27;data&#x27;</span>]</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> (json.JSONDecodeError, KeyError):</span><br><span class="line">            <span class="comment"># Corrupted cache entry</span></span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>._load_and_cache(key, data_loader)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_load_and_cache</span>(<span class="params">self, key: <span class="built_in">str</span>, data_loader: <span class="type">Callable</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        data = data_loader()</span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            cache_entry = &#123;</span><br><span class="line">                <span class="string">&#x27;data&#x27;</span>: data,</span><br><span class="line">                <span class="string">&#x27;logical_expire_time&#x27;</span>: time.time() + <span class="variable language_">self</span>.logical_ttl,</span><br><span class="line">                <span class="string">&#x27;is_refreshing&#x27;</span>: <span class="literal">False</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">self</span>.redis_client.setex(key, <span class="variable language_">self</span>.cache_ttl, json.dumps(cache_entry))</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_async_refresh</span>(<span class="params">self, key: <span class="built_in">str</span>, data_loader: <span class="type">Callable</span></span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">refresh_task</span>():</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># Load fresh data</span></span><br><span class="line">                fresh_data = data_loader()</span><br><span class="line">                <span class="keyword">if</span> fresh_data:</span><br><span class="line">                    cache_entry = &#123;</span><br><span class="line">                        <span class="string">&#x27;data&#x27;</span>: fresh_data,</span><br><span class="line">                        <span class="string">&#x27;logical_expire_time&#x27;</span>: time.time() + <span class="variable language_">self</span>.logical_ttl,</span><br><span class="line">                        <span class="string">&#x27;is_refreshing&#x27;</span>: <span class="literal">False</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="variable language_">self</span>.redis_client.setex(key, <span class="variable language_">self</span>.cache_ttl, json.dumps(cache_entry))</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Error refreshing cache for key <span class="subst">&#123;key&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="comment"># Reset refreshing flag on error</span></span><br><span class="line">                cached_value = <span class="variable language_">self</span>.redis_client.get(key)</span><br><span class="line">                <span class="keyword">if</span> cached_value:</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        cache_entry = json.loads(cached_value)</span><br><span class="line">                        cache_entry[<span class="string">&#x27;is_refreshing&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">                        <span class="variable language_">self</span>.redis_client.setex(key, <span class="variable language_">self</span>.cache_ttl, json.dumps(cache_entry))</span><br><span class="line">                    <span class="keyword">except</span>:</span><br><span class="line">                        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Start refresh in background thread</span></span><br><span class="line">        refresh_thread = threading.Thread(target=refresh_task)</span><br><span class="line">        refresh_thread.daemon = <span class="literal">True</span></span><br><span class="line">        refresh_thread.start()</span><br></pre></td></tr></table></figure>

<h3 id="Solution-3-Semaphore-based-Approach"><a href="#Solution-3-Semaphore-based-Approach" class="headerlink" title="Solution 3: Semaphore-based Approach"></a>Solution 3: Semaphore-based Approach</h3><p>Limit the number of concurrent cache rebuilds using semaphores.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Callable</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SemaphoreCache</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, max_concurrent_rebuilds: <span class="built_in">int</span> = <span class="number">3</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.semaphore = threading.Semaphore(max_concurrent_rebuilds)</span><br><span class="line">        <span class="variable language_">self</span>.cache_ttl = <span class="number">3600</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, key: <span class="built_in">str</span>, data_loader: <span class="type">Callable</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="comment"># Try cache first</span></span><br><span class="line">        cached_data = <span class="variable language_">self</span>.redis_client.get(key)</span><br><span class="line">        <span class="keyword">if</span> cached_data:</span><br><span class="line">            <span class="keyword">return</span> json.loads(cached_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Try to acquire semaphore for rebuild</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.semaphore.acquire(blocking=<span class="literal">False</span>):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># Double-check cache</span></span><br><span class="line">                cached_data = <span class="variable language_">self</span>.redis_client.get(key)</span><br><span class="line">                <span class="keyword">if</span> cached_data:</span><br><span class="line">                    <span class="keyword">return</span> json.loads(cached_data)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># Load and cache data</span></span><br><span class="line">                data = data_loader()</span><br><span class="line">                <span class="keyword">if</span> data:</span><br><span class="line">                    <span class="variable language_">self</span>.redis_client.setex(key, <span class="variable language_">self</span>.cache_ttl, json.dumps(data))</span><br><span class="line">                <span class="keyword">return</span> data</span><br><span class="line">            <span class="keyword">finally</span>:</span><br><span class="line">                <span class="variable language_">self</span>.semaphore.release()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># Semaphore not available, try alternatives</span></span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>._handle_semaphore_unavailable(key, data_loader)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_handle_semaphore_unavailable</span>(<span class="params">self, key: <span class="built_in">str</span>, data_loader: <span class="type">Callable</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="comment"># Wait briefly for other threads to complete</span></span><br><span class="line">        time.sleep(<span class="number">0.05</span>)</span><br><span class="line">        cached_data = <span class="variable language_">self</span>.redis_client.get(key)</span><br><span class="line">        <span class="keyword">if</span> cached_data:</span><br><span class="line">            <span class="keyword">return</span> json.loads(cached_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Fallback to direct database query</span></span><br><span class="line">        <span class="keyword">return</span> data_loader()</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Cache breakdown solutions have different trade-offs. Distributed locking ensures consistency but can create bottlenecks. Logical expiration provides better availability but serves stale data. Semaphores balance both but are more complex to implement correctly.</em></p>
<h2 id="Cache-Avalanche"><a href="#Cache-Avalanche" class="headerlink" title="Cache Avalanche"></a>Cache Avalanche</h2><h3 id="What-is-Cache-Avalanche"><a href="#What-is-Cache-Avalanche" class="headerlink" title="What is Cache Avalanche?"></a>What is Cache Avalanche?</h3><p>Cache avalanche(&#x2F;ˈævəlæntʃ&#x2F;) occurs when a large number of cache entries expire simultaneously, causing massive database load. This can happen due to synchronized expiration times or cache server failures.</p>
<pre>
<code class="mermaid">
flowchart
A[Cache Avalanche Triggers] --&gt; B[Mass Expiration]
A --&gt; C[Cache Server Failure]

B --&gt; D[Synchronized TTL]
B --&gt; E[Batch Operations]

C --&gt; F[Hardware Failure]
C --&gt; G[Network Issues]
C --&gt; H[Memory Exhaustion]

D --&gt; I[Database Overload]
E --&gt; I
F --&gt; I
G --&gt; I
H --&gt; I

I --&gt; J[Service Degradation]
I --&gt; K[Cascade Failures]

style A fill:#ff6b6b
style I fill:#ff6b6b
style J fill:#ff6b6b
style K fill:#ff6b6b
</code>
</pre>

<h3 id="Solution-1-Randomized-TTL"><a href="#Solution-1-Randomized-TTL" class="headerlink" title="Solution 1: Randomized TTL"></a>Solution 1: Randomized TTL</h3><p>Add randomization to cache expiration times to prevent synchronized expiration.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Union</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RandomizedTTLCache</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.base_ttl = <span class="number">3600</span>  <span class="comment"># 1 hour</span></span><br><span class="line">        <span class="variable language_">self</span>.jitter_range = <span class="number">0.2</span>  <span class="comment"># ±20% randomization</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_with_jitter</span>(<span class="params">self, key: <span class="built_in">str</span>, value: <span class="built_in">dict</span>, base_ttl: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Set cache value with randomized TTL to prevent avalanche&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> base_ttl <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            base_ttl = <span class="variable language_">self</span>.base_ttl</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Add random jitter to TTL</span></span><br><span class="line">        jitter = random.uniform(-<span class="variable language_">self</span>.jitter_range, <span class="variable language_">self</span>.jitter_range)</span><br><span class="line">        actual_ttl = <span class="built_in">int</span>(base_ttl * (<span class="number">1</span> + jitter))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Ensure TTL is not negative</span></span><br><span class="line">        actual_ttl = <span class="built_in">max</span>(actual_ttl, <span class="number">60</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.redis_client.setex(key, actual_ttl, json.dumps(value))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_or_set</span>(<span class="params">self, key: <span class="built_in">str</span>, data_loader, ttl: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get from cache or set with randomized TTL&quot;&quot;&quot;</span></span><br><span class="line">        cached_data = <span class="variable language_">self</span>.redis_client.get(key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> cached_data:</span><br><span class="line">            <span class="keyword">return</span> json.loads(cached_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Load data and cache with jitter</span></span><br><span class="line">        data = data_loader()</span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            <span class="variable language_">self</span>.set_with_jitter(key, data, ttl)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage example</span></span><br><span class="line">cache = RandomizedTTLCache()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_user_data</span>(<span class="params">user_id: <span class="built_in">int</span></span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">    <span class="comment"># Simulate database query</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;id&quot;</span>: user_id, <span class="string">&quot;name&quot;</span>: <span class="string">f&quot;User <span class="subst">&#123;user_id&#125;</span>&quot;</span>, <span class="string">&quot;email&quot;</span>: <span class="string">f&quot;user<span class="subst">&#123;user_id&#125;</span>@example.com&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Cache multiple users with randomized TTL</span></span><br><span class="line"><span class="keyword">for</span> user_id <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>, <span class="number">2000</span>):</span><br><span class="line">    cache.get_or_set(<span class="string">f&quot;user:<span class="subst">&#123;user_id&#125;</span>&quot;</span>, <span class="keyword">lambda</span> uid=user_id: load_user_data(uid))</span><br></pre></td></tr></table></figure>

<h3 id="Solution-2-Multi-level-Caching"><a href="#Solution-2-Multi-level-Caching" class="headerlink" title="Solution 2: Multi-level Caching"></a>Solution 2: Multi-level Caching</h3><p>Implement multiple cache layers to provide fallback options.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Dict</span>, <span class="type">Any</span>, <span class="type">List</span></span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CacheLevel</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    L1_MEMORY = <span class="string">&quot;l1_memory&quot;</span></span><br><span class="line">    L2_REDIS = <span class="string">&quot;l2_redis&quot;</span></span><br><span class="line">    L3_REDIS_CLUSTER = <span class="string">&quot;l3_redis_cluster&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MultiLevelCache</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># L1: In-memory cache (fastest, smallest)</span></span><br><span class="line">        <span class="variable language_">self</span>.l1_cache: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]] = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.l1_max_size = <span class="number">1000</span></span><br><span class="line">        <span class="variable language_">self</span>.l1_ttl = <span class="number">300</span>  <span class="comment"># 5 minutes</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># L2: Single Redis instance</span></span><br><span class="line">        <span class="variable language_">self</span>.l2_redis = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.l2_ttl = <span class="number">1800</span>  <span class="comment"># 30 minutes</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># L3: Redis cluster/backup</span></span><br><span class="line">        <span class="variable language_">self</span>.l3_redis = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6380</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.l3_ttl = <span class="number">3600</span>  <span class="comment"># 1 hour</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, key: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get value from cache levels in order&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Try L1 first</span></span><br><span class="line">        value = <span class="variable language_">self</span>._get_from_l1(key)</span><br><span class="line">        <span class="keyword">if</span> value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># Try L2</span></span><br><span class="line">        value = <span class="variable language_">self</span>._get_from_l2(key)</span><br><span class="line">        <span class="keyword">if</span> value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># Backfill L1</span></span><br><span class="line">            <span class="variable language_">self</span>._set_to_l1(key, value)</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># Try L3</span></span><br><span class="line">        value = <span class="variable language_">self</span>._get_from_l3(key)</span><br><span class="line">        <span class="keyword">if</span> value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># Backfill L1 and L2</span></span><br><span class="line">            <span class="variable language_">self</span>._set_to_l1(key, value)</span><br><span class="line">            <span class="variable language_">self</span>._set_to_l2(key, value)</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set</span>(<span class="params">self, key: <span class="built_in">str</span>, value: <span class="built_in">dict</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Set value to all cache levels&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>._set_to_l1(key, value)</span><br><span class="line">        <span class="variable language_">self</span>._set_to_l2(key, value)</span><br><span class="line">        <span class="variable language_">self</span>._set_to_l3(key, value)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_from_l1</span>(<span class="params">self, key: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        entry = <span class="variable language_">self</span>.l1_cache.get(key)</span><br><span class="line">        <span class="keyword">if</span> entry:</span><br><span class="line">            <span class="comment"># Check expiration</span></span><br><span class="line">            <span class="keyword">if</span> time.time() &lt; entry[<span class="string">&#x27;expires_at&#x27;</span>]:</span><br><span class="line">                <span class="keyword">return</span> entry[<span class="string">&#x27;data&#x27;</span>]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># Expired, remove from L1</span></span><br><span class="line">                <span class="keyword">del</span> <span class="variable language_">self</span>.l1_cache[key]</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_set_to_l1</span>(<span class="params">self, key: <span class="built_in">str</span>, value: <span class="built_in">dict</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># Implement LRU eviction if needed</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(<span class="variable language_">self</span>.l1_cache) &gt;= <span class="variable language_">self</span>.l1_max_size:</span><br><span class="line">            <span class="comment"># Remove oldest entry</span></span><br><span class="line">            oldest_key = <span class="built_in">min</span>(<span class="variable language_">self</span>.l1_cache.keys(), </span><br><span class="line">                           key=<span class="keyword">lambda</span> k: <span class="variable language_">self</span>.l1_cache[k][<span class="string">&#x27;created_at&#x27;</span>])</span><br><span class="line">            <span class="keyword">del</span> <span class="variable language_">self</span>.l1_cache[oldest_key]</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.l1_cache[key] = &#123;</span><br><span class="line">            <span class="string">&#x27;data&#x27;</span>: value,</span><br><span class="line">            <span class="string">&#x27;created_at&#x27;</span>: time.time(),</span><br><span class="line">            <span class="string">&#x27;expires_at&#x27;</span>: time.time() + <span class="variable language_">self</span>.l1_ttl</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_from_l2</span>(<span class="params">self, key: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cached_data = <span class="variable language_">self</span>.l2_redis.get(key)</span><br><span class="line">            <span class="keyword">return</span> json.loads(cached_data) <span class="keyword">if</span> cached_data <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_set_to_l2</span>(<span class="params">self, key: <span class="built_in">str</span>, value: <span class="built_in">dict</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>.l2_redis.setex(key, <span class="variable language_">self</span>.l2_ttl, json.dumps(value))</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span>  <span class="comment"># Fail silently, other levels available</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_from_l3</span>(<span class="params">self, key: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cached_data = <span class="variable language_">self</span>.l3_redis.get(key)</span><br><span class="line">            <span class="keyword">return</span> json.loads(cached_data) <span class="keyword">if</span> cached_data <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_set_to_l3</span>(<span class="params">self, key: <span class="built_in">str</span>, value: <span class="built_in">dict</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>.l3_redis.setex(key, <span class="variable language_">self</span>.l3_ttl, json.dumps(value))</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span>  <span class="comment"># Fail silently</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_cache_stats</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get statistics about cache performance&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;l1_size&#x27;</span>: <span class="built_in">len</span>(<span class="variable language_">self</span>.l1_cache),</span><br><span class="line">            <span class="string">&#x27;l1_max_size&#x27;</span>: <span class="variable language_">self</span>.l1_max_size,</span><br><span class="line">            <span class="string">&#x27;l2_available&#x27;</span>: <span class="variable language_">self</span>._is_redis_available(<span class="variable language_">self</span>.l2_redis),</span><br><span class="line">            <span class="string">&#x27;l3_available&#x27;</span>: <span class="variable language_">self</span>._is_redis_available(<span class="variable language_">self</span>.l3_redis)</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_is_redis_available</span>(<span class="params">self, redis_client</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            redis_client.ping()</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<h3 id="Solution-3-Circuit-Breaker-Pattern"><a href="#Solution-3-Circuit-Breaker-Pattern" class="headerlink" title="Solution 3: Circuit Breaker Pattern"></a>Solution 3: Circuit Breaker Pattern</h3><p>Implement circuit breaker to prevent cascade failures when cache is unavailable.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Callable</span>, <span class="type">Any</span></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CircuitState</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    CLOSED = <span class="string">&quot;closed&quot;</span>      <span class="comment"># Normal operation</span></span><br><span class="line">    OPEN = <span class="string">&quot;open&quot;</span>         <span class="comment"># Circuit tripped, fail fast</span></span><br><span class="line">    HALF_OPEN = <span class="string">&quot;half_open&quot;</span>  <span class="comment"># Testing if service recovered</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CircuitBreakerConfig</span>:</span><br><span class="line">    failure_threshold: <span class="built_in">int</span> = <span class="number">5</span></span><br><span class="line">    recovery_timeout: <span class="built_in">int</span> = <span class="number">60</span></span><br><span class="line">    success_threshold: <span class="built_in">int</span> = <span class="number">3</span></span><br><span class="line">    timeout: <span class="built_in">int</span> = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CircuitBreaker</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config: CircuitBreakerConfig</span>):</span><br><span class="line">        <span class="variable language_">self</span>.config = config</span><br><span class="line">        <span class="variable language_">self</span>.state = CircuitState.CLOSED</span><br><span class="line">        <span class="variable language_">self</span>.failure_count = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.success_count = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.last_failure_time = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.lock = threading.Lock()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">call</span>(<span class="params">self, func: <span class="type">Callable</span>, *args, **kwargs</span>) -&gt; <span class="type">Any</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="variable language_">self</span>.lock:</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.state == CircuitState.OPEN:</span><br><span class="line">                <span class="keyword">if</span> <span class="variable language_">self</span>._should_attempt_reset():</span><br><span class="line">                    <span class="variable language_">self</span>.state = CircuitState.HALF_OPEN</span><br><span class="line">                    <span class="variable language_">self</span>.success_count = <span class="number">0</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">raise</span> Exception(<span class="string">&quot;Circuit breaker is OPEN&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                result = func(*args, **kwargs)</span><br><span class="line">                <span class="variable language_">self</span>._on_success()</span><br><span class="line">                <span class="keyword">return</span> result</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="variable language_">self</span>._on_failure()</span><br><span class="line">                <span class="keyword">raise</span> e</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_should_attempt_reset</span>(<span class="params">self</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="keyword">return</span> time.time() - <span class="variable language_">self</span>.last_failure_time &gt;= <span class="variable language_">self</span>.config.recovery_timeout</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_on_success</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.state == CircuitState.HALF_OPEN:</span><br><span class="line">            <span class="variable language_">self</span>.success_count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.success_count &gt;= <span class="variable language_">self</span>.config.success_threshold:</span><br><span class="line">                <span class="variable language_">self</span>.state = CircuitState.CLOSED</span><br><span class="line">                <span class="variable language_">self</span>.failure_count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.failure_count = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_on_failure</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.failure_count += <span class="number">1</span></span><br><span class="line">        <span class="variable language_">self</span>.last_failure_time = time.time()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.failure_count &gt;= <span class="variable language_">self</span>.config.failure_threshold:</span><br><span class="line">            <span class="variable language_">self</span>.state = CircuitState.OPEN</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResilientCacheService</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.circuit_breaker = CircuitBreaker(CircuitBreakerConfig())</span><br><span class="line">        <span class="variable language_">self</span>.fallback_cache = &#123;&#125;  <span class="comment"># In-memory fallback</span></span><br><span class="line">        <span class="variable language_">self</span>.cache_ttl = <span class="number">3600</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, key: <span class="built_in">str</span>, data_loader: <span class="type">Callable</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># Try to get from Redis through circuit breaker</span></span><br><span class="line">            cached_data = <span class="variable language_">self</span>.circuit_breaker.call(<span class="variable language_">self</span>._redis_get, key)</span><br><span class="line">            <span class="keyword">if</span> cached_data:</span><br><span class="line">                <span class="comment"># Update fallback cache</span></span><br><span class="line">                <span class="variable language_">self</span>.fallback_cache[key] = &#123;</span><br><span class="line">                    <span class="string">&#x27;data&#x27;</span>: json.loads(cached_data),</span><br><span class="line">                    <span class="string">&#x27;timestamp&#x27;</span>: time.time()</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> json.loads(cached_data)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Redis unavailable: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Try fallback cache</span></span><br><span class="line">            fallback_entry = <span class="variable language_">self</span>.fallback_cache.get(key)</span><br><span class="line">            <span class="keyword">if</span> fallback_entry:</span><br><span class="line">                <span class="comment"># Check if fallback data is not too old</span></span><br><span class="line">                <span class="keyword">if</span> time.time() - fallback_entry[<span class="string">&#x27;timestamp&#x27;</span>] &lt; <span class="variable language_">self</span>.cache_ttl:</span><br><span class="line">                    <span class="keyword">return</span> fallback_entry[<span class="string">&#x27;data&#x27;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Load from data source</span></span><br><span class="line">        data = data_loader()</span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            <span class="comment"># Try to cache in Redis</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="variable language_">self</span>.circuit_breaker.call(<span class="variable language_">self</span>._redis_set, key, json.dumps(data))</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">pass</span>  <span class="comment"># Fail silently</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Always cache in fallback</span></span><br><span class="line">            <span class="variable language_">self</span>.fallback_cache[key] = &#123;</span><br><span class="line">                <span class="string">&#x27;data&#x27;</span>: data,</span><br><span class="line">                <span class="string">&#x27;timestamp&#x27;</span>: time.time()</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_redis_get</span>(<span class="params">self, key: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">bytes</span>]:</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.redis_client.get(key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_redis_set</span>(<span class="params">self, key: <span class="built_in">str</span>, value: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.redis_client.setex(key, <span class="variable language_">self</span>.cache_ttl, value)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_circuit_status</span>(<span class="params">self</span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;state&#x27;</span>: <span class="variable language_">self</span>.circuit_breaker.state.value,</span><br><span class="line">            <span class="string">&#x27;failure_count&#x27;</span>: <span class="variable language_">self</span>.circuit_breaker.failure_count,</span><br><span class="line">            <span class="string">&#x27;success_count&#x27;</span>: <span class="variable language_">self</span>.circuit_breaker.success_count</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>When discussing cache avalanche, emphasize that prevention is better than reaction. Randomized TTL is simple but effective, multi-level caching provides resilience, and circuit breakers prevent cascade failures. The key is having multiple strategies working together.</em></p>
<h2 id="Monitoring-and-Alerting"><a href="#Monitoring-and-Alerting" class="headerlink" title="Monitoring and Alerting"></a>Monitoring and Alerting</h2><p>Effective monitoring is crucial for detecting and responding to cache problems before they impact users.</p>
<h3 id="Key-Metrics-to-Monitor"><a href="#Key-Metrics-to-Monitor" class="headerlink" title="Key Metrics to Monitor"></a>Key Metrics to Monitor</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict, deque</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CacheMetrics</span>:</span><br><span class="line">    hits: <span class="built_in">int</span> = <span class="number">0</span></span><br><span class="line">    misses: <span class="built_in">int</span> = <span class="number">0</span></span><br><span class="line">    errors: <span class="built_in">int</span> = <span class="number">0</span></span><br><span class="line">    avg_response_time: <span class="built_in">float</span> = <span class="number">0.0</span></span><br><span class="line">    p95_response_time: <span class="built_in">float</span> = <span class="number">0.0</span></span><br><span class="line">    p99_response_time: <span class="built_in">float</span> = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CacheMonitor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, window_size: <span class="built_in">int</span> = <span class="number">300</span></span>):  <span class="comment"># 5 minute window</span></span><br><span class="line">        <span class="variable language_">self</span>.window_size = window_size</span><br><span class="line">        <span class="variable language_">self</span>.metrics = defaultdict(<span class="keyword">lambda</span>: CacheMetrics())</span><br><span class="line">        <span class="variable language_">self</span>.response_times = defaultdict(<span class="keyword">lambda</span>: deque(maxlen=<span class="number">1000</span>))</span><br><span class="line">        <span class="variable language_">self</span>.error_counts = defaultdict(<span class="built_in">int</span>)</span><br><span class="line">        <span class="variable language_">self</span>.lock = threading.Lock()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Start background thread for cleanup</span></span><br><span class="line">        <span class="variable language_">self</span>.cleanup_thread = threading.Thread(target=<span class="variable language_">self</span>._cleanup_old_metrics, daemon=<span class="literal">True</span>)</span><br><span class="line">        <span class="variable language_">self</span>.cleanup_thread.start()</span><br><span class="line">    </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserService</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">record_hit</span>(<span class="params">self, cache_key: <span class="built_in">str</span>, response_time: <span class="built_in">float</span></span>):</span><br><span class="line">        <span class="keyword">with</span> <span class="variable language_">self</span>.lock:</span><br><span class="line">            <span class="variable language_">self</span>.metrics[cache_key].hits += <span class="number">1</span></span><br><span class="line">            <span class="variable language_">self</span>.response_times[cache_key].append(response_time)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">record_miss</span>(<span class="params">self, cache_key: <span class="built_in">str</span>, response_time: <span class="built_in">float</span></span>):</span><br><span class="line">        <span class="keyword">with</span> <span class="variable language_">self</span>.lock:</span><br><span class="line">            <span class="variable language_">self</span>.metrics[cache_key].misses += <span class="number">1</span></span><br><span class="line">            <span class="variable language_">self</span>.response_times[cache_key].append(response_time)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">record_error</span>(<span class="params">self, cache_key: <span class="built_in">str</span>, error_type: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="keyword">with</span> <span class="variable language_">self</span>.lock:</span><br><span class="line">            <span class="variable language_">self</span>.metrics[cache_key].errors += <span class="number">1</span></span><br><span class="line">            <span class="variable language_">self</span>.error_counts[<span class="string">f&quot;<span class="subst">&#123;cache_key&#125;</span>:<span class="subst">&#123;error_type&#125;</span>&quot;</span>] += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_cache_hit_rate</span>(<span class="params">self, cache_key: <span class="built_in">str</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        metrics = <span class="variable language_">self</span>.metrics[cache_key]</span><br><span class="line">        total_requests = metrics.hits + metrics.misses</span><br><span class="line">        <span class="keyword">return</span> metrics.hits / total_requests <span class="keyword">if</span> total_requests &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0.0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_response_time_percentiles</span>(<span class="params">self, cache_key: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">float</span>]:</span><br><span class="line">        times = <span class="built_in">list</span>(<span class="variable language_">self</span>.response_times[cache_key])</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> times:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;p50&quot;</span>: <span class="number">0.0</span>, <span class="string">&quot;p95&quot;</span>: <span class="number">0.0</span>, <span class="string">&quot;p99&quot;</span>: <span class="number">0.0</span>&#125;</span><br><span class="line">        </span><br><span class="line">        times.sort()</span><br><span class="line">        n = <span class="built_in">len</span>(times)</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;p50&quot;</span>: times[<span class="built_in">int</span>(n * <span class="number">0.5</span>)] <span class="keyword">if</span> n &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0.0</span>,</span><br><span class="line">            <span class="string">&quot;p95&quot;</span>: times[<span class="built_in">int</span>(n * <span class="number">0.95</span>)] <span class="keyword">if</span> n &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0.0</span>,</span><br><span class="line">            <span class="string">&quot;p99&quot;</span>: times[<span class="built_in">int</span>(n * <span class="number">0.99</span>)] <span class="keyword">if</span> n &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0.0</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_alert_conditions</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        alerts = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> cache_key, metrics <span class="keyword">in</span> <span class="variable language_">self</span>.metrics.items():</span><br><span class="line">            hit_rate = <span class="variable language_">self</span>.get_cache_hit_rate(cache_key)</span><br><span class="line">            percentiles = <span class="variable language_">self</span>.get_response_time_percentiles(cache_key)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Low hit rate alert</span></span><br><span class="line">            <span class="keyword">if</span> hit_rate &lt; <span class="number">0.8</span> <span class="keyword">and</span> (metrics.hits + metrics.misses) &gt; <span class="number">100</span>:</span><br><span class="line">                alerts.append(&#123;</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;low_hit_rate&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;cache_key&quot;</span>: cache_key,</span><br><span class="line">                    <span class="string">&quot;hit_rate&quot;</span>: hit_rate,</span><br><span class="line">                    <span class="string">&quot;severity&quot;</span>: <span class="string">&quot;warning&quot;</span> <span class="keyword">if</span> hit_rate &gt; <span class="number">0.5</span> <span class="keyword">else</span> <span class="string">&quot;critical&quot;</span></span><br><span class="line">                &#125;)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># High error rate alert</span></span><br><span class="line">            total_ops = metrics.hits + metrics.misses + metrics.errors</span><br><span class="line">            error_rate = metrics.errors / total_ops <span class="keyword">if</span> total_ops &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> error_rate &gt; <span class="number">0.05</span>:  <span class="comment"># 5% error rate</span></span><br><span class="line">                alerts.append(&#123;</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;high_error_rate&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;cache_key&quot;</span>: cache_key,</span><br><span class="line">                    <span class="string">&quot;error_rate&quot;</span>: error_rate,</span><br><span class="line">                    <span class="string">&quot;severity&quot;</span>: <span class="string">&quot;critical&quot;</span></span><br><span class="line">                &#125;)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># High response time alert</span></span><br><span class="line">            <span class="keyword">if</span> percentiles[<span class="string">&quot;p95&quot;</span>] &gt; <span class="number">100</span>:  <span class="comment"># 100ms</span></span><br><span class="line">                alerts.append(&#123;</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;high_response_time&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;cache_key&quot;</span>: cache_key,</span><br><span class="line">                    <span class="string">&quot;p95_time&quot;</span>: percentiles[<span class="string">&quot;p95&quot;</span>],</span><br><span class="line">                    <span class="string">&quot;severity&quot;</span>: <span class="string">&quot;warning&quot;</span> <span class="keyword">if</span> percentiles[<span class="string">&quot;p95&quot;</span>] &lt; <span class="number">500</span> <span class="keyword">else</span> <span class="string">&quot;critical&quot;</span></span><br><span class="line">                &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> alerts</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_cleanup_old_metrics</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            time.sleep(<span class="number">60</span>)  <span class="comment"># Cleanup every minute</span></span><br><span class="line">            current_time = time.time()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">with</span> <span class="variable language_">self</span>.lock:</span><br><span class="line">                <span class="comment"># Remove old response times</span></span><br><span class="line">                <span class="keyword">for</span> key <span class="keyword">in</span> <span class="built_in">list</span>(<span class="variable language_">self</span>.response_times.keys()):</span><br><span class="line">                    times = <span class="variable language_">self</span>.response_times[key]</span><br><span class="line">                    <span class="comment"># Keep only recent times (implement time-based cleanup if needed)</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">len</span>(times) == <span class="number">0</span>:</span><br><span class="line">                        <span class="keyword">del</span> <span class="variable language_">self</span>.response_times[key]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Instrumented Cache Service</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MonitoredCacheService</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="variable language_">self</span>.monitor = CacheMonitor()</span><br><span class="line">        <span class="variable language_">self</span>.cache_ttl = <span class="number">3600</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, key: <span class="built_in">str</span>, data_loader: <span class="type">Callable</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        start_time = time.time()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># Try cache first</span></span><br><span class="line">            cached_data = <span class="variable language_">self</span>.redis_client.get(key)</span><br><span class="line">            response_time = (time.time() - start_time) * <span class="number">1000</span>  <span class="comment"># Convert to ms</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> cached_data:</span><br><span class="line">                <span class="variable language_">self</span>.monitor.record_hit(key, response_time)</span><br><span class="line">                <span class="keyword">return</span> json.loads(cached_data)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># Cache miss - load data</span></span><br><span class="line">                data = data_loader()</span><br><span class="line">                total_response_time = (time.time() - start_time) * <span class="number">1000</span></span><br><span class="line">                <span class="variable language_">self</span>.monitor.record_miss(key, total_response_time)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> data:</span><br><span class="line">                    <span class="comment"># Cache the result</span></span><br><span class="line">                    <span class="variable language_">self</span>.redis_client.setex(key, <span class="variable language_">self</span>.cache_ttl, json.dumps(data))</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> data</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            response_time = (time.time() - start_time) * <span class="number">1000</span></span><br><span class="line">            <span class="variable language_">self</span>.monitor.record_error(key, <span class="built_in">type</span>(e).__name__)</span><br><span class="line">            <span class="keyword">raise</span> e</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_monitoring_dashboard</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        alerts = <span class="variable language_">self</span>.monitor.get_alert_conditions()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Get top cache keys by usage</span></span><br><span class="line">        top_keys = []</span><br><span class="line">        <span class="keyword">for</span> cache_key, metrics <span class="keyword">in</span> <span class="variable language_">self</span>.monitor.metrics.items():</span><br><span class="line">            total_ops = metrics.hits + metrics.misses</span><br><span class="line">            <span class="keyword">if</span> total_ops &gt; <span class="number">0</span>:</span><br><span class="line">                top_keys.append(&#123;</span><br><span class="line">                    <span class="string">&quot;key&quot;</span>: cache_key,</span><br><span class="line">                    <span class="string">&quot;hit_rate&quot;</span>: <span class="variable language_">self</span>.monitor.get_cache_hit_rate(cache_key),</span><br><span class="line">                    <span class="string">&quot;total_operations&quot;</span>: total_ops,</span><br><span class="line">                    <span class="string">&quot;error_count&quot;</span>: metrics.errors,</span><br><span class="line">                    <span class="string">&quot;response_times&quot;</span>: <span class="variable language_">self</span>.monitor.get_response_time_percentiles(cache_key)</span><br><span class="line">                &#125;)</span><br><span class="line">        </span><br><span class="line">        top_keys.sort(key=<span class="keyword">lambda</span> x: x[<span class="string">&quot;total_operations&quot;</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;alerts&quot;</span>: alerts,</span><br><span class="line">            <span class="string">&quot;top_cache_keys&quot;</span>: top_keys[:<span class="number">10</span>],</span><br><span class="line">            <span class="string">&quot;total_alerts&quot;</span>: <span class="built_in">len</span>(alerts),</span><br><span class="line">            <span class="string">&quot;critical_alerts&quot;</span>: <span class="built_in">len</span>([a <span class="keyword">for</span> a <span class="keyword">in</span> alerts <span class="keyword">if</span> a[<span class="string">&quot;severity&quot;</span>] == <span class="string">&quot;critical&quot;</span>])</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Redis-Specific-Monitoring"><a href="#Redis-Specific-Monitoring" class="headerlink" title="Redis-Specific Monitoring"></a>Redis-Specific Monitoring</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">Any</span>, <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RedisMonitor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client: redis.Redis</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis_client</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_redis_info</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get comprehensive Redis information&quot;&quot;&quot;</span></span><br><span class="line">        info = <span class="variable language_">self</span>.redis.info()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;memory&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;used_memory&quot;</span>: info.get(<span class="string">&quot;used_memory&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;used_memory_human&quot;</span>: info.get(<span class="string">&quot;used_memory_human&quot;</span>, <span class="string">&quot;0B&quot;</span>),</span><br><span class="line">                <span class="string">&quot;used_memory_peak&quot;</span>: info.get(<span class="string">&quot;used_memory_peak&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;used_memory_peak_human&quot;</span>: info.get(<span class="string">&quot;used_memory_peak_human&quot;</span>, <span class="string">&quot;0B&quot;</span>),</span><br><span class="line">                <span class="string">&quot;memory_fragmentation_ratio&quot;</span>: info.get(<span class="string">&quot;mem_fragmentation_ratio&quot;</span>, <span class="number">0</span>),</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;performance&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;instantaneous_ops_per_sec&quot;</span>: info.get(<span class="string">&quot;instantaneous_ops_per_sec&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;total_commands_processed&quot;</span>: info.get(<span class="string">&quot;total_commands_processed&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;expired_keys&quot;</span>: info.get(<span class="string">&quot;expired_keys&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;evicted_keys&quot;</span>: info.get(<span class="string">&quot;evicted_keys&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;keyspace_hits&quot;</span>: info.get(<span class="string">&quot;keyspace_hits&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;keyspace_misses&quot;</span>: info.get(<span class="string">&quot;keyspace_misses&quot;</span>, <span class="number">0</span>),</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;connections&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;connected_clients&quot;</span>: info.get(<span class="string">&quot;connected_clients&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;client_longest_output_list&quot;</span>: info.get(<span class="string">&quot;client_longest_output_list&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;client_biggest_input_buf&quot;</span>: info.get(<span class="string">&quot;client_biggest_input_buf&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;blocked_clients&quot;</span>: info.get(<span class="string">&quot;blocked_clients&quot;</span>, <span class="number">0</span>),</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;persistence&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;rdb_changes_since_last_save&quot;</span>: info.get(<span class="string">&quot;rdb_changes_since_last_save&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;rdb_last_save_time&quot;</span>: info.get(<span class="string">&quot;rdb_last_save_time&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;rdb_last_bgsave_status&quot;</span>: info.get(<span class="string">&quot;rdb_last_bgsave_status&quot;</span>, <span class="string">&quot;unknown&quot;</span>),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_cache_hit_ratio</span>(<span class="params">self</span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Calculate overall cache hit ratio&quot;&quot;&quot;</span></span><br><span class="line">        info = <span class="variable language_">self</span>.redis.info()</span><br><span class="line">        hits = info.get(<span class="string">&quot;keyspace_hits&quot;</span>, <span class="number">0</span>)</span><br><span class="line">        misses = info.get(<span class="string">&quot;keyspace_misses&quot;</span>, <span class="number">0</span>)</span><br><span class="line">        total = hits + misses</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> hits / total <span class="keyword">if</span> total &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0.0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_memory_usage_alerts</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Check for memory-related issues&quot;&quot;&quot;</span></span><br><span class="line">        info = <span class="variable language_">self</span>.get_redis_info()</span><br><span class="line">        alerts = []</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Memory fragmentation alert</span></span><br><span class="line">        frag_ratio = info[<span class="string">&quot;memory&quot;</span>][<span class="string">&quot;memory_fragmentation_ratio&quot;</span>]</span><br><span class="line">        <span class="keyword">if</span> frag_ratio &gt; <span class="number">1.5</span>:</span><br><span class="line">            alerts.append(&#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;high_memory_fragmentation&quot;</span>,</span><br><span class="line">                <span class="string">&quot;value&quot;</span>: frag_ratio,</span><br><span class="line">                <span class="string">&quot;severity&quot;</span>: <span class="string">&quot;warning&quot;</span> <span class="keyword">if</span> frag_ratio &lt; <span class="number">2.0</span> <span class="keyword">else</span> <span class="string">&quot;critical&quot;</span>,</span><br><span class="line">                <span class="string">&quot;message&quot;</span>: <span class="string">f&quot;Memory fragmentation ratio is <span class="subst">&#123;frag_ratio:<span class="number">.2</span>f&#125;</span>&quot;</span></span><br><span class="line">            &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># High memory usage alert</span></span><br><span class="line">        used_memory = info[<span class="string">&quot;memory&quot;</span>][<span class="string">&quot;used_memory&quot;</span>]</span><br><span class="line">        <span class="comment"># Assuming max memory is configured</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            max_memory = <span class="variable language_">self</span>.redis.config_get(<span class="string">&quot;maxmemory&quot;</span>)[<span class="string">&quot;maxmemory&quot;</span>]</span><br><span class="line">            <span class="keyword">if</span> max_memory <span class="keyword">and</span> <span class="built_in">int</span>(max_memory) &gt; <span class="number">0</span>:</span><br><span class="line">                usage_ratio = used_memory / <span class="built_in">int</span>(max_memory)</span><br><span class="line">                <span class="keyword">if</span> usage_ratio &gt; <span class="number">0.8</span>:</span><br><span class="line">                    alerts.append(&#123;</span><br><span class="line">                        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;high_memory_usage&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;value&quot;</span>: usage_ratio,</span><br><span class="line">                        <span class="string">&quot;severity&quot;</span>: <span class="string">&quot;warning&quot;</span> <span class="keyword">if</span> usage_ratio &lt; <span class="number">0.9</span> <span class="keyword">else</span> <span class="string">&quot;critical&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;message&quot;</span>: <span class="string">f&quot;Memory usage is <span class="subst">&#123;usage_ratio:<span class="number">.1</span>%&#125;</span>&quot;</span></span><br><span class="line">                    &#125;)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Eviction alert</span></span><br><span class="line">        evicted_keys = info[<span class="string">&quot;performance&quot;</span>][<span class="string">&quot;evicted_keys&quot;</span>]</span><br><span class="line">        <span class="keyword">if</span> evicted_keys &gt; <span class="number">0</span>:</span><br><span class="line">            alerts.append(&#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;key_eviction&quot;</span>,</span><br><span class="line">                <span class="string">&quot;value&quot;</span>: evicted_keys,</span><br><span class="line">                <span class="string">&quot;severity&quot;</span>: <span class="string">&quot;warning&quot;</span>,</span><br><span class="line">                <span class="string">&quot;message&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;evicted_keys&#125;</span> keys have been evicted&quot;</span></span><br><span class="line">            &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> alerts</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_performance_metrics</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">float</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get key performance metrics&quot;&quot;&quot;</span></span><br><span class="line">        info = <span class="variable language_">self</span>.get_redis_info()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;ops_per_second&quot;</span>: info[<span class="string">&quot;performance&quot;</span>][<span class="string">&quot;instantaneous_ops_per_sec&quot;</span>],</span><br><span class="line">            <span class="string">&quot;cache_hit_ratio&quot;</span>: <span class="variable language_">self</span>.get_cache_hit_ratio(),</span><br><span class="line">            <span class="string">&quot;memory_fragmentation_ratio&quot;</span>: info[<span class="string">&quot;memory&quot;</span>][<span class="string">&quot;memory_fragmentation_ratio&quot;</span>],</span><br><span class="line">            <span class="string">&quot;connected_clients&quot;</span>: info[<span class="string">&quot;connections&quot;</span>][<span class="string">&quot;connected_clients&quot;</span>],</span><br><span class="line">            <span class="string">&quot;memory_usage_mb&quot;</span>: info[<span class="string">&quot;memory&quot;</span>][<span class="string">&quot;used_memory&quot;</span>] / (<span class="number">1024</span> * <span class="number">1024</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage Example</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setup_comprehensive_monitoring</span>():</span><br><span class="line">    redis_client = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line">    cache_service = MonitoredCacheService()</span><br><span class="line">    redis_monitor = RedisMonitor(redis_client)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Simulate some cache operations</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_user_data</span>(<span class="params">user_id: <span class="built_in">int</span></span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">        time.sleep(<span class="number">0.01</span>)  <span class="comment"># Simulate DB query time</span></span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;id&quot;</span>: user_id, <span class="string">&quot;name&quot;</span>: <span class="string">f&quot;User <span class="subst">&#123;user_id&#125;</span>&quot;</span>&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Generate some metrics</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">        cache_service.get(<span class="string">f&quot;user:<span class="subst">&#123;i&#125;</span>&quot;</span>, <span class="keyword">lambda</span> uid=i: load_user_data(uid))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Get monitoring dashboard</span></span><br><span class="line">    dashboard = cache_service.get_monitoring_dashboard()</span><br><span class="line">    redis_metrics = redis_monitor.get_performance_metrics()</span><br><span class="line">    redis_alerts = redis_monitor.get_memory_usage_alerts()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;application_metrics&quot;</span>: dashboard,</span><br><span class="line">        <span class="string">&quot;redis_metrics&quot;</span>: redis_metrics,</span><br><span class="line">        <span class="string">&quot;redis_alerts&quot;</span>: redis_alerts</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Monitoring is often overlooked but critical. Mention specific metrics like hit rate, response time percentiles, error rates, and memory usage. Explain how you’d set up alerts and what thresholds you’d use. Show understanding of both application-level and Redis-specific monitoring.</em></p>
<h2 id="Best-Practices-Summary"><a href="#Best-Practices-Summary" class="headerlink" title="Best Practices Summary"></a>Best Practices Summary</h2><h3 id="1-Prevention-Strategies"><a href="#1-Prevention-Strategies" class="headerlink" title="1. Prevention Strategies"></a>1. Prevention Strategies</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Configuration best practices</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CacheConfig</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># TTL strategies</span></span><br><span class="line">        <span class="variable language_">self</span>.base_ttl = <span class="number">3600</span></span><br><span class="line">        <span class="variable language_">self</span>.jitter_percentage = <span class="number">0.2</span></span><br><span class="line">        <span class="variable language_">self</span>.short_ttl_for_nulls = <span class="number">60</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Capacity planning</span></span><br><span class="line">        <span class="variable language_">self</span>.max_memory_policy = <span class="string">&quot;allkeys-lru&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.memory_usage_threshold = <span class="number">0.8</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Performance tuning</span></span><br><span class="line">        <span class="variable language_">self</span>.connection_pool_size = <span class="number">50</span></span><br><span class="line">        <span class="variable language_">self</span>.socket_timeout = <span class="number">5</span></span><br><span class="line">        <span class="variable language_">self</span>.retry_attempts = <span class="number">3</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Security</span></span><br><span class="line">        <span class="variable language_">self</span>.enable_auth = <span class="literal">True</span></span><br><span class="line">        <span class="variable language_">self</span>.use_ssl = <span class="literal">True</span></span><br><span class="line">        <span class="variable language_">self</span>.bind_to_localhost = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Implementation of best practices</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProductionCacheService</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.config = CacheConfig()</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = <span class="variable language_">self</span>._create_redis_client()</span><br><span class="line">        <span class="variable language_">self</span>.monitor = CacheMonitor()</span><br><span class="line">        <span class="variable language_">self</span>.bloom_filter = BloomFilter(capacity=<span class="number">1000000</span>, error_rate=<span class="number">0.01</span>)</span><br><span class="line">        <span class="variable language_">self</span>.circuit_breaker = CircuitBreaker(CircuitBreakerConfig())</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_create_redis_client</span>(<span class="params">self</span>) -&gt; redis.Redis:</span><br><span class="line">        <span class="keyword">return</span> redis.Redis(</span><br><span class="line">            host=<span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">            port=<span class="number">6379</span>,</span><br><span class="line">            db=<span class="number">0</span>,</span><br><span class="line">            socket_timeout=<span class="variable language_">self</span>.config.socket_timeout,</span><br><span class="line">            retry_on_timeout=<span class="literal">True</span>,</span><br><span class="line">            health_check_interval=<span class="number">30</span>,</span><br><span class="line">            connection_pool=redis.ConnectionPool(</span><br><span class="line">                max_connections=<span class="variable language_">self</span>.config.connection_pool_size</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_with_all_protections</span>(<span class="params">self, key: <span class="built_in">str</span>, data_loader: <span class="type">Callable</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get with all cache problem protections enabled&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 1. Input validation</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>._validate_cache_key(key):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;Invalid cache key&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. Bloom filter check (prevents penetration)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.bloom_filter.contains(key):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. Circuit breaker protection (prevents avalanche)</span></span><br><span class="line">        start_time = time.time()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = <span class="variable language_">self</span>.circuit_breaker.call(<span class="variable language_">self</span>._get_with_breakdown_protection, key, data_loader)</span><br><span class="line">            response_time = (time.time() - start_time) * <span class="number">1000</span></span><br><span class="line">            <span class="variable language_">self</span>.monitor.record_hit(key, response_time)</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            response_time = (time.time() - start_time) * <span class="number">1000</span></span><br><span class="line">            <span class="variable language_">self</span>.monitor.record_error(key, <span class="built_in">type</span>(e).__name__)</span><br><span class="line">            <span class="keyword">raise</span> e</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_with_breakdown_protection</span>(<span class="params">self, key: <span class="built_in">str</span>, data_loader: <span class="type">Callable</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get with cache breakdown protection (distributed locking)&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Try cache first</span></span><br><span class="line">        cached_data = <span class="variable language_">self</span>.redis_client.get(key)</span><br><span class="line">        <span class="keyword">if</span> cached_data:</span><br><span class="line">            <span class="keyword">return</span> json.loads(cached_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Use distributed lock to prevent breakdown</span></span><br><span class="line">        lock = DistributedLock(<span class="variable language_">self</span>.redis_client, key, timeout=<span class="number">10</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> lock.acquire():</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># Double-check cache</span></span><br><span class="line">                cached_data = <span class="variable language_">self</span>.redis_client.get(key)</span><br><span class="line">                <span class="keyword">if</span> cached_data:</span><br><span class="line">                    <span class="keyword">return</span> json.loads(cached_data)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># Load data</span></span><br><span class="line">                data = data_loader()</span><br><span class="line">                <span class="keyword">if</span> data:</span><br><span class="line">                    <span class="comment"># Cache with randomized TTL (prevents avalanche)</span></span><br><span class="line">                    jitter = random.uniform(-<span class="variable language_">self</span>.config.jitter_percentage, <span class="variable language_">self</span>.config.jitter_percentage)</span><br><span class="line">                    ttl = <span class="built_in">int</span>(<span class="variable language_">self</span>.config.base_ttl * (<span class="number">1</span> + jitter))</span><br><span class="line">                    <span class="variable language_">self</span>.redis_client.setex(key, ttl, json.dumps(data))</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># Update bloom filter</span></span><br><span class="line">                    <span class="variable language_">self</span>.bloom_filter.add(key)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="comment"># Cache null result with short TTL (prevents penetration)</span></span><br><span class="line">                    <span class="variable language_">self</span>.redis_client.setex(key, <span class="variable language_">self</span>.config.short_ttl_for_nulls, <span class="string">&quot;NULL&quot;</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> data</span><br><span class="line">            <span class="keyword">finally</span>:</span><br><span class="line">                lock.release()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># Couldn&#x27;t acquire lock, try stale data or fallback</span></span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>._handle_lock_failure(key, data_loader)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_validate_cache_key</span>(<span class="params">self, key: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Validate cache key format and content&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> key <span class="keyword">or</span> <span class="built_in">len</span>(key) &gt; <span class="number">250</span>:  <span class="comment"># Redis key length limit</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Check for suspicious patterns</span></span><br><span class="line">        suspicious_patterns = [<span class="string">&#x27;..&#x27;</span>, <span class="string">&#x27;//&#x27;</span>, <span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;&lt;script&#x27;</span>, <span class="string">&#x27;javascript:&#x27;</span>]</span><br><span class="line">        <span class="keyword">for</span> pattern <span class="keyword">in</span> suspicious_patterns:</span><br><span class="line">            <span class="keyword">if</span> pattern <span class="keyword">in</span> key.lower():</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_handle_lock_failure</span>(<span class="params">self, key: <span class="built_in">str</span>, data_loader: <span class="type">Callable</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Handle case when distributed lock cannot be acquired&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Wait briefly and retry cache</span></span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        cached_data = <span class="variable language_">self</span>.redis_client.get(key)</span><br><span class="line">        <span class="keyword">if</span> cached_data <span class="keyword">and</span> cached_data != <span class="string">b&quot;NULL&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> json.loads(cached_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Fallback to direct database query</span></span><br><span class="line">        <span class="keyword">return</span> data_loader()</span><br></pre></td></tr></table></figure>

<h3 id="2-Operational-Excellence"><a href="#2-Operational-Excellence" class="headerlink" title="2. Operational Excellence"></a>2. Operational Excellence</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CacheOperations</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, cache_service: ProductionCacheService</span>):</span><br><span class="line">        <span class="variable language_">self</span>.cache_service = cache_service</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = cache_service.redis_client</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">warm_up_cache</span>(<span class="params">self, keys_to_warm: <span class="type">List</span>[<span class="built_in">str</span>], data_loader_map: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Callable</span>]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Warm up cache with critical data&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Warming up cache for <span class="subst">&#123;<span class="built_in">len</span>(keys_to_warm)&#125;</span> keys...&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> keys_to_warm:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> key <span class="keyword">in</span> data_loader_map:</span><br><span class="line">                    data = data_loader_map[key]()</span><br><span class="line">                    <span class="keyword">if</span> data:</span><br><span class="line">                        <span class="variable language_">self</span>.cache_service.set_with_jitter(key, data)</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f&quot;Warmed up: <span class="subst">&#123;key&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Failed to warm up <span class="subst">&#123;key&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">invalidate_pattern</span>(<span class="params">self, pattern: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Safely invalidate cache keys matching a pattern&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            keys = <span class="variable language_">self</span>.redis_client.keys(pattern)</span><br><span class="line">            <span class="keyword">if</span> keys:</span><br><span class="line">                pipeline = <span class="variable language_">self</span>.redis_client.pipeline()</span><br><span class="line">                <span class="keyword">for</span> key <span class="keyword">in</span> keys:</span><br><span class="line">                    pipeline.delete(key)</span><br><span class="line">                pipeline.execute()</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Invalidated <span class="subst">&#123;<span class="built_in">len</span>(keys)&#125;</span> keys matching pattern: <span class="subst">&#123;pattern&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Failed to invalidate pattern <span class="subst">&#123;pattern&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">export_cache_analytics</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Export cache analytics for analysis&quot;&quot;&quot;</span></span><br><span class="line">        info = <span class="variable language_">self</span>.redis_client.info()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;timestamp&quot;</span>: time.time(),</span><br><span class="line">            <span class="string">&quot;memory_usage&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;used_memory_mb&quot;</span>: info.get(<span class="string">&quot;used_memory&quot;</span>, <span class="number">0</span>) / (<span class="number">1024</span> * <span class="number">1024</span>),</span><br><span class="line">                <span class="string">&quot;peak_memory_mb&quot;</span>: info.get(<span class="string">&quot;used_memory_peak&quot;</span>, <span class="number">0</span>) / (<span class="number">1024</span> * <span class="number">1024</span>),</span><br><span class="line">                <span class="string">&quot;fragmentation_ratio&quot;</span>: info.get(<span class="string">&quot;mem_fragmentation_ratio&quot;</span>, <span class="number">0</span>)</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;performance&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;hit_rate&quot;</span>: <span class="variable language_">self</span>._calculate_hit_rate(info),</span><br><span class="line">                <span class="string">&quot;ops_per_second&quot;</span>: info.get(<span class="string">&quot;instantaneous_ops_per_sec&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;total_commands&quot;</span>: info.get(<span class="string">&quot;total_commands_processed&quot;</span>, <span class="number">0</span>)</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;issues&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;evicted_keys&quot;</span>: info.get(<span class="string">&quot;evicted_keys&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;expired_keys&quot;</span>: info.get(<span class="string">&quot;expired_keys&quot;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;rejected_connections&quot;</span>: info.get(<span class="string">&quot;rejected_connections&quot;</span>, <span class="number">0</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_calculate_hit_rate</span>(<span class="params">self, info: <span class="type">Dict</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        hits = info.get(<span class="string">&quot;keyspace_hits&quot;</span>, <span class="number">0</span>)</span><br><span class="line">        misses = info.get(<span class="string">&quot;keyspace_misses&quot;</span>, <span class="number">0</span>)</span><br><span class="line">        total = hits + misses</span><br><span class="line">        <span class="keyword">return</span> hits / total <span class="keyword">if</span> total &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0.0</span></span><br></pre></td></tr></table></figure>

<h3 id="3-Interview-Questions-and-Answers"><a href="#3-Interview-Questions-and-Answers" class="headerlink" title="3. Interview Questions and Answers"></a>3. Interview Questions and Answers</h3><p><strong>Q: How would you handle a situation where your Redis instance is down?</strong></p>
<p><strong>A:</strong> I’d implement a multi-layered approach:</p>
<ol>
<li><strong>Circuit Breaker</strong>: Detect failures quickly and fail fast to prevent cascade failures</li>
<li><strong>Fallback Cache</strong>: Use in-memory cache or secondary Redis instance</li>
<li><strong>Graceful Degradation</strong>: Serve stale data when possible, direct database queries when necessary</li>
<li><strong>Health Checks</strong>: Implement proper health checks and automatic failover</li>
<li><strong>Monitoring</strong>: Set up alerts for Redis availability and performance metrics</li>
</ol>
<p><strong>Q: Explain the difference between cache penetration and cache breakdown.</strong></p>
<p><strong>A:</strong> </p>
<ul>
<li><strong>Cache Penetration</strong>: Queries for non-existent data bypass cache and hit database repeatedly. Solved by caching null values, bloom filters, or input validation.</li>
<li><strong>Cache Breakdown</strong>: Multiple concurrent requests try to rebuild the same expired cache entry simultaneously. Solved by distributed locking, logical expiration, or semaphores.</li>
</ul>
<p><strong>Q: How do you prevent cache avalanche in a high-traffic system?</strong></p>
<p><strong>A:</strong> Multiple strategies:</p>
<ol>
<li><strong>Randomized TTL</strong>: Add jitter to expiration times to prevent synchronized expiration</li>
<li><strong>Multi-level Caching</strong>: Use L1 (memory), L2 (Redis), L3 (backup) cache layers</li>
<li><strong>Circuit Breakers</strong>: Prevent cascade failures when cache is unavailable</li>
<li><strong>Gradual Rollouts</strong>: Stagger cache warming and deployments</li>
<li><strong>Monitoring</strong>: Proactive monitoring to detect issues early</li>
</ol>
<p><strong>Q: What metrics would you monitor for a Redis cache system?</strong></p>
<p><strong>A:</strong> Key metrics include:</p>
<ul>
<li><strong>Performance</strong>: Hit rate, miss rate, response time percentiles (p95, p99)</li>
<li><strong>Memory</strong>: Usage, fragmentation ratio, evicted keys</li>
<li><strong>Operations</strong>: Ops&#x2F;second, command distribution, slow queries</li>
<li><strong>Connectivity</strong>: Connected clients, rejected connections, network I&#x2F;O</li>
<li><strong>Persistence</strong>: RDB save status, AOF rewrite status</li>
<li><strong>Application</strong>: Error rates, cache penetration attempts, lock contention</li>
</ul>
<p><strong>Q: How would you design a cache system for a globally distributed application?</strong></p>
<p><strong>A:</strong> I’d consider:</p>
<ol>
<li><strong>Regional Clusters</strong>: Deploy Redis clusters in each region</li>
<li><strong>Consistency Strategy</strong>: Choose between strong consistency (slower) or eventual consistency (faster)</li>
<li><strong>Data Locality</strong>: Cache data close to where it’s consumed</li>
<li><strong>Cross-Region Replication</strong>: For critical shared data</li>
<li><strong>Intelligent Routing</strong>: Route requests to nearest available cache</li>
<li><strong>Conflict Resolution</strong>: Handle conflicts in distributed writes</li>
<li><strong>Monitoring</strong>: Global monitoring with regional dashboards</li>
</ol>
<p>This comprehensive approach demonstrates deep understanding of cache problems, practical solutions, and operational considerations that interviewers look for in senior engineers.</p>
<hr>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Cache problems like penetration, breakdown, and avalanche can severely impact system performance, but with proper understanding and implementation of solutions, they can be effectively mitigated. The key is to:</p>
<ol>
<li><strong>Understand the Problems</strong>: Know when and why each problem occurs</li>
<li><strong>Implement Multiple Solutions</strong>: Use layered approaches for robust protection</li>
<li><strong>Monitor Proactively</strong>: Set up comprehensive monitoring and alerting</li>
<li><strong>Plan for Failures</strong>: Design systems that gracefully handle cache failures</li>
<li><strong>Test Thoroughly</strong>: Validate your solutions under realistic load conditions</li>
</ol>
<p>Remember that cache optimization is an ongoing process that requires continuous monitoring, analysis, and improvement based on actual usage patterns and system behavior.</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/redis/" rel="tag"># redis</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/06/10/Redis-Deployment-Modes-Theory-Practice-and-Interview-Insights/" rel="prev" title="Redis Deployment Modes: Theory, Practice, and Interview Insights">
                  <i class="fa fa-angle-left"></i> Redis Deployment Modes: Theory, Practice, and Interview Insights
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/06/10/Redis-Caching-Patterns-and-Consistency-Assurance/" rel="next" title="Redis Caching Patterns and Consistency Assurance">
                  Redis Caching Patterns and Consistency Assurance <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Charlie Feng</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
