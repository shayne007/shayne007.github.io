<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"shayne007.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="This place is for thinking and sharing.">
<meta property="og:type" content="website">
<meta property="og:title" content="Charlie Feng&#39;s Tech Space">
<meta property="og:url" content="https://shayne007.github.io/index.html">
<meta property="og:site_name" content="Charlie Feng&#39;s Tech Space">
<meta property="og:description" content="This place is for thinking and sharing.">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Charlie Feng">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://shayne007.github.io/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Charlie Feng's Tech Space</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"cdn":false,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.5.0/mermaid.min.js","integrity":"sha256-2obLuIPcceEhkE3G09G33hBdmE55ivVcZUlcKcGNHjU="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>





  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Charlie Feng's Tech Space</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">You will survive with skills</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Charlie Feng</p>
  <div class="site-description" itemprop="description">This place is for thinking and sharing.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">48</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/25/Spring-Security-Framework-Complete-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/25/Spring-Security-Framework-Complete-Guide/" class="post-title-link" itemprop="url">Spring Security Framework - Complete Guide</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-25 20:24:29 / Modified: 20:26:34" itemprop="dateCreated datePublished" datetime="2025-06-25T20:24:29+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/spring/" itemprop="url" rel="index"><span itemprop="name">spring</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Core-Underlying-Principles"><a href="#Core-Underlying-Principles" class="headerlink" title="Core Underlying Principles"></a>Core Underlying Principles</h2><p>Spring Security is built on several fundamental principles that form the backbone of its architecture and functionality. Understanding these principles is crucial for implementing robust security solutions.</p>
<h3 id="Authentication-vs-Authorization"><a href="#Authentication-vs-Authorization" class="headerlink" title="Authentication vs Authorization"></a>Authentication vs Authorization</h3><p><strong>Authentication</strong> answers “Who are you?” while <strong>Authorization</strong> answers “What can you do?” Spring Security treats these as separate concerns, allowing for flexible security configurations.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Authentication - verifying identity</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    auth.inMemoryAuthentication()</span><br><span class="line">        .withUser(<span class="string">&quot;user&quot;</span>)</span><br><span class="line">        .password(passwordEncoder().encode(<span class="string">&quot;password&quot;</span>))</span><br><span class="line">        .roles(<span class="string">&quot;USER&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Authorization - defining access rules</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    http.authorizeRequests()</span><br><span class="line">        .antMatchers(<span class="string">&quot;/admin/**&quot;</span>).hasRole(<span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">        .antMatchers(<span class="string">&quot;/user/**&quot;</span>).hasRole(<span class="string">&quot;USER&quot;</span>)</span><br><span class="line">        .anyRequest().authenticated();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Security-Filter-Chain"><a href="#Security-Filter-Chain" class="headerlink" title="Security Filter Chain"></a>Security Filter Chain</h3><p>Spring Security operates through a chain of filters that intercept HTTP requests. Each filter has a specific responsibility and can either process the request or pass it to the next filter.</p>
<pre>
<code class="mermaid">
flowchart TD
A[HTTP Request] --&gt; B[Security Filter Chain]
B --&gt; C[SecurityContextPersistenceFilter]
C --&gt; D[UsernamePasswordAuthenticationFilter]
D --&gt; E[ExceptionTranslationFilter]
E --&gt; F[FilterSecurityInterceptor]
F --&gt; G[Application Controller]

style B fill:#e1f5fe
style G fill:#e8f5e8
</code>
</pre>

<h3 id="SecurityContext-and-SecurityContextHolder"><a href="#SecurityContext-and-SecurityContextHolder" class="headerlink" title="SecurityContext and SecurityContextHolder"></a>SecurityContext and SecurityContextHolder</h3><p>The SecurityContext stores security information for the current thread of execution. The SecurityContextHolder provides access to this context.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Getting current authenticated user</span></span><br><span class="line"><span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line"><span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> authentication.getName();</span><br><span class="line">Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; authorities = authentication.getAuthorities();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Setting security context programmatically</span></span><br><span class="line"><span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">token</span> <span class="operator">=</span> </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(user, <span class="literal">null</span>, authorities);</span><br><span class="line">SecurityContextHolder.getContext().setAuthentication(token);</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“How does Spring Security maintain security context across requests?”</em></p>
<blockquote>
<p>Spring Security uses ThreadLocal to store security context, ensuring thread safety. The SecurityContextPersistenceFilter loads the context from HttpSession at the beginning of each request and clears it at the end.</p>
</blockquote>
<h3 id="Principle-of-Least-Privilege"><a href="#Principle-of-Least-Privilege" class="headerlink" title="Principle of Least Privilege"></a>Principle of Least Privilege</h3><p>Spring Security encourages granting minimal necessary permissions. This is implemented through role-based and method-level security.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreAuthorize(&quot;hasRole(&#x27;ADMIN&#x27;) or (hasRole(&#x27;USER&#x27;) and #username == authentication.name)&quot;)</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">getUserDetails</span><span class="params">(<span class="meta">@PathVariable</span> String username)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> userService.findByUsername(username);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="When-to-Use-Spring-Security-Framework"><a href="#When-to-Use-Spring-Security-Framework" class="headerlink" title="When to Use Spring Security Framework"></a>When to Use Spring Security Framework</h2><h3 id="Enterprise-Applications"><a href="#Enterprise-Applications" class="headerlink" title="Enterprise Applications"></a>Enterprise Applications</h3><p>Spring Security is ideal for enterprise applications requiring:</p>
<ul>
<li>Complex authentication mechanisms (LDAP, OAuth2, SAML)</li>
<li>Fine-grained authorization</li>
<li>Audit trails and compliance requirements</li>
<li>Integration with existing identity providers</li>
</ul>
<h3 id="Web-Applications-with-User-Management"><a href="#Web-Applications-with-User-Management" class="headerlink" title="Web Applications with User Management"></a>Web Applications with User Management</h3><p>Perfect for applications featuring:</p>
<ul>
<li>User registration and login</li>
<li>Role-based access control</li>
<li>Session management</li>
<li>CSRF protection</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">            .authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/register&quot;</span>, <span class="string">&quot;/login&quot;</span>).permitAll()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/admin/**&quot;</span>).hasRole(<span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">            .and()</span><br><span class="line">            .formLogin()</span><br><span class="line">                .loginPage(<span class="string">&quot;/login&quot;</span>)</span><br><span class="line">                .defaultSuccessUrl(<span class="string">&quot;/dashboard&quot;</span>)</span><br><span class="line">            .and()</span><br><span class="line">            .logout()</span><br><span class="line">                .logoutSuccessUrl(<span class="string">&quot;/login?logout&quot;</span>)</span><br><span class="line">            .and()</span><br><span class="line">            .csrf().csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="REST-APIs-and-Microservices"><a href="#REST-APIs-and-Microservices" class="headerlink" title="REST APIs and Microservices"></a>REST APIs and Microservices</h3><p>Essential for securing REST APIs with:</p>
<ul>
<li>JWT token-based authentication</li>
<li>Stateless security</li>
<li>API rate limiting</li>
<li>Cross-origin resource sharing (CORS)</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtSecurityConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JwtAuthenticationEntryPoint <span class="title function_">jwtAuthenticationEntryPoint</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtAuthenticationEntryPoint</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JwtRequestFilter <span class="title function_">jwtRequestFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtRequestFilter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.csrf().disable()</span><br><span class="line">            .authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/api/auth/**&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">            .and()</span><br><span class="line">            .exceptionHandling().authenticationEntryPoint(jwtAuthenticationEntryPoint)</span><br><span class="line">            .and()</span><br><span class="line">            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);</span><br><span class="line">            </span><br><span class="line">        http.addFilterBefore(jwtRequestFilter, UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="When-NOT-to-Use-Spring-Security"><a href="#When-NOT-to-Use-Spring-Security" class="headerlink" title="When NOT to Use Spring Security"></a>When NOT to Use Spring Security</h3><ul>
<li>Simple applications with basic authentication needs</li>
<li>Applications with custom security requirements that conflict with Spring Security’s architecture</li>
<li>Performance-critical applications where the filter chain overhead is unacceptable</li>
<li>Applications requiring non-standard authentication flows</li>
</ul>
<h2 id="User-Login-Logout-and-Session-Management"><a href="#User-Login-Logout-and-Session-Management" class="headerlink" title="User Login, Logout, and Session Management"></a>User Login, Logout, and Session Management</h2><h3 id="Login-Process-Flow"><a href="#Login-Process-Flow" class="headerlink" title="Login Process Flow"></a>Login Process Flow</h3><pre>
<code class="mermaid">
sequenceDiagram
participant U as User
participant B as Browser
participant S as Spring Security
participant A as AuthenticationManager
participant P as AuthenticationProvider
participant D as UserDetailsService

U-&gt;&gt;B: Enter credentials
B-&gt;&gt;S: POST &#x2F;login
S-&gt;&gt;A: Authenticate request
A-&gt;&gt;P: Delegate authentication
P-&gt;&gt;D: Load user details
D--&gt;&gt;P: Return UserDetails
P--&gt;&gt;A: Authentication result
A--&gt;&gt;S: Authenticated user
S-&gt;&gt;B: Redirect to success URL
B-&gt;&gt;U: Display protected resource
</code>
</pre>

<h3 id="Custom-Login-Implementation"><a href="#Custom-Login-Implementation" class="headerlink" title="Custom Login Implementation"></a>Custom Login Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomUserDetailsService userDetailsService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomAuthenticationSuccessHandler successHandler;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomAuthenticationFailureHandler failureHandler;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">            .formLogin()</span><br><span class="line">                .loginPage(<span class="string">&quot;/custom-login&quot;</span>)</span><br><span class="line">                .loginProcessingUrl(<span class="string">&quot;/perform-login&quot;</span>)</span><br><span class="line">                .usernameParameter(<span class="string">&quot;email&quot;</span>)</span><br><span class="line">                .passwordParameter(<span class="string">&quot;pwd&quot;</span>)</span><br><span class="line">                .successHandler(successHandler)</span><br><span class="line">                .failureHandler(failureHandler)</span><br><span class="line">            .and()</span><br><span class="line">            .logout()</span><br><span class="line">                .logoutUrl(<span class="string">&quot;/perform-logout&quot;</span>)</span><br><span class="line">                .logoutSuccessHandler(customLogoutSuccessHandler())</span><br><span class="line">                .deleteCookies(<span class="string">&quot;JSESSIONID&quot;</span>)</span><br><span class="line">                .invalidateHttpSession(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CustomLogoutSuccessHandler <span class="title function_">customLogoutSuccessHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomLogoutSuccessHandler</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Custom-Authentication-Success-Handler"><a href="#Custom-Authentication-Success-Handler" class="headerlink" title="Custom Authentication Success Handler"></a>Custom Authentication Success Handler</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomAuthenticationSuccessHandler</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationSuccessHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(CustomAuthenticationSuccessHandler.class);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, </span></span><br><span class="line"><span class="params">                                      HttpServletResponse response,</span></span><br><span class="line"><span class="params">                                      Authentication authentication)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Log successful login</span></span><br><span class="line">        logger.info(<span class="string">&quot;User &#123;&#125; logged in successfully&quot;</span>, authentication.getName());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Update last login timestamp</span></span><br><span class="line">        updateLastLoginTime(authentication.getName());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Redirect based on role</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">redirectUrl</span> <span class="operator">=</span> determineTargetUrl(authentication);</span><br><span class="line">        response.sendRedirect(redirectUrl);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">determineTargetUrl</span><span class="params">(Authentication authentication)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isAdmin</span> <span class="operator">=</span> authentication.getAuthorities().stream()</span><br><span class="line">            .anyMatch(authority -&gt; authority.getAuthority().equals(<span class="string">&quot;ROLE_ADMIN&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> isAdmin ? <span class="string">&quot;/admin/dashboard&quot;</span> : <span class="string">&quot;/user/dashboard&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateLastLoginTime</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="comment">// Implementation to update user&#x27;s last login time</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Session-Management"><a href="#Session-Management" class="headerlink" title="Session Management"></a>Session Management</h3><p>Spring Security provides comprehensive session management capabilities:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    http</span><br><span class="line">        .sessionManagement()</span><br><span class="line">            .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED)</span><br><span class="line">            .maximumSessions(<span class="number">1</span>)</span><br><span class="line">            .maxSessionsPreventsLogin(<span class="literal">false</span>)</span><br><span class="line">            .sessionRegistry(sessionRegistry())</span><br><span class="line">            .and()</span><br><span class="line">        .sessionFixation().migrateSession()</span><br><span class="line">        .invalidSessionUrl(<span class="string">&quot;/login?expired&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> HttpSessionEventPublisher <span class="title function_">httpSessionEventPublisher</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HttpSessionEventPublisher</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> SessionRegistry <span class="title function_">sessionRegistry</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SessionRegistryImpl</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“How does Spring Security handle concurrent sessions?”</em></p>
<blockquote>
<p>Spring Security can limit concurrent sessions per user through SessionRegistry. When maximum sessions are exceeded, it can either prevent new logins or invalidate existing sessions based on configuration.</p>
</blockquote>
<h3 id="Session-Timeout-Configuration"><a href="#Session-Timeout-Configuration" class="headerlink" title="Session Timeout Configuration"></a>Session Timeout Configuration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// In application.properties</span></span><br><span class="line">server.servlet.session.timeout=30m</span><br><span class="line"></span><br><span class="line"><span class="comment">// Programmatic configuration</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    http</span><br><span class="line">        .sessionManagement()</span><br><span class="line">            .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED)</span><br><span class="line">            .and()</span><br><span class="line">        .rememberMe()</span><br><span class="line">            .key(<span class="string">&quot;uniqueAndSecret&quot;</span>)</span><br><span class="line">            .tokenValiditySeconds(<span class="number">86400</span>) <span class="comment">// 24 hours</span></span><br><span class="line">            .userDetailsService(userDetailsService);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Remember-Me-Functionality"><a href="#Remember-Me-Functionality" class="headerlink" title="Remember Me Functionality"></a>Remember Me Functionality</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RememberMeConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PersistentTokenRepository <span class="title function_">persistentTokenRepository</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">JdbcTokenRepositoryImpl</span> <span class="variable">tokenRepository</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcTokenRepositoryImpl</span>();</span><br><span class="line">        tokenRepository.setDataSource(dataSource);</span><br><span class="line">        <span class="keyword">return</span> tokenRepository;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">            .rememberMe()</span><br><span class="line">                .rememberMeParameter(<span class="string">&quot;remember-me&quot;</span>)</span><br><span class="line">                .tokenRepository(persistentTokenRepository())</span><br><span class="line">                .tokenValiditySeconds(<span class="number">86400</span>)</span><br><span class="line">                .userDetailsService(userDetailsService);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Logout-Process"><a href="#Logout-Process" class="headerlink" title="Logout Process"></a>Logout Process</h2><p>Proper logout implementation is essential for security, ensuring complete cleanup of user sessions and security contexts.</p>
<h3 id="Comprehensive-Logout-Configuration"><a href="#Comprehensive-Logout-Configuration" class="headerlink" title="Comprehensive Logout Configuration"></a>Comprehensive Logout Configuration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogoutConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityFilterChain <span class="title function_">logoutFilterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> http</span><br><span class="line">            .logout(logout -&gt; logout</span><br><span class="line">                .logoutUrl(<span class="string">&quot;/logout&quot;</span>)</span><br><span class="line">                .logoutRequestMatcher(<span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">&quot;/logout&quot;</span>, <span class="string">&quot;POST&quot;</span>))</span><br><span class="line">                .logoutSuccessUrl(<span class="string">&quot;/login?logout=true&quot;</span>)</span><br><span class="line">                .logoutSuccessHandler(customLogoutSuccessHandler())</span><br><span class="line">                .invalidateHttpSession(<span class="literal">true</span>)</span><br><span class="line">                .clearAuthentication(<span class="literal">true</span>)</span><br><span class="line">                .deleteCookies(<span class="string">&quot;JSESSIONID&quot;</span>, <span class="string">&quot;remember-me&quot;</span>)</span><br><span class="line">                .addLogoutHandler(customLogoutHandler())</span><br><span class="line">            )</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LogoutSuccessHandler <span class="title function_">customLogoutSuccessHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomLogoutSuccessHandler</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LogoutHandler <span class="title function_">customLogoutHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomLogoutHandler</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Custom-Logout-Handlers"><a href="#Custom-Logout-Handlers" class="headerlink" title="Custom Logout Handlers"></a>Custom Logout Handlers</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomLogoutHandler</span> <span class="keyword">implements</span> <span class="title class_">LogoutHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SessionRegistry sessionRegistry;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logout</span><span class="params">(HttpServletRequest request, HttpServletResponse response, </span></span><br><span class="line"><span class="params">            Authentication authentication)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (authentication != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> authentication.getName();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Clear user-specific cache</span></span><br><span class="line">            redisTemplate.delete(<span class="string">&quot;user:cache:&quot;</span> + username);</span><br><span class="line">            redisTemplate.delete(<span class="string">&quot;user:permissions:&quot;</span> + username);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Log logout event</span></span><br><span class="line">            logger.info(<span class="string">&quot;User &#123;&#125; logged out from IP: &#123;&#125;&quot;</span>, username, getClientIP(request));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Invalidate all sessions for this user (optional)</span></span><br><span class="line">            sessionRegistry.getAllPrincipals().stream()</span><br><span class="line">                .filter(principal -&gt; principal <span class="keyword">instanceof</span> UserDetails)</span><br><span class="line">                .filter(principal -&gt; ((UserDetails) principal).getUsername().equals(username))</span><br><span class="line">                .forEach(principal -&gt; </span><br><span class="line">                    sessionRegistry.getAllSessions(principal, <span class="literal">false</span>)</span><br><span class="line">                        .forEach(SessionInformation::expireNow)</span><br><span class="line">                );</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Clear security context</span></span><br><span class="line">        SecurityContextHolder.clearContext();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomLogoutSuccessHandler</span> <span class="keyword">implements</span> <span class="title class_">LogoutSuccessHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLogoutSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, </span></span><br><span class="line"><span class="params">            Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Add logout timestamp to response headers</span></span><br><span class="line">        response.addHeader(<span class="string">&quot;Logout-Time&quot;</span>, Instant.now().toString());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Redirect based on user agent or request parameter</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">redirectUrl</span> <span class="operator">=</span> <span class="string">&quot;/login?logout=true&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userAgent</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;User-Agent&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (userAgent != <span class="literal">null</span> &amp;&amp; userAgent.contains(<span class="string">&quot;Mobile&quot;</span>)) &#123;</span><br><span class="line">            redirectUrl = <span class="string">&quot;/mobile/login?logout=true&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        response.sendRedirect(redirectUrl);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Logout-Flow-Diagram"><a href="#Logout-Flow-Diagram" class="headerlink" title="Logout Flow Diagram"></a>Logout Flow Diagram</h3><pre>
<code class="mermaid">
sequenceDiagram
participant User
participant Browser
participant LogoutFilter
participant LogoutHandler
participant SessionRegistry
participant RedisCache
participant Database

User-&gt;&gt;Browser: Click logout
Browser-&gt;&gt;LogoutFilter: POST &#x2F;logout
LogoutFilter-&gt;&gt;LogoutHandler: Handle logout
LogoutHandler-&gt;&gt;SessionRegistry: Invalidate sessions
LogoutHandler-&gt;&gt;RedisCache: Clear user cache
LogoutHandler-&gt;&gt;Database: Log logout event
LogoutHandler--&gt;&gt;LogoutFilter: Cleanup complete
LogoutFilter-&gt;&gt;LogoutFilter: Clear SecurityContext
LogoutFilter--&gt;&gt;Browser: Redirect to login
Browser--&gt;&gt;User: Login page with logout message
</code>
</pre>

<h2 id="Advanced-Authentication-Mechanisms"><a href="#Advanced-Authentication-Mechanisms" class="headerlink" title="Advanced Authentication Mechanisms"></a>Advanced Authentication Mechanisms</h2><h3 id="JWT-Token-Based-Authentication"><a href="#JWT-Token-Based-Authentication" class="headerlink" title="JWT Token-Based Authentication"></a>JWT Token-Based Authentication</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtTokenUtil</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SECRET</span> <span class="operator">=</span> <span class="string">&quot;mySecretKey&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">JWT_TOKEN_VALIDITY</span> <span class="operator">=</span> <span class="number">5</span> * <span class="number">60</span> * <span class="number">60</span>; <span class="comment">// 5 hours</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generateToken</span><span class="params">(UserDetails userDetails)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; claims = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">return</span> createToken(claims, userDetails.getUsername());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">createToken</span><span class="params">(Map&lt;String, Object&gt; claims, String subject)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Jwts.builder()</span><br><span class="line">            .setClaims(claims)</span><br><span class="line">            .setSubject(subject)</span><br><span class="line">            .setIssuedAt(<span class="keyword">new</span> <span class="title class_">Date</span>(System.currentTimeMillis()))</span><br><span class="line">            .setExpiration(<span class="keyword">new</span> <span class="title class_">Date</span>(System.currentTimeMillis() + JWT_TOKEN_VALIDITY * <span class="number">1000</span>))</span><br><span class="line">            .signWith(SignatureAlgorithm.HS512, SECRET)</span><br><span class="line">            .compact();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">validateToken</span><span class="params">(String token, UserDetails userDetails)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> getUsernameFromToken(token);</span><br><span class="line">        <span class="keyword">return</span> (username.equals(userDetails.getUsername()) &amp;&amp; !isTokenExpired(token));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="OAuth2-Integration"><a href="#OAuth2-Integration" class="headerlink" title="OAuth2 Integration"></a>OAuth2 Integration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableOAuth2Client</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OAuth2Config</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> OAuth2RestTemplate <span class="title function_">oauth2RestTemplate</span><span class="params">(OAuth2ClientContext oauth2ClientContext)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OAuth2RestTemplate</span>(googleOAuth2ResourceDetails(), oauth2ClientContext);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> OAuth2ProtectedResourceDetails <span class="title function_">googleOAuth2ResourceDetails</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">AuthorizationCodeResourceDetails</span> <span class="variable">details</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthorizationCodeResourceDetails</span>();</span><br><span class="line">        details.setClientId(<span class="string">&quot;your-client-id&quot;</span>);</span><br><span class="line">        details.setClientSecret(<span class="string">&quot;your-client-secret&quot;</span>);</span><br><span class="line">        details.setAccessTokenUri(<span class="string">&quot;https://oauth2.googleapis.com/token&quot;</span>);</span><br><span class="line">        details.setUserAuthorizationUri(<span class="string">&quot;https://accounts.google.com/o/oauth2/auth&quot;</span>);</span><br><span class="line">        details.setScope(Arrays.asList(<span class="string">&quot;email&quot;</span>, <span class="string">&quot;profile&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> details;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Method-Level-Security"><a href="#Method-Level-Security" class="headerlink" title="Method-Level Security"></a>Method-Level Security</h2><h3 id="Enabling-Method-Security"><a href="#Enabling-Method-Security" class="headerlink" title="Enabling Method Security"></a>Enabling Method Security</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(</span></span><br><span class="line"><span class="meta">    prePostEnabled = true,</span></span><br><span class="line"><span class="meta">    securedEnabled = true,</span></span><br><span class="line"><span class="meta">    jsr250Enabled = true</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MethodSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">GlobalMethodSecurityConfiguration</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> MethodSecurityExpressionHandler <span class="title function_">createExpressionHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DefaultMethodSecurityExpressionHandler</span> <span class="variable">expressionHandler</span> <span class="operator">=</span> </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">DefaultMethodSecurityExpressionHandler</span>();</span><br><span class="line">        expressionHandler.setPermissionEvaluator(<span class="keyword">new</span> <span class="title class_">CustomPermissionEvaluator</span>());</span><br><span class="line">        <span class="keyword">return</span> expressionHandler;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Security-Annotations-in-Action"><a href="#Security-Annotations-in-Action" class="headerlink" title="Security Annotations in Action"></a>Security Annotations in Action</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DocumentService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasRole(&#x27;ADMIN&#x27;)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteDocument</span><span class="params">(Long documentId)</span> &#123;</span><br><span class="line">        <span class="comment">// Only admins can delete documents</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasRole(&#x27;USER&#x27;) and #document.owner == authentication.name&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">editDocument</span><span class="params">(<span class="meta">@P(&quot;document&quot;)</span> Document document)</span> &#123;</span><br><span class="line">        <span class="comment">// Users can only edit their own documents</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostAuthorize(&quot;returnObject.owner == authentication.name or hasRole(&#x27;ADMIN&#x27;)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Document <span class="title function_">getDocument</span><span class="params">(Long documentId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> documentRepository.findById(documentId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PreFilter(&quot;filterObject.owner == authentication.name&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processDocuments</span><span class="params">(List&lt;Document&gt; documents)</span> &#123;</span><br><span class="line">        <span class="comment">// Process only documents owned by the current user</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“What’s the difference between @PreAuthorize and @Secured?”</em></p>
<blockquote>
<p>@PreAuthorize supports SpEL expressions for complex authorization logic, while @Secured only supports role-based authorization. @PreAuthorize is more flexible and powerful.</p>
</blockquote>
<h2 id="Security-Best-Practices"><a href="#Security-Best-Practices" class="headerlink" title="Security Best Practices"></a>Security Best Practices</h2><h3 id="Password-Security"><a href="#Password-Security" class="headerlink" title="Password Security"></a>Password Security</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PasswordConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>(<span class="number">12</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordValidator <span class="title function_">passwordValidator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PasswordValidator</span>(Arrays.asList(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">LengthRule</span>(<span class="number">8</span>, <span class="number">30</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">CharacterRule</span>(EnglishCharacterData.UpperCase, <span class="number">1</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">CharacterRule</span>(EnglishCharacterData.LowerCase, <span class="number">1</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">CharacterRule</span>(EnglishCharacterData.Digit, <span class="number">1</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">CharacterRule</span>(EnglishCharacterData.Special, <span class="number">1</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">WhitespaceRule</span>()</span><br><span class="line">        ));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CSRF-Protection"><a href="#CSRF-Protection" class="headerlink" title="CSRF Protection"></a>CSRF Protection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    http</span><br><span class="line">        .csrf()</span><br><span class="line">            .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())</span><br><span class="line">            .ignoringAntMatchers(<span class="string">&quot;/api/public/**&quot;</span>)</span><br><span class="line">        .and()</span><br><span class="line">        .headers()</span><br><span class="line">            .frameOptions().deny()</span><br><span class="line">            .contentTypeOptions().and()</span><br><span class="line">            .httpStrictTransportSecurity(hstsConfig -&gt; hstsConfig</span><br><span class="line">                .maxAgeInSeconds(<span class="number">31536000</span>)</span><br><span class="line">                .includeSubdomains(<span class="literal">true</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Input-Validation-and-Sanitization"><a href="#Input-Validation-and-Sanitization" class="headerlink" title="Input Validation and Sanitization"></a>Input Validation and Sanitization</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/users&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;User&gt; <span class="title function_">createUser</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> CreateUserRequest request)</span> &#123;</span><br><span class="line">        <span class="comment">// Validation handled by @Valid annotation</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.createUser(request);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CreateUserRequest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;Username is required&quot;)</span></span><br><span class="line">    <span class="meta">@Size(min = 3, max = 20, message = &quot;Username must be between 3 and 20 characters&quot;)</span></span><br><span class="line">    <span class="meta">@Pattern(regexp = &quot;^[a-zA-Z0-9._-]+$&quot;, message = &quot;Username contains invalid characters&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;Email is required&quot;)</span></span><br><span class="line">    <span class="meta">@Email(message = &quot;Invalid email format&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;Password is required&quot;)</span></span><br><span class="line">    <span class="meta">@Size(min = 8, message = &quot;Password must be at least 8 characters&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Common-Security-Vulnerabilities-and-Mitigation"><a href="#Common-Security-Vulnerabilities-and-Mitigation" class="headerlink" title="Common Security Vulnerabilities and Mitigation"></a>Common Security Vulnerabilities and Mitigation</h2><h3 id="SQL-Injection-Prevention"><a href="#SQL-Injection-Prevention" class="headerlink" title="SQL Injection Prevention"></a>SQL Injection Prevention</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserRepository</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Vulnerable code (DON&#x27;T DO THIS)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">findByUsernameUnsafe</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;SELECT * FROM users WHERE username = &#x27;&quot;</span> + username + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.queryForObject(sql, User.class);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Secure code (DO THIS)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">findByUsernameSafe</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;SELECT * FROM users WHERE username = ?&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.queryForObject(sql, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;username&#125;, User.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="XSS-Prevention"><a href="#XSS-Prevention" class="headerlink" title="XSS Prevention"></a>XSS Prevention</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityHeadersConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FilterRegistrationBean&lt;XSSFilter&gt; <span class="title function_">xssPreventFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        FilterRegistrationBean&lt;XSSFilter&gt; registrationBean = <span class="keyword">new</span> <span class="title class_">FilterRegistrationBean</span>&lt;&gt;();</span><br><span class="line">        registrationBean.setFilter(<span class="keyword">new</span> <span class="title class_">XSSFilter</span>());</span><br><span class="line">        registrationBean.addUrlPatterns(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> registrationBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XSSFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, </span></span><br><span class="line"><span class="params">                        FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">XSSRequestWrapper</span> <span class="variable">wrappedRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XSSRequestWrapper</span>((HttpServletRequest) request);</span><br><span class="line">        chain.doFilter(wrappedRequest, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Testing-Spring-Security"><a href="#Testing-Spring-Security" class="headerlink" title="Testing Spring Security"></a>Testing Spring Security</h2><h3 id="Security-Testing-with-MockMvc"><a href="#Security-Testing-with-MockMvc" class="headerlink" title="Security Testing with MockMvc"></a>Security Testing with MockMvc</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@WebMvcTest(UserController.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserControllerSecurityTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MockMvc mockMvc;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@WithMockUser(roles = &quot;ADMIN&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testAdminAccessToUserData</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        mockMvc.perform(get(<span class="string">&quot;/admin/users&quot;</span>))</span><br><span class="line">            .andExpect(status().isOk());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@WithMockUser(roles = &quot;USER&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUserAccessToAdminEndpoint</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        mockMvc.perform(get(<span class="string">&quot;/admin/users&quot;</span>))</span><br><span class="line">            .andExpect(status().isForbidden());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUnauthenticatedAccess</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        mockMvc.perform(get(<span class="string">&quot;/user/profile&quot;</span>))</span><br><span class="line">            .andExpect(status().isUnauthorized());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Integration-Testing-with-TestContainers"><a href="#Integration-Testing-with-TestContainers" class="headerlink" title="Integration Testing with TestContainers"></a>Integration Testing with TestContainers</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Testcontainers</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityIntegrationTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Container</span></span><br><span class="line">    <span class="keyword">static</span> PostgreSQLContainer&lt;?&gt; postgres = <span class="keyword">new</span> <span class="title class_">PostgreSQLContainer</span>&lt;&gt;(<span class="string">&quot;postgres:13&quot;</span>)</span><br><span class="line">        .withDatabaseName(<span class="string">&quot;testdb&quot;</span>)</span><br><span class="line">        .withUsername(<span class="string">&quot;test&quot;</span>)</span><br><span class="line">        .withPassword(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TestRestTemplate restTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFullAuthenticationFlow</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Test user registration</span></span><br><span class="line">        ResponseEntity&lt;String&gt; registerResponse = restTemplate.postForEntity(</span><br><span class="line">            <span class="string">&quot;/api/auth/register&quot;</span>, </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">RegisterRequest</span>(<span class="string">&quot;test@example.com&quot;</span>, <span class="string">&quot;password123&quot;</span>),</span><br><span class="line">            String.class</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        assertThat(registerResponse.getStatusCode()).isEqualTo(HttpStatus.CREATED);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Test user login</span></span><br><span class="line">        ResponseEntity&lt;LoginResponse&gt; loginResponse = restTemplate.postForEntity(</span><br><span class="line">            <span class="string">&quot;/api/auth/login&quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">LoginRequest</span>(<span class="string">&quot;test@example.com&quot;</span>, <span class="string">&quot;password123&quot;</span>),</span><br><span class="line">            LoginResponse.class</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        assertThat(loginResponse.getStatusCode()).isEqualTo(HttpStatus.OK);</span><br><span class="line">        assertThat(loginResponse.getBody().getToken()).isNotNull();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Optimization"><a href="#Performance-Optimization" class="headerlink" title="Performance Optimization"></a>Performance Optimization</h2><h3 id="Security-Filter-Chain-Optimization"><a href="#Security-Filter-Chain-Optimization" class="headerlink" title="Security Filter Chain Optimization"></a>Security Filter Chain Optimization</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OptimizedSecurityConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">            <span class="comment">// Disable unnecessary features for API-only applications</span></span><br><span class="line">            .csrf().disable()</span><br><span class="line">            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span><br><span class="line">            .and()</span><br><span class="line">            <span class="comment">// Order matters - put most specific patterns first</span></span><br><span class="line">            .authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/api/public/**&quot;</span>).permitAll()</span><br><span class="line">                .antMatchers(HttpMethod.GET, <span class="string">&quot;/api/products/**&quot;</span>).permitAll()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/api/admin/**&quot;</span>).hasRole(<span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">                .anyRequest().authenticated();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Caching-Security-Context"><a href="#Caching-Security-Context" class="headerlink" title="Caching Security Context"></a>Caching Security Context</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityCacheConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CacheManager <span class="title function_">cacheManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConcurrentMapCacheManager</span>(<span class="string">&quot;userCache&quot;</span>, <span class="string">&quot;permissionCache&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Service</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CachedUserDetailsService</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Cacheable(value = &quot;userCache&quot;, key = &quot;#username&quot;)</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">            <span class="keyword">return</span> userRepository.findByUsername(username)</span><br><span class="line">                .map(<span class="built_in">this</span>::createUserPrincipal)</span><br><span class="line">                .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">UsernameNotFoundException</span>(<span class="string">&quot;User not found: &quot;</span> + username));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Troubleshooting-Common-Issues"><a href="#Troubleshooting-Common-Issues" class="headerlink" title="Troubleshooting Common Issues"></a>Troubleshooting Common Issues</h2><h3 id="Debug-Security-Configuration"><a href="#Debug-Security-Configuration" class="headerlink" title="Debug Security Configuration"></a>Debug Security Configuration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DebugSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        web.debug(<span class="literal">true</span>); <span class="comment">// Enable security debugging</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Logger <span class="title function_">securityLogger</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="string">&quot;org.springframework.security&quot;</span>);</span><br><span class="line">        ((ch.qos.logback.classic.Logger) logger).setLevel(Level.DEBUG);</span><br><span class="line">        <span class="keyword">return</span> logger;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Common-Configuration-Mistakes"><a href="#Common-Configuration-Mistakes" class="headerlink" title="Common Configuration Mistakes"></a>Common Configuration Mistakes</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WRONG: Ordering matters in security configuration</span></span><br><span class="line">http.authorizeRequests()</span><br><span class="line">    .anyRequest().authenticated()  <span class="comment">// This catches everything</span></span><br><span class="line">    .antMatchers(<span class="string">&quot;/public/**&quot;</span>).permitAll(); <span class="comment">// This never gets reached</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// CORRECT: Specific patterns first</span></span><br><span class="line">http.authorizeRequests()</span><br><span class="line">    .antMatchers(<span class="string">&quot;/public/**&quot;</span>).permitAll()</span><br><span class="line">    .anyRequest().authenticated();</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“What happens when Spring Security configuration conflicts occur?”</em></p>
<blockquote>
<p>Spring Security evaluates rules in order. The first matching rule wins, so specific patterns must come before general ones. Always place more restrictive rules before less restrictive ones.</p>
</blockquote>
<h2 id="Monitoring-and-Auditing"><a href="#Monitoring-and-Auditing" class="headerlink" title="Monitoring and Auditing"></a>Monitoring and Auditing</h2><h3 id="Security-Events-Logging"><a href="#Security-Events-Logging" class="headerlink" title="Security Events Logging"></a>Security Events Logging</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityEventListener</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(SecurityEventListener.class);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleAuthenticationSuccess</span><span class="params">(AuthenticationSuccessEvent event)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;User &#x27;&#123;&#125;&#x27; logged in successfully from IP: &#123;&#125;&quot;</span>, </span><br><span class="line">            event.getAuthentication().getName(),</span><br><span class="line">            getClientIpAddress());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleAuthenticationFailure</span><span class="params">(AbstractAuthenticationFailureEvent event)</span> &#123;</span><br><span class="line">        logger.warn(<span class="string">&quot;Authentication failed for user &#x27;&#123;&#125;&#x27;: &#123;&#125;&quot;</span>, </span><br><span class="line">            event.getAuthentication().getName(),</span><br><span class="line">            event.getException().getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleAuthorizationFailure</span><span class="params">(AuthorizationFailureEvent event)</span> &#123;</span><br><span class="line">        logger.warn(<span class="string">&quot;Authorization failed for user &#x27;&#123;&#125;&#x27; accessing resource: &#123;&#125;&quot;</span>, </span><br><span class="line">            event.getAuthentication().getName(),</span><br><span class="line">            event.getRequestUrl());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Metrics-and-Monitoring"><a href="#Metrics-and-Monitoring" class="headerlink" title="Metrics and Monitoring"></a>Metrics and Monitoring</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityMetrics</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter loginAttempts;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter loginFailures;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SecurityMetrics</span><span class="params">(MeterRegistry meterRegistry)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.meterRegistry = meterRegistry;</span><br><span class="line">        <span class="built_in">this</span>.loginAttempts = Counter.builder(<span class="string">&quot;security.login.attempts&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Total login attempts&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">        <span class="built_in">this</span>.loginFailures = Counter.builder(<span class="string">&quot;security.login.failures&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Failed login attempts&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLoginAttempt</span><span class="params">(AuthenticationSuccessEvent event)</span> &#123;</span><br><span class="line">        loginAttempts.increment();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLoginFailure</span><span class="params">(AbstractAuthenticationFailureEvent event)</span> &#123;</span><br><span class="line">        loginAttempts.increment();</span><br><span class="line">        loginFailures.increment();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Interview-Questions-and-Answers"><a href="#Interview-Questions-and-Answers" class="headerlink" title="Interview Questions and Answers"></a>Interview Questions and Answers</h2><h3 id="Technical-Deep-Dive-Questions"><a href="#Technical-Deep-Dive-Questions" class="headerlink" title="Technical Deep Dive Questions"></a>Technical Deep Dive Questions</h3><p><strong>Q: Explain the difference between authentication and authorization in Spring Security.</strong><br>A: Authentication verifies identity (“who are you?”) while authorization determines permissions (“what can you do?”). Spring Security separates these concerns - AuthenticationManager handles authentication, while AccessDecisionManager handles authorization decisions.</p>
<p><strong>Q: How does Spring Security handle stateless authentication?</strong><br>A: For stateless authentication, Spring Security doesn’t maintain session state. Instead, it uses tokens (like JWT) passed with each request. Configure with <code>SessionCreationPolicy.STATELESS</code> and implement token-based filters.</p>
<p><strong>Q: What is the purpose of SecurityContextHolder?</strong><br>A: SecurityContextHolder provides access to the SecurityContext, which stores authentication information for the current thread. It uses ThreadLocal to ensure thread safety and provides three strategies: ThreadLocal (default), InheritableThreadLocal, and Global.</p>
<p><strong>Q: How do you implement custom authentication in Spring Security?</strong><br>A: Implement custom authentication by:</p>
<ol>
<li>Creating a custom AuthenticationProvider</li>
<li>Implementing authenticate() method</li>
<li>Registering the provider with AuthenticationManager</li>
<li>Optionally creating custom Authentication tokens</li>
</ol>
<h3 id="Practical-Implementation-Questions"><a href="#Practical-Implementation-Questions" class="headerlink" title="Practical Implementation Questions"></a>Practical Implementation Questions</h3><p><strong>Q: How would you secure a REST API with JWT tokens?</strong><br>A: Implement JWT security by:</p>
<ol>
<li>Creating JWT utility class for token generation&#x2F;validation</li>
<li>Implementing JwtAuthenticationEntryPoint for unauthorized access</li>
<li>Creating JwtRequestFilter to validate tokens</li>
<li>Configuring HttpSecurity with stateless session management</li>
<li>Adding JWT filter before UsernamePasswordAuthenticationFilter</li>
</ol>
<p><strong>Q: What are the security implications of CSRF and how does Spring Security handle it?</strong><br>A: CSRF attacks trick users into performing unwanted actions. Spring Security provides CSRF protection by:</p>
<ol>
<li>Generating unique tokens for each session</li>
<li>Validating tokens on state-changing requests</li>
<li>Storing tokens in HttpSession or cookies</li>
<li>Automatically including tokens in forms via Thymeleaf integration</li>
</ol>
<h2 id="External-Resources-and-References"><a href="#External-Resources-and-References" class="headerlink" title="External Resources and References"></a>External Resources and References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/">Spring Security Reference Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://spring.io/guides/tutorials/spring-boot-oauth2/">Spring Security OAuth2 Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://owasp.org/www-project-top-ten/">OWASP Security Guidelines</a></li>
<li><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc8725">JWT Best Practices</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/web.html#web.security">Spring Boot Security Auto-configuration</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/servlet/test/index.html">Spring Security Test Documentation</a></li>
</ul>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Spring Security provides a comprehensive, flexible framework for securing Java applications. Its architecture based on filters, authentication managers, and security contexts allows for sophisticated security implementations while maintaining clean separation of concerns. Success with Spring Security requires understanding its core principles, proper configuration, and adherence to security best practices.</p>
<p>The framework’s strength lies in its ability to handle complex security requirements while providing sensible defaults for common use cases. Whether building traditional web applications or modern microservices, Spring Security offers the tools and flexibility needed to implement robust security solutions.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/19/Java-Virtual-Machine-Garbage-Collection-Complete-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/19/Java-Virtual-Machine-Garbage-Collection-Complete-Guide/" class="post-title-link" itemprop="url">Java Virtual Machine Garbage Collection - Complete Guide</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-19 20:00:34 / Modified: 20:02:55" itemprop="dateCreated datePublished" datetime="2025-06-19T20:00:34+08:00">2025-06-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Memory-Management-Fundamentals"><a href="#Memory-Management-Fundamentals" class="headerlink" title="Memory Management Fundamentals"></a>Memory Management Fundamentals</h2><p>Java’s automatic memory management through garbage collection is one of its key features that differentiates it from languages like C and C++. The JVM automatically handles memory allocation and deallocation, freeing developers from manual memory management while preventing memory leaks and dangling pointer issues.</p>
<h3 id="Memory-Layout-Overview"><a href="#Memory-Layout-Overview" class="headerlink" title="Memory Layout Overview"></a>Memory Layout Overview</h3><p>The JVM heap is divided into several regions, each serving specific purposes in the garbage collection process:</p>
<pre>
<code class="mermaid">
flowchart TB
subgraph &quot;JVM Memory Structure&quot;
    subgraph &quot;Heap Memory&quot;
        subgraph &quot;Young Generation&quot;
            Eden[&quot;Eden Space&quot;]
            S0[&quot;Survivor 0&quot;]
            S1[&quot;Survivor 1&quot;]
        end
        
        subgraph &quot;Old Generation&quot;
            OldGen[&quot;Old Generation (Tenured)&quot;]
        end
        
        MetaSpace[&quot;Metaspace (Java 8+)&quot;]
    end
    
    subgraph &quot;Non-Heap Memory&quot;
        PC[&quot;Program Counter&quot;]
        Stack[&quot;Java Stacks&quot;]
        Native[&quot;Native Method Stacks&quot;]
        Direct[&quot;Direct Memory&quot;]
    end
end
</code>
</pre>

<p><strong>Interview Insight</strong>: <em>“Can you explain the difference between heap and non-heap memory in JVM?”</em></p>
<p><strong>Answer</strong>: Heap memory stores object instances and arrays, managed by GC. Non-heap includes method area (storing class metadata), program counter registers, and stack memory (storing method calls and local variables). Only heap memory is subject to garbage collection.</p>
<h2 id="GC-Roots-and-Object-Reachability"><a href="#GC-Roots-and-Object-Reachability" class="headerlink" title="GC Roots and Object Reachability"></a>GC Roots and Object Reachability</h2><h3 id="Understanding-GC-Roots"><a href="#Understanding-GC-Roots" class="headerlink" title="Understanding GC Roots"></a>Understanding GC Roots</h3><p>GC Roots are the starting points for garbage collection algorithms to determine object reachability. An object is considered “reachable” if there’s a path from any GC Root to that object.</p>
<p><strong>Primary GC Roots include:</strong></p>
<ul>
<li><strong>Local Variables</strong>: Variables in currently executing methods</li>
<li><strong>Static Variables</strong>: Class-level static references</li>
<li><strong>JNI References</strong>: Objects referenced from native code</li>
<li><strong>Monitor Objects</strong>: Objects used for synchronization</li>
<li><strong>Thread Objects</strong>: Active thread instances</li>
<li><strong>Class Objects</strong>: Loaded class instances in Metaspace</li>
</ul>
<pre>
<code class="mermaid">
flowchart TD
subgraph &quot;GC Roots&quot;
    LV[&quot;Local Variables&quot;]
    SV[&quot;Static Variables&quot;]
    JNI[&quot;JNI References&quot;]
    TO[&quot;Thread Objects&quot;]
end

subgraph &quot;Heap Objects&quot;
    A[&quot;Object A&quot;]
    B[&quot;Object B&quot;]
    C[&quot;Object C&quot;]
    D[&quot;Object D (Unreachable)&quot;]
end

LV --&gt; A
SV --&gt; B
A --&gt; C
B --&gt; C

style D fill:#ff6b6b
style A fill:#51cf66
style B fill:#51cf66
style C fill:#51cf66
</code>
</pre>

<h3 id="Object-Reachability-Algorithm"><a href="#Object-Reachability-Algorithm" class="headerlink" title="Object Reachability Algorithm"></a>Object Reachability Algorithm</h3><p>The reachability analysis works through a mark-and-sweep approach:</p>
<ol>
<li><strong>Mark Phase</strong>: Starting from GC Roots, mark all reachable objects</li>
<li><strong>Sweep Phase</strong>: Reclaim memory of unmarked (unreachable) objects</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Example: Object Reachability</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReachabilityExample</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object staticRef;  <span class="comment">// GC Root</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demonstrateReachability</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">localRef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();     <span class="comment">// GC Root (local variable)</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">chainedObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Creating reference chain</span></span><br><span class="line">        localRef.someField = chainedObj;    <span class="comment">// chainedObj is reachable</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Breaking reference chain</span></span><br><span class="line">        localRef = <span class="literal">null</span>;                    <span class="comment">// chainedObj becomes unreachable</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“How does JVM determine if an object is eligible for garbage collection?”</em></p>
<p><strong>Answer</strong>: JVM uses reachability analysis starting from GC Roots. If an object cannot be reached through any path from GC Roots, it becomes eligible for GC. This is more reliable than reference counting as it handles circular references correctly.</p>
<h2 id="Object-Reference-Types"><a href="#Object-Reference-Types" class="headerlink" title="Object Reference Types"></a>Object Reference Types</h2><p>Java provides different reference types that interact with garbage collection in distinct ways:</p>
<h3 id="Strong-References"><a href="#Strong-References" class="headerlink" title="Strong References"></a>Strong References</h3><p>Default reference type that prevents garbage collection:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();  <span class="comment">// Strong reference</span></span><br><span class="line"><span class="comment">// obj will not be collected while this reference exists</span></span><br></pre></td></tr></table></figure>

<h3 id="Weak-References"><a href="#Weak-References" class="headerlink" title="Weak References"></a>Weak References</h3><p>Allow garbage collection even when references exist:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.ref.WeakReference;</span><br><span class="line"></span><br><span class="line">WeakReference&lt;Object&gt; weakRef = <span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">Object</span>());</span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> weakRef.get();  <span class="comment">// May return null if collected</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Common use case: Cache implementation</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeakCache</span>&lt;K, V&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;K, WeakReference&lt;V&gt;&gt; cache = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> V <span class="title function_">get</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        WeakReference&lt;V&gt; ref = cache.get(key);</span><br><span class="line">        <span class="keyword">return</span> (ref != <span class="literal">null</span>) ? ref.get() : <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Soft-References"><a href="#Soft-References" class="headerlink" title="Soft References"></a>Soft References</h3><p>More aggressive than weak references, collected only when memory is low:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.ref.SoftReference;</span><br><span class="line"></span><br><span class="line">SoftReference&lt;LargeObject&gt; softRef = <span class="keyword">new</span> <span class="title class_">SoftReference</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">LargeObject</span>());</span><br><span class="line"><span class="comment">// Collected only when JVM needs memory</span></span><br></pre></td></tr></table></figure>

<h3 id="Phantom-References"><a href="#Phantom-References" class="headerlink" title="Phantom References"></a>Phantom References</h3><p>Used for cleanup operations, cannot retrieve the object:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.ref.PhantomReference;</span><br><span class="line"><span class="keyword">import</span> java.lang.ref.ReferenceQueue;</span><br><span class="line"></span><br><span class="line">ReferenceQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">ReferenceQueue</span>&lt;&gt;();</span><br><span class="line">PhantomReference&lt;Object&gt; phantomRef = <span class="keyword">new</span> <span class="title class_">PhantomReference</span>&lt;&gt;(obj, queue);</span><br><span class="line"><span class="comment">// Used for resource cleanup notification</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“When would you use WeakReference vs SoftReference?”</em></p>
<p><strong>Answer</strong>: Use WeakReference for cache entries that can be recreated easily (like parsed data). Use SoftReference for memory-sensitive caches where you want to keep objects as long as possible but allow collection under memory pressure.</p>
<h2 id="Generational-Garbage-Collection"><a href="#Generational-Garbage-Collection" class="headerlink" title="Generational Garbage Collection"></a>Generational Garbage Collection</h2><h3 id="The-Generational-Hypothesis"><a href="#The-Generational-Hypothesis" class="headerlink" title="The Generational Hypothesis"></a>The Generational Hypothesis</h3><p>Most objects die young - this fundamental observation drives generational GC design:</p>
<pre>
<code class="mermaid">
flowchart LR
subgraph &quot;Object Lifecycle&quot;
    A[&quot;Object Creation&quot;] --&gt; B[&quot;Short-lived Objects (90%+)&quot;]
    A --&gt; C[&quot;Long-lived Objects (&lt;10%)&quot;]
    B --&gt; D[&quot;Die in Young Generation&quot;]
    C --&gt; E[&quot;Promoted to Old Generation&quot;]
end
</code>
</pre>

<h3 id="Young-Generation-Structure"><a href="#Young-Generation-Structure" class="headerlink" title="Young Generation Structure"></a>Young Generation Structure</h3><p><strong>Eden Space</strong>: Where new objects are allocated<br><strong>Survivor Spaces (S0, S1)</strong>: Hold objects that survived at least one GC cycle</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Example: Object allocation flow</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AllocationExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demonstrateAllocation</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Objects allocated in Eden space</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();  <span class="comment">// Allocated in Eden</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">100</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// Some objects may survive longer</span></span><br><span class="line">                longLivedList.add(obj);  <span class="comment">// May get promoted to Old Gen</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Minor-GC-Process"><a href="#Minor-GC-Process" class="headerlink" title="Minor GC Process"></a>Minor GC Process</h3><ol>
<li><strong>Allocation</strong>: New objects go to Eden</li>
<li><strong>Eden Full</strong>: Triggers Minor GC</li>
<li><strong>Survival</strong>: Live objects move to Survivor space</li>
<li><strong>Age Increment</strong>: Survivor objects get age incremented</li>
<li><strong>Promotion</strong>: Old enough objects move to Old Generation</li>
</ol>
<pre>
<code class="mermaid">
sequenceDiagram
participant E as Eden Space
participant S0 as Survivor 0
participant S1 as Survivor 1
participant O as Old Generation

E-&gt;&gt;S0: First GC: Move live objects
Note over S0: Age &#x3D; 1
E-&gt;&gt;S0: Second GC: New objects to S0
S0-&gt;&gt;S1: Move aged objects
Note over S1: Age &#x3D; 2
S1-&gt;&gt;O: Promotion (Age &gt;&#x3D; threshold)
</code>
</pre>

<h3 id="Major-GC-and-Old-Generation"><a href="#Major-GC-and-Old-Generation" class="headerlink" title="Major GC and Old Generation"></a>Major GC and Old Generation</h3><p>Old Generation uses different algorithms optimized for long-lived objects:</p>
<ul>
<li><strong>Concurrent Collection</strong>: Minimize application pause times</li>
<li><strong>Compaction</strong>: Reduce fragmentation</li>
<li><strong>Different Triggers</strong>: Based on Old Gen occupancy or allocation failure</li>
</ul>
<p><strong>Interview Insight</strong>: <em>“Why is Minor GC faster than Major GC?”</em></p>
<p><strong>Answer</strong>: Minor GC only processes Young Generation (smaller space, most objects are dead). Major GC processes entire heap or Old Generation (larger space, more live objects), often requiring more complex algorithms like concurrent marking or compaction.</p>
<h2 id="Garbage-Collection-Algorithms"><a href="#Garbage-Collection-Algorithms" class="headerlink" title="Garbage Collection Algorithms"></a>Garbage Collection Algorithms</h2><h3 id="Mark-and-Sweep"><a href="#Mark-and-Sweep" class="headerlink" title="Mark and Sweep"></a>Mark and Sweep</h3><p>The fundamental GC algorithm:</p>
<p><strong>Mark Phase</strong>: Identify live objects starting from GC Roots<br><strong>Sweep Phase</strong>: Reclaim memory from dead objects</p>
<pre>
<code class="mermaid">
flowchart TD
subgraph &quot;Mark Phase&quot;
    A[&quot;Start from GC Roots&quot;] --&gt; B[&quot;Mark Reachable Objects&quot;]
    B --&gt; C[&quot;Traverse Reference Graph&quot;]
end

subgraph &quot;Sweep Phase&quot;
    D[&quot;Scan Heap&quot;] --&gt; E[&quot;Identify Unmarked Objects&quot;]
    E --&gt; F[&quot;Reclaim Memory&quot;]
end

C --&gt; D
</code>
</pre>

<p><strong>Advantages</strong>: Simple, handles circular references<br><strong>Disadvantages</strong>: Stop-the-world pauses, fragmentation</p>
<h3 id="Copying-Algorithm"><a href="#Copying-Algorithm" class="headerlink" title="Copying Algorithm"></a>Copying Algorithm</h3><p>Used primarily in Young Generation:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Conceptual representation</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CopyingGC</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Space fromSpace;</span><br><span class="line">    <span class="keyword">private</span> Space toSpace;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">collect</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Copy live objects from &#x27;from&#x27; to &#x27;to&#x27; space</span></span><br><span class="line">        <span class="keyword">for</span> (Object obj : fromSpace.getLiveObjects()) &#123;</span><br><span class="line">            toSpace.copy(obj);</span><br><span class="line">            updateReferences(obj);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Swap spaces</span></span><br><span class="line">        <span class="type">Space</span> <span class="variable">temp</span> <span class="operator">=</span> fromSpace;</span><br><span class="line">        fromSpace = toSpace;</span><br><span class="line">        toSpace = temp;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Clear old space</span></span><br><span class="line">        temp.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Advantages</strong>: No fragmentation, fast allocation<br><strong>Disadvantages</strong>: Requires double memory, inefficient for high survival rates</p>
<h3 id="Mark-Compact-Algorithm"><a href="#Mark-Compact-Algorithm" class="headerlink" title="Mark-Compact Algorithm"></a>Mark-Compact Algorithm</h3><p>Combines marking with compaction:</p>
<ol>
<li><strong>Mark</strong>: Identify live objects</li>
<li><strong>Compact</strong>: Move live objects to eliminate fragmentation</li>
</ol>
<pre>
<code class="mermaid">
flowchart LR
subgraph &quot;Before Compaction&quot;
    A[&quot;Live&quot;] --&gt; B[&quot;Dead&quot;] --&gt; C[&quot;Live&quot;] --&gt; D[&quot;Dead&quot;] --&gt; E[&quot;Live&quot;]
end
</code>
</pre>
<pre>
<code class="mermaid">
flowchart LR
subgraph &quot;After Compaction&quot;
    F[&quot;Live&quot;] --&gt; G[&quot;Live&quot;] --&gt; H[&quot;Live&quot;] --&gt; I[&quot;Free Space&quot;]
end
</code>
</pre>

<p><strong>Interview Insight</strong>: <em>“Why doesn’t Young Generation use Mark-Compact algorithm?”</em></p>
<p><strong>Answer</strong>: Young Generation has high mortality rate (90%+ objects die), making copying algorithm more efficient. Mark-Compact is better for Old Generation where most objects survive and fragmentation is a concern.</p>
<h3 id="Incremental-and-Concurrent-Algorithms"><a href="#Incremental-and-Concurrent-Algorithms" class="headerlink" title="Incremental and Concurrent Algorithms"></a>Incremental and Concurrent Algorithms</h3><p><strong>Incremental GC</strong>: Breaks GC work into small increments<br><strong>Concurrent GC</strong>: Runs GC concurrently with application threads</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Tri-color marking for concurrent GC</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">ObjectColor</span> &#123;</span><br><span class="line">    WHITE,  <span class="comment">// Not visited</span></span><br><span class="line">    GRAY,   <span class="comment">// Visited but children not processed</span></span><br><span class="line">    BLACK   <span class="comment">// Visited and children processed</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConcurrentMarking</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">concurrentMark</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Mark roots as gray</span></span><br><span class="line">        <span class="keyword">for</span> (Object root : gcRoots) &#123;</span><br><span class="line">            root.color = GRAY;</span><br><span class="line">            grayQueue.add(root);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Process gray objects concurrently</span></span><br><span class="line">        <span class="keyword">while</span> (!grayQueue.isEmpty() &amp;&amp; !shouldYield()) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> grayQueue.poll();</span><br><span class="line">            <span class="keyword">for</span> (Object child : obj.getReferences()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (child.color == WHITE) &#123;</span><br><span class="line">                    child.color = GRAY;</span><br><span class="line">                    grayQueue.add(child);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            obj.color = BLACK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Garbage-Collectors-Evolution"><a href="#Garbage-Collectors-Evolution" class="headerlink" title="Garbage Collectors Evolution"></a>Garbage Collectors Evolution</h2><h3 id="Serial-GC-XX-UseSerialGC"><a href="#Serial-GC-XX-UseSerialGC" class="headerlink" title="Serial GC (-XX:+UseSerialGC)"></a>Serial GC (-XX:+UseSerialGC)</h3><p><strong>Characteristics</strong>: Single-threaded, stop-the-world<br><strong>Best for</strong>: Small applications, client-side applications<br><strong>JVM Versions</strong>: All versions</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># JVM flags for Serial GC</span></span><br><span class="line">java -XX:+UseSerialGC -Xmx512m MyApplication</span><br></pre></td></tr></table></figure>

<p><strong>Use Case Example</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Small desktop application</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CalculatorApp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// Serial GC sufficient for small heap sizes</span></span><br><span class="line">        SwingUtilities.invokeLater(() -&gt; <span class="keyword">new</span> <span class="title class_">Calculator</span>().setVisible(<span class="literal">true</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Parallel-GC-XX-UseParallelGC"><a href="#Parallel-GC-XX-UseParallelGC" class="headerlink" title="Parallel GC (-XX:+UseParallelGC)"></a>Parallel GC (-XX:+UseParallelGC)</h3><p><strong>Characteristics</strong>: Multi-threaded, throughput-focused<br><strong>Best for</strong>: Batch processing, throughput-sensitive applications<br><strong>Default</strong>: Java 8 (server-class machines)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Parallel GC configuration</span></span><br><span class="line">java -XX:+UseParallelGC -XX:ParallelGCThreads=4 -Xmx2g MyBatchJob</span><br></pre></td></tr></table></figure>

<p><strong>Production Example</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Data processing application</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataProcessor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processBatch</span><span class="params">(List&lt;Record&gt; records)</span> &#123;</span><br><span class="line">        <span class="comment">// High throughput processing</span></span><br><span class="line">        records.parallelStream()</span><br><span class="line">               .map(<span class="built_in">this</span>::transform)</span><br><span class="line">               .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CMS-GC-XX-UseConcMarkSweepGC-Deprecated-in-Java-14"><a href="#CMS-GC-XX-UseConcMarkSweepGC-Deprecated-in-Java-14" class="headerlink" title="CMS GC (-XX:+UseConcMarkSweepGC) [Deprecated in Java 14]"></a>CMS GC (-XX:+UseConcMarkSweepGC) [Deprecated in Java 14]</h3><p><strong>Phases</strong>:</p>
<ol>
<li>Initial Mark (STW)</li>
<li>Concurrent Mark</li>
<li>Concurrent Preclean</li>
<li>Remark (STW)</li>
<li>Concurrent Sweep</li>
</ol>
<p><strong>Characteristics</strong>: Concurrent, low-latency focused<br><strong>Best for</strong>: Web applications requiring low pause times</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMS configuration (legacy)</span></span><br><span class="line">java -XX:+UseConcMarkSweepGC -XX:+CMSIncrementalMode -Xmx4g WebApp</span><br></pre></td></tr></table></figure>

<h3 id="G1-GC-XX-UseG1GC"><a href="#G1-GC-XX-UseG1GC" class="headerlink" title="G1 GC (-XX:+UseG1GC)"></a>G1 GC (-XX:+UseG1GC)</h3><p><strong>Characteristics</strong>: Low-latency, region-based, predictable pause times<br><strong>Best for</strong>: Large heaps (&gt;4GB), latency-sensitive applications<br><strong>Default</strong>: Java 9+</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># G1 GC tuning</span></span><br><span class="line">java -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:G1HeapRegionSize=16m -Xmx8g</span><br></pre></td></tr></table></figure>

<p><strong>Region-based Architecture</strong>:</p>
<pre>
<code class="mermaid">
flowchart TB
subgraph &quot;G1 Heap Regions&quot;
    subgraph &quot;Young Regions&quot;
        E1[&quot;Eden 1&quot;]
        E2[&quot;Eden 2&quot;]
        S1[&quot;Survivor 1&quot;]
    end
    
    subgraph &quot;Old Regions&quot;
        O1[&quot;Old 1&quot;]
        O2[&quot;Old 2&quot;]
        O3[&quot;Old 3&quot;]
    end
    
    subgraph &quot;Special Regions&quot;
        H[&quot;Humongous&quot;]
        F[&quot;Free&quot;]
    end
end
</code>
</pre>

<p><strong>Interview Insight</strong>: <em>“When would you choose G1 over Parallel GC?”</em></p>
<p><strong>Answer</strong>: Choose G1 for applications requiring predictable low pause times (&lt;200ms) with large heaps (&gt;4GB). Use Parallel GC for batch processing where throughput is more important than latency.</p>
<h3 id="ZGC-XX-UseZGC-Java-11"><a href="#ZGC-XX-UseZGC-Java-11" class="headerlink" title="ZGC (-XX:+UseZGC) [Java 11+]"></a>ZGC (-XX:+UseZGC) [Java 11+]</h3><p><strong>Characteristics</strong>: Ultra-low latency (&lt;10ms), colored pointers<br><strong>Best for</strong>: Applications requiring consistent low latency</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ZGC configuration</span></span><br><span class="line">java -XX:+UseZGC -XX:+UseTransparentHugePages -Xmx32g LatencyCriticalApp</span><br></pre></td></tr></table></figure>

<h3 id="Shenandoah-GC-XX-UseShenandoahGC-Java-12"><a href="#Shenandoah-GC-XX-UseShenandoahGC-Java-12" class="headerlink" title="Shenandoah GC (-XX:+UseShenandoahGC) [Java 12+]"></a>Shenandoah GC (-XX:+UseShenandoahGC) [Java 12+]</h3><p><strong>Characteristics</strong>: Low pause times, concurrent collection<br><strong>Best for</strong>: Applications with large heaps requiring consistent performance</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Shenandoah configuration</span></span><br><span class="line">-XX:+UseShenandoahGC</span><br><span class="line">-XX:ShenandoahGCHeuristics=adaptive</span><br></pre></td></tr></table></figure>
<h3 id="Collector-Comparison"><a href="#Collector-Comparison" class="headerlink" title="Collector Comparison"></a>Collector Comparison</h3><p><strong>Collector Comparison Table</strong>:</p>
<table>
<thead>
<tr>
<th>Collector</th>
<th>Java Version</th>
<th>Best Heap Size</th>
<th>Pause Time</th>
<th>Throughput</th>
<th>Use Case</th>
</tr>
</thead>
<tbody><tr>
<td>Serial</td>
<td>All</td>
<td>&lt; 100MB</td>
<td>High</td>
<td>Low</td>
<td>Single-core, client apps</td>
</tr>
<tr>
<td>Parallel</td>
<td>All (default 8)</td>
<td>&lt; 8GB</td>
<td>Medium-High</td>
<td>High</td>
<td>Multi-core, batch processing</td>
</tr>
<tr>
<td>G1</td>
<td>7+ (default 9+)</td>
<td>&gt; 4GB</td>
<td>Low-Medium</td>
<td>Medium-High</td>
<td>Server applications</td>
</tr>
<tr>
<td>ZGC</td>
<td>11+</td>
<td>&gt; 8GB</td>
<td>Ultra-low</td>
<td>Medium</td>
<td>Latency-critical applications</td>
</tr>
<tr>
<td>Shenandoah</td>
<td>12+</td>
<td>&gt; 8GB</td>
<td>Ultra-low</td>
<td>Medium</td>
<td>Real-time applications</td>
</tr>
</tbody></table>
<h2 id="GC-Tuning-Parameters-and-Best-Practices"><a href="#GC-Tuning-Parameters-and-Best-Practices" class="headerlink" title="GC Tuning Parameters and Best Practices"></a>GC Tuning Parameters and Best Practices</h2><h3 id="Heap-Sizing-Parameters"><a href="#Heap-Sizing-Parameters" class="headerlink" title="Heap Sizing Parameters"></a>Heap Sizing Parameters</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Basic heap configuration</span></span><br><span class="line">-Xms2g          <span class="comment"># Initial heap size</span></span><br><span class="line">-Xmx8g          <span class="comment"># Maximum heap size</span></span><br><span class="line">-XX:NewRatio=3  <span class="comment"># Old/Young generation ratio</span></span><br><span class="line">-XX:SurvivorRatio=8  <span class="comment"># Eden/Survivor ratio</span></span><br></pre></td></tr></table></figure>

<h3 id="Young-Generation-Tuning"><a href="#Young-Generation-Tuning" class="headerlink" title="Young Generation Tuning"></a>Young Generation Tuning</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Young generation specific tuning</span></span><br><span class="line">-Xmn2g                    <span class="comment"># Set young generation size</span></span><br><span class="line">-XX:MaxTenuringThreshold=7 <span class="comment"># Promotion threshold</span></span><br><span class="line">-XX:TargetSurvivorRatio=90 <span class="comment"># Survivor space target utilization</span></span><br></pre></td></tr></table></figure>

<p><strong>Real-world Example</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Web application tuning scenario</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebAppTuning</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Application characteristics:</span></span><br><span class="line"><span class="comment">     * - High request rate</span></span><br><span class="line"><span class="comment">     * - Short-lived request objects</span></span><br><span class="line"><span class="comment">     * - Some cached data</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * Tuning strategy:</span></span><br><span class="line"><span class="comment">     * - Larger young generation for short-lived objects</span></span><br><span class="line"><span class="comment">     * - G1GC for predictable pause times</span></span><br><span class="line"><span class="comment">     * - Monitoring allocation rate</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// JVM flags:</span></span><br><span class="line"><span class="comment">// -XX:+UseG1GC -Xmx4g -XX:MaxGCPauseMillis=100 </span></span><br><span class="line"><span class="comment">// -XX:G1HeapRegionSize=8m -XX:NewRatio=2</span></span><br></pre></td></tr></table></figure>

<h3 id="Monitoring-and-Logging"><a href="#Monitoring-and-Logging" class="headerlink" title="Monitoring and Logging"></a>Monitoring and Logging</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># GC logging (Java 8)</span></span><br><span class="line">-Xloggc:gc.log -XX:+PrintGCDetails -XX:+PrintGCTimeStamps</span><br><span class="line"></span><br><span class="line"><span class="comment"># GC logging (Java 9+)</span></span><br><span class="line">-Xlog:gc*:gc.log:<span class="keyword">time</span>,tags</span><br><span class="line"></span><br><span class="line"><span class="comment"># Additional monitoring</span></span><br><span class="line">-XX:+PrintGCApplicationStoppedTime</span><br><span class="line">-XX:+PrintStringDeduplicationStatistics (G1)</span><br></pre></td></tr></table></figure>

<h3 id="Production-Tuning-Checklist"><a href="#Production-Tuning-Checklist" class="headerlink" title="Production Tuning Checklist"></a>Production Tuning Checklist</h3><p><strong>Memory Allocation</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Monitor allocation patterns</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AllocationMonitoring</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">trackAllocationRate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MemoryMXBean</span> <span class="variable">memoryBean</span> <span class="operator">=</span> ManagementFactory.getMemoryMXBean();</span><br><span class="line">        </span><br><span class="line">        <span class="type">long</span> <span class="variable">beforeGC</span> <span class="operator">=</span> memoryBean.getHeapMemoryUsage().getUsed();</span><br><span class="line">        <span class="comment">// ... application work</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">afterGC</span> <span class="operator">=</span> memoryBean.getHeapMemoryUsage().getUsed();</span><br><span class="line">        </span><br><span class="line">        <span class="type">long</span> <span class="variable">allocatedBytes</span> <span class="operator">=</span> calculateAllocationRate(beforeGC, afterGC);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>GC Overhead Analysis</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Acceptable GC overhead typically &lt; 5%</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GCOverheadCalculator</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">calculateGCOverhead</span><span class="params">(List&lt;GCEvent&gt; events, <span class="type">long</span> totalTime)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">gcTime</span> <span class="operator">=</span> events.stream()</span><br><span class="line">                           .mapToLong(GCEvent::getDuration)</span><br><span class="line">                           .sum();</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">double</span>) gcTime / totalTime * <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Advanced-GC-Concepts"><a href="#Advanced-GC-Concepts" class="headerlink" title="Advanced GC Concepts"></a>Advanced GC Concepts</h2><h3 id="Escape-Analysis-and-TLAB"><a href="#Escape-Analysis-and-TLAB" class="headerlink" title="Escape Analysis and TLAB"></a>Escape Analysis and TLAB</h3><p><strong>Thread Local Allocation Buffers (TLAB)</strong> optimize object allocation:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TLABExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demonstrateTLAB</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Objects allocated in thread-local buffer</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();  <span class="comment">// Fast TLAB allocation</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Escape analysis may eliminate allocation entirely</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">noEscapeAllocation</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();  <span class="comment">// May be stack-allocated</span></span><br><span class="line">        sb.append(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();  <span class="comment">// Object doesn&#x27;t escape method</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="String-Deduplication-G1"><a href="#String-Deduplication-G1" class="headerlink" title="String Deduplication (G1)"></a>String Deduplication (G1)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Enable string deduplication</span></span><br><span class="line">-XX:+UseG1GC -XX:+UseStringDeduplication</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// String deduplication example</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StringDeduplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demonstrateDeduplication</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;String&gt; strings = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// These strings have same content but different instances</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            strings.add(<span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;duplicate content&quot;</span>));  <span class="comment">// Candidates for deduplication</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Compressed-OOPs"><a href="#Compressed-OOPs" class="headerlink" title="Compressed OOPs"></a>Compressed OOPs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Enable compressed ordinary object pointers (default on 64-bit with heap &lt; 32GB)</span></span><br><span class="line">-XX:+UseCompressedOops</span><br><span class="line">-XX:+UseCompressedClassPointers</span><br></pre></td></tr></table></figure>

<h2 id="Interview-Questions-and-Advanced-Scenarios"><a href="#Interview-Questions-and-Advanced-Scenarios" class="headerlink" title="Interview Questions and Advanced Scenarios"></a>Interview Questions and Advanced Scenarios</h2><h3 id="Scenario-Based-Questions"><a href="#Scenario-Based-Questions" class="headerlink" title="Scenario-Based Questions"></a>Scenario-Based Questions</h3><p><strong>Question</strong>: <em>“Your application experiences long GC pauses during peak traffic. How would you diagnose and fix this?”</em></p>
<p><strong>Answer</strong>:</p>
<ol>
<li><strong>Analysis</strong>: Enable GC logging, analyze pause times and frequency</li>
<li><strong>Identification</strong>: Check if Major GC is causing long pauses</li>
<li><strong>Solutions</strong>:<ul>
<li>Switch to G1GC for predictable pause times</li>
<li>Increase heap size to reduce GC frequency</li>
<li>Tune young generation size</li>
<li>Consider object pooling for frequently allocated objects</li>
</ul>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Example diagnostic approach</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GCDiagnostics</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">diagnoseGCIssues</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Monitor GC metrics</span></span><br><span class="line">        List&lt;GarbageCollectorMXBean&gt; gcBeans = </span><br><span class="line">            ManagementFactory.getGarbageCollectorMXBeans();</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">for</span> (GarbageCollectorMXBean gcBean : gcBeans) &#123;</span><br><span class="line">            System.out.printf(<span class="string">&quot;GC Name: %s, Collections: %d, Time: %d ms%n&quot;</span>,</span><br><span class="line">                gcBean.getName(),</span><br><span class="line">                gcBean.getCollectionCount(),</span><br><span class="line">                gcBean.getCollectionTime());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Question</strong>: <em>“Explain the trade-offs between throughput and latency in GC selection.”</em></p>
<p><strong>Answer</strong>:</p>
<ul>
<li><strong>Throughput-focused</strong>: Parallel GC maximizes application processing time</li>
<li><strong>Latency-focused</strong>: G1&#x2F;ZGC minimizes pause times but may reduce overall throughput</li>
<li><strong>Choice depends on</strong>: Application requirements, SLA constraints, heap size</li>
</ul>
<h3 id="Memory-Leak-Detection"><a href="#Memory-Leak-Detection" class="headerlink" title="Memory Leak Detection"></a>Memory Leak Detection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Common memory leak patterns</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemoryLeakExamples</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Set&lt;Object&gt; cache = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();  <span class="comment">// Static collection</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">potentialLeak</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Listeners not removed</span></span><br><span class="line">        someComponent.addListener(event -&gt; &#123;&#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ThreadLocal not cleaned</span></span><br><span class="line">        ThreadLocal&lt;ExpensiveObject&gt; threadLocal = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line">        threadLocal.set(<span class="keyword">new</span> <span class="title class_">ExpensiveObject</span>());</span><br><span class="line">        <span class="comment">// threadLocal.remove(); // Missing cleanup</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Proper cleanup</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">properCleanup</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Use try-with-resources</span></span><br><span class="line">            <span class="keyword">try</span> (<span class="type">AutoCloseable</span> <span class="variable">resource</span> <span class="operator">=</span> createResource()) &#123;</span><br><span class="line">                <span class="comment">// Work with resource</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// Handle exception</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Production-Best-Practices"><a href="#Production-Best-Practices" class="headerlink" title="Production Best Practices"></a>Production Best Practices</h2><h3 id="Monitoring-and-Alerting"><a href="#Monitoring-and-Alerting" class="headerlink" title="Monitoring and Alerting"></a>Monitoring and Alerting</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JMX-based GC monitoring</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GCMonitor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;GarbageCollectorMXBean&gt; gcBeans;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GCMonitor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.gcBeans = ManagementFactory.getGarbageCollectorMXBeans();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setupAlerts</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Alert if GC overhead &gt; 5%</span></span><br><span class="line">        <span class="comment">// Alert if pause times &gt; SLA limits</span></span><br><span class="line">        <span class="comment">// Monitor allocation rate trends</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> GCMetrics <span class="title function_">collectMetrics</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">GCMetrics</span>(</span><br><span class="line">            getTotalGCTime(),</span><br><span class="line">            getGCFrequency(),</span><br><span class="line">            getLongestPause(),</span><br><span class="line">            getAllocationRate()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Capacity-Planning"><a href="#Capacity-Planning" class="headerlink" title="Capacity Planning"></a>Capacity Planning</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Capacity planning calculations</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CapacityPlanning</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> HeapSizeRecommendation <span class="title function_">calculateHeapSize</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="type">long</span> allocationRate, </span></span><br><span class="line"><span class="params">            <span class="type">int</span> targetGCFrequency,</span></span><br><span class="line"><span class="params">            <span class="type">double</span> survivorRatio)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Rule of thumb: Heap size should accommodate </span></span><br><span class="line">        <span class="comment">// allocation rate * GC interval * safety factor</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">recommendedHeap</span> <span class="operator">=</span> allocationRate * targetGCFrequency * <span class="number">3</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HeapSizeRecommendation</span>(</span><br><span class="line">            recommendedHeap,</span><br><span class="line">            calculateYoungGenSize(recommendedHeap, survivorRatio),</span><br><span class="line">            calculateOldGenSize(recommendedHeap, survivorRatio)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Performance-Testing"><a href="#Performance-Testing" class="headerlink" title="Performance Testing"></a>Performance Testing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GC performance testing framework</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GCPerformanceTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">runGCStressTest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Measure allocation patterns</span></span><br><span class="line">        <span class="type">AllocationProfiler</span> <span class="variable">profiler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AllocationProfiler</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Simulate production load</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">iteration</span> <span class="operator">=</span> <span class="number">0</span>; iteration &lt; <span class="number">1000</span>; iteration++) &#123;</span><br><span class="line">            simulateWorkload();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (iteration % <span class="number">100</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                profiler.recordMetrics();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Analyze results</span></span><br><span class="line">        profiler.generateReport();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">simulateWorkload</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Create realistic object allocation patterns</span></span><br><span class="line">        List&lt;Object&gt; shortLived = createShortLivedObjects();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">longLived</span> <span class="operator">=</span> createLongLivedObject();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Process data</span></span><br><span class="line">        processData(shortLived, longLived);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Conclusion-and-Future-Directions"><a href="#Conclusion-and-Future-Directions" class="headerlink" title="Conclusion and Future Directions"></a>Conclusion and Future Directions</h2><p>Java’s garbage collection continues to evolve with new collectors like ZGC and Shenandoah pushing the boundaries of low-latency collection. Understanding GC fundamentals, choosing appropriate collectors, and proper tuning remain critical for production Java applications.</p>
<p><strong>Key Takeaways</strong>:</p>
<ul>
<li>Choose GC based on application requirements (throughput vs latency)</li>
<li>Monitor and measure before optimizing</li>
<li>Understand object lifecycle and allocation patterns</li>
<li>Use appropriate reference types for memory-sensitive applications</li>
<li>Regular capacity planning and performance testing</li>
</ul>
<p><strong>Future Trends</strong>:</p>
<ul>
<li>Ultra-low latency collectors (sub-millisecond pauses)</li>
<li>Better integration with container environments</li>
<li>Machine learning-assisted GC tuning</li>
<li>Region-based collectors becoming mainstream</li>
</ul>
<p>The evolution of GC technology continues to make Java more suitable for a wider range of applications, from high-frequency trading systems requiring microsecond latencies to large-scale data processing systems prioritizing throughput.</p>
<h2 id="External-References"><a href="#External-References" class="headerlink" title="External References"></a>External References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/17/gctuning/">Oracle JVM Tuning Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/17/gctuning/garbage-first-g1-garbage-collector1.html">G1 Garbage Collector Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.openjdk.org/display/zgc/Main">ZGC Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.openjdk.org/display/shenandoah/Main">Shenandoah GC</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/openjdk/jdk">GC Algorithms Implementations</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jls/se17/html/jls-17.html#jls-17.4">Java Memory Model Specification</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/19/Redis-Cache-Expiration-Deletion-Policies-Complete-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/19/Redis-Cache-Expiration-Deletion-Policies-Complete-Guide/" class="post-title-link" itemprop="url">Redis Cache Expiration Deletion Policies - Complete Guide</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-19 15:25:00 / Modified: 17:05:24" itemprop="dateCreated datePublished" datetime="2025-06-19T15:25:00+08:00">2025-06-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Overview-of-Cache-Expiration-Strategies"><a href="#Overview-of-Cache-Expiration-Strategies" class="headerlink" title="Overview of Cache Expiration Strategies"></a>Overview of Cache Expiration Strategies</h2><p>Redis implements multiple expiration deletion strategies to efficiently manage memory and ensure optimal performance. Understanding these mechanisms is crucial for building scalable, high-performance applications.</p>
<p><strong>Interview Insight</strong>: <em>“How does Redis handle expired keys?”</em> - Redis uses a combination of lazy deletion and active deletion strategies. It doesn’t immediately delete expired keys but employs intelligent algorithms to balance performance and memory usage.</p>
<h2 id="Core-Expiration-Deletion-Policies"><a href="#Core-Expiration-Deletion-Policies" class="headerlink" title="Core Expiration Deletion Policies"></a>Core Expiration Deletion Policies</h2><h3 id="Lazy-Deletion-Passive-Expiration"><a href="#Lazy-Deletion-Passive-Expiration" class="headerlink" title="Lazy Deletion (Passive Expiration)"></a>Lazy Deletion (Passive Expiration)</h3><p>Lazy deletion is the primary mechanism where expired keys are only removed when they are accessed.</p>
<p><strong>How it works</strong>:</p>
<ul>
<li>When a client attempts to access a key, Redis checks if it has expired</li>
<li>If expired, the key is immediately deleted and <code>NULL</code> is returned</li>
<li>No background scanning or proactive deletion occurs</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Example: Lazy deletion in action</span></span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">r = redis.Redis()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set a key with 2-second expiration</span></span><br><span class="line">r.setex(<span class="string">&#x27;temp_key&#x27;</span>, <span class="number">2</span>, <span class="string">&#x27;temporary_value&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Key exists initially</span></span><br><span class="line"><span class="built_in">print</span>(r.get(<span class="string">&#x27;temp_key&#x27;</span>))  <span class="comment"># b&#x27;temporary_value&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Wait for expiration</span></span><br><span class="line">time.sleep(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Key is deleted only when accessed (lazy deletion)</span></span><br><span class="line"><span class="built_in">print</span>(r.get(<span class="string">&#x27;temp_key&#x27;</span>))  <span class="comment"># None</span></span><br></pre></td></tr></table></figure>

<p><strong>Advantages</strong>:</p>
<ul>
<li>Minimal CPU overhead</li>
<li>No background processing required</li>
<li>Perfect for frequently accessed keys</li>
</ul>
<p><strong>Disadvantages</strong>:</p>
<ul>
<li>Memory waste if expired keys are never accessed</li>
<li>Unpredictable memory usage patterns</li>
</ul>
<h3 id="Active-Deletion-Proactive-Scanning"><a href="#Active-Deletion-Proactive-Scanning" class="headerlink" title="Active Deletion (Proactive Scanning)"></a>Active Deletion (Proactive Scanning)</h3><p>Redis periodically scans and removes expired keys to prevent memory bloat.</p>
<p><strong>Algorithm Details</strong>:</p>
<ol>
<li>Redis runs expiration cycles approximately 10 times per second</li>
<li>Each cycle samples 20 random keys from the expires dictionary</li>
<li>If more than 25% are expired, repeat the process</li>
<li>Maximum execution time per cycle is limited to prevent blocking</li>
</ol>
<pre>
<code class="mermaid">
flowchart TD
A[Start Expiration Cycle] --&gt; B[Sample 20 Random Keys]
B --&gt; C{More than 25% expired?}
C --&gt;|Yes| D[Delete Expired Keys]
D --&gt; E{Time limit reached?}
E --&gt;|No| B
E --&gt;|Yes| F[End Cycle]
C --&gt;|No| F
F --&gt; G[Wait ~100ms]
G --&gt; A
</code>
</pre>

<p><strong>Configuration Parameters</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Redis configuration for active expiration</span></span><br><span class="line">hz 10                    <span class="comment"># Frequency of background tasks (10 Hz = 10 times/second)</span></span><br><span class="line">active-expire-effort 1   <span class="comment"># CPU effort for active expiration (1-10)</span></span><br></pre></td></tr></table></figure>

<h3 id="Timer-Based-Deletion"><a href="#Timer-Based-Deletion" class="headerlink" title="Timer-Based Deletion"></a>Timer-Based Deletion</h3><p>While Redis doesn’t implement traditional timer-based deletion, you can simulate it using sorted sets:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TimerCache</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = redis.Redis()</span><br><span class="line">        <span class="variable language_">self</span>.timer_key = <span class="string">&quot;expiration_timer&quot;</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_with_timer</span>(<span class="params">self, key, value, ttl</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Set key-value with custom timer deletion&quot;&quot;&quot;</span></span><br><span class="line">        expire_time = time.time() + ttl</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Store the actual data</span></span><br><span class="line">        <span class="variable language_">self</span>.redis_client.<span class="built_in">set</span>(key, value)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Add to timer sorted set</span></span><br><span class="line">        <span class="variable language_">self</span>.redis_client.zadd(<span class="variable language_">self</span>.timer_key, &#123;key: expire_time&#125;)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">cleanup_expired</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Background thread to clean expired keys&quot;&quot;&quot;</span></span><br><span class="line">        current_time = time.time()</span><br><span class="line">        expired_keys = <span class="variable language_">self</span>.redis_client.zrangebyscore(</span><br><span class="line">            <span class="variable language_">self</span>.timer_key, <span class="number">0</span>, current_time</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> expired_keys:</span><br><span class="line">            <span class="comment"># Remove expired keys</span></span><br><span class="line">            <span class="keyword">for</span> key <span class="keyword">in</span> expired_keys:</span><br><span class="line">                <span class="variable language_">self</span>.redis_client.delete(key.decode())</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Remove from timer set</span></span><br><span class="line">            <span class="variable language_">self</span>.redis_client.zremrangebyscore(<span class="variable language_">self</span>.timer_key, <span class="number">0</span>, current_time)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage example</span></span><br><span class="line">cache = TimerCache()</span><br><span class="line">cache.set_with_timer(<span class="string">&#x27;user:1&#x27;</span>, <span class="string">&#x27;John Doe&#x27;</span>, <span class="number">60</span>)  <span class="comment"># 60 seconds TTL</span></span><br></pre></td></tr></table></figure>

<h3 id="Delay-Queue-Deletion"><a href="#Delay-Queue-Deletion" class="headerlink" title="Delay Queue Deletion"></a>Delay Queue Deletion</h3><p>Implement a delay queue pattern for complex expiration scenarios:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DelayQueueExpiration</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = redis.Redis()</span><br><span class="line">        <span class="variable language_">self</span>.queue_key = <span class="string">&quot;delay_expiration_queue&quot;</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">schedule_deletion</span>(<span class="params">self, key, delay_seconds</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Schedule key deletion after specified delay&quot;&quot;&quot;</span></span><br><span class="line">        execution_time = time.time() + delay_seconds</span><br><span class="line">        task = &#123;</span><br><span class="line">            <span class="string">&#x27;key&#x27;</span>: key,</span><br><span class="line">            <span class="string">&#x27;scheduled_time&#x27;</span>: execution_time,</span><br><span class="line">            <span class="string">&#x27;action&#x27;</span>: <span class="string">&#x27;delete&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.redis_client.zadd(</span><br><span class="line">            <span class="variable language_">self</span>.queue_key, </span><br><span class="line">            &#123;json.dumps(task): execution_time&#125;</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_delayed_deletions</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Process pending deletions&quot;&quot;&quot;</span></span><br><span class="line">        current_time = time.time()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Get tasks ready for execution</span></span><br><span class="line">        ready_tasks = <span class="variable language_">self</span>.redis_client.zrangebyscore(</span><br><span class="line">            <span class="variable language_">self</span>.queue_key, <span class="number">0</span>, current_time, withscores=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> task_json, score <span class="keyword">in</span> ready_tasks:</span><br><span class="line">            task = json.loads(task_json)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Execute deletion</span></span><br><span class="line">            <span class="variable language_">self</span>.redis_client.delete(task[<span class="string">&#x27;key&#x27;</span>])</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Remove from queue</span></span><br><span class="line">            <span class="variable language_">self</span>.redis_client.zrem(<span class="variable language_">self</span>.queue_key, task_json)</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Deleted key: <span class="subst">&#123;task[<span class="string">&#x27;key&#x27;</span>]&#125;</span> at <span class="subst">&#123;datetime.now()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage</span></span><br><span class="line">delay_queue = DelayQueueExpiration()</span><br><span class="line">delay_queue.schedule_deletion(<span class="string">&#x27;temp_data&#x27;</span>, <span class="number">300</span>)  <span class="comment"># Delete after 5 minutes</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“What’s the difference between active and passive expiration?”</em> - Passive (lazy) expiration only occurs when keys are accessed, while active expiration proactively scans and removes expired keys in background cycles to prevent memory bloat.</p>
<h2 id="Redis-Expiration-Policies-Eviction-Policies"><a href="#Redis-Expiration-Policies-Eviction-Policies" class="headerlink" title="Redis Expiration Policies (Eviction Policies)"></a>Redis Expiration Policies (Eviction Policies)</h2><p>When Redis reaches memory limits, it employs eviction policies to free up space:</p>
<h3 id="Available-Eviction-Policies"><a href="#Available-Eviction-Policies" class="headerlink" title="Available Eviction Policies"></a>Available Eviction Policies</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Configuration in redis.conf</span></span><br><span class="line">maxmemory 2gb</span><br><span class="line">maxmemory-policy allkeys-lru</span><br></pre></td></tr></table></figure>

<p><strong>Policy Types</strong>:</p>
<ol>
<li><p><strong>noeviction</strong> (default)</p>
<ul>
<li>No keys are evicted</li>
<li>Write operations return errors when memory limit reached</li>
<li>Use case: Critical data that cannot be lost</li>
</ul>
</li>
<li><p><strong>allkeys-lru</strong></p>
<ul>
<li>Removes least recently used keys from all keys</li>
<li>Use case: General caching scenarios</li>
</ul>
</li>
<li><p><strong>allkeys-lfu</strong></p>
<ul>
<li>Removes least frequently used keys</li>
<li>Use case: Applications with distinct access patterns</li>
</ul>
</li>
<li><p><strong>volatile-lru</strong></p>
<ul>
<li>Removes LRU keys only from keys with expiration set</li>
<li>Use case: Mixed persistent and temporary data</li>
</ul>
</li>
<li><p><strong>volatile-lfu</strong></p>
<ul>
<li>Removes LFU keys only from keys with expiration set</li>
</ul>
</li>
<li><p><strong>allkeys-random</strong></p>
<ul>
<li>Randomly removes keys</li>
<li>Use case: When access patterns are unpredictable</li>
</ul>
</li>
<li><p><strong>volatile-random</strong></p>
<ul>
<li>Randomly removes keys with expiration set</li>
</ul>
</li>
<li><p><strong>volatile-ttl</strong></p>
<ul>
<li>Removes keys with shortest TTL first</li>
<li>Use case: Time-sensitive data prioritization</li>
</ul>
</li>
</ol>
<h3 id="Policy-Selection-Guide"><a href="#Policy-Selection-Guide" class="headerlink" title="Policy Selection Guide"></a>Policy Selection Guide</h3><pre>
<code class="mermaid">
flowchart TD
A[Memory Pressure] --&gt; B{All data equally important?}
B --&gt;|Yes| C[allkeys-lru&#x2F;lfu]
B --&gt;|No| D{Temporary vs Persistent data?}
D --&gt;|Mixed| E[volatile-lru&#x2F;lfu]
D --&gt;|Time-sensitive| F[volatile-ttl]
C --&gt; G[High access pattern variance?]
G --&gt;|Yes| H[allkeys-lfu]
G --&gt;|No| I[allkeys-lru]
</code>
</pre>

<h2 id="Master-Slave-Cluster-Expiration-Mechanisms"><a href="#Master-Slave-Cluster-Expiration-Mechanisms" class="headerlink" title="Master-Slave Cluster Expiration Mechanisms"></a>Master-Slave Cluster Expiration Mechanisms</h2><h3 id="Replication-of-Expiration"><a href="#Replication-of-Expiration" class="headerlink" title="Replication of Expiration"></a>Replication of Expiration</h3><p>In Redis clusters, expiration handling follows specific patterns:</p>
<p><strong>Master-Slave Expiration Flow</strong>:</p>
<ol>
<li>Only masters perform active expiration</li>
<li>Masters send explicit <code>DEL</code> commands to slaves</li>
<li>Slaves don’t independently expire keys (except for lazy deletion)</li>
</ol>
<pre>
<code class="mermaid">
sequenceDiagram
participant M as Master
participant S1 as Slave 1
participant S2 as Slave 2
participant C as Client

Note over M: Active expiration cycle
M-&gt;&gt;M: Check expired keys
M-&gt;&gt;S1: DEL expired_key
M-&gt;&gt;S2: DEL expired_key

C-&gt;&gt;S1: GET expired_key
S1-&gt;&gt;S1: Lazy expiration check
S1-&gt;&gt;C: NULL (key expired)
</code>
</pre>

<h3 id="Cluster-Configuration-for-Expiration"><a href="#Cluster-Configuration-for-Expiration" class="headerlink" title="Cluster Configuration for Expiration"></a>Cluster Configuration for Expiration</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Master configuration</span></span><br><span class="line"><span class="built_in">bind</span> 0.0.0.0</span><br><span class="line">port 6379</span><br><span class="line">maxmemory 1gb</span><br><span class="line">maxmemory-policy allkeys-lru</span><br><span class="line">hz 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># Slave configuration</span></span><br><span class="line"><span class="built_in">bind</span> 0.0.0.0</span><br><span class="line">port 6380</span><br><span class="line">slaveof 127.0.0.1 6379</span><br><span class="line">slave-read-only <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>

<p><strong>Production Example - Redis Sentinel with Expiration</strong>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis.sentinel</span><br><span class="line"></span><br><span class="line"><span class="comment"># Sentinel configuration for high availability</span></span><br><span class="line">sentinels = [(<span class="string">&#x27;localhost&#x27;</span>, <span class="number">26379</span>), (<span class="string">&#x27;localhost&#x27;</span>, <span class="number">26380</span>), (<span class="string">&#x27;localhost&#x27;</span>, <span class="number">26381</span>)]</span><br><span class="line">sentinel = redis.sentinel.Sentinel(sentinels)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get master and slave connections</span></span><br><span class="line">master = sentinel.master_for(<span class="string">&#x27;mymaster&#x27;</span>, socket_timeout=<span class="number">0.1</span>)</span><br><span class="line">slave = sentinel.slave_for(<span class="string">&#x27;mymaster&#x27;</span>, socket_timeout=<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Write to master with expiration</span></span><br><span class="line">master.setex(<span class="string">&#x27;session:user:1&#x27;</span>, <span class="number">3600</span>, <span class="string">&#x27;session_data&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Read from slave (expiration handled consistently)</span></span><br><span class="line">session_data = slave.get(<span class="string">&#x27;session:user:1&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“How does Redis handle expiration in a cluster?”</em> - In Redis clusters, only master nodes perform active expiration. When a master expires a key, it sends explicit DEL commands to all slaves to maintain consistency.</p>
<h2 id="Durability-and-Expired-Keys"><a href="#Durability-and-Expired-Keys" class="headerlink" title="Durability and Expired Keys"></a>Durability and Expired Keys</h2><h3 id="RDB-Persistence"><a href="#RDB-Persistence" class="headerlink" title="RDB Persistence"></a>RDB Persistence</h3><p>Expired keys are handled during RDB operations:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># RDB configuration</span></span><br><span class="line">save 900 1      <span class="comment"># Save if at least 1 key changed in 900 seconds</span></span><br><span class="line">save 300 10     <span class="comment"># Save if at least 10 keys changed in 300 seconds</span></span><br><span class="line">save 60 10000   <span class="comment"># Save if at least 10000 keys changed in 60 seconds</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Expired keys are not saved to RDB files</span></span><br><span class="line">rdbcompression <span class="built_in">yes</span></span><br><span class="line">rdbchecksum <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>

<h3 id="AOF-Persistence"><a href="#AOF-Persistence" class="headerlink" title="AOF Persistence"></a>AOF Persistence</h3><p>AOF handles expiration through explicit commands:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># AOF configuration</span></span><br><span class="line">appendonly <span class="built_in">yes</span></span><br><span class="line">appendfsync everysec</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line"></span><br><span class="line"><span class="comment"># Expired keys generate explicit DEL commands in AOF</span></span><br><span class="line">no-appendfsync-on-rewrite no</span><br></pre></td></tr></table></figure>

<p><strong>Example AOF entries for expiration</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">*2</span><br><span class="line">$6</span><br><span class="line">SELECT</span><br><span class="line">$1</span><br><span class="line">0</span><br><span class="line">*3</span><br><span class="line">$3</span><br><span class="line">SET</span><br><span class="line">$8</span><br><span class="line">temp_key</span><br><span class="line">$5</span><br><span class="line">value</span><br><span class="line">*3</span><br><span class="line">$6</span><br><span class="line">EXPIRE</span><br><span class="line">$8</span><br><span class="line">temp_key</span><br><span class="line">$2</span><br><span class="line">60</span><br><span class="line">*2</span><br><span class="line">$3</span><br><span class="line">DEL</span><br><span class="line">$8</span><br><span class="line">temp_key</span><br></pre></td></tr></table></figure>

<h2 id="Optimization-Strategies"><a href="#Optimization-Strategies" class="headerlink" title="Optimization Strategies"></a>Optimization Strategies</h2><h3 id="Memory-Efficient-Configuration"><a href="#Memory-Efficient-Configuration" class="headerlink" title="Memory-Efficient Configuration"></a>Memory-Efficient Configuration</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># redis.conf optimizations</span></span><br><span class="line">maxmemory 2gb</span><br><span class="line">maxmemory-policy allkeys-lru</span><br><span class="line"></span><br><span class="line"><span class="comment"># Active deletion tuning</span></span><br><span class="line">hz 10  <span class="comment"># Background task frequency</span></span><br><span class="line">active-expire-cycle-lookups-per-loop 20</span><br><span class="line">active-expire-cycle-fast-duration 1000</span><br><span class="line"></span><br><span class="line"><span class="comment"># Memory sampling for LRU/LFU</span></span><br><span class="line">maxmemory-samples 5</span><br></pre></td></tr></table></figure>

<h3 id="Expiration-Time-Configuration-Optimization"><a href="#Expiration-Time-Configuration-Optimization" class="headerlink" title="Expiration Time Configuration Optimization"></a>Expiration Time Configuration Optimization</h3><p><strong>Hierarchical TTL Strategy</strong>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TTLManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis_client</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Define TTL hierarchy</span></span><br><span class="line">        <span class="variable language_">self</span>.ttl_config = &#123;</span><br><span class="line">            <span class="string">&#x27;hot_data&#x27;</span>: <span class="number">300</span>,      <span class="comment"># 5 minutes - frequently accessed</span></span><br><span class="line">            <span class="string">&#x27;warm_data&#x27;</span>: <span class="number">1800</span>,    <span class="comment"># 30 minutes - moderately accessed</span></span><br><span class="line">            <span class="string">&#x27;cold_data&#x27;</span>: <span class="number">3600</span>,    <span class="comment"># 1 hour - rarely accessed</span></span><br><span class="line">            <span class="string">&#x27;session_data&#x27;</span>: <span class="number">7200</span>, <span class="comment"># 2 hours - user sessions</span></span><br><span class="line">            <span class="string">&#x27;cache_data&#x27;</span>: <span class="number">86400</span>   <span class="comment"># 24 hours - general cache</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_with_smart_ttl</span>(<span class="params">self, key, value, data_type=<span class="string">&#x27;cache_data&#x27;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Set key with intelligent TTL based on data type&quot;&quot;&quot;</span></span><br><span class="line">        ttl = <span class="variable language_">self</span>.ttl_config.get(data_type, <span class="number">3600</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Add jitter to prevent thundering herd</span></span><br><span class="line">        <span class="keyword">import</span> random</span><br><span class="line">        jitter = random.randint(-ttl//<span class="number">10</span>, ttl//<span class="number">10</span>)</span><br><span class="line">        final_ttl = ttl + jitter</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.redis.setex(key, final_ttl, value)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">adaptive_ttl</span>(<span class="params">self, key, access_frequency</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Adjust TTL based on access patterns&quot;&quot;&quot;</span></span><br><span class="line">        base_ttl = <span class="number">3600</span>  <span class="comment"># 1 hour base</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> access_frequency &gt; <span class="number">100</span>:  <span class="comment"># Hot key</span></span><br><span class="line">            <span class="keyword">return</span> base_ttl // <span class="number">4</span>    <span class="comment"># 15 minutes</span></span><br><span class="line">        <span class="keyword">elif</span> access_frequency &gt; <span class="number">10</span>: <span class="comment"># Warm key</span></span><br><span class="line">            <span class="keyword">return</span> base_ttl // <span class="number">2</span>    <span class="comment"># 30 minutes</span></span><br><span class="line">        <span class="keyword">else</span>:                       <span class="comment"># Cold key</span></span><br><span class="line">            <span class="keyword">return</span> base_ttl * <span class="number">2</span>     <span class="comment"># 2 hours</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage example</span></span><br><span class="line">ttl_manager = TTLManager(redis.Redis())</span><br><span class="line">ttl_manager.set_with_smart_ttl(<span class="string">&#x27;user:profile:123&#x27;</span>, user_data, <span class="string">&#x27;hot_data&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="Production-Use-Cases"><a href="#Production-Use-Cases" class="headerlink" title="Production Use Cases"></a>Production Use Cases</h2><h3 id="High-Concurrent-Idempotent-Scenarios"><a href="#High-Concurrent-Idempotent-Scenarios" class="headerlink" title="High-Concurrent Idempotent Scenarios"></a>High-Concurrent Idempotent Scenarios</h3><p>In idempotent(&#x2F;aɪˈdempətənt&#x2F;) operations, cache expiration must prevent duplicate processing while maintaining consistency.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IdempotentCache</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis.Redis()</span><br><span class="line">        <span class="variable language_">self</span>.default_ttl = <span class="number">300</span>  <span class="comment"># 5 minutes</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_idempotent_key</span>(<span class="params">self, operation, params</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Generate unique key for operation&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Create hash from operation and parameters</span></span><br><span class="line">        content = <span class="string">f&quot;<span class="subst">&#123;operation&#125;</span>:<span class="subst">&#123;<span class="built_in">str</span>(<span class="built_in">sorted</span>(params.items()))&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;idempotent:<span class="subst">&#123;hashlib.md5(content.encode()).hexdigest()&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute_idempotent</span>(<span class="params">self, operation, params, executor_func</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Execute operation with idempotency guarantee&quot;&quot;&quot;</span></span><br><span class="line">        idempotent_key = <span class="variable language_">self</span>.generate_idempotent_key(operation, params)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Check if operation already executed</span></span><br><span class="line">        result = <span class="variable language_">self</span>.redis.get(idempotent_key)</span><br><span class="line">        <span class="keyword">if</span> result:</span><br><span class="line">            <span class="keyword">return</span> json.loads(result)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Use distributed lock to prevent concurrent execution</span></span><br><span class="line">        lock_key = <span class="string">f&quot;lock:<span class="subst">&#123;idempotent_key&#125;</span>&quot;</span></span><br><span class="line">        lock_acquired = <span class="variable language_">self</span>.redis.<span class="built_in">set</span>(lock_key, <span class="string">&quot;1&quot;</span>, nx=<span class="literal">True</span>, ex=<span class="number">60</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> lock_acquired:</span><br><span class="line">            <span class="comment"># Wait and check again</span></span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">            result = <span class="variable language_">self</span>.redis.get(idempotent_key)</span><br><span class="line">            <span class="keyword">if</span> result:</span><br><span class="line">                <span class="keyword">return</span> json.loads(result)</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">&quot;Operation in progress&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># Execute the actual operation</span></span><br><span class="line">            result = executor_func(params)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Cache the result</span></span><br><span class="line">            <span class="variable language_">self</span>.redis.setex(</span><br><span class="line">                idempotent_key, </span><br><span class="line">                <span class="variable language_">self</span>.default_ttl, </span><br><span class="line">                json.dumps(result)</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="comment"># Release lock</span></span><br><span class="line">            <span class="variable language_">self</span>.redis.delete(lock_key)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage example</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_payment</span>(<span class="params">params</span>):</span><br><span class="line">    <span class="comment"># Simulate payment processing</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;success&quot;</span>, <span class="string">&quot;transaction_id&quot;</span>: <span class="built_in">str</span>(uuid.uuid4())&#125;</span><br><span class="line"></span><br><span class="line">idempotent_cache = IdempotentCache()</span><br><span class="line">result = idempotent_cache.execute_idempotent(</span><br><span class="line">    <span class="string">&quot;payment&quot;</span>, </span><br><span class="line">    &#123;<span class="string">&quot;amount&quot;</span>: <span class="number">100</span>, <span class="string">&quot;user_id&quot;</span>: <span class="string">&quot;123&quot;</span>&#125;, </span><br><span class="line">    process_payment</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="Hot-Key-Scenarios"><a href="#Hot-Key-Scenarios" class="headerlink" title="Hot Key Scenarios"></a>Hot Key Scenarios</h3><p><strong>Problem</strong>: Managing frequently accessed keys that can overwhelm Redis.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HotKeyManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis.Redis()</span><br><span class="line">        <span class="variable language_">self</span>.access_stats = defaultdict(<span class="built_in">int</span>)</span><br><span class="line">        <span class="variable language_">self</span>.hot_key_threshold = <span class="number">1000</span>  <span class="comment"># Requests per minute</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_with_hot_key_protection</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get value with hot key protection&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.access_stats[key] += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Check if key is hot</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.access_stats[key] &gt; <span class="variable language_">self</span>.hot_key_threshold:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>._handle_hot_key(key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.redis.get(key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_handle_hot_key</span>(<span class="params">self, hot_key</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Handle hot key with multiple strategies&quot;&quot;&quot;</span></span><br><span class="line">        strategies = [</span><br><span class="line">            <span class="variable language_">self</span>._local_cache_strategy,</span><br><span class="line">            <span class="variable language_">self</span>._replica_strategy,</span><br><span class="line">            <span class="variable language_">self</span>._fragmentation_strategy</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Choose strategy based on key characteristics</span></span><br><span class="line">        <span class="keyword">return</span> random.choice(strategies)(hot_key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_local_cache_strategy</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Use local cache for hot keys&quot;&quot;&quot;</span></span><br><span class="line">        local_cache_key = <span class="string">f&quot;local:<span class="subst">&#123;key&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Check local cache first (simulate with Redis)</span></span><br><span class="line">        local_value = <span class="variable language_">self</span>.redis.get(local_cache_key)</span><br><span class="line">        <span class="keyword">if</span> local_value:</span><br><span class="line">            <span class="keyword">return</span> local_value</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Get from main cache and store locally</span></span><br><span class="line">        value = <span class="variable language_">self</span>.redis.get(key)</span><br><span class="line">        <span class="keyword">if</span> value:</span><br><span class="line">            <span class="comment"># Short TTL for local cache</span></span><br><span class="line">            <span class="variable language_">self</span>.redis.setex(local_cache_key, <span class="number">60</span>, value)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_replica_strategy</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Create multiple replicas of hot key&quot;&quot;&quot;</span></span><br><span class="line">        replica_count = <span class="number">5</span></span><br><span class="line">        replica_key = <span class="string">f&quot;<span class="subst">&#123;key&#125;</span>:replica:<span class="subst">&#123;random.randint(<span class="number">1</span>, replica_count)&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Try to get from replica</span></span><br><span class="line">        value = <span class="variable language_">self</span>.redis.get(replica_key)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> value:</span><br><span class="line">            <span class="comment"># Get from master and update replica</span></span><br><span class="line">            value = <span class="variable language_">self</span>.redis.get(key)</span><br><span class="line">            <span class="keyword">if</span> value:</span><br><span class="line">                <span class="variable language_">self</span>.redis.setex(replica_key, <span class="number">300</span>, value)  <span class="comment"># 5 min TTL</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_fragmentation_strategy</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Fragment hot key into smaller pieces&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># For large objects, split into fragments</span></span><br><span class="line">        fragments = []</span><br><span class="line">        fragment_index = <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            fragment_key = <span class="string">f&quot;<span class="subst">&#123;key&#125;</span>:frag:<span class="subst">&#123;fragment_index&#125;</span>&quot;</span></span><br><span class="line">            fragment = <span class="variable language_">self</span>.redis.get(fragment_key)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> fragment:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">                </span><br><span class="line">            fragments.append(fragment)</span><br><span class="line">            fragment_index += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> fragments:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">b&#x27;&#x27;</span>.join(fragments)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.redis.get(key)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage example</span></span><br><span class="line">hot_key_manager = HotKeyManager()</span><br><span class="line">value = hot_key_manager.get_with_hot_key_protection(<span class="string">&#x27;popular_product:123&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Pre-Loading-and-Predictive-Caching"><a href="#Pre-Loading-and-Predictive-Caching" class="headerlink" title="Pre-Loading and Predictive Caching"></a>Pre-Loading and Predictive Caching</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PredictiveCacheManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis_client</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">preload_related_data</span>(<span class="params">self, primary_key, related_keys_func, short_ttl=<span class="number">300</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Pre-load related data with shorter TTL</span></span><br><span class="line"><span class="string">        Useful for pagination, related products, etc.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Get related keys that might be accessed soon</span></span><br><span class="line">        related_keys = related_keys_func(primary_key)</span><br><span class="line">        </span><br><span class="line">        pipeline = <span class="variable language_">self</span>.redis.pipeline()</span><br><span class="line">        <span class="keyword">for</span> related_key <span class="keyword">in</span> related_keys:</span><br><span class="line">            <span class="comment"># Check if already cached</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.redis.exists(related_key):</span><br><span class="line">                <span class="comment"># Pre-load with shorter TTL</span></span><br><span class="line">                related_data = <span class="variable language_">self</span>._fetch_data(related_key)</span><br><span class="line">                pipeline.setex(related_key, short_ttl, related_data)</span><br><span class="line">        </span><br><span class="line">        pipeline.execute()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">cache_with_prefetch</span>(<span class="params">self, key, value, ttl=<span class="number">3600</span>, prefetch_ratio=<span class="number">0.1</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Cache data and trigger prefetch when TTL is near expiration</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.redis.setex(key, ttl, value)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Set a prefetch trigger at 90% of TTL</span></span><br><span class="line">        prefetch_ttl = <span class="built_in">int</span>(ttl * prefetch_ratio)</span><br><span class="line">        prefetch_key = <span class="string">f&quot;prefetch:<span class="subst">&#123;key&#125;</span>&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.redis.setex(prefetch_key, ttl - prefetch_ttl, <span class="string">&quot;trigger&quot;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_and_prefetch</span>(<span class="params">self, key, refresh_func</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Check if prefetch is needed and refresh in background&quot;&quot;&quot;</span></span><br><span class="line">        prefetch_key = <span class="string">f&quot;prefetch:<span class="subst">&#123;key&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.redis.exists(prefetch_key):</span><br><span class="line">            <span class="comment"># Prefetch trigger expired - refresh in background</span></span><br><span class="line">            threading.Thread(</span><br><span class="line">                target=<span class="variable language_">self</span>._background_refresh,</span><br><span class="line">                args=(key, refresh_func)</span><br><span class="line">            ).start()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_background_refresh</span>(<span class="params">self, key, refresh_func</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Refresh data in background before expiration&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            new_value = refresh_func()</span><br><span class="line">            current_ttl = <span class="variable language_">self</span>.redis.ttl(key)</span><br><span class="line">            <span class="keyword">if</span> current_ttl &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="comment"># Extend current key TTL and set new value</span></span><br><span class="line">                <span class="variable language_">self</span>.redis.setex(key, current_ttl + <span class="number">3600</span>, new_value)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># Log error but don&#x27;t fail main request</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Background refresh failed for <span class="subst">&#123;key&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example usage for e-commerce</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_related_product_keys</span>(<span class="params">product_id</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Return keys for related products, reviews, recommendations&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">f&quot;product:<span class="subst">&#123;product_id&#125;</span>:reviews&quot;</span>,</span><br><span class="line">        <span class="string">f&quot;product:<span class="subst">&#123;product_id&#125;</span>:recommendations&quot;</span>, </span><br><span class="line">        <span class="string">f&quot;product:<span class="subst">&#123;product_id&#125;</span>:similar&quot;</span>,</span><br><span class="line">        <span class="string">f&quot;category:<span class="subst">&#123;get_category(product_id)&#125;</span>:featured&quot;</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pre-load when user views a product</span></span><br><span class="line">predictive_cache = PredictiveCacheManager(redis_client)</span><br><span class="line">predictive_cache.preload_related_data(</span><br><span class="line">    <span class="string">f&quot;product:<span class="subst">&#123;product_id&#125;</span>&quot;</span>,</span><br><span class="line">    get_related_product_keys,</span><br><span class="line">    short_ttl=<span class="number">600</span>  <span class="comment"># 10 minutes for related data</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Monitoring-and-Metrics"><a href="#Performance-Monitoring-and-Metrics" class="headerlink" title="Performance Monitoring and Metrics"></a>Performance Monitoring and Metrics</h2><h3 id="Expiration-Monitoring"><a href="#Expiration-Monitoring" class="headerlink" title="Expiration Monitoring"></a>Expiration Monitoring</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExpirationMonitor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis.Redis()</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_expiration_stats</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get comprehensive expiration statistics&quot;&quot;&quot;</span></span><br><span class="line">        info = <span class="variable language_">self</span>.redis.info()</span><br><span class="line">        </span><br><span class="line">        stats = &#123;</span><br><span class="line">            <span class="string">&#x27;expired_keys&#x27;</span>: info.get(<span class="string">&#x27;expired_keys&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">            <span class="string">&#x27;evicted_keys&#x27;</span>: info.get(<span class="string">&#x27;evicted_keys&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">            <span class="string">&#x27;keyspace_hits&#x27;</span>: info.get(<span class="string">&#x27;keyspace_hits&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">            <span class="string">&#x27;keyspace_misses&#x27;</span>: info.get(<span class="string">&#x27;keyspace_misses&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">            <span class="string">&#x27;used_memory&#x27;</span>: info.get(<span class="string">&#x27;used_memory&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">            <span class="string">&#x27;maxmemory&#x27;</span>: info.get(<span class="string">&#x27;maxmemory&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">            <span class="string">&#x27;memory_usage_percentage&#x27;</span>: <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> stats[<span class="string">&#x27;maxmemory&#x27;</span>] &gt; <span class="number">0</span>:</span><br><span class="line">            stats[<span class="string">&#x27;memory_usage_percentage&#x27;</span>] = (</span><br><span class="line">                stats[<span class="string">&#x27;used_memory&#x27;</span>] / stats[<span class="string">&#x27;maxmemory&#x27;</span>] * <span class="number">100</span></span><br><span class="line">            )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Calculate hit ratio</span></span><br><span class="line">        total_requests = stats[<span class="string">&#x27;keyspace_hits&#x27;</span>] + stats[<span class="string">&#x27;keyspace_misses&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> total_requests &gt; <span class="number">0</span>:</span><br><span class="line">            stats[<span class="string">&#x27;hit_ratio&#x27;</span>] = stats[<span class="string">&#x27;keyspace_hits&#x27;</span>] / total_requests * <span class="number">100</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            stats[<span class="string">&#x27;hit_ratio&#x27;</span>] = <span class="number">0</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> stats</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">analyze_key_expiration_patterns</span>(<span class="params">self, pattern=<span class="string">&quot;*&quot;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Analyze expiration patterns for keys matching pattern&quot;&quot;&quot;</span></span><br><span class="line">        keys = <span class="variable language_">self</span>.redis.keys(pattern)</span><br><span class="line">        expiration_analysis = &#123;</span><br><span class="line">            <span class="string">&#x27;total_keys&#x27;</span>: <span class="built_in">len</span>(keys),</span><br><span class="line">            <span class="string">&#x27;keys_with_ttl&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;keys_without_ttl&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;avg_ttl&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;ttl_distribution&#x27;</span>: &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        ttl_values = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> keys:</span><br><span class="line">            ttl = <span class="variable language_">self</span>.redis.ttl(key)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> ttl == -<span class="number">1</span>:  <span class="comment"># No expiration set</span></span><br><span class="line">                expiration_analysis[<span class="string">&#x27;keys_without_ttl&#x27;</span>] += <span class="number">1</span></span><br><span class="line">            <span class="keyword">elif</span> ttl &gt;= <span class="number">0</span>:  <span class="comment"># Has expiration</span></span><br><span class="line">                expiration_analysis[<span class="string">&#x27;keys_with_ttl&#x27;</span>] += <span class="number">1</span></span><br><span class="line">                ttl_values.append(ttl)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># Categorize TTL</span></span><br><span class="line">                <span class="keyword">if</span> ttl &lt; <span class="number">300</span>:  <span class="comment"># &lt; 5 minutes</span></span><br><span class="line">                    category = <span class="string">&#x27;short_term&#x27;</span></span><br><span class="line">                <span class="keyword">elif</span> ttl &lt; <span class="number">3600</span>:  <span class="comment"># &lt; 1 hour</span></span><br><span class="line">                    category = <span class="string">&#x27;medium_term&#x27;</span></span><br><span class="line">                <span class="keyword">else</span>:  <span class="comment"># &gt;= 1 hour</span></span><br><span class="line">                    category = <span class="string">&#x27;long_term&#x27;</span></span><br><span class="line">                </span><br><span class="line">                expiration_analysis[<span class="string">&#x27;ttl_distribution&#x27;</span>][category] = \</span><br><span class="line">                    expiration_analysis[<span class="string">&#x27;ttl_distribution&#x27;</span>].get(category, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ttl_values:</span><br><span class="line">            expiration_analysis[<span class="string">&#x27;avg_ttl&#x27;</span>] = <span class="built_in">sum</span>(ttl_values) / <span class="built_in">len</span>(ttl_values)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> expiration_analysis</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage</span></span><br><span class="line">monitor = ExpirationMonitor()</span><br><span class="line">stats = monitor.get_expiration_stats()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Hit ratio: <span class="subst">&#123;stats[<span class="string">&#x27;hit_ratio&#x27;</span>]:<span class="number">.2</span>f&#125;</span>%&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Memory usage: <span class="subst">&#123;stats[<span class="string">&#x27;memory_usage_percentage&#x27;</span>]:<span class="number">.2</span>f&#125;</span>%&quot;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Configuration-Checklist"><a href="#Configuration-Checklist" class="headerlink" title="Configuration Checklist"></a>Configuration Checklist</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Memory management</span></span><br><span class="line">maxmemory 2gb</span><br><span class="line">maxmemory-policy allkeys-lru</span><br><span class="line"></span><br><span class="line"><span class="comment"># Expiration tuning</span></span><br><span class="line">hz 10</span><br><span class="line">active-expire-effort 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Persistence (affects expiration)</span></span><br><span class="line">save 900 1</span><br><span class="line">appendonly <span class="built_in">yes</span></span><br><span class="line">appendfsync everysec</span><br><span class="line"></span><br><span class="line"><span class="comment"># Monitoring</span></span><br><span class="line">latency-monitor-threshold 100</span><br></pre></td></tr></table></figure>

<h2 id="Interview-Questions-and-Expert-Answers"><a href="#Interview-Questions-and-Expert-Answers" class="headerlink" title="Interview Questions and Expert Answers"></a>Interview Questions and Expert Answers</h2><p><strong>Q: How does Redis handle expiration in a master-slave setup, and what happens during failover?</strong></p>
<p>A: In Redis replication, only the master performs expiration logic. When a key expires on the master (either through lazy or active expiration), the master sends an explicit <code>DEL</code> command to all slaves. Slaves never expire keys independently - they wait for the master’s instruction.</p>
<p>During failover, the promoted slave becomes the new master and starts handling expiration. However, there might be temporary inconsistencies because:</p>
<ol>
<li>The old master might have expired keys that weren’t yet replicated</li>
<li>Clock differences can cause timing variations</li>
<li>Some keys might appear “unexpired” on the new master</li>
</ol>
<p>Production applications should handle these edge cases by implementing fallback mechanisms and not relying solely on Redis for strict expiration timing.</p>
<p><strong>Q: What’s the difference between eviction and expiration, and how do they interact?</strong></p>
<p>A: Expiration is time-based removal of keys that have reached their TTL, while eviction is memory-pressure-based removal when Redis reaches its memory limit.</p>
<p>They interact in several ways:</p>
<ul>
<li>Eviction policies like <code>volatile-lru</code> only consider keys with expiration set</li>
<li>Active expiration reduces memory pressure, potentially avoiding eviction</li>
<li>The <code>volatile-ttl</code> policy evicts keys with the shortest remaining TTL first</li>
<li>Proper TTL configuration can reduce eviction frequency and improve cache performance</li>
</ul>
<p><strong>Q: How would you optimize Redis expiration for a high-traffic e-commerce site?</strong></p>
<p>A: For high-traffic e-commerce, I’d implement a multi-tier expiration strategy:</p>
<ol>
<li><strong>Product Catalog</strong>: Long TTL (4-24 hours) with background refresh</li>
<li><strong>Inventory Counts</strong>: Short TTL (1-5 minutes) with real-time updates</li>
<li><strong>User Sessions</strong>: Medium TTL (30 minutes) with sliding expiration</li>
<li><strong>Shopping Carts</strong>: Longer TTL (24-48 hours) with cleanup processes</li>
<li><strong>Search Results</strong>: Staggered TTL (15-60 minutes) with jitter to prevent thundering herd</li>
</ol>
<p>Key optimizations:</p>
<ul>
<li>Use <code>allkeys-lru</code> eviction for cache-heavy workloads</li>
<li>Implement predictive pre-loading for related products</li>
<li>Add jitter to TTL values to prevent simultaneous expiration</li>
<li>Monitor hot keys and implement replication strategies</li>
<li>Use pipeline operations for bulk TTL updates</li>
</ul>
<p>The goal is balancing data freshness, memory usage, and system performance while handling traffic spikes gracefully.</p>
<h2 id="External-References-and-Resources"><a href="#External-References-and-Resources" class="headerlink" title="External References and Resources"></a>External References and Resources</h2><ul>
<li><a target="_blank" rel="noopener" href="https://redis.io/commands/expire/">Redis Expiration Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://redis.io/topics/memory-optimization">Redis Memory Optimization Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://redis.io/topics/cluster-spec">Redis Cluster Specification</a></li>
<li><a target="_blank" rel="noopener" href="https://redis.io/topics/persistence">Redis Persistence Demystified</a></li>
<li><a target="_blank" rel="noopener" href="https://redis.io/topics/patterns">High Performance Redis Patterns</a></li>
</ul>
<h2 id="Key-Takeaways"><a href="#Key-Takeaways" class="headerlink" title="Key Takeaways"></a>Key Takeaways</h2><p>Redis expiration deletion policies are crucial for maintaining optimal performance and memory usage in production systems. The combination of lazy deletion, active expiration, and memory eviction policies provides flexible options for different use cases.</p>
<p>Success in production requires understanding the trade-offs between memory usage, CPU overhead, and data consistency, especially in distributed environments. Monitoring expiration efficiency and implementing appropriate TTL strategies based on access patterns is essential for maintaining high-performance Redis deployments.</p>
<p>The key is matching expiration strategies to your specific use case: use longer TTLs with background refresh for stable data, shorter TTLs for frequently changing data, and implement sophisticated hot key handling for high-traffic scenarios.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/18/Redis-Cache-Eviction-Policies-Complete-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/18/Redis-Cache-Eviction-Policies-Complete-Guide/" class="post-title-link" itemprop="url">Redis Cache Eviction Policies - Complete Guide</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-18 20:51:32" itemprop="dateCreated datePublished" datetime="2025-06-18T20:51:32+08:00">2025-06-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-19 15:27:13" itemprop="dateModified" datetime="2025-06-19T15:27:13+08:00">2025-06-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Overview-of-Redis-Memory-Management"><a href="#Overview-of-Redis-Memory-Management" class="headerlink" title="Overview of Redis Memory Management"></a>Overview of Redis Memory Management</h2><p>Redis is an in-memory data structure store that requires careful memory management to maintain optimal performance. When Redis approaches its memory limit, it must decide which keys to remove to make space for new data. This process is called <strong>memory eviction</strong>.</p>
<pre>
<code class="mermaid">
flowchart TD
A[Redis Instance] --&gt; B{Memory Usage Check}
B --&gt;|Below maxmemory| C[Accept New Data]
B --&gt;|At maxmemory| D[Apply Eviction Policy]
D --&gt; E[Select Keys to Evict]
E --&gt; F[Remove Selected Keys]
F --&gt; G[Accept New Data]

style A fill:#f9f,stroke:#333,stroke-width:2px
style D fill:#bbf,stroke:#333,stroke-width:2px
style E fill:#fbb,stroke:#333,stroke-width:2px
</code>
</pre>

<p><strong>Interview Insight</strong>: <em>Why is memory management crucial in Redis?</em></p>
<ul>
<li>Redis stores all data in RAM for fast access</li>
<li>Uncontrolled memory growth can lead to system crashes</li>
<li>Proper eviction prevents OOM (Out of Memory) errors</li>
<li>Maintains predictable performance characteristics</li>
</ul>
<h2 id="Redis-Memory-Eviction-Policies"><a href="#Redis-Memory-Eviction-Policies" class="headerlink" title="Redis Memory Eviction Policies"></a>Redis Memory Eviction Policies</h2><p>Redis offers 8 different eviction policies, each serving different use cases:</p>
<h3 id="LRU-Based-Policies"><a href="#LRU-Based-Policies" class="headerlink" title="LRU-Based Policies"></a>LRU-Based Policies</h3><h4 id="allkeys-lru"><a href="#allkeys-lru" class="headerlink" title="allkeys-lru"></a>allkeys-lru</h4><p>Evicts the least recently used keys across all keys in the database.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Configuration</span></span><br><span class="line">CONFIG SET maxmemory-policy allkeys-lru</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example scenario</span></span><br><span class="line">SET user:1001 <span class="string">&quot;John Doe&quot;</span>     <span class="comment"># Time: T1</span></span><br><span class="line">GET user:1001               <span class="comment"># Access at T2</span></span><br><span class="line">SET user:1002 <span class="string">&quot;Jane Smith&quot;</span>  <span class="comment"># Time: T3</span></span><br><span class="line"><span class="comment"># If memory is full, user:1002 is more likely to be evicted</span></span><br></pre></td></tr></table></figure>

<p><strong>Best Practice</strong>: Use when you have a natural access pattern where some data is accessed more frequently than others.</p>
<h4 id="volatile-lru"><a href="#volatile-lru" class="headerlink" title="volatile-lru"></a>volatile-lru</h4><p>Evicts the least recently used keys only among keys with an expiration set.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Setup</span></span><br><span class="line">SET session:abc123 <span class="string">&quot;user_data&quot;</span> EX 3600  <span class="comment"># With expiration</span></span><br><span class="line">SET config:theme <span class="string">&quot;dark&quot;</span>                 <span class="comment"># Without expiration</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Only session:abc123 is eligible for LRU eviction</span></span><br></pre></td></tr></table></figure>

<p><strong>Use Case</strong>: Session management where you want to preserve configuration data.</p>
<h3 id="LFU-Based-Policies"><a href="#LFU-Based-Policies" class="headerlink" title="LFU-Based Policies"></a>LFU-Based Policies</h3><h4 id="allkeys-lfu"><a href="#allkeys-lfu" class="headerlink" title="allkeys-lfu"></a>allkeys-lfu</h4><p>Evicts the least frequently used keys across all keys.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Example: Access frequency tracking</span></span><br><span class="line">SET product:1 <span class="string">&quot;laptop&quot;</span>      <span class="comment"># Accessed 100 times</span></span><br><span class="line">SET product:2 <span class="string">&quot;mouse&quot;</span>       <span class="comment"># Accessed 5 times</span></span><br><span class="line">SET product:3 <span class="string">&quot;keyboard&quot;</span>    <span class="comment"># Accessed 50 times</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># product:2 (mouse) would be evicted first due to lowest frequency</span></span><br></pre></td></tr></table></figure>

<h4 id="volatile-lfu"><a href="#volatile-lfu" class="headerlink" title="volatile-lfu"></a>volatile-lfu</h4><p>Evicts the least frequently used keys only among keys with expiration.</p>
<p><strong>Interview Insight</strong>: <em>When would you choose LFU over LRU?</em></p>
<ul>
<li>LFU is better for data with consistent access patterns</li>
<li>LRU is better for data with temporal locality</li>
<li>LFU prevents cache pollution from occasional bulk operations</li>
</ul>
<h3 id="Random-Policies"><a href="#Random-Policies" class="headerlink" title="Random Policies"></a>Random Policies</h3><h4 id="allkeys-random"><a href="#allkeys-random" class="headerlink" title="allkeys-random"></a>allkeys-random</h4><p>Randomly selects keys for eviction across all keys.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Simulation of random eviction</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">keys = [<span class="string">&quot;user:1&quot;</span>, <span class="string">&quot;user:2&quot;</span>, <span class="string">&quot;user:3&quot;</span>, <span class="string">&quot;config:db&quot;</span>, <span class="string">&quot;session:xyz&quot;</span>]</span><br><span class="line">evict_key = random.choice(keys)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Evicting: <span class="subst">&#123;evict_key&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="volatile-random"><a href="#volatile-random" class="headerlink" title="volatile-random"></a>volatile-random</h4><p>Randomly selects keys for eviction only among keys with expiration.</p>
<p><strong>When to Use Random Policies</strong>:</p>
<ul>
<li>When access patterns are completely unpredictable</li>
<li>For testing and development environments</li>
<li>When you need simple, fast eviction decisions</li>
</ul>
<h3 id="TTL-Based-Policy"><a href="#TTL-Based-Policy" class="headerlink" title="TTL-Based Policy"></a>TTL-Based Policy</h3><h4 id="volatile-ttl"><a href="#volatile-ttl" class="headerlink" title="volatile-ttl"></a>volatile-ttl</h4><p>Evicts keys with expiration, prioritizing those with shorter remaining TTL.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Example scenario</span></span><br><span class="line">SET cache:data1 <span class="string">&quot;value1&quot;</span> EX 3600  <span class="comment"># Expires in 1 hour</span></span><br><span class="line">SET cache:data2 <span class="string">&quot;value2&quot;</span> EX 1800  <span class="comment"># Expires in 30 minutes</span></span><br><span class="line">SET cache:data3 <span class="string">&quot;value3&quot;</span> EX 7200  <span class="comment"># Expires in 2 hours</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cache:data2 will be evicted first (shortest TTL)</span></span><br></pre></td></tr></table></figure>

<h3 id="No-Eviction-Policy"><a href="#No-Eviction-Policy" class="headerlink" title="No Eviction Policy"></a>No Eviction Policy</h3><h4 id="noeviction"><a href="#noeviction" class="headerlink" title="noeviction"></a>noeviction</h4><p>Returns errors when memory limit is reached instead of evicting keys.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CONFIG SET maxmemory-policy noeviction</span><br><span class="line"></span><br><span class="line"><span class="comment"># When memory is full:</span></span><br><span class="line">SET new_key <span class="string">&quot;value&quot;</span></span><br><span class="line"><span class="comment"># Error: OOM command not allowed when used memory &gt; &#x27;maxmemory&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>Use Case</strong>: Critical systems where data loss is unacceptable.</p>
<h2 id="Memory-Limitation-Strategies"><a href="#Memory-Limitation-Strategies" class="headerlink" title="Memory Limitation Strategies"></a>Memory Limitation Strategies</h2><h3 id="Why-Limit-Cache-Memory"><a href="#Why-Limit-Cache-Memory" class="headerlink" title="Why Limit Cache Memory?"></a>Why Limit Cache Memory?</h3><pre>
<code class="mermaid">
flowchart LR
A[Unlimited Memory] --&gt; B[System Instability]
A --&gt; C[Unpredictable Performance]
A --&gt; D[Resource Contention]

E[Limited Memory] --&gt; F[Predictable Behavior]
E --&gt; G[System Stability]
E --&gt; H[Better Resource Planning]

style A fill:#fbb,stroke:#333,stroke-width:2px
style E fill:#bfb,stroke:#333,stroke-width:2px
</code>
</pre>

<p><strong>Production Reasons</strong>:</p>
<ul>
<li><strong>System Stability</strong>: Prevents Redis from consuming all available RAM</li>
<li><strong>Performance Predictability</strong>: Maintains consistent response times</li>
<li><strong>Multi-tenancy</strong>: Allows multiple services to coexist</li>
<li><strong>Cost Control</strong>: Manages infrastructure costs effectively</li>
</ul>
<h3 id="Basic-Memory-Configuration"><a href="#Basic-Memory-Configuration" class="headerlink" title="Basic Memory Configuration"></a>Basic Memory Configuration</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Set maximum memory limit (512MB)</span></span><br><span class="line">CONFIG SET maxmemory 536870912</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set eviction policy</span></span><br><span class="line">CONFIG SET maxmemory-policy allkeys-lru</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check current memory usage</span></span><br><span class="line">INFO memory</span><br></pre></td></tr></table></figure>

<h3 id="Using-Lua-Scripts-for-Advanced-Memory-Control"><a href="#Using-Lua-Scripts-for-Advanced-Memory-Control" class="headerlink" title="Using Lua Scripts for Advanced Memory Control"></a>Using Lua Scripts for Advanced Memory Control</h3><h4 id="Limiting-Key-Value-Pairs"><a href="#Limiting-Key-Value-Pairs" class="headerlink" title="Limiting Key-Value Pairs"></a>Limiting Key-Value Pairs</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- limit_keys.lua: Limit total number of keys</span></span><br><span class="line"><span class="keyword">local</span> max_keys = <span class="built_in">tonumber</span>(ARGV[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">local</span> current_keys = redis.call(<span class="string">&#x27;DBSIZE&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> current_keys &gt;= max_keys <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- Get random key and delete it</span></span><br><span class="line">    <span class="keyword">local</span> keys = redis.call(<span class="string">&#x27;RANDOMKEY&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> keys <span class="keyword">then</span></span><br><span class="line">        redis.call(<span class="string">&#x27;DEL&#x27;</span>, keys)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Evicted key: &quot;</span> .. keys</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Add the new key</span></span><br><span class="line">redis.call(<span class="string">&#x27;SET&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">2</span>])</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;Key added successfully&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Usage</span></span><br><span class="line">EVAL <span class="string">&quot;<span class="subst">$(cat limit_keys.lua)</span>&quot;</span> 1 <span class="string">&quot;new_key&quot;</span> 1000 <span class="string">&quot;new_value&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="Limiting-Value-Size"><a href="#Limiting-Value-Size" class="headerlink" title="Limiting Value Size"></a>Limiting Value Size</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- limit_value_size.lua: Reject large values</span></span><br><span class="line"><span class="keyword">local</span> max_size = <span class="built_in">tonumber</span>(ARGV[<span class="number">2</span>])</span><br><span class="line"><span class="keyword">local</span> value = ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">local</span> value_size = <span class="built_in">string</span>.<span class="built_in">len</span>(value)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> value_size &gt; max_size <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> redis.error_reply(<span class="string">&quot;Value size &quot;</span> .. value_size .. <span class="string">&quot; exceeds limit &quot;</span> .. max_size)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">redis.call(<span class="string">&#x27;SET&#x27;</span>, KEYS[<span class="number">1</span>], value)</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;OK&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Usage: Limit values to 1KB</span></span><br><span class="line">EVAL <span class="string">&quot;<span class="subst">$(cat limit_value_size.lua)</span>&quot;</span> 1 <span class="string">&quot;my_key&quot;</span> <span class="string">&quot;my_value&quot;</span> 1024</span><br></pre></td></tr></table></figure>

<h4 id="Memory-Aware-Key-Management"><a href="#Memory-Aware-Key-Management" class="headerlink" title="Memory-Aware Key Management"></a>Memory-Aware Key Management</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- memory_aware_set.lua: Check memory before setting</span></span><br><span class="line"><span class="keyword">local</span> key = KEYS[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">local</span> value = ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">local</span> memory_threshold = <span class="built_in">tonumber</span>(ARGV[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Get current memory usage</span></span><br><span class="line"><span class="keyword">local</span> memory_info = redis.call(<span class="string">&#x27;MEMORY&#x27;</span>, <span class="string">&#x27;USAGE&#x27;</span>, <span class="string">&#x27;SAMPLES&#x27;</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line"><span class="keyword">local</span> used_memory = memory_info[<span class="string">&#x27;used_memory&#x27;</span>]</span><br><span class="line"><span class="keyword">local</span> max_memory = memory_info[<span class="string">&#x27;maxmemory&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> max_memory &gt; <span class="number">0</span> <span class="keyword">and</span> used_memory &gt; (max_memory * memory_threshold / <span class="number">100</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- Trigger manual cleanup</span></span><br><span class="line">    <span class="keyword">local</span> keys_to_check = redis.call(<span class="string">&#x27;RANDOMKEY&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> keys_to_check <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> key_memory = redis.call(<span class="string">&#x27;MEMORY&#x27;</span>, <span class="string">&#x27;USAGE&#x27;</span>, keys_to_check)</span><br><span class="line">        <span class="keyword">if</span> key_memory &gt; <span class="number">1000</span> <span class="keyword">then</span>  <span class="comment">-- If key uses more than 1KB</span></span><br><span class="line">            redis.call(<span class="string">&#x27;DEL&#x27;</span>, keys_to_check)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">redis.call(<span class="string">&#x27;SET&#x27;</span>, key, value)</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;Key set with memory check&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Practical-Cache-Eviction-Solutions"><a href="#Practical-Cache-Eviction-Solutions" class="headerlink" title="Practical Cache Eviction Solutions"></a>Practical Cache Eviction Solutions</h2><h3 id="Big-Object-Evict-First-Strategy"><a href="#Big-Object-Evict-First-Strategy" class="headerlink" title="Big Object Evict First Strategy"></a>Big Object Evict First Strategy</h3><p>This strategy prioritizes evicting large objects to free maximum memory quickly.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Python implementation for big object eviction</span></span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BigObjectEvictionRedis</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis_client</span><br><span class="line">        <span class="variable language_">self</span>.size_threshold = <span class="number">10240</span>  <span class="comment"># 10KB threshold</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_with_size_check</span>(<span class="params">self, key, value</span>):</span><br><span class="line">        <span class="comment"># Calculate value size</span></span><br><span class="line">        value_size = <span class="built_in">len</span>(<span class="built_in">str</span>(value).encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Store size metadata</span></span><br><span class="line">        <span class="variable language_">self</span>.redis.hset(<span class="string">f&quot;<span class="subst">&#123;key&#125;</span>:meta&quot;</span>, <span class="string">&quot;size&quot;</span>, value_size)</span><br><span class="line">        <span class="variable language_">self</span>.redis.hset(<span class="string">f&quot;<span class="subst">&#123;key&#125;</span>:meta&quot;</span>, <span class="string">&quot;created&quot;</span>, <span class="built_in">int</span>(time.time()))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Set the actual value</span></span><br><span class="line">        <span class="variable language_">self</span>.redis.<span class="built_in">set</span>(key, value)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Track large objects</span></span><br><span class="line">        <span class="keyword">if</span> value_size &gt; <span class="variable language_">self</span>.size_threshold:</span><br><span class="line">            <span class="variable language_">self</span>.redis.sadd(<span class="string">&quot;large_objects&quot;</span>, key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">evict_large_objects</span>(<span class="params">self, target_memory_mb</span>):</span><br><span class="line">        large_objects = <span class="variable language_">self</span>.redis.smembers(<span class="string">&quot;large_objects&quot;</span>)</span><br><span class="line">        freed_memory = <span class="number">0</span></span><br><span class="line">        target_bytes = target_memory_mb * <span class="number">1024</span> * <span class="number">1024</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Sort by size (largest first)</span></span><br><span class="line">        objects_with_size = []</span><br><span class="line">        <span class="keyword">for</span> obj <span class="keyword">in</span> large_objects:</span><br><span class="line">            size = <span class="variable language_">self</span>.redis.hget(<span class="string">f&quot;<span class="subst">&#123;obj&#125;</span>:meta&quot;</span>, <span class="string">&quot;size&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> size:</span><br><span class="line">                objects_with_size.append((obj, <span class="built_in">int</span>(size)))</span><br><span class="line">        </span><br><span class="line">        objects_with_size.sort(key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> obj, size <span class="keyword">in</span> objects_with_size:</span><br><span class="line">            <span class="keyword">if</span> freed_memory &gt;= target_bytes:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">                </span><br><span class="line">            <span class="variable language_">self</span>.redis.delete(obj)</span><br><span class="line">            <span class="variable language_">self</span>.redis.delete(<span class="string">f&quot;<span class="subst">&#123;obj&#125;</span>:meta&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.redis.srem(<span class="string">&quot;large_objects&quot;</span>, obj)</span><br><span class="line">            freed_memory += size</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> freed_memory</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage example</span></span><br><span class="line">r = redis.Redis()</span><br><span class="line">big_obj_redis = BigObjectEvictionRedis(r)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set some large objects</span></span><br><span class="line">big_obj_redis.set_with_size_check(<span class="string">&quot;large_data:1&quot;</span>, <span class="string">&quot;x&quot;</span> * <span class="number">50000</span>)</span><br><span class="line">big_obj_redis.set_with_size_check(<span class="string">&quot;large_data:2&quot;</span>, <span class="string">&quot;y&quot;</span> * <span class="number">30000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Evict to free 100MB</span></span><br><span class="line">freed = big_obj_redis.evict_large_objects(<span class="number">100</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Freed <span class="subst">&#123;freed&#125;</span> bytes&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Small-Object-Evict-First-Strategy"><a href="#Small-Object-Evict-First-Strategy" class="headerlink" title="Small Object Evict First Strategy"></a>Small Object Evict First Strategy</h3><p>Useful when you want to preserve large, expensive-to-recreate objects.</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- small_object_evict.lua</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">get_object_size</span><span class="params">(key)</span></span></span><br><span class="line">    <span class="keyword">return</span> redis.call(<span class="string">&#x27;MEMORY&#x27;</span>, <span class="string">&#x27;USAGE&#x27;</span>, key) <span class="keyword">or</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">evict_small_objects</span><span class="params">(count)</span></span></span><br><span class="line">    <span class="keyword">local</span> all_keys = redis.call(<span class="string">&#x27;KEYS&#x27;</span>, <span class="string">&#x27;*&#x27;</span>)</span><br><span class="line">    <span class="keyword">local</span> small_keys = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i, key <span class="keyword">in</span> <span class="built_in">ipairs</span>(all_keys) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> size = get_object_size(key)</span><br><span class="line">        <span class="keyword">if</span> size &lt; <span class="number">1000</span> <span class="keyword">then</span>  <span class="comment">-- Less than 1KB</span></span><br><span class="line">            <span class="built_in">table</span>.<span class="built_in">insert</span>(small_keys, &#123;key, size&#125;)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- Sort by size (smallest first)</span></span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">sort</span>(small_keys, <span class="function"><span class="keyword">function</span><span class="params">(a, b)</span></span> <span class="keyword">return</span> a[<span class="number">2</span>] &lt; b[<span class="number">2</span>] <span class="keyword">end</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">local</span> evicted = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, <span class="built_in">math</span>.<span class="built_in">min</span>(count, #small_keys) <span class="keyword">do</span></span><br><span class="line">        redis.call(<span class="string">&#x27;DEL&#x27;</span>, small_keys[i][<span class="number">1</span>])</span><br><span class="line">        evicted = evicted + <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> evicted</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> evict_small_objects(<span class="built_in">tonumber</span>(ARGV[<span class="number">1</span>]))</span><br></pre></td></tr></table></figure>

<h3 id="Low-Cost-Evict-First-Strategy"><a href="#Low-Cost-Evict-First-Strategy" class="headerlink" title="Low-Cost Evict First Strategy"></a>Low-Cost Evict First Strategy</h3><p>Evicts data that’s cheap to regenerate or reload.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CostBasedEviction</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis_client</span><br><span class="line">        <span class="variable language_">self</span>.cost_factors = &#123;</span><br><span class="line">            <span class="string">&#x27;cache:&#x27;</span>: <span class="number">1</span>,      <span class="comment"># Low cost - can regenerate</span></span><br><span class="line">            <span class="string">&#x27;session:&#x27;</span>: <span class="number">5</span>,    <span class="comment"># Medium cost - user experience impact</span></span><br><span class="line">            <span class="string">&#x27;computed:&#x27;</span>: <span class="number">10</span>,  <span class="comment"># High cost - expensive computation</span></span><br><span class="line">            <span class="string">&#x27;external:&#x27;</span>: <span class="number">8</span>    <span class="comment"># High cost - external API call</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_with_cost</span>(<span class="params">self, key, value, custom_cost=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="comment"># Determine cost based on key prefix</span></span><br><span class="line">        cost = custom_cost <span class="keyword">or</span> <span class="variable language_">self</span>._calculate_cost(key)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Store with cost metadata</span></span><br><span class="line">        pipe = <span class="variable language_">self</span>.redis.pipeline()</span><br><span class="line">        pipe.<span class="built_in">set</span>(key, value)</span><br><span class="line">        pipe.hset(<span class="string">f&quot;<span class="subst">&#123;key&#125;</span>:meta&quot;</span>, <span class="string">&quot;cost&quot;</span>, cost)</span><br><span class="line">        pipe.hset(<span class="string">f&quot;<span class="subst">&#123;key&#125;</span>:meta&quot;</span>, <span class="string">&quot;timestamp&quot;</span>, <span class="built_in">int</span>(time.time()))</span><br><span class="line">        pipe.execute()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_calculate_cost</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="keyword">for</span> prefix, cost <span class="keyword">in</span> <span class="variable language_">self</span>.cost_factors.items():</span><br><span class="line">            <span class="keyword">if</span> key.startswith(prefix):</span><br><span class="line">                <span class="keyword">return</span> cost</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>  <span class="comment"># Default medium cost</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">evict_low_cost_items</span>(<span class="params">self, target_count</span>):</span><br><span class="line">        <span class="comment"># Get all keys with metadata</span></span><br><span class="line">        pattern = <span class="string">&quot;*:meta&quot;</span></span><br><span class="line">        meta_keys = <span class="variable language_">self</span>.redis.keys(pattern)</span><br><span class="line">        </span><br><span class="line">        items_with_cost = []</span><br><span class="line">        <span class="keyword">for</span> meta_key <span class="keyword">in</span> meta_keys:</span><br><span class="line">            original_key = meta_key.replace(<span class="string">&#x27;:meta&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            cost = <span class="variable language_">self</span>.redis.hget(meta_key, <span class="string">&#x27;cost&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> cost:</span><br><span class="line">                items_with_cost.append((original_key, <span class="built_in">int</span>(cost)))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Sort by cost (lowest first)</span></span><br><span class="line">        items_with_cost.sort(key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>])</span><br><span class="line">        </span><br><span class="line">        evicted = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> key, cost <span class="keyword">in</span> items_with_cost[:target_count]:</span><br><span class="line">            <span class="variable language_">self</span>.redis.delete(key)</span><br><span class="line">            <span class="variable language_">self</span>.redis.delete(<span class="string">f&quot;<span class="subst">&#123;key&#125;</span>:meta&quot;</span>)</span><br><span class="line">            evicted += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> evicted</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage</span></span><br><span class="line">cost_eviction = CostBasedEviction(redis.Redis())</span><br><span class="line">cost_eviction.set_with_cost(<span class="string">&quot;cache:user:1001&quot;</span>, user_data)</span><br><span class="line">cost_eviction.set_with_cost(<span class="string">&quot;computed:analytics:daily&quot;</span>, expensive_computation)</span><br><span class="line">cost_eviction.evict_low_cost_items(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Cold-Data-Evict-First-Strategy"><a href="#Cold-Data-Evict-First-Strategy" class="headerlink" title="Cold Data Evict First Strategy"></a>Cold Data Evict First Strategy</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ColdDataEviction</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis_client</span><br><span class="line">        <span class="variable language_">self</span>.access_tracking_key = <span class="string">&quot;access_log&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_with_tracking</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="comment"># Record access</span></span><br><span class="line">        now = <span class="built_in">int</span>(time.time())</span><br><span class="line">        <span class="variable language_">self</span>.redis.zadd(<span class="variable language_">self</span>.access_tracking_key, &#123;key: now&#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Get value</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.redis.get(key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_with_tracking</span>(<span class="params">self, key, value</span>):</span><br><span class="line">        now = <span class="built_in">int</span>(time.time())</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Set value and track access</span></span><br><span class="line">        pipe = <span class="variable language_">self</span>.redis.pipeline()</span><br><span class="line">        pipe.<span class="built_in">set</span>(key, value)</span><br><span class="line">        pipe.zadd(<span class="variable language_">self</span>.access_tracking_key, &#123;key: now&#125;)</span><br><span class="line">        pipe.execute()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">evict_cold_data</span>(<span class="params">self, days_threshold=<span class="number">7</span>, max_evict=<span class="number">100</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Evict data not accessed within threshold days&quot;&quot;&quot;</span></span><br><span class="line">        cutoff_time = <span class="built_in">int</span>(time.time()) - (days_threshold * <span class="number">24</span> * <span class="number">3600</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Get cold keys (accessed before cutoff time)</span></span><br><span class="line">        cold_keys = <span class="variable language_">self</span>.redis.zrangebyscore(</span><br><span class="line">            <span class="variable language_">self</span>.access_tracking_key, </span><br><span class="line">            <span class="number">0</span>, </span><br><span class="line">            cutoff_time,</span><br><span class="line">            start=<span class="number">0</span>,</span><br><span class="line">            num=max_evict</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        evicted_count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> cold_keys:</span><br><span class="line">            pipe = <span class="variable language_">self</span>.redis.pipeline()</span><br><span class="line">            <span class="keyword">for</span> key <span class="keyword">in</span> cold_keys:</span><br><span class="line">                pipe.delete(key)</span><br><span class="line">                pipe.zrem(<span class="variable language_">self</span>.access_tracking_key, key)</span><br><span class="line">                evicted_count += <span class="number">1</span></span><br><span class="line">                </span><br><span class="line">            pipe.execute()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> evicted_count</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_access_stats</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get access statistics&quot;&quot;&quot;</span></span><br><span class="line">        now = <span class="built_in">int</span>(time.time())</span><br><span class="line">        day_ago = now - <span class="number">86400</span></span><br><span class="line">        week_ago = now - (<span class="number">7</span> * <span class="number">86400</span>)</span><br><span class="line">        </span><br><span class="line">        recent_keys = <span class="variable language_">self</span>.redis.zrangebyscore(<span class="variable language_">self</span>.access_tracking_key, day_ago, now)</span><br><span class="line">        weekly_keys = <span class="variable language_">self</span>.redis.zrangebyscore(<span class="variable language_">self</span>.access_tracking_key, week_ago, now)</span><br><span class="line">        total_keys = <span class="variable language_">self</span>.redis.zcard(<span class="variable language_">self</span>.access_tracking_key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;total_tracked_keys&#x27;</span>: total_keys,</span><br><span class="line">            <span class="string">&#x27;accessed_last_day&#x27;</span>: <span class="built_in">len</span>(recent_keys),</span><br><span class="line">            <span class="string">&#x27;accessed_last_week&#x27;</span>: <span class="built_in">len</span>(weekly_keys),</span><br><span class="line">            <span class="string">&#x27;cold_keys&#x27;</span>: total_keys - <span class="built_in">len</span>(weekly_keys)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage example</span></span><br><span class="line">cold_eviction = ColdDataEviction(redis.Redis())</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use with tracking</span></span><br><span class="line">cold_eviction.set_with_tracking(<span class="string">&quot;user:1001&quot;</span>, <span class="string">&quot;user_data&quot;</span>)</span><br><span class="line">value = cold_eviction.get_with_tracking(<span class="string">&quot;user:1001&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Evict data not accessed in 7 days</span></span><br><span class="line">evicted = cold_eviction.evict_cold_data(days_threshold=<span class="number">7</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Evicted <span class="subst">&#123;evicted&#125;</span> cold data items&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get statistics</span></span><br><span class="line">stats = cold_eviction.get_access_stats()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Access stats: <span class="subst">&#123;stats&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Algorithm-Deep-Dive"><a href="#Algorithm-Deep-Dive" class="headerlink" title="Algorithm Deep Dive"></a>Algorithm Deep Dive</h2><h3 id="LRU-Implementation-Details"><a href="#LRU-Implementation-Details" class="headerlink" title="LRU Implementation Details"></a>LRU Implementation Details</h3><p>Redis uses an approximate LRU algorithm for efficiency:</p>
<pre>
<code class="mermaid">
flowchart TD
A[Key Access] --&gt; B[Update LRU Clock]
B --&gt; C{Memory Full?}
C --&gt;|No| D[Operation Complete]
C --&gt;|Yes| E[Sample Random Keys]
E --&gt; F[Calculate LRU Score]
F --&gt; G[Select Oldest Key]
G --&gt; H[Evict Key]
H --&gt; I[Operation Complete]

style E fill:#bbf,stroke:#333,stroke-width:2px
style F fill:#fbb,stroke:#333,stroke-width:2px
</code>
</pre>

<p><strong>Interview Question</strong>: <em>Why doesn’t Redis use true LRU?</em></p>
<ul>
<li>True LRU requires maintaining a doubly-linked list of all keys</li>
<li>This would consume significant memory overhead</li>
<li>Approximate LRU samples random keys and picks the best candidate</li>
<li>Provides good enough results with much better performance</li>
</ul>
<h3 id="LFU-Implementation-Details"><a href="#LFU-Implementation-Details" class="headerlink" title="LFU Implementation Details"></a>LFU Implementation Details</h3><p>Redis LFU uses a probabilistic counter that decays over time:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Simplified LFU counter simulation</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LFUCounter</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.counter = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.last_access = time.time()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">increment</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Probabilistic increment based on current counter</span></span><br><span class="line">        <span class="comment"># Higher counters increment less frequently</span></span><br><span class="line">        probability = <span class="number">1.0</span> / (<span class="variable language_">self</span>.counter * <span class="number">10</span> + <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> random.random() &lt; probability:</span><br><span class="line">            <span class="variable language_">self</span>.counter += <span class="number">1</span></span><br><span class="line">        <span class="variable language_">self</span>.last_access = time.time()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decay</span>(<span class="params">self, decay_time_minutes=<span class="number">1</span></span>):</span><br><span class="line">        <span class="comment"># Decay counter over time</span></span><br><span class="line">        now = time.time()</span><br><span class="line">        minutes_passed = (now - <span class="variable language_">self</span>.last_access) / <span class="number">60</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> minutes_passed &gt; decay_time_minutes:</span><br><span class="line">            decay_amount = <span class="built_in">int</span>(minutes_passed / decay_time_minutes)</span><br><span class="line">            <span class="variable language_">self</span>.counter = <span class="built_in">max</span>(<span class="number">0</span>, <span class="variable language_">self</span>.counter - decay_amount)</span><br><span class="line">            <span class="variable language_">self</span>.last_access = now</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example usage</span></span><br><span class="line">counter = LFUCounter()</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">    counter.increment()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Counter after 100 accesses: <span class="subst">&#123;counter.counter&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Choosing-the-Right-Eviction-Policy"><a href="#Choosing-the-Right-Eviction-Policy" class="headerlink" title="Choosing the Right Eviction Policy"></a>Choosing the Right Eviction Policy</h2><h3 id="Decision-Matrix"><a href="#Decision-Matrix" class="headerlink" title="Decision Matrix"></a>Decision Matrix</h3><pre>
<code class="mermaid">
flowchart TD
A[Choose Eviction Policy] --&gt; B{Data has TTL?}
B --&gt;|Yes| C{Preserve non-expiring data?}
B --&gt;|No| D{Access pattern known?}

C --&gt;|Yes| E[volatile-lru&#x2F;lfu&#x2F;ttl]
C --&gt;|No| F[allkeys-lru&#x2F;lfu]

D --&gt;|Temporal locality| G[allkeys-lru]
D --&gt;|Frequency based| H[allkeys-lfu]
D --&gt;|Unknown&#x2F;Random| I[allkeys-random]

J{Can tolerate data loss?} --&gt; K[No eviction]
J --&gt;|Yes| L[Choose based on pattern]

style E fill:#bfb,stroke:#333,stroke-width:2px
style G fill:#bbf,stroke:#333,stroke-width:2px
style H fill:#fbb,stroke:#333,stroke-width:2px
</code>
</pre>

<h3 id="Use-Case-Recommendations"><a href="#Use-Case-Recommendations" class="headerlink" title="Use Case Recommendations"></a>Use Case Recommendations</h3><table>
<thead>
<tr>
<th>Use Case</th>
<th>Recommended Policy</th>
<th>Reason</th>
</tr>
</thead>
<tbody><tr>
<td>Web session store</td>
<td><code>volatile-lru</code></td>
<td>Sessions have TTL, preserve config data</td>
</tr>
<tr>
<td>Cache layer</td>
<td><code>allkeys-lru</code></td>
<td>Recent data more likely to be accessed</td>
</tr>
<tr>
<td>Analytics cache</td>
<td><code>allkeys-lfu</code></td>
<td>Popular queries accessed frequently</td>
</tr>
<tr>
<td>Rate limiting</td>
<td><code>volatile-ttl</code></td>
<td>Remove expired limits first</td>
</tr>
<tr>
<td>Database cache</td>
<td><code>allkeys-lfu</code></td>
<td>Hot data accessed repeatedly</td>
</tr>
</tbody></table>
<h3 id="Production-Configuration-Example"><a href="#Production-Configuration-Example" class="headerlink" title="Production Configuration Example"></a>Production Configuration Example</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># redis.conf production settings</span></span><br><span class="line">maxmemory 2gb</span><br><span class="line">maxmemory-policy allkeys-lru</span><br><span class="line">maxmemory-samples 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># Monitor memory usage</span></span><br><span class="line">redis-cli --latency-history -i 1</span><br><span class="line">redis-cli INFO memory | grep used_memory_human</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Monitoring-and-Tuning"><a href="#Performance-Monitoring-and-Tuning" class="headerlink" title="Performance Monitoring and Tuning"></a>Performance Monitoring and Tuning</h2><h3 id="Key-Metrics-to-Monitor"><a href="#Key-Metrics-to-Monitor" class="headerlink" title="Key Metrics to Monitor"></a>Key Metrics to Monitor</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># monitoring_script.py</span></span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">monitor_eviction_performance</span>(<span class="params">redis_client</span>):</span><br><span class="line">    info = redis_client.info(<span class="string">&#x27;stats&#x27;</span>)</span><br><span class="line">    memory_info = redis_client.info(<span class="string">&#x27;memory&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    metrics = &#123;</span><br><span class="line">        <span class="string">&#x27;evicted_keys&#x27;</span>: info.get(<span class="string">&#x27;evicted_keys&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">        <span class="string">&#x27;keyspace_hits&#x27;</span>: info.get(<span class="string">&#x27;keyspace_hits&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">        <span class="string">&#x27;keyspace_misses&#x27;</span>: info.get(<span class="string">&#x27;keyspace_misses&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">        <span class="string">&#x27;used_memory&#x27;</span>: memory_info.get(<span class="string">&#x27;used_memory&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">        <span class="string">&#x27;used_memory_peak&#x27;</span>: memory_info.get(<span class="string">&#x27;used_memory_peak&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">        <span class="string">&#x27;mem_fragmentation_ratio&#x27;</span>: memory_info.get(<span class="string">&#x27;mem_fragmentation_ratio&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Calculate hit ratio</span></span><br><span class="line">    total_requests = metrics[<span class="string">&#x27;keyspace_hits&#x27;</span>] + metrics[<span class="string">&#x27;keyspace_misses&#x27;</span>]</span><br><span class="line">    hit_ratio = metrics[<span class="string">&#x27;keyspace_hits&#x27;</span>] / total_requests <span class="keyword">if</span> total_requests &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    metrics[<span class="string">&#x27;hit_ratio&#x27;</span>] = hit_ratio</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> metrics</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage</span></span><br><span class="line">r = redis.Redis()</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    stats = monitor_eviction_performance(r)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Hit Ratio: <span class="subst">&#123;stats[<span class="string">&#x27;hit_ratio&#x27;</span>]:<span class="number">.2</span>%&#125;</span>, Evicted: <span class="subst">&#123;stats[<span class="string">&#x27;evicted_keys&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Alerting-Thresholds"><a href="#Alerting-Thresholds" class="headerlink" title="Alerting Thresholds"></a>Alerting Thresholds</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># alerts.yml (Prometheus/Grafana style)</span></span><br><span class="line"><span class="attr">alerts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis_hit_ratio_low</span></span><br><span class="line">    <span class="attr">condition:</span> <span class="string">redis_hit_ratio</span> <span class="string">&lt;</span> <span class="number">0.90</span></span><br><span class="line">    <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis_eviction_rate_high</span></span><br><span class="line">    <span class="attr">condition:</span> <span class="string">rate(redis_evicted_keys[5m])</span> <span class="string">&gt;</span> <span class="number">100</span></span><br><span class="line">    <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">    </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis_memory_usage_high</span></span><br><span class="line">    <span class="attr">condition:</span> <span class="string">redis_used_memory</span> <span class="string">/</span> <span class="string">redis_maxmemory</span> <span class="string">&gt;</span> <span class="number">0.90</span></span><br><span class="line">    <span class="attr">severity:</span> <span class="string">warning</span></span><br></pre></td></tr></table></figure>

<h2 id="Interview-Questions-and-Answers"><a href="#Interview-Questions-and-Answers" class="headerlink" title="Interview Questions and Answers"></a>Interview Questions and Answers</h2><h3 id="Advanced-Interview-Questions"><a href="#Advanced-Interview-Questions" class="headerlink" title="Advanced Interview Questions"></a>Advanced Interview Questions</h3><p><strong>Q: How would you handle a scenario where your cache hit ratio drops significantly after implementing LRU eviction?</strong></p>
<p><strong>A</strong>: This suggests the working set is larger than available memory. Solutions:</p>
<ol>
<li>Increase memory allocation if possible</li>
<li>Switch to LFU if there’s a frequency-based access pattern</li>
<li>Implement application-level partitioning</li>
<li>Use Redis Cluster for horizontal scaling</li>
<li>Optimize data structures (use hashes for small objects)</li>
</ol>
<p><strong>Q: Explain the trade-offs between different sampling sizes in Redis LRU implementation.</strong></p>
<p><strong>A</strong>: </p>
<ul>
<li>Small samples (3-5): Fast eviction, less accurate LRU approximation</li>
<li>Large samples (10+): Better LRU approximation, higher CPU overhead</li>
<li>Default (5): Good balance for most use cases</li>
<li>Monitor <code>evicted_keys</code> and <code>keyspace_misses</code> to tune</li>
</ul>
<p><strong>Q: How would you implement a custom eviction policy for a specific business requirement?</strong></p>
<p><strong>A</strong>: Use Lua scripts or application-level logic:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Custom: Evict based on business priority</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">business_priority_evict</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> keys = redis.call(<span class="string">&#x27;KEYS&#x27;</span>, <span class="string">&#x27;*&#x27;</span>)</span><br><span class="line">    <span class="keyword">local</span> priorities = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i, key <span class="keyword">in</span> <span class="built_in">ipairs</span>(keys) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> priority = redis.call(<span class="string">&#x27;HGET&#x27;</span>, key .. <span class="string">&#x27;:meta&#x27;</span>, <span class="string">&#x27;business_priority&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> priority <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">table</span>.<span class="built_in">insert</span>(priorities, &#123;key, <span class="built_in">tonumber</span>(priority)&#125;)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">sort</span>(priorities, <span class="function"><span class="keyword">function</span><span class="params">(a, b)</span></span> <span class="keyword">return</span> a[<span class="number">2</span>] &lt; b[<span class="number">2</span>] <span class="keyword">end</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> #priorities &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        redis.call(<span class="string">&#x27;DEL&#x27;</span>, priorities[<span class="number">1</span>][<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">return</span> priorities[<span class="number">1</span>][<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="Best-Practices-Summary"><a href="#Best-Practices-Summary" class="headerlink" title="Best Practices Summary"></a>Best Practices Summary</h2><h3 id="Configuration-Best-Practices"><a href="#Configuration-Best-Practices" class="headerlink" title="Configuration Best Practices"></a>Configuration Best Practices</h3><ol>
<li><strong>Set appropriate maxmemory</strong>: 80% of available RAM for dedicated Redis instances</li>
<li><strong>Choose policy based on use case</strong>: LRU for temporal, LFU for frequency patterns</li>
<li><strong>Monitor continuously</strong>: Track hit ratios, eviction rates, and memory usage</li>
<li><strong>Test under load</strong>: Verify eviction behavior matches expectations</li>
</ol>
<h3 id="Application-Integration-Best-Practices"><a href="#Application-Integration-Best-Practices" class="headerlink" title="Application Integration Best Practices"></a>Application Integration Best Practices</h3><ol>
<li><strong>Graceful degradation</strong>: Handle cache misses gracefully</li>
<li><strong>TTL strategy</strong>: Set appropriate expiration times</li>
<li><strong>Key naming</strong>: Use consistent patterns for better policy effectiveness</li>
<li><strong>Size awareness</strong>: Monitor and limit large values</li>
</ol>
<h3 id="Operational-Best-Practices"><a href="#Operational-Best-Practices" class="headerlink" title="Operational Best Practices"></a>Operational Best Practices</h3><ol>
<li><strong>Regular monitoring</strong>: Set up alerts for key metrics</li>
<li><strong>Capacity planning</strong>: Plan for growth and peak loads</li>
<li><strong>Testing</strong>: Regularly test eviction scenarios</li>
<li><strong>Documentation</strong>: Document policy choices and rationale</li>
</ol>
<h2 id="External-Resources"><a href="#External-Resources" class="headerlink" title="External Resources"></a>External Resources</h2><ul>
<li><a target="_blank" rel="noopener" href="https://redis.io/docs/manual/eviction/">Redis Memory Optimization Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://redis.io/docs/manual/config/">Redis Configuration Best Practices</a></li>
<li><a target="_blank" rel="noopener" href="https://redis.io/docs/manual/admin/">Redis Monitoring Tools</a></li>
<li><a target="_blank" rel="noopener" href="https://redis.io/docs/manual/optimization/">Performance Tuning Guide</a></li>
</ul>
<p>This comprehensive guide provides the foundation for implementing effective memory eviction strategies in Redis production environments. The combination of theoretical understanding and practical implementation examples ensures robust cache management that scales with your application needs.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/17/Redis-Data-Persistence-Mechanism/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/17/Redis-Data-Persistence-Mechanism/" class="post-title-link" itemprop="url">Redis Data Persistence Mechanism</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-17 20:36:04" itemprop="dateCreated datePublished" datetime="2025-06-17T20:36:04+08:00">2025-06-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-18 16:47:04" itemprop="dateModified" datetime="2025-06-18T16:47:04+08:00">2025-06-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Redis is an in-memory data structure store that provides multiple persistence mechanisms to ensure data durability. Understanding these mechanisms is crucial for building robust, production-ready applications.</p>
<h2 id="Core-Persistence-Mechanisms-Overview"><a href="#Core-Persistence-Mechanisms-Overview" class="headerlink" title="Core Persistence Mechanisms Overview"></a>Core Persistence Mechanisms Overview</h2><p>Redis offers three primary persistence strategies:</p>
<ul>
<li><strong>RDB (Redis Database)</strong>: Point-in-time snapshots</li>
<li><strong>AOF (Append Only File)</strong>: Command logging approach  </li>
<li><strong>Hybrid Mode</strong>: Combination of RDB and AOF for optimal performance and durability</li>
</ul>
<pre>
<code class="mermaid">

A[Redis Memory] --&gt; B{Persistence Strategy}
B --&gt; C[RDB Snapshots]
B --&gt; D[AOF Command Log]
B --&gt; E[Hybrid Mode]

C --&gt; F[Binary Snapshot Files]
D --&gt; G[Command History Files]
E --&gt; H[RDB + AOF Combined]

F --&gt; I[Fast Recovery&lt;br&#x2F;&gt;Larger Data Loss Window]
G --&gt; J[Minimal Data Loss&lt;br&#x2F;&gt;Slower Recovery]
H --&gt; K[Best of Both Worlds]
</code>
</pre>

<h2 id="RDB-Redis-Database-Snapshots"><a href="#RDB-Redis-Database-Snapshots" class="headerlink" title="RDB (Redis Database) Snapshots"></a>RDB (Redis Database) Snapshots</h2><h3 id="Mechanism-Deep-Dive"><a href="#Mechanism-Deep-Dive" class="headerlink" title="Mechanism Deep Dive"></a>Mechanism Deep Dive</h3><p>RDB creates point-in-time snapshots of your dataset at specified intervals. The process involves:</p>
<ol>
<li><strong>Fork Process</strong>: Redis forks a child process to handle snapshot creation</li>
<li><strong>Copy-on-Write</strong>: Leverages OS copy-on-write semantics for memory efficiency</li>
<li><strong>Binary Format</strong>: Creates compact binary files for fast loading</li>
<li><strong>Non-blocking</strong>: Main Redis process continues serving requests</li>
</ol>
<pre>
<code class="mermaid">

participant Client
participant Redis Main
participant Child Process
participant Disk

Client-&gt;&gt;Redis Main: Write Operations
Redis Main-&gt;&gt;Child Process: fork() for BGSAVE
Child Process-&gt;&gt;Disk: Write RDB snapshot
Redis Main-&gt;&gt;Client: Continue serving requests
Child Process-&gt;&gt;Redis Main: Snapshot complete
</code>
</pre>

<h3 id="Configuration-Examples"><a href="#Configuration-Examples" class="headerlink" title="Configuration Examples"></a>Configuration Examples</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Basic RDB configuration in redis.conf</span></span><br><span class="line">save 900 1      <span class="comment"># Save after 900 seconds if at least 1 key changed</span></span><br><span class="line">save 300 10     <span class="comment"># Save after 300 seconds if at least 10 keys changed  </span></span><br><span class="line">save 60 10000   <span class="comment"># Save after 60 seconds if at least 10000 keys changed</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># RDB file settings</span></span><br><span class="line">dbfilename dump.rdb</span><br><span class="line"><span class="built_in">dir</span> /var/lib/redis/</span><br><span class="line"></span><br><span class="line"><span class="comment"># Compression (recommended for production)</span></span><br><span class="line">rdbcompression <span class="built_in">yes</span></span><br><span class="line">rdbchecksum <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>

<h3 id="Manual-Snapshot-Commands"><a href="#Manual-Snapshot-Commands" class="headerlink" title="Manual Snapshot Commands"></a>Manual Snapshot Commands</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Synchronous save (blocks Redis)</span></span><br><span class="line">SAVE</span><br><span class="line"></span><br><span class="line"><span class="comment"># Background save (non-blocking, recommended)</span></span><br><span class="line">BGSAVE</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get last save timestamp</span></span><br><span class="line">LASTSAVE</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check if background save is in progress</span></span><br><span class="line">LASTSAVE</span><br></pre></td></tr></table></figure>

<h3 id="Production-Best-Practices"><a href="#Production-Best-Practices" class="headerlink" title="Production Best Practices"></a>Production Best Practices</h3><p><strong>Scheduling Strategy:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># High-frequency writes: More frequent snapshots</span></span><br><span class="line">save 300 10     <span class="comment"># 5 minutes if 10+ changes</span></span><br><span class="line">save 120 100    <span class="comment"># 2 minutes if 100+ changes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Low-frequency writes: Less frequent snapshots  </span></span><br><span class="line">save 900 1      <span class="comment"># 15 minutes if 1+ change</span></span><br><span class="line">save 1800 10    <span class="comment"># 30 minutes if 10+ changes</span></span><br></pre></td></tr></table></figure>

<p><strong>Real-world Use Case: E-commerce Session Store</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Session data with RDB configuration</span></span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line">r = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Store user session (will be included in next RDB snapshot)</span></span><br><span class="line">session_data = &#123;</span><br><span class="line">    <span class="string">&#x27;user_id&#x27;</span>: <span class="string">&#x27;12345&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;cart_items&#x27;</span>: [<span class="string">&#x27;item1&#x27;</span>, <span class="string">&#x27;item2&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;last_activity&#x27;</span>: <span class="string">&#x27;2024-01-15T10:30:00Z&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r.hset(<span class="string">&#x27;session:user:12345&#x27;</span>, mapping=session_data)</span><br><span class="line">r.expire(<span class="string">&#x27;session:user:12345&#x27;</span>, <span class="number">3600</span>)  <span class="comment"># 1 hour TTL</span></span><br></pre></td></tr></table></figure>

<h3 id="RDB-Advantages-and-Limitations"><a href="#RDB-Advantages-and-Limitations" class="headerlink" title="RDB Advantages and Limitations"></a>RDB Advantages and Limitations</h3><p><strong>Advantages:</strong></p>
<ul>
<li>Compact single-file backups</li>
<li>Fast Redis restart times</li>
<li>Good for disaster recovery</li>
<li>Minimal impact on performance</li>
<li>Perfect for backup strategies</li>
</ul>
<p><strong>Limitations:</strong></p>
<ul>
<li>Data loss potential between snapshots</li>
<li>Fork can be expensive with large datasets</li>
<li>Not suitable for minimal data loss requirements</li>
</ul>
<p><strong>💡 Interview Insight:</strong> “What happens if Redis crashes between RDB snapshots?”<br><em>Answer: All data written since the last snapshot is lost. This is why RDB alone isn’t suitable for applications requiring minimal data loss.</em></p>
<h2 id="AOF-Append-Only-File-Persistence"><a href="#AOF-Append-Only-File-Persistence" class="headerlink" title="AOF (Append Only File) Persistence"></a>AOF (Append Only File) Persistence</h2><h3 id="Mechanism-Deep-Dive-1"><a href="#Mechanism-Deep-Dive-1" class="headerlink" title="Mechanism Deep Dive"></a>Mechanism Deep Dive</h3><p>AOF logs every write operation received by the server, creating a reconstruction log of dataset operations.</p>
<pre>
<code class="mermaid">

A[Client Write] --&gt; B[Redis Memory]
B --&gt; C[AOF Buffer]
C --&gt; D{Sync Policy}
D --&gt; E[OS Buffer]
E --&gt; F[Disk Write]

D --&gt; G[always: Every Command]
D --&gt; H[everysec: Every Second]  
D --&gt; I[no: OS Decides]
</code>
</pre>

<h3 id="AOF-Configuration-Options"><a href="#AOF-Configuration-Options" class="headerlink" title="AOF Configuration Options"></a>AOF Configuration Options</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Enable AOF</span></span><br><span class="line">appendonly <span class="built_in">yes</span></span><br><span class="line">appendfilename <span class="string">&quot;appendonly.aof&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Sync policies</span></span><br><span class="line">appendfsync everysec    <span class="comment"># Recommended for most cases</span></span><br><span class="line"><span class="comment"># appendfsync always    # Maximum durability, slower performance</span></span><br><span class="line"><span class="comment"># appendfsync no        # Best performance, less durability</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># AOF rewrite configuration</span></span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line"></span><br><span class="line"><span class="comment"># Handle AOF corruption</span></span><br><span class="line">aof-load-truncated <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>

<h3 id="Sync-Policies-Comparison"><a href="#Sync-Policies-Comparison" class="headerlink" title="Sync Policies Comparison"></a>Sync Policies Comparison</h3><table>
<thead>
<tr>
<th>Policy</th>
<th>Durability</th>
<th>Performance</th>
<th>Data Loss Risk</th>
</tr>
</thead>
<tbody><tr>
<td><code>always</code></td>
<td>Highest</td>
<td>Slowest</td>
<td>~0 commands</td>
</tr>
<tr>
<td><code>everysec</code></td>
<td>Good</td>
<td>Balanced</td>
<td>~1 second</td>
</tr>
<tr>
<td><code>no</code></td>
<td>Lowest</td>
<td>Fastest</td>
<td>OS buffer size</td>
</tr>
</tbody></table>
<h3 id="AOF-Rewrite-Process"><a href="#AOF-Rewrite-Process" class="headerlink" title="AOF Rewrite Process"></a>AOF Rewrite Process</h3><p>AOF files grow over time, so Redis provides rewrite functionality to optimize file size:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Manual AOF rewrite</span></span><br><span class="line">BGREWRITEAOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check rewrite status</span></span><br><span class="line">INFO persistence</span><br></pre></td></tr></table></figure>

<p><strong>Rewrite Example:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Original AOF commands</span></span><br><span class="line">SET counter 1</span><br><span class="line">INCR counter    <span class="comment"># counter = 2</span></span><br><span class="line">INCR counter    <span class="comment"># counter = 3</span></span><br><span class="line">INCR counter    <span class="comment"># counter = 4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># After rewrite, simplified to:</span></span><br><span class="line">SET counter 4</span><br></pre></td></tr></table></figure>

<h3 id="Production-Configuration-Example"><a href="#Production-Configuration-Example" class="headerlink" title="Production Configuration Example"></a>Production Configuration Example</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Production AOF settings</span></span><br><span class="line">appendonly <span class="built_in">yes</span></span><br><span class="line">appendfilename <span class="string">&quot;appendonly.aof&quot;</span></span><br><span class="line">appendfsync everysec</span><br><span class="line"></span><br><span class="line"><span class="comment"># Automatic rewrite triggers</span></span><br><span class="line">auto-aof-rewrite-percentage 100    <span class="comment"># Rewrite when file doubles in size</span></span><br><span class="line">auto-aof-rewrite-min-size 64mb     <span class="comment"># Minimum size before considering rewrite</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Rewrite process settings</span></span><br><span class="line">no-appendfsync-on-rewrite no       <span class="comment"># Continue syncing during rewrite</span></span><br><span class="line">aof-rewrite-incremental-fsync <span class="built_in">yes</span>  <span class="comment"># Incremental fsync during rewrite</span></span><br></pre></td></tr></table></figure>

<h3 id="Real-world-Use-Case-Financial-Transaction-Log"><a href="#Real-world-Use-Case-Financial-Transaction-Log" class="headerlink" title="Real-world Use Case: Financial Transaction Log"></a>Real-world Use Case: Financial Transaction Log</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">r = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">log_transaction</span>(<span class="params">user_id, amount, transaction_type</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Log financial transaction with AOF persistence&quot;&quot;&quot;</span></span><br><span class="line">    transaction = &#123;</span><br><span class="line">        <span class="string">&#x27;user_id&#x27;</span>: user_id,</span><br><span class="line">        <span class="string">&#x27;amount&#x27;</span>: amount,</span><br><span class="line">        <span class="string">&#x27;type&#x27;</span>: transaction_type,</span><br><span class="line">        <span class="string">&#x27;timestamp&#x27;</span>: datetime.now().isoformat(),</span><br><span class="line">        <span class="string">&#x27;transaction_id&#x27;</span>: <span class="string">f&quot;txn_<span class="subst">&#123;user_id&#125;</span>_<span class="subst">&#123;<span class="built_in">int</span>(datetime.now().timestamp())&#125;</span>&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># This command will be logged in AOF</span></span><br><span class="line">    pipe = r.pipeline()</span><br><span class="line">    pipe.lpush(<span class="string">f&#x27;transactions:<span class="subst">&#123;user_id&#125;</span>&#x27;</span>, json.dumps(transaction))</span><br><span class="line">    pipe.incr(<span class="string">f&#x27;balance:<span class="subst">&#123;user_id&#125;</span>&#x27;</span>, amount <span class="keyword">if</span> transaction_type == <span class="string">&#x27;credit&#x27;</span> <span class="keyword">else</span> -amount)</span><br><span class="line">    pipe.execute()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> transaction</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage</span></span><br><span class="line">transaction = log_transaction(<span class="string">&#x27;user123&#x27;</span>, <span class="number">100.00</span>, <span class="string">&#x27;credit&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Transaction logged: <span class="subst">&#123;transaction&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>💡 Interview Insight:</strong> “How does AOF handle partial writes or corruption?”<br><em>Answer: Redis can handle truncated AOF files with <code>aof-load-truncated yes</code>. For corruption in the middle, tools like <code>redis-check-aof --fix</code> can repair the file.</em></p>
<h2 id="Hybrid-Persistence-Mode"><a href="#Hybrid-Persistence-Mode" class="headerlink" title="Hybrid Persistence Mode"></a>Hybrid Persistence Mode</h2><p>Hybrid mode combines RDB and AOF to leverage the benefits of both approaches.</p>
<h3 id="How-Hybrid-Mode-Works"><a href="#How-Hybrid-Mode-Works" class="headerlink" title="How Hybrid Mode Works"></a>How Hybrid Mode Works</h3><pre>
<code class="mermaid">

A[Redis Start] --&gt; B{Check for AOF}
B --&gt;|AOF exists| C[Load AOF file]
B --&gt;|No AOF| D[Load RDB file]

C --&gt; E[Runtime Operations]
D --&gt; E

E --&gt; F[RDB Snapshots]
E --&gt; G[AOF Command Logging]

F --&gt; H[Background Snapshots]
G --&gt; I[Continuous Command Log]

H --&gt; J[Fast Recovery Base]
I --&gt; K[Recent Changes]
</code>
</pre>

<h3 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Enable hybrid mode</span></span><br><span class="line">appendonly <span class="built_in">yes</span></span><br><span class="line">aof-use-rdb-preamble <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This creates AOF files with RDB preamble</span></span><br><span class="line"><span class="comment"># Format: [RDB snapshot][AOF commands since snapshot]</span></span><br></pre></td></tr></table></figure>

<h3 id="Hybrid-Mode-Benefits"><a href="#Hybrid-Mode-Benefits" class="headerlink" title="Hybrid Mode Benefits"></a>Hybrid Mode Benefits</h3><ol>
<li><strong>Fast Recovery</strong>: RDB portion loads quickly</li>
<li><strong>Minimal Data Loss</strong>: AOF portion captures recent changes</li>
<li><strong>Optimal File Size</strong>: RDB compression + incremental AOF</li>
<li><strong>Best of Both</strong>: Performance + durability</li>
</ol>
<h2 id="RDB-vs-AOF-vs-Hybrid-Comparison"><a href="#RDB-vs-AOF-vs-Hybrid-Comparison" class="headerlink" title="RDB vs AOF vs Hybrid Comparison"></a>RDB vs AOF vs Hybrid Comparison</h2><pre>
<code class="mermaid">

A[Persistence Requirements] --&gt; B{Priority?}

B --&gt;|Performance| C[RDB Only]
B --&gt;|Durability| D[AOF Only]
B --&gt;|Balanced| E[Hybrid Mode]

C --&gt; F[Fast restarts&lt;br&#x2F;&gt;Larger data loss window&lt;br&#x2F;&gt;Smaller files]
D --&gt; G[Minimal data loss&lt;br&#x2F;&gt;Slower restarts&lt;br&#x2F;&gt;Larger files]
E --&gt; H[Fast restarts&lt;br&#x2F;&gt;Minimal data loss&lt;br&#x2F;&gt;Optimal file size]
</code>
</pre>

<table>
<thead>
<tr>
<th>Aspect</th>
<th>RDB</th>
<th>AOF</th>
<th>Hybrid</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Recovery Speed</strong></td>
<td>Fast</td>
<td>Slow</td>
<td>Fast</td>
</tr>
<tr>
<td><strong>Data Loss Risk</strong></td>
<td>Higher</td>
<td>Lower</td>
<td>Lower</td>
</tr>
<tr>
<td><strong>File Size</strong></td>
<td>Smaller</td>
<td>Larger</td>
<td>Optimal</td>
</tr>
<tr>
<td><strong>CPU Impact</strong></td>
<td>Lower</td>
<td>Higher</td>
<td>Balanced</td>
</tr>
<tr>
<td><strong>Disk I&#x2F;O</strong></td>
<td>Periodic</td>
<td>Continuous</td>
<td>Balanced</td>
</tr>
<tr>
<td><strong>Backup Strategy</strong></td>
<td>Excellent</td>
<td>Good</td>
<td>Excellent</td>
</tr>
</tbody></table>
<h2 id="Production-Deployment-Strategies"><a href="#Production-Deployment-Strategies" class="headerlink" title="Production Deployment Strategies"></a>Production Deployment Strategies</h2><h3 id="High-Availability-Setup"><a href="#High-Availability-Setup" class="headerlink" title="High Availability Setup"></a>High Availability Setup</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Master node configuration</span></span><br><span class="line">appendonly <span class="built_in">yes</span></span><br><span class="line">aof-use-rdb-preamble <span class="built_in">yes</span></span><br><span class="line">appendfsync everysec</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line"></span><br><span class="line"><span class="comment"># Replica node configuration  </span></span><br><span class="line">replica-read-only <span class="built_in">yes</span></span><br><span class="line"><span class="comment"># Replicas automatically inherit persistence settings</span></span><br></pre></td></tr></table></figure>

<h3 id="Monitoring-and-Alerting"><a href="#Monitoring-and-Alerting" class="headerlink" title="Monitoring and Alerting"></a>Monitoring and Alerting</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_persistence_health</span>(<span class="params">redis_client</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Monitor Redis persistence health&quot;&quot;&quot;</span></span><br><span class="line">    info = redis_client.info(<span class="string">&#x27;persistence&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    checks = &#123;</span><br><span class="line">        <span class="string">&#x27;rdb_last_save_age&#x27;</span>: info.get(<span class="string">&#x27;rdb_changes_since_last_save&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">        <span class="string">&#x27;aof_enabled&#x27;</span>: info.get(<span class="string">&#x27;aof_enabled&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">        <span class="string">&#x27;aof_rewrite_in_progress&#x27;</span>: info.get(<span class="string">&#x27;aof_rewrite_in_progress&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">        <span class="string">&#x27;rdb_bgsave_in_progress&#x27;</span>: info.get(<span class="string">&#x27;rdb_bgsave_in_progress&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Alert if no save in 30 minutes and changes exist</span></span><br><span class="line">    <span class="keyword">if</span> checks[<span class="string">&#x27;rdb_last_save_age&#x27;</span>] &gt; <span class="number">0</span>:</span><br><span class="line">        last_save_time = info.get(<span class="string">&#x27;rdb_last_save_time&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">if</span> (time.time() - last_save_time) &gt; <span class="number">1800</span>:  <span class="comment"># 30 minutes</span></span><br><span class="line">            alert(<span class="string">&quot;RDB: No recent backup with pending changes&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> checks</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage</span></span><br><span class="line">r = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>)</span><br><span class="line">health = check_persistence_health(r)</span><br></pre></td></tr></table></figure>

<h3 id="Backup-Strategy-Implementation"><a href="#Backup-Strategy-Implementation" class="headerlink" title="Backup Strategy Implementation"></a>Backup Strategy Implementation</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Production backup script</span></span><br><span class="line"></span><br><span class="line">REDIS_CLI=<span class="string">&quot;/usr/bin/redis-cli&quot;</span></span><br><span class="line">BACKUP_DIR=<span class="string">&quot;/backup/redis&quot;</span></span><br><span class="line">DATE=$(<span class="built_in">date</span> +%Y%m%d_%H%M%S)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create backup directory</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$BACKUP_DIR</span>/<span class="variable">$DATE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Trigger background save</span></span><br><span class="line"><span class="variable">$REDIS_CLI</span> BGSAVE</span><br><span class="line"></span><br><span class="line"><span class="comment"># Wait for save to complete</span></span><br><span class="line"><span class="keyword">while</span> [ $(<span class="variable">$REDIS_CLI</span> LASTSAVE) -eq <span class="variable">$PREV_SAVE</span> ]; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">sleep</span> 1</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy files</span></span><br><span class="line"><span class="built_in">cp</span> /var/lib/redis/dump.rdb <span class="variable">$BACKUP_DIR</span>/<span class="variable">$DATE</span>/</span><br><span class="line"><span class="built_in">cp</span> /var/lib/redis/appendonly.aof <span class="variable">$BACKUP_DIR</span>/<span class="variable">$DATE</span>/</span><br><span class="line"></span><br><span class="line"><span class="comment"># Compress backup</span></span><br><span class="line">tar -czf <span class="variable">$BACKUP_DIR</span>/redis_backup_<span class="variable">$DATE</span>.tar.gz -C <span class="variable">$BACKUP_DIR</span>/<span class="variable">$DATE</span> .</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Backup completed: redis_backup_<span class="variable">$DATE</span>.tar.gz&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Disaster-Recovery-Procedures"><a href="#Disaster-Recovery-Procedures" class="headerlink" title="Disaster Recovery Procedures"></a>Disaster Recovery Procedures</h2><h3 id="Recovery-from-RDB"><a href="#Recovery-from-RDB" class="headerlink" title="Recovery from RDB"></a>Recovery from RDB</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. Stop Redis service</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl stop redis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Replace dump.rdb file</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> /backup/dump.rdb /var/lib/redis/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Set proper permissions</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span> redis:redis /var/lib/redis/dump.rdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. Start Redis service</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl start redis</span><br></pre></td></tr></table></figure>

<h3 id="Recovery-from-AOF"><a href="#Recovery-from-AOF" class="headerlink" title="Recovery from AOF"></a>Recovery from AOF</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. Check AOF integrity</span></span><br><span class="line">redis-check-aof appendonly.aof</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Fix if corrupted</span></span><br><span class="line">redis-check-aof --fix appendonly.aof</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Replace AOF file and restart Redis</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> /backup/appendonly.aof /var/lib/redis/</span><br><span class="line"><span class="built_in">sudo</span> systemctl restart redis</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Optimization"><a href="#Performance-Optimization" class="headerlink" title="Performance Optimization"></a>Performance Optimization</h2><h3 id="Memory-Optimization"><a href="#Memory-Optimization" class="headerlink" title="Memory Optimization"></a>Memory Optimization</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Optimize for memory usage</span></span><br><span class="line">rdbcompression <span class="built_in">yes</span></span><br><span class="line">rdbchecksum <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># AOF optimization</span></span><br><span class="line">aof-rewrite-incremental-fsync <span class="built_in">yes</span></span><br><span class="line">aof-load-truncated <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>

<h3 id="I-O-Optimization"><a href="#I-O-Optimization" class="headerlink" title="I&#x2F;O Optimization"></a>I&#x2F;O Optimization</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Separate data and AOF on different disks</span></span><br><span class="line"><span class="built_in">dir</span> /data/redis/snapshots/</span><br><span class="line">appenddirname /logs/redis/aof/</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use faster storage for AOF</span></span><br><span class="line"><span class="comment"># SSD recommended for AOF files</span></span><br></pre></td></tr></table></figure>

<h2 id="Common-Issues-and-Troubleshooting"><a href="#Common-Issues-and-Troubleshooting" class="headerlink" title="Common Issues and Troubleshooting"></a>Common Issues and Troubleshooting</h2><h3 id="Fork-Failures"><a href="#Fork-Failures" class="headerlink" title="Fork Failures"></a>Fork Failures</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Monitor fork issues</span></span><br><span class="line">INFO stats | grep fork</span><br><span class="line"></span><br><span class="line"><span class="comment"># Common solutions:</span></span><br><span class="line"><span class="comment"># 1. Increase vm.overcommit_memory</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;vm.overcommit_memory = 1&#x27;</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Monitor memory usage</span></span><br><span class="line"><span class="comment"># 3. Consider using smaller save intervals</span></span><br></pre></td></tr></table></figure>

<h3 id="AOF-Growing-Too-Large"><a href="#AOF-Growing-Too-Large" class="headerlink" title="AOF Growing Too Large"></a>AOF Growing Too Large</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Monitor AOF size</span></span><br><span class="line">INFO persistence | grep aof_current_size</span><br><span class="line"></span><br><span class="line"><span class="comment"># Solutions:</span></span><br><span class="line"><span class="comment"># 1. Adjust rewrite thresholds</span></span><br><span class="line">auto-aof-rewrite-percentage 50</span><br><span class="line">auto-aof-rewrite-min-size 32mb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Manual rewrite during low traffic</span></span><br><span class="line">BGREWRITEAOF</span><br></pre></td></tr></table></figure>

<h2 id="Key-Interview-Questions-and-Answers"><a href="#Key-Interview-Questions-and-Answers" class="headerlink" title="Key Interview Questions and Answers"></a>Key Interview Questions and Answers</h2><p><strong>Q: When would you choose RDB over AOF?</strong><br>A: Choose RDB when you can tolerate some data loss (5-15 minutes) in exchange for better performance, smaller backup files, and faster Redis restarts. Ideal for caching scenarios, analytics data, or when you have other data durability mechanisms.</p>
<p><strong>Q: Explain the AOF rewrite process and why it’s needed.</strong><br>A: AOF files grow indefinitely as they log every write command. Rewrite compacts the file by analyzing the current dataset state and generating the minimum set of commands needed to recreate it. This happens in a child process to avoid blocking the main Redis instance.</p>
<p><strong>Q: What’s the risk of using <code>appendfsync always</code>?</strong><br>A: While it provides maximum durability (virtually zero data loss), it significantly impacts performance as Redis must wait for each write to be committed to disk before acknowledging the client. This can reduce throughput by 100x compared to <code>everysec</code>.</p>
<p><strong>Q: How does hybrid persistence work during recovery?</strong><br>A: Redis first loads the RDB portion (fast bulk recovery), then replays the AOF commands that occurred after the RDB snapshot (recent changes). This provides both fast startup and minimal data loss.</p>
<p><strong>Q: What happens if both RDB and AOF are corrupted?</strong><br>A: Redis will fail to start. You’d need to either fix the files using <code>redis-check-rdb</code> and <code>redis-check-aof</code>, restore from backups, or start with an empty dataset. This highlights the importance of having multiple backup strategies and monitoring persistence health.</p>
<h2 id="Best-Practices-Summary"><a href="#Best-Practices-Summary" class="headerlink" title="Best Practices Summary"></a>Best Practices Summary</h2><ol>
<li><strong>Use Hybrid Mode</strong> for production systems requiring both performance and durability</li>
<li><strong>Monitor Persistence Health</strong> with automated alerts for failed saves or growing files</li>
<li><strong>Implement Regular Backups</strong> with both local and remote storage</li>
<li><strong>Test Recovery Procedures</strong> regularly in non-production environments</li>
<li><strong>Size Your Infrastructure</strong> appropriately for fork operations and I&#x2F;O requirements</li>
<li><strong>Separate Storage</strong> for RDB snapshots and AOF files when possible</li>
<li><strong>Tune Based on Use Case</strong>: More frequent saves for critical data, less frequent for cache-only scenarios</li>
</ol>
<p>Understanding Redis persistence mechanisms is crucial for building reliable systems. The choice between RDB, AOF, or hybrid mode should align with your application’s durability requirements, performance constraints, and operational capabilities.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/17/Java-Virtual-Machine-Memory-Structure-Complete-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/17/Java-Virtual-Machine-Memory-Structure-Complete-Guide/" class="post-title-link" itemprop="url">Java Virtual Machine Memory Structure - Complete Guide</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-17 18:56:24 / Modified: 20:26:28" itemprop="dateCreated datePublished" datetime="2025-06-17T18:56:24+08:00">2025-06-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="JVM-Architecture-Overview"><a href="#JVM-Architecture-Overview" class="headerlink" title="JVM Architecture Overview"></a>JVM Architecture Overview</h2><p>The Java Virtual Machine (JVM) is a runtime environment that executes Java bytecode. Understanding its memory structure is crucial for writing efficient, scalable applications and troubleshooting performance issues in production environments.</p>
<pre>
<code class="mermaid">
graph TB
A[Java Source Code] --&gt; B[javac Compiler]
B --&gt; C[Bytecode .class files]
C --&gt; D[Class Loader Subsystem]
D --&gt; E[Runtime Data Areas]
D --&gt; F[Execution Engine]
E --&gt; G[Method Area]
E --&gt; H[Heap Memory]
E --&gt; I[Stack Memory]
E --&gt; J[PC Registers]
E --&gt; K[Native Method Stacks]
F --&gt; L[Interpreter]
F --&gt; M[JIT Compiler]
F --&gt; N[Garbage Collector]
</code>
</pre>

<h3 id="Core-JVM-Components"><a href="#Core-JVM-Components" class="headerlink" title="Core JVM Components"></a>Core JVM Components</h3><p>The JVM consists of three main subsystems that work together:</p>
<p><strong>Class Loader Subsystem</strong>: Responsible for loading, linking, and initializing classes dynamically at runtime. This subsystem implements the crucial parent delegation model that ensures class uniqueness and security.</p>
<p><strong>Runtime Data Areas</strong>: Memory regions where the JVM stores various types of data during program execution. These include heap memory for objects, method area for class metadata, stack memory for method calls, and other specialized regions.</p>
<p><strong>Execution Engine</strong>: Converts bytecode into machine code through interpretation and Just-In-Time (JIT) compilation. It also manages garbage collection to reclaim unused memory.</p>
<p><strong>Interview Insight</strong>: <em>A common question is “Explain how JVM components interact when executing a Java program.” Be prepared to walk through the complete flow from source code to execution.</em></p>
<hr>
<h2 id="Class-Loader-Subsystem-Deep-Dive"><a href="#Class-Loader-Subsystem-Deep-Dive" class="headerlink" title="Class Loader Subsystem Deep Dive"></a>Class Loader Subsystem Deep Dive</h2><h3 id="Class-Loader-Hierarchy-and-Types"><a href="#Class-Loader-Hierarchy-and-Types" class="headerlink" title="Class Loader Hierarchy and Types"></a>Class Loader Hierarchy and Types</h3><p>The class loading mechanism follows a hierarchical structure with three built-in class loaders:</p>
<pre>
<code class="mermaid">
graph TD
A[Bootstrap Class Loader] --&gt; B[Extension Class Loader]
B --&gt; C[Application Class Loader]
C --&gt; D[Custom Class Loaders]

A1[rt.jar, core JDK classes] --&gt; A
B1[ext directory, JAVA_HOME&#x2F;lib&#x2F;ext] --&gt; B
C1[Classpath, application classes] --&gt; C
D1[Web apps, plugins, frameworks] --&gt; D
</code>
</pre>

<p><strong>Bootstrap Class Loader (Primordial)</strong>:</p>
<ul>
<li>Written in native code (C&#x2F;C++)</li>
<li>Loads core Java classes from <code>rt.jar</code> and other core JDK libraries</li>
<li>Parent of all other class loaders</li>
<li>Cannot be instantiated in Java code</li>
</ul>
<p><strong>Extension Class Loader (Platform)</strong>:</p>
<ul>
<li>Loads classes from extension directories (<code>JAVA_HOME/lib/ext</code>)</li>
<li>Implements standard extensions to the Java platform</li>
<li>Child of Bootstrap Class Loader</li>
</ul>
<p><strong>Application Class Loader (System)</strong>:</p>
<ul>
<li>Loads classes from the application classpath</li>
<li>Most commonly used class loader</li>
<li>Child of Extension Class Loader</li>
</ul>
<h3 id="Parent-Delegation-Model"><a href="#Parent-Delegation-Model" class="headerlink" title="Parent Delegation Model"></a>Parent Delegation Model</h3><p>The parent delegation model is a security and consistency mechanism that ensures classes are loaded predictably.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Simplified implementation of parent delegation</span></span><br><span class="line"><span class="keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// First, check if the class has already been loaded</span></span><br><span class="line">    Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (parent != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Delegate to parent class loader</span></span><br><span class="line">                c = parent.loadClass(name);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Use bootstrap class loader</span></span><br><span class="line">                c = findBootstrapClassOrNull(name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="comment">// Parent failed to load class</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (c == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Find the class ourselves</span></span><br><span class="line">            c = findClass(name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Key Benefits of Parent Delegation</strong>:</p>
<ol>
<li><strong>Security</strong>: Prevents malicious code from replacing core Java classes</li>
<li><strong>Consistency</strong>: Ensures the same class is not loaded multiple times</li>
<li><strong>Namespace Isolation</strong>: Different class loaders can load classes with the same name</li>
</ol>
<p><strong>Interview Insight</strong>: <em>Understand why <code>java.lang.String</code> cannot be overridden even if you create your own String class in the default package.</em></p>
<h3 id="Class-Loading-Process-The-Five-Phases"><a href="#Class-Loading-Process-The-Five-Phases" class="headerlink" title="Class Loading Process - The Five Phases"></a>Class Loading Process - The Five Phases</h3><pre>
<code class="mermaid">
flowchart LR
A[Loading] --&gt; B[Verification]
B --&gt; C[Preparation]
C --&gt; D[Resolution]
D --&gt; E[Initialization]

A1[Find and load .class file] --&gt; A
B1[Verify bytecode integrity] --&gt; B
C1[Allocate memory for static variables] --&gt; C
D1[Resolve symbolic references] --&gt; D
E1[Execute static initializers] --&gt; E
</code>
</pre>

<h4 id="Loading-Phase"><a href="#Loading-Phase" class="headerlink" title="Loading Phase"></a>Loading Phase</h4><p>The JVM locates and reads the <code>.class</code> file, creating a binary representation in memory.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassLoadingExample</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Class is being loaded and initialized&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONSTANT</span> <span class="operator">=</span> <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">incrementCounter</span><span class="params">()</span> &#123;</span><br><span class="line">        counter++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Verification-Phase"><a href="#Verification-Phase" class="headerlink" title="Verification Phase"></a>Verification Phase</h4><p>The JVM verifies that the bytecode is valid and doesn’t violate security constraints:</p>
<ul>
<li><strong>File format verification</strong>: Ensures proper <code>.class</code> file structure</li>
<li><strong>Metadata verification</strong>: Validates class hierarchy and access modifiers</li>
<li><strong>Bytecode verification</strong>: Ensures operations are type-safe</li>
<li><strong>Symbolic reference verification</strong>: Validates method and field references</li>
</ul>
<h4 id="Preparation-Phase"><a href="#Preparation-Phase" class="headerlink" title="Preparation Phase"></a>Preparation Phase</h4><p>Memory is allocated for class-level (static) variables and initialized with default values:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PreparationExample</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> number;        <span class="comment">// Initialized to 0</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> flag;      <span class="comment">// Initialized to false</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String text;       <span class="comment">// Initialized to null</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CONSTANT</span> <span class="operator">=</span> <span class="number">100</span>; <span class="comment">// Initialized to 100 (final)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Resolution-Phase"><a href="#Resolution-Phase" class="headerlink" title="Resolution Phase"></a>Resolution Phase</h4><p>Symbolic references in the constant pool are replaced with direct references:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResolutionExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">methodA</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Symbolic reference to methodB is resolved to a direct reference</span></span><br><span class="line">        methodB();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">methodB</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Method B executed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Initialization-Phase"><a href="#Initialization-Phase" class="headerlink" title="Initialization Phase"></a>Initialization Phase</h4><p>Static initializers and static variable assignments are executed:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InitializationExample</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> initializeValue(); <span class="comment">// Called during initialization</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Static block executed&quot;</span>);</span><br><span class="line">        value += <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">initializeValue</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Static method called&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Be able to explain the difference between class loading and class initialization, and when each phase occurs.</em></p>
<hr>
<h2 id="Runtime-Data-Areas"><a href="#Runtime-Data-Areas" class="headerlink" title="Runtime Data Areas"></a>Runtime Data Areas</h2><p>The JVM organizes memory into distinct regions, each serving specific purposes during program execution.</p>
<pre>
<code class="mermaid">
graph TB
subgraph &quot;JVM Memory Structure&quot;
    subgraph &quot;Shared Among All Threads&quot;
        A[Method Area]
        B[Heap Memory]
        A1[Class metadata, Constants, Static variables] --&gt; A
        B1[Objects, Instance variables, Arrays] --&gt; B
    end
    
    subgraph &quot;Per Thread&quot;
        C[JVM Stack]
        D[PC Register]
        E[Native Method Stack]
        C1[Method frames, Local variables, Operand stack] --&gt; C
        D1[Current executing instruction address] --&gt; D
        E1[Native method calls] --&gt; E
    end
end
</code>
</pre>

<h3 id="Method-Area-Metaspace-in-Java-8"><a href="#Method-Area-Metaspace-in-Java-8" class="headerlink" title="Method Area (Metaspace in Java 8+)"></a>Method Area (Metaspace in Java 8+)</h3><p>The Method Area stores class-level information shared across all threads:</p>
<p><strong>Contents</strong>:</p>
<ul>
<li>Class metadata and structure information</li>
<li>Method bytecode</li>
<li>Constant pool</li>
<li>Static variables</li>
<li>Runtime constant pool</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MethodAreaExample</span> &#123;</span><br><span class="line">    <span class="comment">// Stored in Method Area</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONSTANT</span> <span class="operator">=</span> <span class="string">&quot;Stored in constant pool&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">staticVariable</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Method bytecode stored in Method Area</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">instanceMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Method implementation</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">staticMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Static method implementation</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Production Best Practice</strong>: Monitor Metaspace usage in Java 8+ applications, as it can lead to <code>OutOfMemoryError: Metaspace</code> if too many classes are loaded dynamically.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># JVM flags for Metaspace tuning</span></span><br><span class="line">-XX:MetaspaceSize=256m</span><br><span class="line">-XX:MaxMetaspaceSize=512m</span><br><span class="line">-XX:+UseCompressedOops</span><br></pre></td></tr></table></figure>

<h3 id="Heap-Memory-Structure"><a href="#Heap-Memory-Structure" class="headerlink" title="Heap Memory Structure"></a>Heap Memory Structure</h3><p>The heap is where all objects and instance variables are stored. Modern JVMs typically implement generational garbage collection.</p>
<pre>
<code class="mermaid">
graph TB
subgraph &quot;Heap Memory&quot;
    subgraph &quot;Young Generation&quot;
        A[Eden Space]
        B[Survivor Space 0]
        C[Survivor Space 1]
    end
    
    subgraph &quot;Old Generation&quot;
        D[Tenured Space]
    end
    
    E[Permanent Generation &#x2F; Metaspace]
end

F[New Objects] --&gt; A
A --&gt; |GC| B
B --&gt; |GC| C
C --&gt; |Long-lived objects| D
</code>
</pre>

<p><strong>Object Lifecycle Example</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HeapMemoryExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// Objects created in Eden space</span></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// These objects may survive minor GC and move to Survivor space</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            list.add(<span class="string">&quot;String &quot;</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Long-lived objects eventually move to Old Generation</span></span><br><span class="line">        staticReference = list; <span class="comment">// This reference keeps the list alive</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; staticReference;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Production Tuning Example</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Heap size configuration</span></span><br><span class="line">-Xms2g -Xmx4g</span><br><span class="line"><span class="comment"># Young generation sizing</span></span><br><span class="line">-XX:NewRatio=3</span><br><span class="line">-XX:SurvivorRatio=8</span><br><span class="line"><span class="comment"># GC algorithm selection</span></span><br><span class="line">-XX:+UseG1GC</span><br><span class="line">-XX:MaxGCPauseMillis=200</span><br></pre></td></tr></table></figure>

<h3 id="JVM-Stack-Thread-Stack"><a href="#JVM-Stack-Thread-Stack" class="headerlink" title="JVM Stack (Thread Stack)"></a>JVM Stack (Thread Stack)</h3><p>Each thread has its own stack containing method call frames.</p>
<pre>
<code class="mermaid">
graph TB
subgraph &quot;Thread Stack&quot;
    A[Method Frame 3 - currentMethod]
    B[Method Frame 2 - callerMethod]
    C[Method Frame 1 - main]
end

subgraph &quot;Method Frame Structure&quot;
    D[Local Variables Array]
    E[Operand Stack]
    F[Frame Data]
end

A --&gt; D
A --&gt; E
A --&gt; F
</code>
</pre>

<p><strong>Stack Frame Components</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StackExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123; <span class="comment">// Frame 1</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">mainVar</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">        methodA(mainVar);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">methodA</span><span class="params">(<span class="type">int</span> param)</span> &#123; <span class="comment">// Frame 2</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">localVar</span> <span class="operator">=</span> param * <span class="number">2</span>;</span><br><span class="line">        methodB(localVar);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">methodB</span><span class="params">(<span class="type">int</span> value)</span> &#123; <span class="comment">// Frame 3</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Value: &quot;</span> + value);</span><br><span class="line">        <span class="comment">// Stack trace shows: methodB -&gt; methodA -&gt; main</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Understand how method calls create stack frames and how local variables are stored versus instance variables in the heap.</em></p>
<hr>
<h2 id="Breaking-Parent-Delegation-Advanced-Scenarios"><a href="#Breaking-Parent-Delegation-Advanced-Scenarios" class="headerlink" title="Breaking Parent Delegation - Advanced Scenarios"></a>Breaking Parent Delegation - Advanced Scenarios</h2><h3 id="When-and-Why-to-Break-Parent-Delegation"><a href="#When-and-Why-to-Break-Parent-Delegation" class="headerlink" title="When and Why to Break Parent Delegation"></a>When and Why to Break Parent Delegation</h3><p>While parent delegation is generally beneficial, certain scenarios require custom class loading strategies:</p>
<ol>
<li><strong>Web Application Containers</strong> (Tomcat, Jetty)</li>
<li><strong>Plugin Architectures</strong> </li>
<li><strong>Hot Deployment</strong> scenarios</li>
<li><strong>Framework Isolation</strong> requirements</li>
</ol>
<h3 id="Tomcat’s-Class-Loading-Architecture"><a href="#Tomcat’s-Class-Loading-Architecture" class="headerlink" title="Tomcat’s Class Loading Architecture"></a>Tomcat’s Class Loading Architecture</h3><p>Tomcat implements a sophisticated class loading hierarchy to support multiple web applications with potentially conflicting dependencies.</p>
<pre>
<code class="mermaid">
graph TB
A[Bootstrap] --&gt; B[System]
B --&gt; C[Common]
C --&gt; D[Catalina]
C --&gt; E[Shared]
E --&gt; F[WebApp1]
E --&gt; G[WebApp2]

A1[JDK core classes] --&gt; A
B1[JVM system classes] --&gt; B
C1[Tomcat common classes] --&gt; C
D1[Tomcat internal classes] --&gt; D
E1[Shared libraries] --&gt; E
F1[Application 1 classes] --&gt; F
G1[Application 2 classes] --&gt; G
</code>
</pre>

<p><strong>Tomcat’s Modified Delegation Model</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebappClassLoader</span> <span class="keyword">extends</span> <span class="title class_">URLClassLoader</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">return</span> loadClass(name, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; loadClass(String name, <span class="type">boolean</span> resolve) </span><br><span class="line">            <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        </span><br><span class="line">        Class&lt;?&gt; clazz = <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. Check the local cache first</span></span><br><span class="line">        clazz = findLoadedClass(name);</span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. Check if the class should be loaded by the parent (system classes)</span></span><br><span class="line">        <span class="keyword">if</span> (isSystemClass(name)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.loadClass(name, resolve);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. Try to load from the web application first (breaking delegation!)</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clazz = findClass(name);</span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="comment">// Fall through to parent delegation</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. Delegate to the parent as a last resort</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.loadClass(name, resolve);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Custom-Class-Loader-Implementation"><a href="#Custom-Class-Loader-Implementation" class="headerlink" title="Custom Class Loader Implementation"></a>Custom Class Loader Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomClassLoader</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String classPath;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomClassLoader</span><span class="params">(String classPath, ClassLoader parent)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(parent);</span><br><span class="line">        <span class="built_in">this</span>.classPath = classPath;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[] classData = loadClassData(name);</span><br><span class="line">            <span class="keyword">return</span> defineClass(name, classData, <span class="number">0</span>, classData.length);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(<span class="string">&quot;Could not load class &quot;</span> + name, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>[] loadClassData(String className) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> className.replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>) + <span class="string">&quot;.class&quot;</span>;</span><br><span class="line">        <span class="type">Path</span> <span class="variable">filePath</span> <span class="operator">=</span> Paths.get(classPath, fileName);</span><br><span class="line">        <span class="keyword">return</span> Files.readAllBytes(filePath);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Usage example</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomClassLoaderExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">CustomClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomClassLoader</span>(<span class="string">&quot;/custom/classes&quot;</span>, </span><br><span class="line">            ClassLoader.getSystemClassLoader());</span><br><span class="line">        </span><br><span class="line">        Class&lt;?&gt; customClass = loader.loadClass(<span class="string">&quot;com.example.CustomPlugin&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> customClass.getDeclaredConstructor().newInstance();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Use reflection to invoke methods</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> customClass.getMethod(<span class="string">&quot;execute&quot;</span>);</span><br><span class="line">        method.invoke(instance);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Hot-Deployment-Implementation"><a href="#Hot-Deployment-Implementation" class="headerlink" title="Hot Deployment Implementation"></a>Hot Deployment Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HotDeploymentManager</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, CustomClassLoader&gt; classLoaders = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileWatcher fileWatcher;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HotDeploymentManager</span><span class="params">(String watchDirectory)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.fileWatcher = <span class="keyword">new</span> <span class="title class_">FileWatcher</span>(watchDirectory, <span class="built_in">this</span>::onFileChanged);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">onFileChanged</span><span class="params">(Path changedFile)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> extractClassName(changedFile);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Create a new class loader for the updated class</span></span><br><span class="line">        <span class="type">CustomClassLoader</span> <span class="variable">newLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomClassLoader</span>(</span><br><span class="line">            changedFile.getParent().toString(),</span><br><span class="line">            getClass().getClassLoader()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Replace old class loader</span></span><br><span class="line">        <span class="type">CustomClassLoader</span> <span class="variable">oldLoader</span> <span class="operator">=</span> classLoaders.put(className, newLoader);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Cleanup old loader (if possible)</span></span><br><span class="line">        <span class="keyword">if</span> (oldLoader != <span class="literal">null</span>) &#123;</span><br><span class="line">            cleanup(oldLoader);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;Reloaded class: &quot;</span> + className);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">createInstance</span><span class="params">(String className)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">CustomClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> classLoaders.get(className);</span><br><span class="line">        <span class="keyword">if</span> (loader == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(<span class="string">&quot;Class not found: &quot;</span> + className);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        Class&lt;?&gt; clazz = loader.loadClass(className);</span><br><span class="line">        <span class="keyword">return</span> clazz.getDeclaredConstructor().newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Be prepared to explain why Tomcat needs to break parent delegation and how it maintains isolation between web applications.</em></p>
<hr>
<h2 id="Memory-Management-Best-Practices"><a href="#Memory-Management-Best-Practices" class="headerlink" title="Memory Management Best Practices"></a>Memory Management Best Practices</h2><h3 id="Monitoring-and-Tuning"><a href="#Monitoring-and-Tuning" class="headerlink" title="Monitoring and Tuning"></a>Monitoring and Tuning</h3><p><strong>Essential JVM Flags for Production</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Memory sizing</span></span><br><span class="line">-Xms4g -Xmx4g                    <span class="comment"># Set initial and maximum heap size</span></span><br><span class="line">-XX:NewRatio=3                   <span class="comment"># Old:Young generation ratio</span></span><br><span class="line">-XX:SurvivorRatio=8              <span class="comment"># Eden:Survivor ratio</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Garbage Collection</span></span><br><span class="line">-XX:+UseG1GC                     <span class="comment"># Use G1 garbage collector</span></span><br><span class="line">-XX:MaxGCPauseMillis=200         <span class="comment"># Target max GC pause time</span></span><br><span class="line">-XX:G1HeapRegionSize=16m         <span class="comment"># G1 region size</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Metaspace (Java 8+)</span></span><br><span class="line">-XX:MetaspaceSize=256m           <span class="comment"># Initial metaspace size</span></span><br><span class="line">-XX:MaxMetaspaceSize=512m        <span class="comment"># Maximum metaspace size</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Monitoring and Debugging</span></span><br><span class="line">-XX:+PrintGC                     <span class="comment"># Print GC information</span></span><br><span class="line">-XX:+PrintGCDetails              <span class="comment"># Detailed GC information</span></span><br><span class="line">-XX:+PrintGCTimeStamps           <span class="comment"># GC timestamps</span></span><br><span class="line">-XX:+HeapDumpOnOutOfMemoryError  <span class="comment"># Generate heap dump on OOM</span></span><br><span class="line">-XX:HeapDumpPath=/path/to/dumps  <span class="comment"># Heap dump location</span></span><br></pre></td></tr></table></figure>

<h3 id="Memory-Leak-Detection"><a href="#Memory-Leak-Detection" class="headerlink" title="Memory Leak Detection"></a>Memory Leak Detection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemoryLeakExample</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;Object&gt; STATIC_LIST = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Memory leak: objects added to static collection never removed</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addToStaticCollection</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">        STATIC_LIST.add(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Proper implementation with cleanup</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; cache = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addToCache</span><span class="params">(String key, Object value)</span> &#123;</span><br><span class="line">        cache.put(key, value);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Implement cache eviction policy</span></span><br><span class="line">        <span class="keyword">if</span> (cache.size() &gt; MAX_CACHE_SIZE) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">oldestKey</span> <span class="operator">=</span> findOldestKey();</span><br><span class="line">            cache.remove(oldestKey);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Thread-Safety-in-Class-Loading"><a href="#Thread-Safety-in-Class-Loading" class="headerlink" title="Thread Safety in Class Loading"></a>Thread Safety in Class Loading</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadSafeClassLoader</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, Class&lt;?&gt;&gt; classCache = </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="type">boolean</span> resolve) </span><br><span class="line">            <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Thread-safe class loading with double-checked locking</span></span><br><span class="line">        Class&lt;?&gt; clazz = classCache.get(name);</span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class="line">                clazz = classCache.get(name);</span><br><span class="line">                <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">                    clazz = <span class="built_in">super</span>.loadClass(name, resolve);</span><br><span class="line">                    classCache.put(name, clazz);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Common-Interview-Questions-and-Answers"><a href="#Common-Interview-Questions-and-Answers" class="headerlink" title="Common Interview Questions and Answers"></a>Common Interview Questions and Answers</h2><h3 id="Memory-Related-Questions"><a href="#Memory-Related-Questions" class="headerlink" title="Memory-Related Questions"></a>Memory-Related Questions</h3><p><strong>Q: Explain the difference between stack and heap memory.</strong></p>
<p>A: Stack memory is thread-specific and stores method call frames with local variables and partial results. It follows the LIFO principle and has fast allocation&#x2F;deallocation. Heap memory is shared among all threads and stores objects and instance variables. It’s managed by garbage collection and has slower allocation, but supports dynamic sizing.</p>
<p><strong>Q: What happens when you get OutOfMemoryError?</strong></p>
<p>A: An OutOfMemoryError can occur in different memory areas:</p>
<ul>
<li><strong>Heap</strong>: Too many objects, increase <code>-Xmx</code> or optimize object lifecycle</li>
<li><strong>Metaspace</strong>: Too many classes loaded, increase <code>-XX:MaxMetaspaceSize</code></li>
<li><strong>Stack</strong>: Deep recursion, increase <code>-Xss</code> or fix recursive logic</li>
<li><strong>Direct Memory</strong>: NIO operations, tune <code>-XX:MaxDirectMemorySize</code></li>
</ul>
<h3 id="Class-Loading-Questions"><a href="#Class-Loading-Questions" class="headerlink" title="Class Loading Questions"></a>Class Loading Questions</h3><p><strong>Q: Can you override java.lang.String class?</strong></p>
<p>A: No, due to the parent delegation model. The Bootstrap class loader always loads <code>java.lang.String</code> from <code>rt.jar</code> first, preventing any custom String class from being loaded.</p>
<p><strong>Q: How does Tomcat isolate different web applications?</strong></p>
<p>A: Tomcat uses separate WebAppClassLoader instances for each web application and modifies the parent delegation model to load application-specific classes first, enabling different versions of the same library in different applications.</p>
<hr>
<h2 id="Advanced-Topics-and-Production-Insights"><a href="#Advanced-Topics-and-Production-Insights" class="headerlink" title="Advanced Topics and Production Insights"></a>Advanced Topics and Production Insights</h2><h3 id="Class-Unloading"><a href="#Class-Unloading" class="headerlink" title="Class Unloading"></a>Class Unloading</h3><p>Classes can be unloaded when their class loader becomes unreachable and eligible for garbage collection:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassUnloadingExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">demonstrateClassUnloading</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// Create custom class loader</span></span><br><span class="line">        <span class="type">URLClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URLClassLoader</span>(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">URL</span>[]&#123;<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;custom-classes/&quot;</span>).toURI().toURL()&#125;</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Load class using custom loader</span></span><br><span class="line">        Class&lt;?&gt; clazz = loader.loadClass(<span class="string">&quot;com.example.CustomClass&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> clazz.getDeclaredConstructor().newInstance();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Use the instance</span></span><br><span class="line">        clazz.getMethod(<span class="string">&quot;doSomething&quot;</span>).invoke(instance);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Clear references</span></span><br><span class="line">        instance = <span class="literal">null</span>;</span><br><span class="line">        clazz = <span class="literal">null</span>;</span><br><span class="line">        loader.close();</span><br><span class="line">        loader = <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Force garbage collection</span></span><br><span class="line">        System.gc();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Class may be unloaded if no other references exist</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Performance-Optimization-Tips"><a href="#Performance-Optimization-Tips" class="headerlink" title="Performance Optimization Tips"></a>Performance Optimization Tips</h3><ol>
<li><strong>Minimize Class Loading</strong>: Reduce the number of classes loaded at startup</li>
<li><strong>Optimize Class Path</strong>: Keep class path short and organized</li>
<li><strong>Use Appropriate GC</strong>: Choose GC algorithm based on application needs</li>
<li><strong>Monitor Memory Usage</strong>: Use tools like JVisualVM, JProfiler, or APM solutions</li>
<li><strong>Implement Proper Caching</strong>: Cache frequently used objects appropriately</li>
</ol>
<h3 id="Production-Monitoring"><a href="#Production-Monitoring" class="headerlink" title="Production Monitoring"></a>Production Monitoring</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JMX bean for monitoring class loading</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassLoadingMonitor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClassLoadingMXBean classLoadingBean;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MemoryMXBean memoryBean;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ClassLoadingMonitor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.classLoadingBean = ManagementFactory.getClassLoadingMXBean();</span><br><span class="line">        <span class="built_in">this</span>.memoryBean = ManagementFactory.getMemoryMXBean();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">printClassLoadingStats</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Loaded Classes: &quot;</span> + classLoadingBean.getLoadedClassCount());</span><br><span class="line">        System.out.println(<span class="string">&quot;Total Loaded: &quot;</span> + classLoadingBean.getTotalLoadedClassCount());</span><br><span class="line">        System.out.println(<span class="string">&quot;Unloaded Classes: &quot;</span> + classLoadingBean.getUnloadedClassCount());</span><br><span class="line">        </span><br><span class="line">        <span class="type">MemoryUsage</span> <span class="variable">heapUsage</span> <span class="operator">=</span> memoryBean.getHeapMemoryUsage();</span><br><span class="line">        System.out.println(<span class="string">&quot;Heap Used: &quot;</span> + heapUsage.getUsed() / (<span class="number">1024</span> * <span class="number">1024</span>) + <span class="string">&quot; MB&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Heap Max: &quot;</span> + heapUsage.getMax() / (<span class="number">1024</span> * <span class="number">1024</span>) + <span class="string">&quot; MB&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This comprehensive guide covers the essential aspects of JVM memory structure, from basic concepts to advanced production scenarios. Understanding these concepts is crucial for developing efficient Java applications and troubleshooting performance issues in production environments.</p>
<h2 id="Essential-Tools-and-Commands"><a href="#Essential-Tools-and-Commands" class="headerlink" title="Essential Tools and Commands"></a>Essential Tools and Commands</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Memory analysis tools</span></span><br><span class="line">jmap -dump:live,format=b,file=heap.hprof &lt;pid&gt;</span><br><span class="line">jhat heap.hprof  <span class="comment"># Heap analysis tool</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Class loading monitoring</span></span><br><span class="line">jstat -class &lt;pid&gt; 1s  <span class="comment"># Monitor class loading every second</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Garbage collection monitoring</span></span><br><span class="line">jstat -gc &lt;pid&gt; 1s     <span class="comment"># Monitor GC activity</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># JVM process information</span></span><br><span class="line">jps -v                 <span class="comment"># List JVM processes with arguments</span></span><br><span class="line">jinfo &lt;pid&gt;           <span class="comment"># Print JVM configuration</span></span><br></pre></td></tr></table></figure>

<h2 id="References-and-Further-Reading"><a href="#References-and-Further-Reading" class="headerlink" title="References and Further Reading"></a>References and Further Reading</h2><ul>
<li><strong>Oracle JVM Specification</strong>: Comprehensive technical documentation</li>
<li><strong>Java Performance: The Definitive Guide</strong> by Scott Oaks</li>
<li><strong>Effective Java</strong> by Joshua Bloch - Best practices for memory management</li>
<li><strong>G1GC Documentation</strong>: For modern garbage collection strategies</li>
<li><strong>JProfiler&#x2F;VisualVM</strong>: Professional memory profiling tools</li>
</ul>
<p>Understanding JVM memory structure is fundamental for Java developers, especially for performance tuning, debugging memory issues, and building scalable applications. Regular monitoring and profiling should be part of your development workflow to ensure optimal application performance.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/17/Elasticsearch-Query-Performance-Optimization-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/17/Elasticsearch-Query-Performance-Optimization-Guide/" class="post-title-link" itemprop="url">Elasticsearch Query Performance Optimization Guide</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-17 17:10:10 / Modified: 17:11:28" itemprop="dateCreated datePublished" datetime="2025-06-17T17:10:10+08:00">2025-06-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/elasticsearch/" itemprop="url" rel="index"><span itemprop="name">elasticsearch</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="System-Level-Optimizations"><a href="#System-Level-Optimizations" class="headerlink" title="System-Level Optimizations"></a>System-Level Optimizations</h2><h3 id="Garbage-Collection-GC-Tuning"><a href="#Garbage-Collection-GC-Tuning" class="headerlink" title="Garbage Collection (GC) Tuning"></a>Garbage Collection (GC) Tuning</h3><p>Elasticsearch relies heavily on the JVM, making GC performance critical for query response times. Poor GC configuration can lead to query timeouts and cluster instability.</p>
<p><strong>Production Best Practices:</strong></p>
<ul>
<li>Use G1GC for heaps larger than 6GB: <code>-XX:+UseG1GC</code></li>
<li>Set heap size to 50% of available RAM, but never exceed 32GB</li>
<li>Configure GC logging for monitoring: <code>-Xloggc:gc.log -XX:+PrintGCDetails</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Optimal JVM settings for production</span></span><br><span class="line">ES_JAVA_OPTS=<span class="string">&quot;-Xms16g -Xmx16g -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+PrintGC -XX:+PrintGCTimeStamps&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight:</strong> <em>“Why is 32GB the heap size limit?”</em> - Beyond 32GB, the JVM loses compressed OOPs (Ordinary Object Pointers), effectively doubling pointer sizes and reducing cache efficiency.</p>
<h3 id="Memory-Management-and-Swappiness"><a href="#Memory-Management-and-Swappiness" class="headerlink" title="Memory Management and Swappiness"></a>Memory Management and Swappiness</h3><p>Swapping to disk can destroy Elasticsearch performance, turning millisecond operations into second-long delays.</p>
<p><strong>Configuration Steps:</strong></p>
<ol>
<li>Disable swap entirely: <code>sudo swapoff -a</code></li>
<li>Configure swappiness: <code>vm.swappiness=1</code></li>
<li>Enable memory locking in Elasticsearch:</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># elasticsearch.yml</span></span><br><span class="line"><span class="attr">bootstrap.memory_lock:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p><strong>Production Example:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/sysctl.conf</span></span><br><span class="line">vm.swappiness=1</span><br><span class="line">vm.max_map_count=262144</span><br><span class="line"></span><br><span class="line"><span class="comment"># Verify settings</span></span><br><span class="line">sysctl vm.swappiness</span><br><span class="line">sysctl vm.max_map_count</span><br></pre></td></tr></table></figure>

<h3 id="File-Descriptors-Optimization"><a href="#File-Descriptors-Optimization" class="headerlink" title="File Descriptors Optimization"></a>File Descriptors Optimization</h3><p>Elasticsearch requires numerous file descriptors for index files, network connections, and internal operations.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/security/limits.conf</span></span><br><span class="line">elasticsearch soft nofile 65536</span><br><span class="line">elasticsearch hard nofile 65536</span><br><span class="line">elasticsearch soft <span class="built_in">nproc</span> 4096</span><br><span class="line">elasticsearch hard <span class="built_in">nproc</span> 4096</span><br><span class="line"></span><br><span class="line"><span class="comment"># Verify current limits</span></span><br><span class="line"><span class="built_in">ulimit</span> -n</span><br><span class="line"><span class="built_in">ulimit</span> -u</span><br></pre></td></tr></table></figure>

<p><strong>Monitoring Script:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Check file descriptor usage</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Current FD usage: <span class="subst">$(lsof -u elasticsearch | wc -l)</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;FD limit: <span class="subst">$(ulimit -n)</span>&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Query-Optimization-Strategies"><a href="#Query-Optimization-Strategies" class="headerlink" title="Query Optimization Strategies"></a>Query Optimization Strategies</h2><h3 id="Pagination-Performance"><a href="#Pagination-Performance" class="headerlink" title="Pagination Performance"></a>Pagination Performance</h3><p>Deep pagination is one of the most common performance bottlenecks in Elasticsearch applications.</p>
<h4 id="Problem-with-Traditional-Pagination"><a href="#Problem-with-Traditional-Pagination" class="headerlink" title="Problem with Traditional Pagination"></a>Problem with Traditional Pagination</h4><pre>
<code class="mermaid">
graph
A[Client Request: from&#x3D;10000, size&#x3D;10] --&gt; B[Elasticsearch Coordinator]
B --&gt; C[Shard 1: Fetch 10010 docs]
B --&gt; D[Shard 2: Fetch 10010 docs]
B --&gt; E[Shard 3: Fetch 10010 docs]
C --&gt; F[Coordinator: Sort 30030 docs]
D --&gt; F
E --&gt; F
F --&gt; G[Return 10 docs to client]
</code>
</pre>

<h4 id="Solution-1-Scroll-API"><a href="#Solution-1-Scroll-API" class="headerlink" title="Solution 1: Scroll API"></a>Solution 1: Scroll API</h4><p>Best for processing large datasets sequentially:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># Initial scroll request</span><br><span class="line">POST /my_index/_search?scroll=<span class="number">1</span>m</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"># Subsequent scroll requests</span><br><span class="line">POST /_search/scroll</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;scroll&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1m&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;scroll_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your_scroll_id_here&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Production Use Case:</strong> Log processing pipeline handling millions of documents daily.</p>
<h4 id="Solution-2-Search-After-API"><a href="#Solution-2-Search-After-API" class="headerlink" title="Solution 2: Search After API"></a>Solution 2: Search After API</h4><p>Ideal for real-time pagination with live data:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># First request</span><br><span class="line">GET /my_index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;elasticsearch&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"># Next page using search_after</span><br><span class="line">GET /my_index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;elasticsearch&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;search_after&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;2023-10-01T10:00:00Z&quot;</span><span class="punctuation">,</span> <span class="string">&quot;doc_id_123&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight:</strong> <em>“When would you choose search_after over scroll?”</em> - Search_after is stateless and handles live data changes better, while scroll is more efficient for complete dataset processing.</p>
<h3 id="Bulk-Operations-Optimization"><a href="#Bulk-Operations-Optimization" class="headerlink" title="Bulk Operations Optimization"></a>Bulk Operations Optimization</h3><p>The <code>_bulk</code> API significantly reduces network overhead and improves indexing performance.</p>
<h4 id="Bulk-API-Best-Practices"><a href="#Bulk-API-Best-Practices" class="headerlink" title="Bulk API Best Practices"></a>Bulk API Best Practices</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_index&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Document 1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Content here&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_index&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Document 2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;More content&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;update&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_index&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;doc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;updated&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;delete&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_index&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Production Implementation:</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> elasticsearch <span class="keyword">import</span> Elasticsearch</span><br><span class="line"><span class="keyword">from</span> elasticsearch.helpers <span class="keyword">import</span> bulk</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bulk_index_documents</span>(<span class="params">es_client, documents, index_name</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Efficiently bulk index documents with error handling</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    actions = []</span><br><span class="line">    <span class="keyword">for</span> doc <span class="keyword">in</span> documents:</span><br><span class="line">        actions.append(&#123;</span><br><span class="line">            <span class="string">&quot;_index&quot;</span>: index_name,</span><br><span class="line">            <span class="string">&quot;_source&quot;</span>: doc</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Process in batches of 1000</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(actions) &gt;= <span class="number">1000</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                bulk(es_client, actions)</span><br><span class="line">                actions = []</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Bulk indexing error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                </span><br><span class="line">    <span class="comment"># Process remaining documents</span></span><br><span class="line">    <span class="keyword">if</span> actions:</span><br><span class="line">        bulk(es_client, actions)</span><br></pre></td></tr></table></figure>

<p><strong>Performance Tuning:</strong></p>
<ul>
<li>Optimal batch size: 1000-5000 documents or 5-15MB</li>
<li>Use multiple threads for parallel bulk requests</li>
<li>Monitor queue sizes and adjust accordingly</li>
</ul>
<h2 id="Index-Level-Optimizations"><a href="#Index-Level-Optimizations" class="headerlink" title="Index-Level Optimizations"></a>Index-Level Optimizations</h2><h3 id="Refresh-Frequency-Optimization"><a href="#Refresh-Frequency-Optimization" class="headerlink" title="Refresh Frequency Optimization"></a>Refresh Frequency Optimization</h3><p>The refresh operation makes documents searchable but consumes significant resources.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># elasticsearch.yml - Global setting</span></span><br><span class="line"><span class="attr">index.refresh_interval:</span> <span class="string">30s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Index-specific setting</span></span><br><span class="line"><span class="string">PUT</span> <span class="string">/my_index/_settings</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;refresh_interval&quot;:</span> <span class="string">&quot;30s&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Disable refresh for write-heavy workloads</span></span><br><span class="line"><span class="string">PUT</span> <span class="string">/my_index/_settings</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;refresh_interval&quot;:</span> <span class="number">-1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Use Case Example:</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># High-volume logging scenario</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setup_logging_index</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Configure index for write-heavy logging workload</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    index_settings = &#123;</span><br><span class="line">        <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;refresh_interval&quot;</span>: <span class="string">&quot;60s&quot;</span>,  <span class="comment"># Reduce refresh frequency</span></span><br><span class="line">            <span class="string">&quot;number_of_replicas&quot;</span>: <span class="number">0</span>,    <span class="comment"># Disable replicas during bulk load</span></span><br><span class="line">            <span class="string">&quot;translog.durability&quot;</span>: <span class="string">&quot;async&quot;</span>,  <span class="comment"># Async translog for speed</span></span><br><span class="line">            <span class="string">&quot;index.merge.policy.max_merge_at_once&quot;</span>: <span class="number">30</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> index_settings</span><br></pre></td></tr></table></figure>

<h3 id="Field-Optimization-Strategies"><a href="#Field-Optimization-Strategies" class="headerlink" title="Field Optimization Strategies"></a>Field Optimization Strategies</h3><p>Disable unnecessary features to reduce index size and improve query performance.</p>
<h4 id="Source-Field-Optimization"><a href="#Source-Field-Optimization" class="headerlink" title="Source Field Optimization"></a>Source Field Optimization</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># Disable _source for analytics-only indices</span><br><span class="line">PUT /analytics_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;metric_value&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;double&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"># Selective source inclusion</span><br><span class="line">PUT /selective_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;includes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;title&quot;</span><span class="punctuation">,</span> <span class="string">&quot;summary&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;excludes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;large_content&quot;</span><span class="punctuation">,</span> <span class="string">&quot;binary_data&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="Doc-Values-Optimization"><a href="#Doc-Values-Optimization" class="headerlink" title="Doc Values Optimization"></a>Doc Values Optimization</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># Disable doc_values for fields that don&#x27;t need aggregations/sorting</span><br><span class="line">PUT /my_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;searchable_text&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;doc_values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;aggregatable_field&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;doc_values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight:</strong> <em>“What are doc_values and when should you disable them?”</em> - Doc_values enable aggregations, sorting, and scripting but consume disk space. Disable for fields used only in queries, not aggregations.</p>
<h3 id="Data-Lifecycle-Management"><a href="#Data-Lifecycle-Management" class="headerlink" title="Data Lifecycle Management"></a>Data Lifecycle Management</h3><p>Separate hot and cold data for optimal resource utilization.</p>
<pre>
<code class="mermaid">
graph
A[Hot Data&lt;br&#x2F;&gt;SSD Storage&lt;br&#x2F;&gt;Frequent Access] --&gt; B[Warm Data&lt;br&#x2F;&gt;HDD Storage&lt;br&#x2F;&gt;Occasional Access]
B --&gt; C[Cold Data&lt;br&#x2F;&gt;Archive Storage&lt;br&#x2F;&gt;Rare Access]

A --&gt; D[High Resources&lt;br&#x2F;&gt;More Replicas]
B --&gt; E[Medium Resources&lt;br&#x2F;&gt;Fewer Replicas]
C --&gt; F[Minimal Resources&lt;br&#x2F;&gt;Compressed Storage]
</code>
</pre>

<p><strong>ILM Policy Example:</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">PUT _ilm/policy/logs_policy</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;policy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;phases&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;hot&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;rollover&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;max_size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1GB&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;max_age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1d&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;warm&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;min_age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7d&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;allocate&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;cold&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;min_age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30d&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;allocate&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Memory-and-Storage-Optimization"><a href="#Memory-and-Storage-Optimization" class="headerlink" title="Memory and Storage Optimization"></a>Memory and Storage Optimization</h2><h3 id="Off-Heap-Memory-Optimization"><a href="#Off-Heap-Memory-Optimization" class="headerlink" title="Off-Heap Memory Optimization"></a>Off-Heap Memory Optimization</h3><p>Elasticsearch uses off-heap memory for various caches and operations.</p>
<p><strong>Circuit Breaker Configuration:</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># elasticsearch.yml</span></span><br><span class="line"><span class="attr">indices.breaker.total.limit:</span> <span class="number">70</span><span class="string">%</span></span><br><span class="line"><span class="attr">indices.breaker.fielddata.limit:</span> <span class="number">40</span><span class="string">%</span></span><br><span class="line"><span class="attr">indices.breaker.request.limit:</span> <span class="number">60</span><span class="string">%</span></span><br></pre></td></tr></table></figure>

<p><strong>Field Data Cache Management:</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># Monitor field data usage</span><br><span class="line">GET /_nodes/stats/indices/fielddata</span><br><span class="line"></span><br><span class="line"># Clear field data cache</span><br><span class="line">POST /_cache/clear?fielddata=<span class="literal"><span class="keyword">true</span></span></span><br><span class="line"></span><br><span class="line"># Limit field data cache size</span><br><span class="line">PUT /_cluster/settings</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;persistent&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;indices.fielddata.cache.size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30%&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Production Monitoring Script:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Monitor memory usage</span></span><br><span class="line">curl -s <span class="string">&quot;localhost:9200/_cat/nodes?v&amp;h=name,heap.percent,ram.percent,fielddata.memory_size,query_cache.memory_size&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Shard-Optimization"><a href="#Shard-Optimization" class="headerlink" title="Shard Optimization"></a>Shard Optimization</h3><p>Proper shard sizing is crucial for performance and cluster stability.</p>
<h4 id="Shard-Count-and-Size-Guidelines"><a href="#Shard-Count-and-Size-Guidelines" class="headerlink" title="Shard Count and Size Guidelines"></a>Shard Count and Size Guidelines</h4><pre>
<code class="mermaid">
graph
A[Determine Shard Strategy] --&gt; B{Index Size}
B --&gt;|&lt; 1GB| C[1 Primary Shard]
B --&gt;|1-50GB| D[1-5 Primary Shards]
B --&gt;|&gt; 50GB| E[Calculate: Size&#x2F;50GB]

C --&gt; F[Small Index Strategy]
D --&gt; G[Medium Index Strategy]
E --&gt; H[Large Index Strategy]

F --&gt; I[Minimize Overhead]
G --&gt; J[Balance Performance]
H --&gt; K[Distribute Load]
</code>
</pre>

<p><strong>Shard Calculation Formula:</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_optimal_shards</span>(<span class="params">index_size_gb, node_count</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Calculate optimal shard count based on index size and cluster size</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># Target shard size: 20-50GB</span></span><br><span class="line">    target_shard_size_gb = <span class="number">30</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Calculate based on size</span></span><br><span class="line">    size_based_shards = <span class="built_in">max</span>(<span class="number">1</span>, index_size_gb // target_shard_size_gb)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Don&#x27;t exceed node count (for primary shards)</span></span><br><span class="line">    optimal_shards = <span class="built_in">min</span>(size_based_shards, node_count)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> optimal_shards</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example usage</span></span><br><span class="line">index_size = <span class="number">150</span>  <span class="comment"># GB</span></span><br><span class="line">nodes = <span class="number">5</span></span><br><span class="line">shards = calculate_optimal_shards(index_size, nodes)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Recommended shards: <span class="subst">&#123;shards&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>Production Shard Settings:</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT /optimized_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.routing.allocation.total_shards_per_node&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Query-Performance-Patterns"><a href="#Query-Performance-Patterns" class="headerlink" title="Query Performance Patterns"></a>Query Performance Patterns</h3><h4 id="Efficient-Query-Patterns"><a href="#Efficient-Query-Patterns" class="headerlink" title="Efficient Query Patterns"></a>Efficient Query Patterns</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># Use filter context for exact matches (cacheable)</span><br><span class="line">GET /my_index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;elasticsearch&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;published&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;date&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2023-01-01&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"># Avoid wildcard queries on large datasets</span><br><span class="line"># BAD<span class="punctuation">:</span></span><br><span class="line"># <span class="punctuation">&#123;</span><span class="attr">&quot;wildcard&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*elasticsearch*&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"># GOOD<span class="punctuation">:</span> Use match_phrase_prefix for autocomplete</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;match_phrase_prefix&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;elasticsearch&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="Aggregation-Optimization"><a href="#Aggregation-Optimization" class="headerlink" title="Aggregation Optimization"></a>Aggregation Optimization</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># Use composite aggregations for large cardinality</span><br><span class="line">GET /my_index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;my_composite&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;composite&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sources&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span><span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;category.keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span><span class="attr">&quot;date&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;date_histogram&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;timestamp&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1d&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Monitoring-and-Troubleshooting"><a href="#Monitoring-and-Troubleshooting" class="headerlink" title="Monitoring and Troubleshooting"></a>Monitoring and Troubleshooting</h2><h3 id="Performance-Metrics"><a href="#Performance-Metrics" class="headerlink" title="Performance Metrics"></a>Performance Metrics</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Key performance APIs</span></span><br><span class="line">curl <span class="string">&quot;localhost:9200/_cat/nodes?v&amp;h=name,heap.percent,cpu,load_1m&quot;</span></span><br><span class="line">curl <span class="string">&quot;localhost:9200/_cat/indices?v&amp;h=index,docs.count,store.size,pri,rep&quot;</span></span><br><span class="line">curl <span class="string">&quot;localhost:9200/_nodes/stats/indices/search,indices/indexing&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>Slow Query Analysis:</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># Enable slow query logging</span><br><span class="line">PUT /my_index/_settings</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;index.search.slowlog.threshold.query.warn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10s&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;index.search.slowlog.threshold.query.info&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5s&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;index.search.slowlog.threshold.fetch.warn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1s&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Common-Performance-Anti-Patterns"><a href="#Common-Performance-Anti-Patterns" class="headerlink" title="Common Performance Anti-Patterns"></a>Common Performance Anti-Patterns</h3><p><strong>Interview Questions &amp; Solutions:</strong></p>
<ol>
<li><p><strong>“Why are my deep pagination queries slow?”</strong></p>
<ul>
<li>Use scroll API for sequential processing</li>
<li>Use search_after for real-time pagination</li>
<li>Implement caching for frequently accessed pages</li>
</ul>
</li>
<li><p><strong>“How do you handle high cardinality aggregations?”</strong></p>
<ul>
<li>Use composite aggregations with pagination</li>
<li>Implement pre-aggregated indices for common queries</li>
<li>Consider using terms aggregation with execution_hint</li>
</ul>
</li>
<li><p><strong>“What causes high memory usage in Elasticsearch?”</strong></p>
<ul>
<li>Large field data caches from aggregations</li>
<li>Too many shards causing overhead</li>
<li>Inefficient query patterns causing cache thrashing</li>
</ul>
</li>
</ol>
<h2 id="Advanced-Optimization-Techniques"><a href="#Advanced-Optimization-Techniques" class="headerlink" title="Advanced Optimization Techniques"></a>Advanced Optimization Techniques</h2><h3 id="Index-Templates-and-Aliases"><a href="#Index-Templates-and-Aliases" class="headerlink" title="Index Templates and Aliases"></a>Index Templates and Aliases</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># Optimized index template</span><br><span class="line">PUT /_index_template/logs_template</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;index_patterns&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;logs-*&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;template&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30s&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;codec&quot;</span><span class="punctuation">:</span> <span class="string">&quot;best_compression&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;dynamic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;strict&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;norms&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;service&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Machine-Learning-and-Anomaly-Detection"><a href="#Machine-Learning-and-Anomaly-Detection" class="headerlink" title="Machine Learning and Anomaly Detection"></a>Machine Learning and Anomaly Detection</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># Use ML for capacity planning</span><br><span class="line">PUT _ml/anomaly_detectors/high_search_rate</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;job_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;high_search_rate&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;analysis_config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bucket_span&quot;</span><span class="punctuation">:</span> <span class="string">&quot;15m&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;detectors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;function&quot;</span><span class="punctuation">:</span> <span class="string">&quot;high_mean&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;field_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;search_rate&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data_description&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;time_field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;timestamp&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Elasticsearch query performance optimization requires a holistic approach combining system-level tuning, query optimization, and proper index design. The key is to:</p>
<ol>
<li><strong>Monitor continuously</strong> - Use built-in monitoring and custom metrics</li>
<li><strong>Test systematically</strong> - Benchmark changes in isolated environments</li>
<li><strong>Scale progressively</strong> - Start with simple optimizations before complex ones</li>
<li><strong>Plan for growth</strong> - Design with future data volumes in mind</li>
</ol>
<p><strong>Critical Interview Insight:</strong> <em>“Performance optimization is not a one-time task but an ongoing process that requires understanding your data patterns, query characteristics, and growth projections.”</em></p>
<h2 id="External-Resources"><a href="#External-Resources" class="headerlink" title="External Resources"></a>External Resources</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/tune-for-search-speed.html">Elasticsearch Official Performance Tuning Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html">Elasticsearch Heap Sizing Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html">Query Performance Best Practices</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index-lifecycle-management.html">Index Lifecycle Management Documentation</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/17/Elasticsearch-High-Availability-Deep-Dive-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/17/Elasticsearch-High-Availability-Deep-Dive-Guide/" class="post-title-link" itemprop="url">Elasticsearch High Availability: Deep Dive Guide</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-17 17:08:58 / Modified: 17:10:45" itemprop="dateCreated datePublished" datetime="2025-06-17T17:08:58+08:00">2025-06-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/elasticsearch/" itemprop="url" rel="index"><span itemprop="name">elasticsearch</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Shards-and-Replicas-The-Foundation-of-Elasticsearch-HA"><a href="#Shards-and-Replicas-The-Foundation-of-Elasticsearch-HA" class="headerlink" title="Shards and Replicas: The Foundation of Elasticsearch HA"></a>Shards and Replicas: The Foundation of Elasticsearch HA</h2><h3 id="Understanding-Shards"><a href="#Understanding-Shards" class="headerlink" title="Understanding Shards"></a>Understanding Shards</h3><p>Shards are the fundamental building blocks of Elasticsearch’s distributed architecture. Each index is divided into multiple shards, which are essentially independent Lucene indices that can be distributed across different nodes in a cluster.</p>
<p><strong>Primary Shards:</strong></p>
<ul>
<li>Store the original data</li>
<li>Handle write operations</li>
<li>Number is fixed at index creation time</li>
<li>Cannot be changed without reindexing</li>
</ul>
<p><strong>Shard Sizing Best Practices:</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.routing.allocation.total_shards_per_node&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Replica-Strategy-for-High-Availability"><a href="#Replica-Strategy-for-High-Availability" class="headerlink" title="Replica Strategy for High Availability"></a>Replica Strategy for High Availability</h3><p>Replicas are exact copies of primary shards that provide both redundancy and increased read throughput.</p>
<p><strong>Production Replica Configuration:</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /production_logs</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30s&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.translog.durability&quot;</span><span class="punctuation">:</span> <span class="string">&quot;request&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Real-World-Example-E-commerce-Platform"><a href="#Real-World-Example-E-commerce-Platform" class="headerlink" title="Real-World Example: E-commerce Platform"></a>Real-World Example: E-commerce Platform</h3><p>Consider an e-commerce platform handling 1TB of product data:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PUT /products</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.routing.allocation.require.box_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hot&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;product_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;double&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<pre>
<code class="mermaid">
graph TB
subgraph &quot;Node 1&quot;
    P1[Primary Shard 1]
    R2[Replica Shard 2]
    R3[Replica Shard 3]
end

subgraph &quot;Node 2&quot;
    P2[Primary Shard 2]
    R1[Replica Shard 1]
    R4[Replica Shard 4]
end

subgraph &quot;Node 3&quot;
    P3[Primary Shard 3]
    P4[Primary Shard 4]
    R5[Replica Shard 5]
end

P1 -.-&gt;|Replicates to| R1
P2 -.-&gt;|Replicates to| R2
P3 -.-&gt;|Replicates to| R3
P4 -.-&gt;|Replicates to| R4
</code>
</pre>

<p><strong>Interview Insight:</strong> <em>“How would you determine the optimal number of shards for a 500GB index with expected 50% growth annually?”</em></p>
<p><strong>Answer:</strong> Calculate based on shard size (aim for 10-50GB per shard), consider node capacity, and factor in growth. For 500GB growing to 750GB: 15-75 shards initially, typically 20-30 shards with 1-2 replicas.</p>
<h2 id="TransLog-Ensuring-Write-Durability"><a href="#TransLog-Ensuring-Write-Durability" class="headerlink" title="TransLog: Ensuring Write Durability"></a>TransLog: Ensuring Write Durability</h2><h3 id="TransLog-Mechanism"><a href="#TransLog-Mechanism" class="headerlink" title="TransLog Mechanism"></a>TransLog Mechanism</h3><p>The Transaction Log (TransLog) is Elasticsearch’s write-ahead log that ensures data durability during unexpected shutdowns or power failures.</p>
<p><strong>How TransLog Works:</strong></p>
<ol>
<li>Write operation received</li>
<li>Data written to in-memory buffer</li>
<li>Operation logged to TransLog</li>
<li>Acknowledgment sent to client</li>
<li>Periodic flush to Lucene segments</li>
</ol>
<h3 id="TransLog-Configuration-for-High-Availability"><a href="#TransLog-Configuration-for-High-Availability" class="headerlink" title="TransLog Configuration for High Availability"></a>TransLog Configuration for High Availability</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /critical_data</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;index.translog.durability&quot;</span><span class="punctuation">:</span> <span class="string">&quot;request&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.translog.sync_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5s&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.translog.flush_threshold_size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;512mb&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1s&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>TransLog Durability Options:</strong></p>
<ul>
<li><code>request</code>: Fsync after each request (highest durability, lower performance)</li>
<li><code>async</code>: Fsync every sync_interval (better performance, slight risk)</li>
</ul>
<h3 id="Production-Example-Financial-Trading-System"><a href="#Production-Example-Financial-Trading-System" class="headerlink" title="Production Example: Financial Trading System"></a>Production Example: Financial Trading System</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PUT /trading_transactions</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.translog.durability&quot;</span><span class="punctuation">:</span> <span class="string">&quot;request&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.translog.sync_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1s&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1s&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.translog.retention.size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1gb&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.translog.retention.age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;12h&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<pre>
<code class="mermaid">
sequenceDiagram
participant Client
participant ES_Node
participant TransLog
participant Lucene

Client-&gt;&gt;ES_Node: Index Document
ES_Node-&gt;&gt;TransLog: Write to TransLog
TransLog--&gt;&gt;ES_Node: Confirm Write
ES_Node-&gt;&gt;Lucene: Add to In-Memory Buffer
ES_Node--&gt;&gt;Client: Acknowledge Request

Note over ES_Node: Periodic Refresh
ES_Node-&gt;&gt;Lucene: Flush Buffer to Segment
ES_Node-&gt;&gt;TransLog: Clear TransLog Entries
</code>
</pre>

<p><strong>Interview Insight:</strong> <em>“What happens if a node crashes between TransLog write and Lucene flush?”</em></p>
<p><strong>Answer:</strong> On restart, Elasticsearch replays TransLog entries to recover uncommitted operations. The TransLog ensures no acknowledged writes are lost, maintaining data consistency.</p>
<h2 id="Production-HA-Challenges-and-Solutions"><a href="#Production-HA-Challenges-and-Solutions" class="headerlink" title="Production HA Challenges and Solutions"></a>Production HA Challenges and Solutions</h2><h3 id="Common-Production-Issues"><a href="#Common-Production-Issues" class="headerlink" title="Common Production Issues"></a>Common Production Issues</h3><h4 id="Split-Brain-Syndrome"><a href="#Split-Brain-Syndrome" class="headerlink" title="Split-Brain Syndrome"></a>Split-Brain Syndrome</h4><p><strong>Problem:</strong> Network partitions causing multiple master nodes</p>
<p><strong>Solution:</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># elasticsearch.yml</span></span><br><span class="line"><span class="attr">discovery.zen.minimum_master_nodes:</span> <span class="number">2</span>  <span class="comment"># (total_masters / 2) + 1</span></span><br><span class="line"><span class="attr">cluster.initial_master_nodes:</span> [<span class="string">&quot;node-1&quot;</span>, <span class="string">&quot;node-2&quot;</span>, <span class="string">&quot;node-3&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="Memory-Pressure-and-GC-Issues"><a href="#Memory-Pressure-and-GC-Issues" class="headerlink" title="Memory Pressure and GC Issues"></a>Memory Pressure and GC Issues</h4><p><strong>Problem:</strong> Large heaps causing long GC pauses</p>
<p><strong>Solution:</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># jvm.options</span></span><br><span class="line"><span class="string">-Xms16g</span></span><br><span class="line"><span class="string">-Xmx16g</span></span><br><span class="line"><span class="string">-XX:+UseG1GC</span></span><br><span class="line"><span class="string">-XX:MaxGCPauseMillis=200</span></span><br></pre></td></tr></table></figure>

<h4 id="Uneven-Shard-Distribution"><a href="#Uneven-Shard-Distribution" class="headerlink" title="Uneven Shard Distribution"></a>Uneven Shard Distribution</h4><p><strong>Problem:</strong> Hot spots on specific nodes</p>
<p><strong>Solution:</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT /_cluster/settings</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;transient&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;cluster.routing.allocation.balance.shard&quot;</span><span class="punctuation">:</span> <span class="number">0.45</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cluster.routing.allocation.balance.index&quot;</span><span class="punctuation">:</span> <span class="number">0.55</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cluster.routing.allocation.balance.threshold&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Real-Production-Case-Study-Log-Analytics-Platform"><a href="#Real-Production-Case-Study-Log-Analytics-Platform" class="headerlink" title="Real Production Case Study: Log Analytics Platform"></a>Real Production Case Study: Log Analytics Platform</h3><p><strong>Challenge:</strong> Processing 100GB&#x2F;day of application logs with strict SLA requirements</p>
<p><strong>Architecture:</strong></p>
<pre>
<code class="mermaid">
graph LR
subgraph &quot;Hot Tier&quot;
    H1[Hot Node 1]
    H2[Hot Node 2]
    H3[Hot Node 3]
end

subgraph &quot;Warm Tier&quot;
    W1[Warm Node 1]
    W2[Warm Node 2]
end

subgraph &quot;Cold Tier&quot;
    C1[Cold Node 1]
end

Apps[Applications] --&gt; LB[Load Balancer]
LB --&gt; H1
LB --&gt; H2
LB --&gt; H3

H1 -.-&gt;|Age-based| W1
H2 -.-&gt;|Migration| W2
W1 -.-&gt;|Archive| C1
W2 -.-&gt;|Archive| C1
</code>
</pre>

<p><strong>Index Template Configuration:</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PUT /_index_template/logs_template</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;index_patterns&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;logs-*&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;template&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;index.lifecycle.name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;logs_policy&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;index.routing.allocation.require.box_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hot&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight:</strong> <em>“How would you handle a scenario where your Elasticsearch cluster is experiencing high write latency?”</em></p>
<p><strong>Answer:</strong> </p>
<ol>
<li>Check TransLog settings (reduce durability if acceptable)</li>
<li>Optimize refresh intervals</li>
<li>Implement bulk indexing</li>
<li>Scale horizontally by adding nodes</li>
<li>Consider index lifecycle management</li>
</ol>
<h2 id="Optimization-Strategies-for-Production-HA"><a href="#Optimization-Strategies-for-Production-HA" class="headerlink" title="Optimization Strategies for Production HA"></a>Optimization Strategies for Production HA</h2><h3 id="Rate-Limiting-Implementation"><a href="#Rate-Limiting-Implementation" class="headerlink" title="Rate Limiting Implementation"></a>Rate Limiting Implementation</h3><p><strong>Circuit Breaker Pattern:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticsearchCircuitBreaker</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CircuitBreaker circuitBreaker;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ElasticsearchClient client;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;IndexResponse&gt; <span class="title function_">indexWithRateLimit</span><span class="params">(</span></span><br><span class="line"><span class="params">            IndexRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> circuitBreaker.executeSupplier(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> client.index(request);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Cluster-level Rate Limiting:</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT /_cluster/settings</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;transient&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;indices.memory.index_buffer_size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;20%&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;indices.memory.min_index_buffer_size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;96mb&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;thread_pool.write.queue_size&quot;</span><span class="punctuation">:</span> <span class="number">1000</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Message-Queue-Peak-Shaving"><a href="#Message-Queue-Peak-Shaving" class="headerlink" title="Message Queue Peak Shaving"></a>Message Queue Peak Shaving</h3><p><strong>Kafka Integration Example:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticsearchBulkProcessor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@KafkaListener(topics = &quot;elasticsearch-queue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processBulkData</span><span class="params">(List&lt;String&gt; documents)</span> &#123;</span><br><span class="line">        <span class="type">BulkRequest</span> <span class="variable">bulkRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BulkRequest</span>();</span><br><span class="line">        </span><br><span class="line">        documents.forEach(doc -&gt; &#123;</span><br><span class="line">            bulkRequest.add(<span class="keyword">new</span> <span class="title class_">IndexRequest</span>(<span class="string">&quot;logs&quot;</span>)</span><br><span class="line">                .source(doc, XContentType.JSON));</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="type">BulkResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.bulk(bulkRequest, RequestOptions.DEFAULT);</span><br><span class="line">        handleBulkResponse(response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>MQ Configuration for Peak Shaving:</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">kafka:</span></span><br><span class="line">    <span class="attr">consumer:</span></span><br><span class="line">      <span class="attr">max-poll-records:</span> <span class="number">500</span></span><br><span class="line">      <span class="attr">fetch-max-wait:</span> <span class="string">1000ms</span></span><br><span class="line">    <span class="attr">producer:</span></span><br><span class="line">      <span class="attr">batch-size:</span> <span class="number">65536</span></span><br><span class="line">      <span class="attr">linger-ms:</span> <span class="number">100</span></span><br></pre></td></tr></table></figure>

<h3 id="Single-Role-Node-Architecture"><a href="#Single-Role-Node-Architecture" class="headerlink" title="Single Role Node Architecture"></a>Single Role Node Architecture</h3><p><strong>Dedicated Master Nodes:</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># master.yml</span></span><br><span class="line"><span class="attr">node.roles:</span> [<span class="string">master</span>]</span><br><span class="line"><span class="attr">discovery.seed_hosts:</span> [<span class="string">&quot;master-1&quot;</span>, <span class="string">&quot;master-2&quot;</span>, <span class="string">&quot;master-3&quot;</span>]</span><br><span class="line"><span class="attr">cluster.initial_master_nodes:</span> [<span class="string">&quot;master-1&quot;</span>, <span class="string">&quot;master-2&quot;</span>, <span class="string">&quot;master-3&quot;</span>]</span><br></pre></td></tr></table></figure>

<p><strong>Data Nodes Configuration:</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># data.yml</span></span><br><span class="line"><span class="attr">node.roles:</span> [<span class="string">data</span>, <span class="string">data_content</span>, <span class="string">data_hot</span>, <span class="string">data_warm</span>]</span><br><span class="line"><span class="attr">path.data:</span> [<span class="string">&quot;/data1&quot;</span>, <span class="string">&quot;/data2&quot;</span>, <span class="string">&quot;/data3&quot;</span>]</span><br></pre></td></tr></table></figure>

<p><strong>Coordinating Nodes:</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coordinator.yml</span></span><br><span class="line"><span class="attr">node.roles:</span> []</span><br><span class="line"><span class="attr">http.port:</span> <span class="number">9200</span></span><br></pre></td></tr></table></figure>

<h3 id="Dual-Cluster-Deployment-Strategy"><a href="#Dual-Cluster-Deployment-Strategy" class="headerlink" title="Dual Cluster Deployment Strategy"></a>Dual Cluster Deployment Strategy</h3><p><strong>Active-Passive Setup:</strong></p>
<pre>
<code class="mermaid">
graph TB
subgraph &quot;Primary DC&quot;
    P_LB[Load Balancer]
    P_C1[Cluster 1 Node 1]
    P_C2[Cluster 1 Node 2]
    P_C3[Cluster 1 Node 3]
    
    P_LB --&gt; P_C1
    P_LB --&gt; P_C2
    P_LB --&gt; P_C3
end

subgraph &quot;Secondary DC&quot;
    S_C1[Cluster 2 Node 1]
    S_C2[Cluster 2 Node 2]
    S_C3[Cluster 2 Node 3]
end

P_C1 -.-&gt;|Cross Cluster Replication| S_C1
P_C2 -.-&gt;|CCR| S_C2
P_C3 -.-&gt;|CCR| S_C3

Apps[Applications] --&gt; P_LB
</code>
</pre>

<p><strong>Cross-Cluster Replication Setup:</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PUT /_cluster/settings</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;persistent&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;cluster.remote.secondary&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;seeds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;secondary-cluster:9300&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;transport.compress&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">PUT /primary_index/_ccr/follow</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;remote_cluster&quot;</span><span class="punctuation">:</span> <span class="string">&quot;secondary&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;leader_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;primary_index&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Advanced-HA-Monitoring-and-Alerting"><a href="#Advanced-HA-Monitoring-and-Alerting" class="headerlink" title="Advanced HA Monitoring and Alerting"></a>Advanced HA Monitoring and Alerting</h2><h3 id="Key-Metrics-to-Monitor"><a href="#Key-Metrics-to-Monitor" class="headerlink" title="Key Metrics to Monitor"></a>Key Metrics to Monitor</h3><p><strong>Cluster Health Script:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">CLUSTER_HEALTH=$(curl -s <span class="string">&quot;localhost:9200/_cluster/health&quot;</span>)</span><br><span class="line">STATUS=$(<span class="built_in">echo</span> <span class="variable">$CLUSTER_HEALTH</span> | jq -r <span class="string">&#x27;.status&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$STATUS</span>&quot;</span> != <span class="string">&quot;green&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;ALERT: Cluster status is <span class="variable">$STATUS</span>&quot;</span></span><br><span class="line">    <span class="comment"># Send notification</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p><strong>Critical Metrics:</strong></p>
<ul>
<li>Cluster status (green&#x2F;yellow&#x2F;red)</li>
<li>Node availability</li>
<li>Shard allocation status</li>
<li>Memory usage and GC frequency</li>
<li>Search and indexing latency</li>
<li>TransLog size and flush frequency</li>
</ul>
<h3 id="Alerting-Configuration-Example"><a href="#Alerting-Configuration-Example" class="headerlink" title="Alerting Configuration Example"></a>Alerting Configuration Example</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># alertmanager.yml</span></span><br><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">elasticsearch</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">ElasticsearchClusterNotHealthy</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">elasticsearch_cluster_health_status&#123;color=&quot;red&quot;&#125;</span> <span class="string">==</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">0m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;Elasticsearch cluster health is RED&quot;</span></span><br><span class="line">      </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">ElasticsearchNodeDown</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">up&#123;job=&quot;elasticsearch&quot;&#125;</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br></pre></td></tr></table></figure>

<h2 id="Performance-Tuning-for-HA"><a href="#Performance-Tuning-for-HA" class="headerlink" title="Performance Tuning for HA"></a>Performance Tuning for HA</h2><h3 id="Index-Lifecycle-Management"><a href="#Index-Lifecycle-Management" class="headerlink" title="Index Lifecycle Management"></a>Index Lifecycle Management</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">PUT /_ilm/policy/production_policy</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;policy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;phases&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;hot&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;rollover&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;max_size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10gb&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;max_age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1d&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;warm&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;min_age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7d&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;allocate&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;require&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;box_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;warm&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;forcemerge&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;max_num_segments&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;cold&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;min_age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30d&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;allocate&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;require&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;box_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cold&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Hardware-Recommendations"><a href="#Hardware-Recommendations" class="headerlink" title="Hardware Recommendations"></a>Hardware Recommendations</h3><p><strong>Production Hardware Specs:</strong></p>
<ul>
<li><strong>CPU:</strong> 16+ cores for data nodes</li>
<li><strong>Memory:</strong> 64GB+ RAM (50% for heap, 50% for filesystem cache)</li>
<li><strong>Storage:</strong> NVMe SSDs for hot data, SATA SSDs for warm&#x2F;cold</li>
<li><strong>Network:</strong> 10Gbps+ for inter-node communication</li>
</ul>
<h2 id="Interview-Questions-and-Expert-Answers"><a href="#Interview-Questions-and-Expert-Answers" class="headerlink" title="Interview Questions and Expert Answers"></a>Interview Questions and Expert Answers</h2><p><strong>Q: “How would you recover from a complete cluster failure?”</strong></p>
<p><strong>A:</strong> </p>
<ol>
<li>Restore from snapshot if available</li>
<li>If no snapshots, recover using <code>elasticsearch-node</code> tool</li>
<li>Implement proper backup strategy going forward</li>
<li>Consider cross-cluster replication for future disasters</li>
</ol>
<p><strong>Q: “Explain the difference between <code>index.refresh_interval</code> and TransLog flush.”</strong></p>
<p><strong>A:</strong> </p>
<ul>
<li><code>refresh_interval</code> controls when in-memory documents become searchable</li>
<li>TransLog flush persists data to disk for durability</li>
<li>Refresh affects search visibility, flush affects data safety</li>
</ul>
<p><strong>Q: “How do you handle version conflicts in a distributed environment?”</strong></p>
<p><strong>A:</strong> </p>
<ul>
<li>Use optimistic concurrency control with version numbers</li>
<li>Implement retry logic with exponential backoff</li>
<li>Consider using <code>_seq_no</code> and <code>_primary_term</code> for more granular control</li>
</ul>
<h2 id="Security-Considerations-for-HA"><a href="#Security-Considerations-for-HA" class="headerlink" title="Security Considerations for HA"></a>Security Considerations for HA</h2><h3 id="Authentication-and-Authorization"><a href="#Authentication-and-Authorization" class="headerlink" title="Authentication and Authorization"></a>Authentication and Authorization</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># elasticsearch.yml</span></span><br><span class="line"><span class="attr">xpack.security.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.http.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">xpack.security.authc.realms.native.native1:</span></span><br><span class="line">  <span class="attr">order:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><strong>Role-Based Access Control:</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /_security/role/log_reader</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;indices&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;names&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;logs-*&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;privileges&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;read&quot;</span><span class="punctuation">,</span> <span class="string">&quot;view_index_metadata&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Best-Practices-Summary"><a href="#Best-Practices-Summary" class="headerlink" title="Best Practices Summary"></a>Best Practices Summary</h2><h3 id="Do’s"><a href="#Do’s" class="headerlink" title="Do’s"></a>Do’s</h3><ul>
<li>Always use odd number of master-eligible nodes (3, 5, 7)</li>
<li>Implement proper monitoring and alerting</li>
<li>Use index templates for consistent settings</li>
<li>Regularly test disaster recovery procedures</li>
<li>Implement proper backup strategies</li>
</ul>
<h3 id="Don’ts"><a href="#Don’ts" class="headerlink" title="Don’ts"></a>Don’ts</h3><ul>
<li>Don’t set heap size above 32GB</li>
<li>Don’t disable swap without proper configuration</li>
<li>Don’t ignore yellow cluster status</li>
<li>Don’t use default settings in production</li>
<li>Don’t forget to monitor disk space</li>
</ul>
<h2 id="References-and-Additional-Resources"><a href="#References-and-Additional-Resources" class="headerlink" title="References and Additional Resources"></a>References and Additional Resources</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">Elasticsearch Official Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/tune-for-search-speed.html">Elasticsearch Performance Tuning Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/cloud/current/ec-getting-started.html">Elastic Cloud Architecture Best Practices</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/system-config.html">Production Deployment Considerations</a></li>
</ul>
<hr>
<p><em>This guide provides a comprehensive foundation for implementing and maintaining highly available Elasticsearch clusters in production environments. Regular updates and testing of these configurations are essential for maintaining optimal performance and reliability.</em></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/16/Design-Video-Image-Structure-Analysis-Platform/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/16/Design-Video-Image-Structure-Analysis-Platform/" class="post-title-link" itemprop="url">Design Video Image Structure Analysis Platform</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-16 19:28:03 / Modified: 19:29:35" itemprop="dateCreated datePublished" datetime="2025-06-16T19:28:03+08:00">2025-06-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system-design/" itemprop="url" rel="index"><span itemprop="name">system-design</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="System-Architecture-Overview"><a href="#System-Architecture-Overview" class="headerlink" title="System Architecture Overview"></a>System Architecture Overview</h2><p>The Video Image Structure Analysis Platform is designed as a cloud-native, microservices-based system that processes video streams and images to extract structured metadata about objects like people, vehicles, bikes, and motorbikes. The architecture emphasizes scalability, resilience, and real-time processing capabilities.</p>
<pre>
<code class="mermaid">
graph TB
subgraph &quot;Data Ingestion Layer&quot;
    Camera[Cameras&#x2F;Video Sources]
    StreamService[StreamingAccessService]
    Camera --&gt; StreamService
end

subgraph &quot;Processing Layer&quot;
    StructureApp[StructureAppService]
    TaskManager[TaskManagerService]
    StreamService --&gt; StructureApp
    TaskManager --&gt; StructureApp
end

subgraph &quot;Message Queue&quot;
    Kafka[Apache Kafka]
    StructureApp --&gt; Kafka
end

subgraph &quot;Storage Layer&quot;
    ElasticSearch[ElasticSearch]
    FastDFS[FastDFS]
    StorageService[StorageAndSearchService]
    Kafka --&gt; StorageService
    StorageService --&gt; ElasticSearch
    StorageService --&gt; FastDFS
end

subgraph &quot;Application Layer&quot;
    PlatformAPI[AnalysisPlatformService]
    WebUI[AnalysisPlatformUI]
    StorageService --&gt; PlatformAPI
    PlatformAPI --&gt; WebUI
end

subgraph &quot;Infrastructure&quot;
    Redis[Redis Cache]
    Zookeeper[Zookeeper]
    PlatformAPI --&gt; Redis
    TaskManager --&gt; Zookeeper
end
</code>
</pre>

<p><strong>Interview Insight</strong>: When designing distributed systems, the separation of concerns is crucial. Each service has a single responsibility, and communication patterns are well-defined through message queues and APIs.</p>
<h2 id="Core-Services-Architecture"><a href="#Core-Services-Architecture" class="headerlink" title="Core Services Architecture"></a>Core Services Architecture</h2><h3 id="StreamingAccessService"><a href="#StreamingAccessService" class="headerlink" title="StreamingAccessService"></a>StreamingAccessService</h3><p>The StreamingAccessService acts as the gateway for all video inputs, managing camera connections and stream processing.</p>
<p><strong>Key Responsibilities:</strong></p>
<ul>
<li>Real-time RTMP&#x2F;RTSP stream ingestion from multiple cameras</li>
<li>Video transcoding and format normalization</li>
<li>Frame extraction and batching for analysis</li>
<li>Load balancing across multiple camera feeds</li>
<li>Geographic distribution management with camera mapping</li>
</ul>
<p><strong>Technical Implementation:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StreamingAccessService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processVideoStream</span><span class="params">(String cameraId, VideoStream stream)</span> &#123;</span><br><span class="line">        <span class="comment">// Frame extraction logic</span></span><br><span class="line">        List&lt;Frame&gt; frames = extractFrames(stream);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Cache camera metadata</span></span><br><span class="line">        cacheManager.put(<span class="string">&quot;camera:&quot;</span> + cameraId, getCameraMetadata(cameraId));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Send frames for analysis</span></span><br><span class="line">        structureAppService.analyzeFrames(frames, cameraId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Scaling Strategy</strong>: Use horizontal pod autoscaling based on CPU and memory metrics, with dedicated nodes for video processing to handle I&#x2F;O intensive operations.</p>
<h3 id="StructureAppService"><a href="#StructureAppService" class="headerlink" title="StructureAppService"></a>StructureAppService</h3><p>This GPU-accelerated service performs the core computer vision analysis using deep learning models.</p>
<p><strong>ML Pipeline Architecture:</strong></p>
<pre>
<code class="mermaid">
flowchart LR
Input[Frame Input] --&gt; Preprocess[Preprocessing]
Preprocess --&gt; Detection[Object Detection]
Detection --&gt; Classification[Classification]
Classification --&gt; Attribution[Attribute Extraction]
Attribution --&gt; Output[JSON Output]

subgraph &quot;Models&quot;
    YOLO[YOLO v8]
    ResNet[ResNet-50]
    Custom[Custom Models]
end

Detection --&gt; YOLO
Classification --&gt; ResNet
Attribution --&gt; Custom
</code>
</pre>

<p><strong>Object Analysis Specifications:</strong></p>
<p><em>Person Attributes:</em></p>
<ul>
<li>Age estimation (age ranges: 0-12, 13-17, 18-30, 31-50, 51-70, 70+)</li>
<li>Gender classification (male, female, unknown)</li>
<li>Height estimation using reference objects</li>
<li>Clothing color detection (top, bottom)</li>
<li>Body size estimation (small, medium, large)</li>
<li>Pose estimation for activity recognition</li>
</ul>
<p><em>Vehicle Attributes:</em></p>
<ul>
<li>License plate recognition using OCR</li>
<li>Vehicle type classification (sedan, SUV, truck, bus)</li>
<li>Color detection using color histograms</li>
<li>Brand recognition using CNN models</li>
<li>Seatbelt detection for driver safety compliance</li>
</ul>
<p><strong>Interview Insight</strong>: GPU resource management is critical. Implement batch processing to maximize GPU utilization and use model optimization techniques like TensorRT for inference acceleration.</p>
<h3 id="TaskManagerService"><a href="#TaskManagerService" class="headerlink" title="TaskManagerService"></a>TaskManagerService</h3><p>Coordinates analysis tasks across the distributed system using Zookeeper for consensus and resource management.</p>
<p><strong>Resource Management:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TaskManagerService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CuratorFramework zookeeperClient;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">scheduleAnalysisTask</span><span class="params">(AnalysisTask task)</span> &#123;</span><br><span class="line">        <span class="comment">// Get available nodes from Zookeeper</span></span><br><span class="line">        List&lt;String&gt; availableNodes = getAvailableNodes();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Select optimal node based on resources</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">selectedNode</span> <span class="operator">=</span> selectNodeByResources(availableNodes, task);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Create distributed lock for task assignment</span></span><br><span class="line">        <span class="type">InterProcessMutex</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InterProcessMutex</span>(zookeeperClient, </span><br><span class="line">            <span class="string">&quot;/tasks/locks/&quot;</span> + task.getId());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.acquire();</span><br><span class="line">            assignTaskToNode(task, selectedNode);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.release();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Zookeeper Data Structure:</strong></p>
<ul>
<li><code>/nodes/available</code> - List of active processing nodes</li>
<li><code>/nodes/resources</code> - Current resource utilization</li>
<li><code>/tasks/pending</code> - Queue of pending analysis tasks</li>
<li><code>/tasks/processing</code> - Currently executing tasks</li>
<li><code>/cameras/registry</code> - Camera registration and metadata</li>
</ul>
<h3 id="StorageAndSearchService"><a href="#StorageAndSearchService" class="headerlink" title="StorageAndSearchService"></a>StorageAndSearchService</h3><p>Manages structured data storage and provides advanced search capabilities.</p>
<p><strong>ElasticSearch Index Mapping:</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;person_index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;camera_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;geo_point&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;person_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;age_range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;height_cm&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;clothing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;top_color&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;bottom_color&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;style&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;body_size&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;image_path&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;confidence_score&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;float&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;feature_vector&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dense_vector&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;dims&quot;</span><span class="punctuation">:</span> <span class="number">512</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;vehicle_index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;camera_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;geo_point&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;vehicle_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;license_plate&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;vehicle_type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;brand&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;model&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;driver_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;seatbelt_detected&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;boolean&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;phone_usage&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;boolean&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;image_path&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;confidence_score&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;float&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;feature_vector&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dense_vector&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;dims&quot;</span><span class="punctuation">:</span> <span class="number">512</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>FastDFS Integration:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ImageStorageService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">storeImage</span><span class="params">(<span class="type">byte</span>[] imageData, String objectType)</span> &#123;</span><br><span class="line">        <span class="comment">// Generate unique filename</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> generateUniqueFilename(objectType);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Store in FastDFS</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileId</span> <span class="operator">=</span> fastDFSClient.uploadFile(imageData, <span class="string">&quot;jpg&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Cache mapping in Redis for quick access</span></span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;image:&quot;</span> + filename, fileId, </span><br><span class="line">            Duration.ofHours(<span class="number">24</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> fileId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: When designing search indices, consider both exact matches and fuzzy searches. Use appropriate analyzers for text fields and optimize for common query patterns.</p>
<h2 id="API-Design"><a href="#API-Design" class="headerlink" title="API Design"></a>API Design</h2><h3 id="RESTful-API-Endpoints"><a href="#RESTful-API-Endpoints" class="headerlink" title="RESTful API Endpoints"></a>RESTful API Endpoints</h3><p><strong>Task Management APIs:</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /api/v1/tasks</span><br><span class="line">GET /api/v1/tasks?status=&#123;status&#125;&amp;camera_id=&#123;id&#125;</span><br><span class="line">GET /api/v1/tasks/&#123;taskId&#125;</span><br><span class="line">PUT /api/v1/tasks/&#123;taskId&#125;</span><br><span class="line">DELETE /api/v1/tasks/&#123;taskId&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Camera Management APIs:</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /api/v1/cameras</span><br><span class="line">GET /api/v1/cameras?location=&#123;lat,lng&#125;&amp;radius=&#123;km&#125;</span><br><span class="line">GET /api/v1/cameras/&#123;cameraId&#125;</span><br><span class="line">PUT /api/v1/cameras/&#123;cameraId&#125;</span><br><span class="line">DELETE /api/v1/cameras/&#123;cameraId&#125;</span><br><span class="line">GET /api/v1/cameras/&#123;cameraId&#125;/stream</span><br></pre></td></tr></table></figure>

<p><strong>Search APIs:</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /api/v1/search/persons</span><br><span class="line">POST /api/v1/search/vehicles</span><br><span class="line">POST /api/v1/search/similarity</span><br><span class="line">GET /api/v1/search/export?format=&#123;json|csv&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Real-time APIs:</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /api/v1/stream/cameras/&#123;cameraId&#125;/ws</span><br><span class="line">GET /api/v1/alerts/ws</span><br></pre></td></tr></table></figure>

<h3 id="API-Request-Response-Examples"><a href="#API-Request-Response-Examples" class="headerlink" title="API Request&#x2F;Response Examples"></a>API Request&#x2F;Response Examples</h3><p><strong>Person Search Request:</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;filters&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;age_range&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;18-30&quot;</span><span class="punctuation">,</span> <span class="string">&quot;31-50&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;male&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;clothing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;top_color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blue&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bottom_color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;black&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;time_range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-01-01T00:00:00Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-01-31T23:59:59Z&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;center&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;lat&quot;</span><span class="punctuation">:</span> <span class="number">40.7128</span><span class="punctuation">,</span> <span class="attr">&quot;lng&quot;</span><span class="punctuation">:</span> <span class="number">-74.0060</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;radius&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5km&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pagination&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;page&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">20</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;timestamp&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;confidence_score&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Similarity Search Request:</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;image&quot;</span><span class="punctuation">:</span> <span class="string">&quot;base64_encoded_image_data&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;object_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;person&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;similarity_threshold&quot;</span><span class="punctuation">:</span> <span class="number">0.8</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;max_results&quot;</span><span class="punctuation">:</span> <span class="number">50</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;time_range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-01-01T00:00:00Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-01-31T23:59:59Z&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Message-Queue-Architecture"><a href="#Message-Queue-Architecture" class="headerlink" title="Message Queue Architecture"></a>Message Queue Architecture</h2><h3 id="Kafka-Topic-Design"><a href="#Kafka-Topic-Design" class="headerlink" title="Kafka Topic Design"></a>Kafka Topic Design</h3><p><strong>Topic Structure:</strong></p>
<ul>
<li><code>video-frames</code>: Raw frame data for analysis</li>
<li><code>analysis-results</code>: Structured analysis output</li>
<li><code>alerts</code>: Real-time alerts and notifications</li>
<li><code>system-metrics</code>: Performance and health metrics</li>
</ul>
<p><strong>Message Schema (Avro):</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;record&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AnalysisResult&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;messageId&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;timestamp&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cameraId&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;frameId&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;objects&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;array&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;record&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DetectedObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;objectType&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;boundingBox&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;confidence&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;float&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;attributes&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: Schema evolution is important in production systems. Use Avro or Protocol Buffers for backward compatibility when message formats change.</p>
<h2 id="Microservices-Configuration"><a href="#Microservices-Configuration" class="headerlink" title="Microservices Configuration"></a>Microservices Configuration</h2><h3 id="Spring-Cloud-Alibaba-Setup"><a href="#Spring-Cloud-Alibaba-Setup" class="headerlink" title="Spring Cloud Alibaba Setup"></a>Spring Cloud Alibaba Setup</h3><p><strong>Application Configuration:</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">video-analysis-platform</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">$&#123;NACOS_SERVER:localhost:8848&#125;</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">$&#123;NACOS_SERVER:localhost:8848&#125;</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">$&#123;SENTINEL_DASHBOARD:localhost:8080&#125;</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">streaming-service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://streaming-access-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/v1/streams/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">analysis-service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://structure-app-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/v1/analysis/**</span></span><br></pre></td></tr></table></figure>

<p><strong>Service Discovery:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableCircuitBreaker</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VideoAnalysisPlatformApplication</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Customizer&lt;Resilience4JCircuitBreakerFactory&gt; <span class="title function_">globalCustomConfiguration</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> factory -&gt; factory.configureDefault(id -&gt; <span class="keyword">new</span> <span class="title class_">Resilience4JConfigBuilder</span>(id)</span><br><span class="line">            .timeLimiterConfig(TimeLimiterConfig.custom()</span><br><span class="line">                .timeoutDuration(Duration.ofSeconds(<span class="number">10</span>))</span><br><span class="line">                .build())</span><br><span class="line">            .circuitBreakerConfig(CircuitBreakerConfig.custom()</span><br><span class="line">                .failureRateThreshold(<span class="number">50</span>)</span><br><span class="line">                .waitDurationInOpenState(Duration.ofMillis(<span class="number">1000</span>))</span><br><span class="line">                .slidingWindowSize(<span class="number">2</span>)</span><br><span class="line">                .build())</span><br><span class="line">            .build());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Frontend-Architecture"><a href="#Frontend-Architecture" class="headerlink" title="Frontend Architecture"></a>Frontend Architecture</h2><h3 id="Modern-React-based-UI"><a href="#Modern-React-based-UI" class="headerlink" title="Modern React-based UI"></a>Modern React-based UI</h3><p><strong>Key Components:</strong></p>
<ul>
<li>Camera Dashboard with real-time video feeds</li>
<li>Interactive map showing camera locations</li>
<li>Advanced search interface with filtering</li>
<li>Task management console</li>
<li>Real-time alerts and notifications</li>
<li>Analytics dashboard with charts and metrics</li>
</ul>
<p><strong>Technology Stack:</strong></p>
<ul>
<li>React 18 with TypeScript</li>
<li>Material-UI for component library</li>
<li>React Query for state management</li>
<li>Leaflet.js for mapping</li>
<li>Socket.io for real-time updates</li>
<li>Chart.js for data visualization</li>
</ul>
<p><strong>Map Integration Example:</strong></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">CameraMap</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> [cameras, setCameras] = <span class="title function_">useState</span>([]);</span><br><span class="line">  <span class="keyword">const</span> [selectedCamera, setSelectedCamera] = <span class="title function_">useState</span>(<span class="literal">null</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> socket = <span class="title function_">io</span>(<span class="string">&#x27;/camera-updates&#x27;</span>);</span><br><span class="line">    socket.<span class="title function_">on</span>(<span class="string">&#x27;camera-status&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">setCameras</span>(<span class="function"><span class="params">prev</span> =&gt;</span> <span class="title function_">updateCameraStatus</span>(prev, data));</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> socket.<span class="title function_">disconnect</span>();</span><br><span class="line">  &#125;, []);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">MapContainer</span> <span class="attr">center</span>=<span class="string">&#123;[40.7128,</span> <span class="attr">-74.0060</span>]&#125; <span class="attr">zoom</span>=<span class="string">&#123;13&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">TileLayer</span> <span class="attr">url</span>=<span class="string">&quot;https://&#123;s&#125;.tile.openstreetmap.org/&#123;z&#125;/&#123;x&#125;/&#123;y&#125;.png&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;cameras.map(camera =&gt; (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Marker</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">key</span>=<span class="string">&#123;camera.id&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">position</span>=<span class="string">&#123;[camera.lat,</span> <span class="attr">camera.lng</span>]&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setSelectedCamera(camera)&#125;</span></span><br><span class="line"><span class="language-xml">        &gt;</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Popup</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">CameraDetails</span> <span class="attr">camera</span>=<span class="string">&#123;camera&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">Popup</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Marker</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      ))&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">MapContainer</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Deployment-and-DevOps"><a href="#Deployment-and-DevOps" class="headerlink" title="Deployment and DevOps"></a>Deployment and DevOps</h2><h3 id="Docker-Configuration"><a href="#Docker-Configuration" class="headerlink" title="Docker Configuration"></a>Docker Configuration</h3><p><strong>Multi-stage Dockerfile for Analysis Service:</strong></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> nvidia/cuda:<span class="number">11.8</span>-devel-ubuntu20.<span class="number">04</span> as builder</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> requirements.txt .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install --no-cache-dir -r requirements.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> nvidia/cuda:<span class="number">11.8</span>-runtime-ubuntu20.<span class="number">04</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /usr/local/lib/python3.8/site-packages /usr/local/lib/python3.8/site-packages</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;python&quot;</span>, <span class="string">&quot;app.py&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p><strong>Kubernetes Deployment:</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">structure-app-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">structure-app-service</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">structure-app-service</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">structure-app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">video-analysis/structure-app:latest</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">nvidia.com/gpu:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;4Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">nvidia.com/gpu:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;8Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KAFKA_BROKERS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;kafka-cluster:9092&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">REDIS_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;redis-cluster:6379&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Performance-Optimization"><a href="#Performance-Optimization" class="headerlink" title="Performance Optimization"></a>Performance Optimization</h2><h3 id="Caching-Strategy"><a href="#Caching-Strategy" class="headerlink" title="Caching Strategy"></a>Caching Strategy</h3><p><strong>Multi-level Caching:</strong></p>
<ul>
<li>L1: Application-level cache using Caffeine</li>
<li>L2: Redis distributed cache for shared data</li>
<li>L3: ElasticSearch query result caching</li>
</ul>
<p><strong>Redis Cache Patterns:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Cacheable(value = &quot;camera-metadata&quot;, key = &quot;#cameraId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CameraMetadata <span class="title function_">getCameraMetadata</span><span class="params">(String cameraId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cameraRepository.findById(cameraId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@CacheEvict(value = &quot;search-results&quot;, allEntries = true)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">evictSearchCache</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Triggered when new analysis results are added</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Database-Optimization"><a href="#Database-Optimization" class="headerlink" title="Database Optimization"></a>Database Optimization</h3><p><strong>ElasticSearch Performance Tuning:</strong></p>
<ul>
<li>Use index templates for consistent mapping</li>
<li>Implement index lifecycle management (ILM)</li>
<li>Configure appropriate shard and replica counts</li>
<li>Use bulk operations for high-throughput indexing</li>
</ul>
<p><strong>Query Optimization:</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;camera_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;camera_001&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-01-01&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;lte&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-01-31&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;clothing.top_color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blue&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">20</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Monitoring-and-Observability"><a href="#Monitoring-and-Observability" class="headerlink" title="Monitoring and Observability"></a>Monitoring and Observability</h2><h3 id="Comprehensive-Monitoring-Stack"><a href="#Comprehensive-Monitoring-Stack" class="headerlink" title="Comprehensive Monitoring Stack"></a>Comprehensive Monitoring Stack</h3><p><strong>Key Metrics:</strong></p>
<ul>
<li>Frame processing throughput (frames&#x2F;second)</li>
<li>Analysis accuracy and confidence scores</li>
<li>System resource utilization (CPU, GPU, memory)</li>
<li>API response times and error rates</li>
<li>Kafka message lag and throughput</li>
</ul>
<p><strong>Prometheus Metrics:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MetricsCollector</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Counter</span> <span class="variable">framesProcessed</span> <span class="operator">=</span> Counter.build()</span><br><span class="line">        .name(<span class="string">&quot;frames_processed_total&quot;</span>)</span><br><span class="line">        .help(<span class="string">&quot;Total number of frames processed&quot;</span>)</span><br><span class="line">        .labelNames(<span class="string">&quot;camera_id&quot;</span>, <span class="string">&quot;status&quot;</span>)</span><br><span class="line">        .register();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Histogram</span> <span class="variable">analysisLatency</span> <span class="operator">=</span> Histogram.build()</span><br><span class="line">        .name(<span class="string">&quot;analysis_latency_seconds&quot;</span>)</span><br><span class="line">        .help(<span class="string">&quot;Time taken for frame analysis&quot;</span>)</span><br><span class="line">        .register();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordFrameProcessed</span><span class="params">(String cameraId, String status)</span> &#123;</span><br><span class="line">        framesProcessed.labels(cameraId, status).inc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: Observability is crucial in ML systems. Track both technical metrics (latency, throughput) and business metrics (accuracy, detection rates) to understand system health and model performance.</p>
<h2 id="Security-Considerations"><a href="#Security-Considerations" class="headerlink" title="Security Considerations"></a>Security Considerations</h2><h3 id="Multi-layered-Security-Approach"><a href="#Multi-layered-Security-Approach" class="headerlink" title="Multi-layered Security Approach"></a>Multi-layered Security Approach</h3><p><strong>Authentication and Authorization:</strong></p>
<ul>
<li>JWT-based authentication with refresh tokens</li>
<li>Role-based access control (RBAC)</li>
<li>API rate limiting and throttling</li>
<li>Secure video stream transmission using HTTPS&#x2F;WSS</li>
</ul>
<p><strong>Data Protection:</strong></p>
<ul>
<li>Encryption at rest for stored images and metadata</li>
<li>PII anonymization for privacy compliance</li>
<li>Audit logging for all system operations</li>
<li>Network segmentation between services</li>
</ul>
<p><strong>Security Configuration:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityFilterChain <span class="title function_">filterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">            .authorizeHttpRequests(authz -&gt; authz</span><br><span class="line">                .requestMatchers(<span class="string">&quot;/api/v1/public/**&quot;</span>).permitAll()</span><br><span class="line">                .requestMatchers(<span class="string">&quot;/api/v1/admin/**&quot;</span>).hasRole(<span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">            )</span><br><span class="line">            .oauth2ResourceServer(oauth2 -&gt; oauth2</span><br><span class="line">                .jwt(jwt -&gt; jwt.jwtDecoder(jwtDecoder()))</span><br><span class="line">            );</span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Scalability-and-Resilience"><a href="#Scalability-and-Resilience" class="headerlink" title="Scalability and Resilience"></a>Scalability and Resilience</h2><h3 id="Horizontal-Scaling-Strategies"><a href="#Horizontal-Scaling-Strategies" class="headerlink" title="Horizontal Scaling Strategies"></a>Horizontal Scaling Strategies</h3><p><strong>Auto-scaling Configuration:</strong></p>
<ul>
<li>HPA based on CPU, memory, and custom metrics</li>
<li>Vertical Pod Autoscaler for optimal resource allocation</li>
<li>Cluster autoscaling for node management</li>
<li>Geographic distribution for disaster recovery</li>
</ul>
<p><strong>Resilience Patterns:</strong></p>
<ul>
<li>Circuit breaker for external service calls</li>
<li>Retry mechanisms with exponential backoff</li>
<li>Bulkhead isolation for critical components</li>
<li>Graceful degradation during system overload</li>
</ul>
<p><strong>Load Balancing:</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">analysis-platform-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">analysis-platform</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">ClientIP</span></span><br></pre></td></tr></table></figure>

<h2 id="Production-Deployment-Checklist"><a href="#Production-Deployment-Checklist" class="headerlink" title="Production Deployment Checklist"></a>Production Deployment Checklist</h2><p><strong>Pre-deployment Validation:</strong></p>
<ul>
<li>Model accuracy testing with validation datasets</li>
<li>Performance benchmarking under expected load</li>
<li>Security penetration testing</li>
<li>Disaster recovery procedure validation</li>
<li>Database backup and restore testing</li>
</ul>
<p><strong>Monitoring Setup:</strong></p>
<ul>
<li>Alert rules for critical system metrics</li>
<li>Log aggregation and analysis</li>
<li>Performance dashboards</li>
<li>Health check endpoints</li>
<li>SLA monitoring and reporting</li>
</ul>
<p><strong>Interview Insight</strong>: Production readiness involves more than just functional requirements. Consider operational aspects like monitoring, alerting, backup strategies, and incident response procedures from the design phase.</p>
<p>This Video Image Structure Analysis Platform provides a robust, scalable solution for real-time video analysis with advanced object detection and attribute extraction capabilities. The microservices architecture ensures maintainability and scalability, while the comprehensive monitoring and security measures make it production-ready for large-scale deployments.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/16/Elasticsearch-Underlying-Principles-Deep-Dive/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/16/Elasticsearch-Underlying-Principles-Deep-Dive/" class="post-title-link" itemprop="url">Elasticsearch Underlying Principles Deep Dive</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-16 16:35:40 / Modified: 16:36:36" itemprop="dateCreated datePublished" datetime="2025-06-16T16:35:40+08:00">2025-06-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/elasticsearch/" itemprop="url" rel="index"><span itemprop="name">elasticsearch</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Understanding-Inverted-Index-The-Heart-of-Search"><a href="#Understanding-Inverted-Index-The-Heart-of-Search" class="headerlink" title="Understanding Inverted Index: The Heart of Search"></a>Understanding Inverted Index: The Heart of Search</h2><p>The inverted index is Elasticsearch’s fundamental data structure that enables lightning-fast full-text search. Unlike a traditional database index that maps record IDs to field values, an inverted index maps each unique term to a list of documents containing that term.</p>
<h3 id="How-Inverted-Index-Works"><a href="#How-Inverted-Index-Works" class="headerlink" title="How Inverted Index Works"></a>How Inverted Index Works</h3><p>Consider a simple example with three documents:</p>
<ul>
<li>Document 1: “The quick brown fox”</li>
<li>Document 2: “The brown dog”</li>
<li>Document 3: “A quick fox jumps”</li>
</ul>
<p>The inverted index would look like:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Term     | Document IDs | Positions</span><br><span class="line">---------|-------------|----------</span><br><span class="line">the      | [1, 2]      | [1:0, 2:0]</span><br><span class="line">quick    | [1, 3]      | [1:1, 3:1]</span><br><span class="line">brown    | [1, 2]      | [1:2, 2:1]</span><br><span class="line">fox      | [1, 3]      | [1:3, 3:2]</span><br><span class="line">dog      | [2]         | [2:2]</span><br><span class="line">a        | [3]         | [3:0]</span><br><span class="line">jumps    | [3]         | [3:3]</span><br></pre></td></tr></table></figure>

<h3 id="Implementation-Details"><a href="#Implementation-Details" class="headerlink" title="Implementation Details"></a>Implementation Details</h3><p>Elasticsearch implements inverted indexes using several sophisticated techniques:</p>
<p><strong>Term Dictionary</strong>: Stores all unique terms in sorted order<br><strong>Posting Lists</strong>: For each term, maintains a list of documents containing that term<br><strong>Term Frequencies</strong>: Tracks how often each term appears in each document<br><strong>Positional Information</strong>: Stores exact positions for phrase queries</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index_options&quot;</span><span class="punctuation">:</span> <span class="string">&quot;positions&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“Can you explain why Elasticsearch is faster than traditional SQL databases for text search?”</em> The answer lies in the inverted index structure - instead of scanning entire documents, Elasticsearch directly maps search terms to relevant documents.</p>
<h2 id="Text-vs-Keyword-Understanding-Field-Types"><a href="#Text-vs-Keyword-Understanding-Field-Types" class="headerlink" title="Text vs Keyword: Understanding Field Types"></a>Text vs Keyword: Understanding Field Types</h2><p>The distinction between Text and Keyword fields is crucial for proper data modeling and search behavior.</p>
<h3 id="Text-Fields"><a href="#Text-Fields" class="headerlink" title="Text Fields"></a>Text Fields</h3><p>Text fields are analyzed - they go through tokenization, normalization, and other transformations:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;product_description&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;keyword&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ignore_above&quot;</span><span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Analysis Process for Text Fields</strong>:</p>
<ol>
<li><strong>Tokenization</strong>: “iPhone 13 Pro Max” → [“iPhone”, “13”, “Pro”, “Max”]</li>
<li><strong>Lowercase Filter</strong>: [“iphone”, “13”, “pro”, “max”]</li>
<li><strong>Stop Words Removal</strong>: (if configured)</li>
<li><strong>Stemming</strong>: (if configured) [“iphon”, “13”, “pro”, “max”]</li>
</ol>
<h3 id="Keyword-Fields"><a href="#Keyword-Fields" class="headerlink" title="Keyword Fields"></a>Keyword Fields</h3><p>Keyword fields are stored as-is, without analysis:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;product_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Use-Cases-Comparison"><a href="#Use-Cases-Comparison" class="headerlink" title="Use Cases Comparison"></a>Use Cases Comparison</h3><table>
<thead>
<tr>
<th>Scenario</th>
<th>Text Field</th>
<th>Keyword Field</th>
</tr>
</thead>
<tbody><tr>
<td>Full-text search</td>
<td>✅ “search iPhone” matches “iPhone 13”</td>
<td>❌ Exact match only</td>
</tr>
<tr>
<td>Aggregations</td>
<td>❌ Analyzed terms cause issues</td>
<td>✅ Perfect for grouping</td>
</tr>
<tr>
<td>Sorting</td>
<td>❌ Unreliable due to analysis</td>
<td>✅ Lexicographic sorting</td>
</tr>
<tr>
<td>Exact matching</td>
<td>❌ “iPhone-13” ≠ “iPhone 13”</td>
<td>✅ “iPhone-13” &#x3D; “iPhone-13”</td>
</tr>
</tbody></table>
<p><strong>Interview Insight</strong>: <em>“When would you use multi-fields?”</em> Multi-fields allow the same data to be indexed in multiple ways - as both text (for search) and keyword (for aggregations and sorting).</p>
<h2 id="Posting-Lists-Trie-Trees-and-FST"><a href="#Posting-Lists-Trie-Trees-and-FST" class="headerlink" title="Posting Lists, Trie Trees, and FST"></a>Posting Lists, Trie Trees, and FST</h2><h3 id="Posting-Lists"><a href="#Posting-Lists" class="headerlink" title="Posting Lists"></a>Posting Lists</h3><p>Posting lists are the core data structure that stores document IDs for each term. Elasticsearch optimizes these lists using several techniques:</p>
<p><strong>Delta Compression</strong>: Instead of storing absolute document IDs, store differences:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Original: [1, 5, 8, 12, 15]</span><br><span class="line">Compressed: [1, +4, +3, +4, +3]</span><br></pre></td></tr></table></figure>

<p><strong>Variable Byte Encoding</strong>: Uses fewer bytes for smaller numbers<br><strong>Skip Lists</strong>: Enable faster intersection operations for AND queries</p>
<h3 id="Trie-Trees-Prefix-Trees"><a href="#Trie-Trees-Prefix-Trees" class="headerlink" title="Trie Trees (Prefix Trees)"></a>Trie Trees (Prefix Trees)</h3><p>Trie trees optimize prefix-based operations and are used in Elasticsearch for:</p>
<ul>
<li>Autocomplete functionality</li>
<li>Wildcard queries</li>
<li>Range queries on terms</li>
</ul>
<pre>
<code class="mermaid">
graph TD
A[Root] --&gt; B[c]
A --&gt; C[s]
B --&gt; D[a]
B --&gt; E[o]
D --&gt; F[r]
D --&gt; G[t]
F --&gt; H[car]
G --&gt; I[cat]
E --&gt; J[o]
J --&gt; K[cool]
C --&gt; L[u]
L --&gt; M[n]
M --&gt; N[sun]
</code>
</pre>

<h3 id="Finite-State-Transducers-FST"><a href="#Finite-State-Transducers-FST" class="headerlink" title="Finite State Transducers (FST)"></a>Finite State Transducers (FST)</h3><p>FST is Elasticsearch’s secret weapon for memory-efficient term dictionaries. It combines the benefits of tries with minimal memory usage.</p>
<p><strong>Benefits of FST</strong>:</p>
<ul>
<li><strong>Memory Efficient</strong>: Shares common prefixes and suffixes</li>
<li><strong>Fast Lookups</strong>: O(k) complexity where k is key length</li>
<li><strong>Ordered Iteration</strong>: Maintains lexicographic order</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;prefix&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;elastics&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“How does Elasticsearch handle memory efficiency for large vocabularies?”</em> FST allows Elasticsearch to store millions of terms using minimal memory by sharing common character sequences.</p>
<h2 id="Data-Writing-Process-in-Elasticsearch-Cluster"><a href="#Data-Writing-Process-in-Elasticsearch-Cluster" class="headerlink" title="Data Writing Process in Elasticsearch Cluster"></a>Data Writing Process in Elasticsearch Cluster</h2><p>Understanding the write path is crucial for optimizing indexing performance and ensuring data durability.</p>
<h3 id="Write-Process-Overview"><a href="#Write-Process-Overview" class="headerlink" title="Write Process Overview"></a>Write Process Overview</h3><pre>
<code class="mermaid">
sequenceDiagram
participant Client
participant Coordinating Node
participant Primary Shard
participant Replica Shard
participant Translog
participant Lucene

Client-&gt;&gt;Coordinating Node: Index Request
Coordinating Node-&gt;&gt;Primary Shard: Route to Primary
Primary Shard-&gt;&gt;Translog: Write to Translog
Primary Shard-&gt;&gt;Lucene: Add to In-Memory Buffer
Primary Shard-&gt;&gt;Replica Shard: Replicate to Replicas
Replica Shard-&gt;&gt;Translog: Write to Translog
Replica Shard-&gt;&gt;Lucene: Add to In-Memory Buffer
Primary Shard-&gt;&gt;Coordinating Node: Success Response
Coordinating Node-&gt;&gt;Client: Acknowledge
</code>
</pre>

<h3 id="Detailed-Write-Steps"><a href="#Detailed-Write-Steps" class="headerlink" title="Detailed Write Steps"></a>Detailed Write Steps</h3><p><strong>Step 1: Document Routing</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shard_id = <span class="built_in">hash</span>(routing_value) % number_of_primary_shards</span><br><span class="line"><span class="comment"># Default routing_value is document _id</span></span><br></pre></td></tr></table></figure>

<p><strong>Step 2: Primary Shard Processing</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;products&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_routing&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user123&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;iPhone 13&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">999</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;electronics&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Step 3: Translog Write</strong><br>The transaction log ensures durability before data reaches disk:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Translog configuration</span></span><br><span class="line">PUT /my_index/_settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;translog&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;sync_interval&quot;</span>: <span class="string">&quot;5s&quot;</span>,</span><br><span class="line">    <span class="string">&quot;durability&quot;</span>: <span class="string">&quot;request&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Step 4: Replication</strong><br>Documents are replicated to replica shards for high availability:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.write.wait_for_active_shards&quot;</span><span class="punctuation">:</span> <span class="string">&quot;all&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Write-Performance-Optimization"><a href="#Write-Performance-Optimization" class="headerlink" title="Write Performance Optimization"></a>Write Performance Optimization</h3><p><strong>Bulk Indexing Best Practices</strong>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;products&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Product 1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;products&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Product 2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Optimal Bulk Size</strong>: 5-15 MB per bulk request<br><strong>Thread Pool Tuning</strong>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">thread_pool:</span></span><br><span class="line">  <span class="attr">write:</span></span><br><span class="line">    <span class="attr">size:</span> <span class="number">8</span></span><br><span class="line">    <span class="attr">queue_size:</span> <span class="number">200</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“How would you optimize Elasticsearch for high write throughput?”</em> Key strategies include bulk indexing, increasing refresh intervals, using appropriate replica counts, and tuning thread pools.</p>
<h2 id="Refresh-Flush-and-Fsync-Operations"><a href="#Refresh-Flush-and-Fsync-Operations" class="headerlink" title="Refresh, Flush, and Fsync Operations"></a>Refresh, Flush, and Fsync Operations</h2><p>These operations manage the transition of data from memory to disk and control search visibility.</p>
<h3 id="Refresh-Operation"><a href="#Refresh-Operation" class="headerlink" title="Refresh Operation"></a>Refresh Operation</h3><p>Refresh makes documents searchable by moving them from the in-memory buffer to the filesystem cache.</p>
<pre>
<code class="mermaid">
graph LR
A[In-Memory Buffer] --&gt;|Refresh| B[Filesystem Cache]
B --&gt;|Flush| C[Disk Segments]
D[Translog] --&gt;|Flush| E[Disk]

subgraph &quot;Search Visible&quot;
    B
    C
end
</code>
</pre>

<p><strong>Refresh Configuration</strong>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30s&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.max_refresh_listeners&quot;</span><span class="punctuation">:</span> <span class="number">1000</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Manual Refresh</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /my_index/_refresh</span><br></pre></td></tr></table></figure>

<p><strong>Real-time Use Case</strong>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /logs/_doc/<span class="number">1</span>?refresh=<span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-01-15T10:30:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ERROR&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Database connection failed&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Flush-Operation"><a href="#Flush-Operation" class="headerlink" title="Flush Operation"></a>Flush Operation</h3><p>Flush persists the translog to disk and creates new Lucene segments.</p>
<p><strong>Flush Triggers</strong>:</p>
<ul>
<li>Translog size exceeds threshold (default: 512MB)</li>
<li>Translog age exceeds threshold (default: 30 minutes)</li>
<li>Manual flush operation</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;translog.flush_threshold_size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1gb&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;translog.sync_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5s&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;translog.durability&quot;</span><span class="punctuation">:</span> <span class="string">&quot;request&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Manual Flush</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /my_index/_flush</span><br><span class="line">POST /_flush?wait_if_ongoing=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="Fsync-Operation"><a href="#Fsync-Operation" class="headerlink" title="Fsync Operation"></a>Fsync Operation</h3><p>Fsync ensures data is physically written to disk storage.</p>
<p><strong>Fsync Configuration</strong>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;translog.durability&quot;</span><span class="punctuation">:</span> <span class="string">&quot;async&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;translog.sync_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5s&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Performance-Impact-Analysis"><a href="#Performance-Impact-Analysis" class="headerlink" title="Performance Impact Analysis"></a>Performance Impact Analysis</h3><table>
<thead>
<tr>
<th>Operation</th>
<th>Frequency</th>
<th>Performance Impact</th>
<th>Data Safety</th>
</tr>
</thead>
<tbody><tr>
<td>Refresh</td>
<td>High (1s default)</td>
<td>Medium</td>
<td>No durability</td>
</tr>
<tr>
<td>Flush</td>
<td>Low (30m or 512MB)</td>
<td>High</td>
<td>Full durability</td>
</tr>
<tr>
<td>Fsync</td>
<td>Configurable</td>
<td>High</td>
<td>Hardware dependent</td>
</tr>
</tbody></table>
<h3 id="Production-Best-Practices"><a href="#Production-Best-Practices" class="headerlink" title="Production Best Practices"></a>Production Best Practices</h3><p><strong>High Throughput Indexing</strong>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;60s&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;translog.durability&quot;</span><span class="punctuation">:</span> <span class="string">&quot;async&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;translog.sync_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30s&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Near Real-time Search</strong>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1s&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;translog.durability&quot;</span><span class="punctuation">:</span> <span class="string">&quot;request&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>“Explain the trade-offs between search latency and indexing performance.”</em> Frequent refreshes provide near real-time search but impact indexing throughput. Adjust refresh_interval based on your use case - use longer intervals for high-volume indexing and shorter for real-time requirements.</p>
<h2 id="Advanced-Concepts-and-Optimizations"><a href="#Advanced-Concepts-and-Optimizations" class="headerlink" title="Advanced Concepts and Optimizations"></a>Advanced Concepts and Optimizations</h2><h3 id="Segment-Merging"><a href="#Segment-Merging" class="headerlink" title="Segment Merging"></a>Segment Merging</h3><p>Elasticsearch continuously merges smaller segments into larger ones:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;index.merge.policy.max_merge_at_once&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.merge.policy.segments_per_tier&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index.merge.scheduler.max_thread_count&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Force-Merge-for-Read-Only-Indices"><a href="#Force-Merge-for-Read-Only-Indices" class="headerlink" title="Force Merge for Read-Only Indices"></a>Force Merge for Read-Only Indices</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /old_logs/_forcemerge?max_num_segments=1</span><br></pre></td></tr></table></figure>

<h3 id="Circuit-Breakers"><a href="#Circuit-Breakers" class="headerlink" title="Circuit Breakers"></a>Circuit Breakers</h3><p>Prevent OutOfMemory errors during operations:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;persistent&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;indices.breaker.total.limit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;70%&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;indices.breaker.fielddata.limit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;40%&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;indices.breaker.request.limit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30%&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Monitoring-and-Troubleshooting"><a href="#Monitoring-and-Troubleshooting" class="headerlink" title="Monitoring and Troubleshooting"></a>Monitoring and Troubleshooting</h2><h3 id="Key-Metrics-to-Monitor"><a href="#Key-Metrics-to-Monitor" class="headerlink" title="Key Metrics to Monitor"></a>Key Metrics to Monitor</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Index stats</span></span><br><span class="line">GET /_stats/indexing,search,merge,refresh,flush</span><br><span class="line"></span><br><span class="line"><span class="comment"># Segment information</span></span><br><span class="line">GET /my_index/_segments</span><br><span class="line"></span><br><span class="line"><span class="comment"># Translog stats</span></span><br><span class="line">GET /_stats/translog</span><br></pre></td></tr></table></figure>

<h3 id="Common-Issues-and-Solutions"><a href="#Common-Issues-and-Solutions" class="headerlink" title="Common Issues and Solutions"></a>Common Issues and Solutions</h3><p><strong>Slow Indexing</strong>:</p>
<ul>
<li>Check bulk request size</li>
<li>Monitor merge operations</li>
<li>Verify disk I&#x2F;O capacity</li>
</ul>
<p><strong>Memory Issues</strong>:</p>
<ul>
<li>Implement proper mapping</li>
<li>Use appropriate field types</li>
<li>Monitor fielddata usage</li>
</ul>
<p><strong>Search Latency</strong>:</p>
<ul>
<li>Optimize queries</li>
<li>Check segment count</li>
<li>Monitor cache hit rates</li>
</ul>
<h2 id="Interview-Questions-Deep-Dive"><a href="#Interview-Questions-Deep-Dive" class="headerlink" title="Interview Questions Deep Dive"></a>Interview Questions Deep Dive</h2><p><strong>Q: “How does Elasticsearch achieve near real-time search?”</strong><br>A: Through the refresh operation that moves documents from in-memory buffers to searchable filesystem cache, typically every 1 second by default.</p>
<p><strong>Q: “What happens when a primary shard fails during indexing?”</strong><br>A: Elasticsearch promotes a replica shard to primary, replays the translog, and continues operations. The cluster remains functional with potential brief unavailability.</p>
<p><strong>Q: “How would you design an Elasticsearch cluster for a high-write, low-latency application?”</strong><br>A: Focus on horizontal scaling, optimize bulk operations, increase refresh intervals during high-write periods, use appropriate replica counts, and implement proper monitoring.</p>
<p><strong>Q: “Explain the memory implications of text vs keyword fields.”</strong><br>A: Text fields consume more memory during analysis and create larger inverted indexes. Keyword fields are more memory-efficient for exact-match scenarios and aggregations.</p>
<h2 id="External-References"><a href="#External-References" class="headerlink" title="External References"></a>External References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/">Elasticsearch Official Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://lucene.apache.org/core/8_11_0/core/org/apache/lucene/search/similarities/TFIDFSimilarity.html">Lucene Scoring Algorithm</a></li>
<li><a target="_blank" rel="noopener" href="https://citeseerx.ist.psu.edu/document?repid=rep1&type=pdf&doi=10.1.1.24.3698">Finite State Transducers Research Paper</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/tune-for-indexing-speed.html">Elasticsearch Performance Tuning Guide</a></li>
</ul>
<hr>
<p><em>This deep dive covers the fundamental concepts that power Elasticsearch’s search capabilities. Understanding these principles is essential for building scalable, performant search applications and succeeding in technical interviews.</em></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Charlie Feng</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
