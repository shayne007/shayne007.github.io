<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"shayne007.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="This place is for thinking and sharing.">
<meta property="og:type" content="website">
<meta property="og:title" content="Charlie Feng&#39;s Tech Space">
<meta property="og:url" content="https://shayne007.github.io/index.html">
<meta property="og:site_name" content="Charlie Feng&#39;s Tech Space">
<meta property="og:description" content="This place is for thinking and sharing.">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Charlie Feng">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://shayne007.github.io/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Charlie Feng's Tech Space</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"cdn":false,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.5.0/mermaid.min.js","integrity":"sha256-2obLuIPcceEhkE3G09G33hBdmE55ivVcZUlcKcGNHjU="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>





  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Charlie Feng's Tech Space</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">You will survive with skills</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Charlie Feng</p>
  <div class="site-description" itemprop="description">This place is for thinking and sharing.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/09/12/Design-File-Storage-Service-wiht-Frontend-chunking/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/09/12/Design-File-Storage-Service-wiht-Frontend-chunking/" class="post-title-link" itemprop="url">Design File Storage Service wiht Frontend chunking</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-09-12 00:19:55 / Modified: 00:26:51" itemprop="dateCreated datePublished" datetime="2025-09-12T00:19:55+08:00">2025-09-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system-design/" itemprop="url" rel="index"><span itemprop="name">system-design</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="File-Storage-Service-Design-Guide"><a href="#File-Storage-Service-Design-Guide" class="headerlink" title="File Storage Service Design Guide"></a>File Storage Service Design Guide</h1><h2 id="System-Architecture-Overview"><a href="#System-Architecture-Overview" class="headerlink" title="System Architecture Overview"></a>System Architecture Overview</h2><p>A production-ready File Storage Service requires careful consideration of scalability, reliability, security, and performance. This service acts as a centralized file management system that abstracts the complexity of cloud storage while providing rich metadata capabilities through PostgreSQL.</p>
<pre>
<code class="mermaid">
graph TB
A[Client Applications] --&gt; B[Load Balancer]
B --&gt; C[File Storage API Gateway]
C --&gt; D[File Storage Service Cluster]
D --&gt; E[PostgreSQL Cluster]
D --&gt; F[Google Cloud Storage]
D --&gt; G[Redis Cache]
H[File Storage SDK] --&gt; C
I[Monitoring &amp; Logging] --&gt; D
J[CDN] --&gt; F
</code>
</pre>

<p>The architecture follows a microservices pattern where the File Storage Service is independently deployable and scalable. The service handles both file operations and metadata management, ensuring data consistency and providing high availability.</p>
<p><strong>Interview Insight</strong>: <em>When asked about system architecture decisions, emphasize the separation of concerns - metadata in PostgreSQL for complex queries and actual files in GCS for scalability and durability.</em></p>
<h2 id="Database-Schema-Design"><a href="#Database-Schema-Design" class="headerlink" title="Database Schema Design"></a>Database Schema Design</h2><p>The PostgreSQL schema is designed to support various file types, track upload progress for chunked uploads, and maintain audit trails.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Files table for storing file metadata</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> files (</span><br><span class="line">    id UUID <span class="keyword">PRIMARY KEY</span> <span class="keyword">DEFAULT</span> gen_random_uuid(),</span><br><span class="line">    filename <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    original_filename <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    file_size <span class="type">BIGINT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    mime_type <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    file_hash <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT NULL</span>, <span class="comment">-- SHA-256 hash for deduplication</span></span><br><span class="line">    gcs_bucket <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    gcs_object_key <span class="type">VARCHAR</span>(<span class="number">500</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    upload_status <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;PENDING&#x27;</span>, <span class="comment">-- PENDING, UPLOADING, COMPLETED, FAILED</span></span><br><span class="line">    created_by UUID <span class="keyword">NOT NULL</span>,</span><br><span class="line">    project_id UUID,</span><br><span class="line">    tags JSONB,</span><br><span class="line">    metadata JSONB, <span class="comment">-- Extensible metadata storage</span></span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">WITH</span> <span class="type">TIME</span> ZONE <span class="keyword">DEFAULT</span> NOW(),</span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span> <span class="keyword">WITH</span> <span class="type">TIME</span> ZONE <span class="keyword">DEFAULT</span> NOW(),</span><br><span class="line">    expires_at <span class="type">TIMESTAMP</span> <span class="keyword">WITH</span> <span class="type">TIME</span> ZONE, <span class="comment">-- For temporary files</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">CONSTRAINT</span> valid_upload_status <span class="keyword">CHECK</span> (upload_status <span class="keyword">IN</span> (<span class="string">&#x27;PENDING&#x27;</span>, <span class="string">&#x27;UPLOADING&#x27;</span>, <span class="string">&#x27;COMPLETED&#x27;</span>, <span class="string">&#x27;FAILED&#x27;</span>))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Chunked uploads table for managing large file uploads</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> chunked_uploads (</span><br><span class="line">    id UUID <span class="keyword">PRIMARY KEY</span> <span class="keyword">DEFAULT</span> gen_random_uuid(),</span><br><span class="line">    file_id UUID <span class="keyword">REFERENCES</span> files(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE,</span><br><span class="line">    upload_id <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT NULL</span>, <span class="comment">-- GCS multipart upload ID</span></span><br><span class="line">    total_chunks <span class="type">INTEGER</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    completed_chunks <span class="type">INTEGER</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    chunk_size <span class="type">INTEGER</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">WITH</span> <span class="type">TIME</span> ZONE <span class="keyword">DEFAULT</span> NOW(),</span><br><span class="line">    expires_at <span class="type">TIMESTAMP</span> <span class="keyword">WITH</span> <span class="type">TIME</span> ZONE <span class="keyword">NOT NULL</span> <span class="comment">-- Cleanup incomplete uploads</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Chunks table for tracking individual chunk uploads</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> chunks (</span><br><span class="line">    id UUID <span class="keyword">PRIMARY KEY</span> <span class="keyword">DEFAULT</span> gen_random_uuid(),</span><br><span class="line">    chunked_upload_id UUID <span class="keyword">REFERENCES</span> chunked_uploads(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE,</span><br><span class="line">    chunk_number <span class="type">INTEGER</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    chunk_size <span class="type">INTEGER</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    etag <span class="type">VARCHAR</span>(<span class="number">255</span>), <span class="comment">-- GCS ETag for the chunk</span></span><br><span class="line">    uploaded_at <span class="type">TIMESTAMP</span> <span class="keyword">WITH</span> <span class="type">TIME</span> ZONE,</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">UNIQUE</span>(chunked_upload_id, chunk_number)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- File access logs for audit and analytics</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> file_access_logs (</span><br><span class="line">    id UUID <span class="keyword">PRIMARY KEY</span> <span class="keyword">DEFAULT</span> gen_random_uuid(),</span><br><span class="line">    file_id UUID <span class="keyword">REFERENCES</span> files(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">SET</span> <span class="keyword">NULL</span>,</span><br><span class="line">    access_type <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span>, <span class="comment">-- UPLOAD, DOWNLOAD, DELETE, VIEW</span></span><br><span class="line">    user_id UUID <span class="keyword">NOT NULL</span>,</span><br><span class="line">    ip_address INET,</span><br><span class="line">    user_agent TEXT,</span><br><span class="line">    accessed_at <span class="type">TIMESTAMP</span> <span class="keyword">WITH</span> <span class="type">TIME</span> ZONE <span class="keyword">DEFAULT</span> NOW()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Indexes for performance</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_files_project_id <span class="keyword">ON</span> files(project_id);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_files_created_by <span class="keyword">ON</span> files(created_by);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_files_file_hash <span class="keyword">ON</span> files(file_hash);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_files_upload_status <span class="keyword">ON</span> files(upload_status);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_files_created_at <span class="keyword">ON</span> files(created_at <span class="keyword">DESC</span>);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_chunked_uploads_file_id <span class="keyword">ON</span> chunked_uploads(file_id);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_chunks_chunked_upload_id <span class="keyword">ON</span> chunks(chunked_upload_id);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_file_access_logs_file_id <span class="keyword">ON</span> file_access_logs(file_id);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_file_access_logs_user_id <span class="keyword">ON</span> file_access_logs(user_id);</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>The schema design demonstrates understanding of ACID properties, referential integrity, and performance optimization. The JSONB fields provide flexibility while maintaining query performance.</em></p>
<h2 id="Core-Service-Implementation"><a href="#Core-Service-Implementation" class="headerlink" title="Core Service Implementation"></a>Core Service Implementation</h2><h3 id="File-Service-Interface"><a href="#File-Service-Interface" class="headerlink" title="File Service Interface"></a>File Service Interface</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FileStorageService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initiate a single file upload</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    FileUploadResponse <span class="title function_">uploadFile</span><span class="params">(FileUploadRequest request)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initiate a chunked upload for large files</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ChunkedUploadResponse <span class="title function_">initiateChunkedUpload</span><span class="params">(ChunkedUploadRequest request)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Upload a single chunk</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ChunkUploadResponse <span class="title function_">uploadChunk</span><span class="params">(ChunkUploadRequest request)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Complete chunked upload</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    FileUploadResponse <span class="title function_">completeChunkedUpload</span><span class="params">(CompleteChunkedUploadRequest request)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Generate signed download URL</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    FileDownloadResponse <span class="title function_">getDownloadUrl</span><span class="params">(String fileId, Duration expiration)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Query files with filtering and pagination</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    FileQueryResponse <span class="title function_">queryFiles</span><span class="params">(FileQueryRequest request)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Delete a file</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deleteFile</span><span class="params">(String fileId, String userId)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get file metadata</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    FileMetadata <span class="title function_">getFileMetadata</span><span class="params">(String fileId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="File-Storage-Service-Implementation"><a href="#File-Storage-Service-Implementation" class="headerlink" title="File Storage Service Implementation"></a>File Storage Service Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">FileStorageService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileRepository fileRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChunkedUploadRepository chunkedUploadRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GcsStorageClient gcsClient;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileAccessLogger accessLogger;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FileUploadResponse <span class="title function_">uploadFile</span><span class="params">(FileUploadRequest request)</span> &#123;</span><br><span class="line">        validateUploadRequest(request);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check for file deduplication</span></span><br><span class="line">        Optional&lt;FileEntity&gt; existingFile = fileRepository</span><br><span class="line">            .findByFileHashAndProjectId(request.getFileHash(), request.getProjectId());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (existingFile.isPresent() &amp;&amp; request.isAllowDeduplication()) &#123;</span><br><span class="line">            <span class="keyword">return</span> createDeduplicationResponse(existingFile.get());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Create file entity</span></span><br><span class="line">        <span class="type">FileEntity</span> <span class="variable">fileEntity</span> <span class="operator">=</span> FileEntity.builder()</span><br><span class="line">            .filename(generateUniqueFilename(request.getOriginalFilename()))</span><br><span class="line">            .originalFilename(request.getOriginalFilename())</span><br><span class="line">            .fileSize(request.getFileSize())</span><br><span class="line">            .mimeType(request.getMimeType())</span><br><span class="line">            .fileHash(request.getFileHash())</span><br><span class="line">            .gcsBucket(gcsClient.getDefaultBucket())</span><br><span class="line">            .gcsObjectKey(generateObjectKey(request))</span><br><span class="line">            .uploadStatus(UploadStatus.PENDING)</span><br><span class="line">            .createdBy(request.getUserId())</span><br><span class="line">            .projectId(request.getProjectId())</span><br><span class="line">            .tags(request.getTags())</span><br><span class="line">            .metadata(request.getMetadata())</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        fileEntity = fileRepository.save(fileEntity);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Generate signed upload URL</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">signedUrl</span> <span class="operator">=</span> gcsClient.generateSignedUploadUrl(</span><br><span class="line">                fileEntity.getGcsBucket(),</span><br><span class="line">                fileEntity.getGcsObjectKey(),</span><br><span class="line">                request.getMimeType(),</span><br><span class="line">                Duration.ofHours(<span class="number">1</span>)</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Cache upload session</span></span><br><span class="line">            cacheUploadSession(fileEntity.getId(), request.getUserId());</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> FileUploadResponse.builder()</span><br><span class="line">                .fileId(fileEntity.getId())</span><br><span class="line">                .uploadUrl(signedUrl)</span><br><span class="line">                .expiresAt(Instant.now().plus(Duration.ofHours(<span class="number">1</span>)))</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            fileEntity.setUploadStatus(UploadStatus.FAILED);</span><br><span class="line">            fileRepository.save(fileEntity);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileUploadException</span>(<span class="string">&quot;Failed to generate upload URL&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ChunkedUploadResponse <span class="title function_">initiateChunkedUpload</span><span class="params">(ChunkedUploadRequest request)</span> &#123;</span><br><span class="line">        validateChunkedUploadRequest(request);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Create file entity</span></span><br><span class="line">        <span class="type">FileEntity</span> <span class="variable">fileEntity</span> <span class="operator">=</span> createFileEntity(request);</span><br><span class="line">        fileEntity = fileRepository.save(fileEntity);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Initiate multipart upload in GCS</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">uploadId</span> <span class="operator">=</span> gcsClient.initiateMultipartUpload(</span><br><span class="line">                fileEntity.getGcsBucket(),</span><br><span class="line">                fileEntity.getGcsObjectKey(),</span><br><span class="line">                request.getMimeType()</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Create chunked upload entity</span></span><br><span class="line">            <span class="type">ChunkedUploadEntity</span> <span class="variable">chunkedUpload</span> <span class="operator">=</span> ChunkedUploadEntity.builder()</span><br><span class="line">                .fileId(fileEntity.getId())</span><br><span class="line">                .uploadId(uploadId)</span><br><span class="line">                .totalChunks(request.getTotalChunks())</span><br><span class="line">                .chunkSize(request.getChunkSize())</span><br><span class="line">                .expiresAt(Instant.now().plus(Duration.ofDays(<span class="number">1</span>)))</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">            chunkedUpload = chunkedUploadRepository.save(chunkedUpload);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> ChunkedUploadResponse.builder()</span><br><span class="line">                .fileId(fileEntity.getId())</span><br><span class="line">                .uploadId(chunkedUpload.getId())</span><br><span class="line">                .expiresAt(chunkedUpload.getExpiresAt())</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            fileEntity.setUploadStatus(UploadStatus.FAILED);</span><br><span class="line">            fileRepository.save(fileEntity);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileUploadException</span>(<span class="string">&quot;Failed to initiate chunked upload&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ChunkUploadResponse <span class="title function_">uploadChunk</span><span class="params">(ChunkUploadRequest request)</span> &#123;</span><br><span class="line">        <span class="type">ChunkedUploadEntity</span> <span class="variable">chunkedUpload</span> <span class="operator">=</span> chunkedUploadRepository</span><br><span class="line">            .findById(request.getUploadId())</span><br><span class="line">            .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">ChunkedUploadNotFoundException</span>(<span class="string">&quot;Upload not found&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        validateChunkUploadRequest(request, chunkedUpload);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Generate signed URL for chunk upload</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">signedUrl</span> <span class="operator">=</span> gcsClient.generateSignedChunkUploadUrl(</span><br><span class="line">                chunkedUpload.getUploadId(),</span><br><span class="line">                request.getChunkNumber(),</span><br><span class="line">                Duration.ofHours(<span class="number">1</span>)</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> ChunkUploadResponse.builder()</span><br><span class="line">                .chunkUploadUrl(signedUrl)</span><br><span class="line">                .expiresAt(Instant.now().plus(Duration.ofHours(<span class="number">1</span>)))</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ChunkUploadException</span>(<span class="string">&quot;Failed to generate chunk upload URL&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FileDownloadResponse <span class="title function_">getDownloadUrl</span><span class="params">(String fileId, Duration expiration)</span> &#123;</span><br><span class="line">        <span class="type">FileEntity</span> <span class="variable">fileEntity</span> <span class="operator">=</span> fileRepository.findById(UUID.fromString(fileId))</span><br><span class="line">            .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">FileNotFoundException</span>(<span class="string">&quot;File not found&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (fileEntity.getUploadStatus() != UploadStatus.COMPLETED) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileNotAvailableException</span>(<span class="string">&quot;File is not available for download&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">signedUrl</span> <span class="operator">=</span> gcsClient.generateSignedDownloadUrl(</span><br><span class="line">                fileEntity.getGcsBucket(),</span><br><span class="line">                fileEntity.getGcsObjectKey(),</span><br><span class="line">                expiration</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Log access</span></span><br><span class="line">            accessLogger.logAccess(fileId, AccessType.DOWNLOAD);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> FileDownloadResponse.builder()</span><br><span class="line">                .downloadUrl(signedUrl)</span><br><span class="line">                .filename(fileEntity.getOriginalFilename())</span><br><span class="line">                .fileSize(fileEntity.getFileSize())</span><br><span class="line">                .mimeType(fileEntity.getMimeType())</span><br><span class="line">                .expiresAt(Instant.now().plus(expiration))</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileDownloadException</span>(<span class="string">&quot;Failed to generate download URL&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>This implementation demonstrates proper error handling, transaction management, and separation of concerns. The use of signed URLs ensures security while offloading bandwidth from your servers.</em></p>
<h2 id="API-Endpoints-Design"><a href="#API-Endpoints-Design" class="headerlink" title="API Endpoints Design"></a>API Endpoints Design</h2><h3 id="REST-API-Specification"><a href="#REST-API-Specification" class="headerlink" title="REST API Specification"></a>REST API Specification</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/v1/files&quot;)</span></span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileStorageService fileStorageService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Upload a single file (&lt; 10MB)</span></span><br><span class="line"><span class="comment">     * POST /api/v1/files/upload</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;FileUploadResponse&gt; <span class="title function_">uploadFile</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@Valid</span> <span class="meta">@RequestBody</span> FileUploadRequest request)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">FileUploadResponse</span> <span class="variable">response</span> <span class="operator">=</span> fileStorageService.uploadFile(request);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initiate chunked upload for large files</span></span><br><span class="line"><span class="comment">     * POST /api/v1/files/upload/chunked</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload/chunked&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;ChunkedUploadResponse&gt; <span class="title function_">initiateChunkedUpload</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@Valid</span> <span class="meta">@RequestBody</span> ChunkedUploadRequest request)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">ChunkedUploadResponse</span> <span class="variable">response</span> <span class="operator">=</span> fileStorageService.initiateChunkedUpload(request);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.CREATED).body(response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get upload URL for a specific chunk</span></span><br><span class="line"><span class="comment">     * POST /api/v1/files/upload/chunked/&#123;uploadId&#125;/chunks/&#123;chunkNumber&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload/chunked/&#123;uploadId&#125;/chunks/&#123;chunkNumber&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;ChunkUploadResponse&gt; <span class="title function_">getChunkUploadUrl</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String uploadId,</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> Integer chunkNumber)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">ChunkUploadRequest</span> <span class="variable">request</span> <span class="operator">=</span> ChunkUploadRequest.builder()</span><br><span class="line">            .uploadId(uploadId)</span><br><span class="line">            .chunkNumber(chunkNumber)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="type">ChunkUploadResponse</span> <span class="variable">response</span> <span class="operator">=</span> fileStorageService.uploadChunk(request);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Complete chunked upload</span></span><br><span class="line"><span class="comment">     * POST /api/v1/files/upload/chunked/&#123;uploadId&#125;/complete</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload/chunked/&#123;uploadId&#125;/complete&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;FileUploadResponse&gt; <span class="title function_">completeChunkedUpload</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String uploadId,</span></span><br><span class="line"><span class="params">            <span class="meta">@Valid</span> <span class="meta">@RequestBody</span> CompleteChunkedUploadRequest request)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        request.setUploadId(uploadId);</span><br><span class="line">        <span class="type">FileUploadResponse</span> <span class="variable">response</span> <span class="operator">=</span> fileStorageService.completeChunkedUpload(request);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get file download URL</span></span><br><span class="line"><span class="comment">     * GET /api/v1/files/&#123;fileId&#125;/download</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;fileId&#125;/download&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;FileDownloadResponse&gt; <span class="title function_">getDownloadUrl</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String fileId,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(defaultValue = &quot;3600&quot;)</span> Long expirationSeconds)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">Duration</span> <span class="variable">expiration</span> <span class="operator">=</span> Duration.ofSeconds(expirationSeconds);</span><br><span class="line">        <span class="type">FileDownloadResponse</span> <span class="variable">response</span> <span class="operator">=</span> fileStorageService.getDownloadUrl(fileId, expiration);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Query files with filtering and pagination</span></span><br><span class="line"><span class="comment">     * GET /api/v1/files</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;FileQueryResponse&gt; <span class="title function_">queryFiles</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(required = false)</span> String projectId,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(required = false)</span> List&lt;String&gt; mimeTypes,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(required = false)</span> String createdBy,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(required = false)</span> <span class="meta">@DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME)</span> Instant createdAfter,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(required = false)</span> <span class="meta">@DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME)</span> Instant createdBefore,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(defaultValue = &quot;0&quot;)</span> Integer page,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(defaultValue = &quot;20&quot;)</span> Integer size,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(defaultValue = &quot;createdAt,desc&quot;)</span> String sort)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">FileQueryRequest</span> <span class="variable">request</span> <span class="operator">=</span> FileQueryRequest.builder()</span><br><span class="line">            .projectId(projectId)</span><br><span class="line">            .mimeTypes(mimeTypes)</span><br><span class="line">            .createdBy(createdBy)</span><br><span class="line">            .createdAfter(createdAfter)</span><br><span class="line">            .createdBefore(createdBefore)</span><br><span class="line">            .page(page)</span><br><span class="line">            .size(size)</span><br><span class="line">            .sort(sort)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="type">FileQueryResponse</span> <span class="variable">response</span> <span class="operator">=</span> fileStorageService.queryFiles(request);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get file metadata</span></span><br><span class="line"><span class="comment">     * GET /api/v1/files/&#123;fileId&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;fileId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;FileMetadata&gt; <span class="title function_">getFileMetadata</span><span class="params">(<span class="meta">@PathVariable</span> String fileId)</span> &#123;</span><br><span class="line">        <span class="type">FileMetadata</span> <span class="variable">metadata</span> <span class="operator">=</span> fileStorageService.getFileMetadata(fileId);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(metadata);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Delete file</span></span><br><span class="line"><span class="comment">     * DELETE /api/v1/files/&#123;fileId&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/&#123;fileId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Void&gt; <span class="title function_">deleteFile</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String fileId,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestHeader(&quot;X-User-Id&quot;)</span> String userId)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        fileStorageService.deleteFile(fileId, userId);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.noContent().build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="API-Request-Response-Models"><a href="#API-Request-Response-Models" class="headerlink" title="API Request&#x2F;Response Models"></a>API Request&#x2F;Response Models</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Request models</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileUploadRequest</span> &#123;</span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Size(min = 1, max = 255)</span></span><br><span class="line">    <span class="keyword">private</span> String originalFilename;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Min(1)</span></span><br><span class="line">    <span class="keyword">private</span> Long fileSize;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Size(min = 1, max = 100)</span></span><br><span class="line">    <span class="keyword">private</span> String mimeType;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Size(min = 64, max = 64)</span></span><br><span class="line">    <span class="keyword">private</span> String fileHash; <span class="comment">// SHA-256</span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="keyword">private</span> String userId;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String projectId;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Valid</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; tags;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Valid</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; metadata;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Builder</span>.Default</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Boolean</span> <span class="variable">allowDeduplication</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChunkedUploadRequest</span> &#123;</span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Size(min = 1, max = 255)</span></span><br><span class="line">    <span class="keyword">private</span> String originalFilename;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Min(1)</span></span><br><span class="line">    <span class="keyword">private</span> Long fileSize;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Size(min = 1, max = 100)</span></span><br><span class="line">    <span class="keyword">private</span> String mimeType;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Size(min = 64, max = 64)</span></span><br><span class="line">    <span class="keyword">private</span> String fileHash;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="keyword">private</span> String userId;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String projectId;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Min(2)</span></span><br><span class="line">    <span class="meta">@Max(10000)</span></span><br><span class="line">    <span class="keyword">private</span> Integer totalChunks;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Min(1048576)</span> <span class="comment">// 1MB minimum</span></span><br><span class="line">    <span class="meta">@Max(104857600)</span> <span class="comment">// 100MB maximum</span></span><br><span class="line">    <span class="keyword">private</span> Integer chunkSize;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; tags;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; metadata;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Response models</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileUploadResponse</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String fileId;</span><br><span class="line">    <span class="keyword">private</span> String uploadUrl;</span><br><span class="line">    <span class="keyword">private</span> Instant expiresAt;</span><br><span class="line">    <span class="keyword">private</span> Boolean isDuplicate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChunkedUploadResponse</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String fileId;</span><br><span class="line">    <span class="keyword">private</span> String uploadId;</span><br><span class="line">    <span class="keyword">private</span> Instant expiresAt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileDownloadResponse</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String downloadUrl;</span><br><span class="line">    <span class="keyword">private</span> String filename;</span><br><span class="line">    <span class="keyword">private</span> Long fileSize;</span><br><span class="line">    <span class="keyword">private</span> String mimeType;</span><br><span class="line">    <span class="keyword">private</span> Instant expiresAt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="File-Storage-SDK-Implementation"><a href="#File-Storage-SDK-Implementation" class="headerlink" title="File Storage SDK Implementation"></a>File Storage SDK Implementation</h2><h3 id="SDK-Architecture"><a href="#SDK-Architecture" class="headerlink" title="SDK Architecture"></a>SDK Architecture</h3><p>The SDK provides a clean abstraction layer for client applications, handling authentication, retries, and error handling automatically.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageSDK</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileStorageClient client;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RetryPolicy retryPolicy;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthenticationProvider authProvider;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FileStorageSDK</span><span class="params">(FileStorageConfig config)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.client = <span class="keyword">new</span> <span class="title class_">FileStorageClient</span>(config);</span><br><span class="line">        <span class="built_in">this</span>.retryPolicy = createRetryPolicy(config);</span><br><span class="line">        <span class="built_in">this</span>.authProvider = <span class="keyword">new</span> <span class="title class_">AuthenticationProvider</span>(config);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Upload a single file</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;FileUploadResult&gt; <span class="title function_">uploadFile</span><span class="params">(File file, UploadOptions options)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                validateFile(file);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (file.length() &gt; options.getChunkThreshold()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> uploadFileInChunks(file, options);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> uploadSingleFile(file, options);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileUploadException</span>(<span class="string">&quot;Upload failed&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Download a file</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;File&gt; <span class="title function_">downloadFile</span><span class="params">(String fileId, File destination)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">FileDownloadResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.getDownloadUrl(fileId);</span><br><span class="line">                <span class="keyword">return</span> downloadFromSignedUrl(response.getDownloadUrl(), destination);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileDownloadException</span>(<span class="string">&quot;Download failed&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Upload file with progress callback</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;FileUploadResult&gt; <span class="title function_">uploadFileWithProgress</span><span class="params">(</span></span><br><span class="line"><span class="params">            File file, </span></span><br><span class="line"><span class="params">            UploadOptions options, </span></span><br><span class="line"><span class="params">            ProgressCallback callback)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (file.length() &lt;= options.getChunkThreshold()) &#123;</span><br><span class="line">            <span class="keyword">return</span> uploadSingleFileWithProgress(file, options, callback);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> uploadFileInChunksWithProgress(file, options, callback);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> FileUploadResult <span class="title function_">uploadFileInChunksWithProgress</span><span class="params">(</span></span><br><span class="line"><span class="params">            File file, </span></span><br><span class="line"><span class="params">            UploadOptions options, </span></span><br><span class="line"><span class="params">            ProgressCallback callback)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Calculate file hash</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">fileHash</span> <span class="operator">=</span> calculateSHA256(file);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Calculate chunks</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">chunkSize</span> <span class="operator">=</span> options.getChunkSize();</span><br><span class="line">            <span class="type">int</span> <span class="variable">totalChunks</span> <span class="operator">=</span> (<span class="type">int</span>) Math.ceil((<span class="type">double</span>) file.length() / chunkSize);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Initiate chunked upload</span></span><br><span class="line">            <span class="type">ChunkedUploadRequest</span> <span class="variable">request</span> <span class="operator">=</span> ChunkedUploadRequest.builder()</span><br><span class="line">                .originalFilename(file.getName())</span><br><span class="line">                .fileSize(file.length())</span><br><span class="line">                .mimeType(detectMimeType(file))</span><br><span class="line">                .fileHash(fileHash)</span><br><span class="line">                .userId(options.getUserId())</span><br><span class="line">                .projectId(options.getProjectId())</span><br><span class="line">                .totalChunks(totalChunks)</span><br><span class="line">                .chunkSize((<span class="type">int</span>) chunkSize)</span><br><span class="line">                .tags(options.getTags())</span><br><span class="line">                .metadata(options.getMetadata())</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">            <span class="type">ChunkedUploadResponse</span> <span class="variable">uploadResponse</span> <span class="operator">=</span> client.initiateChunkedUpload(request);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Upload chunks</span></span><br><span class="line">            List&lt;ChunkInfo&gt; chunkInfos = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">RandomAccessFile</span> <span class="variable">raf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(file, <span class="string">&quot;r&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; totalChunks; i++) &#123;</span><br><span class="line">                    <span class="type">long</span> <span class="variable">offset</span> <span class="operator">=</span> (<span class="type">long</span>) i * chunkSize;</span><br><span class="line">                    <span class="type">long</span> <span class="variable">currentChunkSize</span> <span class="operator">=</span> Math.min(chunkSize, file.length() - offset);</span><br><span class="line">                    </span><br><span class="line">                    <span class="type">ChunkUploadResponse</span> <span class="variable">chunkResponse</span> <span class="operator">=</span> client.getChunkUploadUrl(</span><br><span class="line">                        uploadResponse.getUploadId(), i + <span class="number">1</span>);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// Upload chunk to GCS</span></span><br><span class="line">                    <span class="type">byte</span>[] chunkData = <span class="keyword">new</span> <span class="title class_">byte</span>[(<span class="type">int</span>) currentChunkSize];</span><br><span class="line">                    raf.seek(offset);</span><br><span class="line">                    raf.readFully(chunkData);</span><br><span class="line">                    </span><br><span class="line">                    <span class="type">String</span> <span class="variable">etag</span> <span class="operator">=</span> uploadChunkToGCS(chunkResponse.getChunkUploadUrl(), chunkData);</span><br><span class="line">                    </span><br><span class="line">                    chunkInfos.add(<span class="keyword">new</span> <span class="title class_">ChunkInfo</span>(i + <span class="number">1</span>, etag));</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// Update progress</span></span><br><span class="line">                    <span class="keyword">if</span> (callback != <span class="literal">null</span>) &#123;</span><br><span class="line">                        callback.onProgress((<span class="type">double</span>) (i + <span class="number">1</span>) / totalChunks);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Complete upload</span></span><br><span class="line">            <span class="type">CompleteChunkedUploadRequest</span> <span class="variable">completeRequest</span> <span class="operator">=</span> CompleteChunkedUploadRequest.builder()</span><br><span class="line">                .uploadId(uploadResponse.getUploadId())</span><br><span class="line">                .chunks(chunkInfos)</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">            <span class="type">FileUploadResponse</span> <span class="variable">finalResponse</span> <span class="operator">=</span> client.completeChunkedUpload(completeRequest);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (callback != <span class="literal">null</span>) &#123;</span><br><span class="line">                callback.onComplete();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> FileUploadResult.builder()</span><br><span class="line">                .fileId(finalResponse.getFileId())</span><br><span class="line">                .filename(file.getName())</span><br><span class="line">                .fileSize(file.length())</span><br><span class="line">                .uploadedAt(Instant.now())</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (callback != <span class="literal">null</span>) &#123;</span><br><span class="line">                callback.onError(e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileUploadException</span>(<span class="string">&quot;Chunked upload failed&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Query files with fluent API</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> FileQuery <span class="title function_">queryFiles</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FileQuery</span>(client);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Fluent query builder</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">FileQuery</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> FileStorageClient client;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> FileQueryRequest.FileQueryRequestBuilder builder;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">FileQuery</span><span class="params">(FileStorageClient client)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.client = client;</span><br><span class="line">            <span class="built_in">this</span>.builder = FileQueryRequest.builder();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> FileQuery <span class="title function_">inProject</span><span class="params">(String projectId)</span> &#123;</span><br><span class="line">            builder.projectId(projectId);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> FileQuery <span class="title function_">withMimeTypes</span><span class="params">(String... mimeTypes)</span> &#123;</span><br><span class="line">            builder.mimeTypes(Arrays.asList(mimeTypes));</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> FileQuery <span class="title function_">createdBy</span><span class="params">(String userId)</span> &#123;</span><br><span class="line">            builder.createdBy(userId);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> FileQuery <span class="title function_">createdAfter</span><span class="params">(Instant after)</span> &#123;</span><br><span class="line">            builder.createdAfter(after);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> FileQuery <span class="title function_">pageSize</span><span class="params">(<span class="type">int</span> size)</span> &#123;</span><br><span class="line">            builder.size(size);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> FileQuery <span class="title function_">page</span><span class="params">(<span class="type">int</span> page)</span> &#123;</span><br><span class="line">            builder.page(page);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> CompletableFuture&lt;FileQueryResult&gt; <span class="title function_">execute</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">FileQueryResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.queryFiles(builder.build());</span><br><span class="line">                    <span class="keyword">return</span> FileQueryResult.from(response);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileQueryException</span>(<span class="string">&quot;Query failed&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SDK-Usage-Examples"><a href="#SDK-Usage-Examples" class="headerlink" title="SDK Usage Examples"></a>SDK Usage Examples</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Initialize SDK</span></span><br><span class="line"><span class="type">FileStorageConfig</span> <span class="variable">config</span> <span class="operator">=</span> FileStorageConfig.builder()</span><br><span class="line">    .baseUrl(<span class="string">&quot;https://api.example.com&quot;</span>)</span><br><span class="line">    .apiKey(<span class="string">&quot;your-api-key&quot;</span>)</span><br><span class="line">    .timeout(Duration.ofMinutes(<span class="number">5</span>))</span><br><span class="line">    .chunkSize(<span class="number">5</span> * <span class="number">1024</span> * <span class="number">1024</span>) <span class="comment">// 5MB chunks</span></span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line"><span class="type">FileStorageSDK</span> <span class="variable">sdk</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileStorageSDK</span>(config);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Simple file upload</span></span><br><span class="line"><span class="type">File</span> <span class="variable">document</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;document.pdf&quot;</span>);</span><br><span class="line"><span class="type">UploadOptions</span> <span class="variable">options</span> <span class="operator">=</span> UploadOptions.builder()</span><br><span class="line">    .userId(<span class="string">&quot;user-123&quot;</span>)</span><br><span class="line">    .projectId(<span class="string">&quot;project-456&quot;</span>)</span><br><span class="line">    .tag(<span class="string">&quot;category&quot;</span>, <span class="string">&quot;documents&quot;</span>)</span><br><span class="line">    .metadata(<span class="string">&quot;department&quot;</span>, <span class="string">&quot;engineering&quot;</span>)</span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line">CompletableFuture&lt;FileUploadResult&gt; uploadFuture = sdk.uploadFile(document, options);</span><br><span class="line"><span class="type">FileUploadResult</span> <span class="variable">result</span> <span class="operator">=</span> uploadFuture.join();</span><br><span class="line">System.out.println(<span class="string">&quot;File uploaded: &quot;</span> + result.getFileId());</span><br><span class="line"></span><br><span class="line"><span class="comment">// Upload with progress tracking</span></span><br><span class="line">sdk.uploadFileWithProgress(document, options, <span class="keyword">new</span> <span class="title class_">ProgressCallback</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onProgress</span><span class="params">(<span class="type">double</span> progress)</span> &#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;Upload progress: %.2f%%\n&quot;</span>, progress * <span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onComplete</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Upload completed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Exception error)</span> &#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;Upload failed: &quot;</span> + error.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Query files</span></span><br><span class="line">CompletableFuture&lt;FileQueryResult&gt; queryFuture = sdk.queryFiles()</span><br><span class="line">    .inProject(<span class="string">&quot;project-456&quot;</span>)</span><br><span class="line">    .withMimeTypes(<span class="string">&quot;application/pdf&quot;</span>, <span class="string">&quot;image/jpeg&quot;</span>)</span><br><span class="line">    .createdAfter(Instant.now().minus(Duration.ofDays(<span class="number">30</span>)))</span><br><span class="line">    .pageSize(<span class="number">50</span>)</span><br><span class="line">    .execute();</span><br><span class="line"></span><br><span class="line"><span class="type">FileQueryResult</span> <span class="variable">queryResult</span> <span class="operator">=</span> queryFuture.join();</span><br><span class="line">queryResult.getFiles().forEach(file -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;File: &quot;</span> + file.getFilename() + <span class="string">&quot; (&quot;</span> + file.getFileSize() + <span class="string">&quot; bytes)&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Download file</span></span><br><span class="line">CompletableFuture&lt;File&gt; downloadFuture = sdk.downloadFile(</span><br><span class="line">    result.getFileId(), </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;downloads/document.pdf&quot;</span>)</span><br><span class="line">);</span><br><span class="line"><span class="type">File</span> <span class="variable">downloadedFile</span> <span class="operator">=</span> downloadFuture.join();</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>The SDK design demonstrates understanding of asynchronous programming, builder patterns, and clean API design. The fluent query interface shows advanced Java skills.</em></p>
<h2 id="Chunked-Upload-Flow"><a href="#Chunked-Upload-Flow" class="headerlink" title="Chunked Upload Flow"></a>Chunked Upload Flow</h2><p>The chunked upload mechanism handles large files efficiently by splitting them into manageable chunks and uploading them in parallel when possible.</p>
<pre>
<code class="mermaid">
sequenceDiagram
participant C as Client
participant API as File API
participant DB as PostgreSQL
participant GCS as Google Cloud Storage

Note over C,GCS: Large File Upload (&gt;10MB)

C-&gt;&gt;API: POST &#x2F;files&#x2F;upload&#x2F;chunked
API-&gt;&gt;DB: Create file metadata (PENDING)
API-&gt;&gt;GCS: Initiate multipart upload
GCS--&gt;&gt;API: Upload ID
API-&gt;&gt;DB: Create chunked_upload record
API--&gt;&gt;C: Return upload ID &amp; file ID

loop For each chunk
    C-&gt;&gt;API: POST &#x2F;upload&#x2F;chunked&#x2F;{uploadId}&#x2F;chunks&#x2F;{n}
    API--&gt;&gt;C: Return signed upload URL
    C-&gt;&gt;GCS: PUT chunk data to signed URL
    GCS--&gt;&gt;C: ETag response
    C-&gt;&gt;API: Notify chunk completion (ETag)
    API-&gt;&gt;DB: Update chunk status
end

C-&gt;&gt;API: POST &#x2F;upload&#x2F;chunked&#x2F;{uploadId}&#x2F;complete
API-&gt;&gt;GCS: Complete multipart upload
GCS--&gt;&gt;API: Final object info
API-&gt;&gt;DB: Update file status to COMPLETED
API--&gt;&gt;C: Return download URL
</code>
</pre>

<h3 id="Chunked-Upload-Implementation-Details"><a href="#Chunked-Upload-Implementation-Details" class="headerlink" title="Chunked Upload Implementation Details"></a>Chunked Upload Implementation Details</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChunkedUploadHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChunkedUploadRepository chunkedUploadRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChunkRepository chunkRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GcsStorageClient gcsClient;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TaskExecutor taskExecutor;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Process chunk completion asynchronously</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;Void&gt; <span class="title function_">handleChunkCompletion</span><span class="params">(</span></span><br><span class="line"><span class="params">            String uploadId, </span></span><br><span class="line"><span class="params">            Integer chunkNumber, </span></span><br><span class="line"><span class="params">            String etag)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">ChunkedUploadEntity</span> <span class="variable">upload</span> <span class="operator">=</span> chunkedUploadRepository.findById(uploadId)</span><br><span class="line">                    .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">ChunkedUploadNotFoundException</span>(<span class="string">&quot;Upload not found&quot;</span>));</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Update or create chunk record</span></span><br><span class="line">                <span class="type">ChunkEntity</span> <span class="variable">chunk</span> <span class="operator">=</span> chunkRepository</span><br><span class="line">                    .findByChunkedUploadIdAndChunkNumber(uploadId, chunkNumber)</span><br><span class="line">                    .orElse(ChunkEntity.builder()</span><br><span class="line">                        .chunkedUploadId(uploadId)</span><br><span class="line">                        .chunkNumber(chunkNumber)</span><br><span class="line">                        .build());</span><br><span class="line">                </span><br><span class="line">                chunk.setEtag(etag);</span><br><span class="line">                chunk.setUploadedAt(Instant.now());</span><br><span class="line">                chunkRepository.save(chunk);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Update completed chunks count</span></span><br><span class="line">                upload.setCompletedChunks(upload.getCompletedChunks() + <span class="number">1</span>);</span><br><span class="line">                chunkedUploadRepository.save(upload);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Check if all chunks are completed</span></span><br><span class="line">                <span class="keyword">if</span> (upload.getCompletedChunks().equals(upload.getTotalChunks())) &#123;</span><br><span class="line">                    notifyUploadCompletion(uploadId);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;Failed to handle chunk completion for upload: &#123;&#125;, chunk: &#123;&#125;&quot;</span>, </span><br><span class="line">                    uploadId, chunkNumber, e);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ChunkProcessingException</span>(<span class="string">&quot;Chunk processing failed&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, taskExecutor);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Auto-complete upload when all chunks are received</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">notifyUploadCompletion</span><span class="params">(String uploadId)</span> &#123;</span><br><span class="line">        <span class="comment">// Use event-driven approach for loose coupling</span></span><br><span class="line">        applicationEventPublisher.publishEvent(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ChunkedUploadCompletedEvent</span>(uploadId)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>The asynchronous processing of chunk completions demonstrates understanding of event-driven architecture and prevents blocking the upload API.</em></p>
<h2 id="Security-and-Authentication"><a href="#Security-and-Authentication" class="headerlink" title="Security and Authentication"></a>Security and Authentication</h2><h3 id="API-Security-Implementation"><a href="#API-Security-Implementation" class="headerlink" title="API Security Implementation"></a>API Security Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileSecurityService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtTokenProvider jwtTokenProvider;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PermissionService permissionService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RateLimitService rateLimitService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Validate file access permissions</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">validateFileAccess</span><span class="params">(String fileId, String userId, FileOperation operation)</span> &#123;</span><br><span class="line">        <span class="comment">// Check rate limits</span></span><br><span class="line">        <span class="keyword">if</span> (!rateLimitService.isAllowed(userId, operation)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RateLimitExceededException</span>(<span class="string">&quot;Rate limit exceeded&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Validate file ownership or permissions</span></span><br><span class="line">        <span class="type">FileEntity</span> <span class="variable">file</span> <span class="operator">=</span> fileRepository.findById(UUID.fromString(fileId))</span><br><span class="line">            .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">FileNotFoundException</span>(<span class="string">&quot;File not found&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!canUserAccessFile(file, userId, operation)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AccessDeniedException</span>(<span class="string">&quot;Insufficient permissions&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Validate file status for downloads</span></span><br><span class="line">        <span class="keyword">if</span> (operation == FileOperation.DOWNLOAD &amp;&amp; </span><br><span class="line">            file.getUploadStatus() != UploadStatus.COMPLETED) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileNotAvailableException</span>(<span class="string">&quot;File not available&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check file expiration</span></span><br><span class="line">        <span class="keyword">if</span> (file.getExpiresAt() != <span class="literal">null</span> &amp;&amp; </span><br><span class="line">            file.getExpiresAt().isBefore(Instant.now())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileExpiredException</span>(<span class="string">&quot;File has expired&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">canUserAccessFile</span><span class="params">(FileEntity file, String userId, FileOperation operation)</span> &#123;</span><br><span class="line">        <span class="comment">// Owner always has full access</span></span><br><span class="line">        <span class="keyword">if</span> (file.getCreatedBy().equals(UUID.fromString(userId))) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check project-level permissions</span></span><br><span class="line">        <span class="keyword">if</span> (file.getProjectId() != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> permissionService.hasProjectPermission(</span><br><span class="line">                userId, </span><br><span class="line">                file.getProjectId().toString(), </span><br><span class="line">                operation.toPermission()</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check organization-level permissions for non-project files</span></span><br><span class="line">        <span class="keyword">return</span> permissionService.hasOrganizationPermission(</span><br><span class="line">            userId, </span><br><span class="line">            operation.toPermission()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Generate secure signed URLs with additional validation</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generateSecureSignedUrl</span><span class="params">(String fileId, String userId, Duration expiration)</span> &#123;</span><br><span class="line">        validateFileAccess(fileId, userId, FileOperation.DOWNLOAD);</span><br><span class="line">        </span><br><span class="line">        <span class="type">FileEntity</span> <span class="variable">file</span> <span class="operator">=</span> fileRepository.findById(UUID.fromString(fileId))</span><br><span class="line">            .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">FileNotFoundException</span>(<span class="string">&quot;File not found&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Generate signed URL with custom headers for validation</span></span><br><span class="line">        Map&lt;String, String&gt; customHeaders = Map.of(</span><br><span class="line">            <span class="string">&quot;x-user-id&quot;</span>, userId,</span><br><span class="line">            <span class="string">&quot;x-file-id&quot;</span>, fileId,</span><br><span class="line">            <span class="string">&quot;x-timestamp&quot;</span>, String.valueOf(Instant.now().getEpochSecond())</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> gcsClient.generateSignedDownloadUrl(</span><br><span class="line">            file.getGcsBucket(),</span><br><span class="line">            file.getGcsObjectKey(),</span><br><span class="line">            expiration,</span><br><span class="line">            customHeaders</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Security interceptor for file operations</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileSecurityInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileSecurityService securityService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtTokenProvider jwtTokenProvider;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, </span></span><br><span class="line"><span class="params">                           HttpServletResponse response, </span></span><br><span class="line"><span class="params">                           Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> extractTokenFromRequest(request);</span><br><span class="line">        <span class="keyword">if</span> (token == <span class="literal">null</span> || !jwtTokenProvider.validateToken(token)) &#123;</span><br><span class="line">            response.setStatus(HttpStatus.UNAUTHORIZED.value());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> jwtTokenProvider.getUserIdFromToken(token);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Extract file ID from path</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileId</span> <span class="operator">=</span> extractFileIdFromPath(request.getRequestURI());</span><br><span class="line">        <span class="keyword">if</span> (fileId != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">FileOperation</span> <span class="variable">operation</span> <span class="operator">=</span> determineOperation(request.getMethod(), request.getRequestURI());</span><br><span class="line">            securityService.validateFileAccess(fileId, userId, operation);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Set user context for the request</span></span><br><span class="line">        SecurityContextHolder.getContext().setUserId(userId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Optimization"><a href="#Performance-Optimization" class="headerlink" title="Performance Optimization"></a>Performance Optimization</h2><h3 id="Caching-Strategy"><a href="#Caching-Strategy" class="headerlink" title="Caching Strategy"></a>Caching Strategy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileCacheService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CacheManager cacheManager;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">METADATA_CACHE_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;file:metadata:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DOWNLOAD_URL_CACHE_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;file:download:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Duration</span> <span class="variable">METADATA_CACHE_TTL</span> <span class="operator">=</span> Duration.ofMinutes(<span class="number">30</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Duration</span> <span class="variable">DOWNLOAD_URL_CACHE_TTL</span> <span class="operator">=</span> Duration.ofMinutes(<span class="number">5</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Cache file metadata with intelligent TTL</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Cacheable(value = &quot;fileMetadata&quot;, key = &quot;#fileId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> FileMetadata <span class="title function_">getFileMetadata</span><span class="params">(String fileId)</span> &#123;</span><br><span class="line">        <span class="comment">// Cache miss - load from database</span></span><br><span class="line">        <span class="type">FileEntity</span> <span class="variable">file</span> <span class="operator">=</span> fileRepository.findById(UUID.fromString(fileId))</span><br><span class="line">            .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">FileNotFoundException</span>(<span class="string">&quot;File not found&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="type">FileMetadata</span> <span class="variable">metadata</span> <span class="operator">=</span> FileMetadata.from(file);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Cache with adaptive TTL based on file age</span></span><br><span class="line">        <span class="type">Duration</span> <span class="variable">ttl</span> <span class="operator">=</span> calculateAdaptiveTTL(file.getCreatedAt());</span><br><span class="line">        cacheMetadataWithTTL(fileId, metadata, ttl);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> metadata;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Cache download URLs with short TTL for security</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCachedDownloadUrl</span><span class="params">(String fileId, String userId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cacheKey</span> <span class="operator">=</span> DOWNLOAD_URL_CACHE_PREFIX + fileId + <span class="string">&quot;:&quot;</span> + userId;</span><br><span class="line">        <span class="keyword">return</span> (String) redisTemplate.opsForValue().get(cacheKey);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cacheDownloadUrl</span><span class="params">(String fileId, String userId, String url, Duration expiration)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cacheKey</span> <span class="operator">=</span> DOWNLOAD_URL_CACHE_PREFIX + fileId + <span class="string">&quot;:&quot;</span> + userId;</span><br><span class="line">        <span class="type">Duration</span> <span class="variable">cacheTTL</span> <span class="operator">=</span> expiration.compareTo(DOWNLOAD_URL_CACHE_TTL) &lt; <span class="number">0</span> ? </span><br><span class="line">            expiration : DOWNLOAD_URL_CACHE_TTL;</span><br><span class="line">        </span><br><span class="line">        redisTemplate.opsForValue().set(cacheKey, url, cacheTTL);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Invalidate cache when file is updated or deleted</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@CacheEvict(value = &quot;fileMetadata&quot;, key = &quot;#fileId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invalidateFileCache</span><span class="params">(String fileId)</span> &#123;</span><br><span class="line">        <span class="comment">// Also clear download URL caches for this file</span></span><br><span class="line">        Set&lt;String&gt; keys = redisTemplate.keys(DOWNLOAD_URL_CACHE_PREFIX + fileId + <span class="string">&quot;:*&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!keys.isEmpty()) &#123;</span><br><span class="line">            redisTemplate.delete(keys);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Calculate adaptive TTL based on file characteristics</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Duration <span class="title function_">calculateAdaptiveTTL</span><span class="params">(Instant createdAt)</span> &#123;</span><br><span class="line">        <span class="type">Duration</span> <span class="variable">age</span> <span class="operator">=</span> Duration.between(createdAt, Instant.now());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Older files get longer cache TTL as they&#x27;re less likely to change</span></span><br><span class="line">        <span class="keyword">if</span> (age.toDays() &gt; <span class="number">30</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Duration.ofHours(<span class="number">2</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (age.toDays() &gt; <span class="number">7</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Duration.ofMinutes(<span class="number">60</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Duration.ofMinutes(<span class="number">15</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Database query optimization</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OptimizedFileRepository</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PersistenceContext</span></span><br><span class="line">    <span class="keyword">private</span> EntityManager entityManager;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Optimized query for file listing with filtering</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Query(value = &quot;&quot;&quot;</span></span><br><span class="line"><span class="meta">        SELECT f.*, </span></span><br><span class="line"><span class="meta">               COUNT(*) OVER() as total_count</span></span><br><span class="line"><span class="meta">        FROM files f</span></span><br><span class="line"><span class="meta">        WHERE (?1 IS NULL OR f.project_id = ?1::uuid)</span></span><br><span class="line"><span class="meta">          AND (?2 IS NULL OR f.mime_type = ANY(?2))</span></span><br><span class="line"><span class="meta">          AND (?3 IS NULL OR f.created_by = ?3::uuid)</span></span><br><span class="line"><span class="meta">          AND (?4 IS NULL OR f.created_at &gt;= ?4)</span></span><br><span class="line"><span class="meta">          AND (?5 IS NULL OR f.created_at &lt;= ?5)</span></span><br><span class="line"><span class="meta">          AND f.upload_status = &#x27;COMPLETED&#x27;</span></span><br><span class="line"><span class="meta">        ORDER BY f.created_at DESC</span></span><br><span class="line"><span class="meta">        LIMIT ?6 OFFSET ?7</span></span><br><span class="line"><span class="meta">        &quot;&quot;&quot;, nativeQuery = true)</span></span><br><span class="line">    List&lt;FileProjection&gt; <span class="title function_">findFilesOptimized</span><span class="params">(</span></span><br><span class="line"><span class="params">        String projectId,</span></span><br><span class="line"><span class="params">        String[] mimeTypes,</span></span><br><span class="line"><span class="params">        String createdBy,</span></span><br><span class="line"><span class="params">        Instant createdAfter,</span></span><br><span class="line"><span class="params">        Instant createdBefore,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> limit,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> offset</span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Bulk operations for cleanup</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Modifying</span></span><br><span class="line">    <span class="meta">@Query(&quot;DELETE FROM FileEntity f WHERE f.uploadStatus = &#x27;FAILED&#x27; AND f.createdAt &lt; :cutoffDate&quot;)</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">deleteFailedUploadsOlderThan</span><span class="params">(<span class="meta">@Param(&quot;cutoffDate&quot;)</span> Instant cutoffDate)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Modifying</span></span><br><span class="line">    <span class="meta">@Query(&quot;&quot;&quot;</span></span><br><span class="line"><span class="meta">        UPDATE FileEntity f </span></span><br><span class="line"><span class="meta">        SET f.uploadStatus = &#x27;EXPIRED&#x27; </span></span><br><span class="line"><span class="meta">        WHERE f.expiresAt &lt; :now AND f.uploadStatus = &#x27;COMPLETED&#x27;</span></span><br><span class="line"><span class="meta">        &quot;&quot;&quot;)</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">markExpiredFiles</span><span class="params">(<span class="meta">@Param(&quot;now&quot;)</span> Instant now)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Monitoring-and-Observability"><a href="#Monitoring-and-Observability" class="headerlink" title="Monitoring and Observability"></a>Monitoring and Observability</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageMetrics</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter uploadCounter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter downloadCounter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Timer uploadTimer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Gauge activeUploadsGauge;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DistributionSummary fileSizeDistribution;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FileStorageMetrics</span><span class="params">(MeterRegistry meterRegistry)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.meterRegistry = meterRegistry;</span><br><span class="line">        <span class="built_in">this</span>.uploadCounter = Counter.builder(<span class="string">&quot;file_uploads_total&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Total number of file uploads&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">this</span>.downloadCounter = Counter.builder(<span class="string">&quot;file_downloads_total&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Total number of file downloads&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">this</span>.uploadTimer = Timer.builder(<span class="string">&quot;file_upload_duration&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;File upload duration&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">this</span>.fileSizeDistribution = DistributionSummary.builder(<span class="string">&quot;file_size_bytes&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Distribution of file sizes&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordUpload</span><span class="params">(String mimeType, <span class="type">long</span> fileSize, Duration duration, <span class="type">boolean</span> successful)</span> &#123;</span><br><span class="line">        uploadCounter.increment(</span><br><span class="line">            Tags.of(</span><br><span class="line">                <span class="string">&quot;mime_type&quot;</span>, mimeType,</span><br><span class="line">                <span class="string">&quot;status&quot;</span>, successful ? <span class="string">&quot;success&quot;</span> : <span class="string">&quot;failure&quot;</span></span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (successful) &#123;</span><br><span class="line">            uploadTimer.record(duration);</span><br><span class="line">            fileSizeDistribution.record(fileSize);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordDownload</span><span class="params">(String mimeType)</span> &#123;</span><br><span class="line">        downloadCounter.increment(Tags.of(<span class="string">&quot;mime_type&quot;</span>, mimeType));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 30000)</span> <span class="comment">// Every 30 seconds</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateActiveUploadsGauge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">activeUploads</span> <span class="operator">=</span> chunkedUploadRepository.countByStatusIn(</span><br><span class="line">            Arrays.asList(UploadStatus.PENDING, UploadStatus.UPLOADING)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        Gauge.builder(<span class="string">&quot;file_uploads_active&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Number of active uploads&quot;</span>)</span><br><span class="line">            .register(meterRegistry, <span class="built_in">this</span>, unused -&gt; activeUploads);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Error-Handling-and-Resilience"><a href="#Error-Handling-and-Resilience" class="headerlink" title="Error Handling and Resilience"></a>Error Handling and Resilience</h2><h3 id="Comprehensive-Error-Handling"><a href="#Comprehensive-Error-Handling" class="headerlink" title="Comprehensive Error Handling"></a>Comprehensive Error Handling</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageExceptionHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(FileStorageExceptionHandler.class);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler(FileNotFoundException.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;ErrorResponse&gt; <span class="title function_">handleFileNotFound</span><span class="params">(FileNotFoundException e)</span> &#123;</span><br><span class="line">        log.warn(<span class="string">&quot;File not found: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.NOT_FOUND)</span><br><span class="line">            .body(ErrorResponse.builder()</span><br><span class="line">                .error(<span class="string">&quot;FILE_NOT_FOUND&quot;</span>)</span><br><span class="line">                .message(e.getMessage())</span><br><span class="line">                .timestamp(Instant.now())</span><br><span class="line">                .build());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler(FileUploadException.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;ErrorResponse&gt; <span class="title function_">handleUploadException</span><span class="params">(FileUploadException e)</span> &#123;</span><br><span class="line">        log.error(<span class="string">&quot;File upload failed&quot;</span>, e);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.BAD_REQUEST)</span><br><span class="line">            .body(ErrorResponse.builder()</span><br><span class="line">                .error(<span class="string">&quot;UPLOAD_FAILED&quot;</span>)</span><br><span class="line">                .message(<span class="string">&quot;File upload failed: &quot;</span> + e.getMessage())</span><br><span class="line">                .timestamp(Instant.now())</span><br><span class="line">                .details(extractErrorDetails(e))</span><br><span class="line">                .build());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler(RateLimitExceededException.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;ErrorResponse&gt; <span class="title function_">handleRateLimit</span><span class="params">(RateLimitExceededException e)</span> &#123;</span><br><span class="line">        log.warn(<span class="string">&quot;Rate limit exceeded: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.TOO_MANY_REQUESTS)</span><br><span class="line">            .header(<span class="string">&quot;Retry-After&quot;</span>, <span class="string">&quot;60&quot;</span>)</span><br><span class="line">            .body(ErrorResponse.builder()</span><br><span class="line">                .error(<span class="string">&quot;RATE_LIMIT_EXCEEDED&quot;</span>)</span><br><span class="line">                .message(<span class="string">&quot;Too many requests. Please try again later.&quot;</span>)</span><br><span class="line">                .timestamp(Instant.now())</span><br><span class="line">                .build());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler(StorageQuotaExceededException.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;ErrorResponse&gt; <span class="title function_">handleQuotaExceeded</span><span class="params">(StorageQuotaExceededException e)</span> &#123;</span><br><span class="line">        log.warn(<span class="string">&quot;Storage quota exceeded: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.INSUFFICIENT_STORAGE)</span><br><span class="line">            .body(ErrorResponse.builder()</span><br><span class="line">                .error(<span class="string">&quot;QUOTA_EXCEEDED&quot;</span>)</span><br><span class="line">                .message(<span class="string">&quot;Storage quota exceeded. Please upgrade your plan or delete some files.&quot;</span>)</span><br><span class="line">                .timestamp(Instant.now())</span><br><span class="line">                .build());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Circuit breaker for GCS operations</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResilientGcsClient</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Storage storage;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CircuitBreaker circuitBreaker;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RetryTemplate retryTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ResilientGcsClient</span><span class="params">(Storage storage)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.storage = storage;</span><br><span class="line">        <span class="built_in">this</span>.circuitBreaker = CircuitBreaker.builder(<span class="string">&quot;gcs-operations&quot;</span>)</span><br><span class="line">            .slidingWindow(<span class="number">10</span>, <span class="number">5</span>, CircuitBreaker.SlidingWindowType.COUNT_BASED)</span><br><span class="line">            .failureThreshold(<span class="number">50.0f</span>)</span><br><span class="line">            .waitInterval(Duration.ofSeconds(<span class="number">30</span>))</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">this</span>.retryTemplate = RetryTemplate.builder()</span><br><span class="line">            .maxAttempts(<span class="number">3</span>)</span><br><span class="line">            .exponentialBackoff(<span class="number">1000</span>, <span class="number">2</span>, <span class="number">10000</span>)</span><br><span class="line">            .retryOn(StorageException.class)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generateSignedUrl</span><span class="params">(String bucket, String objectName, Duration expiration)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> circuitBreaker.supply(() -&gt; </span><br><span class="line">            retryTemplate.execute(context -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">BlobInfo</span> <span class="variable">blobInfo</span> <span class="operator">=</span> BlobInfo.newBuilder(bucket, objectName).build();</span><br><span class="line">                    <span class="keyword">return</span> storage.signUrl(blobInfo, expiration.toMillis(), TimeUnit.MILLISECONDS)</span><br><span class="line">                        .toString();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (StorageException e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;Failed to generate signed URL for &#123;&#125;/&#123;&#125;&quot;</span>, bucket, objectName, e);</span><br><span class="line">                    <span class="keyword">throw</span> e;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Deployment-and-Infrastructure"><a href="#Deployment-and-Infrastructure" class="headerlink" title="Deployment and Infrastructure"></a>Deployment and Infrastructure</h2><h3 id="Docker-Configuration"><a href="#Docker-Configuration" class="headerlink" title="Docker Configuration"></a>Docker Configuration</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Multi-stage build for production optimization</span></span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">17</span>-jdk-slim AS builder</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> gradlew .</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> gradle gradle</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> build.gradle settings.gradle ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> src src</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> ./gradlew build -x <span class="built_in">test</span> --no-daemon</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">17</span>-jre-slim</span><br><span class="line"></span><br><span class="line"><span class="comment"># Security: Create non-root user</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> groupadd -r fileservice &amp;&amp; useradd -r -g fileservice fileservice</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Install required packages</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y \</span></span><br><span class="line"><span class="language-bash">    curl \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy application jar</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/build/libs/file-storage-service-*.jar app.jar</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy configuration files</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --<span class="built_in">chown</span>=fileservice:fileservice docker/application-docker.yml application.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Health check</span></span><br><span class="line"><span class="keyword">HEALTHCHECK</span><span class="language-bash"> --interval=30s --<span class="built_in">timeout</span>=10s --start-period=60s --retries=3 \</span></span><br><span class="line"><span class="language-bash">  CMD curl -f http://localhost:8080/actuator/health || <span class="built_in">exit</span> 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Switch to non-root user</span></span><br><span class="line"><span class="keyword">USER</span> fileservice</span><br><span class="line"></span><br><span class="line"><span class="comment"># JVM optimization for containers</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_OPTS=<span class="string">&quot;-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0 -XX:+UseG1GC&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;java <span class="variable">$JAVA_OPTS</span> -jar app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h3 id="Kubernetes-Deployment"><a href="#Kubernetes-Deployment" class="headerlink" title="Kubernetes Deployment"></a>Kubernetes Deployment</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">file-storage-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">file-storage</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">file-storage-service</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">file-storage-service</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">file-storage-service</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">file-storage-service:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_PROFILES_ACTIVE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;kubernetes&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_HOST</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">postgres-secret</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">host</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_PASSWORD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">postgres-secret</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">password</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GOOGLE_APPLICATION_CREDENTIALS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;/etc/gcp/service-account.json&quot;</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gcp-service-account</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/gcp</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;512Mi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;1000m&quot;</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/actuator/health/liveness</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">30</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/actuator/health/readiness</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gcp-service-account</span></span><br><span class="line">        <span class="attr">secret:</span></span><br><span class="line">          <span class="attr">secretName:</span> <span class="string">gcp-service-account</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># service.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">file-storage-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">file-storage</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">file-storage-service</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># hpa.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">file-storage-hpa</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">file-storage</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">file-storage-service</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cpu</span></span><br><span class="line">      <span class="attr">target:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">Utilization</span></span><br><span class="line">        <span class="attr">averageUtilization:</span> <span class="number">70</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">memory</span></span><br><span class="line">      <span class="attr">target:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">Utilization</span></span><br><span class="line">        <span class="attr">averageUtilization:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h2 id="Testing-Strategy"><a href="#Testing-Strategy" class="headerlink" title="Testing Strategy"></a>Testing Strategy</h2><h3 id="Integration-Testing"><a href="#Integration-Testing" class="headerlink" title="Integration Testing"></a>Integration Testing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)</span></span><br><span class="line"><span class="meta">@TestPropertySource(locations = &quot;classpath:application-test.properties&quot;)</span></span><br><span class="line"><span class="meta">@Testcontainers</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileStorageIntegrationTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Container</span></span><br><span class="line">    <span class="keyword">static</span> PostgreSQLContainer&lt;?&gt; postgres = <span class="keyword">new</span> <span class="title class_">PostgreSQLContainer</span>&lt;&gt;(<span class="string">&quot;postgres:13&quot;</span>)</span><br><span class="line">            .withDatabaseName(<span class="string">&quot;filetest&quot;</span>)</span><br><span class="line">            .withUsername(<span class="string">&quot;test&quot;</span>)</span><br><span class="line">            .withPassword(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Container</span></span><br><span class="line">    <span class="keyword">static</span> GenericContainer&lt;?&gt; redis = <span class="keyword">new</span> <span class="title class_">GenericContainer</span>&lt;&gt;(<span class="string">&quot;redis:6-alpine&quot;</span>)</span><br><span class="line">            .withExposedPorts(<span class="number">6379</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TestRestTemplate restTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@MockBean</span></span><br><span class="line">    <span class="keyword">private</span> GcsStorageClient gcsClient;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldUploadFileSuccessfully</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Given</span></span><br><span class="line">        <span class="type">FileUploadRequest</span> <span class="variable">request</span> <span class="operator">=</span> FileUploadRequest.builder()</span><br><span class="line">            .originalFilename(<span class="string">&quot;test.pdf&quot;</span>)</span><br><span class="line">            .fileSize(<span class="number">1024L</span>)</span><br><span class="line">            .mimeType(<span class="string">&quot;application/pdf&quot;</span>)</span><br><span class="line">            .fileHash(<span class="string">&quot;abcd1234&quot;</span>)</span><br><span class="line">            .userId(<span class="string">&quot;user-123&quot;</span>)</span><br><span class="line">            .projectId(<span class="string">&quot;project-456&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">when</span>(gcsClient.generateSignedUploadUrl(any(), any(), any(), any()))</span><br><span class="line">            .thenReturn(<span class="string">&quot;https://storage.googleapis.com/signed-url&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When</span></span><br><span class="line">        ResponseEntity&lt;FileUploadResponse&gt; response = restTemplate.postForEntity(</span><br><span class="line">            <span class="string">&quot;/api/v1/files/upload&quot;</span>,</span><br><span class="line">            request,</span><br><span class="line">            FileUploadResponse.class</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Then</span></span><br><span class="line">        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);</span><br><span class="line">        assertThat(response.getBody().getFileId()).isNotNull();</span><br><span class="line">        assertThat(response.getBody().getUploadUrl()).contains(<span class="string">&quot;signed-url&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldHandleChunkedUploadFlow</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Given</span></span><br><span class="line">        <span class="type">ChunkedUploadRequest</span> <span class="variable">request</span> <span class="operator">=</span> ChunkedUploadRequest.builder()</span><br><span class="line">            .originalFilename(<span class="string">&quot;large-file.zip&quot;</span>)</span><br><span class="line">            .fileSize(<span class="number">50_000_000L</span>)</span><br><span class="line">            .mimeType(<span class="string">&quot;application/zip&quot;</span>)</span><br><span class="line">            .fileHash(<span class="string">&quot;efgh5678&quot;</span>)</span><br><span class="line">            .userId(<span class="string">&quot;user-123&quot;</span>)</span><br><span class="line">            .totalChunks(<span class="number">10</span>)</span><br><span class="line">            .chunkSize(<span class="number">5_000_000</span>)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">when</span>(gcsClient.initiateMultipartUpload(any(), any(), any()))</span><br><span class="line">            .thenReturn(<span class="string">&quot;multipart-upload-id&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When - Initiate chunked upload</span></span><br><span class="line">        ResponseEntity&lt;ChunkedUploadResponse&gt; initResponse = restTemplate.postForEntity(</span><br><span class="line">            <span class="string">&quot;/api/v1/files/upload/chunked&quot;</span>,</span><br><span class="line">            request,</span><br><span class="line">            ChunkedUploadResponse.class</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Then</span></span><br><span class="line">        assertThat(initResponse.getStatusCode()).isEqualTo(HttpStatus.CREATED);</span><br><span class="line">        <span class="type">String</span> <span class="variable">uploadId</span> <span class="operator">=</span> initResponse.getBody().getUploadId();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When - Get chunk upload URLs</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">when</span>(gcsClient.generateSignedChunkUploadUrl(any(), eq(i), any()))</span><br><span class="line">                .thenReturn(<span class="string">&quot;https://storage.googleapis.com/chunk-&quot;</span> + i);</span><br><span class="line">            </span><br><span class="line">            ResponseEntity&lt;ChunkUploadResponse&gt; chunkResponse = restTemplate.postForEntity(</span><br><span class="line">                <span class="string">&quot;/api/v1/files/upload/chunked/&quot;</span> + uploadId + <span class="string">&quot;/chunks/&quot;</span> + i,</span><br><span class="line">                <span class="literal">null</span>,</span><br><span class="line">                ChunkUploadResponse.class</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            assertThat(chunkResponse.getStatusCode()).isEqualTo(HttpStatus.OK);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When - Complete upload</span></span><br><span class="line">        <span class="type">CompleteChunkedUploadRequest</span> <span class="variable">completeRequest</span> <span class="operator">=</span> CompleteChunkedUploadRequest.builder()</span><br><span class="line">            .uploadId(uploadId)</span><br><span class="line">            .chunks(IntStream.rangeClosed(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">                .mapToObj(i -&gt; <span class="keyword">new</span> <span class="title class_">ChunkInfo</span>(i, <span class="string">&quot;etag-&quot;</span> + i))</span><br><span class="line">                .collect(Collectors.toList()))</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">when</span>(gcsClient.completeMultipartUpload(any(), any()))</span><br><span class="line">            .thenReturn(<span class="string">&quot;final-object-key&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        ResponseEntity&lt;FileUploadResponse&gt; completeResponse = restTemplate.postForEntity(</span><br><span class="line">            <span class="string">&quot;/api/v1/files/upload/chunked/&quot;</span> + uploadId + <span class="string">&quot;/complete&quot;</span>,</span><br><span class="line">            completeRequest,</span><br><span class="line">            FileUploadResponse.class</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Then</span></span><br><span class="line">        assertThat(completeResponse.getStatusCode()).isEqualTo(HttpStatus.OK);</span><br><span class="line">        assertThat(completeResponse.getBody().getFileId()).isNotNull();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Common-Interview-Questions-Answers"><a href="#Common-Interview-Questions-Answers" class="headerlink" title="Common Interview Questions &amp; Answers"></a>Common Interview Questions &amp; Answers</h2><p><strong>Q: How do you handle concurrent uploads of the same file?</strong></p>
<p>A: We implement file deduplication using SHA-256 hashes. When a file upload request comes in, we first check if a file with the same hash already exists for that project. If deduplication is enabled and the file exists, we return a reference to the existing file instead of creating a duplicate. For concurrent uploads of different files, we use database transactions and optimistic locking to handle race conditions.</p>
<p><strong>Q: How do you ensure data consistency during chunked uploads?</strong></p>
<p>A: We use a multi-phase approach:</p>
<ol>
<li>Database transactions ensure atomicity of metadata operations</li>
<li>Each chunk upload is tracked individually with ETags from GCS</li>
<li>We implement a completion verification step that validates all chunks before finalizing</li>
<li>Failed uploads are automatically cleaned up using scheduled tasks</li>
<li>We use optimistic locking on the chunked_uploads table to prevent race conditions</li>
</ol>
<p><strong>Q: How do you handle failures during large file uploads?</strong></p>
<p>A: Our resilience strategy includes:</p>
<ol>
<li><strong>Retry mechanisms</strong>: Exponential backoff for transient failures</li>
<li><strong>Circuit breakers</strong>: Prevent cascading failures to GCS</li>
<li><strong>Cleanup jobs</strong>: Remove orphaned uploads after expiration</li>
<li><strong>Resume capability</strong>: Clients can query upload status and resume from the last successful chunk</li>
<li><strong>Monitoring</strong>: Real-time alerts for high failure rates</li>
</ol>
<p><strong>Q: How do you scale the service horizontally?</strong></p>
<p>A: The service is designed to be stateless and cloud-native:</p>
<ol>
<li><strong>Stateless design</strong>: All upload state is stored in PostgreSQL&#x2F;Redis</li>
<li><strong>Load balancing</strong>: Multiple service instances behind a load balancer</li>
<li><strong>Database connection pooling</strong>: Efficient resource utilization</li>
<li><strong>Caching</strong>: Redis for frequently accessed metadata</li>
<li><strong>Auto-scaling</strong>: Kubernetes HPA based on CPU&#x2F;memory metrics</li>
<li><strong>CDN integration</strong>: CloudFront for global file delivery</li>
</ol>
<p><strong>Q: How do you handle different file types and validation?</strong></p>
<p>A: We implement a comprehensive validation framework:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileValidator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, FileTypeValidator&gt; validators;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> VirusScanner virusScanner;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ValidationResult <span class="title function_">validateFile</span><span class="params">(FileUploadRequest request, InputStream fileStream)</span> &#123;</span><br><span class="line">        <span class="type">ValidationResult</span> <span class="variable">result</span> <span class="operator">=</span> ValidationResult.success();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Basic validations</span></span><br><span class="line">        result.merge(validateFileSize(request.getFileSize()));</span><br><span class="line">        result.merge(validateMimeType(request.getMimeType()));</span><br><span class="line">        result.merge(validateFilename(request.getOriginalFilename()));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Content-specific validation</span></span><br><span class="line">        <span class="type">FileTypeValidator</span> <span class="variable">validator</span> <span class="operator">=</span> validators.get(request.getMimeType());</span><br><span class="line">        <span class="keyword">if</span> (validator != <span class="literal">null</span>) &#123;</span><br><span class="line">            result.merge(validator.validate(fileStream));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Security scan</span></span><br><span class="line">        <span class="keyword">if</span> (result.isValid()) &#123;</span><br><span class="line">            result.merge(virusScanner.scan(fileStream));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Q: How do you implement file versioning?</strong></p>
<p>A: File versioning can be implemented by extending the schema:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Add version tracking to files table</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> files <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> version_number <span class="type">INTEGER</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">ALTER TABLE</span> files <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> parent_file_id UUID <span class="keyword">REFERENCES</span> files(id);</span><br><span class="line"><span class="keyword">ALTER TABLE</span> files <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> is_latest_version <span class="type">BOOLEAN</span> <span class="keyword">DEFAULT</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Index for efficient version queries</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_files_parent_version <span class="keyword">ON</span> files(parent_file_id, version_number);</span><br></pre></td></tr></table></figure>

<p>This allows tracking file history while maintaining backward compatibility with existing APIs.</p>
<h2 id="Best-Practices-and-Recommendations"><a href="#Best-Practices-and-Recommendations" class="headerlink" title="Best Practices and Recommendations"></a>Best Practices and Recommendations</h2><h3 id="Production-Deployment-Checklist"><a href="#Production-Deployment-Checklist" class="headerlink" title="Production Deployment Checklist"></a>Production Deployment Checklist</h3><ul>
<li><strong>Security</strong>: Implement proper authentication, authorization, and input validation</li>
<li><strong>Monitoring</strong>: Set up comprehensive logging, metrics, and alerting</li>
<li><strong>Performance</strong>: Implement caching, connection pooling, and query optimization</li>
<li><strong>Reliability</strong>: Use circuit breakers, retry mechanisms, and graceful degradation</li>
<li><strong>Scalability</strong>: Design for horizontal scaling with stateless services</li>
<li><strong>Data Protection</strong>: Implement backup strategies and disaster recovery</li>
<li><strong>Compliance</strong>: Ensure GDPR&#x2F;compliance requirements for file metadata and deletion</li>
</ul>
<h3 id="External-Resources"><a href="#External-Resources" class="headerlink" title="External Resources"></a>External Resources</h3><ul>
<li><a target="_blank" rel="noopener" href="https://cloud.google.com/storage/docs/best-practices">Google Cloud Storage Best Practices</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.postgresql.org/wiki/Performance_Optimization">PostgreSQL Performance Tuning</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html">Spring Boot Production Guidelines</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/storage/">Kubernetes File Storage Patterns</a></li>
<li><a target="_blank" rel="noopener" href="https://microservices.io/patterns/observability/audit-logging.html">Microservices Observability</a></li>
</ul>
<p>This comprehensive guide provides a production-ready foundation for building a scalable, secure, and maintainable file storage service. The modular design allows for easy extension and customization based on specific business requirements.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/09/11/Design-File-Storage-Service-with-GCS-and-Postgrel/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/09/11/Design-File-Storage-Service-with-GCS-and-Postgrel/" class="post-title-link" itemprop="url">Design File Storage Service with GCS and PostgreSQL</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-09-11 00:09:52 / Modified: 00:17:22" itemprop="dateCreated datePublished" datetime="2025-09-11T00:09:52+08:00">2025-09-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system-design/" itemprop="url" rel="index"><span itemprop="name">system-design</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="System-Overview"><a href="#System-Overview" class="headerlink" title="System Overview"></a>System Overview</h2><p>The File Storage Service is a robust, scalable solution for handling file uploads, storage, and retrieval operations. Built on Google Cloud Storage (GCS) and PostgreSQL, it provides enterprise-grade file management capabilities with comprehensive SDK support for seamless integration.</p>
<h3 id="Architecture-Goals"><a href="#Architecture-Goals" class="headerlink" title="Architecture Goals"></a>Architecture Goals</h3><ul>
<li><strong>Scalability</strong>: Handle millions of files with horizontal scaling</li>
<li><strong>Reliability</strong>: 99.9% uptime with fault tolerance</li>
<li><strong>Security</strong>: End-to-end encryption and access control</li>
<li><strong>Performance</strong>: Sub-second response times for file operations</li>
<li><strong>Cost Efficiency</strong>: Intelligent storage tiering and lifecycle management</li>
</ul>
<h2 id="High-Level-Architecture"><a href="#High-Level-Architecture" class="headerlink" title="High-Level Architecture"></a>High-Level Architecture</h2><pre>
<code class="mermaid">
graph TB
subgraph &quot;Client Layer&quot;
    A[Web Client] 
    B[Mobile Client]
    C[Service Integration]
end

subgraph &quot;API Gateway&quot;
    D[Load Balancer]
    E[Authentication]
    F[Rate Limiting]
end

subgraph &quot;File Storage Service&quot;
    G[Upload Controller]
    H[Download Controller]
    I[Metadata Service]
    J[Chunk Manager]
end

subgraph &quot;Storage Layer&quot;
    K[PostgreSQL&lt;br&#x2F;&gt;Metadata DB]
    L[Redis&lt;br&#x2F;&gt;Cache Layer]
    M[Google Cloud Storage&lt;br&#x2F;&gt;File Storage]
end

subgraph &quot;External Services&quot;
    N[Notification Service]
    O[Audit Service]
    P[Monitoring]
end

A --&gt; D
B --&gt; D
C --&gt; D
D --&gt; E
E --&gt; F
F --&gt; G
F --&gt; H
G --&gt; I
H --&gt; I
G --&gt; J
I --&gt; K
I --&gt; L
J --&gt; M
G --&gt; M
H --&gt; M
I --&gt; N
I --&gt; O
G --&gt; P
H --&gt; P
</code>
</pre>

<h2 id="Core-Components-Deep-Dive"><a href="#Core-Components-Deep-Dive" class="headerlink" title="Core Components Deep Dive"></a>Core Components Deep Dive</h2><h3 id="File-Upload-Service"><a href="#File-Upload-Service" class="headerlink" title="File Upload Service"></a>File Upload Service</h3><p>The upload service handles both single-shot uploads and chunked uploads for large files, implementing resumable upload patterns for reliability.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/v1/files&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileUploadController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileUploadService fileUploadService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChunkManagerService chunkManagerService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileValidationService validationService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;FileUploadResponse&gt; <span class="title function_">uploadFile</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(value = &quot;projectId&quot;, required = false)</span> String projectId,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(value = &quot;metadata&quot;, required = false)</span> String metadata)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Validate file</span></span><br><span class="line">        validationService.validateFile(file);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Determine upload strategy</span></span><br><span class="line">        <span class="keyword">if</span> (file.getSize() &gt; MAX_SINGLE_UPLOAD_SIZE) &#123;</span><br><span class="line">            <span class="keyword">return</span> initiateChunkedUpload(file, projectId, metadata);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> uploadDirectly(file, projectId, metadata);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload/chunked/initiate&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;ChunkedUploadResponse&gt; <span class="title function_">initiateChunkedUpload</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestBody</span> ChunkedUploadRequest request)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">uploadId</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        <span class="type">ChunkedUploadSession</span> <span class="variable">session</span> <span class="operator">=</span> chunkManagerService.createUploadSession(</span><br><span class="line">            uploadId, request.getFileName(), request.getTotalSize(), </span><br><span class="line">            request.getChunkSize(), request.getProjectId()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(ChunkedUploadResponse.builder()</span><br><span class="line">            .uploadId(uploadId)</span><br><span class="line">            .totalChunks(session.getTotalChunks())</span><br><span class="line">            .chunkSize(session.getChunkSize())</span><br><span class="line">            .build());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PutMapping(&quot;/upload/chunked/&#123;uploadId&#125;/chunk/&#123;chunkNumber&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;ChunkUploadResponse&gt; <span class="title function_">uploadChunk</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String uploadId,</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> <span class="type">int</span> chunkNumber,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;chunk&quot;)</span> MultipartFile chunk)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">ChunkUploadResult</span> <span class="variable">result</span> <span class="operator">=</span> chunkManagerService.uploadChunk(</span><br><span class="line">            uploadId, chunkNumber, chunk</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (result.isComplete()) &#123;</span><br><span class="line">            <span class="comment">// All chunks uploaded, finalize the file</span></span><br><span class="line">            <span class="type">FileMetadata</span> <span class="variable">fileMetadata</span> <span class="operator">=</span> chunkManagerService.finalizeUpload(uploadId);</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.ok(ChunkUploadResponse.builder()</span><br><span class="line">                .chunkNumber(chunkNumber)</span><br><span class="line">                .completed(<span class="literal">true</span>)</span><br><span class="line">                .fileUrl(fileMetadata.getDownloadUrl())</span><br><span class="line">                .fileId(fileMetadata.getFileId())</span><br><span class="line">                .build());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(ChunkUploadResponse.builder()</span><br><span class="line">            .chunkNumber(chunkNumber)</span><br><span class="line">            .completed(<span class="literal">false</span>)</span><br><span class="line">            .build());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Chunk-Management-System"><a href="#Chunk-Management-System" class="headerlink" title="Chunk Management System"></a>Chunk Management System</h3><p>For files larger than 10MB, the system implements intelligent chunking with resumable uploads:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChunkManagerService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GcsService gcsService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileMetadataRepository metadataRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_CHUNK_SIZE</span> <span class="operator">=</span> <span class="number">5</span> * <span class="number">1024</span> * <span class="number">1024</span>; <span class="comment">// 5MB</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CHUNK_SESSION_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;chunk_session:&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ChunkedUploadSession <span class="title function_">createUploadSession</span><span class="params">(String uploadId, </span></span><br><span class="line"><span class="params">            String fileName, <span class="type">long</span> totalSize, <span class="type">int</span> chunkSize, String projectId)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> <span class="variable">totalChunks</span> <span class="operator">=</span> (<span class="type">int</span>) Math.ceil((<span class="type">double</span>) totalSize / chunkSize);</span><br><span class="line">        </span><br><span class="line">        <span class="type">ChunkedUploadSession</span> <span class="variable">session</span> <span class="operator">=</span> ChunkedUploadSession.builder()</span><br><span class="line">            .uploadId(uploadId)</span><br><span class="line">            .fileName(fileName)</span><br><span class="line">            .totalSize(totalSize)</span><br><span class="line">            .chunkSize(chunkSize)</span><br><span class="line">            .totalChunks(totalChunks)</span><br><span class="line">            .projectId(projectId)</span><br><span class="line">            .uploadedChunks(<span class="keyword">new</span> <span class="title class_">BitSet</span>(totalChunks))</span><br><span class="line">            .createdAt(Instant.now())</span><br><span class="line">            .expiresAt(Instant.now().plus(Duration.ofHours(<span class="number">24</span>)))</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Store session in Redis with TTL</span></span><br><span class="line">        redisTemplate.opsForValue().set(</span><br><span class="line">            CHUNK_SESSION_PREFIX + uploadId, </span><br><span class="line">            session, </span><br><span class="line">            Duration.ofHours(<span class="number">24</span>)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> session;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> ChunkUploadResult <span class="title function_">uploadChunk</span><span class="params">(String uploadId, <span class="type">int</span> chunkNumber, </span></span><br><span class="line"><span class="params">            MultipartFile chunk)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">ChunkedUploadSession</span> <span class="variable">session</span> <span class="operator">=</span> getUploadSession(uploadId);</span><br><span class="line">        <span class="keyword">if</span> (session == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UploadSessionNotFoundException</span>(<span class="string">&quot;Upload session not found: &quot;</span> + uploadId);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Validate chunk</span></span><br><span class="line">        validateChunk(session, chunkNumber, chunk);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Upload chunk to GCS with temporary naming</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">tempChunkPath</span> <span class="operator">=</span> generateTempChunkPath(uploadId, chunkNumber);</span><br><span class="line">        gcsService.uploadChunk(chunk.getInputStream(), tempChunkPath);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Update session state</span></span><br><span class="line">        session.getUploadedChunks().set(chunkNumber - <span class="number">1</span>);</span><br><span class="line">        updateUploadSession(session);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check if all chunks are uploaded</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isComplete</span> <span class="operator">=</span> session.getUploadedChunks().cardinality() == session.getTotalChunks();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ChunkUploadResult.builder()</span><br><span class="line">            .chunkNumber(chunkNumber)</span><br><span class="line">            .complete(isComplete)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> FileMetadata <span class="title function_">finalizeUpload</span><span class="params">(String uploadId)</span> &#123;</span><br><span class="line">        <span class="type">ChunkedUploadSession</span> <span class="variable">session</span> <span class="operator">=</span> getUploadSession(uploadId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Combine all chunks into final file</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">finalFilePath</span> <span class="operator">=</span> generateFinalFilePath(session);</span><br><span class="line">        List&lt;String&gt; chunkPaths = generateChunkPaths(uploadId, session.getTotalChunks());</span><br><span class="line">        </span><br><span class="line">        gcsService.combineChunks(chunkPaths, finalFilePath);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Create file metadata</span></span><br><span class="line">        <span class="type">FileMetadata</span> <span class="variable">metadata</span> <span class="operator">=</span> FileMetadata.builder()</span><br><span class="line">            .fileId(UUID.randomUUID().toString())</span><br><span class="line">            .originalFileName(session.getFileName())</span><br><span class="line">            .gcsPath(finalFilePath)</span><br><span class="line">            .fileSize(session.getTotalSize())</span><br><span class="line">            .projectId(session.getProjectId())</span><br><span class="line">            .uploadedAt(Instant.now())</span><br><span class="line">            .downloadUrl(gcsService.generateSignedUrl(finalFilePath, Duration.ofDays(<span class="number">365</span>)))</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        metadataRepository.save(metadata);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Clean up chunks and session</span></span><br><span class="line">        cleanupChunks(chunkPaths);</span><br><span class="line">        deleteUploadSession(uploadId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> metadata;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Database-Schema-Design"><a href="#Database-Schema-Design" class="headerlink" title="Database Schema Design"></a>Database Schema Design</h3><p>The PostgreSQL schema is optimized for query performance and supports file versioning:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Files table for storing file metadata</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> files (</span><br><span class="line">    file_id <span class="type">VARCHAR</span>(<span class="number">36</span>) <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    original_filename <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    content_type <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    file_size <span class="type">BIGINT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    gcs_bucket <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    gcs_path <span class="type">VARCHAR</span>(<span class="number">500</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    project_id <span class="type">VARCHAR</span>(<span class="number">36</span>),</span><br><span class="line">    upload_session_id <span class="type">VARCHAR</span>(<span class="number">36</span>),</span><br><span class="line">    checksum_md5 <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    checksum_sha256 <span class="type">VARCHAR</span>(<span class="number">64</span>),</span><br><span class="line">    encryption_key_id <span class="type">VARCHAR</span>(<span class="number">36</span>),</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">WITH</span> <span class="type">TIME</span> ZONE <span class="keyword">DEFAULT</span> NOW(),</span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span> <span class="keyword">WITH</span> <span class="type">TIME</span> ZONE <span class="keyword">DEFAULT</span> NOW(),</span><br><span class="line">    deleted_at <span class="type">TIMESTAMP</span> <span class="keyword">WITH</span> <span class="type">TIME</span> ZONE,</span><br><span class="line">    created_by <span class="type">VARCHAR</span>(<span class="number">36</span>),</span><br><span class="line">    tags JSONB,</span><br><span class="line">    metadata JSONB</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- File versions for supporting file versioning</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> file_versions (</span><br><span class="line">    version_id <span class="type">VARCHAR</span>(<span class="number">36</span>) <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    file_id <span class="type">VARCHAR</span>(<span class="number">36</span>) <span class="keyword">REFERENCES</span> files(file_id),</span><br><span class="line">    version_number <span class="type">INTEGER</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    gcs_path <span class="type">VARCHAR</span>(<span class="number">500</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    file_size <span class="type">BIGINT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    checksum_md5 <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">WITH</span> <span class="type">TIME</span> ZONE <span class="keyword">DEFAULT</span> NOW(),</span><br><span class="line">    created_by <span class="type">VARCHAR</span>(<span class="number">36</span>),</span><br><span class="line">    change_description TEXT</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Upload sessions for chunked uploads</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> upload_sessions (</span><br><span class="line">    session_id <span class="type">VARCHAR</span>(<span class="number">36</span>) <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    original_filename <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    total_size <span class="type">BIGINT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    chunk_size <span class="type">INTEGER</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    total_chunks <span class="type">INTEGER</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    uploaded_chunks_bitmap TEXT,</span><br><span class="line">    project_id <span class="type">VARCHAR</span>(<span class="number">36</span>),</span><br><span class="line">    status <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;IN_PROGRESS&#x27;</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">WITH</span> <span class="type">TIME</span> ZONE <span class="keyword">DEFAULT</span> NOW(),</span><br><span class="line">    expires_at <span class="type">TIMESTAMP</span> <span class="keyword">WITH</span> <span class="type">TIME</span> ZONE <span class="keyword">NOT NULL</span>,</span><br><span class="line">    created_by <span class="type">VARCHAR</span>(<span class="number">36</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Indexes for performance optimization</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_files_project_id <span class="keyword">ON</span> files(project_id);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_files_created_at <span class="keyword">ON</span> files(created_at);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_files_deleted_at <span class="keyword">ON</span> files(deleted_at) <span class="keyword">WHERE</span> deleted_at <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_files_tags <span class="keyword">ON</span> files <span class="keyword">USING</span> GIN(tags);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_file_versions_file_id <span class="keyword">ON</span> file_versions(file_id);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_upload_sessions_expires_at <span class="keyword">ON</span> upload_sessions(expires_at);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Partitioning for large datasets (optional)</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> files_2024 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> files</span><br><span class="line">    <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="string">&#x27;2024-01-01&#x27;</span>) <span class="keyword">TO</span> (<span class="string">&#x27;2025-01-01&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="GCS-Integration-Service"><a href="#GCS-Integration-Service" class="headerlink" title="GCS Integration Service"></a>GCS Integration Service</h3><p>The GCS service handles actual file storage with intelligent lifecycle management:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GcsService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Storage storage;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String bucketName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String cdnDomain;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Duration</span> <span class="variable">DEFAULT_SIGNED_URL_DURATION</span> <span class="operator">=</span> Duration.ofHours(<span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">uploadFile</span><span class="params">(InputStream inputStream, String fileName, </span></span><br><span class="line"><span class="params">            String contentType, Map&lt;String, String&gt; metadata)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">gcsPath</span> <span class="operator">=</span> generateGcsPath(fileName);</span><br><span class="line">        </span><br><span class="line">        <span class="type">BlobId</span> <span class="variable">blobId</span> <span class="operator">=</span> BlobId.of(bucketName, gcsPath);</span><br><span class="line">        BlobInfo.<span class="type">Builder</span> <span class="variable">blobInfoBuilder</span> <span class="operator">=</span> BlobInfo.newBuilder(blobId)</span><br><span class="line">            .setContentType(contentType)</span><br><span class="line">            .setCacheControl(<span class="string">&quot;public, max-age=31536000&quot;</span>); <span class="comment">// 1 year cache</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Add custom metadata</span></span><br><span class="line">        <span class="keyword">if</span> (metadata != <span class="literal">null</span>) &#123;</span><br><span class="line">            blobInfoBuilder.setMetadata(metadata);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Set storage class based on file characteristics</span></span><br><span class="line">        <span class="type">StorageClass</span> <span class="variable">storageClass</span> <span class="operator">=</span> determineStorageClass(fileName, metadata);</span><br><span class="line">        blobInfoBuilder.setStorageClass(storageClass);</span><br><span class="line">        </span><br><span class="line">        <span class="type">BlobInfo</span> <span class="variable">blobInfo</span> <span class="operator">=</span> blobInfoBuilder.build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Blob</span> <span class="variable">blob</span> <span class="operator">=</span> storage.create(blobInfo, inputStream);</span><br><span class="line">            <span class="keyword">return</span> blob.getName();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileStorageException</span>(<span class="string">&quot;Failed to upload file to GCS&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generateSignedUrl</span><span class="params">(String gcsPath, Duration duration)</span> &#123;</span><br><span class="line">        <span class="type">BlobId</span> <span class="variable">blobId</span> <span class="operator">=</span> BlobId.of(bucketName, gcsPath);</span><br><span class="line">        </span><br><span class="line">        <span class="type">URL</span> <span class="variable">signedUrl</span> <span class="operator">=</span> storage.signUrl(</span><br><span class="line">            BlobInfo.newBuilder(blobId).build(),</span><br><span class="line">            duration.toMillis(),</span><br><span class="line">            TimeUnit.MILLISECONDS,</span><br><span class="line">            Storage.SignUrlOption.httpMethod(HttpMethod.GET)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> signedUrl.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">combineChunks</span><span class="params">(List&lt;String&gt; chunkPaths, String finalPath)</span> &#123;</span><br><span class="line">        <span class="type">BlobId</span> <span class="variable">finalBlobId</span> <span class="operator">=</span> BlobId.of(bucketName, finalPath);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Use GCS compose operation for efficient chunk combination</span></span><br><span class="line">        Storage.ComposeRequest.<span class="type">Builder</span> <span class="variable">composeBuilder</span> <span class="operator">=</span> Storage.ComposeRequest.newBuilder()</span><br><span class="line">            .setTarget(BlobInfo.newBuilder(finalBlobId).build());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String chunkPath : chunkPaths) &#123;</span><br><span class="line">            <span class="type">BlobId</span> <span class="variable">chunkBlobId</span> <span class="operator">=</span> BlobId.of(bucketName, chunkPath);</span><br><span class="line">            composeBuilder.addSource(chunkBlobId);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        storage.compose(composeBuilder.build());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> StorageClass <span class="title function_">determineStorageClass</span><span class="params">(String fileName, Map&lt;String, String&gt; metadata)</span> &#123;</span><br><span class="line">        <span class="comment">// Intelligent storage class selection based on file type and metadata</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileExtension</span> <span class="operator">=</span> getFileExtension(fileName);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Archive files go to coldline storage</span></span><br><span class="line">        <span class="keyword">if</span> (isArchiveFile(fileExtension)) &#123;</span><br><span class="line">            <span class="keyword">return</span> StorageClass.COLDLINE;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Frequently accessed files use standard storage</span></span><br><span class="line">        <span class="keyword">return</span> StorageClass.STANDARD;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Lifecycle management</span></span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0 2 * * *&quot;)</span> <span class="comment">// Daily at 2 AM</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">optimizeStorageClasses</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Move infrequently accessed files to cheaper storage classes</span></span><br><span class="line">        <span class="comment">// This could be based on access patterns, file age, etc.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="File-Storage-SDK-Design"><a href="#File-Storage-SDK-Design" class="headerlink" title="File Storage SDK Design"></a>File Storage SDK Design</h2><p>The SDK provides a clean, intuitive interface for client applications:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageClient</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String baseUrl;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String apiKey;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OkHttpClient httpClient;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectMapper objectMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FileStorageClient</span><span class="params">(String baseUrl, String apiKey)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.baseUrl = baseUrl;</span><br><span class="line">        <span class="built_in">this</span>.apiKey = apiKey;</span><br><span class="line">        <span class="built_in">this</span>.httpClient = createHttpClient();</span><br><span class="line">        <span class="built_in">this</span>.objectMapper = <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Upload a single file</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> FileUploadResult <span class="title function_">uploadFile</span><span class="params">(File file, UploadOptions options)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (file.length() &gt; options.getChunkThreshold()) &#123;</span><br><span class="line">            <span class="keyword">return</span> uploadFileChunked(file, options);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> uploadFileDirect(file, options);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Upload file with progress callback</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> FileUploadResult <span class="title function_">uploadFile</span><span class="params">(File file, UploadOptions options, </span></span><br><span class="line"><span class="params">            ProgressCallback progressCallback)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> uploadFileChunked(file, options, progressCallback);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Download file by ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> InputStream <span class="title function_">downloadFile</span><span class="params">(String fileId)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">FileMetadata</span> <span class="variable">metadata</span> <span class="operator">=</span> getFileMetadata(fileId);</span><br><span class="line">        <span class="keyword">return</span> downloadFileByUrl(metadata.getDownloadUrl());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get file metadata</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> FileMetadata <span class="title function_">getFileMetadata</span><span class="params">(String fileId)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">            .url(baseUrl + <span class="string">&quot;/api/v1/files/&quot;</span> + fileId + <span class="string">&quot;/metadata&quot;</span>)</span><br><span class="line">            .addHeader(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;Bearer &quot;</span> + apiKey)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> httpClient.newCall(request).execute()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!response.isSuccessful()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;Failed to get file metadata: &quot;</span> + response.code());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> objectMapper.readValue(response.body().string(), FileMetadata.class);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * List files with pagination and filtering</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> PagedResult&lt;FileMetadata&gt; <span class="title function_">listFiles</span><span class="params">(FileQuery query)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        HttpUrl.<span class="type">Builder</span> <span class="variable">urlBuilder</span> <span class="operator">=</span> HttpUrl.parse(baseUrl + <span class="string">&quot;/api/v1/files&quot;</span>).newBuilder();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (query.getProjectId() != <span class="literal">null</span>) &#123;</span><br><span class="line">            urlBuilder.addQueryParameter(<span class="string">&quot;projectId&quot;</span>, query.getProjectId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (query.getFileType() != <span class="literal">null</span>) &#123;</span><br><span class="line">            urlBuilder.addQueryParameter(<span class="string">&quot;fileType&quot;</span>, query.getFileType());</span><br><span class="line">        &#125;</span><br><span class="line">        urlBuilder.addQueryParameter(<span class="string">&quot;page&quot;</span>, String.valueOf(query.getPage()));</span><br><span class="line">        urlBuilder.addQueryParameter(<span class="string">&quot;size&quot;</span>, String.valueOf(query.getSize()));</span><br><span class="line">        </span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">            .url(urlBuilder.build())</span><br><span class="line">            .addHeader(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;Bearer &quot;</span> + apiKey)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> httpClient.newCall(request).execute()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!response.isSuccessful()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;Failed to list files: &quot;</span> + response.code());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            TypeReference&lt;PagedResult&lt;FileMetadata&gt;&gt; typeRef = </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;PagedResult&lt;FileMetadata&gt;&gt;() &#123;&#125;;</span><br><span class="line">            <span class="keyword">return</span> objectMapper.readValue(response.body().string(), typeRef);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Delete file (soft delete)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteFile</span><span class="params">(String fileId)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">            .url(baseUrl + <span class="string">&quot;/api/v1/files/&quot;</span> + fileId)</span><br><span class="line">            .delete()</span><br><span class="line">            .addHeader(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;Bearer &quot;</span> + apiKey)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> httpClient.newCall(request).execute()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!response.isSuccessful()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;Failed to delete file: &quot;</span> + response.code());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> FileUploadResult <span class="title function_">uploadFileChunked</span><span class="params">(File file, UploadOptions options, </span></span><br><span class="line"><span class="params">            ProgressCallback progressCallback)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Initiate chunked upload</span></span><br><span class="line">            <span class="type">ChunkedUploadResponse</span> <span class="variable">initResponse</span> <span class="operator">=</span> initiateChunkedUpload(file, options);</span><br><span class="line">            </span><br><span class="line">            <span class="type">long</span> <span class="variable">uploadedBytes</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">chunkSize</span> <span class="operator">=</span> initResponse.getChunkSize();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> (<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file)) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">chunkNumber</span> <span class="operator">=</span> <span class="number">1</span>; chunkNumber &lt;= initResponse.getTotalChunks(); chunkNumber++) &#123;</span><br><span class="line">                    <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[Math.min(chunkSize, (<span class="type">int</span>) (file.length() - uploadedBytes))];</span><br><span class="line">                    <span class="type">int</span> <span class="variable">bytesRead</span> <span class="operator">=</span> fis.read(buffer);</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (bytesRead &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        uploadChunk(initResponse.getUploadId(), chunkNumber, </span><br><span class="line">                            Arrays.copyOf(buffer, bytesRead));</span><br><span class="line">                        uploadedBytes += bytesRead;</span><br><span class="line">                        </span><br><span class="line">                        <span class="keyword">if</span> (progressCallback != <span class="literal">null</span>) &#123;</span><br><span class="line">                            progressCallback.onProgress(uploadedBytes, file.length());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// All chunks uploaded successfully</span></span><br><span class="line">            <span class="keyword">return</span> FileUploadResult.builder()</span><br><span class="line">                .fileId(initResponse.getFinalFileId())</span><br><span class="line">                .downloadUrl(initResponse.getFinalDownloadUrl())</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileUploadException</span>(<span class="string">&quot;Failed to upload file&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Security-Implementation"><a href="#Security-Implementation" class="headerlink" title="Security Implementation"></a>Security Implementation</h2><h3 id="Authentication-and-Authorization"><a href="#Authentication-and-Authorization" class="headerlink" title="Authentication and Authorization"></a>Authentication and Authorization</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileAccessSecurityService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtTokenProvider tokenProvider;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserService userService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ProjectService projectService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">canAccessFile</span><span class="params">(String userId, String fileId, FileOperation operation)</span> &#123;</span><br><span class="line">        <span class="type">FileMetadata</span> <span class="variable">fileMetadata</span> <span class="operator">=</span> getFileMetadata(fileId);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getUser(userId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check project-level permissions</span></span><br><span class="line">        <span class="keyword">if</span> (fileMetadata.getProjectId() != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">ProjectPermission</span> <span class="variable">permission</span> <span class="operator">=</span> projectService.getUserPermission(</span><br><span class="line">                userId, fileMetadata.getProjectId()</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> hasRequiredPermission(permission, operation);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check file-level permissions</span></span><br><span class="line">        <span class="keyword">return</span> fileMetadata.getCreatedBy().equals(userId) || user.isAdmin();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;@fileAccessSecurityService.canAccessFile(authentication.name, #fileId, &#x27;READ&#x27;)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> FileMetadata <span class="title function_">getFile</span><span class="params">(String fileId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fileMetadataRepository.findById(fileId)</span><br><span class="line">            .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">FileNotFoundException</span>(<span class="string">&quot;File not found: &quot;</span> + fileId));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">hasRequiredPermission</span><span class="params">(ProjectPermission permission, FileOperation operation)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (operation) &#123;</span><br><span class="line">            <span class="keyword">case</span> READ:</span><br><span class="line">                <span class="keyword">return</span> permission.canRead();</span><br><span class="line">            <span class="keyword">case</span> WRITE:</span><br><span class="line">                <span class="keyword">return</span> permission.canWrite();</span><br><span class="line">            <span class="keyword">case</span> DELETE:</span><br><span class="line">                <span class="keyword">return</span> permission.canDelete();</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="File-Encryption"><a href="#File-Encryption" class="headerlink" title="File Encryption"></a>File Encryption</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileEncryptionService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GoogleKmsService kmsService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String keyRingName;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> EncryptedUploadStream <span class="title function_">encryptFile</span><span class="params">(InputStream inputStream, String fileId)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Generate data encryption key (DEK)</span></span><br><span class="line">            <span class="type">byte</span>[] dek = generateDataEncryptionKey();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Encrypt DEK with KEK (Key Encryption Key) using Google KMS</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">encryptedDek</span> <span class="operator">=</span> kmsService.encrypt(keyRingName, dek);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Create cipher for file encryption</span></span><br><span class="line">            <span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;AES/GCM/NoPadding&quot;</span>);</span><br><span class="line">            <span class="type">SecretKeySpec</span> <span class="variable">keySpec</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(dek, <span class="string">&quot;AES&quot;</span>);</span><br><span class="line">            cipher.init(Cipher.ENCRYPT_MODE, keySpec);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Store encryption metadata</span></span><br><span class="line">            <span class="type">FileEncryptionMetadata</span> <span class="variable">encryptionMetadata</span> <span class="operator">=</span> FileEncryptionMetadata.builder()</span><br><span class="line">                .fileId(fileId)</span><br><span class="line">                .encryptedDek(encryptedDek)</span><br><span class="line">                .algorithm(<span class="string">&quot;AES-256-GCM&quot;</span>)</span><br><span class="line">                .keyVersion(kmsService.getCurrentKeyVersion())</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">EncryptedUploadStream</span>(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">CipherInputStream</span>(inputStream, cipher),</span><br><span class="line">                encryptionMetadata</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">EncryptionException</span>(<span class="string">&quot;Failed to encrypt file&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> InputStream <span class="title function_">decryptFile</span><span class="params">(InputStream encryptedStream, String fileId)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">FileEncryptionMetadata</span> <span class="variable">metadata</span> <span class="operator">=</span> getEncryptionMetadata(fileId);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Decrypt DEK using KMS</span></span><br><span class="line">            <span class="type">byte</span>[] dek = kmsService.decrypt(metadata.getEncryptedDek());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Create cipher for decryption</span></span><br><span class="line">            <span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;AES/GCM/NoPadding&quot;</span>);</span><br><span class="line">            <span class="type">SecretKeySpec</span> <span class="variable">keySpec</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(dek, <span class="string">&quot;AES&quot;</span>);</span><br><span class="line">            cipher.init(Cipher.DECRYPT_MODE, keySpec);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CipherInputStream</span>(encryptedStream, cipher);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DecryptionException</span>(<span class="string">&quot;Failed to decrypt file&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Optimization-Strategies"><a href="#Performance-Optimization-Strategies" class="headerlink" title="Performance Optimization Strategies"></a>Performance Optimization Strategies</h2><h3 id="Caching-Layer-Implementation"><a href="#Caching-Layer-Implementation" class="headerlink" title="Caching Layer Implementation"></a>Caching Layer Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileCacheService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GcsService gcsService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FILE_METADATA_CACHE_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;file_metadata:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FILE_CONTENT_CACHE_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;file_content:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Duration</span> <span class="variable">METADATA_TTL</span> <span class="operator">=</span> Duration.ofHours(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Duration</span> <span class="variable">SMALL_FILE_TTL</span> <span class="operator">=</span> Duration.ofMinutes(<span class="number">30</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Cacheable(value = &quot;file_metadata&quot;, key = &quot;#fileId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> FileMetadata <span class="title function_">getFileMetadata</span><span class="params">(String fileId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cacheKey</span> <span class="operator">=</span> FILE_METADATA_CACHE_PREFIX + fileId;</span><br><span class="line">        </span><br><span class="line">        <span class="type">FileMetadata</span> <span class="variable">cached</span> <span class="operator">=</span> (FileMetadata) redisTemplate.opsForValue().get(cacheKey);</span><br><span class="line">        <span class="keyword">if</span> (cached != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> cached;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">FileMetadata</span> <span class="variable">metadata</span> <span class="operator">=</span> fileMetadataRepository.findById(fileId)</span><br><span class="line">            .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">FileNotFoundException</span>(<span class="string">&quot;File not found: &quot;</span> + fileId));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Cache metadata</span></span><br><span class="line">        redisTemplate.opsForValue().set(cacheKey, metadata, METADATA_TTL);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> metadata;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> InputStream <span class="title function_">getFileContent</span><span class="params">(String fileId)</span> &#123;</span><br><span class="line">        <span class="type">FileMetadata</span> <span class="variable">metadata</span> <span class="operator">=</span> getFileMetadata(fileId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Cache small files (&lt; 1MB) in Redis</span></span><br><span class="line">        <span class="keyword">if</span> (metadata.getFileSize() &lt; <span class="number">1024</span> * <span class="number">1024</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">cacheKey</span> <span class="operator">=</span> FILE_CONTENT_CACHE_PREFIX + fileId;</span><br><span class="line">            <span class="type">byte</span>[] cachedContent = (<span class="type">byte</span>[]) redisTemplate.opsForValue().get(cacheKey);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (cachedContent != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(cachedContent);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Load from GCS and cache</span></span><br><span class="line">            <span class="type">byte</span>[] content = gcsService.downloadFileAsBytes(metadata.getGcsPath());</span><br><span class="line">            redisTemplate.opsForValue().set(cacheKey, content, SMALL_FILE_TTL);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(content);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Large files: direct stream from GCS</span></span><br><span class="line">        <span class="keyword">return</span> gcsService.downloadFile(metadata.getGcsPath());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Database-Query-Optimization"><a href="#Database-Query-Optimization" class="headerlink" title="Database Query Optimization"></a>Database Query Optimization</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileMetadataRepository</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PersistenceContext</span></span><br><span class="line">    <span class="keyword">private</span> EntityManager entityManager;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Optimized query for file listing with filtering and pagination</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Page&lt;FileMetadata&gt; <span class="title function_">findFilesWithFilters</span><span class="params">(FileSearchCriteria criteria, </span></span><br><span class="line"><span class="params">            Pageable pageable)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">CriteriaBuilder</span> <span class="variable">cb</span> <span class="operator">=</span> entityManager.getCriteriaBuilder();</span><br><span class="line">        CriteriaQuery&lt;FileMetadata&gt; query = cb.createQuery(FileMetadata.class);</span><br><span class="line">        Root&lt;FileMetadata&gt; root = query.from(FileMetadata.class);</span><br><span class="line">        </span><br><span class="line">        List&lt;Predicate&gt; predicates = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Active files only (not soft deleted)</span></span><br><span class="line">        predicates.add(cb.isNull(root.get(<span class="string">&quot;deletedAt&quot;</span>)));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Project filter</span></span><br><span class="line">        <span class="keyword">if</span> (criteria.getProjectId() != <span class="literal">null</span>) &#123;</span><br><span class="line">            predicates.add(cb.equal(root.get(<span class="string">&quot;projectId&quot;</span>), criteria.getProjectId()));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Content type filter</span></span><br><span class="line">        <span class="keyword">if</span> (criteria.getContentType() != <span class="literal">null</span>) &#123;</span><br><span class="line">            predicates.add(cb.like(root.get(<span class="string">&quot;contentType&quot;</span>), criteria.getContentType() + <span class="string">&quot;%&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// File size range filter</span></span><br><span class="line">        <span class="keyword">if</span> (criteria.getMinSize() != <span class="literal">null</span>) &#123;</span><br><span class="line">            predicates.add(cb.greaterThanOrEqualTo(root.get(<span class="string">&quot;fileSize&quot;</span>), criteria.getMinSize()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (criteria.getMaxSize() != <span class="literal">null</span>) &#123;</span><br><span class="line">            predicates.add(cb.lessThanOrEqualTo(root.get(<span class="string">&quot;fileSize&quot;</span>), criteria.getMaxSize()));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Date range filter</span></span><br><span class="line">        <span class="keyword">if</span> (criteria.getCreatedAfter() != <span class="literal">null</span>) &#123;</span><br><span class="line">            predicates.add(cb.greaterThanOrEqualTo(root.get(<span class="string">&quot;createdAt&quot;</span>), criteria.getCreatedAfter()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (criteria.getCreatedBefore() != <span class="literal">null</span>) &#123;</span><br><span class="line">            predicates.add(cb.lessThanOrEqualTo(root.get(<span class="string">&quot;createdAt&quot;</span>), criteria.getCreatedBefore()));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Tags filter (using JSONB operations)</span></span><br><span class="line">        <span class="keyword">if</span> (criteria.getTags() != <span class="literal">null</span> &amp;&amp; !criteria.getTags().isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String tag : criteria.getTags()) &#123;</span><br><span class="line">                predicates.add(cb.isTrue(</span><br><span class="line">                    cb.function(<span class="string">&quot;jsonb_exists&quot;</span>, Boolean.class, root.get(<span class="string">&quot;tags&quot;</span>), cb.literal(tag))</span><br><span class="line">                ));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        query.where(predicates.toArray(<span class="keyword">new</span> <span class="title class_">Predicate</span>[<span class="number">0</span>]));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Default ordering by creation date (newest first)</span></span><br><span class="line">        query.orderBy(cb.desc(root.get(<span class="string">&quot;createdAt&quot;</span>)));</span><br><span class="line">        </span><br><span class="line">        TypedQuery&lt;FileMetadata&gt; typedQuery = entityManager.createQuery(query);</span><br><span class="line">        typedQuery.setFirstResult((<span class="type">int</span>) pageable.getOffset());</span><br><span class="line">        typedQuery.setMaxResults(pageable.getPageSize());</span><br><span class="line">        </span><br><span class="line">        List&lt;FileMetadata&gt; results = typedQuery.getResultList();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Count query for pagination</span></span><br><span class="line">        CriteriaQuery&lt;Long&gt; countQuery = cb.createQuery(Long.class);</span><br><span class="line">        Root&lt;FileMetadata&gt; countRoot = countQuery.from(FileMetadata.class);</span><br><span class="line">        countQuery.select(cb.count(countRoot));</span><br><span class="line">        countQuery.where(predicates.toArray(<span class="keyword">new</span> <span class="title class_">Predicate</span>[<span class="number">0</span>]));</span><br><span class="line">        </span><br><span class="line">        <span class="type">Long</span> <span class="variable">totalCount</span> <span class="operator">=</span> entityManager.createQuery(countQuery).getSingleResult();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageImpl</span>&lt;&gt;(results, pageable, totalCount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Monitoring-and-Observability"><a href="#Monitoring-and-Observability" class="headerlink" title="Monitoring and Observability"></a>Monitoring and Observability</h2><h3 id="Comprehensive-Monitoring-Setup"><a href="#Comprehensive-Monitoring-Setup" class="headerlink" title="Comprehensive Monitoring Setup"></a>Comprehensive Monitoring Setup</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageMetrics</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Timer uploadTimer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Timer downloadTimer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter uploadSuccessCounter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter uploadFailureCounter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Gauge activeUploadsGauge;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FileStorageMetrics</span><span class="params">(MeterRegistry meterRegistry)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.meterRegistry = meterRegistry;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">this</span>.uploadTimer = Timer.builder(<span class="string">&quot;file_upload_duration&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Time taken to upload files&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;service&quot;</span>, <span class="string">&quot;file-storage&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.downloadTimer = Timer.builder(<span class="string">&quot;file_download_duration&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Time taken to download files&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;service&quot;</span>, <span class="string">&quot;file-storage&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.uploadSuccessCounter = Counter.builder(<span class="string">&quot;file_upload_success_total&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Total number of successful file uploads&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;service&quot;</span>, <span class="string">&quot;file-storage&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.uploadFailureCounter = Counter.builder(<span class="string">&quot;file_upload_failure_total&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Total number of failed file uploads&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;service&quot;</span>, <span class="string">&quot;file-storage&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.activeUploadsGauge = Gauge.builder(<span class="string">&quot;file_upload_active_count&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Number of currently active uploads&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;service&quot;</span>, <span class="string">&quot;file-storage&quot;</span>)</span><br><span class="line">            .register(meterRegistry, <span class="built_in">this</span>, FileStorageMetrics::getActiveUploadsCount);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordUploadSuccess</span><span class="params">(String fileType, <span class="type">long</span> fileSizeBytes, Duration duration)</span> &#123;</span><br><span class="line">        uploadSuccessCounter.increment(</span><br><span class="line">            Tags.of(</span><br><span class="line">                <span class="string">&quot;file_type&quot;</span>, fileType,</span><br><span class="line">                <span class="string">&quot;size_category&quot;</span>, categorizeFileSize(fileSizeBytes)</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        uploadTimer.record(duration);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Record file size distribution</span></span><br><span class="line">        DistributionSummary.builder(<span class="string">&quot;file_upload_size_bytes&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;file_type&quot;</span>, fileType)</span><br><span class="line">            .register(meterRegistry)</span><br><span class="line">            .record(fileSizeBytes);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordUploadFailure</span><span class="params">(String fileType, String errorType, Duration duration)</span> &#123;</span><br><span class="line">        uploadFailureCounter.increment(</span><br><span class="line">            Tags.of(</span><br><span class="line">                <span class="string">&quot;file_type&quot;</span>, fileType,</span><br><span class="line">                <span class="string">&quot;error_type&quot;</span>, errorType</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">categorizeFileSize</span><span class="params">(<span class="type">long</span> sizeBytes)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (sizeBytes &lt; <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="string">&quot;small&quot;</span>;      <span class="comment">// &lt; 1MB</span></span><br><span class="line">        <span class="keyword">if</span> (sizeBytes &lt; <span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="string">&quot;medium&quot;</span>; <span class="comment">// &lt; 10MB</span></span><br><span class="line">        <span class="keyword">if</span> (sizeBytes &lt; <span class="number">100</span> * <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="string">&quot;large&quot;</span>; <span class="comment">// &lt; 100MB</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;xlarge&quot;</span>; <span class="comment">// &gt;= 100MB</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> <span class="title function_">getActiveUploadsCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Implementation to get current active upload count</span></span><br><span class="line">        <span class="keyword">return</span> uploadSessionService.getActiveUploadCount();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Health Check Implementation</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageHealthIndicator</span> <span class="keyword">implements</span> <span class="title class_">HealthIndicator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GcsService gcsService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataSource dataSource;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Health <span class="title function_">health</span><span class="params">()</span> &#123;</span><br><span class="line">        Health.<span class="type">Builder</span> <span class="variable">healthBuilder</span> <span class="operator">=</span> Health.up();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check PostgreSQL connectivity</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!connection.isValid(<span class="number">5</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> Health.down()</span><br><span class="line">                    .withDetail(<span class="string">&quot;database&quot;</span>, <span class="string">&quot;Connection validation failed&quot;</span>)</span><br><span class="line">                    .build();</span><br><span class="line">            &#125;</span><br><span class="line">            healthBuilder.withDetail(<span class="string">&quot;database&quot;</span>, <span class="string">&quot;UP&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> Health.down()</span><br><span class="line">                .withDetail(<span class="string">&quot;database&quot;</span>, <span class="string">&quot;Connection failed: &quot;</span> + e.getMessage())</span><br><span class="line">                .build();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check Redis connectivity</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.execute((RedisCallback&lt;String&gt;) connection -&gt; &#123;</span><br><span class="line">                connection.ping();</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;PONG&quot;</span>;</span><br><span class="line">            &#125;);</span><br><span class="line">            healthBuilder.withDetail(<span class="string">&quot;redis&quot;</span>, <span class="string">&quot;UP&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            healthBuilder.withDetail(<span class="string">&quot;redis&quot;</span>, <span class="string">&quot;DOWN: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check GCS connectivity</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">gcsHealthy</span> <span class="operator">=</span> gcsService.checkHealth();</span><br><span class="line">            healthBuilder.withDetail(<span class="string">&quot;gcs&quot;</span>, gcsHealthy ? <span class="string">&quot;UP&quot;</span> : <span class="string">&quot;DOWN&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!gcsHealthy) &#123;</span><br><span class="line">                <span class="keyword">return</span> healthBuilder.down().build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> Health.down()</span><br><span class="line">                .withDetail(<span class="string">&quot;gcs&quot;</span>, <span class="string">&quot;Health check failed: &quot;</span> + e.getMessage())</span><br><span class="line">                .build();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> healthBuilder.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Error-Handling-and-Resilience"><a href="#Error-Handling-and-Resilience" class="headerlink" title="Error Handling and Resilience"></a>Error Handling and Resilience</h2><h3 id="Comprehensive-Error-Handling-Strategy"><a href="#Comprehensive-Error-Handling-Strategy" class="headerlink" title="Comprehensive Error Handling Strategy"></a>Comprehensive Error Handling Strategy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageExceptionHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(FileStorageExceptionHandler.class);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler(FileNotFoundException.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.NOT_FOUND)</span></span><br><span class="line">    <span class="keyword">public</span> ErrorResponse <span class="title function_">handleFileNotFound</span><span class="params">(FileNotFoundException e)</span> &#123;</span><br><span class="line">        logger.warn(<span class="string">&quot;File not found: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> ErrorResponse.builder()</span><br><span class="line">            .code(<span class="string">&quot;FILE_NOT_FOUND&quot;</span>)</span><br><span class="line">            .message(<span class="string">&quot;The requested file was not found&quot;</span>)</span><br><span class="line">            .timestamp(Instant.now())</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler(FileSizeExceededException.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.PAYLOAD_TOO_LARGE)</span></span><br><span class="line">    <span class="keyword">public</span> ErrorResponse <span class="title function_">handleFileSizeExceeded</span><span class="params">(FileSizeExceededException e)</span> &#123;</span><br><span class="line">        logger.warn(<span class="string">&quot;File size exceeded: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> ErrorResponse.builder()</span><br><span class="line">            .code(<span class="string">&quot;FILE_SIZE_EXCEEDED&quot;</span>)</span><br><span class="line">            .message(<span class="string">&quot;File size exceeds the maximum allowed limit&quot;</span>)</span><br><span class="line">            .details(Map.of(<span class="string">&quot;maxSize&quot;</span>, e.getMaxAllowedSize(), <span class="string">&quot;actualSize&quot;</span>, e.getActualSize()))</span><br><span class="line">            .timestamp(Instant.now())</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler(UnsupportedFileTypeException.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.UNSUPPORTED_MEDIA_TYPE)</span></span><br><span class="line">    <span class="keyword">public</span> ErrorResponse <span class="title function_">handleUnsupportedFileType</span><span class="params">(UnsupportedFileTypeException e)</span> &#123;</span><br><span class="line">        logger.warn(<span class="string">&quot;Unsupported file type: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> ErrorResponse.builder()</span><br><span class="line">            .code(<span class="string">&quot;UNSUPPORTED_FILE_TYPE&quot;</span>)</span><br><span class="line">            .message(<span class="string">&quot;The file type is not supported&quot;</span>)</span><br><span class="line">            .details(Map.of(<span class="string">&quot;supportedTypes&quot;</span>, e.getSupportedTypes()))</span><br><span class="line">            .timestamp(Instant.now())</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler(StorageException.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line">    <span class="keyword">public</span> ErrorResponse <span class="title function_">handleStorageException</span><span class="params">(StorageException e)</span> &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;Storage operation failed&quot;</span>, e);</span><br><span class="line">        <span class="keyword">return</span> ErrorResponse.builder()</span><br><span class="line">            .code(<span class="string">&quot;STORAGE_ERROR&quot;</span>)</span><br><span class="line">            .message(<span class="string">&quot;An error occurred while processing the file&quot;</span>)</span><br><span class="line">            .timestamp(Instant.now())</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler(RateLimitExceededException.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.TOO_MANY_REQUESTS)</span></span><br><span class="line">    <span class="keyword">public</span> ErrorResponse <span class="title function_">handleRateLimit</span><span class="params">(RateLimitExceededException e)</span> &#123;</span><br><span class="line">        logger.warn(<span class="string">&quot;Rate limit exceeded for user: &#123;&#125;&quot;</span>, e.getUserId());</span><br><span class="line">        <span class="keyword">return</span> ErrorResponse.builder()</span><br><span class="line">            .code(<span class="string">&quot;RATE_LIMIT_EXCEEDED&quot;</span>)</span><br><span class="line">            .message(<span class="string">&quot;Upload rate limit exceeded&quot;</span>)</span><br><span class="line">            .details(Map.of(<span class="string">&quot;retryAfter&quot;</span>, e.getRetryAfterSeconds()))</span><br><span class="line">            .timestamp(Instant.now())</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Retry Mechanism for GCS Operations</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResilientGcsService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Storage storage;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RetryTemplate retryTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CircuitBreaker circuitBreaker;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ResilientGcsService</span><span class="params">(Storage storage)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.storage = storage;</span><br><span class="line">        <span class="built_in">this</span>.retryTemplate = createRetryTemplate();</span><br><span class="line">        <span class="built_in">this</span>.circuitBreaker = createCircuitBreaker();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Retryable(value = &#123;StorageException.class&#125;, maxAttempts = 3, </span></span><br><span class="line"><span class="meta">               backoff = @Backoff(delay = 1000, multiplier = 2))</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">uploadWithRetry</span><span class="params">(InputStream inputStream, String path, String contentType)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> circuitBreaker.executeSupplier(() -&gt; </span><br><span class="line">            retryTemplate.execute(context -&gt; &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;Attempting upload, attempt: &#123;&#125;&quot;</span>, context.getRetryCount() + <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">return</span> doUpload(inputStream, path, contentType);</span><br><span class="line">            &#125;)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> RetryTemplate <span class="title function_">createRetryTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">RetryTemplate</span> <span class="variable">template</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RetryTemplate</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="type">FixedBackOffPolicy</span> <span class="variable">backOffPolicy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FixedBackOffPolicy</span>();</span><br><span class="line">        backOffPolicy.setBackOffPeriod(<span class="number">2000</span>); <span class="comment">// 2 seconds</span></span><br><span class="line">        template.setBackOffPolicy(backOffPolicy);</span><br><span class="line">        </span><br><span class="line">        <span class="type">SimpleRetryPolicy</span> <span class="variable">retryPolicy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleRetryPolicy</span>();</span><br><span class="line">        retryPolicy.setMaxAttempts(<span class="number">3</span>);</span><br><span class="line">        template.setRetryPolicy(retryPolicy);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> CircuitBreaker <span class="title function_">createCircuitBreaker</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CircuitBreaker.ofDefaults(<span class="string">&quot;gcs-upload&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Production-Deployment-Architecture"><a href="#Production-Deployment-Architecture" class="headerlink" title="Production Deployment Architecture"></a>Production Deployment Architecture</h2><h3 id="Kubernetes-Deployment-Configuration"><a href="#Kubernetes-Deployment-Configuration" class="headerlink" title="Kubernetes Deployment Configuration"></a>Kubernetes Deployment Configuration</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># file-storage-deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">file-storage-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">file-storage-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">file-storage-service</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">file-storage-service</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">file-storage-service</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">file-storage-service:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_PROFILES_ACTIVE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;production&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DATABASE_URL</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">file-storage-secrets</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">database-url</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">REDIS_URL</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">file-storage-secrets</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">redis-url</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GCS_BUCKET_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">file-storage-config</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">gcs-bucket-name</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;512Mi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/actuator/health</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">30</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/actuator/health/readiness</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gcs-key</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">&quot;/etc/gcs&quot;</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gcs-key</span></span><br><span class="line">        <span class="attr">secret:</span></span><br><span class="line">          <span class="attr">secretName:</span> <span class="string">gcs-service-account-key</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">file-storage-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">file-storage-service</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">file-storage-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line">    <span class="attr">cert-manager.io/cluster-issuer:</span> <span class="string">&quot;letsencrypt-prod&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/proxy-body-size:</span> <span class="string">&quot;100m&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">api.fileservice.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">file-storage-tls</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">api.fileservice.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">file-storage-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h3 id="Infrastructure-as-Code-Terraform"><a href="#Infrastructure-as-Code-Terraform" class="headerlink" title="Infrastructure as Code (Terraform)"></a>Infrastructure as Code (Terraform)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"># GCS Bucket Configuration</span><br><span class="line">resource &quot;google_storage_bucket&quot; &quot;file_storage_bucket&quot; &#123;</span><br><span class="line">  name          = &quot;company-file-storage-$&#123;var.environment&#125;&quot;</span><br><span class="line">  location      = &quot;US&quot;</span><br><span class="line">  force_destroy = false</span><br><span class="line"></span><br><span class="line">  versioning &#123;</span><br><span class="line">    enabled = true</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  lifecycle_rule &#123;</span><br><span class="line">    condition &#123;</span><br><span class="line">      age = 30</span><br><span class="line">    &#125;</span><br><span class="line">    action &#123;</span><br><span class="line">      type          = &quot;SetStorageClass&quot;</span><br><span class="line">      storage_class = &quot;NEARLINE&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  lifecycle_rule &#123;</span><br><span class="line">    condition &#123;</span><br><span class="line">      age = 90</span><br><span class="line">    &#125;</span><br><span class="line">    action &#123;</span><br><span class="line">      type          = &quot;SetStorageClass&quot;</span><br><span class="line">      storage_class = &quot;COLDLINE&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  lifecycle_rule &#123;</span><br><span class="line">    condition &#123;</span><br><span class="line">      age = 365</span><br><span class="line">    &#125;</span><br><span class="line">    action &#123;</span><br><span class="line">      type          = &quot;SetStorageClass&quot;</span><br><span class="line">      storage_class = &quot;ARCHIVE&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cors &#123;</span><br><span class="line">    origin          = [&quot;https://app.company.com&quot;]</span><br><span class="line">    method          = [&quot;GET&quot;, &quot;HEAD&quot;, &quot;PUT&quot;, &quot;POST&quot;, &quot;DELETE&quot;]</span><br><span class="line">    response_header = [&quot;*&quot;]</span><br><span class="line">    max_age_seconds = 3600</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Cloud SQL PostgreSQL Instance</span><br><span class="line">resource &quot;google_sql_database_instance&quot; &quot;file_storage_db&quot; &#123;</span><br><span class="line">  name             = &quot;file-storage-db-$&#123;var.environment&#125;&quot;</span><br><span class="line">  database_version = &quot;POSTGRES_13&quot;</span><br><span class="line">  region          = &quot;us-central1&quot;</span><br><span class="line"></span><br><span class="line">  settings &#123;</span><br><span class="line">    tier = &quot;db-custom-2-4096&quot;</span><br><span class="line">    </span><br><span class="line">    backup_configuration &#123;</span><br><span class="line">      enabled                        = true</span><br><span class="line">      start_time                    = &quot;03:00&quot;</span><br><span class="line">      location                      = &quot;us&quot;</span><br><span class="line">      point_in_time_recovery_enabled = true</span><br><span class="line">      backup_retention_settings &#123;</span><br><span class="line">        retained_backups = 30</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ip_configuration &#123;</span><br><span class="line">      ipv4_enabled    = false</span><br><span class="line">      private_network = google_compute_network.vpc.id</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    database_flags &#123;</span><br><span class="line">      name  = &quot;max_connections&quot;</span><br><span class="line">      value = &quot;200&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    database_flags &#123;</span><br><span class="line">      name  = &quot;shared_preload_libraries&quot;</span><br><span class="line">      value = &quot;pg_stat_statements&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Redis Instance for Caching</span><br><span class="line">resource &quot;google_redis_instance&quot; &quot;file_storage_cache&quot; &#123;</span><br><span class="line">  name           = &quot;file-storage-cache-$&#123;var.environment&#125;&quot;</span><br><span class="line">  tier           = &quot;STANDARD_HA&quot;</span><br><span class="line">  memory_size_gb = 4</span><br><span class="line">  region         = &quot;us-central1&quot;</span><br><span class="line">  </span><br><span class="line">  redis_version     = &quot;REDIS_6_X&quot;</span><br><span class="line">  display_name      = &quot;File Storage Cache&quot;</span><br><span class="line">  authorized_network = google_compute_network.vpc.id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Benchmarks-and-SLAs"><a href="#Performance-Benchmarks-and-SLAs" class="headerlink" title="Performance Benchmarks and SLAs"></a>Performance Benchmarks and SLAs</h2><h3 id="Service-Level-Objectives"><a href="#Service-Level-Objectives" class="headerlink" title="Service Level Objectives"></a>Service Level Objectives</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SLO Configuration</span></span><br><span class="line"><span class="attr">slo_targets:</span></span><br><span class="line">  <span class="attr">availability:</span></span><br><span class="line">    <span class="attr">target:</span> <span class="number">99.9</span><span class="string">%</span></span><br><span class="line">    <span class="attr">measurement_window:</span> <span class="string">30_days</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">latency:</span></span><br><span class="line">    <span class="attr">upload_p95:</span> <span class="string">5s</span>      <span class="comment"># 95% of uploads complete within 5 seconds</span></span><br><span class="line">    <span class="attr">upload_p99:</span> <span class="string">15s</span>     <span class="comment"># 99% of uploads complete within 15 seconds</span></span><br><span class="line">    <span class="attr">download_p95:</span> <span class="string">500ms</span> <span class="comment"># 95% of downloads start within 500ms</span></span><br><span class="line">    <span class="attr">download_p99:</span> <span class="string">2s</span>    <span class="comment"># 99% of downloads start within 2 seconds</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">throughput:</span></span><br><span class="line">    <span class="attr">max_concurrent_uploads:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">max_upload_rate:</span> <span class="string">10GB/s</span></span><br><span class="line">    <span class="attr">max_download_rate:</span> <span class="string">50GB/s</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">error_rate:</span></span><br><span class="line">    <span class="attr">target:</span> <span class="number">0.1</span><span class="string">%</span>        <span class="comment"># Less than 0.1% error rate</span></span><br><span class="line">    <span class="attr">measurement_window:</span> <span class="string">24_hours</span></span><br></pre></td></tr></table></figure>

<h3 id="Load-Testing-Strategy"><a href="#Load-Testing-Strategy" class="headerlink" title="Load Testing Strategy"></a>Load Testing Strategy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageLoadTester</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileStorageClient client;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutorService executorService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> LoadTestResult <span class="title function_">runLoadTest</span><span class="params">(LoadTestConfig config)</span> &#123;</span><br><span class="line">        List&lt;CompletableFuture&lt;UploadResult&gt;&gt; futures = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; config.getConcurrentUsers(); i++) &#123;</span><br><span class="line">            CompletableFuture&lt;UploadResult&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">return</span> simulateUserUpload(config);</span><br><span class="line">            &#125;, executorService);</span><br><span class="line">            </span><br><span class="line">            futures.add(future);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Collect results</span></span><br><span class="line">        List&lt;UploadResult&gt; results = futures.stream()</span><br><span class="line">            .map(CompletableFuture::join)</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> analyzeResults(results);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> UploadResult <span class="title function_">simulateUserUpload</span><span class="params">(LoadTestConfig config)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Generate test file</span></span><br><span class="line">            <span class="type">byte</span>[] testData = generateTestFile(config.getFileSize());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Upload file</span></span><br><span class="line">            <span class="type">FileUploadResult</span> <span class="variable">result</span> <span class="operator">=</span> client.uploadFile(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(testData),</span><br><span class="line">                <span class="string">&quot;test-file-&quot;</span> + UUID.randomUUID().toString(),</span><br><span class="line">                <span class="string">&quot;application/octet-stream&quot;</span></span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="type">long</span> <span class="variable">duration</span> <span class="operator">=</span> System.currentTimeMillis() - startTime;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> UploadResult.builder()</span><br><span class="line">                .success(<span class="literal">true</span>)</span><br><span class="line">                .duration(duration)</span><br><span class="line">                .fileSize(testData.length)</span><br><span class="line">                .fileId(result.getFileId())</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">duration</span> <span class="operator">=</span> System.currentTimeMillis() - startTime;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> UploadResult.builder()</span><br><span class="line">                .success(<span class="literal">false</span>)</span><br><span class="line">                .duration(duration)</span><br><span class="line">                .error(e.getMessage())</span><br><span class="line">                .build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Interview-Questions-and-Insights"><a href="#Interview-Questions-and-Insights" class="headerlink" title="Interview Questions and Insights"></a>Interview Questions and Insights</h2><h3 id="System-Design-Questions"><a href="#System-Design-Questions" class="headerlink" title="System Design Questions"></a>System Design Questions</h3><p><strong>Q: How would you handle a scenario where files need to be replicated across multiple regions for disaster recovery?</strong></p>
<p>A: I would implement a multi-region replication strategy:</p>
<ol>
<li><strong>Primary-Secondary Pattern</strong>: Use GCS multi-region buckets for automatic replication</li>
<li><strong>Database Replication</strong>: Set up PostgreSQL read replicas in different regions</li>
<li><strong>Metadata Consistency</strong>: Implement eventual consistency with conflict resolution</li>
<li><strong>Failover Logic</strong>: Automatic failover with health checks and circuit breakers</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiRegionReplicationService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, GcsService&gt; regionalGcsServices;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CircuitBreaker circuitBreaker;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> FileUploadResult <span class="title function_">uploadWithReplication</span><span class="params">(MultipartFile file, String primaryRegion)</span> &#123;</span><br><span class="line">        <span class="comment">// Upload to primary region first</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">primaryPath</span> <span class="operator">=</span> uploadToPrimary(file, primaryRegion);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Async replication to secondary regions</span></span><br><span class="line">        CompletableFuture.runAsync(() -&gt; replicateToSecondaryRegions(file, primaryPath));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> buildUploadResult(primaryPath);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">replicateToSecondaryRegions</span><span class="params">(MultipartFile file, String primaryPath)</span> &#123;</span><br><span class="line">        regionalGcsServices.entrySet().parallelStream()</span><br><span class="line">            .filter(entry -&gt; !entry.getKey().equals(primaryRegion))</span><br><span class="line">            .forEach(entry -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    circuitBreaker.executeSupplier(() -&gt; </span><br><span class="line">                        entry.getValue().replicateFile(primaryPath, file)</span><br><span class="line">                    );</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    logger.error(<span class="string">&quot;Failed to replicate to region: &#123;&#125;&quot;</span>, entry.getKey(), e);</span><br><span class="line">                    <span class="comment">// Schedule retry or alert operations team</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Q: How would you optimize the system for handling millions of small files vs. thousands of large files?</strong></p>
<p>A: Different optimization strategies are needed:</p>
<p><strong>For Small Files (&lt; 1MB):</strong></p>
<ul>
<li>Batch multiple small files into larger objects</li>
<li>Use aggressive caching in Redis</li>
<li>Implement file bundling&#x2F;archiving</li>
<li>Use CDN for frequently accessed files</li>
</ul>
<p><strong>For Large Files (&gt; 100MB):</strong></p>
<ul>
<li>Mandatory chunked uploads with resumability</li>
<li>Implement progressive download with range requests</li>
<li>Use streaming processing to avoid memory issues</li>
<li>Implement intelligent storage class selection</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileOptimizationService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> StorageStrategy <span class="title function_">determineOptimalStrategy</span><span class="params">(FileMetadata file)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (file.getFileSize() &lt; SMALL_FILE_THRESHOLD) &#123;</span><br><span class="line">            <span class="keyword">return</span> StorageStrategy.builder()</span><br><span class="line">                .cacheInRedis(<span class="literal">true</span>)</span><br><span class="line">                .bundleWithOthers(shouldBundle(file))</span><br><span class="line">                .storageClass(StorageClass.STANDARD)</span><br><span class="line">                .cdnEnabled(<span class="literal">true</span>)</span><br><span class="line">                .build();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (file.getFileSize() &gt; LARGE_FILE_THRESHOLD) &#123;</span><br><span class="line">            <span class="keyword">return</span> StorageStrategy.builder()</span><br><span class="line">                .chunkedUpload(<span class="literal">true</span>)</span><br><span class="line">                .resumableUpload(<span class="literal">true</span>)</span><br><span class="line">                .storageClass(determineStorageClass(file))</span><br><span class="line">                .compressionEnabled(shouldCompress(file))</span><br><span class="line">                .build();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> StorageStrategy.defaultStrategy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Q: How would you implement file deduplication to save storage costs?</strong></p>
<p>A: Implement content-based deduplication using cryptographic hashing:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileDeduplicationService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileHashRepository hashRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GcsService gcsService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> FileUploadResult <span class="title function_">uploadWithDeduplication</span><span class="params">(MultipartFile file, String projectId)</span> &#123;</span><br><span class="line">        <span class="comment">// Calculate file hash</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">sha256Hash</span> <span class="operator">=</span> calculateSHA256(file);</span><br><span class="line">        <span class="type">String</span> <span class="variable">md5Hash</span> <span class="operator">=</span> calculateMD5(file);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check if file already exists</span></span><br><span class="line">        Optional&lt;FileMetadata&gt; existingFile = hashRepository.findByHash(sha256Hash);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (existingFile.isPresent()) &#123;</span><br><span class="line">            <span class="comment">// File exists, create reference instead of duplicate</span></span><br><span class="line">            <span class="keyword">return</span> createFileReference(existingFile.get(), projectId);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// New file, upload and store hash</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">gcsPath</span> <span class="operator">=</span> gcsService.uploadFile(file.getInputStream(), </span><br><span class="line">            generateFileName(), file.getContentType());</span><br><span class="line">        </span><br><span class="line">        <span class="type">FileMetadata</span> <span class="variable">metadata</span> <span class="operator">=</span> FileMetadata.builder()</span><br><span class="line">            .fileId(UUID.randomUUID().toString())</span><br><span class="line">            .originalFileName(file.getOriginalFilename())</span><br><span class="line">            .gcsPath(gcsPath)</span><br><span class="line">            .fileSize(file.getSize())</span><br><span class="line">            .projectId(projectId)</span><br><span class="line">            .sha256Hash(sha256Hash)</span><br><span class="line">            .md5Hash(md5Hash)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> fileMetadataRepository.save(metadata);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> FileUploadResult <span class="title function_">createFileReference</span><span class="params">(FileMetadata originalFile, String projectId)</span> &#123;</span><br><span class="line">        <span class="comment">// Create a new metadata entry that references the same GCS object</span></span><br><span class="line">        <span class="type">FileMetadata</span> <span class="variable">referenceMetadata</span> <span class="operator">=</span> originalFile.toBuilder()</span><br><span class="line">            .fileId(UUID.randomUUID().toString())</span><br><span class="line">            .projectId(projectId)</span><br><span class="line">            .createdAt(Instant.now())</span><br><span class="line">            .isReference(<span class="literal">true</span>)</span><br><span class="line">            .originalFileId(originalFile.getFileId())</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        fileMetadataRepository.save(referenceMetadata);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> FileUploadResult.builder()</span><br><span class="line">            .fileId(referenceMetadata.getFileId())</span><br><span class="line">            .downloadUrl(generateDownloadUrl(referenceMetadata))</span><br><span class="line">            .deduplicated(<span class="literal">true</span>)</span><br><span class="line">            .originalFileId(originalFile.getFileId())</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Scalability-Questions"><a href="#Scalability-Questions" class="headerlink" title="Scalability Questions"></a>Scalability Questions</h3><p><strong>Q: How would you handle rate limiting to prevent abuse while maintaining good user experience?</strong></p>
<p>A: Implement a multi-tier rate limiting strategy:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileUploadRateLimiter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisTemplate&lt;String, String&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Different limits for different user tiers</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;UserTier, RateLimitConfig&gt; tierLimits = Map.of(</span><br><span class="line">        UserTier.FREE, <span class="keyword">new</span> <span class="title class_">RateLimitConfig</span>(<span class="number">10</span>, Duration.ofMinutes(<span class="number">1</span>), <span class="number">100</span> * <span class="number">1024</span> * <span class="number">1024L</span>), <span class="comment">// 10 files/min, 100MB/day</span></span><br><span class="line">        UserTier.PREMIUM, <span class="keyword">new</span> <span class="title class_">RateLimitConfig</span>(<span class="number">100</span>, Duration.ofMinutes(<span class="number">1</span>), <span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1024L</span>), <span class="comment">// 100 files/min, 10GB/day</span></span><br><span class="line">        UserTier.ENTERPRISE, <span class="keyword">new</span> <span class="title class_">RateLimitConfig</span>(<span class="number">1000</span>, Duration.ofMinutes(<span class="number">1</span>), Long.MAX_VALUE) <span class="comment">// 1000 files/min, unlimited</span></span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">allowUpload</span><span class="params">(String userId, <span class="type">long</span> fileSize)</span> &#123;</span><br><span class="line">        <span class="type">UserTier</span> <span class="variable">userTier</span> <span class="operator">=</span> getUserTier(userId);</span><br><span class="line">        <span class="type">RateLimitConfig</span> <span class="variable">config</span> <span class="operator">=</span> tierLimits.get(userTier);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check request rate limit</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">rateLimitKey</span> <span class="operator">=</span> <span class="string">&quot;rate_limit:&quot;</span> + userId;</span><br><span class="line">        <span class="keyword">if</span> (!checkRateLimit(rateLimitKey, config.getRequestsPerWindow(), config.getTimeWindow())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RateLimitExceededException</span>(<span class="string">&quot;Request rate limit exceeded&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check bandwidth limit</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">bandwidthKey</span> <span class="operator">=</span> <span class="string">&quot;bandwidth:&quot;</span> + userId + <span class="string">&quot;:&quot;</span> + LocalDate.now();</span><br><span class="line">        <span class="type">long</span> <span class="variable">currentUsage</span> <span class="operator">=</span> getCurrentBandwidthUsage(bandwidthKey);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (currentUsage + fileSize &gt; config.getDailyBandwidthLimit()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BandwidthLimitExceededException</span>(<span class="string">&quot;Daily bandwidth limit exceeded&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Update bandwidth usage</span></span><br><span class="line">        redisTemplate.opsForValue().increment(bandwidthKey, fileSize);</span><br><span class="line">        redisTemplate.expire(bandwidthKey, Duration.ofDays(<span class="number">1</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkRateLimit</span><span class="params">(String key, <span class="type">int</span> limit, Duration window)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            local key = KEYS[1]</span></span><br><span class="line"><span class="string">            local limit = tonumber(ARGV[1])</span></span><br><span class="line"><span class="string">            local window = tonumber(ARGV[2])</span></span><br><span class="line"><span class="string">            local now = tonumber(ARGV[3])</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            redis.call(&#x27;zremrangebyscore&#x27;, key, 0, now - window)</span></span><br><span class="line"><span class="string">            local current = redis.call(&#x27;zcard&#x27;, key)</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            if current &lt; limit then</span></span><br><span class="line"><span class="string">                redis.call(&#x27;zadd&#x27;, key, now, now)</span></span><br><span class="line"><span class="string">                redis.call(&#x27;expire&#x27;, key, window)</span></span><br><span class="line"><span class="string">                return 1</span></span><br><span class="line"><span class="string">            else</span></span><br><span class="line"><span class="string">                return 0</span></span><br><span class="line"><span class="string">            end</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> redisTemplate.execute(</span><br><span class="line">            RedisScript.of(script, Long.class),</span><br><span class="line">            List.of(key),</span><br><span class="line">            String.valueOf(limit),</span><br><span class="line">            String.valueOf(window.toMillis()),</span><br><span class="line">            String.valueOf(System.currentTimeMillis())</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result != <span class="literal">null</span> &amp;&amp; result == <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SDK-Usage-Examples"><a href="#SDK-Usage-Examples" class="headerlink" title="SDK Usage Examples"></a>SDK Usage Examples</h2><h3 id="Java-SDK-Usage"><a href="#Java-SDK-Usage" class="headerlink" title="Java SDK Usage"></a>Java SDK Usage</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageExamples</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// Initialize the client</span></span><br><span class="line">        <span class="type">FileStorageClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileStorageClient</span>(</span><br><span class="line">            <span class="string">&quot;https://api.fileservice.com&quot;</span>, </span><br><span class="line">            <span class="string">&quot;your-api-key&quot;</span></span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Example 1: Simple file upload</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;document.pdf&quot;</span>);</span><br><span class="line">        <span class="type">UploadOptions</span> <span class="variable">options</span> <span class="operator">=</span> UploadOptions.builder()</span><br><span class="line">            .projectId(<span class="string">&quot;project-123&quot;</span>)</span><br><span class="line">            .tags(Set.of(<span class="string">&quot;document&quot;</span>, <span class="string">&quot;pdf&quot;</span>))</span><br><span class="line">            .metadata(Map.of(<span class="string">&quot;department&quot;</span>, <span class="string">&quot;engineering&quot;</span>))</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">FileUploadResult</span> <span class="variable">result</span> <span class="operator">=</span> client.uploadFile(file, options);</span><br><span class="line">            System.out.println(<span class="string">&quot;File uploaded successfully: &quot;</span> + result.getFileId());</span><br><span class="line">            System.out.println(<span class="string">&quot;Download URL: &quot;</span> + result.getDownloadUrl());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileUploadException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Upload failed: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Example 2: Large file upload with progress tracking</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">largeFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;large-video.mp4&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">FileUploadResult</span> <span class="variable">result</span> <span class="operator">=</span> client.uploadFile(largeFile, options, (uploaded, total) -&gt; &#123;</span><br><span class="line">            <span class="type">double</span> <span class="variable">progress</span> <span class="operator">=</span> (<span class="type">double</span>) uploaded / total * <span class="number">100</span>;</span><br><span class="line">            System.out.printf(<span class="string">&quot;Upload progress: %.2f%%\n&quot;</span>, progress);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Example 3: File download</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> client.downloadFile(result.getFileId())) &#123;</span><br><span class="line">            Files.copy(inputStream, Paths.get(<span class="string">&quot;downloaded-file.mp4&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;File downloaded successfully&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Download failed: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Example 4: List files with filtering</span></span><br><span class="line">        <span class="type">FileQuery</span> <span class="variable">query</span> <span class="operator">=</span> FileQuery.builder()</span><br><span class="line">            .projectId(<span class="string">&quot;project-123&quot;</span>)</span><br><span class="line">            .fileType(<span class="string">&quot;image/*&quot;</span>)</span><br><span class="line">            .createdAfter(LocalDateTime.now().minusDays(<span class="number">7</span>))</span><br><span class="line">            .tags(Set.of(<span class="string">&quot;processed&quot;</span>))</span><br><span class="line">            .page(<span class="number">0</span>)</span><br><span class="line">            .size(<span class="number">20</span>)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        PagedResult&lt;FileMetadata&gt; files = client.listFiles(query);</span><br><span class="line">        files.getContent().forEach(file -&gt; </span><br><span class="line">            System.out.println(<span class="string">&quot;File: &quot;</span> + file.getOriginalFileName() + <span class="string">&quot; - &quot;</span> + file.getFileSize() + <span class="string">&quot; bytes&quot;</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="React-SDK-Usage"><a href="#React-SDK-Usage" class="headerlink" title="React SDK Usage"></a>React SDK Usage</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">FileStorageClient</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@company/file-storage-sdk&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">App</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> [client] = <span class="title function_">useState</span>(<span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="title class_">FileStorageClient</span>(&#123;</span><br><span class="line">    <span class="attr">baseUrl</span>: <span class="string">&#x27;https://api.fileservice.com&#x27;</span>,</span><br><span class="line">    <span class="attr">apiKey</span>: process.<span class="property">env</span>.<span class="property">REACT_APP_API_KEY</span></span><br><span class="line">  &#125;));</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> [uploadProgress, setUploadProgress] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleFileUpload</span> = <span class="keyword">async</span> (<span class="params">file</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> result = <span class="keyword">await</span> client.<span class="title function_">uploadFile</span>(file, &#123;</span><br><span class="line">        <span class="attr">projectId</span>: <span class="string">&#x27;project-123&#x27;</span>,</span><br><span class="line">        <span class="attr">onProgress</span>: <span class="function">(<span class="params">loaded, total</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">setUploadProgress</span>((loaded / total) * <span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      </span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Upload successful:&#x27;</span>, result);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Upload failed:&#x27;</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleFileDrop</span> = (<span class="params">acceptedFiles</span>) =&gt; &#123;</span><br><span class="line">    acceptedFiles.<span class="title function_">forEach</span>(<span class="function"><span class="params">file</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">handleFileUpload</span>(file);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">FileDropzone</span> <span class="attr">onDrop</span>=<span class="string">&#123;handleFileDrop&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;uploadProgress &gt; 0 &amp;&amp; (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">ProgressBar</span> <span class="attr">value</span>=<span class="string">&#123;uploadProgress&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      )&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Security-Best-Practices"><a href="#Security-Best-Practices" class="headerlink" title="Security Best Practices"></a>Security Best Practices</h2><h3 id="Content-Validation-and-Sanitization"><a href="#Content-Validation-and-Sanitization" class="headerlink" title="Content Validation and Sanitization"></a>Content Validation and Sanitization</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileSecurityService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; allowedContentTypes = Set.of(</span><br><span class="line">        <span class="string">&quot;image/jpeg&quot;</span>, <span class="string">&quot;image/png&quot;</span>, <span class="string">&quot;image/gif&quot;</span>, <span class="string">&quot;image/webp&quot;</span>,</span><br><span class="line">        <span class="string">&quot;application/pdf&quot;</span>, <span class="string">&quot;text/plain&quot;</span>, <span class="string">&quot;application/json&quot;</span>,</span><br><span class="line">        <span class="string">&quot;video/mp4&quot;</span>, <span class="string">&quot;video/webm&quot;</span></span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; dangerousExtensions = Set.of(</span><br><span class="line">        <span class="string">&quot;.exe&quot;</span>, <span class="string">&quot;.bat&quot;</span>, <span class="string">&quot;.cmd&quot;</span>, <span class="string">&quot;.scr&quot;</span>, <span class="string">&quot;.pif&quot;</span>, <span class="string">&quot;.com&quot;</span>, <span class="string">&quot;.vbs&quot;</span>, <span class="string">&quot;.js&quot;</span></span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">validateFile</span><span class="params">(MultipartFile file)</span> &#123;</span><br><span class="line">        <span class="comment">// Check file size</span></span><br><span class="line">        <span class="keyword">if</span> (file.getSize() &gt; MAX_FILE_SIZE) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileSizeExceededException</span>(<span class="string">&quot;File size exceeds maximum allowed size&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Validate content type</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">contentType</span> <span class="operator">=</span> file.getContentType();</span><br><span class="line">        <span class="keyword">if</span> (contentType == <span class="literal">null</span> || !allowedContentTypes.contains(contentType.toLowerCase())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedFileTypeException</span>(<span class="string">&quot;File type not allowed: &quot;</span> + contentType);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check file extension</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> file.getOriginalFilename();</span><br><span class="line">        <span class="keyword">if</span> (filename != <span class="literal">null</span> &amp;&amp; hasDangerousExtension(filename)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;File extension not allowed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Scan file content for malware (integrate with antivirus service)</span></span><br><span class="line">        scanForMalware(file);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Validate file signature matches declared content type</span></span><br><span class="line">        validateFileSignature(file, contentType);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">scanForMalware</span><span class="params">(MultipartFile file)</span> &#123;</span><br><span class="line">        <span class="comment">// Integration with antivirus scanning service</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">AntivirusResult</span> <span class="variable">result</span> <span class="operator">=</span> antivirusService.scanFile(file.getBytes());</span><br><span class="line">            <span class="keyword">if</span> (!result.isClean()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;File contains malware: &quot;</span> + result.getThreatName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;Unable to scan file for malware&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">validateFileSignature</span><span class="params">(MultipartFile file, String declaredContentType)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[] header = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">12</span>];</span><br><span class="line">            file.getInputStream().read(header);</span><br><span class="line">            </span><br><span class="line">            <span class="type">String</span> <span class="variable">detectedType</span> <span class="operator">=</span> detectContentType(header);</span><br><span class="line">            <span class="keyword">if</span> (!declaredContentType.equals(detectedType)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;File signature doesn&#x27;t match declared content type&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;Unable to validate file signature&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Access-Control-Implementation"><a href="#Access-Control-Implementation" class="headerlink" title="Access Control Implementation"></a>Access Control Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileAccessControlService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtTokenProvider tokenProvider;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PermissionEvaluator permissionEvaluator;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;@fileAccessControlService.canAccessFile(authentication, #fileId, &#x27;READ&#x27;)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> FileMetadata <span class="title function_">getFileMetadata</span><span class="params">(String fileId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fileMetadataRepository.findById(fileId)</span><br><span class="line">            .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">FileNotFoundException</span>(<span class="string">&quot;File not found: &quot;</span> + fileId));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">canAccessFile</span><span class="params">(Authentication authentication, String fileId, String operation)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> authentication.getName();</span><br><span class="line">        <span class="type">FileMetadata</span> <span class="variable">file</span> <span class="operator">=</span> getFileMetadata(fileId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Owner can do everything</span></span><br><span class="line">        <span class="keyword">if</span> (file.getCreatedBy().equals(userId)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check project-level permissions</span></span><br><span class="line">        <span class="keyword">if</span> (file.getProjectId() != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> permissionEvaluator.hasPermission(authentication, file.getProjectId(), <span class="string">&quot;Project&quot;</span>, operation);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check if file is public</span></span><br><span class="line">        <span class="keyword">if</span> (file.getVisibility() == FileVisibility.PUBLIC &amp;&amp; <span class="string">&quot;READ&quot;</span>.equals(operation)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check explicit file permissions</span></span><br><span class="line">        <span class="keyword">return</span> hasExplicitFilePermission(userId, fileId, operation);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">hasExplicitFilePermission</span><span class="params">(String userId, String fileId, String operation)</span> &#123;</span><br><span class="line">        <span class="comment">// Check file-specific permissions in ACL table</span></span><br><span class="line">        <span class="keyword">return</span> filePermissionRepository.existsByFileIdAndUserIdAndPermission(</span><br><span class="line">            fileId, userId, FilePermission.valueOf(operation)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Disaster-Recovery-and-Backup-Strategy"><a href="#Disaster-Recovery-and-Backup-Strategy" class="headerlink" title="Disaster Recovery and Backup Strategy"></a>Disaster Recovery and Backup Strategy</h2><h3 id="Automated-Backup-System"><a href="#Automated-Backup-System" class="headerlink" title="Automated Backup System"></a>Automated Backup System</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileBackupService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GcsService primaryGcsService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GcsService backupGcsService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileMetadataRepository fileMetadataRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0 2 * * *&quot;)</span> <span class="comment">// Daily at 2 AM</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performIncrementalBackup</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">lastBackup</span> <span class="operator">=</span> getLastBackupTime();</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Find files modified since last backup</span></span><br><span class="line">        List&lt;FileMetadata&gt; modifiedFiles = fileMetadataRepository</span><br><span class="line">            .findByUpdatedAtBetween(lastBackup, now);</span><br><span class="line">        </span><br><span class="line">        <span class="type">BackupResult</span> <span class="variable">result</span> <span class="operator">=</span> BackupResult.builder()</span><br><span class="line">            .startTime(now)</span><br><span class="line">            .totalFiles(modifiedFiles.size())</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Backup files in parallel</span></span><br><span class="line">            List&lt;CompletableFuture&lt;FileBackupResult&gt;&gt; futures = modifiedFiles.stream()</span><br><span class="line">                .map(file -&gt; CompletableFuture.supplyAsync(() -&gt; backupFile(file)))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">            </span><br><span class="line">            List&lt;FileBackupResult&gt; backupResults = futures.stream()</span><br><span class="line">                .map(CompletableFuture::join)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">            </span><br><span class="line">            result = result.toBuilder()</span><br><span class="line">                .endTime(LocalDateTime.now())</span><br><span class="line">                .successCount(backupResults.stream().mapToInt(r -&gt; r.isSuccess() ? <span class="number">1</span> : <span class="number">0</span>).sum())</span><br><span class="line">                .failureCount(backupResults.stream().mapToInt(r -&gt; r.isSuccess() ? <span class="number">0</span> : <span class="number">1</span>).sum())</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Record backup completion</span></span><br><span class="line">            recordBackupCompletion(result);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;Backup process failed&quot;</span>, e);</span><br><span class="line">            alertService.sendBackupFailureAlert(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> FileBackupResult <span class="title function_">backupFile</span><span class="params">(FileMetadata fileMetadata)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Generate backup path</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">backupPath</span> <span class="operator">=</span> generateBackupPath(fileMetadata);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Copy file to backup bucket</span></span><br><span class="line">            primaryGcsService.copyFile(fileMetadata.getGcsPath(), </span><br><span class="line">                backupGcsService, backupPath);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Create backup metadata record</span></span><br><span class="line">            <span class="type">FileBackupMetadata</span> <span class="variable">backupMetadata</span> <span class="operator">=</span> FileBackupMetadata.builder()</span><br><span class="line">                .originalFileId(fileMetadata.getFileId())</span><br><span class="line">                .backupPath(backupPath)</span><br><span class="line">                .backupTime(LocalDateTime.now())</span><br><span class="line">                .backupSize(fileMetadata.getFileSize())</span><br><span class="line">                .checksum(fileMetadata.getChecksumSha256())</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">            fileBackupRepository.save(backupMetadata);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> FileBackupResult.success(fileMetadata.getFileId());</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;Failed to backup file: &#123;&#125;&quot;</span>, fileMetadata.getFileId(), e);</span><br><span class="line">            <span class="keyword">return</span> FileBackupResult.failure(fileMetadata.getFileId(), e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0 3 * * 0&quot;)</span> <span class="comment">// Weekly on Sunday at 3 AM</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performFullBackup</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Full backup implementation</span></span><br><span class="line">        logger.info(<span class="string">&quot;Starting full backup process&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Export database schema and data</span></span><br><span class="line">        exportDatabase();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Backup all files</span></span><br><span class="line">        performFullFileBackup();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Verify backup integrity</span></span><br><span class="line">        verifyBackupIntegrity();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> RestoreResult <span class="title function_">restoreFromBackup</span><span class="params">(RestoreRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (request.getRestoreType() == RestoreType.POINT_IN_TIME) &#123;</span><br><span class="line">                <span class="keyword">return</span> restoreToPointInTime(request.getTargetTime());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (request.getRestoreType() == RestoreType.SPECIFIC_FILES) &#123;</span><br><span class="line">                <span class="keyword">return</span> restoreSpecificFiles(request.getFileIds());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> restoreFullSystem(request.getBackupId());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;Restore operation failed&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> RestoreResult.failure(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Multi-Region-Deployment-Flow"><a href="#Multi-Region-Deployment-Flow" class="headerlink" title="Multi-Region Deployment Flow"></a>Multi-Region Deployment Flow</h3><pre>
<code class="mermaid">
graph TB
subgraph &quot;Primary Region (US-Central)&quot;
    A[API Gateway] --&gt; B[File Service Instances]
    B --&gt; C[Primary PostgreSQL]
    B --&gt; D[Primary GCS Bucket]
    B --&gt; E[Redis Cache]
end

subgraph &quot;Secondary Region (Europe-West)&quot;
    F[API Gateway] --&gt; G[File Service Instances]
    G --&gt; H[Read Replica PostgreSQL]
    G --&gt; I[Secondary GCS Bucket]
    G --&gt; J[Redis Cache]
end

subgraph &quot;Disaster Recovery Region (Asia-Southeast)&quot;
    K[Standby API Gateway] --&gt; L[Standby File Service]
    L --&gt; M[Backup PostgreSQL]
    L --&gt; N[Archive GCS Bucket]
end

C --&gt; H
D --&gt; I
D --&gt; N

O[Global Load Balancer] --&gt; A
O --&gt; F
O --&gt; K

P[Health Checker] --&gt; O
Q[Failover Controller] --&gt; O

style A fill:#e1f5fe
style F fill:#e8f5e8
style K fill:#fff3e0
</code>
</pre>

<h2 id="Cost-Optimization-Strategies"><a href="#Cost-Optimization-Strategies" class="headerlink" title="Cost Optimization Strategies"></a>Cost Optimization Strategies</h2><h3 id="Intelligent-Storage-Class-Management"><a href="#Intelligent-Storage-Class-Management" class="headerlink" title="Intelligent Storage Class Management"></a>Intelligent Storage Class Management</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StorageCostOptimizer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GcsService gcsService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileMetadataRepository fileMetadataRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileAccessLogRepository accessLogRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0 1 * * *&quot;)</span> <span class="comment">// Daily at 1 AM</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">optimizeStorageClasses</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">cutoffDate</span> <span class="operator">=</span> LocalDateTime.now().minusDays(<span class="number">30</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Find files that haven&#x27;t been accessed in 30 days</span></span><br><span class="line">        List&lt;FileMetadata&gt; candidates = fileMetadataRepository.findInfrequentlyAccessedFiles(cutoffDate);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (FileMetadata file : candidates) &#123;</span><br><span class="line">            <span class="type">StorageOptimizationDecision</span> <span class="variable">decision</span> <span class="operator">=</span> analyzeFile(file);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (decision.shouldChangeStorageClass()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    gcsService.changeStorageClass(file.getGcsPath(), decision.getTargetStorageClass());</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// Update metadata</span></span><br><span class="line">                    file.setStorageClass(decision.getTargetStorageClass());</span><br><span class="line">                    file.setLastOptimized(LocalDateTime.now());</span><br><span class="line">                    fileMetadataRepository.save(file);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// Record cost savings</span></span><br><span class="line">                    recordCostSavings(file, decision);</span><br><span class="line">                    </span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    logger.error(<span class="string">&quot;Failed to optimize storage for file: &#123;&#125;&quot;</span>, file.getFileId(), e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> StorageOptimizationDecision <span class="title function_">analyzeFile</span><span class="params">(FileMetadata file)</span> &#123;</span><br><span class="line">        <span class="comment">// Analyze access patterns</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">accessCount</span> <span class="operator">=</span> accessLogRepository.countByFileIdAndAccessTimeAfter(</span><br><span class="line">            file.getFileId(), LocalDateTime.now().minusDays(<span class="number">30</span>)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">lastAccess</span> <span class="operator">=</span> accessLogRepository.findLastAccessTime(file.getFileId());</span><br><span class="line">        <span class="type">long</span> <span class="variable">daysSinceLastAccess</span> <span class="operator">=</span> ChronoUnit.DAYS.between(lastAccess, LocalDateTime.now());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Decision matrix for storage class optimization</span></span><br><span class="line">        <span class="keyword">if</span> (daysSinceLastAccess &gt; <span class="number">365</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> StorageOptimizationDecision.moveToArchive();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (daysSinceLastAccess &gt; <span class="number">90</span> &amp;&amp; accessCount &lt; <span class="number">5</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> StorageOptimizationDecision.moveToColdline();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (daysSinceLastAccess &gt; <span class="number">30</span> &amp;&amp; accessCount &lt; <span class="number">10</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> StorageOptimizationDecision.moveToNearline();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> StorageOptimizationDecision.noChange();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">recordCostSavings</span><span class="params">(FileMetadata file, StorageOptimizationDecision decision)</span> &#123;</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">originalCost</span> <span class="operator">=</span> calculateMonthlyCost(file.getFileSize(), file.getCurrentStorageClass());</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">newCost</span> <span class="operator">=</span> calculateMonthlyCost(file.getFileSize(), decision.getTargetStorageClass());</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">savings</span> <span class="operator">=</span> originalCost.subtract(newCost);</span><br><span class="line">        </span><br><span class="line">        <span class="type">CostOptimizationRecord</span> <span class="variable">record</span> <span class="operator">=</span> CostOptimizationRecord.builder()</span><br><span class="line">            .fileId(file.getFileId())</span><br><span class="line">            .optimizationDate(LocalDateTime.now())</span><br><span class="line">            .fromStorageClass(file.getCurrentStorageClass())</span><br><span class="line">            .toStorageClass(decision.getTargetStorageClass())</span><br><span class="line">            .fileSize(file.getFileSize())</span><br><span class="line">            .monthlySavings(savings)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        costOptimizationRepository.save(record);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Update metrics</span></span><br><span class="line">        costSavingsCounter.increment(Tags.of(<span class="string">&quot;storage_class&quot;</span>, decision.getTargetStorageClass().name()),</span><br><span class="line">            savings.doubleValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Usage-Analytics-and-Reporting"><a href="#Usage-Analytics-and-Reporting" class="headerlink" title="Usage Analytics and Reporting"></a>Usage Analytics and Reporting</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileStorageAnalyticsService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> StorageAnalyticsReport <span class="title function_">generateMonthlyReport</span><span class="params">(String projectId, YearMonth month)</span> &#123;</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">startOfMonth</span> <span class="operator">=</span> month.atDay(<span class="number">1</span>).atStartOfDay();</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">endOfMonth</span> <span class="operator">=</span> month.atEndOfMonth().atTime(<span class="number">23</span>, <span class="number">59</span>, <span class="number">59</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Storage usage metrics</span></span><br><span class="line">        <span class="type">StorageUsageMetrics</span> <span class="variable">usage</span> <span class="operator">=</span> StorageUsageMetrics.builder()</span><br><span class="line">            .totalFiles(fileMetadataRepository.countByProjectIdAndCreatedAtBetween(</span><br><span class="line">                projectId, startOfMonth, endOfMonth))</span><br><span class="line">            .totalStorageBytes(fileMetadataRepository.sumFileSizeByProjectIdAndDateRange(</span><br><span class="line">                projectId, startOfMonth, endOfMonth))</span><br><span class="line">            .averageFileSize(calculateAverageFileSize(projectId, startOfMonth, endOfMonth))</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Access patterns</span></span><br><span class="line">        <span class="type">AccessPatternMetrics</span> <span class="variable">access</span> <span class="operator">=</span> AccessPatternMetrics.builder()</span><br><span class="line">            .totalDownloads(accessLogRepository.countDownloadsByProjectAndDateRange(</span><br><span class="line">                projectId, startOfMonth, endOfMonth))</span><br><span class="line">            .totalUploads(uploadLogRepository.countUploadsByProjectAndDateRange(</span><br><span class="line">                projectId, startOfMonth, endOfMonth))</span><br><span class="line">            .uniqueUsers(accessLogRepository.countUniqueUsersByProjectAndDateRange(</span><br><span class="line">                projectId, startOfMonth, endOfMonth))</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Cost analysis</span></span><br><span class="line">        <span class="type">CostAnalysisMetrics</span> <span class="variable">cost</span> <span class="operator">=</span> CostAnalysisMetrics.builder()</span><br><span class="line">            .storageCost(calculateStorageCost(usage))</span><br><span class="line">            .bandwidthCost(calculateBandwidthCost(access))</span><br><span class="line">            .operationsCost(calculateOperationsCost(access))</span><br><span class="line">            .totalCost(calculateTotalCost(usage, access))</span><br><span class="line">            .projectedCost(projectCostForNextMonth(usage, access))</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Top files by size and access</span></span><br><span class="line">        List&lt;FileUsageStats&gt; topFilesBySize = getTopFilesBySize(projectId, <span class="number">10</span>);</span><br><span class="line">        List&lt;FileUsageStats&gt; topFilesByAccess = getTopFilesByAccess(projectId, <span class="number">10</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> StorageAnalyticsReport.builder()</span><br><span class="line">            .projectId(projectId)</span><br><span class="line">            .reportMonth(month)</span><br><span class="line">            .generatedAt(LocalDateTime.now())</span><br><span class="line">            .storageUsage(usage)</span><br><span class="line">            .accessPatterns(access)</span><br><span class="line">            .costAnalysis(cost)</span><br><span class="line">            .topFilesBySize(topFilesBySize)</span><br><span class="line">            .topFilesByAccess(topFilesByAccess)</span><br><span class="line">            .recommendations(generateRecommendations(usage, access, cost))</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> List&lt;CostOptimizationRecommendation&gt; <span class="title function_">generateRecommendations</span><span class="params">(</span></span><br><span class="line"><span class="params">            StorageUsageMetrics usage, AccessPatternMetrics access, CostAnalysisMetrics cost)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        List&lt;CostOptimizationRecommendation&gt; recommendations = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Recommendation 1: Storage class optimization</span></span><br><span class="line">        <span class="keyword">if</span> (cost.getStorageCost().compareTo(cost.getBandwidthCost()) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            recommendations.add(CostOptimizationRecommendation.builder()</span><br><span class="line">                .type(RecommendationType.STORAGE_CLASS_OPTIMIZATION)</span><br><span class="line">                .description(<span class="string">&quot;Consider moving infrequently accessed files to cheaper storage classes&quot;</span>)</span><br><span class="line">                .potentialSavings(estimateStorageClassSavings(usage))</span><br><span class="line">                .priority(RecommendationPriority.HIGH)</span><br><span class="line">                .build());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Recommendation 2: File lifecycle management</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">oldFilesCount</span> <span class="operator">=</span> fileMetadataRepository.countOldFiles(</span><br><span class="line">            usage.getProjectId(), LocalDateTime.now().minusYears(<span class="number">1</span>)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (oldFilesCount &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">            recommendations.add(CostOptimizationRecommendation.builder()</span><br><span class="line">                .type(RecommendationType.LIFECYCLE_POLICY)</span><br><span class="line">                .description(<span class="string">&quot;Implement automatic archival for files older than 1 year&quot;</span>)</span><br><span class="line">                .potentialSavings(estimateLifecycleSavings(oldFilesCount))</span><br><span class="line">                .priority(RecommendationPriority.MEDIUM)</span><br><span class="line">                .build());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> recommendations;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Testing-Strategy"><a href="#Testing-Strategy" class="headerlink" title="Testing Strategy"></a>Testing Strategy</h2><h3 id="Integration-Testing"><a href="#Integration-Testing" class="headerlink" title="Integration Testing"></a>Integration Testing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)</span></span><br><span class="line"><span class="meta">@TestPropertySource(properties = &#123;</span></span><br><span class="line"><span class="meta">    &quot;spring.datasource.url=jdbc:h2:mem:testdb&quot;,</span></span><br><span class="line"><span class="meta">    &quot;gcs.bucket-name=test-bucket&quot;,</span></span><br><span class="line"><span class="meta">    &quot;redis.host=localhost&quot;</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileStorageIntegrationTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TestRestTemplate restTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> FileMetadataRepository fileMetadataRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@MockBean</span></span><br><span class="line">    <span class="keyword">private</span> GcsService gcsService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldUploadFileSuccessfully</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// Arrange</span></span><br><span class="line">        <span class="type">MockMultipartFile</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockMultipartFile</span>(</span><br><span class="line">            <span class="string">&quot;file&quot;</span>, <span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;text/plain&quot;</span>, <span class="string">&quot;Hello World&quot;</span>.getBytes()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">when</span>(gcsService.uploadFile(any(), any(), any(), any()))</span><br><span class="line">            .thenReturn(<span class="string">&quot;test-bucket/files/test.txt&quot;</span>);</span><br><span class="line">        <span class="keyword">when</span>(gcsService.generateSignedUrl(any(), any()))</span><br><span class="line">            .thenReturn(<span class="string">&quot;https://storage.googleapis.com/test-bucket/files/test.txt&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Act</span></span><br><span class="line">        MultiValueMap&lt;String, Object&gt; body = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line">        body.add(<span class="string">&quot;file&quot;</span>, file.getResource());</span><br><span class="line">        body.add(<span class="string">&quot;projectId&quot;</span>, <span class="string">&quot;test-project&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">        headers.setContentType(MediaType.MULTIPART_FORM_DATA);</span><br><span class="line">        headers.setBearerAuth(<span class="string">&quot;test-token&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        ResponseEntity&lt;FileUploadResponse&gt; response = restTemplate.exchange(</span><br><span class="line">            <span class="string">&quot;/api/v1/files/upload&quot;</span>,</span><br><span class="line">            HttpMethod.POST,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(body, headers),</span><br><span class="line">            FileUploadResponse.class</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Assert</span></span><br><span class="line">        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);</span><br><span class="line">        assertThat(response.getBody().getFileId()).isNotNull();</span><br><span class="line">        assertThat(response.getBody().getDownloadUrl()).contains(<span class="string">&quot;storage.googleapis.com&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Verify database record</span></span><br><span class="line">        Optional&lt;FileMetadata&gt; savedFile = fileMetadataRepository.findById(response.getBody().getFileId());</span><br><span class="line">        assertThat(savedFile).isPresent();</span><br><span class="line">        assertThat(savedFile.get().getOriginalFileName()).isEqualTo(<span class="string">&quot;test.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldHandleChunkedUploadCorrectly</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// Arrange</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">uploadId</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        <span class="type">int</span> <span class="variable">totalChunks</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">chunkSize</span> <span class="operator">=</span> <span class="number">1024</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Initiate chunked upload</span></span><br><span class="line">        <span class="type">ChunkedUploadRequest</span> <span class="variable">initRequest</span> <span class="operator">=</span> ChunkedUploadRequest.builder()</span><br><span class="line">            .fileName(<span class="string">&quot;large-file.mp4&quot;</span>)</span><br><span class="line">            .totalSize(<span class="number">3072</span>)</span><br><span class="line">            .chunkSize(chunkSize)</span><br><span class="line">            .projectId(<span class="string">&quot;test-project&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        ResponseEntity&lt;ChunkedUploadResponse&gt; initResponse = restTemplate.postForEntity(</span><br><span class="line">            <span class="string">&quot;/api/v1/files/upload/chunked/initiate&quot;</span>,</span><br><span class="line">            initRequest,</span><br><span class="line">            ChunkedUploadResponse.class</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        assertThat(initResponse.getStatusCode()).isEqualTo(HttpStatus.OK);</span><br><span class="line">        <span class="type">String</span> <span class="variable">actualUploadId</span> <span class="operator">=</span> initResponse.getBody().getUploadId();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Upload chunks</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= totalChunks; i++) &#123;</span><br><span class="line">            <span class="type">MockMultipartFile</span> <span class="variable">chunk</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockMultipartFile</span>(</span><br><span class="line">                <span class="string">&quot;chunk&quot;</span>, <span class="string">&quot;chunk&quot;</span> + i, <span class="string">&quot;application/octet-stream&quot;</span>, </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">byte</span>[i == totalChunks ? <span class="number">1024</span> : chunkSize] <span class="comment">// Last chunk smaller</span></span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            MultiValueMap&lt;String, Object&gt; chunkBody = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line">            chunkBody.add(<span class="string">&quot;chunk&quot;</span>, chunk.getResource());</span><br><span class="line">            </span><br><span class="line">            ResponseEntity&lt;ChunkUploadResponse&gt; chunkResponse = restTemplate.exchange(</span><br><span class="line">                <span class="string">&quot;/api/v1/files/upload/chunked/&quot;</span> + actualUploadId + <span class="string">&quot;/chunk/&quot;</span> + i,</span><br><span class="line">                HttpMethod.PUT,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(chunkBody, createAuthHeaders()),</span><br><span class="line">                ChunkUploadResponse.class</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            assertThat(chunkResponse.getStatusCode()).isEqualTo(HttpStatus.OK);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (i == totalChunks) &#123;</span><br><span class="line">                <span class="comment">// Last chunk should complete the upload</span></span><br><span class="line">                assertThat(chunkResponse.getBody().isCompleted()).isTrue();</span><br><span class="line">                assertThat(chunkResponse.getBody().getFileId()).isNotNull();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shouldEnforceRateLimitsCorrectly</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Test rate limiting behavior</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> <span class="string">&quot;test-user&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Simulate exceeding rate limit</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">15</span>; i++) &#123; <span class="comment">// Assuming limit is 10 requests per minute</span></span><br><span class="line">            <span class="type">MockMultipartFile</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockMultipartFile</span>(</span><br><span class="line">                <span class="string">&quot;file&quot;</span>, <span class="string">&quot;test&quot;</span> + i + <span class="string">&quot;.txt&quot;</span>, <span class="string">&quot;text/plain&quot;</span>, (<span class="string">&quot;Content &quot;</span> + i).getBytes()</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            MultiValueMap&lt;String, Object&gt; body = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line">            body.add(<span class="string">&quot;file&quot;</span>, file.getResource());</span><br><span class="line">            </span><br><span class="line">            ResponseEntity&lt;String&gt; response = restTemplate.exchange(</span><br><span class="line">                <span class="string">&quot;/api/v1/files/upload&quot;</span>,</span><br><span class="line">                HttpMethod.POST,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(body, createAuthHeaders(userId)),</span><br><span class="line">                String.class</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (i &lt; <span class="number">10</span>) &#123;</span><br><span class="line">                assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                assertThat(response.getStatusCode()).isEqualTo(HttpStatus.TOO_MANY_REQUESTS);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Load-Testing-with-JMeter-Configuration"><a href="#Load-Testing-with-JMeter-Configuration" class="headerlink" title="Load Testing with JMeter Configuration"></a>Load Testing with JMeter Configuration</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">jmeterTestPlan</span> <span class="attr">version</span>=<span class="string">&quot;1.2&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">hashTree</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TestPlan</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;TestPlan.comments&quot;</span>&gt;</span>File Storage Service Load Test<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">boolProp</span> <span class="attr">name</span>=<span class="string">&quot;TestPlan.functional_mode&quot;</span>&gt;</span>false<span class="tag">&lt;/<span class="name">boolProp</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">boolProp</span> <span class="attr">name</span>=<span class="string">&quot;TestPlan.tearDown_on_shutdown&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">boolProp</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">boolProp</span> <span class="attr">name</span>=<span class="string">&quot;TestPlan.serialize_threadgroups&quot;</span>&gt;</span>false<span class="tag">&lt;/<span class="name">boolProp</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">elementProp</span> <span class="attr">name</span>=<span class="string">&quot;TestPlan.arguments&quot;</span> <span class="attr">elementType</span>=<span class="string">&quot;Arguments&quot;</span> <span class="attr">guiclass</span>=<span class="string">&quot;ArgumentsPanel&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">collectionProp</span> <span class="attr">name</span>=<span class="string">&quot;Arguments.arguments&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">elementProp</span> <span class="attr">name</span>=<span class="string">&quot;base_url&quot;</span> <span class="attr">elementType</span>=<span class="string">&quot;Argument&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;Argument.name&quot;</span>&gt;</span>base_url<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;Argument.value&quot;</span>&gt;</span>https://api.fileservice.com<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">elementProp</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">collectionProp</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">elementProp</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;TestPlan.user_define_classpath&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">TestPlan</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hashTree</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- Thread Group for File Upload Load Test --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ThreadGroup</span> <span class="attr">guiclass</span>=<span class="string">&quot;ThreadGroupGui&quot;</span> <span class="attr">testclass</span>=<span class="string">&quot;ThreadGroup&quot;</span> <span class="attr">testname</span>=<span class="string">&quot;File Upload Load Test&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;ThreadGroup.on_sample_error&quot;</span>&gt;</span>continue<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">elementProp</span> <span class="attr">name</span>=<span class="string">&quot;ThreadGroup.main_controller&quot;</span> <span class="attr">elementType</span>=<span class="string">&quot;LoopController&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">boolProp</span> <span class="attr">name</span>=<span class="string">&quot;LoopController.continue_forever&quot;</span>&gt;</span>false<span class="tag">&lt;/<span class="name">boolProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;LoopController.loops&quot;</span>&gt;</span>10<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">elementProp</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;ThreadGroup.num_threads&quot;</span>&gt;</span>100<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;ThreadGroup.ramp_time&quot;</span>&gt;</span>60<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">boolProp</span> <span class="attr">name</span>=<span class="string">&quot;ThreadGroup.scheduler&quot;</span>&gt;</span>false<span class="tag">&lt;/<span class="name">boolProp</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;ThreadGroup.duration&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;ThreadGroup.delay&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">ThreadGroup</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">hashTree</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- HTTP Request for File Upload --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">HTTPSamplerProxy</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">elementProp</span> <span class="attr">name</span>=<span class="string">&quot;HTTPsampler.Files&quot;</span> <span class="attr">elementType</span>=<span class="string">&quot;HTTPFileArgs&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">collectionProp</span> <span class="attr">name</span>=<span class="string">&quot;HTTPFileArgs.files&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">elementProp</span> <span class="attr">name</span>=<span class="string">&quot;&quot;</span> <span class="attr">elementType</span>=<span class="string">&quot;HTTPFileArg&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;File.path&quot;</span>&gt;</span>$&#123;__P(test_file_path)&#125;<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;File.paramname&quot;</span>&gt;</span>file<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;File.mimetype&quot;</span>&gt;</span>application/octet-stream<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">elementProp</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">collectionProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">elementProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">elementProp</span> <span class="attr">name</span>=<span class="string">&quot;HTTPsampler.Arguments&quot;</span> <span class="attr">elementType</span>=<span class="string">&quot;Arguments&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">collectionProp</span> <span class="attr">name</span>=<span class="string">&quot;Arguments.arguments&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">elementProp</span> <span class="attr">name</span>=<span class="string">&quot;projectId&quot;</span> <span class="attr">elementType</span>=<span class="string">&quot;HTTPArgument&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">boolProp</span> <span class="attr">name</span>=<span class="string">&quot;HTTPArgument.always_encode&quot;</span>&gt;</span>false<span class="tag">&lt;/<span class="name">boolProp</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;Argument.value&quot;</span>&gt;</span>load-test-project<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;Argument.name&quot;</span>&gt;</span>projectId<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">elementProp</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">collectionProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">elementProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;HTTPSampler.domain&quot;</span>&gt;</span>$&#123;base_url&#125;<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;HTTPSampler.port&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;HTTPSampler.protocol&quot;</span>&gt;</span>https<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;HTTPSampler.contentEncoding&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;HTTPSampler.path&quot;</span>&gt;</span>/api/v1/files/upload<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">stringProp</span> <span class="attr">name</span>=<span class="string">&quot;HTTPSampler.method&quot;</span>&gt;</span>POST<span class="tag">&lt;/<span class="name">stringProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">boolProp</span> <span class="attr">name</span>=<span class="string">&quot;HTTPSampler.follow_redirects&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">boolProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">boolProp</span> <span class="attr">name</span>=<span class="string">&quot;HTTPSampler.auto_redirects&quot;</span>&gt;</span>false<span class="tag">&lt;/<span class="name">boolProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">boolProp</span> <span class="attr">name</span>=<span class="string">&quot;HTTPSampler.use_keepalive&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">boolProp</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">boolProp</span> <span class="attr">name</span>=<span class="string">&quot;HTTPSampler.DO_MULTIPART_POST&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">boolProp</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">HTTPSamplerProxy</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">hashTree</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">hashTree</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">hashTree</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">jmeterTestPlan</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="External-Resources-and-Documentation"><a href="#External-Resources-and-Documentation" class="headerlink" title="External Resources and Documentation"></a>External Resources and Documentation</h2><h3 id="Essential-Resources"><a href="#Essential-Resources" class="headerlink" title="Essential Resources"></a>Essential Resources</h3><p><strong>Google Cloud Storage Documentation:</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://cloud.google.com/storage/docs/best-practices">GCS Best Practices Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.google.com/storage/docs/storage-classes">Storage Classes and Lifecycle Management</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.google.com/storage/docs/resumable-uploads">Resumable Uploads</a></li>
</ul>
<p><strong>PostgreSQL Performance:</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://wiki.postgresql.org/wiki/Performance_Optimization">PostgreSQL Performance Tuning Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://use-the-index-luke.com/">Indexing Strategies</a></li>
<li><a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/current/datatype-json.html">JSONB Performance</a></li>
</ul>
<p><strong>Spring Boot Integration:</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://spring.io/guides/gs/uploading-files/">Spring Boot File Upload</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/">Spring Security Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html">Spring Boot Actuator</a></li>
</ul>
<p><strong>Monitoring and Observability:</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://micrometer.io/docs">Micrometer Metrics</a></li>
<li><a target="_blank" rel="noopener" href="https://prometheus.io/docs/practices/naming/">Prometheus Best Practices</a></li>
<li><a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards">Grafana Dashboard Examples</a></li>
</ul>
<p><strong>Security Best Practices:</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload">OWASP File Upload Security</a></li>
<li><a target="_blank" rel="noopener" href="https://auth0.com/blog/a-look-at-the-latest-draft-for-jwt-bcp/">JWT Security Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.google.com/security/best-practices">Google Cloud Security Best Practices</a></li>
</ul>
<p>This comprehensive file storage service design provides a production-ready, scalable solution that handles millions of files efficiently while maintaining high availability, security, and performance standards. The architecture supports both small and large file operations, implements intelligent cost optimization, and provides robust monitoring and disaster recovery capabilities.
    </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/08/03/K8s-common-interview-questions/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/08/03/K8s-common-interview-questions/" class="post-title-link" itemprop="url">K8s common interview questions</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-08-03 15:38:17 / Modified: 15:44:32" itemprop="dateCreated datePublished" datetime="2025-08-03T15:38:17+08:00">2025-08-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="What-is-Kubernetes-and-why-would-you-use-it-for-Java-applications"><a href="#What-is-Kubernetes-and-why-would-you-use-it-for-Java-applications" class="headerlink" title="What is Kubernetes and why would you use it for Java applications?"></a>What is Kubernetes and why would you use it for Java applications?</h2><h3 id="Reference-Answer"><a href="#Reference-Answer" class="headerlink" title="Reference Answer"></a>Reference Answer</h3><p>Kubernetes is an open-source container orchestration platform that automates the deployment, scaling, and management of containerized applications. It acts as a distributed operating system for containerized workloads.</p>
<h3 id="Key-Benefits-for-Java-Applications"><a href="#Key-Benefits-for-Java-Applications" class="headerlink" title="Key Benefits for Java Applications:"></a>Key Benefits for Java Applications:</h3><ul>
<li><strong>Microservices Architecture</strong>: Enables independent scaling and deployment of Java services</li>
<li><strong>Service Discovery</strong>: Built-in DNS-based service discovery eliminates hardcoded endpoints</li>
<li><strong>Load Balancing</strong>: Automatic distribution of traffic across healthy instances</li>
<li><strong>Rolling Deployments</strong>: Zero-downtime deployments with gradual traffic shifting</li>
<li><strong>Configuration Management</strong>: Externalized configuration through ConfigMaps and Secrets</li>
<li><strong>Resource Management</strong>: Optimal JVM performance through resource quotas and limits</li>
<li><strong>Self-Healing</strong>: Automatic restart of failed containers and rescheduling on healthy nodes</li>
<li><strong>Horizontal Scaling</strong>: Auto-scaling based on CPU, memory, or custom metrics</li>
</ul>
<h3 id="Architecture-Overview"><a href="#Architecture-Overview" class="headerlink" title="Architecture Overview"></a>Architecture Overview</h3><pre>
<code class="mermaid">
graph TB
subgraph &quot;Kubernetes Cluster&quot;
    subgraph &quot;Master Node&quot;
        API[API Server]
        ETCD[etcd]
        SCHED[Scheduler]
        CM[Controller Manager]
    end
    
    subgraph &quot;Worker Node 1&quot;
        KUBELET1[Kubelet]
        PROXY1[Kube-proxy]
        subgraph &quot;Pods&quot;
            POD1[Java App Pod 1]
            POD2[Java App Pod 2]
        end
    end
    
    subgraph &quot;Worker Node 2&quot;
        KUBELET2[Kubelet]
        PROXY2[Kube-proxy]
        POD3[Java App Pod 3]
    end
end

USERS[Users] --&gt; API
API --&gt; ETCD
API --&gt; SCHED
API --&gt; CM
SCHED --&gt; KUBELET1
SCHED --&gt; KUBELET2
</code>
</pre>

<hr>
<h2 id="Explain-the-difference-between-Pods-Services-and-Deployments"><a href="#Explain-the-difference-between-Pods-Services-and-Deployments" class="headerlink" title="Explain the difference between Pods, Services, and Deployments"></a>Explain the difference between Pods, Services, and Deployments</h2><h3 id="Reference-Answer-1"><a href="#Reference-Answer-1" class="headerlink" title="Reference Answer"></a>Reference Answer</h3><p>These are fundamental Kubernetes resources that work together to run and expose applications.</p>
<h3 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h3><ul>
<li><strong>Definition</strong>: Smallest deployable unit containing one or more containers</li>
<li><strong>Characteristics</strong>: Shared network and storage, ephemeral, single IP address</li>
<li><strong>Java Context</strong>: Typically one JVM per pod for resource isolation</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">java-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">java-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">openjdk:11-jre-slim</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;512Mi&quot;</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;1000m&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><ul>
<li><strong>Definition</strong>: Abstraction that defines access to a logical set of pods</li>
<li><strong>Types</strong>: ClusterIP (internal), NodePort (external via node), LoadBalancer (cloud LB)</li>
<li><strong>Purpose</strong>: Provides stable networking and load balancing</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">java-app</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br></pre></td></tr></table></figure>

<h3 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h3><ul>
<li><strong>Definition</strong>: Higher-level resource managing ReplicaSets and pod lifecycles</li>
<li><strong>Features</strong>: Rolling updates, rollbacks, replica management, declarative updates</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">java-app</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">java-app</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">java-app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">my-java-app:1.0</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<h3 id="Relationship-Diagram"><a href="#Relationship-Diagram" class="headerlink" title="Relationship Diagram"></a>Relationship Diagram</h3><pre>
<code class="mermaid">
graph LR
DEPLOY[Deployment] --&gt; RS[ReplicaSet]
RS --&gt; POD1[Pod 1]
RS --&gt; POD2[Pod 2]
RS --&gt; POD3[Pod 3]

SVC[Service] --&gt; POD1
SVC --&gt; POD2
SVC --&gt; POD3

USERS[External Users] --&gt; SVC
</code>
</pre>

<hr>
<h2 id="How-do-you-handle-configuration-management-for-Java-applications-in-Kubernetes"><a href="#How-do-you-handle-configuration-management-for-Java-applications-in-Kubernetes" class="headerlink" title="How do you handle configuration management for Java applications in Kubernetes?"></a>How do you handle configuration management for Java applications in Kubernetes?</h2><h3 id="Reference-Answer-2"><a href="#Reference-Answer-2" class="headerlink" title="Reference Answer"></a>Reference Answer</h3><p>Configuration management in Kubernetes separates configuration from application code using ConfigMaps and Secrets, following the twelve-factor app methodology.</p>
<h3 id="ConfigMaps-Non-sensitive-data"><a href="#ConfigMaps-Non-sensitive-data" class="headerlink" title="ConfigMaps (Non-sensitive data)"></a>ConfigMaps (Non-sensitive data)</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">application.properties:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    server.port=8080</span></span><br><span class="line"><span class="string">    spring.profiles.active=production</span></span><br><span class="line"><span class="string">    logging.level.com.example=INFO</span></span><br><span class="line"><span class="string">    database.pool.size=10</span></span><br><span class="line"><span class="string"></span>  <span class="attr">app.env:</span> <span class="string">&quot;production&quot;</span></span><br><span class="line">  <span class="attr">debug.enabled:</span> <span class="string">&quot;false&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Secrets-Sensitive-data"><a href="#Secrets-Sensitive-data" class="headerlink" title="Secrets (Sensitive data)"></a>Secrets (Sensitive data)</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app-secrets</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">database-username:</span> <span class="string">dXNlcm5hbWU=</span>  <span class="comment"># base64 encoded</span></span><br><span class="line">  <span class="attr">database-password:</span> <span class="string">cGFzc3dvcmQ=</span>  <span class="comment"># base64 encoded</span></span><br><span class="line">  <span class="attr">api-key:</span> <span class="string">YWJjZGVmZ2hpams=</span>        <span class="comment"># base64 encoded</span></span><br></pre></td></tr></table></figure>

<h3 id="Using-Configuration-in-Deployment"><a href="#Using-Configuration-in-Deployment" class="headerlink" title="Using Configuration in Deployment"></a>Using Configuration in Deployment</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">my-java-app:1.0</span></span><br><span class="line">        <span class="comment"># Environment variables from ConfigMap</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_PROFILES_ACTIVE</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">java-app-config</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">app.env</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_USERNAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">java-app-secrets</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">database-username</span></span><br><span class="line">        <span class="comment"># Mount ConfigMap as volume</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/app/config</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secret-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/app/secrets</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">java-app-config</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secret-volume</span></span><br><span class="line">        <span class="attr">secret:</span></span><br><span class="line">          <span class="attr">secretName:</span> <span class="string">java-app-secrets</span></span><br></pre></td></tr></table></figure>

<h3 id="Spring-Boot-Integration"><a href="#Spring-Boot-Integration" class="headerlink" title="Spring Boot Integration"></a>Spring Boot Integration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;app&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String environment;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> debugEnabled;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// getters and setters</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;database.pool.size:5&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> poolSize;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AppConfig appConfig;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Configuration-Hot-Reloading-with-Spring-Cloud-Kubernetes"><a href="#Configuration-Hot-Reloading-with-Spring-Cloud-Kubernetes" class="headerlink" title="Configuration Hot-Reloading with Spring Cloud Kubernetes"></a>Configuration Hot-Reloading with Spring Cloud Kubernetes</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-kubernetes-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">kubernetes:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">sources:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">java-app-config</span></span><br><span class="line">          <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">reload:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">event</span></span><br><span class="line">        <span class="attr">strategy:</span> <span class="string">refresh</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Describe-resource-management-and-JVM-tuning-in-Kubernetes"><a href="#Describe-resource-management-and-JVM-tuning-in-Kubernetes" class="headerlink" title="Describe resource management and JVM tuning in Kubernetes"></a>Describe resource management and JVM tuning in Kubernetes</h2><h3 id="Reference-Answer-3"><a href="#Reference-Answer-3" class="headerlink" title="Reference Answer"></a>Reference Answer</h3><p>Resource management in Kubernetes involves setting appropriate CPU and memory requests and limits, while JVM tuning ensures optimal performance within container constraints.</p>
<h3 id="Resource-Requests-vs-Limits"><a href="#Resource-Requests-vs-Limits" class="headerlink" title="Resource Requests vs Limits"></a>Resource Requests vs Limits</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">java-app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">my-java-app:1.0</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span>      <span class="comment"># Guaranteed memory</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span>        <span class="comment"># Guaranteed CPU (0.5 cores)</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;2Gi&quot;</span>      <span class="comment"># Maximum memory</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;1000m&quot;</span>       <span class="comment"># Maximum CPU (1 core)</span></span><br></pre></td></tr></table></figure>

<h3 id="JVM-Container-Awareness"><a href="#JVM-Container-Awareness" class="headerlink" title="JVM Container Awareness"></a>JVM Container Awareness</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">java-app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">openjdk:11-jre-slim</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&gt;-</span></span><br><span class="line"><span class="string">            -XX:+UseContainerSupport</span></span><br><span class="line"><span class="string">            -XX:MaxRAMPercentage=75.0</span></span><br><span class="line"><span class="string">            -XX:+UseG1GC</span></span><br><span class="line"><span class="string">            -XX:+UseStringDeduplication</span></span><br><span class="line"><span class="string">            -XX:+OptimizeStringConcat</span></span><br><span class="line"><span class="string">            -Djava.security.egd=file:/dev/./urandom</span></span><br><span class="line"><span class="string"></span>        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;2Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;1000m&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Memory-Calculation-Strategy"><a href="#Memory-Calculation-Strategy" class="headerlink" title="Memory Calculation Strategy"></a>Memory Calculation Strategy</h3><pre>
<code class="mermaid">
graph TD
CONTAINER[Container Memory Limit: 2Gi] --&gt; JVM[JVM Heap: ~75% &#x3D; 1.5Gi]
CONTAINER --&gt; NONHEAP[Non-Heap: ~20% &#x3D; 400Mi]
CONTAINER --&gt; OS[OS&#x2F;Buffer: ~5% &#x3D; 100Mi]

JVM --&gt; HEAP_YOUNG[Young Generation]
JVM --&gt; HEAP_OLD[Old Generation]

NONHEAP --&gt; METASPACE[Metaspace]
NONHEAP --&gt; CODECACHE[Code Cache]
NONHEAP --&gt; STACK[Thread Stacks]
</code>
</pre>

<h3 id="Advanced-JVM-Configuration"><a href="#Advanced-JVM-Configuration" class="headerlink" title="Advanced JVM Configuration"></a>Advanced JVM Configuration</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">11</span>-jre-slim</span><br><span class="line"></span><br><span class="line"><span class="comment"># JVM tuning for containers</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_OPTS=<span class="string">&quot;-server \</span></span><br><span class="line"><span class="string">    -XX:+UseContainerSupport \</span></span><br><span class="line"><span class="string">    -XX:MaxRAMPercentage=75.0 \</span></span><br><span class="line"><span class="string">    -XX:InitialRAMPercentage=50.0 \</span></span><br><span class="line"><span class="string">    -XX:+UseG1GC \</span></span><br><span class="line"><span class="string">    -XX:MaxGCPauseMillis=200 \</span></span><br><span class="line"><span class="string">    -XX:+UseStringDeduplication \</span></span><br><span class="line"><span class="string">    -XX:+OptimizeStringConcat \</span></span><br><span class="line"><span class="string">    -XX:+UseCompressedOops \</span></span><br><span class="line"><span class="string">    -XX:+UseCompressedClassPointers \</span></span><br><span class="line"><span class="string">    -Djava.security.egd=file:/dev/./urandom \</span></span><br><span class="line"><span class="string">    -Dfile.encoding=UTF-8 \</span></span><br><span class="line"><span class="string">    -Duser.timezone=UTC&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> app.jar /app/app.jar</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;java <span class="variable">$JAVA_OPTS</span> -jar /app/app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h3 id="Resource-Monitoring"><a href="#Resource-Monitoring" class="headerlink" title="Resource Monitoring"></a>Resource Monitoring</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">prometheus.io/scrape:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">prometheus.io/path:</span> <span class="string">&quot;/actuator/prometheus&quot;</span></span><br><span class="line">    <span class="attr">prometheus.io/port:</span> <span class="string">&quot;8080&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">java-app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">my-java-app:1.0</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br></pre></td></tr></table></figure>

<h3 id="Vertical-Pod-Autoscaler-VPA-Configuration"><a href="#Vertical-Pod-Autoscaler-VPA-Configuration" class="headerlink" title="Vertical Pod Autoscaler (VPA) Configuration"></a>Vertical Pod Autoscaler (VPA) Configuration</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VerticalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app-vpa</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">targetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">java-app</span></span><br><span class="line">  <span class="attr">updatePolicy:</span></span><br><span class="line">    <span class="attr">updateMode:</span> <span class="string">&quot;Auto&quot;</span></span><br><span class="line">  <span class="attr">resourcePolicy:</span></span><br><span class="line">    <span class="attr">containerPolicies:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerName:</span> <span class="string">java-app</span></span><br><span class="line">      <span class="attr">maxAllowed:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">4Gi</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">2000m</span></span><br><span class="line">      <span class="attr">minAllowed:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">250m</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="How-do-you-implement-health-checks-for-Java-applications"><a href="#How-do-you-implement-health-checks-for-Java-applications" class="headerlink" title="How do you implement health checks for Java applications?"></a>How do you implement health checks for Java applications?</h2><h3 id="Reference-Answer-4"><a href="#Reference-Answer-4" class="headerlink" title="Reference Answer"></a>Reference Answer</h3><p>Health checks in Kubernetes use three types of probes to ensure application reliability and proper traffic routing.</p>
<h3 id="Probe-Types"><a href="#Probe-Types" class="headerlink" title="Probe Types"></a>Probe Types</h3><pre>
<code class="mermaid">
graph LR
subgraph &quot;Pod Lifecycle&quot;
    START[Pod Start] --&gt; STARTUP{Startup Probe}
    STARTUP --&gt;|Pass| READY{Readiness Probe}
    STARTUP --&gt;|Fail| RESTART[Restart Container]
    READY --&gt;|Pass| TRAFFIC[Receive Traffic]
    READY --&gt;|Fail| NO_TRAFFIC[No Traffic]
    TRAFFIC --&gt; LIVE{Liveness Probe}
    LIVE --&gt;|Pass| TRAFFIC
    LIVE --&gt;|Fail| RESTART
end
</code>
</pre>

<h3 id="Spring-Boot-Actuator-Health-Endpoints"><a href="#Spring-Boot-Actuator-Health-Endpoints" class="headerlink" title="Spring Boot Actuator Health Endpoints"></a>Spring Boot Actuator Health Endpoints</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HealthController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/health/live&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Map&lt;String, String&gt;&gt; <span class="title function_">liveness</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, String&gt; status = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        status.put(<span class="string">&quot;status&quot;</span>, <span class="string">&quot;UP&quot;</span>);</span><br><span class="line">        status.put(<span class="string">&quot;timestamp&quot;</span>, Instant.now().toString());</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(status);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/health/ready&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">readiness</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; health = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        health.put(<span class="string">&quot;status&quot;</span>, <span class="string">&quot;UP&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check database connectivity</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            dataSource.getConnection().close();</span><br><span class="line">            health.put(<span class="string">&quot;database&quot;</span>, <span class="string">&quot;UP&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            health.put(<span class="string">&quot;database&quot;</span>, <span class="string">&quot;DOWN&quot;</span>);</span><br><span class="line">            health.put(<span class="string">&quot;status&quot;</span>, <span class="string">&quot;DOWN&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.status(<span class="number">503</span>).body(health);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check external dependencies</span></span><br><span class="line">        health.put(<span class="string">&quot;externalAPI&quot;</span>, checkExternalAPI());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(health);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">checkExternalAPI</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Implementation to check external dependencies</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;UP&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Kubernetes-Deployment-with-Health-Checks"><a href="#Kubernetes-Deployment-with-Health-Checks" class="headerlink" title="Kubernetes Deployment with Health Checks"></a>Kubernetes Deployment with Health Checks</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">java-app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">my-java-app:1.0</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Startup probe for slow-starting applications</span></span><br><span class="line">        <span class="attr">startupProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/health/live</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">30</span>  <span class="comment"># 30 * 5 = 150s max startup time</span></span><br><span class="line">          </span><br><span class="line">        <span class="comment"># Liveness probe</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/health/live</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">3</span>   <span class="comment"># Restart after 3 consecutive failures</span></span><br><span class="line">          </span><br><span class="line">        <span class="comment"># Readiness probe</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/health/ready</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">3</span>   <span class="comment"># Remove from service after 3 failures</span></span><br></pre></td></tr></table></figure>

<h3 id="Custom-Health-Indicators"><a href="#Custom-Health-Indicators" class="headerlink" title="Custom Health Indicators"></a>Custom Health Indicators</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseHealthIndicator</span> <span class="keyword">implements</span> <span class="title class_">HealthIndicator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Health <span class="title function_">health</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection();</span><br><span class="line">            <span class="comment">// Perform a simple query</span></span><br><span class="line">            <span class="type">PreparedStatement</span> <span class="variable">statement</span> <span class="operator">=</span> connection.prepareStatement(<span class="string">&quot;SELECT 1&quot;</span>);</span><br><span class="line">            <span class="type">ResultSet</span> <span class="variable">resultSet</span> <span class="operator">=</span> statement.executeQuery();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (resultSet.next()) &#123;</span><br><span class="line">                <span class="keyword">return</span> Health.up()</span><br><span class="line">                    .withDetail(<span class="string">&quot;database&quot;</span>, <span class="string">&quot;Available&quot;</span>)</span><br><span class="line">                    .withDetail(<span class="string">&quot;connectionPool&quot;</span>, getConnectionPoolInfo())</span><br><span class="line">                    .build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> Health.down()</span><br><span class="line">                .withDetail(<span class="string">&quot;database&quot;</span>, <span class="string">&quot;Unavailable&quot;</span>)</span><br><span class="line">                .withDetail(<span class="string">&quot;error&quot;</span>, e.getMessage())</span><br><span class="line">                .build();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> Health.down().build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; <span class="title function_">getConnectionPoolInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Return connection pool metrics</span></span><br><span class="line">        Map&lt;String, Object&gt; poolInfo = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        poolInfo.put(<span class="string">&quot;active&quot;</span>, <span class="number">5</span>);</span><br><span class="line">        poolInfo.put(<span class="string">&quot;idle&quot;</span>, <span class="number">3</span>);</span><br><span class="line">        poolInfo.put(<span class="string">&quot;max&quot;</span>, <span class="number">10</span>);</span><br><span class="line">        <span class="keyword">return</span> poolInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Application-Properties-Configuration"><a href="#Application-Properties-Configuration" class="headerlink" title="Application Properties Configuration"></a>Application Properties Configuration</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Health endpoint configuration</span></span><br><span class="line"><span class="attr">management.endpoints.web.exposure.include</span>=<span class="string">health,info,metrics,prometheus</span></span><br><span class="line"><span class="attr">management.endpoint.health.show-details</span>=<span class="string">always</span></span><br><span class="line"><span class="attr">management.endpoint.health.show-components</span>=<span class="string">always</span></span><br><span class="line"><span class="attr">management.health.db.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">management.health.diskspace.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Custom health check paths</span></span><br><span class="line"><span class="attr">management.server.port</span>=<span class="string">8081</span></span><br><span class="line"><span class="attr">management.endpoints.web.base-path</span>=<span class="string">/actuator</span></span><br></pre></td></tr></table></figure>

<h3 id="TCP-and-Command-Probes"><a href="#TCP-and-Command-Probes" class="headerlink" title="TCP and Command Probes"></a>TCP and Command Probes</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TCP probe example</span></span><br><span class="line"><span class="attr">livenessProbe:</span></span><br><span class="line">  <span class="attr">tcpSocket:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">  <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Command probe example</span></span><br><span class="line"><span class="attr">livenessProbe:</span></span><br><span class="line">  <span class="attr">exec:</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;ps aux | grep java&quot;</span></span><br><span class="line">  <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">  <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Explain-how-to-handle-persistent-data-in-Java-applications-on-Kubernetes"><a href="#Explain-how-to-handle-persistent-data-in-Java-applications-on-Kubernetes" class="headerlink" title="Explain how to handle persistent data in Java applications on Kubernetes"></a>Explain how to handle persistent data in Java applications on Kubernetes</h2><h3 id="Reference-Answer-5"><a href="#Reference-Answer-5" class="headerlink" title="Reference Answer"></a>Reference Answer</h3><p>Persistent data in Kubernetes requires understanding storage abstractions and choosing appropriate patterns based on application requirements.</p>
<h3 id="Storage-Architecture"><a href="#Storage-Architecture" class="headerlink" title="Storage Architecture"></a>Storage Architecture</h3><pre>
<code class="mermaid">
graph TB
subgraph &quot;Storage Layer&quot;
    SC[StorageClass] --&gt; PV[PersistentVolume]
    PVC[PersistentVolumeClaim] --&gt; PV
end

subgraph &quot;Application Layer&quot;
    POD[Pod] --&gt; PVC
    STATEFULSET[StatefulSet] --&gt; PVC
    DEPLOYMENT[Deployment] --&gt; PVC
end

subgraph &quot;Physical Storage&quot;
    PV --&gt; DISK[Physical Disk]
    PV --&gt; NFS[NFS Server]
    PV --&gt; CLOUD[Cloud Storage]
end
</code>
</pre>

<h3 id="StorageClass-Definition"><a href="#StorageClass-Definition" class="headerlink" title="StorageClass Definition"></a>StorageClass Definition</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fast-ssd</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">kubernetes.io/aws-ebs</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">gp3</span></span><br><span class="line">  <span class="attr">fsType:</span> <span class="string">ext4</span></span><br><span class="line">  <span class="attr">encrypted:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Delete</span></span><br><span class="line"><span class="attr">allowVolumeExpansion:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">volumeBindingMode:</span> <span class="string">WaitForFirstConsumer</span></span><br></pre></td></tr></table></figure>

<h3 id="PersistentVolumeClaim"><a href="#PersistentVolumeClaim" class="headerlink" title="PersistentVolumeClaim"></a>PersistentVolumeClaim</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app-storage</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">fast-ssd</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">10Gi</span></span><br></pre></td></tr></table></figure>

<h3 id="Java-Application-with-File-Storage"><a href="#Java-Application-with-File-Storage" class="headerlink" title="Java Application with File Storage"></a>Java Application with File Storage</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-file-processor</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span>  <span class="comment"># Single replica for ReadWriteOnce</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">my-java-app:1.0</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app-storage</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/app/data</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">logs-storage</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/app/logs</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DATA_DIR</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;/app/data&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LOG_DIR</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;/app/logs&quot;</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app-storage</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">java-app-storage</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">logs-storage</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">java-app-logs</span></span><br></pre></td></tr></table></figure>

<h3 id="StatefulSet-for-Database-Applications"><a href="#StatefulSet-for-Database-Applications" class="headerlink" title="StatefulSet for Database Applications"></a>StatefulSet for Database Applications</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-database-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;java-db-service&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">my-java-db-app:1.0</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/app/data</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">data-volume</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteOnce&quot;</span>]</span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">&quot;fast-ssd&quot;</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">20Gi</span></span><br></pre></td></tr></table></figure>

<h3 id="Java-File-Processing-Example"><a href="#Java-File-Processing-Example" class="headerlink" title="Java File Processing Example"></a>Java File Processing Example</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileProcessingService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;app.data.dir:/app/data&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String dataDirectory;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Ensure data directory exists</span></span><br><span class="line">        <span class="type">Path</span> <span class="variable">dataPath</span> <span class="operator">=</span> Paths.get(dataDirectory);</span><br><span class="line">        <span class="keyword">if</span> (!Files.exists(dataPath)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Files.createDirectories(dataPath);</span><br><span class="line">                logger.info(<span class="string">&quot;Created data directory: &#123;&#125;&quot;</span>, dataPath);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;Failed to create data directory&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processFile</span><span class="params">(MultipartFile uploadedFile)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> UUID.randomUUID().toString() + <span class="string">&quot;_&quot;</span> + uploadedFile.getOriginalFilename();</span><br><span class="line">            <span class="type">Path</span> <span class="variable">filePath</span> <span class="operator">=</span> Paths.get(dataDirectory, filename);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Save uploaded file</span></span><br><span class="line">            uploadedFile.transferTo(filePath.toFile());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Process file</span></span><br><span class="line">            processFileContent(filePath);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Move to processed directory</span></span><br><span class="line">            <span class="type">Path</span> <span class="variable">processedDir</span> <span class="operator">=</span> Paths.get(dataDirectory, <span class="string">&quot;processed&quot;</span>);</span><br><span class="line">            Files.createDirectories(processedDir);</span><br><span class="line">            Files.move(filePath, processedDir.resolve(filename));</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;Error processing file&quot;</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileProcessingException</span>(<span class="string">&quot;Failed to process file&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processFileContent</span><span class="params">(Path filePath)</span> &#123;</span><br><span class="line">        <span class="comment">// File processing logic</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> Files.newBufferedReader(filePath)) &#123;</span><br><span class="line">            reader.lines()</span><br><span class="line">                .filter(line -&gt; !line.trim().isEmpty())</span><br><span class="line">                .forEach(<span class="built_in">this</span>::processLine);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;Error reading file: &quot;</span> + filePath, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Backup-Strategy-with-CronJob"><a href="#Backup-Strategy-with-CronJob" class="headerlink" title="Backup Strategy with CronJob"></a>Backup Strategy with CronJob</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">data-backup</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">schedule:</span> <span class="string">&quot;0 2 * * *&quot;</span>  <span class="comment"># Daily at 2 AM</span></span><br><span class="line">  <span class="attr">jobTemplate:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">containers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">backup</span></span><br><span class="line">            <span class="attr">image:</span> <span class="string">alpine:latest</span></span><br><span class="line">            <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">              apk add --no-cache tar gzip</span></span><br><span class="line"><span class="string">              DATE=$(date +%Y%m%d_%H%M%S)</span></span><br><span class="line"><span class="string">              tar -czf /backup/data_backup_$DATE.tar.gz -C /app/data .</span></span><br><span class="line"><span class="string">              # Keep only last 7 backups</span></span><br><span class="line"><span class="string">              find /backup -name &quot;data_backup_*.tar.gz&quot; -mtime +7 -delete</span></span><br><span class="line"><span class="string"></span>            <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app-data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/app/data</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">backup-storage</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/backup</span></span><br><span class="line">          <span class="attr">volumes:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app-data</span></span><br><span class="line">            <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">              <span class="attr">claimName:</span> <span class="string">java-app-storage</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">backup-storage</span></span><br><span class="line">            <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">              <span class="attr">claimName:</span> <span class="string">backup-storage</span></span><br><span class="line">          <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br></pre></td></tr></table></figure>

<h3 id="Database-Connection-with-Persistent-Storage"><a href="#Database-Connection-with-Persistent-Storage" class="headerlink" title="Database Connection with Persistent Storage"></a>Database Connection with Persistent Storage</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String databaseUrl;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">HikariConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HikariConfig</span>();</span><br><span class="line">        config.setJdbcUrl(databaseUrl);</span><br><span class="line">        config.setUsername(<span class="string">&quot;$&#123;DB_USERNAME&#125;&quot;</span>);</span><br><span class="line">        config.setPassword(<span class="string">&quot;$&#123;DB_PASSWORD&#125;&quot;</span>);</span><br><span class="line">        config.setMaximumPoolSize(<span class="number">20</span>);</span><br><span class="line">        config.setMinimumIdle(<span class="number">5</span>);</span><br><span class="line">        config.setConnectionTimeout(<span class="number">30000</span>);</span><br><span class="line">        config.setIdleTimeout(<span class="number">600000</span>);</span><br><span class="line">        config.setMaxLifetime(<span class="number">1800000</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HikariDataSource</span>(config);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PlatformTransactionManager <span class="title function_">transactionManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataSourceTransactionManager</span>(dataSource());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="How-do-you-implement-service-discovery-and-communication-between-Java-microservices"><a href="#How-do-you-implement-service-discovery-and-communication-between-Java-microservices" class="headerlink" title="How do you implement service discovery and communication between Java microservices?"></a>How do you implement service discovery and communication between Java microservices?</h2><h3 id="Reference-Answer-6"><a href="#Reference-Answer-6" class="headerlink" title="Reference Answer"></a>Reference Answer</h3><p>Kubernetes provides built-in service discovery through DNS, while Java applications can leverage Spring Cloud Kubernetes for enhanced integration.</p>
<h3 id="Service-Discovery-Architecture"><a href="#Service-Discovery-Architecture" class="headerlink" title="Service Discovery Architecture"></a>Service Discovery Architecture</h3><pre>
<code class="mermaid">
graph TB
subgraph &quot;Kubernetes Cluster&quot;
    subgraph &quot;Namespace: default&quot;
        SVC1[user-service]
        SVC2[order-service]
        SVC3[payment-service]
        
        POD1[User Service Pods]
        POD2[Order Service Pods]
        POD3[Payment Service Pods]
        
        SVC1 --&gt; POD1
        SVC2 --&gt; POD2
        SVC3 --&gt; POD3
    end
    
    DNS[CoreDNS] --&gt; SVC1
    DNS --&gt; SVC2
    DNS --&gt; SVC3
end

POD2 --&gt;|user-service.default.svc.cluster.local| POD1
POD2 --&gt;|payment-service.default.svc.cluster.local| POD3
</code>
</pre>

<h3 id="Service-Definitions"><a href="#Service-Definitions" class="headerlink" title="Service Definitions"></a>Service Definitions</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># User Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">user-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">user-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">user-service</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Order Service  </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">order-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">order-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">order-service</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Payment Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">payment-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">payment-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">payment-service</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br></pre></td></tr></table></figure>

<h3 id="Spring-Cloud-Kubernetes-Configuration"><a href="#Spring-Cloud-Kubernetes-Configuration" class="headerlink" title="Spring Cloud Kubernetes Configuration"></a>Spring Cloud Kubernetes Configuration</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-kubernetes-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Service-Discovery-Configuration"><a href="#Service-Discovery-Configuration" class="headerlink" title="Service Discovery Configuration"></a>Service Discovery Configuration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceDiscoveryConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="keyword">public</span> WebClient.Builder <span class="title function_">webClientBuilder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> WebClient.builder();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> WebClient <span class="title function_">webClient</span><span class="params">(WebClient.Builder builder)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> builder</span><br><span class="line">            .codecs(configurer -&gt; configurer.defaultCodecs().maxInMemorySize(<span class="number">1024</span> * <span class="number">1024</span>))</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Inter-Service-Communication"><a href="#Inter-Service-Communication" class="headerlink" title="Inter-Service Communication"></a>Inter-Service Communication</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WebClient webClient;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OrderService</span><span class="params">(WebClient webClient)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.webClient = webClient;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Mono&lt;UserDto&gt; <span class="title function_">getUserDetails</span><span class="params">(String userId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> webClient</span><br><span class="line">            .get()</span><br><span class="line">            .uri(<span class="string">&quot;http://user-service/api/users/&#123;userId&#125;&quot;</span>, userId)</span><br><span class="line">            .retrieve()</span><br><span class="line">            .onStatus(HttpStatus::isError, response -&gt; &#123;</span><br><span class="line">                <span class="keyword">return</span> Mono.error(<span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;User service error: &quot;</span> + response.statusCode()));</span><br><span class="line">            &#125;)</span><br><span class="line">            .bodyToMono(UserDto.class)</span><br><span class="line">            .timeout(Duration.ofSeconds(<span class="number">5</span>))</span><br><span class="line">            .retry(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Mono&lt;PaymentResponse&gt; <span class="title function_">processPayment</span><span class="params">(PaymentRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> webClient</span><br><span class="line">            .post()</span><br><span class="line">            .uri(<span class="string">&quot;http://payment-service/api/payments&quot;</span>)</span><br><span class="line">            .body(Mono.just(request), PaymentRequest.class)</span><br><span class="line">            .retrieve()</span><br><span class="line">            .bodyToMono(PaymentResponse.class)</span><br><span class="line">            .timeout(Duration.ofSeconds(<span class="number">10</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;OrderDto&gt; <span class="title function_">createOrder</span><span class="params">(CreateOrderRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getUserDetails(request.getUserId())</span><br><span class="line">            .flatMap(user -&gt; &#123;</span><br><span class="line">                <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Order</span>();</span><br><span class="line">                order.setUserId(user.getId());</span><br><span class="line">                order.setAmount(request.getAmount());</span><br><span class="line">                order.setStatus(OrderStatus.PENDING);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> Mono.fromCallable(() -&gt; orderRepository.save(order));</span><br><span class="line">            &#125;)</span><br><span class="line">            .flatMap(order -&gt; &#123;</span><br><span class="line">                <span class="type">PaymentRequest</span> <span class="variable">paymentRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PaymentRequest</span>();</span><br><span class="line">                paymentRequest.setOrderId(order.getId());</span><br><span class="line">                paymentRequest.setAmount(order.getAmount());</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> processPayment(paymentRequest)</span><br><span class="line">                    .map(paymentResponse -&gt; &#123;</span><br><span class="line">                        order.setStatus(paymentResponse.isSuccessful() ? </span><br><span class="line">                            OrderStatus.CONFIRMED : OrderStatus.FAILED);</span><br><span class="line">                        <span class="keyword">return</span> orderRepository.save(order);</span><br><span class="line">                    &#125;);</span><br><span class="line">            &#125;)</span><br><span class="line">            .map(<span class="built_in">this</span>::toOrderDto);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Circuit-Breaker-with-Resilience4j"><a href="#Circuit-Breaker-with-Resilience4j" class="headerlink" title="Circuit Breaker with Resilience4j"></a>Circuit Breaker with Resilience4j</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentServiceClient</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WebClient webClient;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CircuitBreaker circuitBreaker;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PaymentServiceClient</span><span class="params">(WebClient webClient)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.webClient = webClient;</span><br><span class="line">        <span class="built_in">this</span>.circuitBreaker = CircuitBreaker.ofDefaults(<span class="string">&quot;payment-service&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Mono&lt;PaymentResponse&gt; <span class="title function_">processPayment</span><span class="params">(PaymentRequest request)</span> &#123;</span><br><span class="line">        Supplier&lt;Mono&lt;PaymentResponse&gt;&gt; decoratedSupplier = CircuitBreaker</span><br><span class="line">            .decorateSupplier(circuitBreaker, () -&gt; &#123;</span><br><span class="line">                <span class="keyword">return</span> webClient</span><br><span class="line">                    .post()</span><br><span class="line">                    .uri(<span class="string">&quot;http://payment-service/api/payments&quot;</span>)</span><br><span class="line">                    .body(Mono.just(request), PaymentRequest.class)</span><br><span class="line">                    .retrieve()</span><br><span class="line">                    .bodyToMono(PaymentResponse.class)</span><br><span class="line">                    .timeout(Duration.ofSeconds(<span class="number">5</span>));</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> decoratedSupplier.get()</span><br><span class="line">            .onErrorResume(CallNotPermittedException.class, ex -&gt; &#123;</span><br><span class="line">                <span class="comment">// Circuit breaker is open</span></span><br><span class="line">                <span class="keyword">return</span> Mono.just(PaymentResponse.failed(<span class="string">&quot;Service temporarily unavailable&quot;</span>));</span><br><span class="line">            &#125;)</span><br><span class="line">            .onErrorResume(TimeoutException.class, ex -&gt; &#123;</span><br><span class="line">                <span class="keyword">return</span> Mono.just(PaymentResponse.failed(<span class="string">&quot;Payment service timeout&quot;</span>));</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Application-Properties"><a href="#Application-Properties" class="headerlink" title="Application Properties"></a>Application Properties</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">kubernetes:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">all-namespaces:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">wait-cache-ready:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">client:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">loadbalancer:</span></span><br><span class="line">      <span class="attr">ribbon:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">resilience4j:</span></span><br><span class="line">  <span class="attr">circuitbreaker:</span></span><br><span class="line">    <span class="attr">instances:</span></span><br><span class="line">      <span class="attr">payment-service:</span></span><br><span class="line">        <span class="attr">registerHealthIndicator:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">slidingWindowSize:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">minimumNumberOfCalls:</span> <span class="number">3</span></span><br><span class="line">        <span class="attr">failureRateThreshold:</span> <span class="number">50</span></span><br><span class="line">        <span class="attr">waitDurationInOpenState:</span> <span class="string">10s</span></span><br><span class="line">        <span class="attr">permittedNumberOfCallsInHalfOpenState:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">retry:</span></span><br><span class="line">    <span class="attr">instances:</span></span><br><span class="line">      <span class="attr">payment-service:</span></span><br><span class="line">        <span class="attr">maxAttempts:</span> <span class="number">3</span></span><br><span class="line">        <span class="attr">waitDuration:</span> <span class="string">1s</span></span><br><span class="line">        <span class="attr">exponentialBackoffMultiplier:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">timelimiter:</span></span><br><span class="line">    <span class="attr">instances:</span></span><br><span class="line">      <span class="attr">payment-service:</span></span><br><span class="line">        <span class="attr">timeoutDuration:</span> <span class="string">5s</span></span><br></pre></td></tr></table></figure>

<h3 id="Service-Mesh-Integration-Istio"><a href="#Service-Mesh-Integration-Istio" class="headerlink" title="Service Mesh Integration (Istio)"></a>Service Mesh Integration (Istio)</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">payment-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">payment-service</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">/api/payments</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">payment-service</span></span><br><span class="line">        <span class="attr">port:</span></span><br><span class="line">          <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">    <span class="attr">retries:</span></span><br><span class="line">      <span class="attr">attempts:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">perTryTimeout:</span> <span class="string">3s</span></span><br><span class="line">      <span class="attr">retryOn:</span> <span class="string">5xx,reset,connect-failure,refused-stream</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">payment-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">payment-service</span></span><br><span class="line">  <span class="attr">trafficPolicy:</span></span><br><span class="line">    <span class="attr">loadBalancer:</span></span><br><span class="line">      <span class="attr">simple:</span> <span class="string">LEAST_CONN</span></span><br><span class="line">    <span class="attr">connectionPool:</span></span><br><span class="line">      <span class="attr">tcp:</span></span><br><span class="line">        <span class="attr">maxConnections:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">http1MaxPendingRequests:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">maxRequestsPerConnection:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">circuitBreaker:</span></span><br><span class="line">      <span class="attr">consecutiveErrors:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">baseEjectionTime:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">maxEjectionPercent:</span> <span class="number">50</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Describe-different-deployment-strategies-in-Kubernetes"><a href="#Describe-different-deployment-strategies-in-Kubernetes" class="headerlink" title="Describe different deployment strategies in Kubernetes"></a>Describe different deployment strategies in Kubernetes</h2><h3 id="Reference-Answer-7"><a href="#Reference-Answer-7" class="headerlink" title="Reference Answer"></a>Reference Answer</h3><p>Kubernetes supports various deployment strategies to minimize downtime and reduce risk during application updates.</p>
<h3 id="Deployment-Strategies-Overview"><a href="#Deployment-Strategies-Overview" class="headerlink" title="Deployment Strategies Overview"></a>Deployment Strategies Overview</h3><pre>
<code class="mermaid">
graph TB
subgraph &quot;Rolling Update&quot;
    RU1[v1 Pod] --&gt; RU2[v1 Pod]
    RU2 --&gt; RU3[v1 Pod]
    RU4[v2 Pod] --&gt; RU5[v2 Pod]
    RU5 --&gt; RU6[v2 Pod]
end

subgraph &quot;Blue-Green&quot;
    BG1[Blue Environment&lt;br&#x2F;&gt;v1 Pods] 
    BG2[Green Environment&lt;br&#x2F;&gt;v2 Pods]
    LB[Load Balancer] --&gt; BG1
    LB -.-&gt; BG2
end

subgraph &quot;Canary&quot;
    C1[v1 Pods - 90%]
    C2[v2 Pods - 10%]
    CLB[Load Balancer] --&gt; C1
    CLB --&gt; C2
end
</code>
</pre>

<h3 id="Rolling-Update-Default-Strategy"><a href="#Rolling-Update-Default-Strategy" class="headerlink" title="Rolling Update (Default Strategy)"></a>Rolling Update (Default Strategy)</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app-rolling</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">6</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">1</span>      <span class="comment"># Max pods that can be unavailable</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">2</span>           <span class="comment"># Max pods that can be created above desired replica count</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">java-app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">my-java-app:v2</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/health/ready</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/health/live</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<h3 id="Blue-Green-Deployment"><a href="#Blue-Green-Deployment" class="headerlink" title="Blue-Green Deployment"></a>Blue-Green Deployment</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Blue deployment (current version)</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app-blue</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">blue</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">java-app</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">blue</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">java-app</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">blue</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">java-app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">my-java-app:v1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Green deployment (new version)</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app-green</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">green</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">java-app</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">green</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">java-app</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">green</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">java-app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">my-java-app:v2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Service pointing to blue (active) version</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">java-app</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">blue</span>  <span class="comment"># Switch to &#x27;green&#x27; when ready</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<h3 id="Canary-Deployment-with-Istio"><a href="#Canary-Deployment-with-Istio" class="headerlink" title="Canary Deployment with Istio"></a>Canary Deployment with Istio</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Primary deployment (90% traffic)</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app-primary</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">9</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">java-app</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">primary</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">java-app</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">primary</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">java-app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">my-java-app:v1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Canary deployment (10% traffic)</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app-canary</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">java-app</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">canary</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">java-app</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">canary</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">java-app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">my-java-app:v2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># VirtualService for traffic splitting</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">java-app</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">headers:</span></span><br><span class="line">        <span class="attr">canary:</span></span><br><span class="line">          <span class="attr">exact:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">java-app</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">canary</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">java-app</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">primary</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">90</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">java-app</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">canary</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># DestinationRule defining subsets</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">java-app</span></span><br><span class="line">  <span class="attr">subsets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">primary</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">primary</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">canary</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">canary</span></span><br></pre></td></tr></table></figure>

<h3 id="Recreate-Strategy"><a href="#Recreate-Strategy" class="headerlink" title="Recreate Strategy"></a>Recreate Strategy</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app-recreate</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span>  <span class="comment"># Terminates all old pods before creating new ones</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">java-app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">my-java-app:v2</span></span><br></pre></td></tr></table></figure>

<h3 id="Deployment-Automation-Script"><a href="#Deployment-Automation-Script" class="headerlink" title="Deployment Automation Script"></a>Deployment Automation Script</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">DEPLOYMENT_NAME=<span class="string">&quot;java-app&quot;</span></span><br><span class="line">NEW_IMAGE=<span class="string">&quot;my-java-app:v2&quot;</span></span><br><span class="line">NAMESPACE=<span class="string">&quot;default&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Rolling update</span></span><br><span class="line">kubectl <span class="built_in">set</span> image deployment/<span class="variable">$DEPLOYMENT_NAME</span> java-app=<span class="variable">$NEW_IMAGE</span> -n <span class="variable">$NAMESPACE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Wait for rollout to complete</span></span><br><span class="line">kubectl rollout status deployment/<span class="variable">$DEPLOYMENT_NAME</span> -n <span class="variable">$NAMESPACE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Check if rollout was successful</span></span><br><span class="line"><span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Deployment successful&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Optional: Run smoke tests</span></span><br><span class="line">    kubectl run smoke-test --<span class="built_in">rm</span> -i --restart=Never --image=curlimages/curl -- \</span><br><span class="line">        curl -f http://java-app-service/health/ready</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Smoke tests passed&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Smoke tests failed, rolling back&quot;</span></span><br><span class="line">        kubectl rollout undo deployment/<span class="variable">$DEPLOYMENT_NAME</span> -n <span class="variable">$NAMESPACE</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Deployment failed, rolling back&quot;</span></span><br><span class="line">    kubectl rollout undo deployment/<span class="variable">$DEPLOYMENT_NAME</span> -n <span class="variable">$NAMESPACE</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h3 id="Spring-Boot-Graceful-Shutdown"><a href="#Spring-Boot-Graceful-Shutdown" class="headerlink" title="Spring Boot Graceful Shutdown"></a>Spring Boot Graceful Shutdown</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GracefulShutdownHook</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(GracefulShutdownHook.class);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(ContextClosedEvent event)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;Received shutdown signal, starting graceful shutdown...&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Allow ongoing requests to complete</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">5000</span>); <span class="comment">// Grace period</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">&quot;Graceful shutdown completed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.properties</span></span><br><span class="line"><span class="attr">server.shutdown</span>=<span class="string">graceful</span></span><br><span class="line"><span class="attr">spring.lifecycle.timeout-per-shutdown-phase</span>=<span class="string">30s</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="How-do-you-handle-logging-and-monitoring-for-Java-applications-in-Kubernetes"><a href="#How-do-you-handle-logging-and-monitoring-for-Java-applications-in-Kubernetes" class="headerlink" title="How do you handle logging and monitoring for Java applications in Kubernetes?"></a>How do you handle logging and monitoring for Java applications in Kubernetes?</h2><h3 id="Reference-Answer-8"><a href="#Reference-Answer-8" class="headerlink" title="Reference Answer"></a>Reference Answer</h3><p>Comprehensive logging and monitoring in Kubernetes requires centralized log aggregation, metrics collection, and distributed tracing.</p>
<h3 id="Logging-Architecture"><a href="#Logging-Architecture" class="headerlink" title="Logging Architecture"></a>Logging Architecture</h3><pre>
<code class="mermaid">
graph TB
subgraph &quot;Kubernetes Cluster&quot;
    subgraph &quot;Application Pods&quot;
        APP1[Java App 1] --&gt; LOGS1[stdout&#x2F;stderr]
        APP2[Java App 2] --&gt; LOGS2[stdout&#x2F;stderr]
        APP3[Java App 3] --&gt; LOGS3[stdout&#x2F;stderr]
    end
    
    subgraph &quot;Log Collection&quot;
        FLUENTD[Fluentd DaemonSet]
        LOGS1 --&gt; FLUENTD
        LOGS2 --&gt; FLUENTD
        LOGS3 --&gt; FLUENTD
    end
    
    subgraph &quot;Monitoring&quot;
        PROMETHEUS[Prometheus]
        APP1 --&gt; PROMETHEUS
        APP2 --&gt; PROMETHEUS
        APP3 --&gt; PROMETHEUS
    end
end

subgraph &quot;External Systems&quot;
    FLUENTD --&gt; ELASTICSEARCH[Elasticsearch]
    ELASTICSEARCH --&gt; KIBANA[Kibana]
    PROMETHEUS --&gt; GRAFANA[Grafana]
end
</code>
</pre>

<h3 id="Structured-Logging-Configuration"><a href="#Structured-Logging-Configuration" class="headerlink" title="Structured Logging Configuration"></a>Structured Logging Configuration</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- logback-spring.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">&quot;!local&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;STDOUT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">class</span>=<span class="string">&quot;net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">providers</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">timestamp</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">logLevel</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">loggerName</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">message</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">mdc</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">arguments</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">stackTrace</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">pattern</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">pattern</span>&gt;</span></span><br><span class="line">                            &#123;</span><br><span class="line">                                &quot;service&quot;: &quot;java-app&quot;,</span><br><span class="line">                                &quot;version&quot;: &quot;$&#123;APP_VERSION:-unknown&#125;&quot;,</span><br><span class="line">                                &quot;pod&quot;: &quot;$&#123;HOSTNAME:-unknown&#125;&quot;,</span><br><span class="line">                                &quot;namespace&quot;: &quot;$&#123;POD_NAMESPACE:-default&#125;&quot;</span><br><span class="line">                            &#125;</span><br><span class="line">                        <span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">providers</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">&quot;local&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;STDOUT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;36&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;com.example&quot;</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;org.springframework.web&quot;</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Application-Logging-Code"><a href="#Application-Logging-Code" class="headerlink" title="Application Logging Code"></a>Application Logging Code</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/orders&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;OrderDto&gt; <span class="title function_">createOrder</span><span class="params">(<span class="meta">@RequestBody</span> CreateOrderRequest request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">correlationId</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Add correlation ID to MDC for request tracing</span></span><br><span class="line">        MDC.put(<span class="string">&quot;correlationId&quot;</span>, correlationId);</span><br><span class="line">        MDC.put(<span class="string">&quot;operation&quot;</span>, <span class="string">&quot;createOrder&quot;</span>);</span><br><span class="line">        MDC.put(<span class="string">&quot;userId&quot;</span>, request.getUserId());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Creating order for user: &#123;&#125;&quot;</span>, request.getUserId());</span><br><span class="line">            </span><br><span class="line">            <span class="type">OrderDto</span> <span class="variable">order</span> <span class="operator">=</span> orderService.createOrder(request);</span><br><span class="line">            </span><br><span class="line">            log.info(<span class="string">&quot;Order created successfully: orderId=&#123;&#125;, amount=&#123;&#125;&quot;</span>, </span><br><span class="line">                order.getId(), order.getAmount());</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.ok(order);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Failed to create order: &#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            MDC.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Fluentd-Configuration"><a href="#Fluentd-Configuration" class="headerlink" title="Fluentd Configuration"></a>Fluentd Configuration</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluentd-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">fluent.conf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &lt;source&gt;</span></span><br><span class="line"><span class="string">      @type tail</span></span><br><span class="line"><span class="string">      path /var/log/containers/*java-app*.log</span></span><br><span class="line"><span class="string">      pos_file /var/log/fluentd-containers.log.pos</span></span><br><span class="line"><span class="string">      tag kubernetes.*</span></span><br><span class="line"><span class="string">      format json</span></span><br><span class="line"><span class="string">      read_from_head true</span></span><br><span class="line"><span class="string">    &lt;/source&gt;</span></span><br><span class="line"><span class="string"></span>    </span><br><span class="line">    <span class="string">&lt;filter</span> <span class="string">kubernetes.**&gt;</span></span><br><span class="line">      <span class="string">@type</span> <span class="string">kubernetes_metadata</span></span><br><span class="line">    <span class="string">&lt;/filter&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="string">&lt;filter</span> <span class="string">kubernetes.**&gt;</span></span><br><span class="line">      <span class="string">@type</span> <span class="string">parser</span></span><br><span class="line">      <span class="string">key_name</span> <span class="string">log</span></span><br><span class="line">      <span class="string">reserve_data</span> <span class="literal">true</span></span><br><span class="line">      <span class="string">&lt;parse&gt;</span></span><br><span class="line">        <span class="string">@type</span> <span class="string">json</span></span><br><span class="line">      <span class="string">&lt;/parse&gt;</span></span><br><span class="line">    <span class="string">&lt;/filter&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="string">&lt;match</span> <span class="string">kubernetes.**&gt;</span></span><br><span class="line">      <span class="string">@type</span> <span class="string">elasticsearch</span></span><br><span class="line">      <span class="string">host</span> <span class="string">elasticsearch.logging.svc.cluster.local</span></span><br><span class="line">      <span class="string">port</span> <span class="number">9200</span></span><br><span class="line">      <span class="string">index_name</span> <span class="string">kubernetes</span></span><br><span class="line">      <span class="string">type_name</span> <span class="string">_doc</span></span><br><span class="line">      <span class="string">&lt;buffer&gt;</span></span><br><span class="line">        <span class="string">@type</span> <span class="string">file</span></span><br><span class="line">        <span class="string">path</span> <span class="string">/var/log/fluentd-buffers/kubernetes.system.buffer</span></span><br><span class="line">        <span class="string">flush_mode</span> <span class="string">interval</span></span><br><span class="line">        <span class="string">retry_type</span> <span class="string">exponential_backoff</span></span><br><span class="line">        <span class="string">flush_thread_count</span> <span class="number">2</span></span><br><span class="line">        <span class="string">flush_interval</span> <span class="string">5s</span></span><br><span class="line">        <span class="string">retry_forever</span></span><br><span class="line">        <span class="string">retry_max_interval</span> <span class="number">30</span></span><br><span class="line">        <span class="string">chunk_limit_size</span> <span class="string">2M</span></span><br><span class="line">        <span class="string">queue_limit_length</span> <span class="number">8</span></span><br><span class="line">        <span class="string">overflow_action</span> <span class="string">block</span></span><br><span class="line">      <span class="string">&lt;/buffer&gt;</span></span><br><span class="line">    <span class="string">&lt;/match&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluentd</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">fluentd</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">fluentd</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fluentd</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">fluent/fluentd-kubernetes-daemonset:v1.14-debian-elasticsearch7-1</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/log</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlibdockercontainers</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/fluentd/etc</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/log</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlibdockercontainers</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">fluentd-config</span></span><br></pre></td></tr></table></figure>

<h3 id="Prometheus-Metrics-with-Micrometer"><a href="#Prometheus-Metrics-with-Micrometer" class="headerlink" title="Prometheus Metrics with Micrometer"></a>Prometheus Metrics with Micrometer</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MetricsConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MeterRegistryCustomizer&lt;MeterRegistry&gt; <span class="title function_">metricsCommonTags</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> registry -&gt; registry.config().commonTags(</span><br><span class="line">            <span class="string">&quot;application&quot;</span>, <span class="string">&quot;java-app&quot;</span>,</span><br><span class="line">            <span class="string">&quot;version&quot;</span>, System.getProperty(<span class="string">&quot;app.version&quot;</span>, <span class="string">&quot;unknown&quot;</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TimedAspect <span class="title function_">timedAspect</span><span class="params">(MeterRegistry registry)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TimedAspect</span>(registry);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter orderCreatedCounter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Timer orderProcessingTimer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Gauge activeOrdersGauge;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OrderService</span><span class="params">(MeterRegistry meterRegistry)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.orderCreatedCounter = Counter.builder(<span class="string">&quot;orders.created&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Number of orders created&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.orderProcessingTimer = Timer.builder(<span class="string">&quot;orders.processing.time&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Order processing time&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.activeOrdersGauge = Gauge.builder(<span class="string">&quot;orders.active&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Number of active orders&quot;</span>)</span><br><span class="line">            .register(meterRegistry, <span class="built_in">this</span>, OrderService::getActiveOrderCount);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Timed(name = &quot;orders.create&quot;, description = &quot;Create order operation&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> OrderDto <span class="title function_">createOrder</span><span class="params">(CreateOrderRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Timer.Sample.start(orderProcessingTimer)</span><br><span class="line">            .stop(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// Order creation logic</span></span><br><span class="line">                    <span class="type">OrderDto</span> <span class="variable">order</span> <span class="operator">=</span> processOrder(request);</span><br><span class="line">                    orderCreatedCounter.increment(Tags.of(<span class="string">&quot;status&quot;</span>, <span class="string">&quot;success&quot;</span>));</span><br><span class="line">                    <span class="keyword">return</span> order;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    orderCreatedCounter.increment(Tags.of(<span class="string">&quot;status&quot;</span>, <span class="string">&quot;error&quot;</span>));</span><br><span class="line">                    <span class="keyword">throw</span> e;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">getActiveOrderCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Return current active order count</span></span><br><span class="line">        <span class="keyword">return</span> orderRepository.countByStatus(OrderStatus.ACTIVE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Deployment-with-Monitoring-Annotations"><a href="#Deployment-with-Monitoring-Annotations" class="headerlink" title="Deployment with Monitoring Annotations"></a>Deployment with Monitoring Annotations</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">prometheus.io/scrape:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="attr">prometheus.io/path:</span> <span class="string">&quot;/actuator/prometheus&quot;</span></span><br><span class="line">        <span class="attr">prometheus.io/port:</span> <span class="string">&quot;8080&quot;</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">java-app</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">java-app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">my-java-app:1.0</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOSTNAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">APP_VERSION</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;1.0&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Distributed-Tracing-with-Jaeger"><a href="#Distributed-Tracing-with-Jaeger" class="headerlink" title="Distributed Tracing with Jaeger"></a>Distributed Tracing with Jaeger</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.opentracing.contrib<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>opentracing-spring-jaeger-cloud-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Tracer tracer;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/orders&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;OrderDto&gt; <span class="title function_">createOrder</span><span class="params">(<span class="meta">@RequestBody</span> CreateOrderRequest request)</span> &#123;</span><br><span class="line">        <span class="type">Span</span> <span class="variable">span</span> <span class="operator">=</span> tracer.nextSpan()</span><br><span class="line">            .name(<span class="string">&quot;create-order&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;user.id&quot;</span>, request.getUserId())</span><br><span class="line">            .tag(<span class="string">&quot;order.amount&quot;</span>, String.valueOf(request.getAmount()))</span><br><span class="line">            .start();</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">try</span> (Tracer.<span class="type">SpanInScope</span> <span class="variable">ws</span> <span class="operator">=</span> tracer.withSpanInScope(span)) &#123;</span><br><span class="line">            <span class="type">OrderDto</span> <span class="variable">order</span> <span class="operator">=</span> orderService.createOrder(request);</span><br><span class="line">            span.tag(<span class="string">&quot;order.id&quot;</span>, order.getId());</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.ok(order);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            span.tag(<span class="string">&quot;error&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">            span.tag(<span class="string">&quot;error.message&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            span.end();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Application-Properties-for-Monitoring"><a href="#Application-Properties-for-Monitoring" class="headerlink" title="Application Properties for Monitoring"></a>Application Properties for Monitoring</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">health,info,metrics,prometheus,loggers</span></span><br><span class="line">  <span class="attr">endpoint:</span></span><br><span class="line">    <span class="attr">health:</span></span><br><span class="line">      <span class="attr">show-details:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">metrics:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line">    <span class="attr">export:</span></span><br><span class="line">      <span class="attr">prometheus:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">distribution:</span></span><br><span class="line">      <span class="attr">percentiles-histogram:</span></span><br><span class="line">        <span class="attr">http.server.requests:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">percentiles:</span></span><br><span class="line">        <span class="attr">http.server.requests:</span> <span class="number">0.5</span><span class="string">,</span> <span class="number">0.95</span><span class="string">,</span> <span class="number">0.99</span></span><br><span class="line">      <span class="attr">sla:</span></span><br><span class="line">        <span class="attr">http.server.requests:</span> <span class="string">100ms,</span> <span class="string">200ms,</span> <span class="string">500ms</span></span><br><span class="line"></span><br><span class="line"><span class="attr">opentracing:</span></span><br><span class="line">  <span class="attr">jaeger:</span></span><br><span class="line">    <span class="attr">service-name:</span> <span class="string">java-app</span></span><br><span class="line">    <span class="attr">sampler:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">const</span></span><br><span class="line">      <span class="attr">param:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">log-spans:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">io.jaeger:</span> <span class="string">INFO</span></span><br><span class="line">    <span class="attr">io.opentracing:</span> <span class="string">INFO</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="What-are-the-security-considerations-for-Java-applications-in-Kubernetes"><a href="#What-are-the-security-considerations-for-Java-applications-in-Kubernetes" class="headerlink" title="What are the security considerations for Java applications in Kubernetes?"></a>What are the security considerations for Java applications in Kubernetes?</h2><h3 id="Reference-Answer-9"><a href="#Reference-Answer-9" class="headerlink" title="Reference Answer"></a>Reference Answer</h3><p>Security in Kubernetes requires a multi-layered approach covering container security, network policies, RBAC, and secure configuration management.</p>
<h3 id="Security-Architecture"><a href="#Security-Architecture" class="headerlink" title="Security Architecture"></a>Security Architecture</h3><pre>
<code class="mermaid">
graph TB
subgraph &quot;Cluster Security&quot;
    RBAC[RBAC] --&gt; API[API Server]
    PSP[Pod Security Standards] --&gt; PODS[Pods]
    NP[Network Policies] --&gt; NETWORK[Pod Network]
end

subgraph &quot;Pod Security&quot;
    SECCTX[Security Context] --&gt; CONTAINER[Container]
    SECRETS[Secrets] --&gt; CONTAINER
    SA[Service Account] --&gt; CONTAINER
end

subgraph &quot;Image Security&quot;
    SCAN[Image Scanning] --&gt; REGISTRY[Container Registry]
    SIGN[Image Signing] --&gt; REGISTRY
end
</code>
</pre>

<h3 id="Pod-Security-Context"><a href="#Pod-Security-Context" class="headerlink" title="Pod Security Context"></a>Pod Security Context</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secure-java-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="comment"># Pod-level security context</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">runAsUser:</span> <span class="number">1000</span></span><br><span class="line">        <span class="attr">runAsGroup:</span> <span class="number">3000</span></span><br><span class="line">        <span class="attr">fsGroup:</span> <span class="number">2000</span></span><br><span class="line">        <span class="attr">seccompProfile:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">RuntimeDefault</span></span><br><span class="line">      </span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">java-app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">my-java-app:1.0</span></span><br><span class="line">        <span class="comment"># Container-level security context</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">runAsUser:</span> <span class="number">1000</span></span><br><span class="line">          <span class="attr">capabilities:</span></span><br><span class="line">            <span class="attr">drop:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line">            <span class="attr">add:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">NET_BIND_SERVICE</span>  <span class="comment"># Only if needed for port &lt; 1024</span></span><br><span class="line">        </span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tmp-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cache-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/app/cache</span></span><br><span class="line">        </span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;512Mi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line">      </span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tmp-volume</span></span><br><span class="line">        <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cache-volume</span></span><br><span class="line">        <span class="attr">emptyDir:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Secure-Dockerfile"><a href="#Secure-Dockerfile" class="headerlink" title="Secure Dockerfile"></a>Secure Dockerfile</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">11</span>-jre-slim</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create non-root user</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> groupadd -r appgroup &amp;&amp; useradd -r -g appgroup -u 1000 appuser</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create app directory</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> -p /app/logs /app/cache &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">chown</span> -R appuser:appgroup /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy application</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --<span class="built_in">chown</span>=appuser:appgroup target/app.jar /app/app.jar</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Switch to non-root user</span></span><br><span class="line"><span class="keyword">USER</span> appuser</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Expose port</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Health check</span></span><br><span class="line"><span class="keyword">HEALTHCHECK</span><span class="language-bash"> --interval=30s --<span class="built_in">timeout</span>=3s --start-period=5s --retries=3 \</span></span><br><span class="line"><span class="language-bash">  CMD curl -f http://localhost:8080/actuator/health || <span class="built_in">exit</span> 1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-jar&quot;</span>, <span class="string">&quot;app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h3 id="Network-Policies"><a href="#Network-Policies" class="headerlink" title="Network Policies"></a>Network Policies</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Deny all ingress traffic by default</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default-deny-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Allow specific ingress traffic to Java app</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">java-app</span></span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">  <span class="comment"># Allow traffic from ingress controller</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">namespaceSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="comment"># Allow traffic from same namespace</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">podSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">app:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">egress:</span></span><br><span class="line">  <span class="comment"># Allow DNS resolution</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span> []</span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">UDP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">53</span></span><br><span class="line">  <span class="comment"># Allow database access</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">podSelector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">app:</span> <span class="string">database</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">5432</span></span><br><span class="line">  <span class="comment"># Allow external API calls</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span> []</span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">443</span></span><br></pre></td></tr></table></figure>

<h3 id="RBAC-Configuration"><a href="#RBAC-Configuration" class="headerlink" title="RBAC Configuration"></a>RBAC Configuration</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Service Account</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app-sa</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Role with minimal permissions</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app-role</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;configmaps&quot;</span>, <span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Role Binding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app-binding</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app-sa</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app-role</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Deployment using Service Account</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">java-app-sa</span></span><br><span class="line">      <span class="attr">automountServiceAccountToken:</span> <span class="literal">false</span>  <span class="comment"># Disable if not needed</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">java-app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">my-java-app:1.0</span></span><br></pre></td></tr></table></figure>

<h3 id="Secrets-Management"><a href="#Secrets-Management" class="headerlink" title="Secrets Management"></a>Secrets Management</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create secret from command line (better than YAML)</span></span><br><span class="line"><span class="comment"># kubectl create secret generic db-credentials \</span></span><br><span class="line"><span class="comment">#   --from-literal=username=dbuser \</span></span><br><span class="line"><span class="comment">#   --from-literal=password=securepassword</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">db-credentials</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">ZGJ1c2Vy</span>        <span class="comment"># base64 encoded</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">c2VjdXJlcGFzc3dvcmQ=</span>  <span class="comment"># base64 encoded</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">java-app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">my-java-app:1.0</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_USERNAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">db-credentials</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">username</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_PASSWORD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">db-credentials</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">password</span></span><br><span class="line">        <span class="comment"># Or mount as files</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">db-credentials</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/secrets</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">db-credentials</span></span><br><span class="line">        <span class="attr">secret:</span></span><br><span class="line">          <span class="attr">secretName:</span> <span class="string">db-credentials</span></span><br><span class="line">          <span class="attr">defaultMode:</span> <span class="number">0400</span>  <span class="comment"># Read-only for owner</span></span><br></pre></td></tr></table></figure>

<h3 id="Pod-Security-Standards"><a href="#Pod-Security-Standards" class="headerlink" title="Pod Security Standards"></a>Pod Security Standards</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secure-namespace</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">pod-security.kubernetes.io/enforce:</span> <span class="string">restricted</span></span><br><span class="line">    <span class="attr">pod-security.kubernetes.io/audit:</span> <span class="string">restricted</span></span><br><span class="line">    <span class="attr">pod-security.kubernetes.io/warn:</span> <span class="string">restricted</span></span><br></pre></td></tr></table></figure>

<h3 id="Security-Configuration-in-Java"><a href="#Security-Configuration-in-Java" class="headerlink" title="Security Configuration in Java"></a>Security Configuration in Java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityFilterChain <span class="title function_">filterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">            .sessionManagement()</span><br><span class="line">                .sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span><br><span class="line">            .and()</span><br><span class="line">            .headers()</span><br><span class="line">                .frameOptions().deny()</span><br><span class="line">                .contentTypeOptions()</span><br><span class="line">                .and()</span><br><span class="line">                .httpStrictTransportSecurity(hstsConfig -&gt; hstsConfig</span><br><span class="line">                    .maxAgeInSeconds(<span class="number">31536000</span>)</span><br><span class="line">                    .includeSubdomains(<span class="literal">true</span>))</span><br><span class="line">            .and()</span><br><span class="line">            .csrf().disable()</span><br><span class="line">            .authorizeHttpRequests(authz -&gt; authz</span><br><span class="line">                .requestMatchers(<span class="string">&quot;/actuator/health&quot;</span>, <span class="string">&quot;/actuator/info&quot;</span>).permitAll()</span><br><span class="line">                .requestMatchers(<span class="string">&quot;/actuator/**&quot;</span>).hasRole(<span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">            )</span><br><span class="line">            .oauth2ResourceServer(OAuth2ResourceServerConfigurer::jwt);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecureController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/secure-endpoint&quot;)</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasRole(&#x27;USER&#x27;)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title function_">secureEndpoint</span><span class="params">(Authentication authentication)</span> &#123;</span><br><span class="line">        <span class="comment">// Log access attempt</span></span><br><span class="line">        log.info(<span class="string">&quot;Secure endpoint accessed by: &#123;&#125;&quot;</span>, authentication.getName());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(<span class="string">&quot;Secure data&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Image-Scanning-with-Trivy"><a href="#Image-Scanning-with-Trivy" class="headerlink" title="Image Scanning with Trivy"></a>Image Scanning with Trivy</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">image-scan</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">trivy</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">aquasec/trivy:latest</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">trivy</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">image</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--exit-code</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--severity</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">HIGH,CRITICAL</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">my-java-app:1.0</span></span><br></pre></td></tr></table></figure>

<h3 id="Admission-Controller-OPA-Gatekeeper"><a href="#Admission-Controller-OPA-Gatekeeper" class="headerlink" title="Admission Controller (OPA Gatekeeper)"></a>Admission Controller (OPA Gatekeeper)</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">templates.gatekeeper.sh/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConstraintTemplate</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">k8srequiredsecuritycontext</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">crd:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">names:</span></span><br><span class="line">        <span class="attr">kind:</span> <span class="string">K8sRequiredSecurityContext</span></span><br><span class="line">      <span class="attr">validation:</span></span><br><span class="line">        <span class="attr">properties:</span></span><br><span class="line">          <span class="attr">runAsNonRoot:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">boolean</span></span><br><span class="line">  <span class="attr">targets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target:</span> <span class="string">admission.k8s.gatekeeper.sh</span></span><br><span class="line">      <span class="attr">rego:</span> <span class="string">|</span></span><br><span class="line"><span class="string">        package k8srequiredsecuritycontext</span></span><br><span class="line"><span class="string"></span>        </span><br><span class="line">        <span class="string">violation[&#123;&quot;msg&quot;:</span> <span class="string">msg&#125;]</span> &#123;</span><br><span class="line">          <span class="string">container</span> <span class="string">:=</span> <span class="string">input.review.object.spec.containers</span>[<span class="string">_</span>]</span><br><span class="line">          <span class="string">not</span> <span class="string">container.securityContext.runAsNonRoot</span></span><br><span class="line">          <span class="string">msg</span> <span class="string">:=</span> <span class="string">&quot;Container must run as non-root user&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">constraints.gatekeeper.sh/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">K8sRequiredSecurityContext</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">must-run-as-non-root</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">match:</span></span><br><span class="line">    <span class="attr">kinds:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;apps&quot;</span>]</span><br><span class="line">        <span class="attr">kinds:</span> [<span class="string">&quot;Deployment&quot;</span>]</span><br><span class="line">  <span class="attr">parameters:</span></span><br><span class="line">    <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="How-do-you-debug-issues-in-Java-applications-running-on-Kubernetes"><a href="#How-do-you-debug-issues-in-Java-applications-running-on-Kubernetes" class="headerlink" title="How do you debug issues in Java applications running on Kubernetes?"></a>How do you debug issues in Java applications running on Kubernetes?</h2><h3 id="Reference-Answer-10"><a href="#Reference-Answer-10" class="headerlink" title="Reference Answer"></a>Reference Answer</h3><p>Debugging Kubernetes applications requires understanding both Kubernetes diagnostics and Java-specific debugging techniques.</p>
<h3 id="Debugging-Workflow"><a href="#Debugging-Workflow" class="headerlink" title="Debugging Workflow"></a>Debugging Workflow</h3><pre>
<code class="mermaid">
graph TD
ISSUE[Application Issue] --&gt; CHECK1{Pod Status}
CHECK1 --&gt;|Running| CHECK2{Logs Analysis}
CHECK1 --&gt;|Pending| EVENTS[Check Events]
CHECK1 --&gt;|Failed| DESCRIBE[Describe Pod]

CHECK2 --&gt;|App Logs| APPLOGS[Application Logs]
CHECK2 --&gt;|System Logs| SYSLOGS[System Logs]

EVENTS --&gt; RESOURCES{Resource Issues}
DESCRIBE --&gt; CONFIG{Config Issues}

APPLOGS --&gt; METRICS[Check Metrics]
SYSLOGS --&gt; NETWORK[Network Debug]

RESOURCES --&gt; SCALE[Scale Resources]
CONFIG --&gt; FIX[Fix Configuration]

METRICS --&gt; PROFILE[Java Profiling]
NETWORK --&gt; CONNECTIVITY[Test Connectivity]
</code>
</pre>

<h3 id="Basic-Kubernetes-Debugging-Commands"><a href="#Basic-Kubernetes-Debugging-Commands" class="headerlink" title="Basic Kubernetes Debugging Commands"></a>Basic Kubernetes Debugging Commands</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Check pod status</span></span><br><span class="line">kubectl get pods -l app=java-app</span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe pod for detailed information</span></span><br><span class="line">kubectl describe pod &lt;pod-name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get pod logs</span></span><br><span class="line">kubectl logs &lt;pod-name&gt;</span><br><span class="line">kubectl logs &lt;pod-name&gt; --previous  <span class="comment"># Previous container logs</span></span><br><span class="line">kubectl logs &lt;pod-name&gt; -c &lt;container-name&gt;  <span class="comment"># Multi-container pod</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Follow logs in real-time</span></span><br><span class="line">kubectl logs -f &lt;pod-name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get logs from all pods with label</span></span><br><span class="line">kubectl logs -l app=java-app --<span class="built_in">tail</span>=100</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check events</span></span><br><span class="line">kubectl get events --sort-by=.metadata.creationTimestamp</span><br><span class="line"></span><br><span class="line"><span class="comment"># Execute commands in pod</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -- /bin/bash</span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -- ps aux</span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -- netstat -tlnp</span><br></pre></td></tr></table></figure>

<h3 id="Java-Application-Debugging"><a href="#Java-Application-Debugging" class="headerlink" title="Java Application Debugging"></a>Java Application Debugging</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DebugController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(DebugController.class);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MeterRegistry meterRegistry;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/debug/health&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getDetailedHealth</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; health = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// JVM Memory info</span></span><br><span class="line">        <span class="type">MemoryMXBean</span> <span class="variable">memoryBean</span> <span class="operator">=</span> ManagementFactory.getMemoryMXBean();</span><br><span class="line">        <span class="type">MemoryUsage</span> <span class="variable">heapUsage</span> <span class="operator">=</span> memoryBean.getHeapMemoryUsage();</span><br><span class="line">        <span class="type">MemoryUsage</span> <span class="variable">nonHeapUsage</span> <span class="operator">=</span> memoryBean.getNonHeapMemoryUsage();</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, Object&gt; memory = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        memory.put(<span class="string">&quot;heap&quot;</span>, Map.of(</span><br><span class="line">            <span class="string">&quot;used&quot;</span>, heapUsage.getUsed(),</span><br><span class="line">            <span class="string">&quot;committed&quot;</span>, heapUsage.getCommitted(),</span><br><span class="line">            <span class="string">&quot;max&quot;</span>, heapUsage.getMax()</span><br><span class="line">        ));</span><br><span class="line">        memory.put(<span class="string">&quot;nonHeap&quot;</span>, Map.of(</span><br><span class="line">            <span class="string">&quot;used&quot;</span>, nonHeapUsage.getUsed(),</span><br><span class="line">            <span class="string">&quot;committed&quot;</span>, nonHeapUsage.getCommitted(),</span><br><span class="line">            <span class="string">&quot;max&quot;</span>, nonHeapUsage.getMax()</span><br><span class="line">        ));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Thread info</span></span><br><span class="line">        <span class="type">ThreadMXBean</span> <span class="variable">threadBean</span> <span class="operator">=</span> ManagementFactory.getThreadMXBean();</span><br><span class="line">        Map&lt;String, Object&gt; threads = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        threads.put(<span class="string">&quot;count&quot;</span>, threadBean.getThreadCount());</span><br><span class="line">        threads.put(<span class="string">&quot;peak&quot;</span>, threadBean.getPeakThreadCount());</span><br><span class="line">        threads.put(<span class="string">&quot;daemon&quot;</span>, threadBean.getDaemonThreadCount());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// GC info</span></span><br><span class="line">        List&lt;GarbageCollectorMXBean&gt; gcBeans = ManagementFactory.getGarbageCollectorMXBeans();</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; gcInfo = gcBeans.stream()</span><br><span class="line">            .map(gc -&gt; Map.of(</span><br><span class="line">                <span class="string">&quot;name&quot;</span>, gc.getName(),</span><br><span class="line">                <span class="string">&quot;collections&quot;</span>, gc.getCollectionCount(),</span><br><span class="line">                <span class="string">&quot;time&quot;</span>, gc.getCollectionTime()</span><br><span class="line">            ))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">        </span><br><span class="line">        health.put(<span class="string">&quot;timestamp&quot;</span>, Instant.now());</span><br><span class="line">        health.put(<span class="string">&quot;memory&quot;</span>, memory);</span><br><span class="line">        health.put(<span class="string">&quot;threads&quot;</span>, threads);</span><br><span class="line">        health.put(<span class="string">&quot;gc&quot;</span>, gcInfo);</span><br><span class="line">        health.put(<span class="string">&quot;uptime&quot;</span>, ManagementFactory.getRuntimeMXBean().getUptime());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> health;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/debug/threads&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getThreadDump</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadMXBean</span> <span class="variable">threadBean</span> <span class="operator">=</span> ManagementFactory.getThreadMXBean();</span><br><span class="line">        ThreadInfo[] threadInfos = threadBean.dumpAllThreads(<span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, Object&gt; dump = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        dump.put(<span class="string">&quot;timestamp&quot;</span>, Instant.now());</span><br><span class="line">        dump.put(<span class="string">&quot;threadCount&quot;</span>, threadInfos.length);</span><br><span class="line">        </span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; threads = Arrays.stream(threadInfos)</span><br><span class="line">            .map(info -&gt; &#123;</span><br><span class="line">                Map&lt;String, Object&gt; thread = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                thread.put(<span class="string">&quot;name&quot;</span>, info.getThreadName());</span><br><span class="line">                thread.put(<span class="string">&quot;state&quot;</span>, info.getThreadState().toString());</span><br><span class="line">                thread.put(<span class="string">&quot;blocked&quot;</span>, info.getBlockedCount());</span><br><span class="line">                thread.put(<span class="string">&quot;waited&quot;</span>, info.getWaitedCount());</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (info.getLockInfo() != <span class="literal">null</span>) &#123;</span><br><span class="line">                    thread.put(<span class="string">&quot;lock&quot;</span>, info.getLockInfo().toString());</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> thread;</span><br><span class="line">            &#125;)</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">            </span><br><span class="line">        dump.put(<span class="string">&quot;threads&quot;</span>, threads);</span><br><span class="line">        <span class="keyword">return</span> dump;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/debug/gc&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">triggerGC</span><span class="params">()</span> &#123;</span><br><span class="line">        logger.warn(<span class="string">&quot;Manually triggering garbage collection - this should not be done in production&quot;</span>);</span><br><span class="line">        System.gc();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;GC triggered&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Remote-Debugging-Configuration"><a href="#Remote-Debugging-Configuration" class="headerlink" title="Remote Debugging Configuration"></a>Remote Debugging Configuration</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app-debug</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span>  <span class="comment"># Single replica for debugging</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">java-app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">my-java-app:1.0</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">5005</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">debug</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&gt;-</span></span><br><span class="line"><span class="string">            -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005</span></span><br><span class="line"><span class="string">            -XX:+UseContainerSupport</span></span><br><span class="line"><span class="string">            -XX:MaxRAMPercentage=75.0</span></span><br><span class="line"><span class="string"></span>        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;2Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;1000m&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app-debug-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">java-app</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">debug</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5005</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">5005</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br></pre></td></tr></table></figure>

<h3 id="Port-Forwarding-for-Local-Debugging"><a href="#Port-Forwarding-for-Local-Debugging" class="headerlink" title="Port Forwarding for Local Debugging"></a>Port Forwarding for Local Debugging</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Forward application port</span></span><br><span class="line">kubectl port-forward deployment/java-app 8080:8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># Forward debug port</span></span><br><span class="line">kubectl port-forward deployment/java-app-debug 5005:5005</span><br><span class="line"></span><br><span class="line"><span class="comment"># Forward multiple ports</span></span><br><span class="line">kubectl port-forward pod/&lt;pod-name&gt; 8080:8080 5005:5005</span><br><span class="line"></span><br><span class="line"><span class="comment"># Connect your IDE debugger to localhost:5005</span></span><br></pre></td></tr></table></figure>

<h3 id="Performance-Debugging-with-JVM-Tools"><a href="#Performance-Debugging-with-JVM-Tools" class="headerlink" title="Performance Debugging with JVM Tools"></a>Performance Debugging with JVM Tools</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Execute JVM diagnostic commands in pod</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -- jps -l</span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -- jstat -gc &lt;pid&gt; 5s</span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -- jstack &lt;pid&gt;</span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -- jmap -histo &lt;pid&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create heap dump</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -- jcmd &lt;pid&gt; GC.run_finalization</span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -- jcmd &lt;pid&gt; VM.gc</span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -- jcmd &lt;pid&gt; GC.dump /tmp/heapdump.hprof</span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy heap dump to local machine</span></span><br><span class="line">kubectl <span class="built_in">cp</span> &lt;pod-name&gt;:/tmp/heapdump.hprof ./heapdump.hprof</span><br></pre></td></tr></table></figure>

<h3 id="Network-Debugging"><a href="#Network-Debugging" class="headerlink" title="Network Debugging"></a>Network Debugging</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Network debugging pod</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">network-debug</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">network-tools</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nicolaka/netshoot</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/bash&quot;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&quot;-c&quot;</span>, <span class="string">&quot;while true; do ping localhost; sleep 30;done&quot;</span>]</span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Test network connectivity</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it network-debug -- nslookup java-app-service</span><br><span class="line">kubectl <span class="built_in">exec</span> -it network-debug -- curl -v http://java-app-service:8080/health</span><br><span class="line">kubectl <span class="built_in">exec</span> -it network-debug -- telnet java-app-service 8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check DNS resolution</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it network-debug -- dig java-app-service.default.svc.cluster.local</span><br><span class="line"></span><br><span class="line"><span class="comment"># Test external connectivity</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it network-debug -- curl -v https://api.external-service.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># Network policy testing</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it network-debug -- nc -zv java-app-service 8080</span><br></pre></td></tr></table></figure>

<h3 id="Debugging-Init-Containers"><a href="#Debugging-Init-Containers" class="headerlink" title="Debugging Init Containers"></a>Debugging Init Containers</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app-with-init</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wait-for-db</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">busybox:1.28</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;Waiting for database...&quot;</span></span><br><span class="line"><span class="string">          until nc -z database-service 5432; do</span></span><br><span class="line"><span class="string">            echo &quot;Database not ready, waiting...&quot;</span></span><br><span class="line"><span class="string">            sleep 2</span></span><br><span class="line"><span class="string">          done</span></span><br><span class="line"><span class="string">          echo &quot;Database is ready!&quot;</span></span><br><span class="line"><span class="string"></span>      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">migrate-db</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">migrate/migrate</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;/migrate&quot;</span>]</span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;-path=/migrations&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;-database=postgresql://user:pass@database-service:5432/db?sslmode=disable&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;up&quot;</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">migrations</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/migrations</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">java-app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">my-java-app:1.0</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">migrations</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">db-migrations</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Check init container logs</span></span><br><span class="line">kubectl logs &lt;pod-name&gt; -c wait-for-db</span><br><span class="line">kubectl logs &lt;pod-name&gt; -c migrate-db</span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe pod to see init container status</span></span><br><span class="line">kubectl describe pod &lt;pod-name&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Application-Metrics-Debugging"><a href="#Application-Metrics-Debugging" class="headerlink" title="Application Metrics Debugging"></a>Application Metrics Debugging</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomMetrics</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter httpRequestsTotal;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Timer httpRequestDuration;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Gauge activeConnections;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomMetrics</span><span class="params">(MeterRegistry meterRegistry)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.httpRequestsTotal = Counter.builder(<span class="string">&quot;http_requests_total&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Total HTTP requests&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.httpRequestDuration = Timer.builder(<span class="string">&quot;http_request_duration&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;HTTP request duration&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.activeConnections = Gauge.builder(<span class="string">&quot;active_connections&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Active database connections&quot;</span>)</span><br><span class="line">            .register(meterRegistry, <span class="built_in">this</span>, CustomMetrics::getActiveConnections);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordRequest</span><span class="params">(String method, String endpoint, <span class="type">long</span> duration)</span> &#123;</span><br><span class="line">        httpRequestsTotal.increment(</span><br><span class="line">            Tags.of(<span class="string">&quot;method&quot;</span>, method, <span class="string">&quot;endpoint&quot;</span>, endpoint)</span><br><span class="line">        );</span><br><span class="line">        httpRequestDuration.record(duration, TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">getActiveConnections</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Return actual active connection count</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">10.0</span>; <span class="comment">// Placeholder</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Debugging-Persistent-Volumes"><a href="#Debugging-Persistent-Volumes" class="headerlink" title="Debugging Persistent Volumes"></a>Debugging Persistent Volumes</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Check PV and PVC status</span></span><br><span class="line">kubectl get pv</span><br><span class="line">kubectl get pvc</span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe PVC for detailed info</span></span><br><span class="line">kubectl describe pvc java-app-storage</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check mounted volumes in pod</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -- <span class="built_in">df</span> -h</span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -- <span class="built_in">ls</span> -la /app/data</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check file permissions</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -- <span class="built_in">ls</span> -la /app/data</span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -- <span class="built_in">id</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Test file creation</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -- <span class="built_in">touch</span> /app/data/test.txt</span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -- <span class="built_in">echo</span> <span class="string">&quot;test&quot;</span> &gt; /app/data/test.txt</span><br></pre></td></tr></table></figure>

<h3 id="Resource-Usage-Investigation"><a href="#Resource-Usage-Investigation" class="headerlink" title="Resource Usage Investigation"></a>Resource Usage Investigation</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Check resource usage</span></span><br><span class="line">kubectl top pods</span><br><span class="line">kubectl top nodes</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get detailed resource information</span></span><br><span class="line">kubectl describe node &lt;node-name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check resource quotas</span></span><br><span class="line">kubectl get resourcequota</span><br><span class="line">kubectl describe resourcequota</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check limit ranges</span></span><br><span class="line">kubectl get limitrange</span><br><span class="line">kubectl describe limitrange</span><br></pre></td></tr></table></figure>

<h3 id="Debugging-ConfigMaps-and-Secrets"><a href="#Debugging-ConfigMaps-and-Secrets" class="headerlink" title="Debugging ConfigMaps and Secrets"></a>Debugging ConfigMaps and Secrets</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Check ConfigMap content</span></span><br><span class="line">kubectl get configmap java-app-config -o yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check Secret content (base64 encoded)</span></span><br><span class="line">kubectl get secret java-app-secrets -o yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># Decode secret values</span></span><br><span class="line">kubectl get secret java-app-secrets -o jsonpath=<span class="string">&#x27;&#123;.data.database-password&#125;&#x27;</span> | <span class="built_in">base64</span> --decode</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check mounted config in pod</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -- <span class="built_in">cat</span> /app/config/application.properties</span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -- <span class="built_in">env</span> | grep -i database</span><br></pre></td></tr></table></figure>

<h3 id="Automated-Debugging-Script"><a href="#Automated-Debugging-Script" class="headerlink" title="Automated Debugging Script"></a>Automated Debugging Script</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">APP_NAME=<span class="string">&quot;java-app&quot;</span></span><br><span class="line">NAMESPACE=<span class="string">&quot;default&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Kubernetes Debugging Report for <span class="variable">$APP_NAME</span> ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Timestamp: <span class="subst">$(date)</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Pod Status ===&quot;</span></span><br><span class="line">kubectl get pods -l app=<span class="variable">$APP_NAME</span> -n <span class="variable">$NAMESPACE</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Recent Events ===&quot;</span></span><br><span class="line">kubectl get events --sort-by=.metadata.creationTimestamp -n <span class="variable">$NAMESPACE</span> | <span class="built_in">tail</span> -10</span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Pod Description ===&quot;</span></span><br><span class="line">POD_NAME=$(kubectl get pods -l app=<span class="variable">$APP_NAME</span> -n <span class="variable">$NAMESPACE</span> -o jsonpath=<span class="string">&#x27;&#123;.items[0].metadata.name&#125;&#x27;</span>)</span><br><span class="line">kubectl describe pod <span class="variable">$POD_NAME</span> -n <span class="variable">$NAMESPACE</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Application Logs (last 50 lines) ===&quot;</span></span><br><span class="line">kubectl logs <span class="variable">$POD_NAME</span> -n <span class="variable">$NAMESPACE</span> --<span class="built_in">tail</span>=50</span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Resource Usage ===&quot;</span></span><br><span class="line">kubectl top pod <span class="variable">$POD_NAME</span> -n <span class="variable">$NAMESPACE</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Service Status ===&quot;</span></span><br><span class="line">kubectl get svc -l app=<span class="variable">$APP_NAME</span> -n <span class="variable">$NAMESPACE</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== ConfigMap Status ===&quot;</span></span><br><span class="line">kubectl get configmap -l app=<span class="variable">$APP_NAME</span> -n <span class="variable">$NAMESPACE</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Secret Status ===&quot;</span></span><br><span class="line">kubectl get secret -l app=<span class="variable">$APP_NAME</span> -n <span class="variable">$NAMESPACE</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Network Connectivity Test ===&quot;</span></span><br><span class="line">kubectl run debug-pod --<span class="built_in">rm</span> -i --restart=Never --image=nicolaka/netshoot -- \</span><br><span class="line">  /bin/bash -c <span class="string">&quot;nslookup <span class="variable">$APP_NAME</span>-service.<span class="variable">$NAMESPACE</span>.svc.cluster.local &amp;&amp; \</span></span><br><span class="line"><span class="string">                curl -s -o /dev/null -w &#x27;%&#123;http_code&#125;&#x27; http://<span class="variable">$APP_NAME</span>-service.<span class="variable">$NAMESPACE</span>.svc.cluster.local:8080/health&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Explain-Ingress-and-how-to-expose-Java-applications-externally"><a href="#Explain-Ingress-and-how-to-expose-Java-applications-externally" class="headerlink" title="Explain Ingress and how to expose Java applications externally"></a>Explain Ingress and how to expose Java applications externally</h2><h3 id="Reference-Answer-11"><a href="#Reference-Answer-11" class="headerlink" title="Reference Answer"></a>Reference Answer</h3><p>Ingress provides HTTP and HTTPS routing to services within a Kubernetes cluster, acting as a reverse proxy and load balancer for external traffic.</p>
<h3 id="Ingress-Architecture"><a href="#Ingress-Architecture" class="headerlink" title="Ingress Architecture"></a>Ingress Architecture</h3><pre>
<code class="mermaid">
graph TB
INTERNET[Internet] --&gt; LB[Load Balancer]
LB --&gt; INGRESS[Ingress Controller]

subgraph &quot;Kubernetes Cluster&quot;
    INGRESS --&gt; INGRESS_RULES[Ingress Rules]
    INGRESS_RULES --&gt; SVC1[Java App Service]
    INGRESS_RULES --&gt; SVC2[API Service]
    INGRESS_RULES --&gt; SVC3[Frontend Service]
    
    SVC1 --&gt; POD1[Java App Pods]
    SVC2 --&gt; POD2[API Pods]
    SVC3 --&gt; POD3[Frontend Pods]
end
</code>
</pre>

<h3 id="Basic-Ingress-Configuration"><a href="#Basic-Ingress-Configuration" class="headerlink" title="Basic Ingress Configuration"></a>Basic Ingress Configuration</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/proxy-body-size:</span> <span class="string">&quot;10m&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/proxy-connect-timeout:</span> <span class="string">&quot;60&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/proxy-send-timeout:</span> <span class="string">&quot;60&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/proxy-read-timeout:</span> <span class="string">&quot;60&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">myapp.example.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">myapp-tls</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">myapp.example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">java-app-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h3 id="Advanced-Ingress-with-Path-based-Routing"><a href="#Advanced-Ingress-with-Path-based-Routing" class="headerlink" title="Advanced Ingress with Path-based Routing"></a>Advanced Ingress with Path-based Routing</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">microservices-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/$2</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/use-regex:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/proxy-body-size:</span> <span class="string">&quot;50m&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rate-limit:</span> <span class="string">&quot;100&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rate-limit-window:</span> <span class="string">&quot;1m&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">api.example.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">api-tls</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">api.example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="comment"># User service</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/api/users(/|$)(.*)</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">user-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">      <span class="comment"># Order service  </span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/api/orders(/|$)(.*)</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">order-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">      <span class="comment"># Payment service</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/api/payments(/|$)(.*)</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">payment-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">      <span class="comment"># Default fallback</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/(.*)</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">frontend-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h3 id="Java-Application-Configuration-for-Ingress"><a href="#Java-Application-Configuration-for-Ingress" class="headerlink" title="Java Application Configuration for Ingress"></a>Java Application Configuration for Ingress</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/orders&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Handle base path properly</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/health&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Map&lt;String, String&gt;&gt; <span class="title function_">health</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        Map&lt;String, String&gt; health = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        health.put(<span class="string">&quot;status&quot;</span>, <span class="string">&quot;UP&quot;</span>);</span><br><span class="line">        health.put(<span class="string">&quot;service&quot;</span>, <span class="string">&quot;order-service&quot;</span>);</span><br><span class="line">        health.put(<span class="string">&quot;path&quot;</span>, request.getRequestURI());</span><br><span class="line">        health.put(<span class="string">&quot;forwardedPath&quot;</span>, request.getHeader(<span class="string">&quot;X-Forwarded-Prefix&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(health);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;List&lt;OrderDto&gt;&gt; <span class="title function_">getOrders</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(defaultValue = &quot;0&quot;)</span> <span class="type">int</span> page,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(defaultValue = &quot;10&quot;)</span> <span class="type">int</span> size,</span></span><br><span class="line"><span class="params">            HttpServletRequest request)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Log forwarded headers for debugging</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">forwardedFor</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;X-Forwarded-For&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">forwardedProto</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;X-Forwarded-Proto&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">forwardedHost</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;X-Forwarded-Host&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        log.info(<span class="string">&quot;Request from: &#123;&#125; via &#123;&#125; to &#123;&#125;&quot;</span>, forwardedFor, forwardedProto, forwardedHost);</span><br><span class="line">        </span><br><span class="line">        List&lt;OrderDto&gt; orders = orderService.getOrders(page, size);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(orders);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Spring-Boot-Configuration-for-Proxy-Headers"><a href="#Spring-Boot-Configuration-for-Proxy-Headers" class="headerlink" title="Spring Boot Configuration for Proxy Headers"></a>Spring Boot Configuration for Proxy Headers</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/</span></span><br><span class="line">  <span class="attr">forward-headers-strategy:</span> <span class="string">native</span></span><br><span class="line">  <span class="attr">tomcat:</span></span><br><span class="line">    <span class="attr">remoteip:</span></span><br><span class="line">      <span class="attr">remote-ip-header:</span> <span class="string">X-Forwarded-For</span></span><br><span class="line">      <span class="attr">protocol-header:</span> <span class="string">X-Forwarded-Proto</span></span><br><span class="line">      <span class="attr">port-header:</span> <span class="string">X-Forwarded-Port</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">base-path:</span> <span class="string">/actuator</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">health,info,metrics,prometheus</span></span><br></pre></td></tr></table></figure>

<h3 id="SSL-TLS-Certificate-Management"><a href="#SSL-TLS-Certificate-Management" class="headerlink" title="SSL&#x2F;TLS Certificate Management"></a>SSL&#x2F;TLS Certificate Management</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Using cert-manager for automatic SSL certificates</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">cert-manager.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterIssuer</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">letsencrypt-prod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">acme:</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://acme-v02.api.letsencrypt.org/directory</span></span><br><span class="line">    <span class="attr">email:</span> <span class="string">admin@example.com</span></span><br><span class="line">    <span class="attr">privateKeySecretRef:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">letsencrypt-prod</span></span><br><span class="line">    <span class="attr">solvers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">http01:</span></span><br><span class="line">        <span class="attr">ingress:</span></span><br><span class="line">          <span class="attr">class:</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app-ssl-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">cert-manager.io/cluster-issuer:</span> <span class="string">&quot;letsencrypt-prod&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/force-ssl-redirect:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">myapp.example.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">myapp-tls-auto</span>  <span class="comment"># Will be created by cert-manager</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">myapp.example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">java-app-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h3 id="Ingress-with-Authentication"><a href="#Ingress-with-Authentication" class="headerlink" title="Ingress with Authentication"></a>Ingress with Authentication</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app-auth-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-type:</span> <span class="string">basic</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-secret:</span> <span class="string">basic-auth</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-realm:</span> <span class="string">&#x27;Authentication Required&#x27;</span></span><br><span class="line">    <span class="comment"># Or OAuth2 authentication</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-url:</span> <span class="string">&quot;https://auth.example.com/oauth2/auth&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-signin:</span> <span class="string">&quot;https://auth.example.com/oauth2/start&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">secure.example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">java-app-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Basic auth secret</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">basic-auth</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">auth:</span> <span class="string">YWRtaW46JGFwcjEkSDY1dnVhNU8kblNEOC9ObDBINFkwL3pmWUZOcUI4MQ==</span>  <span class="comment"># admin:admin</span></span><br></pre></td></tr></table></figure>

<h3 id="Custom-Error-Pages"><a href="#Custom-Error-Pages" class="headerlink" title="Custom Error Pages"></a>Custom Error Pages</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">custom-error-pages</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">404.html:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">    &lt;html&gt;</span></span><br><span class="line"><span class="string">    &lt;head&gt;</span></span><br><span class="line"><span class="string">        &lt;title&gt;Page Not Found&lt;/title&gt;</span></span><br><span class="line"><span class="string">        &lt;style&gt;</span></span><br><span class="line"><span class="string">            body &#123; font-family: Arial, sans-serif; text-align: center; margin-top: 50px; &#125;</span></span><br><span class="line"><span class="string">            .error-code &#123; font-size: 72px; color: #e74c3c; &#125;</span></span><br><span class="line"><span class="string">            .error-message &#123; font-size: 24px; color: #7f8c8d; &#125;</span></span><br><span class="line"><span class="string">        &lt;/style&gt;</span></span><br><span class="line"><span class="string">    &lt;/head&gt;</span></span><br><span class="line"><span class="string">    &lt;body&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;error-code&quot;&gt;404&lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;error-message&quot;&gt;The page you&#x27;re looking for doesn&#x27;t exist.&lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;&lt;a href=&quot;/&quot;&gt;Go back to homepage&lt;/a&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;/body&gt;</span></span><br><span class="line"><span class="string">    &lt;/html&gt;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">500.html:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">    &lt;html&gt;</span></span><br><span class="line"><span class="string">    &lt;head&gt;</span></span><br><span class="line"><span class="string">        &lt;title&gt;Internal Server Error&lt;/title&gt;</span></span><br><span class="line"><span class="string">        &lt;style&gt;</span></span><br><span class="line"><span class="string">            body &#123; font-family: Arial, sans-serif; text-align: center; margin-top: 50px; &#125;</span></span><br><span class="line"><span class="string">            .error-code &#123; font-size: 72px; color: #e74c3c; &#125;</span></span><br><span class="line"><span class="string">            .error-message &#123; font-size: 24px; color: #7f8c8d; &#125;</span></span><br><span class="line"><span class="string">        &lt;/style&gt;</span></span><br><span class="line"><span class="string">    &lt;/head&gt;</span></span><br><span class="line"><span class="string">    &lt;body&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;error-code&quot;&gt;500&lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;error-message&quot;&gt;Something went wrong on our end.&lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;Please try again later.&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;/body&gt;</span></span><br><span class="line"><span class="string">    &lt;/html&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app-custom-errors</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/custom-http-errors:</span> <span class="string">&quot;404,500,503&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/default-backend:</span> <span class="string">error-pages-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">myapp.example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">java-app-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h3 id="Load-Balancing-and-Session-Affinity"><a href="#Load-Balancing-and-Session-Affinity" class="headerlink" title="Load Balancing and Session Affinity"></a>Load Balancing and Session Affinity</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">java-app-sticky-sessions</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/affinity:</span> <span class="string">&quot;cookie&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/affinity-mode:</span> <span class="string">&quot;persistent&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/session-cookie-name:</span> <span class="string">&quot;JSESSIONID&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/session-cookie-expires:</span> <span class="string">&quot;86400&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/session-cookie-max-age:</span> <span class="string">&quot;86400&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/session-cookie-path:</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/upstream-hash-by:</span> <span class="string">&quot;$remote_addr&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">myapp.example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">java-app-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h3 id="Ingress-Health-Checks-and-Monitoring"><a href="#Ingress-Health-Checks-and-Monitoring" class="headerlink" title="Ingress Health Checks and Monitoring"></a>Ingress Health Checks and Monitoring</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IngressHealthController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/health/ingress&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">ingressHealth</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; health = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        health.put(<span class="string">&quot;status&quot;</span>, <span class="string">&quot;UP&quot;</span>);</span><br><span class="line">        health.put(<span class="string">&quot;timestamp&quot;</span>, Instant.now());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Include request information for debugging</span></span><br><span class="line">        Map&lt;String, String&gt; requestInfo = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        requestInfo.put(<span class="string">&quot;remoteAddr&quot;</span>, request.getRemoteAddr());</span><br><span class="line">        requestInfo.put(<span class="string">&quot;forwardedFor&quot;</span>, request.getHeader(<span class="string">&quot;X-Forwarded-For&quot;</span>));</span><br><span class="line">        requestInfo.put(<span class="string">&quot;forwardedProto&quot;</span>, request.getHeader(<span class="string">&quot;X-Forwarded-Proto&quot;</span>));</span><br><span class="line">        requestInfo.put(<span class="string">&quot;forwardedHost&quot;</span>, request.getHeader(<span class="string">&quot;X-Forwarded-Host&quot;</span>));</span><br><span class="line">        requestInfo.put(<span class="string">&quot;userAgent&quot;</span>, request.getHeader(<span class="string">&quot;User-Agent&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        health.put(<span class="string">&quot;request&quot;</span>, requestInfo);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(health);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/ready&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title function_">readiness</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Perform readiness checks</span></span><br><span class="line">        <span class="keyword">if</span> (isApplicationReady()) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.ok(<span class="string">&quot;Ready&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.status(<span class="number">503</span>).body(<span class="string">&quot;Not Ready&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isApplicationReady</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Check database connectivity, external services, etc.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Ingress-Controller-Configuration"><a href="#Ingress-Controller-Configuration" class="headerlink" title="Ingress Controller Configuration"></a>Ingress Controller Configuration</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-configuration</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="comment"># Global settings</span></span><br><span class="line">  <span class="attr">proxy-connect-timeout:</span> <span class="string">&quot;60&quot;</span></span><br><span class="line">  <span class="attr">proxy-send-timeout:</span> <span class="string">&quot;60&quot;</span></span><br><span class="line">  <span class="attr">proxy-read-timeout:</span> <span class="string">&quot;60&quot;</span></span><br><span class="line">  <span class="attr">proxy-body-size:</span> <span class="string">&quot;100m&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Performance tuning</span></span><br><span class="line">  <span class="attr">worker-processes:</span> <span class="string">&quot;auto&quot;</span></span><br><span class="line">  <span class="attr">worker-connections:</span> <span class="string">&quot;1024&quot;</span></span><br><span class="line">  <span class="attr">keepalive-timeout:</span> <span class="string">&quot;65&quot;</span></span><br><span class="line">  <span class="attr">keepalive-requests:</span> <span class="string">&quot;100&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Security headers</span></span><br><span class="line">  <span class="attr">add-headers:</span> <span class="string">&quot;ingress-nginx/custom-headers&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Compression</span></span><br><span class="line">  <span class="attr">enable-gzip:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">gzip-types:</span> <span class="string">&quot;text/plain text/css application/json application/javascript text/xml application/xml&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Rate limiting</span></span><br><span class="line">  <span class="attr">rate-limit:</span> <span class="string">&quot;1000&quot;</span></span><br><span class="line">  <span class="attr">rate-limit-window:</span> <span class="string">&quot;1m&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">custom-headers</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">X-Content-Type-Options:</span> <span class="string">&quot;nosniff&quot;</span></span><br><span class="line">  <span class="attr">X-Frame-Options:</span> <span class="string">&quot;DENY&quot;</span></span><br><span class="line">  <span class="attr">X-XSS-Protection:</span> <span class="string">&quot;1; mode=block&quot;</span></span><br><span class="line">  <span class="attr">Strict-Transport-Security:</span> <span class="string">&quot;max-age=31536000; includeSubDomains&quot;</span></span><br><span class="line">  <span class="attr">Content-Security-Policy:</span> <span class="string">&quot;default-src &#x27;self&#x27;&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Testing-Ingress-Configuration"><a href="#Testing-Ingress-Configuration" class="headerlink" title="Testing Ingress Configuration"></a>Testing Ingress Configuration</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Test basic connectivity</span></span><br><span class="line">curl -H <span class="string">&quot;Host: myapp.example.com&quot;</span> http://&lt;ingress-ip&gt;/health</span><br><span class="line"></span><br><span class="line"><span class="comment"># Test SSL</span></span><br><span class="line">curl -H <span class="string">&quot;Host: myapp.example.com&quot;</span> https://&lt;ingress-ip&gt;/health</span><br><span class="line"></span><br><span class="line"><span class="comment"># Test with custom headers</span></span><br><span class="line">curl -H <span class="string">&quot;Host: myapp.example.com&quot;</span> -H <span class="string">&quot;X-Custom-Header: test&quot;</span> http://&lt;ingress-ip&gt;/api/orders</span><br><span class="line"></span><br><span class="line"><span class="comment"># Test different paths</span></span><br><span class="line">curl -H <span class="string">&quot;Host: api.example.com&quot;</span> http://&lt;ingress-ip&gt;/api/users/health</span><br><span class="line">curl -H <span class="string">&quot;Host: api.example.com&quot;</span> http://&lt;ingress-ip&gt;/api/orders/health</span><br><span class="line"></span><br><span class="line"><span class="comment"># Debug ingress controller logs</span></span><br><span class="line">kubectl logs -n ingress-nginx deployment/ingress-nginx-controller -f</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check ingress status</span></span><br><span class="line">kubectl get ingress</span><br><span class="line">kubectl describe ingress java-app-ingress</span><br></pre></td></tr></table></figure>

<p>This comprehensive guide covers the essential Kubernetes concepts and practical implementations that senior Java developers need to understand when working with containerized applications in production environments. </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/07/28/Java-Basic-Interview-Questions-Reference-Answers/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/28/Java-Basic-Interview-Questions-Reference-Answers/" class="post-title-link" itemprop="url">Java Basic Interview Questions-Reference Answers</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-07-28 23:57:51 / Modified: 23:58:41" itemprop="dateCreated datePublished" datetime="2025-07-28T23:57:51+08:00">2025-07-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Core-Java-Concepts"><a href="#Core-Java-Concepts" class="headerlink" title="Core Java Concepts"></a>Core Java Concepts</h2><h3 id="Whats-the-difference-between-and-equals-in-Java"><a href="#Whats-the-difference-between-and-equals-in-Java" class="headerlink" title="Whats the difference between == and .equals() in Java?"></a>Whats the difference between <code>==</code> and <code>.equals()</code> in Java?</h3><p><strong>Reference Answer:</strong></p>
<ul>
<li><code>==</code> compares references (memory addresses) for objects and values for primitives</li>
<li><code>.equals()</code> compares the actual content&#x2F;state of objects</li>
<li>By default, <code>.equals()</code> uses <code>==</code> (reference comparison) unless overridden</li>
<li>When overriding <code>.equals()</code>, you must also override <code>.hashCode()</code> to maintain the contract: if two objects are equal according to <code>.equals()</code>, they must have the same hash code</li>
<li>String pool example: <code>&quot;hello&quot; == &quot;hello&quot;</code> is true due to string interning, but <code>new String(&quot;hello&quot;) == new String(&quot;hello&quot;)</code> is false</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">s1</span> <span class="operator">=</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">s2</span> <span class="operator">=</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">s3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"></span><br><span class="line">s1 == s2;        <span class="comment">// true (same reference in string pool)</span></span><br><span class="line">s1 == s3;        <span class="comment">// false (different references)</span></span><br><span class="line">s1.equals(s3);   <span class="comment">// true (same content)</span></span><br></pre></td></tr></table></figure>

<h3 id="Explain-the-Java-memory-model-and-garbage-collection"><a href="#Explain-the-Java-memory-model-and-garbage-collection" class="headerlink" title="Explain the Java memory model and garbage collection."></a>Explain the Java memory model and garbage collection.</h3><p><strong>Reference Answer:</strong><br><strong>Memory Areas:</strong></p>
<ul>
<li><strong>Heap</strong>: Object storage, divided into Young Generation (Eden, S0, S1) and Old Generation</li>
<li><strong>Stack</strong>: Method call frames, local variables, partial results</li>
<li><strong>Method Area&#x2F;Metaspace</strong>: Class metadata, constant pool</li>
<li><strong>PC Register</strong>: Current executing instruction</li>
<li><strong>Native Method Stack</strong>: Native method calls</li>
</ul>
<p><strong>Garbage Collection Process:</strong></p>
<ol>
<li>Objects created in Eden space</li>
<li>When Eden fills, minor GC moves surviving objects to Survivor space</li>
<li>After several GC cycles, long-lived objects promoted to Old Generation</li>
<li>Major GC cleans Old Generation (more expensive)</li>
</ol>
<p><strong>Common GC Algorithms:</strong></p>
<ul>
<li><strong>Serial GC</strong>: Single-threaded, suitable for small applications</li>
<li><strong>Parallel GC</strong>: Multi-threaded, good for throughput</li>
<li><strong>G1GC</strong>: Low-latency, good for large heaps</li>
<li><strong>ZGC&#x2F;Shenandoah</strong>: Ultra-low latency collectors</li>
</ul>
<h3 id="What-are-the-differences-between-abstract-classes-and-interfaces"><a href="#What-are-the-differences-between-abstract-classes-and-interfaces" class="headerlink" title="What are the differences between abstract classes and interfaces?"></a>What are the differences between abstract classes and interfaces?</h3><p><strong>Reference Answer:</strong></p>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Abstract Class</th>
<th>Interface</th>
</tr>
</thead>
<tbody><tr>
<td>Inheritance</td>
<td>Single inheritance</td>
<td>Multiple inheritance</td>
</tr>
<tr>
<td>Methods</td>
<td>Can have concrete methods</td>
<td>All methods abstract (before Java 8)</td>
</tr>
<tr>
<td>Variables</td>
<td>Can have instance variables</td>
<td>Only public static final variables</td>
</tr>
<tr>
<td>Constructor</td>
<td>Can have constructors</td>
<td>Cannot have constructors</td>
</tr>
<tr>
<td>Access Modifiers</td>
<td>Any access modifier</td>
<td>Public by default</td>
</tr>
</tbody></table>
<p><strong>Modern Java (8+) additions:</strong></p>
<ul>
<li>Interfaces can have default and static methods</li>
<li>Private methods in interfaces (Java 9+)</li>
</ul>
<p><strong>When to use:</strong></p>
<ul>
<li><strong>Abstract Class</strong>: When you have common code to share and is-a relationship</li>
<li><strong>Interface</strong>: When you want to define a contract and can-do relationship</li>
</ul>
<h2 id="Concurrency-and-Threading"><a href="#Concurrency-and-Threading" class="headerlink" title="Concurrency and Threading"></a>Concurrency and Threading</h2><h3 id="How-does-the-volatile-keyword-work"><a href="#How-does-the-volatile-keyword-work" class="headerlink" title="How does the volatile keyword work?"></a>How does the <code>volatile</code> keyword work?</h3><p><strong>Reference Answer:</strong><br><strong>Purpose:</strong> Ensures visibility of variable changes across threads and prevents instruction reordering.</p>
<p><strong>Memory Effects:</strong></p>
<ul>
<li>Reads&#x2F;writes to volatile variables are directly from&#x2F;to main memory</li>
<li>Creates a happens-before relationship</li>
<li>Prevents compiler optimizations that cache variable values</li>
</ul>
<p><strong>When to use:</strong></p>
<ul>
<li>Simple flags or state variables</li>
<li>Single writer, multiple readers scenarios</li>
<li>Not sufficient for compound operations (like increment)</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VolatileExample</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Thread 1</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setFlag</span><span class="params">()</span> &#123;</span><br><span class="line">        flag = <span class="literal">true</span>; <span class="comment">// Immediately visible to other threads</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Thread 2</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkFlag</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (!flag) &#123;</span><br><span class="line">            <span class="comment">// Will see the change immediately</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Limitations:</strong> Doesnt provide atomicity for compound operations. Use <code>AtomicBoolean</code>, <code>AtomicInteger</code>, etc., for atomic operations.</p>
<h3 id="Explain-different-ways-to-create-threads-and-their-trade-offs"><a href="#Explain-different-ways-to-create-threads-and-their-trade-offs" class="headerlink" title="Explain different ways to create threads and their trade-offs."></a>Explain different ways to create threads and their trade-offs.</h3><p><strong>Reference Answer:</strong></p>
<p><strong>1. Extending Thread class:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123; <span class="comment">/* implementation */</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">MyThread</span>().start();</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>Pros</strong>: Simple, direct control</li>
<li><strong>Cons</strong>: Single inheritance limitation, tight coupling</li>
</ul>
<p><strong>2. Implementing Runnable:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123; <span class="comment">/* implementation */</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">MyTask</span>()).start();</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>Pros</strong>: Better design, can extend other classes</li>
<li><strong>Cons</strong>: Still creates OS threads</li>
</ul>
<p><strong>3. ExecutorService:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line">executor.submit(() -&gt; &#123; <span class="comment">/* task */</span> &#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>Pros</strong>: Thread pooling, resource management</li>
<li><strong>Cons</strong>: More complex, need proper shutdown</li>
</ul>
<p><strong>4. CompletableFuture:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture.supplyAsync(() -&gt; &#123; <span class="comment">/* computation */</span> &#125;)</span><br><span class="line">    .thenApply(result -&gt; &#123; <span class="comment">/* transform */</span> &#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>Pros</strong>: Asynchronous composition, functional style</li>
<li><strong>Cons</strong>: Learning curve, can be overkill for simple tasks</li>
</ul>
<p><strong>5. Virtual Threads (Java 19+):</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Thread.startVirtualThread(() -&gt; &#123; <span class="comment">/* task */</span> &#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>Pros</strong>: Lightweight, millions of threads possible</li>
<li><strong>Cons</strong>: New feature, limited adoption</li>
</ul>
<h3 id="Whats-the-difference-between-synchronized-and-ReentrantLock"><a href="#Whats-the-difference-between-synchronized-and-ReentrantLock" class="headerlink" title="Whats the difference between synchronized and ReentrantLock?"></a>Whats the difference between <code>synchronized</code> and <code>ReentrantLock</code>?</h3><p><strong>Reference Answer:</strong></p>
<table>
<thead>
<tr>
<th>Feature</th>
<th>synchronized</th>
<th>ReentrantLock</th>
</tr>
</thead>
<tbody><tr>
<td>Type</td>
<td>Intrinsic&#x2F;implicit lock</td>
<td>Explicit lock</td>
</tr>
<tr>
<td>Acquisition</td>
<td>Automatic</td>
<td>Manual (lock&#x2F;unlock)</td>
</tr>
<tr>
<td>Fairness</td>
<td>No fairness guarantee</td>
<td>Optional fairness</td>
</tr>
<tr>
<td>Interruptibility</td>
<td>Not interruptible</td>
<td>Interruptible</td>
</tr>
<tr>
<td>Try Lock</td>
<td>Not available</td>
<td>Available</td>
</tr>
<tr>
<td>Condition Variables</td>
<td>wait&#x2F;notify</td>
<td>Multiple Condition objects</td>
</tr>
<tr>
<td>Performance</td>
<td>JVM optimized</td>
<td>Slightly more overhead</td>
</tr>
</tbody></table>
<p><strong>ReentrantLock Example:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>(<span class="literal">true</span>); <span class="comment">// fair lock</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performTask</span><span class="params">()</span> &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// critical section</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock(); <span class="comment">// Must be in finally block</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryPerformTask</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (lock.tryLock()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// critical section</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Collections-and-Data-Structures"><a href="#Collections-and-Data-Structures" class="headerlink" title="Collections and Data Structures"></a>Collections and Data Structures</h2><h3 id="How-does-HashMap-work-internally"><a href="#How-does-HashMap-work-internally" class="headerlink" title="How does HashMap work internally?"></a>How does HashMap work internally?</h3><p><strong>Reference Answer:</strong><br><strong>Internal Structure:</strong></p>
<ul>
<li>Array of buckets (Node&lt;K,V&gt;[] table)</li>
<li>Each bucket can contain a linked list or red-black tree</li>
<li>Default initial capacity: 16, load factor: 0.75</li>
</ul>
<p><strong>Hash Process:</strong></p>
<ol>
<li>Calculate hash code of key using <code>hashCode()</code></li>
<li>Apply hash function: <code>hash(key) = key.hashCode() ^ (key.hashCode() &gt;&gt;&gt; 16)</code></li>
<li>Find bucket: <code>index = hash &amp; (capacity - 1)</code></li>
</ol>
<p><strong>Collision Resolution:</strong></p>
<ul>
<li><strong>Chaining</strong>: Multiple entries in same bucket form linked list</li>
<li><strong>Treeification</strong> (Java 8+): When bucket size  8, convert to red-black tree</li>
<li><strong>Untreeification</strong>: When bucket size  6, convert back to linked list</li>
</ul>
<p><strong>Resizing:</strong></p>
<ul>
<li>When size &gt; capacity  load factor, capacity doubles</li>
<li>All entries rehashed to new positions</li>
<li>Expensive operation, can cause performance issues</li>
</ul>
<p><strong>Poor hashCode() Impact:</strong><br>If <code>hashCode()</code> always returns same value, all entries go to one bucket, degrading performance to O(n) for operations.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Simplified internal structure</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;K,V&gt; &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> hash;</span><br><span class="line">    <span class="keyword">final</span> K key;</span><br><span class="line">    V value;</span><br><span class="line">    Node&lt;K,V&gt; next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="When-would-you-use-ConcurrentHashMap-vs-Collections-synchronizedMap"><a href="#When-would-you-use-ConcurrentHashMap-vs-Collections-synchronizedMap" class="headerlink" title="When would you use ConcurrentHashMap vs Collections.synchronizedMap()?"></a>When would you use ConcurrentHashMap vs Collections.synchronizedMap()?</h3><p><strong>Reference Answer:</strong></p>
<p><strong>Collections.synchronizedMap():</strong></p>
<ul>
<li>Wraps existing map with synchronized methods</li>
<li><strong>Synchronization</strong>: Entire map locked for each operation</li>
<li><strong>Performance</strong>: Poor in multi-threaded scenarios</li>
<li><strong>Iteration</strong>: Requires external synchronization</li>
<li><strong>Fail-fast</strong>: Iterators can throw ConcurrentModificationException</li>
</ul>
<p><strong>ConcurrentHashMap:</strong></p>
<ul>
<li><strong>Synchronization</strong>: Segment-based locking (Java 7) or CAS operations (Java 8+)</li>
<li><strong>Performance</strong>: Excellent concurrent read performance</li>
<li><strong>Iteration</strong>: Weakly consistent iterators, no external sync needed</li>
<li><strong>Fail-safe</strong>: Iterators reflect state at creation time</li>
<li><strong>Atomic operations</strong>: putIfAbsent(), replace(), computeIfAbsent()</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ConcurrentHashMap example</span></span><br><span class="line">ConcurrentHashMap&lt;String, Integer&gt; map = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">map.putIfAbsent(<span class="string">&quot;key&quot;</span>, <span class="number">1</span>);</span><br><span class="line">map.computeIfPresent(<span class="string">&quot;key&quot;</span>, (k, v) -&gt; v + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Safe iteration without external synchronization</span></span><br><span class="line"><span class="keyword">for</span> (Map.Entry&lt;String, Integer&gt; entry : map.entrySet()) &#123;</span><br><span class="line">    <span class="comment">// No ConcurrentModificationException</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Use ConcurrentHashMap when:</strong></p>
<ul>
<li>High concurrent access</li>
<li>More reads than writes</li>
<li>Need atomic operations</li>
<li>Want better performance</li>
</ul>
<h2 id="Design-Patterns-and-Architecture"><a href="#Design-Patterns-and-Architecture" class="headerlink" title="Design Patterns and Architecture"></a>Design Patterns and Architecture</h2><h3 id="Implement-the-Singleton-pattern-and-discuss-its-problems"><a href="#Implement-the-Singleton-pattern-and-discuss-its-problems" class="headerlink" title="Implement the Singleton pattern and discuss its problems."></a>Implement the Singleton pattern and discuss its problems.</h3><p><strong>Reference Answer:</strong></p>
<p><strong>1. Eager Initialization:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EagerSingleton</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">EagerSingleton</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EagerSingleton</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">EagerSingleton</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> EagerSingleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>Pros</strong>: Thread-safe, simple</li>
<li><strong>Cons</strong>: Creates instance even if never used</li>
</ul>
<p><strong>2. Lazy Initialization (Thread-unsafe):</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LazySingleton</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> LazySingleton instance;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">LazySingleton</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> LazySingleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> <span class="title class_">LazySingleton</span>(); <span class="comment">// Race condition!</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3. Thread-safe Lazy (Double-checked locking):</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadSafeSingleton</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> ThreadSafeSingleton instance;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">ThreadSafeSingleton</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ThreadSafeSingleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (ThreadSafeSingleton.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> <span class="title class_">ThreadSafeSingleton</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>4. Enum Singleton (Recommended):</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">EnumSingleton</span> &#123;</span><br><span class="line">    INSTANCE;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doSomething</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// business logic</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Problems with Singleton:</strong></p>
<ul>
<li><strong>Testing</strong>: Difficult to mock, global state</li>
<li><strong>Coupling</strong>: Tight coupling throughout application</li>
<li><strong>Scalability</strong>: Global bottleneck</li>
<li><strong>Serialization</strong>: Need special handling</li>
<li><strong>Reflection</strong>: Can break private constructor</li>
<li><strong>Classloader</strong>: Multiple instances with different classloaders</li>
</ul>
<h3 id="Explain-dependency-injection-and-inversion-of-control"><a href="#Explain-dependency-injection-and-inversion-of-control" class="headerlink" title="Explain dependency injection and inversion of control."></a>Explain dependency injection and inversion of control.</h3><p><strong>Reference Answer:</strong></p>
<p><strong>Inversion of Control (IoC):</strong><br>Principle where control of object creation and lifecycle is transferred from the application code to an external framework.</p>
<p><strong>Dependency Injection (DI):</strong><br>A technique to implement IoC where dependencies are provided to an object rather than the object creating them.</p>
<p><strong>Types of DI:</strong></p>
<p><strong>1. Constructor Injection:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserRepository userRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserService</span><span class="params">(UserRepository userRepository)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userRepository = userRepository;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2. Setter Injection:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserRepository</span><span class="params">(UserRepository userRepository)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userRepository = userRepository;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3. Field Injection:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Benefits:</strong></p>
<ul>
<li><strong>Testability</strong>: Easy to inject mock dependencies</li>
<li><strong>Flexibility</strong>: Change implementations without code changes</li>
<li><strong>Decoupling</strong>: Reduces tight coupling between classes</li>
<li><strong>Configuration</strong>: Centralized dependency configuration</li>
</ul>
<p><strong>Without DI:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">UserRepository</span> <span class="variable">userRepository</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DatabaseUserRepository</span>(); <span class="comment">// Tight coupling</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>With DI:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserRepository userRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserService</span><span class="params">(UserRepository userRepository)</span> &#123; <span class="comment">// Loose coupling</span></span><br><span class="line">        <span class="built_in">this</span>.userRepository = userRepository;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-and-Optimization"><a href="#Performance-and-Optimization" class="headerlink" title="Performance and Optimization"></a>Performance and Optimization</h2><h3 id="How-would-you-identify-and-resolve-a-memory-leak-in-a-Java-application"><a href="#How-would-you-identify-and-resolve-a-memory-leak-in-a-Java-application" class="headerlink" title="How would you identify and resolve a memory leak in a Java application?"></a>How would you identify and resolve a memory leak in a Java application?</h3><p><strong>Reference Answer:</strong></p>
<p><strong>Identification Tools:</strong></p>
<ol>
<li><strong>JVisualVM</strong>: Visual profiler, heap dumps</li>
<li><strong>JProfiler</strong>: Commercial profiler</li>
<li><strong>Eclipse MAT</strong>: Memory Analyzer Tool</li>
<li><strong>JConsole</strong>: Built-in monitoring</li>
<li><strong>Application metrics</strong>: OutOfMemoryError frequency</li>
</ol>
<p><strong>Detection Signs:</strong></p>
<ul>
<li>Gradual memory increase over time</li>
<li>OutOfMemoryError exceptions</li>
<li>Increasing GC frequency&#x2F;duration</li>
<li>Application slowdown</li>
</ul>
<p><strong>Analysis Process:</strong></p>
<p><strong>1. Heap Dump Analysis:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jcmd &lt;pid&gt; GC.run_finalization</span><br><span class="line">jcmd &lt;pid&gt; VM.gc</span><br><span class="line">jmap -dump:format=b,file=heapdump.hprof &lt;pid&gt;</span><br></pre></td></tr></table></figure>

<p><strong>2. Common Leak Scenarios:</strong></p>
<p><strong>Static Collections:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LeakyClass</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Object&gt; cache = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(); <span class="comment">// Never cleared</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addToCache</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">        cache.add(obj); <span class="comment">// Memory leak!</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Listener Registration:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventPublisher</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;EventListener&gt; listeners = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addListener</span><span class="params">(EventListener listener)</span> &#123;</span><br><span class="line">        listeners.add(listener); <span class="comment">// If not removed, leak!</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeListener</span><span class="params">(EventListener listener)</span> &#123;</span><br><span class="line">        listeners.remove(listener); <span class="comment">// Often forgotten</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ThreadLocal Variables:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalLeak</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;ExpensiveObject&gt; threadLocal = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setThreadLocalValue</span><span class="params">()</span> &#123;</span><br><span class="line">        threadLocal.set(<span class="keyword">new</span> <span class="title class_">ExpensiveObject</span>()); <span class="comment">// Clear when done!</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cleanup</span><span class="params">()</span> &#123;</span><br><span class="line">        threadLocal.remove(); <span class="comment">// Essential in long-lived threads</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Resolution Strategies:</strong></p>
<ul>
<li>Use weak references where appropriate</li>
<li>Implement proper cleanup in finally blocks</li>
<li>Clear collections when no longer needed</li>
<li>Remove listeners in lifecycle methods</li>
<li>Use try-with-resources for automatic cleanup</li>
<li>Monitor object creation patterns</li>
</ul>
<h3 id="What-are-some-JVM-tuning-parameters-youve-used"><a href="#What-are-some-JVM-tuning-parameters-youve-used" class="headerlink" title="What are some JVM tuning parameters youve used?"></a>What are some JVM tuning parameters youve used?</h3><p><strong>Reference Answer:</strong></p>
<p><strong>Heap Memory:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-Xms2g          <span class="comment"># Initial heap size</span></span><br><span class="line">-Xmx8g          <span class="comment"># Maximum heap size</span></span><br><span class="line">-XX:NewRatio=3  <span class="comment"># Old/Young generation ratio</span></span><br><span class="line">-XX:MaxMetaspaceSize=256m  <span class="comment"># Metaspace limit</span></span><br></pre></td></tr></table></figure>

<p><strong>Garbage Collection:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># G1GC (recommended for large heaps)</span></span><br><span class="line">-XX:+UseG1GC</span><br><span class="line">-XX:MaxGCPauseMillis=200</span><br><span class="line">-XX:G1HeapRegionSize=16m</span><br><span class="line"></span><br><span class="line"><span class="comment"># Parallel GC (good throughput)</span></span><br><span class="line">-XX:+UseParallelGC</span><br><span class="line">-XX:ParallelGCThreads=8</span><br><span class="line"></span><br><span class="line"><span class="comment"># ZGC (ultra-low latency)</span></span><br><span class="line">-XX:+UseZGC</span><br><span class="line">-XX:+UnlockExperimentalVMOptions</span><br></pre></td></tr></table></figure>

<p><strong>GC Logging:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-Xlog:gc*:gc.log:<span class="keyword">time</span>,tags</span><br><span class="line">-XX:+UseGCLogFileRotation</span><br><span class="line">-XX:NumberOfGCLogFiles=5</span><br><span class="line">-XX:GCLogFileSize=100M</span><br></pre></td></tr></table></figure>

<p><strong>Performance Monitoring:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-XX:+PrintGCDetails</span><br><span class="line">-XX:+PrintGCTimeStamps</span><br><span class="line">-XX:+HeapDumpOnOutOfMemoryError</span><br><span class="line">-XX:HeapDumpPath=/path/to/dumps/</span><br></pre></td></tr></table></figure>

<p><strong>JIT Compilation:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-XX:+TieredCompilation</span><br><span class="line">-XX:CompileThreshold=10000</span><br><span class="line">-XX:+PrintCompilation</span><br></pre></td></tr></table></figure>

<p><strong>Common Tuning Scenarios:</strong></p>
<ul>
<li><strong>High throughput</strong>: Parallel GC, larger heap</li>
<li><strong>Low latency</strong>: G1GC or ZGC, smaller pause times</li>
<li><strong>Memory constrained</strong>: Smaller heap, compressed OOPs</li>
<li><strong>CPU intensive</strong>: More GC threads, tiered compilation</li>
</ul>
<h2 id="Modern-Java-Features"><a href="#Modern-Java-Features" class="headerlink" title="Modern Java Features"></a>Modern Java Features</h2><h3 id="Explain-streams-and-when-youd-use-them-vs-traditional-loops"><a href="#Explain-streams-and-when-youd-use-them-vs-traditional-loops" class="headerlink" title="Explain streams and when youd use them vs traditional loops."></a>Explain streams and when youd use them vs traditional loops.</h3><p><strong>Reference Answer:</strong></p>
<p><strong>Stream Characteristics:</strong></p>
<ul>
<li><strong>Functional</strong>: Declarative programming style</li>
<li><strong>Lazy</strong>: Operations executed only when terminal operation called</li>
<li><strong>Immutable</strong>: Original collection unchanged</li>
<li><strong>Chainable</strong>: Fluent API for operation composition</li>
</ul>
<p><strong>Stream Example:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; names = Arrays.asList(<span class="string">&quot;Alice&quot;</span>, <span class="string">&quot;Bob&quot;</span>, <span class="string">&quot;Charlie&quot;</span>, <span class="string">&quot;David&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Traditional loop</span></span><br><span class="line">List&lt;String&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (String name : names) &#123;</span><br><span class="line">    <span class="keyword">if</span> (name.length() &gt; <span class="number">4</span>) &#123;</span><br><span class="line">        result.add(name.toUpperCase());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Stream approach</span></span><br><span class="line">List&lt;String&gt; result = names.stream()</span><br><span class="line">    .filter(name -&gt; name.length() &gt; <span class="number">4</span>)</span><br><span class="line">    .map(String::toUpperCase)</span><br><span class="line">    .collect(Collectors.toList());</span><br></pre></td></tr></table></figure>

<p><strong>When to use Streams:</strong></p>
<ul>
<li><strong>Data transformation pipelines</strong></li>
<li><strong>Complex filtering&#x2F;mapping operations</strong></li>
<li><strong>Parallel processing</strong> (<code>.parallelStream()</code>)</li>
<li><strong>Functional programming style preferred</strong></li>
<li><strong>Readability</strong> over performance for complex operations</li>
</ul>
<p><strong>When to use Traditional Loops:</strong></p>
<ul>
<li><strong>Simple iterations</strong> without transformations</li>
<li><strong>Performance critical</strong> tight loops</li>
<li><strong>Early termination</strong> needed</li>
<li><strong>State modification</strong> during iteration</li>
<li><strong>Index-based</strong> operations</li>
</ul>
<p><strong>Performance Considerations:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Stream overhead for simple operations</span></span><br><span class="line">list.stream().forEach(System.out::println); <span class="comment">// Slower</span></span><br><span class="line">list.forEach(System.out::println);           <span class="comment">// Faster</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Streams excel at complex operations</span></span><br><span class="line">list.stream()</span><br><span class="line">    .filter(complex_predicate)</span><br><span class="line">    .map(expensive_transformation)</span><br><span class="line">    .sorted()</span><br><span class="line">    .limit(<span class="number">10</span>)</span><br><span class="line">    .collect(Collectors.toList()); <span class="comment">// More readable than equivalent loop</span></span><br></pre></td></tr></table></figure>

<h3 id="What-are-records-in-Java-14-and-when-would-you-use-them"><a href="#What-are-records-in-Java-14-and-when-would-you-use-them" class="headerlink" title="What are records in Java 14+ and when would you use them?"></a>What are records in Java 14+ and when would you use them?</h3><p><strong>Reference Answer:</strong></p>
<p><strong>Records Definition:</strong><br>Records are immutable data carriers that automatically generate boilerplate code.</p>
<p><strong>Basic Record:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">record</span> <span class="title class_">Person</span><span class="params">(String name, <span class="type">int</span> age, String email)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Automatically generates:</span></span><br><span class="line"><span class="comment">// - Constructor: Person(String name, int age, String email)</span></span><br><span class="line"><span class="comment">// - Accessors: name(), age(), email()</span></span><br><span class="line"><span class="comment">// - equals(), hashCode(), toString()</span></span><br><span class="line"><span class="comment">// - All fields are private final</span></span><br></pre></td></tr></table></figure>

<p><strong>Custom Methods:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">record</span> <span class="title class_">Point</span><span class="params">(<span class="type">double</span> x, <span class="type">double</span> y)</span> &#123;</span><br><span class="line">    <span class="comment">// Custom constructor with validation</span></span><br><span class="line">    <span class="keyword">public</span> Point &#123;</span><br><span class="line">        <span class="keyword">if</span> (x &lt; <span class="number">0</span> || y &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Coordinates must be positive&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Additional methods</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">distanceFromOrigin</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Math.sqrt(x * x + y * y);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Static factory method</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Point <span class="title function_">origin</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Point</span>(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>When to Use Records:</strong></p>
<ul>
<li><strong>Data Transfer Objects</strong> (DTOs)</li>
<li><strong>Configuration objects</strong></li>
<li><strong>API response&#x2F;request models</strong></li>
<li><strong>Value objects</strong> in domain modeling</li>
<li><strong>Tuple-like</strong> data structures</li>
<li><strong>Database result mapping</strong></li>
</ul>
<p><strong>Example Use Cases:</strong></p>
<p><strong>API Response:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">record</span> <span class="title class_">UserResponse</span><span class="params">(Long id, String username, String email, LocalDateTime createdAt)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Usage</span></span><br><span class="line"><span class="keyword">return</span> users.stream()</span><br><span class="line">    .map(user -&gt; <span class="keyword">new</span> <span class="title class_">UserResponse</span>(user.getId(), user.getUsername(), </span><br><span class="line">                                 user.getEmail(), user.getCreatedAt()))</span><br><span class="line">    .collect(Collectors.toList());</span><br></pre></td></tr></table></figure>

<p><strong>Configuration:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">record</span> <span class="title class_">DatabaseConfig</span><span class="params">(String url, String username, String password, </span></span><br><span class="line"><span class="params">                           <span class="type">int</span> maxConnections, Duration timeout)</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Limitations:</strong></p>
<ul>
<li>Cannot extend other classes (can implement interfaces)</li>
<li>All fields are implicitly final</li>
<li>Cannot declare instance fields beyond record components</li>
<li>Less flexibility than regular classes</li>
</ul>
<p><strong>Records vs Classes:</strong></p>
<ul>
<li><strong>Use Records</strong>: Immutable data, minimal behavior</li>
<li><strong>Use Classes</strong>: Mutable state, complex behavior, inheritance needed</li>
</ul>
<h2 id="System-Design-Integration"><a href="#System-Design-Integration" class="headerlink" title="System Design Integration"></a>System Design Integration</h2><h3 id="How-would-you-design-a-thread-safe-cache-with-TTL-time-to-live"><a href="#How-would-you-design-a-thread-safe-cache-with-TTL-time-to-live" class="headerlink" title="How would you design a thread-safe cache with TTL (time-to-live)?"></a>How would you design a thread-safe cache with TTL (time-to-live)?</h3><p><strong>Reference Answer:</strong></p>
<p><strong>Design Requirements:</strong></p>
<ul>
<li>Thread-safe concurrent access</li>
<li>Automatic expiration based on TTL</li>
<li>Efficient cleanup of expired entries</li>
<li>Good performance for reads and writes</li>
</ul>
<p><strong>Implementation:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TTLCache</span>&lt;K, V&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CacheEntry</span>&lt;V&gt; &#123;</span><br><span class="line">        <span class="keyword">final</span> V value;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> expirationTime;</span><br><span class="line">        </span><br><span class="line">        CacheEntry(V value, <span class="type">long</span> ttlMillis) &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">            <span class="built_in">this</span>.expirationTime = System.currentTimeMillis() + ttlMillis;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">boolean</span> <span class="title function_">isExpired</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> System.currentTimeMillis() &gt; expirationTime;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;K, CacheEntry&lt;V&gt;&gt; cache = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService cleanupExecutor;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> defaultTTL;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TTLCache</span><span class="params">(<span class="type">long</span> defaultTTLMillis, <span class="type">long</span> cleanupIntervalMillis)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.defaultTTL = defaultTTLMillis;</span><br><span class="line">        <span class="built_in">this</span>.cleanupExecutor = Executors.newSingleThreadScheduledExecutor(r -&gt; &#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r, <span class="string">&quot;TTLCache-Cleanup&quot;</span>);</span><br><span class="line">            t.setDaemon(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Schedule periodic cleanup</span></span><br><span class="line">        cleanupExecutor.scheduleAtFixedRate(<span class="built_in">this</span>::cleanup, </span><br><span class="line">            cleanupIntervalMillis, cleanupIntervalMillis, TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">        put(key, value, defaultTTL);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(K key, V value, <span class="type">long</span> ttlMillis)</span> &#123;</span><br><span class="line">        cache.put(key, <span class="keyword">new</span> <span class="title class_">CacheEntry</span>&lt;&gt;(value, ttlMillis));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> V <span class="title function_">get</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        CacheEntry&lt;V&gt; entry = cache.get(key);</span><br><span class="line">        <span class="keyword">if</span> (entry == <span class="literal">null</span> || entry.isExpired()) &#123;</span><br><span class="line">            cache.remove(key); <span class="comment">// Clean up expired entry</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> entry.value;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">containsKey</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> get(key) != <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        cache.remove(key);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span> &#123;</span><br><span class="line">        cache.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span> &#123;</span><br><span class="line">        cleanup(); <span class="comment">// Clean expired entries first</span></span><br><span class="line">        <span class="keyword">return</span> cache.size();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">cleanup</span><span class="params">()</span> &#123;</span><br><span class="line">        cache.entrySet().removeIf(entry -&gt; entry.getValue().isExpired());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span> &#123;</span><br><span class="line">        cleanupExecutor.shutdown();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!cleanupExecutor.awaitTermination(<span class="number">5</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">                cleanupExecutor.shutdownNow();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            cleanupExecutor.shutdownNow();</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Usage Example:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create cache with 5-minute default TTL, cleanup every minute</span></span><br><span class="line">TTLCache&lt;String, UserData&gt; userCache = <span class="keyword">new</span> <span class="title class_">TTLCache</span>&lt;&gt;(<span class="number">5</span> * <span class="number">60</span> * <span class="number">1000</span>, <span class="number">60</span> * <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Store with default TTL</span></span><br><span class="line">userCache.put(<span class="string">&quot;user123&quot;</span>, userData);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Store with custom TTL (10 minutes)</span></span><br><span class="line">userCache.put(<span class="string">&quot;session456&quot;</span>, sessionData, <span class="number">10</span> * <span class="number">60</span> * <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Retrieve</span></span><br><span class="line"><span class="type">UserData</span> <span class="variable">user</span> <span class="operator">=</span> userCache.get(<span class="string">&quot;user123&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>Alternative Approaches:</strong></p>
<ul>
<li><strong>Caffeine Cache</strong>: Production-ready with advanced features</li>
<li><strong>Guava Cache</strong>: Googles caching library</li>
<li><strong>Redis</strong>: External cache for distributed systems</li>
<li><strong>Chronicle Map</strong>: Off-heap storage for large datasets</li>
</ul>
<h3 id="Explain-how-youd-handle-database-connections-in-a-high-traffic-application"><a href="#Explain-how-youd-handle-database-connections-in-a-high-traffic-application" class="headerlink" title="Explain how youd handle database connections in a high-traffic application."></a>Explain how youd handle database connections in a high-traffic application.</h3><p><strong>Reference Answer:</strong></p>
<p><strong>Connection Pooling Strategy:</strong></p>
<p><strong>1. HikariCP Configuration (Recommended):</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">HikariConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HikariConfig</span>();</span><br><span class="line">        config.setJdbcUrl(<span class="string">&quot;jdbc:postgresql://localhost:5432/mydb&quot;</span>);</span><br><span class="line">        config.setUsername(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        config.setPassword(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Pool sizing</span></span><br><span class="line">        config.setMaximumPoolSize(<span class="number">20</span>);              <span class="comment">// Max connections</span></span><br><span class="line">        config.setMinimumIdle(<span class="number">5</span>);                   <span class="comment">// Min idle connections</span></span><br><span class="line">        config.setConnectionTimeout(<span class="number">30000</span>);         <span class="comment">// 30 seconds timeout</span></span><br><span class="line">        config.setIdleTimeout(<span class="number">600000</span>);              <span class="comment">// 10 minutes idle timeout</span></span><br><span class="line">        config.setMaxLifetime(<span class="number">1800000</span>);             <span class="comment">// 30 minutes max lifetime</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Performance tuning</span></span><br><span class="line">        config.setLeakDetectionThreshold(<span class="number">60000</span>);    <span class="comment">// 1 minute leak detection</span></span><br><span class="line">        config.setCachePrepStmts(<span class="literal">true</span>);</span><br><span class="line">        config.setPrepStmtCacheSize(<span class="number">250</span>);</span><br><span class="line">        config.setPrepStmtCacheSqlLimit(<span class="number">2048</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HikariDataSource</span>(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2. Connection Pool Sizing:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">connections = ((core_count * 2) + effective_spindle_count)</span><br><span class="line"></span><br><span class="line">For CPU-intensive: core_count * 2</span><br><span class="line">For I/O-intensive: higher multiplier (3-4x)</span><br><span class="line">Monitor and adjust based on actual usage</span><br></pre></td></tr></table></figure>

<p><strong>3. Transaction Management:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Transactional(readOnly = true)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">findById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userRepository.findById(id);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateUserAsync</span><span class="params">(Long id, UserData data)</span> &#123;</span><br><span class="line">        <span class="comment">// Runs in separate transaction</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userRepository.findById(id);</span><br><span class="line">        user.update(data);</span><br><span class="line">        userRepository.save(user);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Transactional(timeout = 30)</span> <span class="comment">// 30 seconds timeout</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bulkOperation</span><span class="params">(List&lt;User&gt; users)</span> &#123;</span><br><span class="line">        users.forEach(userRepository::save);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>4. Read&#x2F;Write Splitting:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseRoutingConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">routingDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">RoutingDataSource</span> <span class="variable">routingDataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RoutingDataSource</span>();</span><br><span class="line">        </span><br><span class="line">        Map&lt;Object, Object&gt; targetDataSources = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        targetDataSources.put(<span class="string">&quot;write&quot;</span>, writeDataSource());</span><br><span class="line">        targetDataSources.put(<span class="string">&quot;read&quot;</span>, readDataSource());</span><br><span class="line">        </span><br><span class="line">        routingDataSource.setTargetDataSources(targetDataSources);</span><br><span class="line">        routingDataSource.setDefaultTargetDataSource(writeDataSource());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> routingDataSource;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">writeDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Master database configuration</span></span><br><span class="line">        <span class="keyword">return</span> createDataSource(<span class="string">&quot;jdbc:postgresql://master:5432/mydb&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">readDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Replica database configuration</span></span><br><span class="line">        <span class="keyword">return</span> createDataSource(<span class="string">&quot;jdbc:postgresql://replica:5432/mydb&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RoutingDataSource</span> <span class="keyword">extends</span> <span class="title class_">AbstractRoutingDataSource</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">determineCurrentLookupKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> TransactionSynchronizationManager.isCurrentTransactionReadOnly() ? <span class="string">&quot;read&quot;</span> : <span class="string">&quot;write&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>5. Monitoring and Health Checks:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseHealthIndicator</span> <span class="keyword">implements</span> <span class="title class_">HealthIndicator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Health <span class="title function_">health</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (connection.isValid(<span class="number">2</span>)) &#123; <span class="comment">// 2 second timeout</span></span><br><span class="line">                <span class="keyword">return</span> Health.up()</span><br><span class="line">                    .withDetail(<span class="string">&quot;database&quot;</span>, <span class="string">&quot;Available&quot;</span>)</span><br><span class="line">                    .withDetail(<span class="string">&quot;active-connections&quot;</span>, getActiveConnections())</span><br><span class="line">                    .build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> Health.down()</span><br><span class="line">                .withDetail(<span class="string">&quot;database&quot;</span>, <span class="string">&quot;Unavailable&quot;</span>)</span><br><span class="line">                .withException(e)</span><br><span class="line">                .build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Health.down().withDetail(<span class="string">&quot;database&quot;</span>, <span class="string">&quot;Connection invalid&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getActiveConnections</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (dataSource <span class="keyword">instanceof</span> HikariDataSource) &#123;</span><br><span class="line">            <span class="keyword">return</span> ((HikariDataSource) dataSource).getHikariPoolMXBean().getActiveConnections();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>6. Best Practices for High Traffic:</strong></p>
<p><strong>Connection Management:</strong></p>
<ul>
<li>Always use connection pooling</li>
<li>Set appropriate timeouts</li>
<li>Monitor pool metrics</li>
<li>Use read replicas for read-heavy workloads</li>
</ul>
<p><strong>Query Optimization:</strong></p>
<ul>
<li>Use prepared statements</li>
<li>Implement proper indexing</li>
<li>Cache frequently accessed data</li>
<li>Use batch operations for bulk updates</li>
</ul>
<p><strong>Resilience Patterns:</strong></p>
<ul>
<li>Circuit breaker for database failures</li>
<li>Retry logic with exponential backoff</li>
<li>Graceful degradation when database unavailable</li>
<li>Database failover strategies</li>
</ul>
<p><strong>Performance Monitoring:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EventListener</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleConnectionPoolMetrics</span><span class="params">(ConnectionPoolMetricsEvent event)</span> &#123;</span><br><span class="line">    logger.info(<span class="string">&quot;Active connections: &#123;&#125;, Idle: &#123;&#125;, Waiting: &#123;&#125;&quot;</span>, </span><br><span class="line">        event.getActive(), event.getIdle(), event.getWaiting());</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (event.getActive() &gt; event.getMaxPool() * <span class="number">0.8</span>) &#123;</span><br><span class="line">        alertingService.sendAlert(<span class="string">&quot;High database connection usage&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This comprehensive approach ensures database connections are efficiently managed in high-traffic scenarios while maintaining performance and reliability.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/07/02/Design-FinTech-AI-Workflow-and-Chat-System/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/02/Design-FinTech-AI-Workflow-and-Chat-System/" class="post-title-link" itemprop="url">Design FinTech AI Workflow and Chat System</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-07-02 17:39:48" itemprop="dateCreated datePublished" datetime="2025-07-02T17:39:48+08:00">2025-07-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-07-03 20:24:11" itemprop="dateModified" datetime="2025-07-03T20:24:11+08:00">2025-07-03</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>The FinTech AI Workflow and Chat System represents a comprehensive lending platform that combines traditional workflow automation with artificial intelligence capabilities. This system streamlines the personal loan application process through intelligent automation while maintaining human oversight at critical decision points.</p>
<p>The architecture employs a microservices approach, integrating multiple AI technologies including Large Language Models (LLMs), Retrieval-Augmented Generation (RAG), and intelligent agents to create a seamless lending experience. The system processes over 2000 concurrent conversations with an average response time of 30 seconds, demonstrating enterprise-grade performance.</p>
<p><strong>Key Business Benefits:</strong></p>
<ul>
<li><strong>Reduced Processing Time</strong>: From days to minutes for loan approvals</li>
<li><strong>Enhanced Accuracy</strong>: AI-powered risk assessment reduces default rates</li>
<li><strong>Improved Customer Experience</strong>: 24&#x2F;7 availability with multi-modal interaction</li>
<li><strong>Regulatory Compliance</strong>: Built-in compliance checks and audit trails</li>
<li><strong>Cost Efficiency</strong>: Automated workflows reduce operational costs by 60%</li>
</ul>
<p><strong>Key Interview Question</strong>: <em>How would you design a scalable FinTech system that balances automation with regulatory compliance?</em></p>
<p><strong>Reference Answer</strong>: The system employs a layered architecture with clear separation of concerns. The workflow engine handles business logic while maintaining audit trails for regulatory compliance. AI components augment human decision-making rather than replacing it entirely, ensuring transparency and accountability. The microservices architecture allows for independent scaling of components based on demand.</p>
<h3 id="Architecture-Design"><a href="#Architecture-Design" class="headerlink" title="Architecture Design"></a>Architecture Design</h3><pre>
<code class="mermaid">
flowchart TB
subgraph &quot;Frontend Layer&quot;
    A[ChatWebUI] --&gt; B[React&#x2F;Vue Components]
    B --&gt; C[Multi-Modal Input Handler]
end

subgraph &quot;Gateway Layer&quot;
    D[Higress AI Gateway] --&gt; E[Load Balancer]
    E --&gt; F[Multi-Model Provider]
    F --&gt; G[Context Memory - mem0]
end

subgraph &quot;Service Layer&quot;
    H[ConversationService] --&gt; I[AIWorkflowEngineService]
    I --&gt; J[WorkflowEngineService]
    H --&gt; K[KnowledgeBaseService]
end

subgraph &quot;AI Layer&quot;
    L[LLM Providers] --&gt; M[ReAct Pattern Engine]
    M --&gt; N[MCP Server Agents]
    N --&gt; O[RAG System]
end

subgraph &quot;External Systems&quot;
    P[BankCreditSystem]
    Q[TaxSystem]
    R[SocialSecuritySystem]
    S[Rule Engine]
end

subgraph &quot;Configuration&quot;
    T[Nacos Config Center]
    U[Prompt Templates]
end

A --&gt; D
D --&gt; H
H --&gt; L
I --&gt; P
I --&gt; Q
I --&gt; R
J --&gt; S
K --&gt; O
T --&gt; U
U --&gt; L
</code>
</pre>

<p>The architecture follows a distributed microservices pattern with clear separation between presentation, business logic, and data layers. The AI Gateway serves as the entry point for all AI-related operations, providing load balancing and context management across multiple LLM providers.</p>
<h2 id="Core-Components"><a href="#Core-Components" class="headerlink" title="Core Components"></a>Core Components</h2><h3 id="WorkflowEngineService"><a href="#WorkflowEngineService" class="headerlink" title="WorkflowEngineService"></a>WorkflowEngineService</h3><p>The WorkflowEngineService serves as the backbone of the lending process, orchestrating the three-stage review workflow: Initial Review, Review, and Final Review.</p>
<p><strong>Core Responsibilities:</strong></p>
<ul>
<li>Workflow orchestration and state management</li>
<li>External system integration</li>
<li>Business rule execution</li>
<li>Audit trail maintenance</li>
<li>SLA monitoring and enforcement</li>
</ul>
<p><strong>Implementation Architecture:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WorkflowEngineService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoanApplicationRepository loanRepo;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ExternalIntegrationService integrationService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RuleEngineService ruleEngine;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> NotificationService notificationService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> WorkflowResult <span class="title function_">processLoanApplication</span><span class="params">(LoanApplication application)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Initialize workflow</span></span><br><span class="line">            <span class="type">WorkflowInstance</span> <span class="variable">workflow</span> <span class="operator">=</span> initializeWorkflow(application);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Execute initial review</span></span><br><span class="line">            <span class="type">InitialReviewResult</span> <span class="variable">initialResult</span> <span class="operator">=</span> executeInitialReview(application);</span><br><span class="line">            workflow.updateStage(WorkflowStage.INITIAL_REVIEW, initialResult);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (initialResult.isApproved()) &#123;</span><br><span class="line">                <span class="comment">// Proceed to detailed review</span></span><br><span class="line">                <span class="type">DetailedReviewResult</span> <span class="variable">detailedResult</span> <span class="operator">=</span> executeDetailedReview(application);</span><br><span class="line">                workflow.updateStage(WorkflowStage.DETAILED_REVIEW, detailedResult);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (detailedResult.isApproved()) &#123;</span><br><span class="line">                    <span class="comment">// Final review</span></span><br><span class="line">                    <span class="type">FinalReviewResult</span> <span class="variable">finalResult</span> <span class="operator">=</span> executeFinalReview(application);</span><br><span class="line">                    workflow.updateStage(WorkflowStage.FINAL_REVIEW, finalResult);</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">return</span> WorkflowResult.builder()</span><br><span class="line">                        .status(finalResult.isApproved() ? </span><br><span class="line">                            WorkflowStatus.APPROVED : WorkflowStatus.REJECTED)</span><br><span class="line">                        .workflowId(workflow.getId())</span><br><span class="line">                        .build();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> WorkflowResult.builder()</span><br><span class="line">                .status(WorkflowStatus.REJECTED)</span><br><span class="line">                .workflowId(workflow.getId())</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Workflow processing failed&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> handleWorkflowError(application, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> InitialReviewResult <span class="title function_">executeInitialReview</span><span class="params">(LoanApplication application)</span> &#123;</span><br><span class="line">        <span class="comment">// Validate basic information</span></span><br><span class="line">        <span class="type">ValidationResult</span> <span class="variable">validation</span> <span class="operator">=</span> validateBasicInfo(application);</span><br><span class="line">        <span class="keyword">if</span> (!validation.isValid()) &#123;</span><br><span class="line">            <span class="keyword">return</span> InitialReviewResult.rejected(validation.getErrors());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check credit score</span></span><br><span class="line">        <span class="type">CreditScoreResult</span> <span class="variable">creditScore</span> <span class="operator">=</span> integrationService.getCreditScore(</span><br><span class="line">            application.getApplicantId());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Apply initial screening rules</span></span><br><span class="line">        <span class="type">RuleResult</span> <span class="variable">ruleResult</span> <span class="operator">=</span> ruleEngine.evaluateInitialRules(</span><br><span class="line">            application, creditScore);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> InitialReviewResult.builder()</span><br><span class="line">            .approved(ruleResult.isApproved())</span><br><span class="line">            .creditScore(creditScore.getScore())</span><br><span class="line">            .reasons(ruleResult.getReasons())</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Three-Stage Review Process:</strong></p>
<ol>
<li><p><strong>Initial Review</strong>: Automated screening based on basic criteria</p>
<ul>
<li>Identity verification</li>
<li>Credit score check</li>
<li>Basic eligibility validation</li>
<li>Fraud detection algorithms</li>
</ul>
</li>
<li><p><strong>Detailed Review</strong>: Comprehensive analysis of financial capacity</p>
<ul>
<li>Income verification through tax systems</li>
<li>Employment history validation</li>
<li>Debt-to-income ratio calculation</li>
<li>Collateral assessment (if applicable)</li>
</ul>
</li>
<li><p><strong>Final Review</strong>: Human oversight and final approval</p>
<ul>
<li>Risk assessment confirmation</li>
<li>Regulatory compliance check</li>
<li>Manual review of edge cases</li>
<li>Final approval or rejection</li>
</ul>
</li>
</ol>
<p><strong>External System Integration:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExternalIntegrationService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BankCreditSystemClient bankCreditClient;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TaxSystemClient taxClient;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SocialSecuritySystemClient socialSecurityClient;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Retryable(value = &#123;Exception.class&#125;, maxAttempts = 3)</span></span><br><span class="line">    <span class="keyword">public</span> CreditScoreResult <span class="title function_">getCreditScore</span><span class="params">(String applicantId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> bankCreditClient.getCreditScore(applicantId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Retryable(value = &#123;Exception.class&#125;, maxAttempts = 3)</span></span><br><span class="line">    <span class="keyword">public</span> TaxInformationResult <span class="title function_">getTaxInformation</span><span class="params">(String applicantId, <span class="type">int</span> years)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> taxClient.getTaxInformation(applicantId, years);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Retryable(value = &#123;Exception.class&#125;, maxAttempts = 3)</span></span><br><span class="line">    <span class="keyword">public</span> SocialSecurityResult <span class="title function_">getSocialSecurityInfo</span><span class="params">(String applicantId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> socialSecurityClient.getSocialSecurityInfo(applicantId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Key Interview Question</strong>: <em>How do you handle transaction consistency across multiple external system calls in a workflow?</em></p>
<p><strong>Reference Answer</strong>: The system uses the Saga pattern for distributed transactions. Each step in the workflow is designed as a compensable transaction. If a step fails, the system executes compensation actions to maintain consistency. For example, if the final review fails after initial approvals, the system automatically triggers cleanup processes to revert any provisional approvals.</p>
<h3 id="AIWorkflowEngineService"><a href="#AIWorkflowEngineService" class="headerlink" title="AIWorkflowEngineService"></a>AIWorkflowEngineService</h3><p>The AIWorkflowEngineService leverages Spring AI to provide intelligent automation of the lending process, reducing manual intervention while maintaining accuracy.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Sl4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AIWorkflowEngineService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel chatModel;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PromptTemplateService promptTemplateService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WorkflowEngineService traditionalWorkflowService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> AIWorkflowResult <span class="title function_">processLoanApplicationWithAI</span><span class="params">(LoanApplication application)</span> &#123;</span><br><span class="line">        <span class="comment">// First, gather all relevant data</span></span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> gatherApplicationContext(application);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Use AI to perform initial assessment</span></span><br><span class="line">        <span class="type">AIAssessmentResult</span> <span class="variable">aiAssessment</span> <span class="operator">=</span> performAIAssessment(context);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Decide whether to proceed with full automated flow or human review</span></span><br><span class="line">        <span class="keyword">if</span> (aiAssessment.getConfidenceScore() &gt; <span class="number">0.85</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> processAutomatedFlow(context, aiAssessment);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> processHybridFlow(context, aiAssessment);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> AIAssessmentResult <span class="title function_">performAIAssessment</span><span class="params">(ApplicationContext context)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">promptTemplate</span> <span class="operator">=</span> promptTemplateService.getTemplate(<span class="string">&quot;loan_assessment&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        Map&lt;String, Object&gt; variables = Map.of(</span><br><span class="line">            <span class="string">&quot;applicantData&quot;</span>, context.getApplicantData(),</span><br><span class="line">            <span class="string">&quot;creditHistory&quot;</span>, context.getCreditHistory(),</span><br><span class="line">            <span class="string">&quot;financialData&quot;</span>, context.getFinancialData()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="type">Prompt</span> <span class="variable">prompt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PromptTemplate</span>(promptTemplate, variables).create();</span><br><span class="line">        <span class="type">ChatResponse</span> <span class="variable">response</span> <span class="operator">=</span> chatModel.call(prompt);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> parseAIResponse(response.getResult().getOutput().getContent());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> AIAssessmentResult <span class="title function_">parseAIResponse</span><span class="params">(String aiResponse)</span> &#123;</span><br><span class="line">        <span class="comment">// Parse structured AI response</span></span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> mapper.readValue(aiResponse, AIAssessmentResult.class);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Failed to parse AI response&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> AIAssessmentResult.lowConfidence();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Key Interview Question</strong>: <em>How do you ensure AI decisions are explainable and auditable in a regulated financial environment?</em></p>
<p><strong>Reference Answer</strong>: The system maintains detailed audit logs for every AI decision, including the input data, prompt templates used, model responses, and confidence scores. Each AI assessment includes reasoning chains that explain the decision logic. For regulatory compliance, the system can replay any decision by re-running the same prompt with the same input data, ensuring reproducibility and transparency.</p>
<h3 id="ChatWebUI"><a href="#ChatWebUI" class="headerlink" title="ChatWebUI"></a>ChatWebUI</h3><p>The ChatWebUI serves as the primary interface for user interaction, supporting multi-modal communication including text, files, images, and audio.</p>
<p><strong>Key Features:</strong></p>
<ul>
<li><strong>Multi-Modal Input</strong>: Text, voice, image, and document upload</li>
<li><strong>Real-Time Chat</strong>: WebSocket-based instant messaging</li>
<li><strong>Progressive Web App</strong>: Mobile-responsive design</li>
<li><strong>Accessibility</strong>: WCAG 2.1 compliant interface</li>
<li><strong>Internationalization</strong>: Multi-language support</li>
</ul>
<p><strong>React-based Implementation:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/chat&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ConversationService conversationService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> FileProcessingService fileProcessingService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/message&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;ChatResponse&gt; <span class="title function_">sendMessage</span><span class="params">(<span class="meta">@RequestBody</span> ChatRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ChatResponse</span> <span class="variable">response</span> <span class="operator">=</span> conversationService.processMessage(request);</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.ok(response);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span><br><span class="line">                .body(ChatResponse.error(<span class="string">&quot;Failed to process message&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;FileUploadResponse&gt; <span class="title function_">uploadFile</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;conversationId&quot;)</span> String conversationId)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">FileProcessingResult</span> <span class="variable">result</span> <span class="operator">=</span> fileProcessingService.processFile(</span><br><span class="line">                file, conversationId);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.ok(FileUploadResponse.builder()</span><br><span class="line">                .fileId(result.getFileId())</span><br><span class="line">                .extractedText(result.getExtractedText())</span><br><span class="line">                .processingStatus(result.getStatus())</span><br><span class="line">                .build());</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span><br><span class="line">                .body(FileUploadResponse.error(<span class="string">&quot;File processing failed&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/conversation/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;ConversationHistory&gt; <span class="title function_">getConversationHistory</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String id)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">ConversationHistory</span> <span class="variable">history</span> <span class="operator">=</span> conversationService.getConversationHistory(id);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(history);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ConversationService"><a href="#ConversationService" class="headerlink" title="ConversationService"></a>ConversationService</h3><p>The ConversationService handles multi-modal customer interactions, supporting text, file uploads, images, and audio processing.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@sl4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConversationService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> KnowledgeBaseService knowledgeBaseService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AIWorkflowEngineService aiWorkflowService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ContextMemoryService contextMemoryService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ConversationResponse <span class="title function_">processMessage</span><span class="params">(ConversationRequest request)</span> &#123;</span><br><span class="line">        <span class="comment">// Retrieve conversation context</span></span><br><span class="line">        <span class="type">ConversationContext</span> <span class="variable">context</span> <span class="operator">=</span> contextMemoryService.getContext(</span><br><span class="line">            request.getSessionId());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Process multi-modal input</span></span><br><span class="line">        <span class="type">ProcessedInput</span> <span class="variable">processedInput</span> <span class="operator">=</span> processMultiModalInput(request);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Classify intent using ReAct pattern</span></span><br><span class="line">        <span class="type">IntentClassification</span> <span class="variable">intent</span> <span class="operator">=</span> classifyIntent(processedInput, context);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span> (intent.getType()) &#123;</span><br><span class="line">            <span class="keyword">case</span> LOAN_APPLICATION:</span><br><span class="line">                <span class="keyword">return</span> handleLoanApplication(processedInput, context);</span><br><span class="line">            <span class="keyword">case</span> KNOWLEDGE_QUERY:</span><br><span class="line">                <span class="keyword">return</span> handleKnowledgeQuery(processedInput, context);</span><br><span class="line">            <span class="keyword">case</span> DOCUMENT_UPLOAD:</span><br><span class="line">                <span class="keyword">return</span> handleDocumentUpload(processedInput, context);</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> handleGeneralChat(processedInput, context);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> ProcessedInput <span class="title function_">processMultiModalInput</span><span class="params">(ConversationRequest request)</span> &#123;</span><br><span class="line">        ProcessedInput.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> ProcessedInput.builder()</span><br><span class="line">            .sessionId(request.getSessionId())</span><br><span class="line">            .timestamp(Instant.now());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Process text</span></span><br><span class="line">        <span class="keyword">if</span> (request.getText() != <span class="literal">null</span>) &#123;</span><br><span class="line">            builder.text(request.getText());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Process files</span></span><br><span class="line">        <span class="keyword">if</span> (request.getFiles() != <span class="literal">null</span>) &#123;</span><br><span class="line">            List&lt;ProcessedFile&gt; processedFiles = request.getFiles().stream()</span><br><span class="line">                .map(<span class="built_in">this</span>::processFile)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">            builder.files(processedFiles);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Process images</span></span><br><span class="line">        <span class="keyword">if</span> (request.getImages() != <span class="literal">null</span>) &#123;</span><br><span class="line">            List&lt;ProcessedImage&gt; processedImages = request.getImages().stream()</span><br><span class="line">                .map(<span class="built_in">this</span>::processImage)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">            builder.images(processedImages);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="KnowledgeBaseService"><a href="#KnowledgeBaseService" class="headerlink" title="KnowledgeBaseService"></a>KnowledgeBaseService</h3><p>The KnowledgeBaseService implements a comprehensive RAG system for financial domain knowledge, supporting various document formats and providing contextually relevant responses.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@sl4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KnowledgeBaseService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> VectorStoreService vectorStoreService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DocumentParsingService documentParsingService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmbeddingModel embeddingModel;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel chatModel;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> KnowledgeResponse <span class="title function_">queryKnowledge</span><span class="params">(String query, ConversationContext context)</span> &#123;</span><br><span class="line">        <span class="comment">// Generate embedding for the query</span></span><br><span class="line">        <span class="type">EmbeddingRequest</span> <span class="variable">embeddingRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EmbeddingRequest</span>(</span><br><span class="line">            List.of(query), EmbeddingOptions.EMPTY);</span><br><span class="line">        <span class="type">EmbeddingResponse</span> <span class="variable">embeddingResponse</span> <span class="operator">=</span> embeddingModel.call(embeddingRequest);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Retrieve relevant documents</span></span><br><span class="line">        List&lt;Document&gt; relevantDocs = vectorStoreService.similaritySearch(</span><br><span class="line">            SearchRequest.query(query)</span><br><span class="line">                .withTopK(<span class="number">5</span>)</span><br><span class="line">                .withSimilarityThreshold(<span class="number">0.7</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Generate contextual response</span></span><br><span class="line">        <span class="keyword">return</span> generateContextualResponse(query, relevantDocs, context);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">indexDocument</span><span class="params">(MultipartFile file)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Parse document based on format</span></span><br><span class="line">            <span class="type">ParsedDocument</span> <span class="variable">parsedDoc</span> <span class="operator">=</span> documentParsingService.parse(file);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Split into chunks</span></span><br><span class="line">            List&lt;DocumentChunk&gt; chunks = splitDocument(parsedDoc);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Generate embeddings and store</span></span><br><span class="line">            <span class="keyword">for</span> (DocumentChunk chunk : chunks) &#123;</span><br><span class="line">                <span class="type">EmbeddingRequest</span> <span class="variable">embeddingRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EmbeddingRequest</span>(</span><br><span class="line">                    List.of(chunk.getContent()), EmbeddingOptions.EMPTY);</span><br><span class="line">                <span class="type">EmbeddingResponse</span> <span class="variable">embeddingResponse</span> <span class="operator">=</span> embeddingModel.call(embeddingRequest);</span><br><span class="line">                </span><br><span class="line">                <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Document</span>(chunk.getContent(), </span><br><span class="line">                    Map.of(<span class="string">&quot;source&quot;</span>, file.getOriginalFilename(),</span><br><span class="line">                           <span class="string">&quot;chunk_id&quot;</span>, chunk.getId()));</span><br><span class="line">                document.setEmbedding(embeddingResponse.getResults().get(<span class="number">0</span>).getOutput());</span><br><span class="line">                </span><br><span class="line">                vectorStoreService.add(List.of(document));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Failed to index document: &#123;&#125;&quot;</span>, file.getOriginalFilename(), e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DocumentIndexingException</span>(<span class="string">&quot;Failed to index document&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> List&lt;DocumentChunk&gt; <span class="title function_">splitDocument</span><span class="params">(ParsedDocument parsedDoc)</span> &#123;</span><br><span class="line">        <span class="comment">// Implement intelligent chunking based on document structure</span></span><br><span class="line">        <span class="keyword">return</span> DocumentChunker.builder()</span><br><span class="line">            .chunkSize(<span class="number">1000</span>)</span><br><span class="line">            .chunkOverlap(<span class="number">200</span>)</span><br><span class="line">            .respectSentenceBoundaries(<span class="literal">true</span>)</span><br><span class="line">            .respectParagraphBoundaries(<span class="literal">true</span>)</span><br><span class="line">            .build()</span><br><span class="line">            .split(parsedDoc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Key-Technologies"><a href="#Key-Technologies" class="headerlink" title="Key Technologies"></a>Key Technologies</h2><h3 id="LLM-fine-tuning-with-Financial-data"><a href="#LLM-fine-tuning-with-Financial-data" class="headerlink" title="LLM fine-tuning with Financial data"></a>LLM fine-tuning with Financial data</h3><p>Fine-tuning Large Language Models with domain-specific financial data enhances their understanding of financial concepts, regulations, and terminology.</p>
<p><strong>Fine-tuning Strategy:</strong></p>
<ul>
<li><strong>Base Model Selection</strong>: Choose appropriate foundation models (GPT-4, Claude, or Llama)</li>
<li><strong>Dataset Preparation</strong>: Curate high-quality financial datasets</li>
<li><strong>Training Pipeline</strong>: Implement efficient fine-tuning workflows</li>
<li><strong>Evaluation Metrics</strong>: Define domain-specific evaluation criteria</li>
<li><strong>Continuous Learning</strong>: Update models with new financial data</li>
</ul>
<p><strong>Implementation Example:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FinancialLLMFineTuner</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ModelTrainingService trainingService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DatasetManager datasetManager;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ModelEvaluationService evaluationService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0 0 2 * * SUN&quot;)</span> <span class="comment">// Weekly training</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">scheduledFineTuning</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Prepare training dataset</span></span><br><span class="line">            <span class="type">FinancialDataset</span> <span class="variable">dataset</span> <span class="operator">=</span> datasetManager.prepareFinancialDataset();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Configure training parameters</span></span><br><span class="line">            <span class="type">TrainingConfig</span> <span class="variable">config</span> <span class="operator">=</span> TrainingConfig.builder()</span><br><span class="line">                .baseModel(<span class="string">&quot;gpt-4&quot;</span>)</span><br><span class="line">                .learningRate(<span class="number">0.0001</span>)</span><br><span class="line">                .batchSize(<span class="number">16</span>)</span><br><span class="line">                .epochs(<span class="number">3</span>)</span><br><span class="line">                .warmupSteps(<span class="number">100</span>)</span><br><span class="line">                .evaluationStrategy(EvaluationStrategy.STEPS)</span><br><span class="line">                .evaluationSteps(<span class="number">500</span>)</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Start fine-tuning</span></span><br><span class="line">            <span class="type">TrainingResult</span> <span class="variable">result</span> <span class="operator">=</span> trainingService.fineTuneModel(config, dataset);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Evaluate model performance</span></span><br><span class="line">            <span class="type">EvaluationResult</span> <span class="variable">evaluation</span> <span class="operator">=</span> evaluationService.evaluate(</span><br><span class="line">                result.getModelId(), dataset.getTestSet());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Deploy if performance meets criteria</span></span><br><span class="line">            <span class="keyword">if</span> (evaluation.getFinancialAccuracy() &gt; <span class="number">0.95</span>) &#123;</span><br><span class="line">                deployModel(result.getModelId());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Fine-tuning failed&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">deployModel</span><span class="params">(String modelId)</span> &#123;</span><br><span class="line">        <span class="comment">// Implement model deployment logic</span></span><br><span class="line">        <span class="comment">// Include A/B testing for gradual rollout</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Multi-Modal-Message-Processing"><a href="#Multi-Modal-Message-Processing" class="headerlink" title="Multi-Modal Message Processing"></a>Multi-Modal Message Processing</h3><p>The system processes diverse input types, including text, images, audio, and documents. Each modality is handled by specialized processors that extract relevant information and convert it into a unified format.</p>
<h4 id="MultiModalProcessor"><a href="#MultiModalProcessor" class="headerlink" title="MultiModalProcessor"></a>MultiModalProcessor</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiModalProcessor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AudioTranscriptionService audioTranscriptionService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ImageAnalysisService imageAnalysisService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DocumentExtractionService documentExtractionService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ProcessedInput <span class="title function_">processInput</span><span class="params">(MultiModalInput input)</span> &#123;</span><br><span class="line">        ProcessedInput.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> ProcessedInput.builder();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Process audio to text</span></span><br><span class="line">        <span class="keyword">if</span> (input.hasAudio()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">transcription</span> <span class="operator">=</span> audioTranscriptionService.transcribe(input.getAudio());</span><br><span class="line">            builder.transcription(transcription);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Process images</span></span><br><span class="line">        <span class="keyword">if</span> (input.hasImages()) &#123;</span><br><span class="line">            List&lt;ImageAnalysisResult&gt; imageResults = input.getImages().stream()</span><br><span class="line">                .map(imageAnalysisService::analyzeImage)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">            builder.imageAnalysis(imageResults);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Process documents</span></span><br><span class="line">        <span class="keyword">if</span> (input.hasDocuments()) &#123;</span><br><span class="line">            List&lt;ExtractedContent&gt; documentContents = input.getDocuments().stream()</span><br><span class="line">                .map(documentExtractionService::extractContent)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">            builder.documentContents(documentContents);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Multi-Format-Document-Processing"><a href="#Multi-Format-Document-Processing" class="headerlink" title="Multi-Format Document Processing"></a>Multi-Format Document Processing</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DocumentProcessor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PdfProcessor pdfProcessor;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ExcelProcessor excelProcessor;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WordProcessor wordProcessor;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TextSplitter textSplitter;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> List&lt;Document&gt; <span class="title function_">processDocument</span><span class="params">(MultipartFile file)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> file.getOriginalFilename();</span><br><span class="line">        <span class="type">String</span> <span class="variable">contentType</span> <span class="operator">=</span> file.getContentType();</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> <span class="keyword">switch</span> (contentType) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;application/pdf&quot;</span> -&gt; pdfProcessor.extractText(file);</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot;</span> -&gt; </span><br><span class="line">                excelProcessor.extractText(file);</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;application/vnd.openxmlformats-officedocument.wordprocessingml.document&quot;</span> -&gt; </span><br><span class="line">                wordProcessor.extractText(file);</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;text/plain&quot;</span> -&gt; <span class="keyword">new</span> <span class="title class_">String</span>(file.getBytes(), StandardCharsets.UTF_8);</span><br><span class="line">            <span class="keyword">default</span> -&gt; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedFileTypeException</span>(<span class="string">&quot;Unsupported file type: &quot;</span> + contentType);</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Split content into chunks</span></span><br><span class="line">        List&lt;String&gt; chunks = textSplitter.splitText(content);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Create documents</span></span><br><span class="line">        <span class="keyword">return</span> chunks.stream()</span><br><span class="line">            .map(chunk -&gt; Document.builder()</span><br><span class="line">                .content(chunk)</span><br><span class="line">                .metadata(Map.of(</span><br><span class="line">                    <span class="string">&quot;filename&quot;</span>, filename,</span><br><span class="line">                    <span class="string">&quot;content_type&quot;</span>, contentType,</span><br><span class="line">                    <span class="string">&quot;chunk_size&quot;</span>, String.valueOf(chunk.length())</span><br><span class="line">                ))</span><br><span class="line">                .build())</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Key Interview Question</strong>: <em>How do you handle different file formats and ensure consistent processing across modalities?</em></p>
<p><strong>Reference Answer</strong>: The system uses a plugin-based architecture where each file type has a dedicated processor. Common formats like PDF, DOCX, and images are handled by specialized libraries (Apache PDFBox, Apache POI, etc.). For audio, we use speech-to-text services. All processors output to a common <code>ProcessedInput</code> format, ensuring consistency downstream. The system is extensible - new processors can be added without modifying core logic.</p>
<h3 id="RAG-Implementation-for-Knowledge-Base"><a href="#RAG-Implementation-for-Knowledge-Base" class="headerlink" title="RAG Implementation for Knowledge Base"></a>RAG Implementation for Knowledge Base</h3><p>The RAG system combines vector search with contextual generation to provide accurate, relevant responses about financial topics.</p>
<h4 id="RAGService"><a href="#RAGService" class="headerlink" title="RAGService"></a>RAGService</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RAGService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> VectorStoreService vectorStore;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel chatModel;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PromptTemplateService promptTemplateService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> RAGResponse <span class="title function_">generateResponse</span><span class="params">(String query, ConversationContext context)</span> &#123;</span><br><span class="line">        <span class="comment">// Step 1: Retrieve relevant documents</span></span><br><span class="line">        List&lt;Document&gt; relevantDocs = retrieveRelevantDocuments(query);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Step 2: Rank and filter documents</span></span><br><span class="line">        List&lt;Document&gt; rankedDocs = rankDocuments(relevantDocs, query, context);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Step 3: Generate response with context</span></span><br><span class="line">        <span class="keyword">return</span> generateWithContext(query, rankedDocs, context);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> List&lt;Document&gt; <span class="title function_">rankDocuments</span><span class="params">(List&lt;Document&gt; documents, </span></span><br><span class="line"><span class="params">                                       String query, </span></span><br><span class="line"><span class="params">                                       ConversationContext context)</span> &#123;</span><br><span class="line">        <span class="comment">// Implement re-ranking based on:</span></span><br><span class="line">        <span class="comment">// - Semantic similarity</span></span><br><span class="line">        <span class="comment">// - Recency of information</span></span><br><span class="line">        <span class="comment">// - User&#x27;s conversation history</span></span><br><span class="line">        <span class="comment">// - Domain-specific relevance</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> documents.stream()</span><br><span class="line">            .sorted((doc1, doc2) -&gt; &#123;</span><br><span class="line">                <span class="type">double</span> <span class="variable">score1</span> <span class="operator">=</span> calculateRelevanceScore(doc1, query, context);</span><br><span class="line">                <span class="type">double</span> <span class="variable">score2</span> <span class="operator">=</span> calculateRelevanceScore(doc2, query, context);</span><br><span class="line">                <span class="keyword">return</span> Double.compare(score2, score1);</span><br><span class="line">            &#125;)</span><br><span class="line">            .limit(<span class="number">3</span>)</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> <span class="title function_">calculateRelevanceScore</span><span class="params">(Document doc, String query, ConversationContext context)</span> &#123;</span><br><span class="line">        <span class="type">double</span> <span class="variable">semanticScore</span> <span class="operator">=</span> calculateSemanticSimilarity(doc, query);</span><br><span class="line">        <span class="type">double</span> <span class="variable">contextScore</span> <span class="operator">=</span> calculateContextualRelevance(doc, context);</span><br><span class="line">        <span class="type">double</span> <span class="variable">freshnessScore</span> <span class="operator">=</span> calculateFreshnessScore(doc);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0.5</span> * semanticScore + <span class="number">0.3</span> * contextScore + <span class="number">0.2</span> * freshnessScore;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Multi-Vector-RAG-for-Financial-Documents"><a href="#Multi-Vector-RAG-for-Financial-Documents" class="headerlink" title="Multi-Vector RAG for Financial Documents"></a>Multi-Vector RAG for Financial Documents</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AdvancedRAGService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> VectorStore semanticVectorStore;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> VectorStore keywordVectorStore;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GraphRAGService graphRAGService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> RAGResponse <span class="title function_">queryWithMultiVectorRAG</span><span class="params">(String query, ConversationContext context)</span> &#123;</span><br><span class="line">        <span class="comment">// Semantic search</span></span><br><span class="line">        List&lt;Document&gt; semanticResults = semanticVectorStore.similaritySearch(</span><br><span class="line">            SearchRequest.query(query).withTopK(<span class="number">5</span>)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Keyword search</span></span><br><span class="line">        List&lt;Document&gt; keywordResults = keywordVectorStore.similaritySearch(</span><br><span class="line">            SearchRequest.query(extractKeywords(query)).withTopK(<span class="number">5</span>)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Graph-based retrieval for relationship context</span></span><br><span class="line">        List&lt;Document&gt; graphResults = graphRAGService.retrieveRelatedDocuments(query);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Combine and re-rank results</span></span><br><span class="line">        List&lt;Document&gt; combinedResults = reRankDocuments(</span><br><span class="line">            Arrays.asList(semanticResults, keywordResults, graphResults), </span><br><span class="line">            query</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Generate response with multi-vector context</span></span><br><span class="line">        <span class="keyword">return</span> generateEnhancedResponse(query, combinedResults, context);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> List&lt;Document&gt; <span class="title function_">reRankDocuments</span><span class="params">(List&lt;List&lt;Document&gt;&gt; documentLists, String query)</span> &#123;</span><br><span class="line">        <span class="comment">// Implement reciprocal rank fusion (RRF)</span></span><br><span class="line">        Map&lt;String, Double&gt; documentScores = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (List&lt;Document&gt; documents : documentLists) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; documents.size(); i++) &#123;</span><br><span class="line">                <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> documents.get(i);</span><br><span class="line">                <span class="type">String</span> <span class="variable">docId</span> <span class="operator">=</span> doc.getId();</span><br><span class="line">                <span class="type">double</span> <span class="variable">score</span> <span class="operator">=</span> <span class="number">1.0</span> / (i + <span class="number">1</span>); <span class="comment">// Reciprocal rank</span></span><br><span class="line">                documentScores.merge(docId, score, Double::sum);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Sort by combined score and return top results</span></span><br><span class="line">        <span class="keyword">return</span> documentScores.entrySet().stream()</span><br><span class="line">            .sorted(Map.Entry.&lt;String, Double&gt;comparingByValue().reversed())</span><br><span class="line">            .limit(<span class="number">10</span>)</span><br><span class="line">            .map(entry -&gt; findDocumentById(entry.getKey()))</span><br><span class="line">            .filter(Objects::nonNull)</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Financial-Domain-Specific-Text-Splitter"><a href="#Financial-Domain-Specific-Text-Splitter" class="headerlink" title="Financial Domain-Specific Text Splitter"></a>Financial Domain-Specific Text Splitter</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FinancialTextSplitter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Pattern</span> <span class="variable">FINANCIAL_SECTION_PATTERN</span> <span class="operator">=</span> </span><br><span class="line">        Pattern.compile(<span class="string">&quot;(INCOME|EXPENSES|ASSETS|LIABILITIES|CASH FLOW|CREDIT HISTORY)&quot;</span>, </span><br><span class="line">                       Pattern.CASE_INSENSITIVE);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Pattern</span> <span class="variable">CURRENCY_PATTERN</span> <span class="operator">=</span> </span><br><span class="line">        Pattern.compile(<span class="string">&quot;\\$[0-9,]+\\.?[0-9]*|[0-9,]+\\.[0-9]&#123;2&#125;&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">splitFinancialDocument</span><span class="params">(String text)</span> &#123;</span><br><span class="line">        List&lt;String&gt; chunks = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Split by financial sections first</span></span><br><span class="line">        String[] sections = FINANCIAL_SECTION_PATTERN.split(text);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String section : sections) &#123;</span><br><span class="line">            <span class="keyword">if</span> (section.length() &gt; <span class="number">2000</span>) &#123;</span><br><span class="line">                <span class="comment">// Further split large sections while preserving financial context</span></span><br><span class="line">                chunks.addAll(splitLargeSection(section));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                chunks.add(section.trim());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> chunks.stream()</span><br><span class="line">            .filter(chunk -&gt; !chunk.isEmpty())</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; <span class="title function_">splitLargeSection</span><span class="params">(String section)</span> &#123;</span><br><span class="line">        List&lt;String&gt; chunks = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        String[] sentences = section.split(<span class="string">&quot;\\.&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">currentChunk</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String sentence : sentences) &#123;</span><br><span class="line">            <span class="keyword">if</span> (currentChunk.length() + sentence.length() &gt; <span class="number">1500</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (currentChunk.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    chunks.add(currentChunk.toString().trim());</span><br><span class="line">                    currentChunk = <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            currentChunk.append(sentence).append(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Preserve financial context by keeping currency amounts together</span></span><br><span class="line">            <span class="keyword">if</span> (CURRENCY_PATTERN.matcher(sentence).find()) &#123;</span><br><span class="line">                <span class="comment">// Don&#x27;t split immediately after financial amounts</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (currentChunk.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            chunks.add(currentChunk.toString().trim());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> chunks;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="MCP-Server-and-Agent-to-Agent-Communication"><a href="#MCP-Server-and-Agent-to-Agent-Communication" class="headerlink" title="MCP Server and Agent-to-Agent Communication"></a>MCP Server and Agent-to-Agent Communication</h3><p>The Model Context Protocol (MCP) enables seamless communication between specialized agents, each handling specific domain expertise.</p>
<h4 id="MCPServerManager"><a href="#MCPServerManager" class="headerlink" title="MCPServerManager"></a>MCPServerManager</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MCPServerManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, MCPAgent&gt; agents = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initializeAgents</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Initialize specialized agents</span></span><br><span class="line">        agents.put(<span class="string">&quot;credit_agent&quot;</span>, <span class="keyword">new</span> <span class="title class_">CreditAnalysisAgent</span>());</span><br><span class="line">        agents.put(<span class="string">&quot;risk_agent&quot;</span>, <span class="keyword">new</span> <span class="title class_">RiskAssessmentAgent</span>());</span><br><span class="line">        agents.put(<span class="string">&quot;compliance_agent&quot;</span>, <span class="keyword">new</span> <span class="title class_">ComplianceAgent</span>());</span><br><span class="line">        agents.put(<span class="string">&quot;document_agent&quot;</span>, <span class="keyword">new</span> <span class="title class_">DocumentAnalysisAgent</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> AgentResponse <span class="title function_">routeToAgent</span><span class="params">(String agentType, AgentRequest request)</span> &#123;</span><br><span class="line">        <span class="type">MCPAgent</span> <span class="variable">agent</span> <span class="operator">=</span> agents.get(agentType);</span><br><span class="line">        <span class="keyword">if</span> (agent == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AgentNotFoundException</span>(<span class="string">&quot;Agent not found: &quot;</span> + agentType);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> agent.process(request);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> CompoundResponse <span class="title function_">processWithMultipleAgents</span><span class="params">(List&lt;String&gt; agentTypes, </span></span><br><span class="line"><span class="params">                                                     AgentRequest request)</span> &#123;</span><br><span class="line">        CompoundResponse.<span class="type">Builder</span> <span class="variable">responseBuilder</span> <span class="operator">=</span> CompoundResponse.builder();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Process with multiple agents in parallel</span></span><br><span class="line">        List&lt;CompletableFuture&lt;AgentResponse&gt;&gt; futures = agentTypes.stream()</span><br><span class="line">            .map(agentType -&gt; CompletableFuture.supplyAsync(() -&gt; </span><br><span class="line">                routeToAgent(agentType, request)))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">        </span><br><span class="line">        CompletableFuture.allOf(futures.toArray(<span class="keyword">new</span> <span class="title class_">CompletableFuture</span>[<span class="number">0</span>]))</span><br><span class="line">            .join();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Combine responses</span></span><br><span class="line">        List&lt;AgentResponse&gt; responses = futures.stream()</span><br><span class="line">            .map(CompletableFuture::join)</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> responseBuilder.agentResponses(responses).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Credit-Analysis-Agent-Example"><a href="#Credit-Analysis-Agent-Example" class="headerlink" title="Credit Analysis Agent Example"></a>Credit Analysis Agent Example</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CreditAnalysisAgent</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@MCPMethod(&quot;analyze_credit_profile&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CreditAnalysisResult <span class="title function_">analyzeCreditProfile</span><span class="params">(CreditAnalysisRequest request)</span> &#123;</span><br><span class="line">        <span class="comment">// Specialized credit analysis logic</span></span><br><span class="line">        <span class="type">CreditProfile</span> <span class="variable">profile</span> <span class="operator">=</span> request.getCreditProfile();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Calculate various credit metrics</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">debtToIncomeRatio</span> <span class="operator">=</span> calculateDebtToIncomeRatio(profile);</span><br><span class="line">        <span class="type">double</span> <span class="variable">creditUtilization</span> <span class="operator">=</span> calculateCreditUtilization(profile);</span><br><span class="line">        <span class="type">int</span> <span class="variable">paymentHistory</span> <span class="operator">=</span> analyzePaymentHistory(profile);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Generate risk score</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">riskScore</span> <span class="operator">=</span> calculateCreditRiskScore(debtToIncomeRatio, creditUtilization, paymentHistory);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Provide recommendations</span></span><br><span class="line">        List&lt;String&gt; recommendations = generateCreditRecommendations(profile, riskScore);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> CreditAnalysisResult.builder()</span><br><span class="line">            .riskScore(riskScore)</span><br><span class="line">            .debtToIncomeRatio(debtToIncomeRatio)</span><br><span class="line">            .creditUtilization(creditUtilization)</span><br><span class="line">            .paymentHistoryScore(paymentHistory)</span><br><span class="line">            .recommendations(recommendations)</span><br><span class="line">            .analysisTimestamp(Instant.now())</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> <span class="title function_">calculateCreditRiskScore</span><span class="params">(<span class="type">double</span> dtiRatio, <span class="type">double</span> utilization, <span class="type">int</span> paymentHistory)</span> &#123;</span><br><span class="line">        <span class="comment">// Weighted scoring algorithm</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">dtiWeight</span> <span class="operator">=</span> <span class="number">0.35</span>;</span><br><span class="line">        <span class="type">double</span> <span class="variable">utilizationWeight</span> <span class="operator">=</span> <span class="number">0.30</span>;</span><br><span class="line">        <span class="type">double</span> <span class="variable">paymentHistoryWeight</span> <span class="operator">=</span> <span class="number">0.35</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="type">double</span> <span class="variable">dtiScore</span> <span class="operator">=</span> Math.max(<span class="number">0</span>, <span class="number">100</span> - (dtiRatio * <span class="number">2</span>)); <span class="comment">// Lower DTI = higher score</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">utilizationScore</span> <span class="operator">=</span> Math.max(<span class="number">0</span>, <span class="number">100</span> - (utilization * <span class="number">100</span>)); <span class="comment">// Lower utilization = higher score</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">paymentScore</span> <span class="operator">=</span> paymentHistory; <span class="comment">// Already normalized to 0-100</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> (dtiScore * dtiWeight) + (utilizationScore * utilizationWeight) + (paymentScore * paymentHistoryWeight);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Session-Memory-and-Context-Caching-with-mem0"><a href="#Session-Memory-and-Context-Caching-with-mem0" class="headerlink" title="Session Memory and Context Caching with mem0"></a>Session Memory and Context Caching with mem0</h3><p>The mem0 solution provides sophisticated context management, maintaining conversation state and user preferences across sessions.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ContextMemoryService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Mem0Client mem0Client;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ConversationContext <span class="title function_">getContext</span><span class="params">(String sessionId)</span> &#123;</span><br><span class="line">        <span class="comment">// Try L1 cache first (Redis)</span></span><br><span class="line">        <span class="type">ConversationContext</span> <span class="variable">context</span> <span class="operator">=</span> (ConversationContext) </span><br><span class="line">            redisTemplate.opsForValue().get(<span class="string">&quot;context:&quot;</span> + sessionId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (context == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Fall back to mem0 for persistent context</span></span><br><span class="line">            context = mem0Client.getContext(sessionId);</span><br><span class="line">            <span class="keyword">if</span> (context != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Cache in Redis for quick access</span></span><br><span class="line">                redisTemplate.opsForValue().set(<span class="string">&quot;context:&quot;</span> + sessionId, </span><br><span class="line">                    context, Duration.ofMinutes(<span class="number">30</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> context != <span class="literal">null</span> ? context : <span class="keyword">new</span> <span class="title class_">ConversationContext</span>(sessionId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateContext</span><span class="params">(String sessionId, ConversationContext context)</span> &#123;</span><br><span class="line">        <span class="comment">// Update both caches</span></span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;context:&quot;</span> + sessionId, </span><br><span class="line">            context, Duration.ofMinutes(<span class="number">30</span>));</span><br><span class="line">        mem0Client.updateContext(sessionId, context);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addMemory</span><span class="params">(String sessionId, Memory memory)</span> &#123;</span><br><span class="line">        mem0Client.addMemory(sessionId, memory);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Invalidate cache to force refresh</span></span><br><span class="line">        redisTemplate.delete(<span class="string">&quot;context:&quot;</span> + sessionId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Key Interview Question</strong>: <em>How do you handle context windows and memory management in long conversations?</em></p>
<p><strong>Reference Answer</strong>: The system uses a hierarchical memory approach. Short-term context is kept in Redis for quick access, while long-term memories are stored in mem0. We implement context window management by summarizing older parts of conversations and keeping only the most relevant recent exchanges. The system also uses semantic clustering to group related memories and retrieves them based on relevance to the current conversation.</p>
<h3 id="LLM-ReAct-Pattern-Implementation"><a href="#LLM-ReAct-Pattern-Implementation" class="headerlink" title="LLM ReAct Pattern Implementation"></a>LLM ReAct Pattern Implementation</h3><p>The ReAct (Reasoning + Acting) pattern enables the system to break down complex queries into reasoning steps and actions.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReActEngine</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel chatModel;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ToolRegistry toolRegistry;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ReActResponse <span class="title function_">process</span><span class="params">(String query, ConversationContext context)</span> &#123;</span><br><span class="line">        <span class="type">ReActState</span> <span class="variable">state</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReActState</span>(query, context);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> (!state.isComplete() &amp;&amp; state.getStepCount() &lt; MAX_STEPS) &#123;</span><br><span class="line">            <span class="comment">// Reasoning step</span></span><br><span class="line">            <span class="type">ReasoningResult</span> <span class="variable">reasoning</span> <span class="operator">=</span> performReasoning(state);</span><br><span class="line">            state.addReasoning(reasoning);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Action step</span></span><br><span class="line">            <span class="keyword">if</span> (reasoning.requiresAction()) &#123;</span><br><span class="line">                <span class="type">ActionResult</span> <span class="variable">action</span> <span class="operator">=</span> performAction(reasoning.getAction(), state);</span><br><span class="line">                state.addAction(action);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Observation step</span></span><br><span class="line">                <span class="keyword">if</span> (action.hasObservation()) &#123;</span><br><span class="line">                    state.addObservation(action.getObservation());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Check if we have enough information to provide final answer</span></span><br><span class="line">            <span class="keyword">if</span> (reasoning.canProvideAnswer()) &#123;</span><br><span class="line">                state.setComplete(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> generateFinalResponse(state);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> ReasoningResult <span class="title function_">performReasoning</span><span class="params">(ReActState state)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">reasoningPrompt</span> <span class="operator">=</span> buildReasoningPrompt(state);</span><br><span class="line">        <span class="type">ChatResponse</span> <span class="variable">response</span> <span class="operator">=</span> chatModel.call(<span class="keyword">new</span> <span class="title class_">Prompt</span>(reasoningPrompt));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> parseReasoningResponse(response.getResult().getOutput().getContent());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> ActionResult <span class="title function_">performAction</span><span class="params">(Action action, ReActState state)</span> &#123;</span><br><span class="line">        <span class="type">Tool</span> <span class="variable">tool</span> <span class="operator">=</span> toolRegistry.getTool(action.getToolName());</span><br><span class="line">        <span class="keyword">if</span> (tool == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ActionResult.error(<span class="string">&quot;Tool not found: &quot;</span> + action.getToolName());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> tool.execute(action.getParameters(), state.getContext());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="LLM-Planning-Pattern-implementation"><a href="#LLM-Planning-Pattern-implementation" class="headerlink" title="LLM Planning Pattern implementation"></a>LLM Planning Pattern implementation</h3><p>The Planning pattern enables the system to create and execute complex multi-step plans for loan processing workflows.</p>
<p><strong>Planning Implementation:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PlanningAgent</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient chatClient;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TaskExecutor taskExecutor;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PlanValidator planValidator;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> PlanExecutionResult <span class="title function_">executePlan</span><span class="params">(String objective, PlanningConfig config)</span> &#123;</span><br><span class="line">        <span class="comment">// Step 1: Generate plan</span></span><br><span class="line">        <span class="type">Plan</span> <span class="variable">plan</span> <span class="operator">=</span> generatePlan(objective, config);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Step 2: Validate plan</span></span><br><span class="line">        <span class="type">ValidationResult</span> <span class="variable">validation</span> <span class="operator">=</span> planValidator.validate(plan);</span><br><span class="line">        <span class="keyword">if</span> (!validation.isValid()) &#123;</span><br><span class="line">            <span class="keyword">return</span> PlanExecutionResult.failed(validation.getErrors());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Step 3: Execute plan</span></span><br><span class="line">        <span class="keyword">return</span> executePlanSteps(plan);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Plan <span class="title function_">generatePlan</span><span class="params">(String objective, PlanningConfig config)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">prompt</span> <span class="operator">=</span> String.format(</span><br><span class="line">            <span class="string">&quot;Create a detailed plan to achieve the following objective: %s\n\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;Available capabilities: %s\n\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;Constraints: %s\n\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;Generate a step-by-step plan with the following format:\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;1. Step description\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;   - Required tools: [tool1, tool2]\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;   - Expected output: description\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;   - Dependencies: [step numbers]\n\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;Plan:&quot;</span>,</span><br><span class="line">            objective,</span><br><span class="line">            config.getAvailableCapabilities(),</span><br><span class="line">            config.getConstraints());</span><br><span class="line">        </span><br><span class="line">        <span class="type">ChatResponse</span> <span class="variable">response</span> <span class="operator">=</span> chatClient.call(<span class="keyword">new</span> <span class="title class_">Prompt</span>(prompt));</span><br><span class="line">        <span class="keyword">return</span> parsePlan(response.getResult().getOutput().getContent());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> PlanExecutionResult <span class="title function_">executePlanSteps</span><span class="params">(Plan plan)</span> &#123;</span><br><span class="line">        List&lt;StepResult&gt; stepResults = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        Map&lt;String, Object&gt; context = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (PlanStep step : plan.getSteps()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Check dependencies</span></span><br><span class="line">                <span class="keyword">if</span> (!areDependenciesMet(step, stepResults)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> PlanExecutionResult.failed(<span class="string">&quot;Dependencies not met for step: &quot;</span> + step.getId());</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Execute step</span></span><br><span class="line">                <span class="type">StepResult</span> <span class="variable">result</span> <span class="operator">=</span> executeStep(step, context);</span><br><span class="line">                stepResults.add(result);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Update context with results</span></span><br><span class="line">                context.put(step.getId(), result.getOutput());</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Check if step failed</span></span><br><span class="line">                <span class="keyword">if</span> (!result.isSuccess()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> PlanExecutionResult.failed(<span class="string">&quot;Step failed: &quot;</span> + step.getId());</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">return</span> PlanExecutionResult.failed(<span class="string">&quot;Step execution error: &quot;</span> + e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> PlanExecutionResult.success(stepResults);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> StepResult <span class="title function_">executeStep</span><span class="params">(PlanStep step, Map&lt;String, Object&gt; context)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> taskExecutor.execute(TaskExecution.builder()</span><br><span class="line">            .stepId(step.getId())</span><br><span class="line">            .description(step.getDescription())</span><br><span class="line">            .tools(step.getRequiredTools())</span><br><span class="line">            .context(context)</span><br><span class="line">            .build());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Example: Loan processing planning</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoanProcessingPlanner</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PlanningAgent planningAgent;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> LoanProcessingResult <span class="title function_">processLoanWithPlanning</span><span class="params">(LoanApplication application)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">objective</span> <span class="operator">=</span> String.format(</span><br><span class="line">            <span class="string">&quot;Process loan application for %s requesting $%,.2f. &quot;</span> +</span><br><span class="line">            <span class="string">&quot;Complete all required verifications and make final decision.&quot;</span>,</span><br><span class="line">            application.getApplicantName(),</span><br><span class="line">            application.getRequestedAmount());</span><br><span class="line">        </span><br><span class="line">        <span class="type">PlanningConfig</span> <span class="variable">config</span> <span class="operator">=</span> PlanningConfig.builder()</span><br><span class="line">            .availableCapabilities(Arrays.asList(</span><br><span class="line">                <span class="string">&quot;document_verification&quot;</span>, <span class="string">&quot;credit_check&quot;</span>, <span class="string">&quot;income_verification&quot;</span>,</span><br><span class="line">                <span class="string">&quot;employment_verification&quot;</span>, <span class="string">&quot;risk_assessment&quot;</span>, <span class="string">&quot;compliance_check&quot;</span>))</span><br><span class="line">            .constraints(Arrays.asList(</span><br><span class="line">                <span class="string">&quot;Must complete within 30 minutes&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Must verify all required documents&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Must comply with lending regulations&quot;</span>))</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="type">PlanExecutionResult</span> <span class="variable">result</span> <span class="operator">=</span> planningAgent.executePlan(objective, config);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> LoanProcessingResult.builder()</span><br><span class="line">            .application(application)</span><br><span class="line">            .executionResult(result)</span><br><span class="line">            .decision(extractDecisionFromPlan(result))</span><br><span class="line">            .processingTime(result.getExecutionTime())</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Model-Providers-Routing-with-Higress-AI-gateway"><a href="#Model-Providers-Routing-with-Higress-AI-gateway" class="headerlink" title="Model Providers Routing with Higress AI gateway"></a>Model Providers Routing with Higress AI gateway</h3><p>Higress AI Gateway provides intelligent routing and load balancing across multiple LLM providers, ensuring optimal performance and cost efficiency.</p>
<p><strong>Gateway Configuration:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HigressAIGatewayConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ModelProviderRouter <span class="title function_">modelProviderRouter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ModelProviderRouter.builder()</span><br><span class="line">            .addProvider(<span class="string">&quot;openai&quot;</span>, OpenAIProvider.builder()</span><br><span class="line">                .apiKey(<span class="string">&quot;$&#123;openai.api-key&#125;&quot;</span>)</span><br><span class="line">                .models(Arrays.asList(<span class="string">&quot;gpt-4&quot;</span>, <span class="string">&quot;gpt-3.5-turbo&quot;</span>))</span><br><span class="line">                .rateLimits(RateLimits.builder()</span><br><span class="line">                    .requestsPerMinute(<span class="number">60</span>)</span><br><span class="line">                    .tokensPerMinute(<span class="number">150000</span>)</span><br><span class="line">                    .build())</span><br><span class="line">                .build())</span><br><span class="line">            .addProvider(<span class="string">&quot;anthropic&quot;</span>, AnthropicProvider.builder()</span><br><span class="line">                .apiKey(<span class="string">&quot;$&#123;anthropic.api-key&#125;&quot;</span>)</span><br><span class="line">                .models(Arrays.asList(<span class="string">&quot;claude-3-opus&quot;</span>, <span class="string">&quot;claude-3-sonnet&quot;</span>))</span><br><span class="line">                .rateLimits(RateLimits.builder()</span><br><span class="line">                    .requestsPerMinute(<span class="number">50</span>)</span><br><span class="line">                    .tokensPerMinute(<span class="number">100000</span>)</span><br><span class="line">                    .build())</span><br><span class="line">                .build())</span><br><span class="line">            .addProvider(<span class="string">&quot;azure&quot;</span>, AzureProvider.builder()</span><br><span class="line">                .apiKey(<span class="string">&quot;$&#123;azure.api-key&#125;&quot;</span>)</span><br><span class="line">                .endpoint(<span class="string">&quot;$&#123;azure.endpoint&#125;&quot;</span>)</span><br><span class="line">                .models(Arrays.asList(<span class="string">&quot;gpt-4&quot;</span>, <span class="string">&quot;gpt-35-turbo&quot;</span>))</span><br><span class="line">                .rateLimits(RateLimits.builder()</span><br><span class="line">                    .requestsPerMinute(<span class="number">100</span>)</span><br><span class="line">                    .tokensPerMinute(<span class="number">200000</span>)</span><br><span class="line">                    .build())</span><br><span class="line">                .build())</span><br><span class="line">            .routingStrategy(RoutingStrategy.WEIGHTED_ROUND_ROBIN)</span><br><span class="line">            .fallbackStrategy(FallbackStrategy.CASCADE)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IntelligentModelRouter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ModelProviderRouter router;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ModelPerformanceMonitor monitor;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CostOptimizer costOptimizer;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ModelResponse <span class="title function_">routeRequest</span><span class="params">(ModelRequest request)</span> &#123;</span><br><span class="line">        <span class="comment">// Determine optimal provider based on request characteristics</span></span><br><span class="line">        <span class="type">ProviderSelection</span> <span class="variable">selection</span> <span class="operator">=</span> selectOptimalProvider(request);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Route to selected provider</span></span><br><span class="line">            <span class="type">ModelResponse</span> <span class="variable">response</span> <span class="operator">=</span> router.route(request, selection.getProvider());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Update performance metrics</span></span><br><span class="line">            monitor.recordSuccess(selection.getProvider(), response.getLatency());</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// Handle failures with fallback</span></span><br><span class="line">            <span class="keyword">return</span> handleFailureWithFallback(request, selection, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> ProviderSelection <span class="title function_">selectOptimalProvider</span><span class="params">(ModelRequest request)</span> &#123;</span><br><span class="line">        <span class="comment">// Analyze request characteristics</span></span><br><span class="line">        <span class="type">RequestAnalysis</span> <span class="variable">analysis</span> <span class="operator">=</span> analyzeRequest(request);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Consider multiple factors for provider selection</span></span><br><span class="line">        List&lt;ProviderScore&gt; scores = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String provider : router.getAvailableProviders()) &#123;</span><br><span class="line">            <span class="type">double</span> <span class="variable">score</span> <span class="operator">=</span> calculateProviderScore(provider, analysis);</span><br><span class="line">            scores.add(<span class="keyword">new</span> <span class="title class_">ProviderScore</span>(provider, score));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Select provider with highest score</span></span><br><span class="line">        <span class="type">ProviderScore</span> <span class="variable">best</span> <span class="operator">=</span> scores.stream()</span><br><span class="line">            .max(Comparator.comparingDouble(ProviderScore::getScore))</span><br><span class="line">            .orElse(scores.get(<span class="number">0</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ProviderSelection.builder()</span><br><span class="line">            .provider(best.getProvider())</span><br><span class="line">            .confidence(best.getScore())</span><br><span class="line">            .reasoning(generateSelectionReasoning(best, analysis))</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> <span class="title function_">calculateProviderScore</span><span class="params">(String provider, RequestAnalysis analysis)</span> &#123;</span><br><span class="line">        <span class="type">double</span> <span class="variable">score</span> <span class="operator">=</span> <span class="number">0.0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Factor 1: Model capability match</span></span><br><span class="line">        score += calculateCapabilityScore(provider, analysis) * <span class="number">0.4</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Factor 2: Performance (latency, availability)</span></span><br><span class="line">        score += calculatePerformanceScore(provider) * <span class="number">0.3</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Factor 3: Cost efficiency</span></span><br><span class="line">        score += calculateCostScore(provider, analysis) * <span class="number">0.2</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Factor 4: Current load</span></span><br><span class="line">        score += calculateLoadScore(provider) * <span class="number">0.1</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> score;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> ModelResponse <span class="title function_">handleFailureWithFallback</span><span class="params">(</span></span><br><span class="line"><span class="params">            ModelRequest request, ProviderSelection selection, Exception error)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        log.warn(<span class="string">&quot;Provider &#123;&#125; failed, attempting fallback&quot;</span>, selection.getProvider(), error);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Get fallback providers</span></span><br><span class="line">        List&lt;String&gt; fallbackProviders = router.getFallbackProviders(selection.getProvider());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String fallbackProvider : fallbackProviders) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">ModelResponse</span> <span class="variable">response</span> <span class="operator">=</span> router.route(request, fallbackProvider);</span><br><span class="line">                monitor.recordFallbackSuccess(fallbackProvider);</span><br><span class="line">                <span class="keyword">return</span> response;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception fallbackError) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;Fallback provider &#123;&#125; also failed&quot;</span>, fallbackProvider, fallbackError);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// All providers failed</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ModelRoutingException</span>(<span class="string">&quot;All providers failed for request&quot;</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="LLM-Prompt-Templates-via-Nacos"><a href="#LLM-Prompt-Templates-via-Nacos" class="headerlink" title="LLM Prompt Templates via Nacos"></a>LLM Prompt Templates via Nacos</h3><p>Dynamic prompt management through Nacos configuration center enables hot-swapping of prompts without system restart.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;prompts&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PromptTemplateService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NacosValue(&quot;$&#123;prompts.loan-assessment&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String loanAssessmentTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NacosValue(&quot;$&#123;prompts.risk-analysis&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String riskAnalysisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NacosValue(&quot;$&#123;prompts.knowledge-query&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String knowledgeQueryTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, String&gt; templateCache = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initializeTemplates</span><span class="params">()</span> &#123;</span><br><span class="line">        templateCache.put(<span class="string">&quot;loan_assessment&quot;</span>, loanAssessmentTemplate);</span><br><span class="line">        templateCache.put(<span class="string">&quot;risk_analysis&quot;</span>, riskAnalysisTemplate);</span><br><span class="line">        templateCache.put(<span class="string">&quot;knowledge_query&quot;</span>, knowledgeQueryTemplate);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTemplate</span><span class="params">(String templateName)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> templateCache.getOrDefault(templateName, getDefaultTemplate());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NacosConfigListener(dataId = &quot;prompts&quot;, type = ConfigType.YAML)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onConfigChange</span><span class="params">(String configInfo)</span> &#123;</span><br><span class="line">        <span class="comment">// Hot reload templates when configuration changes</span></span><br><span class="line">        log.info(<span class="string">&quot;Prompt templates updated, reloading...&quot;</span>);</span><br><span class="line">        <span class="comment">// Parse new configuration and update cache</span></span><br><span class="line">        updateTemplateCache(configInfo);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateTemplateCache</span><span class="params">(String configInfo)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>(<span class="keyword">new</span> <span class="title class_">YAMLFactory</span>());</span><br><span class="line">            Map&lt;String, String&gt; newTemplates = mapper.readValue(configInfo, </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;Map&lt;String, String&gt;&gt;() &#123;&#125;);</span><br><span class="line">            </span><br><span class="line">            templateCache.clear();</span><br><span class="line">            templateCache.putAll(newTemplates);</span><br><span class="line">            </span><br><span class="line">            log.info(<span class="string">&quot;Successfully updated &#123;&#125; prompt templates&quot;</span>, newTemplates.size());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Failed to update prompt templates&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Monitoring-and-Observability-with-OpenTelemetry"><a href="#Monitoring-and-Observability-with-OpenTelemetry" class="headerlink" title="Monitoring and Observability with OpenTelemetry"></a>Monitoring and Observability with OpenTelemetry</h3><p>OpenTelemetry provides comprehensive observability for the AI system, enabling performance monitoring, error tracking, and optimization insights.</p>
<p><strong>OpenTelemetry Configuration:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OpenTelemetryConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> OpenTelemetry <span class="title function_">openTelemetry</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> OpenTelemetySdk.builder()</span><br><span class="line">            .setTracerProvider(</span><br><span class="line">                SdkTracerProvider.builder()</span><br><span class="line">                    .addSpanProcessor(BatchSpanProcessor.builder(</span><br><span class="line">                        OtlpGrpcSpanExporter.builder()</span><br><span class="line">                            .setEndpoint(<span class="string">&quot;http://jaeger:14250&quot;</span>)</span><br><span class="line">                            .build())</span><br><span class="line">                        .build())</span><br><span class="line">                    .setResource(Resource.getDefault()</span><br><span class="line">                        .merge(Resource.builder()</span><br><span class="line">                            .put(ResourceAttributes.SERVICE_NAME, <span class="string">&quot;fintech-ai-system&quot;</span>)</span><br><span class="line">                            .put(ResourceAttributes.SERVICE_VERSION, <span class="string">&quot;1.0.0&quot;</span>)</span><br><span class="line">                            .build()))</span><br><span class="line">                    .build())</span><br><span class="line">            .setMeterProvider(</span><br><span class="line">                SdkMeterProvider.builder()</span><br><span class="line">                    .registerMetricReader(</span><br><span class="line">                        PeriodicMetricReader.builder(</span><br><span class="line">                            OtlpGrpcMetricExporter.builder()</span><br><span class="line">                                .setEndpoint(<span class="string">&quot;http://prometheus:9090&quot;</span>)</span><br><span class="line">                                .build())</span><br><span class="line">                            .setInterval(Duration.ofSeconds(<span class="number">30</span>))</span><br><span class="line">                            .build())</span><br><span class="line">                    .build())</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AISystemObservability</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Tracer tracer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Meter meter;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Metrics</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter requestCounter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Histogram responseTime;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Gauge activeConnections;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AISystemObservability</span><span class="params">(OpenTelemetry openTelemetry)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.tracer = openTelemetry.getTracer(<span class="string">&quot;fintech-ai-system&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.meter = openTelemetry.getMeter(<span class="string">&quot;fintech-ai-system&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Initialize metrics</span></span><br><span class="line">        <span class="built_in">this</span>.requestCounter = meter.counterBuilder(<span class="string">&quot;ai_requests_total&quot;</span>)</span><br><span class="line">            .setDescription(<span class="string">&quot;Total number of AI requests&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">this</span>.responseTime = meter.histogramBuilder(<span class="string">&quot;ai_response_time_seconds&quot;</span>)</span><br><span class="line">            .setDescription(<span class="string">&quot;AI response time in seconds&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">this</span>.activeConnections = meter.gaugeBuilder(<span class="string">&quot;ai_active_connections&quot;</span>)</span><br><span class="line">            .setDescription(<span class="string">&quot;Number of active AI connections&quot;</span>)</span><br><span class="line">            .buildObserver();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">traceAIOperation</span><span class="params">(String operationName, Supplier&lt;T&gt; operation)</span> &#123;</span><br><span class="line">        <span class="type">Span</span> <span class="variable">span</span> <span class="operator">=</span> tracer.spanBuilder(operationName)</span><br><span class="line">            .setSpanKind(SpanKind.INTERNAL)</span><br><span class="line">            .startSpan();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Scope</span> <span class="variable">scope</span> <span class="operator">=</span> span.makeCurrent()) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Execute operation</span></span><br><span class="line">            <span class="type">T</span> <span class="variable">result</span> <span class="operator">=</span> operation.get();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Record metrics</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">duration</span> <span class="operator">=</span> System.nanoTime() - startTime;</span><br><span class="line">            responseTime.record(duration / <span class="number">1_000_000_000.0</span>);</span><br><span class="line">            requestCounter.add(<span class="number">1</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Add span attributes</span></span><br><span class="line">            span.setStatus(StatusCode.OK);</span><br><span class="line">            span.setAttribute(<span class="string">&quot;operation.success&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            span.setStatus(StatusCode.ERROR, e.getMessage());</span><br><span class="line">            span.setAttribute(<span class="string">&quot;operation.success&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            span.setAttribute(<span class="string">&quot;error.type&quot;</span>, e.getClass().getSimpleName());</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            span.end();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordLLMMetrics</span><span class="params">(String provider, String model, <span class="type">long</span> tokens, </span></span><br><span class="line"><span class="params">                               <span class="type">double</span> latency, <span class="type">boolean</span> success)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">Attributes</span> <span class="variable">attributes</span> <span class="operator">=</span> Attributes.builder()</span><br><span class="line">            .put(<span class="string">&quot;provider&quot;</span>, provider)</span><br><span class="line">            .put(<span class="string">&quot;model&quot;</span>, model)</span><br><span class="line">            .put(<span class="string">&quot;success&quot;</span>, success)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        meter.counterBuilder(<span class="string">&quot;llm_requests_total&quot;</span>)</span><br><span class="line">            .build()</span><br><span class="line">            .add(<span class="number">1</span>, attributes);</span><br><span class="line">        </span><br><span class="line">        meter.histogramBuilder(<span class="string">&quot;llm_token_usage&quot;</span>)</span><br><span class="line">            .build()</span><br><span class="line">            .record(tokens, attributes);</span><br><span class="line">        </span><br><span class="line">        meter.histogramBuilder(<span class="string">&quot;llm_latency_seconds&quot;</span>)</span><br><span class="line">            .build()</span><br><span class="line">            .record(latency, attributes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Usage in services</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MonitoredAIService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AISystemObservability observability;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient chatClient;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">processWithMonitoring</span><span class="params">(String query)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> observability.traceAIOperation(<span class="string">&quot;llm_query_processing&quot;</span>, () -&gt; &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">ChatResponse</span> <span class="variable">response</span> <span class="operator">=</span> chatClient.call(<span class="keyword">new</span> <span class="title class_">Prompt</span>(query));</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Record success metrics</span></span><br><span class="line">                <span class="type">long</span> <span class="variable">latency</span> <span class="operator">=</span> System.currentTimeMillis() - startTime;</span><br><span class="line">                observability.recordLLMMetrics(<span class="string">&quot;openai&quot;</span>, <span class="string">&quot;gpt-4&quot;</span>, </span><br><span class="line">                    response.getResult().getMetadata().getUsage().getTotalTokens(),</span><br><span class="line">                    latency / <span class="number">1000.0</span>, <span class="literal">true</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> response.getResult().getOutput().getContent();</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// Record failure metrics</span></span><br><span class="line">                <span class="type">long</span> <span class="variable">latency</span> <span class="operator">=</span> System.currentTimeMillis() - startTime;</span><br><span class="line">                observability.recordLLMMetrics(<span class="string">&quot;openai&quot;</span>, <span class="string">&quot;gpt-4&quot;</span>, <span class="number">0</span>, </span><br><span class="line">                    latency / <span class="number">1000.0</span>, <span class="literal">false</span>);</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Use-Cases-and-Examples"><a href="#Use-Cases-and-Examples" class="headerlink" title="Use Cases and Examples"></a>Use Cases and Examples</h2><h3 id="Use-Case-1-Automated-Loan-Application-Processing"><a href="#Use-Case-1-Automated-Loan-Application-Processing" class="headerlink" title="Use Case 1: Automated Loan Application Processing"></a>Use Case 1: Automated Loan Application Processing</h3><p><strong>Scenario</strong>: A customer applies for a $50,000 personal loan through the chat interface.</p>
<p><strong>Flow</strong>:</p>
<ol>
<li>Customer initiates conversation: Id like to apply for a personal loan</li>
<li>AI classifies intent as LOAN_APPLICATION</li>
<li>System guides customer through document collection</li>
<li>AI processes submitted documents using OCR and NLP</li>
<li>Automated workflow calls external systems for verification</li>
<li>AI makes preliminary assessment with 92% confidence</li>
<li>System auto-approves loan with conditions</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Example implementation</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testAutomatedLoanFlow</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// Simulate customer input</span></span><br><span class="line">    <span class="type">ConversationRequest</span> <span class="variable">request</span> <span class="operator">=</span> ConversationRequest.builder()</span><br><span class="line">        .text(<span class="string">&quot;I need a $50,000 personal loan&quot;</span>)</span><br><span class="line">        .sessionId(<span class="string">&quot;session-123&quot;</span>)</span><br><span class="line">        .build();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Process through conversation service</span></span><br><span class="line">    <span class="type">ConversationResponse</span> <span class="variable">response</span> <span class="operator">=</span> conversationService.processMessage(request);</span><br><span class="line">    </span><br><span class="line">    assertThat(response.getIntent()).isEqualTo(IntentType.LOAN_APPLICATION);</span><br><span class="line">    assertThat(response.getNextSteps()).contains(<span class="string">&quot;document_collection&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Simulate document upload</span></span><br><span class="line">    <span class="type">ConversationRequest</span> <span class="variable">docRequest</span> <span class="operator">=</span> ConversationRequest.builder()</span><br><span class="line">        .files(Arrays.asList(mockPayStub, mockBankStatement))</span><br><span class="line">        .sessionId(<span class="string">&quot;session-123&quot;</span>)</span><br><span class="line">        .build();</span><br><span class="line">    </span><br><span class="line">    <span class="type">ConversationResponse</span> <span class="variable">docResponse</span> <span class="operator">=</span> conversationService.processMessage(docRequest);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Verify AI processing</span></span><br><span class="line">    assertThat(docResponse.getProcessingResult().getConfidence()).isGreaterThan(<span class="number">0.9</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Use-Case-2-Multi-Modal-Customer-Support"><a href="#Use-Case-2-Multi-Modal-Customer-Support" class="headerlink" title="Use Case 2: Multi-Modal Customer Support"></a>Use Case 2: Multi-Modal Customer Support</h3><p><strong>Scenario</strong>: Customer uploads a photo of their bank statement and asks about eligibility.</p>
<p><strong>Flow</strong>:</p>
<ol>
<li>Customer uploads bank statement image</li>
<li>OCR extracts text and financial data</li>
<li>AI analyzes income patterns and expenses</li>
<li>System queries knowledge base for eligibility criteria</li>
<li>AI provides personalized eligibility assessment</li>
</ol>
<h3 id="Use-Case-3-Complex-Financial-Query-Resolution"><a href="#Use-Case-3-Complex-Financial-Query-Resolution" class="headerlink" title="Use Case 3: Complex Financial Query Resolution"></a>Use Case 3: Complex Financial Query Resolution</h3><p><strong>Scenario</strong>: What are the tax implications of early loan repayment?</p>
<p><strong>Flow</strong>:</p>
<ol>
<li>ReAct engine breaks down the query</li>
<li>System retrieves relevant tax documents from knowledge base</li>
<li>AI reasons through tax implications step by step</li>
<li>System provides comprehensive answer with citations</li>
</ol>
<h2 id="Performance-Optimization-and-Scalability"><a href="#Performance-Optimization-and-Scalability" class="headerlink" title="Performance Optimization and Scalability"></a>Performance Optimization and Scalability</h2><h3 id="Caching-Strategy"><a href="#Caching-Strategy" class="headerlink" title="Caching Strategy"></a>Caching Strategy</h3><p>The system implements a multi-level caching strategy to achieve sub-30-second response times:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CachingService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Cacheable(value = &quot;llm-responses&quot;, key = &quot;#promptHash&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCachedResponse</span><span class="params">(String promptHash)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (String) redisTemplate.opsForValue().get(<span class="string">&quot;llm:&quot;</span> + promptHash);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@CachePut(value = &quot;llm-responses&quot;, key = &quot;#promptHash&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">cacheResponse</span><span class="params">(String promptHash, String response)</span> &#123;</span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;llm:&quot;</span> + promptHash, response, </span><br><span class="line">            Duration.ofHours(<span class="number">1</span>));</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Cacheable(value = &quot;embeddings&quot;, key = &quot;#text.hashCode()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Float&gt; <span class="title function_">getCachedEmbedding</span><span class="params">(String text)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (List&lt;Float&gt;) redisTemplate.opsForValue().get(<span class="string">&quot;embedding:&quot;</span> + text.hashCode());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Load-Balancing-and-Horizontal-Scaling"><a href="#Load-Balancing-and-Horizontal-Scaling" class="headerlink" title="Load Balancing and Horizontal Scaling"></a>Load Balancing and Horizontal Scaling</h3><pre>
<code class="mermaid">
flowchart LR
A[Load Balancer] --&gt; B[Service Instance 1]
A --&gt; C[Service Instance 2]
A --&gt; D[Service Instance 3]

B --&gt; E[LLM Provider 1]
B --&gt; F[LLM Provider 2]
C --&gt; E
C --&gt; F
D --&gt; E
D --&gt; F

E --&gt; G[Redis Cache]
F --&gt; G

B --&gt; H[Vector DB]
C --&gt; H
D --&gt; H
</code>
</pre>

<h3 id="Database-Optimization"><a href="#Database-Optimization" class="headerlink" title="Database Optimization"></a>Database Optimization</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;loan_applications&quot;, indexes = &#123;</span></span><br><span class="line"><span class="meta">    @Index(name = &quot;idx_applicant_status&quot;, columnList = &quot;applicant_id, status&quot;),</span></span><br><span class="line"><span class="meta">    @Index(name = &quot;idx_created_date&quot;, columnList = &quot;created_date&quot;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoanApplication</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(name = &quot;applicant_id&quot;, nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> String applicantId;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Enumerated(EnumType.STRING)</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;status&quot;, nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationStatus status;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(name = &quot;created_date&quot;, nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createdDate;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Optimized for queries</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;search_vector&quot;, columnDefinition = &quot;tsvector&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String searchVector;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Key Interview Question</strong>: <em>How do you ensure the system can handle 2000+ concurrent users while maintaining response times?</em></p>
<p><strong>Reference Answer</strong>: The system uses several optimization techniques: 1) Multi-level caching with Redis for frequently accessed data, 2) Connection pooling for database and external service calls, 3) Asynchronous processing for non-critical operations, 4) Load balancing across multiple LLM providers, 5) Database query optimization with proper indexing, 6) Context caching to avoid repeated LLM calls for similar queries, and 7) Horizontal scaling of microservices based on demand.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>The FinTech AI Workflow and Chat System represents a sophisticated integration of traditional financial workflows with cutting-edge AI technologies. By combining the reliability of established banking processes with the intelligence of modern AI systems, the platform delivers a superior user experience while maintaining the security and compliance requirements essential in financial services.</p>
<p>The architectures microservices design ensures scalability and maintainability, while the AI components provide intelligent automation that reduces processing time and improves accuracy. The systems ability to handle over 2000 concurrent conversations with rapid response times demonstrates its enterprise readiness.</p>
<p>Key success factors include:</p>
<ul>
<li>Seamless integration between traditional and AI-powered workflows</li>
<li>Robust multi-modal processing capabilities</li>
<li>Intelligent context management and memory systems</li>
<li>Flexible prompt template management for rapid iteration</li>
<li>Comprehensive performance optimization strategies</li>
</ul>
<p>The system sets a new standard for AI-powered financial services, combining the best of human expertise with artificial intelligence to create a truly intelligent lending platform.</p>
<h2 id="External-Resources-and-References"><a href="#External-Resources-and-References" class="headerlink" title="External Resources and References"></a>External Resources and References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-ai/reference/">Spring AI Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://higress.io/">Higress AI Gateway</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mem0ai/mem0">mem0 Memory Management</a></li>
<li><a target="_blank" rel="noopener" href="https://nacos.io/">Nacos Configuration Center</a></li>
<li><a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/">LangGraph Pattern Implementation</a></li>
<li><a target="_blank" rel="noopener" href="https://modelcontextprotocol.io/">Model Context Protocol (MCP)</a></li>
<li><a target="_blank" rel="noopener" href="https://arxiv.org/abs/2210.03629">ReAct Pattern Paper</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.llamaindex.ai/en/stable/getting_started/concepts.html">RAG Best Practices</a></li>
<li><a target="_blank" rel="noopener" href="https://www.federalregister.gov/documents/2021/03/15/2021-05015/artificial-intelligence-risk-management">Financial Services AI Compliance Guidelines</a></li>
<li><a target="_blank" rel="noopener" href="https://platform.openai.com/docs/guides/production-best-practices">OpenAI API Best Practices</a></li>
<li><a target="_blank" rel="noopener" href="https://www.pinecone.io/learn/vector-database-performance/">Vector Database Performance Optimization</a></li>
<li><a target="_blank" rel="noopener" href="https://microservices.io/patterns/security/">Microservices Security Patterns</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/29/Design-Distributed-Pressure-Test-Tool-By-Zookeeper/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/29/Design-Distributed-Pressure-Test-Tool-By-Zookeeper/" class="post-title-link" itemprop="url">Design Distributed Pressure Test Tool By Zookeeper</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-29 16:46:34" itemprop="dateCreated datePublished" datetime="2025-06-29T16:46:34+08:00">2025-06-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-30 14:40:16" itemprop="dateModified" datetime="2025-06-30T14:40:16+08:00">2025-06-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/system-design/" itemprop="url" rel="index"><span itemprop="name">system-design</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="System-Architecture-Overview"><a href="#System-Architecture-Overview" class="headerlink" title="System Architecture Overview"></a>System Architecture Overview</h2><p>A distributed pressure testing system leverages multiple client nodes coordinated through Apache Zookeeper to simulate high-load scenarios against target services. This architecture provides horizontal scalability, centralized coordination, and real-time monitoring capabilities.</p>
<pre>
<code class="mermaid">
graph TB
subgraph &quot;Control Layer&quot;
    Master[MasterTestNode]
    Dashboard[Dashboard Website]
    ZK[Zookeeper Cluster]
end

subgraph &quot;Execution Layer&quot;
    Client1[ClientTestNode 1]
    Client2[ClientTestNode 2]
    Client3[ClientTestNode N]
end

subgraph &quot;Target Layer&quot;
    Service[Target Microservice]
    DB[(Database)]
end

Master --&gt; ZK
Dashboard --&gt; Master
Client1 --&gt; ZK
Client2 --&gt; ZK
Client3 --&gt; ZK
Client1 --&gt; Service
Client2 --&gt; Service
Client3 --&gt; Service
Service --&gt; DB

ZK -.-&gt; Master
ZK -.-&gt; Client1
ZK -.-&gt; Client2
ZK -.-&gt; Client3
</code>
</pre>

<p><strong>Interview Question</strong>: <em>Why choose Zookeeper for coordination instead of a message queue like Kafka or RabbitMQ?</em></p>
<p><strong>Answer</strong>: Zookeeper provides strong consistency guarantees, distributed configuration management, and service discovery capabilities essential for test coordination. Unlike message queues that focus on data streaming, Zookeeper excels at maintaining cluster state, leader election, and distributed locks - critical for coordinating test execution phases and preventing race conditions.</p>
<h2 id="Core-Components-Design"><a href="#Core-Components-Design" class="headerlink" title="Core Components Design"></a>Core Components Design</h2><h3 id="ClientTestNode-Architecture"><a href="#ClientTestNode-Architecture" class="headerlink" title="ClientTestNode Architecture"></a>ClientTestNode Architecture</h3><p>The ClientTestNode is the workhorse of the system, responsible for generating load and collecting metrics. Built on Netty for high-performance HTTP communication.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClientTestNode</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ZookeeperClient zkClient;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> NettyHttpClient httpClient;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MetricsCollector metricsCollector;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TaskConfiguration taskConfig;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Register with Zookeeper</span></span><br><span class="line">        zkClient.registerNode(getNodeInfo());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Initialize Netty client</span></span><br><span class="line">        httpClient.initialize(taskConfig.getNettyConfig());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Start metrics collection</span></span><br><span class="line">        metricsCollector.startCollection();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeTest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">TestTask</span> <span class="variable">task</span> <span class="operator">=</span> zkClient.getTestTask();</span><br><span class="line">        </span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(task.getThreadCount());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>()</span><br><span class="line">                .group(group)</span><br><span class="line">                .channel(NioSocketChannel.class)</span><br><span class="line">                .handler(<span class="keyword">new</span> <span class="title class_">HttpClientInitializer</span>(metricsCollector));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Execute concurrent requests</span></span><br><span class="line">            IntStream.range(<span class="number">0</span>, task.getConcurrency())</span><br><span class="line">                .parallel()</span><br><span class="line">                .forEach(i -&gt; executeRequest(bootstrap, task));</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">executeRequest</span><span class="params">(Bootstrap bootstrap, TestTask task)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        </span><br><span class="line">        <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> bootstrap.connect(task.getTargetHost(), task.getTargetPort());</span><br><span class="line">        future.addListener((ChannelFutureListener) channelFuture -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (channelFuture.isSuccess()) &#123;</span><br><span class="line">                <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> channelFuture.channel();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Build HTTP request</span></span><br><span class="line">                <span class="type">FullHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultFullHttpRequest</span>(</span><br><span class="line">                    HTTP_1_1, HttpMethod.valueOf(task.getMethod()), task.getPath());</span><br><span class="line">                request.headers().set(HttpHeaderNames.HOST, task.getTargetHost());</span><br><span class="line">                request.headers().set(HttpHeaderNames.CONNECTION, HttpHeaderValues.KEEP_ALIVE);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Send request and handle response</span></span><br><span class="line">                channel.writeAndFlush(request);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="MasterTestNode-Coordination"><a href="#MasterTestNode-Coordination" class="headerlink" title="MasterTestNode Coordination"></a>MasterTestNode Coordination</h3><p>The MasterTestNode orchestrates the entire testing process, manages client lifecycle, and aggregates results.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MasterTestNode</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ZookeeperClient zkClient;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TestTaskManager taskManager;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ResultAggregator resultAggregator;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startTest</span><span class="params">(TestConfiguration config)</span> &#123;</span><br><span class="line">        <span class="comment">// Create test task in Zookeeper</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">taskPath</span> <span class="operator">=</span> zkClient.createTestTask(config);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Wait for client nodes to register</span></span><br><span class="line">        waitForClientNodes(config.getRequiredClientCount());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Distribute task configuration</span></span><br><span class="line">        distributeTaskConfiguration(taskPath, config);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Monitor test execution</span></span><br><span class="line">        monitorTestExecution(taskPath);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">waitForClientNodes</span><span class="params">(<span class="type">int</span> requiredCount)</span> &#123;</span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(requiredCount);</span><br><span class="line">        </span><br><span class="line">        zkClient.watchChildren(<span class="string">&quot;/test/clients&quot;</span>, (event) -&gt; &#123;</span><br><span class="line">            List&lt;String&gt; children = zkClient.getChildren(<span class="string">&quot;/test/clients&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (children.size() &gt;= requiredCount) &#123;</span><br><span class="line">                latch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            latch.await(<span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TestExecutionException</span>(<span class="string">&quot;Timeout waiting for client nodes&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> TestResult <span class="title function_">aggregateResults</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;String&gt; clientNodes = zkClient.getChildren(<span class="string">&quot;/test/clients&quot;</span>);</span><br><span class="line">        List&lt;ClientMetrics&gt; allMetrics = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String clientNode : clientNodes) &#123;</span><br><span class="line">            <span class="type">ClientMetrics</span> <span class="variable">metrics</span> <span class="operator">=</span> zkClient.getData(<span class="string">&quot;/test/results/&quot;</span> + clientNode, ClientMetrics.class);</span><br><span class="line">            allMetrics.add(metrics);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> resultAggregator.aggregate(allMetrics);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Task-Configuration-Management"><a href="#Task-Configuration-Management" class="headerlink" title="Task Configuration Management"></a>Task Configuration Management</h2><h3 id="Configuration-Structure"><a href="#Configuration-Structure" class="headerlink" title="Configuration Structure"></a>Configuration Structure</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@JsonSerialize</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TaskConfiguration</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String testId;</span><br><span class="line">    <span class="keyword">private</span> String targetUrl;</span><br><span class="line">    <span class="keyword">private</span> HttpMethod method;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; headers;</span><br><span class="line">    <span class="keyword">private</span> String requestBody;</span><br><span class="line">    <span class="keyword">private</span> LoadPattern loadPattern;</span><br><span class="line">    <span class="keyword">private</span> Duration duration;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> concurrency;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> qps;</span><br><span class="line">    <span class="keyword">private</span> RetryPolicy retryPolicy;</span><br><span class="line">    <span class="keyword">private</span> NettyConfiguration nettyConfig;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LoadPattern</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> LoadType type; <span class="comment">// CONSTANT, RAMP_UP, SPIKE, STEP</span></span><br><span class="line">        <span class="keyword">private</span> List&lt;LoadStep&gt; steps;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Data</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LoadStep</span> &#123;</span><br><span class="line">            <span class="keyword">private</span> Duration duration;</span><br><span class="line">            <span class="keyword">private</span> <span class="type">int</span> targetQps;</span><br><span class="line">            <span class="keyword">private</span> <span class="type">int</span> concurrency;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">NettyConfiguration</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> <span class="variable">connectTimeoutMs</span> <span class="operator">=</span> <span class="number">5000</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> <span class="variable">readTimeoutMs</span> <span class="operator">=</span> <span class="number">10000</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> <span class="variable">maxConnections</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">keepAlive</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> <span class="variable">workerThreads</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors() * <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Dynamic-Configuration-Updates"><a href="#Dynamic-Configuration-Updates" class="headerlink" title="Dynamic Configuration Updates"></a>Dynamic Configuration Updates</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicConfigurationManager</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ZookeeperClient zkClient;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> TaskConfiguration currentConfig;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">configPath</span> <span class="operator">=</span> <span class="string">&quot;/test/config&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Watch for configuration changes</span></span><br><span class="line">        zkClient.watchData(configPath, (event) -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (event.getType() == EventType.NodeDataChanged) &#123;</span><br><span class="line">                updateConfiguration(zkClient.getData(configPath, TaskConfiguration.class));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateConfiguration</span><span class="params">(TaskConfiguration newConfig)</span> &#123;</span><br><span class="line">        <span class="type">TaskConfiguration</span> <span class="variable">oldConfig</span> <span class="operator">=</span> <span class="built_in">this</span>.currentConfig;</span><br><span class="line">        <span class="built_in">this</span>.currentConfig = newConfig;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Apply hot configuration changes</span></span><br><span class="line">        <span class="keyword">if</span> (oldConfig != <span class="literal">null</span> &amp;&amp; !Objects.equals(oldConfig.getQps(), newConfig.getQps())) &#123;</span><br><span class="line">            adjustLoadRate(newConfig.getQps());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (oldConfig != <span class="literal">null</span> &amp;&amp; !Objects.equals(oldConfig.getConcurrency(), newConfig.getConcurrency())) &#123;</span><br><span class="line">            adjustConcurrency(newConfig.getConcurrency());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">adjustLoadRate</span><span class="params">(<span class="type">int</span> newQps)</span> &#123;</span><br><span class="line">        <span class="comment">// Implement rate limiter adjustment</span></span><br><span class="line">        RateLimiter.create(newQps);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Question</strong>: <em>How do you handle configuration consistency across distributed nodes during runtime updates?</em></p>
<p><strong>Answer</strong>: We use Zookeepers atomic operations and watches to ensure configuration consistency. When the master updates configuration, it uses conditional writes (compare-and-swap) to prevent conflicts. Client nodes register watches on configuration znodes and receive immediate notifications. We implement a two-phase commit pattern: first distribute the new configuration, then send an activation signal once all nodes acknowledge receipt.</p>
<h2 id="Metrics-Collection-and-Statistics"><a href="#Metrics-Collection-and-Statistics" class="headerlink" title="Metrics Collection and Statistics"></a>Metrics Collection and Statistics</h2><h3 id="Real-time-Metrics-Collection"><a href="#Real-time-Metrics-Collection" class="headerlink" title="Real-time Metrics Collection"></a>Real-time Metrics Collection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MetricsCollector</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Timer responseTimer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter requestCounter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter errorCounter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Histogram responseSizeHistogram;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService scheduler;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MetricsCollector</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MetricRegistry</span> <span class="variable">registry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MetricRegistry</span>();</span><br><span class="line">        <span class="built_in">this</span>.responseTimer = registry.timer(<span class="string">&quot;http.response.time&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.requestCounter = registry.counter(<span class="string">&quot;http.requests.total&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.errorCounter = registry.counter(<span class="string">&quot;http.errors.total&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.responseSizeHistogram = registry.histogram(<span class="string">&quot;http.response.size&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.scheduler = Executors.newScheduledThreadPool(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordRequest</span><span class="params">(<span class="type">long</span> responseTimeNanos, <span class="type">int</span> statusCode, <span class="type">int</span> responseSize)</span> &#123;</span><br><span class="line">        responseTimer.update(responseTimeNanos, TimeUnit.NANOSECONDS);</span><br><span class="line">        requestCounter.inc();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (statusCode &gt;= <span class="number">400</span>) &#123;</span><br><span class="line">            errorCounter.inc();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        responseSizeHistogram.update(responseSize);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> MetricsSnapshot <span class="title function_">getSnapshot</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Snapshot</span> <span class="variable">timerSnapshot</span> <span class="operator">=</span> responseTimer.getSnapshot();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> MetricsSnapshot.builder()</span><br><span class="line">            .timestamp(System.currentTimeMillis())</span><br><span class="line">            .totalRequests(requestCounter.getCount())</span><br><span class="line">            .totalErrors(errorCounter.getCount())</span><br><span class="line">            .qps(calculateQPS())</span><br><span class="line">            .avgResponseTime(timerSnapshot.getMean())</span><br><span class="line">            .p95ResponseTime(timerSnapshot.get95thPercentile())</span><br><span class="line">            .p99ResponseTime(timerSnapshot.get99thPercentile())</span><br><span class="line">            .errorRate(calculateErrorRate())</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> <span class="title function_">calculateQPS</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">currentTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">long</span> <span class="variable">timeWindow</span> <span class="operator">=</span> <span class="number">1000</span>; <span class="comment">// 1 second</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> requestCounter.getCount() / ((currentTime - startTime) / <span class="number">1000.0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 1000)</span> <span class="comment">// Report every second</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reportMetrics</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MetricsSnapshot</span> <span class="variable">snapshot</span> <span class="operator">=</span> getSnapshot();</span><br><span class="line">        zkClient.updateData(<span class="string">&quot;/test/metrics/&quot;</span> + nodeId, snapshot);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Advanced-Statistical-Calculations"><a href="#Advanced-Statistical-Calculations" class="headerlink" title="Advanced Statistical Calculations"></a>Advanced Statistical Calculations</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StatisticalAnalyzer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> TestResult <span class="title function_">calculateDetailedStatistics</span><span class="params">(List&lt;MetricsSnapshot&gt; snapshots)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (snapshots.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> TestResult.empty();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Calculate aggregated metrics</span></span><br><span class="line">        <span class="type">DoubleSummaryStatistics</span> <span class="variable">responseTimeStats</span> <span class="operator">=</span> snapshots.stream()</span><br><span class="line">            .mapToDouble(MetricsSnapshot::getAvgResponseTime)</span><br><span class="line">            .summaryStatistics();</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// Calculate percentiles using HdrHistogram for accuracy</span></span><br><span class="line">        <span class="type">Histogram</span> <span class="variable">histogram</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Histogram</span>(<span class="number">3</span>);</span><br><span class="line">        snapshots.forEach(snapshot -&gt; </span><br><span class="line">            histogram.recordValue((<span class="type">long</span>) snapshot.getAvgResponseTime()));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Throughput analysis</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">totalQps</span> <span class="operator">=</span> snapshots.stream()</span><br><span class="line">            .mapToDouble(MetricsSnapshot::getQps)</span><br><span class="line">            .sum();</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// Error rate analysis</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">totalRequests</span> <span class="operator">=</span> snapshots.stream()</span><br><span class="line">            .mapToDouble(MetricsSnapshot::getTotalRequests)</span><br><span class="line">            .sum();</span><br><span class="line">        <span class="type">double</span> <span class="variable">totalErrors</span> <span class="operator">=</span> snapshots.stream()</span><br><span class="line">            .mapToDouble(MetricsSnapshot::getTotalErrors)</span><br><span class="line">            .sum();</span><br><span class="line">        <span class="type">double</span> <span class="variable">overallErrorRate</span> <span class="operator">=</span> totalErrors / totalRequests * <span class="number">100</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Stability analysis</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">responseTimeStdDev</span> <span class="operator">=</span> calculateStandardDeviation(</span><br><span class="line">            snapshots.stream()</span><br><span class="line">                .mapToDouble(MetricsSnapshot::getAvgResponseTime)</span><br><span class="line">                .toArray());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> TestResult.builder()</span><br><span class="line">            .totalQps(totalQps)</span><br><span class="line">            .avgResponseTime(responseTimeStats.getAverage())</span><br><span class="line">            .minResponseTime(responseTimeStats.getMin())</span><br><span class="line">            .maxResponseTime(responseTimeStats.getMax())</span><br><span class="line">            .p50ResponseTime(histogram.getValueAtPercentile(<span class="number">50</span>))</span><br><span class="line">            .p95ResponseTime(histogram.getValueAtPercentile(<span class="number">95</span>))</span><br><span class="line">            .p99ResponseTime(histogram.getValueAtPercentile(<span class="number">99</span>))</span><br><span class="line">            .p999ResponseTime(histogram.getValueAtPercentile(<span class="number">99.9</span>))</span><br><span class="line">            .errorRate(overallErrorRate)</span><br><span class="line">            .responseTimeStdDev(responseTimeStdDev)</span><br><span class="line">            .stabilityScore(calculateStabilityScore(responseTimeStdDev, overallErrorRate))</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> <span class="title function_">calculateStabilityScore</span><span class="params">(<span class="type">double</span> stdDev, <span class="type">double</span> errorRate)</span> &#123;</span><br><span class="line">        <span class="comment">// Custom stability scoring algorithm</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">variabilityScore</span> <span class="operator">=</span> Math.max(<span class="number">0</span>, <span class="number">100</span> - (stdDev / <span class="number">10</span>)); <span class="comment">// Lower std dev = higher score</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">reliabilityScore</span> <span class="operator">=</span> Math.max(<span class="number">0</span>, <span class="number">100</span> - (errorRate * <span class="number">2</span>)); <span class="comment">// Lower error rate = higher score</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> (variabilityScore + reliabilityScore) / <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Question</strong>: <em>How do you ensure accurate percentile calculations in a distributed environment?</em></p>
<p><strong>Answer</strong>: We use HdrHistogram library for accurate percentile calculations with minimal memory overhead. Each client node maintains local histograms and periodically serializes them to Zookeeper. The master node deserializes and merges histograms using HdrHistograms built-in merge capabilities, which maintains accuracy across distributed measurements. This approach is superior to simple averaging and provides true percentile values across the entire distributed system.</p>
<h2 id="Zookeeper-Integration-Patterns"><a href="#Zookeeper-Integration-Patterns" class="headerlink" title="Zookeeper Integration Patterns"></a>Zookeeper Integration Patterns</h2><h3 id="Service-Discovery-and-Registration"><a href="#Service-Discovery-and-Registration" class="headerlink" title="Service Discovery and Registration"></a>Service Discovery and Registration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZookeeperServiceRegistry</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CuratorFramework client;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServiceDiscovery&lt;TestNodeMetadata&gt; serviceDiscovery;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ZookeeperServiceRegistry</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.client = CuratorFrameworkFactory.newClient(</span><br><span class="line">            <span class="string">&quot;localhost:2181&quot;</span>, </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ExponentialBackoffRetry</span>(<span class="number">1000</span>, <span class="number">3</span>)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">this</span>.serviceDiscovery = ServiceDiscoveryBuilder.builder(TestNodeMetadata.class)</span><br><span class="line">            .client(client)</span><br><span class="line">            .basePath(<span class="string">&quot;/test/services&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerTestNode</span><span class="params">(TestNodeInfo nodeInfo)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ServiceInstance&lt;TestNodeMetadata&gt; instance = ServiceInstance.&lt;TestNodeMetadata&gt;builder()</span><br><span class="line">                .name(<span class="string">&quot;test-client&quot;</span>)</span><br><span class="line">                .id(nodeInfo.getNodeId())</span><br><span class="line">                .address(nodeInfo.getHost())</span><br><span class="line">                .port(nodeInfo.getPort())</span><br><span class="line">                .payload(<span class="keyword">new</span> <span class="title class_">TestNodeMetadata</span>(nodeInfo))</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">            serviceDiscovery.registerService(instance);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Create ephemeral sequential node for load balancing</span></span><br><span class="line">            client.create()</span><br><span class="line">                .withMode(CreateMode.EPHEMERAL_SEQUENTIAL)</span><br><span class="line">                .forPath(<span class="string">&quot;/test/clients/client-&quot;</span>, nodeInfo.serialize());</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceRegistrationException</span>(<span class="string">&quot;Failed to register test node&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> List&lt;TestNodeInfo&gt; <span class="title function_">discoverAvailableNodes</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Collection&lt;ServiceInstance&lt;TestNodeMetadata&gt;&gt; instances = </span><br><span class="line">                serviceDiscovery.queryForInstances(<span class="string">&quot;test-client&quot;</span>);</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">return</span> instances.stream()</span><br><span class="line">                .map(instance -&gt; instance.getPayload().getNodeInfo())</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceDiscoveryException</span>(<span class="string">&quot;Failed to discover test nodes&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Distributed-Coordination-and-Synchronization"><a href="#Distributed-Coordination-and-Synchronization" class="headerlink" title="Distributed Coordination and Synchronization"></a>Distributed Coordination and Synchronization</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributedTestCoordinator</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CuratorFramework client;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DistributedBarrier startBarrier;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DistributedBarrier endBarrier;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InterProcessMutex configLock;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DistributedTestCoordinator</span><span class="params">(CuratorFramework client)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.client = client;</span><br><span class="line">        <span class="built_in">this</span>.startBarrier = <span class="keyword">new</span> <span class="title class_">DistributedBarrier</span>(client, <span class="string">&quot;/test/barriers/start&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.endBarrier = <span class="keyword">new</span> <span class="title class_">DistributedBarrier</span>(client, <span class="string">&quot;/test/barriers/end&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.configLock = <span class="keyword">new</span> <span class="title class_">InterProcessMutex</span>(client, <span class="string">&quot;/test/locks/config&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">coordinateTestStart</span><span class="params">(<span class="type">int</span> expectedClients)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// Wait for all clients to be ready</span></span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">clientReadyLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(expectedClients);</span><br><span class="line">        </span><br><span class="line">        <span class="type">PathChildrenCache</span> <span class="variable">clientCache</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PathChildrenCache</span>(client, <span class="string">&quot;/test/clients&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        clientCache.getListenable().addListener((cache, event) -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (event.getType() == PathChildrenCacheEvent.Type.CHILD_ADDED) &#123;</span><br><span class="line">                clientReadyLatch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        clientCache.start();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Wait for all clients with timeout</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">allReady</span> <span class="operator">=</span> clientReadyLatch.await(<span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">if</span> (!allReady) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TestCoordinationException</span>(<span class="string">&quot;Not all clients ready within timeout&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Set start barrier to begin test</span></span><br><span class="line">        startBarrier.setBarrier();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Signal all clients to start</span></span><br><span class="line">        client.setData().forPath(<span class="string">&quot;/test/control/command&quot;</span>, <span class="string">&quot;START&quot;</span>.getBytes());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">waitForTestCompletion</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// Wait for end barrier</span></span><br><span class="line">        endBarrier.waitOnBarrier();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Cleanup</span></span><br><span class="line">        cleanupTestResources();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateConfigurationSafely</span><span class="params">(TaskConfiguration newConfig)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// Acquire distributed lock</span></span><br><span class="line">        <span class="keyword">if</span> (configLock.acquire(<span class="number">10</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Atomic configuration update</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">configPath</span> <span class="operator">=</span> <span class="string">&quot;/test/config&quot;</span>;</span><br><span class="line">                <span class="type">Stat</span> <span class="variable">stat</span> <span class="operator">=</span> client.checkExists().forPath(configPath);</span><br><span class="line">                </span><br><span class="line">                client.setData()</span><br><span class="line">                    .withVersion(stat.getVersion())</span><br><span class="line">                    .forPath(configPath, JsonUtils.toJson(newConfig).getBytes());</span><br><span class="line">                    </span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                configLock.release();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConfigurationException</span>(<span class="string">&quot;Failed to acquire configuration lock&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Question</strong>: <em>How do you handle network partitions and split-brain scenarios in your distributed testing system?</em></p>
<p><strong>Answer</strong>: We implement several safeguards: 1) Use Zookeepers session timeouts to detect node failures quickly. 2) Implement a master election process using Curators LeaderSelector to prevent split-brain. 3) Use distributed barriers to ensure synchronized test phases. 4) Implement exponential backoff retry policies for transient network issues. 5) Set minimum quorum requirements - tests only proceed if sufficient client nodes are available. 6) Use Zookeepers strong consistency guarantees to maintain authoritative state.</p>
<h2 id="High-Performance-Netty-Implementation"><a href="#High-Performance-Netty-Implementation" class="headerlink" title="High-Performance Netty Implementation"></a>High-Performance Netty Implementation</h2><h3 id="Netty-HTTP-Client-Configuration"><a href="#Netty-HTTP-Client-Configuration" class="headerlink" title="Netty HTTP Client Configuration"></a>Netty HTTP Client Configuration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyHttpClientConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> NettyHttpClient <span class="title function_">createHttpClient</span><span class="params">(TaskConfiguration config)</span> &#123;</span><br><span class="line">        <span class="type">NettyConfiguration</span> <span class="variable">nettyConfig</span> <span class="operator">=</span> config.getNettyConfig();</span><br><span class="line">        </span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(nettyConfig.getWorkerThreads());</span><br><span class="line">        </span><br><span class="line">        <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>()</span><br><span class="line">            .group(workerGroup)</span><br><span class="line">            .channel(NioSocketChannel.class)</span><br><span class="line">            .option(ChannelOption.SO_KEEPALIVE, nettyConfig.isKeepAlive())</span><br><span class="line">            .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, nettyConfig.getConnectTimeoutMs())</span><br><span class="line">            .option(ChannelOption.SO_REUSEADDR, <span class="literal">true</span>)</span><br><span class="line">            .option(ChannelOption.TCP_NODELAY, <span class="literal">true</span>)</span><br><span class="line">            .option(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT)</span><br><span class="line">            .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> &#123;</span><br><span class="line">                    <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> ch.pipeline();</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// HTTP codec</span></span><br><span class="line">                    pipeline.addLast(<span class="keyword">new</span> <span class="title class_">HttpClientCodec</span>());</span><br><span class="line">                    pipeline.addLast(<span class="keyword">new</span> <span class="title class_">HttpObjectAggregator</span>(<span class="number">1048576</span>)); <span class="comment">// 1MB max</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// Compression</span></span><br><span class="line">                    pipeline.addLast(<span class="keyword">new</span> <span class="title class_">HttpContentDecompressor</span>());</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// Timeout handlers</span></span><br><span class="line">                    pipeline.addLast(<span class="keyword">new</span> <span class="title class_">ReadTimeoutHandler</span>(nettyConfig.getReadTimeoutMs(), TimeUnit.MILLISECONDS));</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// Custom handler for metrics and response processing</span></span><br><span class="line">                    pipeline.addLast(<span class="keyword">new</span> <span class="title class_">HttpResponseHandler</span>());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">NettyHttpClient</span>(bootstrap, workerGroup);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="High-Performance-Request-Execution"><a href="#High-Performance-Request-Execution" class="headerlink" title="High-Performance Request Execution"></a>High-Performance Request Execution</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpResponseHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;FullHttpResponse&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MetricsCollector metricsCollector;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">requestStartTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> &#123;</span><br><span class="line">        requestStartTime.set(System.nanoTime());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, FullHttpResponse response)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">responseTime</span> <span class="operator">=</span> System.nanoTime() - requestStartTime.get();</span><br><span class="line">        <span class="type">int</span> <span class="variable">statusCode</span> <span class="operator">=</span> response.status().code();</span><br><span class="line">        <span class="type">int</span> <span class="variable">responseSize</span> <span class="operator">=</span> response.content().readableBytes();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Record metrics</span></span><br><span class="line">        metricsCollector.recordRequest(responseTime, statusCode, responseSize);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Handle response based on status</span></span><br><span class="line">        <span class="keyword">if</span> (statusCode &gt;= <span class="number">200</span> &amp;&amp; statusCode &lt; <span class="number">300</span>) &#123;</span><br><span class="line">            handleSuccessResponse(response);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            handleErrorResponse(response, statusCode);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Close connection if not keep-alive</span></span><br><span class="line">        <span class="keyword">if</span> (!HttpUtil.isKeepAlive(response)) &#123;</span><br><span class="line">            ctx.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">responseTime</span> <span class="operator">=</span> System.nanoTime() - requestStartTime.get();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Record error metrics</span></span><br><span class="line">        metricsCollector.recordRequest(responseTime, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        logger.error(<span class="string">&quot;Request failed&quot;</span>, cause);</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleSuccessResponse</span><span class="params">(FullHttpResponse response)</span> &#123;</span><br><span class="line">        <span class="comment">// Process successful response</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">contentType</span> <span class="operator">=</span> response.headers().get(HttpHeaderNames.CONTENT_TYPE);</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">content</span> <span class="operator">=</span> response.content();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Optional: Validate response content</span></span><br><span class="line">        <span class="keyword">if</span> (contentType != <span class="literal">null</span> &amp;&amp; contentType.contains(<span class="string">&quot;application/json&quot;</span>)) &#123;</span><br><span class="line">            validateJsonResponse(content.toString(StandardCharsets.UTF_8));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Connection-Pool-Management"><a href="#Connection-Pool-Management" class="headerlink" title="Connection Pool Management"></a>Connection Pool Management</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyConnectionPoolManager</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Channel&gt; connectionPool = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">connectionCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> maxConnections;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NettyConnectionPoolManager</span><span class="params">(NettyConfiguration config)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.maxConnections = config.getMaxConnections();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Channel <span class="title function_">getConnection</span><span class="params">(String host, <span class="type">int</span> port)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> host + <span class="string">&quot;:&quot;</span> + port;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> connectionPool.computeIfAbsent(key, k -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (connectionCount.get() &gt;= maxConnections) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConnectionPoolExhaustedException</span>(<span class="string">&quot;Connection pool exhausted&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> createNewConnection(host, port);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Channel <span class="title function_">createNewConnection</span><span class="params">(String host, <span class="type">int</span> port)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> bootstrap.connect(host, port);</span><br><span class="line">            <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> future.sync().channel();</span><br><span class="line">            </span><br><span class="line">            connectionCount.incrementAndGet();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Add close listener to update connection count</span></span><br><span class="line">            channel.closeFuture().addListener(closeFuture -&gt; &#123;</span><br><span class="line">                connectionCount.decrementAndGet();</span><br><span class="line">                connectionPool.remove(host + <span class="string">&quot;:&quot;</span> + port);</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> channel;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConnectionException</span>(<span class="string">&quot;Failed to create connection&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">closeAllConnections</span><span class="params">()</span> &#123;</span><br><span class="line">        connectionPool.values().forEach(Channel::close);</span><br><span class="line">        connectionPool.clear();</span><br><span class="line">        connectionCount.set(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Dashboard-and-Visualization"><a href="#Dashboard-and-Visualization" class="headerlink" title="Dashboard and Visualization"></a>Dashboard and Visualization</h2><h3 id="Real-time-Dashboard-Backend"><a href="#Real-time-Dashboard-Backend" class="headerlink" title="Real-time Dashboard Backend"></a>Real-time Dashboard Backend</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/dashboard&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DashboardController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TestResultService testResultService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SimpMessagingTemplate messagingTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/tests/&#123;testId&#125;/metrics&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;TestMetrics&gt; <span class="title function_">getCurrentMetrics</span><span class="params">(<span class="meta">@PathVariable</span> String testId)</span> &#123;</span><br><span class="line">        <span class="type">TestMetrics</span> <span class="variable">metrics</span> <span class="operator">=</span> testResultService.getCurrentMetrics(testId);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(metrics);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/tests/&#123;testId&#125;/timeline&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;List&lt;TimelineData&gt;&gt; <span class="title function_">getMetricsTimeline</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@PathVariable</span> String testId,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(defaultValue = &quot;300&quot;)</span> <span class="type">int</span> seconds)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        List&lt;TimelineData&gt; timeline = testResultService.getMetricsTimeline(testId, seconds);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(timeline);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMetricsUpdate</span><span class="params">(MetricsUpdateEvent event)</span> &#123;</span><br><span class="line">        <span class="comment">// Broadcast real-time metrics to WebSocket clients</span></span><br><span class="line">        messagingTemplate.convertAndSend(</span><br><span class="line">            <span class="string">&quot;/topic/metrics/&quot;</span> + event.getTestId(),</span><br><span class="line">            event.getMetrics()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/tests/&#123;testId&#125;/report&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;TestReport&gt; <span class="title function_">generateReport</span><span class="params">(<span class="meta">@PathVariable</span> String testId)</span> &#123;</span><br><span class="line">        <span class="type">TestReport</span> <span class="variable">report</span> <span class="operator">=</span> testResultService.generateComprehensiveReport(testId);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(report);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="WebSocket-Configuration-for-Real-time-Updates"><a href="#WebSocket-Configuration-for-Real-time-Updates" class="headerlink" title="WebSocket Configuration for Real-time Updates"></a>WebSocket Configuration for Real-time Updates</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSocketMessageBroker</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketConfig</span> <span class="keyword">implements</span> <span class="title class_">WebSocketMessageBrokerConfigurer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureMessageBroker</span><span class="params">(MessageBrokerRegistry config)</span> &#123;</span><br><span class="line">        config.enableSimpleBroker(<span class="string">&quot;/topic&quot;</span>);</span><br><span class="line">        config.setApplicationDestinationPrefixes(<span class="string">&quot;/app&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerStompEndpoints</span><span class="params">(StompEndpointRegistry registry)</span> &#123;</span><br><span class="line">        registry.addEndpoint(<span class="string">&quot;/websocket&quot;</span>)</span><br><span class="line">            .setAllowedOriginPatterns(<span class="string">&quot;*&quot;</span>)</span><br><span class="line">            .withSockJS();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Frontend-Dashboard-Components"><a href="#Frontend-Dashboard-Components" class="headerlink" title="Frontend Dashboard Components"></a>Frontend Dashboard Components</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Real-time metrics dashboard component</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MetricsDashboard</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">testId</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">testId</span> = testId;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">socket</span> = <span class="keyword">new</span> <span class="title class_">SockJS</span>(<span class="string">&#x27;/websocket&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">stompClient</span> = <span class="title class_">Stomp</span>.<span class="title function_">over</span>(<span class="variable language_">this</span>.<span class="property">socket</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">charts</span> = &#123;&#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">initializeCharts</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">connectWebSocket</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">initializeCharts</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// QPS Chart</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">charts</span>.<span class="property">qps</span> = <span class="keyword">new</span> <span class="title class_">Chart</span>(<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;qpsChart&#x27;</span>), &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;line&#x27;</span>,</span><br><span class="line">            <span class="attr">data</span>: &#123;</span><br><span class="line">                <span class="attr">labels</span>: [],</span><br><span class="line">                <span class="attr">datasets</span>: [&#123;</span><br><span class="line">                    <span class="attr">label</span>: <span class="string">&#x27;QPS&#x27;</span>,</span><br><span class="line">                    <span class="attr">data</span>: [],</span><br><span class="line">                    <span class="attr">borderColor</span>: <span class="string">&#x27;rgb(75, 192, 192)&#x27;</span>,</span><br><span class="line">                    <span class="attr">tension</span>: <span class="number">0.1</span></span><br><span class="line">                &#125;]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">options</span>: &#123;</span><br><span class="line">                <span class="attr">responsive</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">scales</span>: &#123;</span><br><span class="line">                    <span class="attr">y</span>: &#123;</span><br><span class="line">                        <span class="attr">beginAtZero</span>: <span class="literal">true</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">plugins</span>: &#123;</span><br><span class="line">                    <span class="attr">title</span>: &#123;</span><br><span class="line">                        <span class="attr">display</span>: <span class="literal">true</span>,</span><br><span class="line">                        <span class="attr">text</span>: <span class="string">&#x27;Queries Per Second&#x27;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Response Time Chart</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">charts</span>.<span class="property">responseTime</span> = <span class="keyword">new</span> <span class="title class_">Chart</span>(<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;responseTimeChart&#x27;</span>), &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;line&#x27;</span>,</span><br><span class="line">            <span class="attr">data</span>: &#123;</span><br><span class="line">                <span class="attr">labels</span>: [],</span><br><span class="line">                <span class="attr">datasets</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">label</span>: <span class="string">&#x27;Average&#x27;</span>,</span><br><span class="line">                        <span class="attr">data</span>: [],</span><br><span class="line">                        <span class="attr">borderColor</span>: <span class="string">&#x27;rgb(54, 162, 235)&#x27;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">label</span>: <span class="string">&#x27;P95&#x27;</span>,</span><br><span class="line">                        <span class="attr">data</span>: [],</span><br><span class="line">                        <span class="attr">borderColor</span>: <span class="string">&#x27;rgb(255, 206, 86)&#x27;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">label</span>: <span class="string">&#x27;P99&#x27;</span>,</span><br><span class="line">                        <span class="attr">data</span>: [],</span><br><span class="line">                        <span class="attr">borderColor</span>: <span class="string">&#x27;rgb(255, 99, 132)&#x27;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">options</span>: &#123;</span><br><span class="line">                <span class="attr">responsive</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">scales</span>: &#123;</span><br><span class="line">                    <span class="attr">y</span>: &#123;</span><br><span class="line">                        <span class="attr">beginAtZero</span>: <span class="literal">true</span>,</span><br><span class="line">                        <span class="attr">title</span>: &#123;</span><br><span class="line">                            <span class="attr">display</span>: <span class="literal">true</span>,</span><br><span class="line">                            <span class="attr">text</span>: <span class="string">&#x27;Response Time (ms)&#x27;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">connectWebSocket</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">stompClient</span>.<span class="title function_">connect</span>(&#123;&#125;, <span class="function">(<span class="params">frame</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Connected: &#x27;</span> + frame);</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">stompClient</span>.<span class="title function_">subscribe</span>(<span class="string">`/topic/metrics/<span class="subst">$&#123;<span class="variable language_">this</span>.testId&#125;</span>`</span>, <span class="function">(<span class="params">message</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> metrics = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(message.<span class="property">body</span>);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">updateCharts</span>(metrics);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">updateMetricCards</span>(metrics);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">updateCharts</span>(<span class="params">metrics</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> timestamp = <span class="keyword">new</span> <span class="title class_">Date</span>(metrics.<span class="property">timestamp</span>).<span class="title function_">toLocaleTimeString</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Update QPS chart</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">addDataPoint</span>(<span class="variable language_">this</span>.<span class="property">charts</span>.<span class="property">qps</span>, timestamp, metrics.<span class="property">qps</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Update Response Time chart</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">addDataPoint</span>(<span class="variable language_">this</span>.<span class="property">charts</span>.<span class="property">responseTime</span>, timestamp, [</span><br><span class="line">            metrics.<span class="property">avgResponseTime</span>,</span><br><span class="line">            metrics.<span class="property">p95ResponseTime</span>,</span><br><span class="line">            metrics.<span class="property">p99ResponseTime</span></span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">addDataPoint</span>(<span class="params">chart, label, data</span>) &#123;</span><br><span class="line">        chart.<span class="property">data</span>.<span class="property">labels</span>.<span class="title function_">push</span>(label);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(data)) &#123;</span><br><span class="line">            data.<span class="title function_">forEach</span>(<span class="function">(<span class="params">value, index</span>) =&gt;</span> &#123;</span><br><span class="line">                chart.<span class="property">data</span>.<span class="property">datasets</span>[index].<span class="property">data</span>.<span class="title function_">push</span>(value);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            chart.<span class="property">data</span>.<span class="property">datasets</span>[<span class="number">0</span>].<span class="property">data</span>.<span class="title function_">push</span>(data);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Keep only last 50 data points</span></span><br><span class="line">        <span class="keyword">if</span> (chart.<span class="property">data</span>.<span class="property">labels</span>.<span class="property">length</span> &gt; <span class="number">50</span>) &#123;</span><br><span class="line">            chart.<span class="property">data</span>.<span class="property">labels</span>.<span class="title function_">shift</span>();</span><br><span class="line">            chart.<span class="property">data</span>.<span class="property">datasets</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">dataset</span> =&gt;</span> dataset.<span class="property">data</span>.<span class="title function_">shift</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        chart.<span class="title function_">update</span>(<span class="string">&#x27;none&#x27;</span>); <span class="comment">// No animation for better performance</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">updateMetricCards</span>(<span class="params">metrics</span>) &#123;</span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;currentQps&#x27;</span>).<span class="property">textContent</span> = metrics.<span class="property">qps</span>.<span class="title function_">toFixed</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;avgResponseTime&#x27;</span>).<span class="property">textContent</span> = metrics.<span class="property">avgResponseTime</span>.<span class="title function_">toFixed</span>(<span class="number">2</span>) + <span class="string">&#x27; ms&#x27;</span>;</span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;errorRate&#x27;</span>).<span class="property">textContent</span> = (metrics.<span class="property">errorRate</span> * <span class="number">100</span>).<span class="title function_">toFixed</span>(<span class="number">2</span>) + <span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;activeConnections&#x27;</span>).<span class="property">textContent</span> = metrics.<span class="property">activeConnections</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Production-Deployment-Considerations"><a href="#Production-Deployment-Considerations" class="headerlink" title="Production Deployment Considerations"></a>Production Deployment Considerations</h2><h3 id="Docker-Configuration"><a href="#Docker-Configuration" class="headerlink" title="Docker Configuration"></a>Docker Configuration</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ClientTestNode Dockerfile</span></span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">17</span>-jre-slim</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Install monitoring tools</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y \</span></span><br><span class="line"><span class="language-bash">    curl \</span></span><br><span class="line"><span class="language-bash">    netcat \</span></span><br><span class="line"><span class="language-bash">    htop \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> target/client-test-node.jar app.jar</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># JVM optimization for load testing</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_OPTS=<span class="string">&quot;-Xms2g -Xmx4g -XX:+UseG1GC -XX:+UseStringDeduplication -XX:MaxGCPauseMillis=200 -Dio.netty.allocator.type=pooled -Dio.netty.allocator.numDirectArenas=8&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span> <span class="number">8081</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">HEALTHCHECK</span><span class="language-bash"> --interval=30s --<span class="built_in">timeout</span>=10s --start-period=60s --retries=3 \</span></span><br><span class="line"><span class="language-bash">  CMD curl -f http://localhost:8080/actuator/health || <span class="built_in">exit</span> 1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;java <span class="variable">$JAVA_OPTS</span> -jar app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h3 id="Kubernetes-Deployment"><a href="#Kubernetes-Deployment" class="headerlink" title="Kubernetes Deployment"></a>Kubernetes Deployment</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># client-test-node-deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">client-test-node</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">client-test-node</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">client-test-node</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">client-test-node</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">client-test-node</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">your-registry/client-test-node:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8081</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ZOOKEEPER_HOSTS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;zookeeper:2181&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_ID</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_IP</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">status.podIP</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;2Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;1000m&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;4Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;2000m&quot;</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/actuator/health</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/actuator/ready</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">client-test-node-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">client-test-node</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">metrics</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8081</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br></pre></td></tr></table></figure>

<h3 id="Monitoring-and-Observability"><a href="#Monitoring-and-Observability" class="headerlink" title="Monitoring and Observability"></a>Monitoring and Observability</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SystemMonitor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService scheduler;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SystemMonitor</span><span class="params">(MeterRegistry meterRegistry)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.meterRegistry = meterRegistry;</span><br><span class="line">        <span class="built_in">this</span>.scheduler = Executors.newScheduledThreadPool(<span class="number">2</span>);</span><br><span class="line">        initializeMetrics();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initializeMetrics</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// JVM metrics</span></span><br><span class="line">        Metrics.gauge(<span class="string">&quot;jvm.memory.heap.used&quot;</span>, <span class="built_in">this</span>, monitor -&gt; getHeapMemoryUsed());</span><br><span class="line">        Metrics.gauge(<span class="string">&quot;jvm.memory.heap.max&quot;</span>, <span class="built_in">this</span>, monitor -&gt; getHeapMemoryMax());</span><br><span class="line">        Metrics.gauge(<span class="string">&quot;jvm.gc.pause&quot;</span>, <span class="built_in">this</span>, monitor -&gt; getGCPauseTime());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Netty metrics</span></span><br><span class="line">        Metrics.gauge(<span class="string">&quot;netty.connections.active&quot;</span>, <span class="built_in">this</span>, monitor -&gt; getActiveConnections());</span><br><span class="line">        Metrics.gauge(<span class="string">&quot;netty.buffer.memory.used&quot;</span>, <span class="built_in">this</span>, monitor -&gt; getBufferMemoryUsed());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// System metrics</span></span><br><span class="line">        Metrics.gauge(<span class="string">&quot;system.cpu.usage&quot;</span>, <span class="built_in">this</span>, monitor -&gt; getCpuUsage());</span><br><span class="line">        Metrics.gauge(<span class="string">&quot;system.memory.usage&quot;</span>, <span class="built_in">this</span>, monitor -&gt; getSystemMemoryUsage());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Custom application metrics</span></span><br><span class="line">        scheduler.scheduleAtFixedRate(<span class="built_in">this</span>::collectCustomMetrics, <span class="number">0</span>, <span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">collectCustomMetrics</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Network interface metrics</span></span><br><span class="line">        NetworkInterface[] interfaces = NetworkInterface.getNetworkInterfaces();</span><br><span class="line">        <span class="keyword">for</span> (NetworkInterface ni : interfaces) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ni.isUp() &amp;&amp; !ni.isLoopback()) &#123;</span><br><span class="line">                Metrics.gauge(<span class="string">&quot;network.bytes.sent&quot;</span>, </span><br><span class="line">                    Tags.of(<span class="string">&quot;interface&quot;</span>, ni.getName()), </span><br><span class="line">                    ni.getBytesRecv());</span><br><span class="line">                Metrics.gauge(<span class="string">&quot;network.bytes.received&quot;</span>, </span><br><span class="line">                    Tags.of(<span class="string">&quot;interface&quot;</span>, ni.getName()), </span><br><span class="line">                    ni.getBytesSent());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Thread pool metrics</span></span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> (ThreadPoolExecutor) </span><br><span class="line">            ((ScheduledThreadPoolExecutor) scheduler);</span><br><span class="line">        Metrics.gauge(<span class="string">&quot;thread.pool.active&quot;</span>, executor.getActiveCount());</span><br><span class="line">        Metrics.gauge(<span class="string">&quot;thread.pool.queue.size&quot;</span>, executor.getQueue().size());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleTestEvent</span><span class="params">(TestEvent event)</span> &#123;</span><br><span class="line">        Metrics.counter(<span class="string">&quot;test.events&quot;</span>, </span><br><span class="line">            Tags.of(<span class="string">&quot;type&quot;</span>, event.getType().name(),</span><br><span class="line">                   <span class="string">&quot;status&quot;</span>, event.getStatus().name()))</span><br><span class="line">            .increment();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Question</strong>: <em>How do you handle resource management and prevent memory leaks in a long-running load testing system?</em></p>
<p><strong>Answer</strong>: We implement comprehensive resource management: 1) Use Nettys pooled allocators to reduce GC pressure. 2) Configure appropriate JVM heap sizes and use G1GC for low-latency collection. 3) Implement proper connection lifecycle management with connection pooling. 4) Use weak references for caches and implement cache eviction policies. 5) Monitor memory usage through JMX and set up alerts for memory leaks. 6) Implement graceful shutdown procedures to clean up resources. 7) Use profiling tools like async-profiler to identify memory hotspots.</p>
<h2 id="Advanced-Use-Cases-and-Examples"><a href="#Advanced-Use-Cases-and-Examples" class="headerlink" title="Advanced Use Cases and Examples"></a>Advanced Use Cases and Examples</h2><h3 id="Scenario-1-E-commerce-Flash-Sale-Testing"><a href="#Scenario-1-E-commerce-Flash-Sale-Testing" class="headerlink" title="Scenario 1: E-commerce Flash Sale Testing"></a>Scenario 1: E-commerce Flash Sale Testing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlashSaleTestScenario</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> TaskConfiguration <span class="title function_">createFlashSaleTest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> TaskConfiguration.builder()</span><br><span class="line">            .testId(<span class="string">&quot;flash-sale-2024&quot;</span>)</span><br><span class="line">            .targetUrl(<span class="string">&quot;https://api.ecommerce.com/products/flash-sale&quot;</span>)</span><br><span class="line">            .method(HttpMethod.POST)</span><br><span class="line">            .headers(Map.of(</span><br><span class="line">                <span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>,</span><br><span class="line">                <span class="string">&quot;User-Agent&quot;</span>, <span class="string">&quot;LoadTester/1.0&quot;</span></span><br><span class="line">            ))</span><br><span class="line">            .requestBody(generateRandomPurchaseRequest())</span><br><span class="line">            .loadPattern(LoadPattern.builder()</span><br><span class="line">                .type(LoadType.SPIKE)</span><br><span class="line">                .steps(Arrays.asList(</span><br><span class="line">                    LoadStep.of(Duration.ofMinutes(<span class="number">2</span>), <span class="number">100</span>, <span class="number">10</span>),   <span class="comment">// Warm-up</span></span><br><span class="line">                    LoadStep.of(Duration.ofMinutes(<span class="number">1</span>), <span class="number">5000</span>, <span class="number">500</span>), <span class="comment">// Spike</span></span><br><span class="line">                    LoadStep.of(Duration.ofMinutes(<span class="number">5</span>), <span class="number">2000</span>, <span class="number">200</span>), <span class="comment">// Sustained</span></span><br><span class="line">                    LoadStep.of(Duration.ofMinutes(<span class="number">2</span>), <span class="number">100</span>, <span class="number">10</span>)    <span class="comment">// Cool-down</span></span><br><span class="line">                ))</span><br><span class="line">                .build())</span><br><span class="line">            .duration(Duration.ofMinutes(<span class="number">10</span>))</span><br><span class="line">            .retryPolicy(RetryPolicy.builder()</span><br><span class="line">                .maxRetries(<span class="number">3</span>)</span><br><span class="line">                .backoffStrategy(BackoffStrategy.EXPONENTIAL)</span><br><span class="line">                .build())</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">generateRandomPurchaseRequest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">                &quot;productId&quot;: &quot;%s&quot;,</span></span><br><span class="line"><span class="string">                &quot;quantity&quot;: %d,</span></span><br><span class="line"><span class="string">                &quot;userId&quot;: &quot;%s&quot;,</span></span><br><span class="line"><span class="string">                &quot;paymentMethod&quot;: &quot;credit_card&quot;,</span></span><br><span class="line"><span class="string">                &quot;shippingAddress&quot;: &#123;</span></span><br><span class="line"><span class="string">                    &quot;street&quot;: &quot;123 Test St&quot;,</span></span><br><span class="line"><span class="string">                    &quot;city&quot;: &quot;Test City&quot;,</span></span><br><span class="line"><span class="string">                    &quot;zipCode&quot;: &quot;12345&quot;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>.formatted(</span><br><span class="line">                generateRandomProductId(), </span><br><span class="line">                ThreadLocalRandom.current().nextInt(<span class="number">1</span>, <span class="number">5</span>),</span><br><span class="line">                generateRandomUserId()</span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Scenario-2-Gradual-Ramp-up-Testing"><a href="#Scenario-2-Gradual-Ramp-up-Testing" class="headerlink" title="Scenario 2: Gradual Ramp-up Testing"></a>Scenario 2: Gradual Ramp-up Testing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GradualRampUpTestScenario</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> TaskConfiguration <span class="title function_">createRampUpTest</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;LoadStep&gt; rampUpSteps = IntStream.range(<span class="number">0</span>, <span class="number">10</span>)</span><br><span class="line">            .mapToObj(i -&gt; LoadStep.of(</span><br><span class="line">                Duration.ofMinutes(<span class="number">2</span>),</span><br><span class="line">                <span class="number">100</span> + (i * <span class="number">200</span>), <span class="comment">// QPS: 100, 300, 500, 700, 900...</span></span><br><span class="line">                <span class="number">10</span> + (i * <span class="number">20</span>)    <span class="comment">// Concurrency: 10, 30, 50, 70, 90...</span></span><br><span class="line">            ))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> TaskConfiguration.builder()</span><br><span class="line">            .testId(<span class="string">&quot;gradual-ramp-up&quot;</span>)</span><br><span class="line">            .targetUrl(<span class="string">&quot;https://api.service.com/endpoint&quot;</span>)</span><br><span class="line">            .method(HttpMethod.GET)</span><br><span class="line">            .loadPattern(LoadPattern.builder()</span><br><span class="line">                .type(LoadType.RAMP_UP)</span><br><span class="line">                .steps(rampUpSteps)</span><br><span class="line">                .build())</span><br><span class="line">            .duration(Duration.ofMinutes(<span class="number">20</span>))</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Scenario-3-API-Rate-Limiting-Validation"><a href="#Scenario-3-API-Rate-Limiting-Validation" class="headerlink" title="Scenario 3: API Rate Limiting Validation"></a>Scenario 3: API Rate Limiting Validation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RateLimitingTestScenario</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRateLimiting</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">TaskConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> TaskConfiguration.builder()</span><br><span class="line">            .testId(<span class="string">&quot;rate-limiting-validation&quot;</span>)</span><br><span class="line">            .targetUrl(<span class="string">&quot;https://api.service.com/rate-limited-endpoint&quot;</span>)</span><br><span class="line">            .method(HttpMethod.GET)</span><br><span class="line">            .headers(Map.of(<span class="string">&quot;API-Key&quot;</span>, <span class="string">&quot;test-key&quot;</span>))</span><br><span class="line">            .qps(<span class="number">1000</span>) <span class="comment">// Exceed rate limit intentionally</span></span><br><span class="line">            .concurrency(<span class="number">100</span>)</span><br><span class="line">            .duration(Duration.ofMinutes(<span class="number">5</span>))</span><br><span class="line">            .build();</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// Custom result validator</span></span><br><span class="line">        <span class="type">TestResultValidator</span> <span class="variable">validator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestResultValidator</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> ValidationResult <span class="title function_">validate</span><span class="params">(TestResult result)</span> &#123;</span><br><span class="line">                <span class="type">double</span> <span class="variable">rateLimitErrorRate</span> <span class="operator">=</span> result.getErrorsByStatus().get(<span class="number">429</span>) / </span><br><span class="line">                    (<span class="type">double</span>) result.getTotalRequests() * <span class="number">100</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">if</span> (rateLimitErrorRate &lt; <span class="number">10</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ValidationResult.failed(<span class="string">&quot;Rate limiting not working properly&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (result.getP99ResponseTime() &gt; <span class="number">5000</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ValidationResult.failed(<span class="string">&quot;Response time too high under rate limiting&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> ValidationResult.passed();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        executeTestWithValidation(config, validator);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Error-Handling-and-Resilience"><a href="#Error-Handling-and-Resilience" class="headerlink" title="Error Handling and Resilience"></a>Error Handling and Resilience</h2><h3 id="Circuit-Breaker-Implementation"><a href="#Circuit-Breaker-Implementation" class="headerlink" title="Circuit Breaker Implementation"></a>Circuit Breaker Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CircuitBreakerTestClient</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CircuitBreaker circuitBreaker;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MetricsCollector metricsCollector;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CircuitBreakerTestClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.circuitBreaker = CircuitBreaker.ofDefaults(<span class="string">&quot;test-circuit-breaker&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.circuitBreaker.getEventPublisher()</span><br><span class="line">            .onStateTransition(event -&gt; </span><br><span class="line">                metricsCollector.recordCircuitBreakerEvent(event));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;HttpResponse&gt; <span class="title function_">executeRequest</span><span class="params">(HttpRequest request)</span> &#123;</span><br><span class="line">        Supplier&lt;CompletableFuture&lt;HttpResponse&gt;&gt; decoratedSupplier = </span><br><span class="line">            CircuitBreaker.decorateSupplier(circuitBreaker, () -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> httpClient.execute(request);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Request failed&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> Try.ofSupplier(decoratedSupplier)</span><br><span class="line">            .recover(throwable -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (throwable <span class="keyword">instanceof</span> CallNotPermittedException) &#123;</span><br><span class="line">                    <span class="comment">// Circuit breaker is open</span></span><br><span class="line">                    metricsCollector.recordCircuitBreakerOpen();</span><br><span class="line">                    <span class="keyword">return</span> CompletableFuture.completedFuture(</span><br><span class="line">                        HttpResponse.builder()</span><br><span class="line">                            .statusCode(<span class="number">503</span>)</span><br><span class="line">                            .body(<span class="string">&quot;Circuit breaker open&quot;</span>)</span><br><span class="line">                            .build()</span><br><span class="line">                    );</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> CompletableFuture.failedFuture(throwable);</span><br><span class="line">            &#125;)</span><br><span class="line">            .get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Retry-Strategy-with-Backoff"><a href="#Retry-Strategy-with-Backoff" class="headerlink" title="Retry Strategy with Backoff"></a>Retry Strategy with Backoff</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RetryableTestClient</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Retry retry;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TimeLimiter timeLimiter;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RetryableTestClient</span><span class="params">(RetryPolicy retryPolicy)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.retry = Retry.of(<span class="string">&quot;test-retry&quot;</span>, RetryConfig.custom()</span><br><span class="line">            .maxAttempts(retryPolicy.getMaxRetries())</span><br><span class="line">            .waitDuration(Duration.ofMillis(retryPolicy.getBaseDelayMs()))</span><br><span class="line">            .intervalFunction(IntervalFunction.ofExponentialBackoff(</span><br><span class="line">                retryPolicy.getBaseDelayMs(), </span><br><span class="line">                retryPolicy.getMultiplier()))</span><br><span class="line">            .retryOnException(throwable -&gt; </span><br><span class="line">                throwable <span class="keyword">instanceof</span> IOException || </span><br><span class="line">                throwable <span class="keyword">instanceof</span> TimeoutException)</span><br><span class="line">            .build());</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.timeLimiter = TimeLimiter.of(<span class="string">&quot;test-timeout&quot;</span>, TimeLimiterConfig.custom()</span><br><span class="line">            .timeoutDuration(Duration.ofSeconds(<span class="number">30</span>))</span><br><span class="line">            .build());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;HttpResponse&gt; <span class="title function_">executeWithRetry</span><span class="params">(HttpRequest request)</span> &#123;</span><br><span class="line">        Supplier&lt;CompletableFuture&lt;HttpResponse&gt;&gt; decoratedSupplier = </span><br><span class="line">            Decorators.ofSupplier(() -&gt; httpClient.execute(request))</span><br><span class="line">                .withRetry(retry)</span><br><span class="line">                .withTimeLimiter(timeLimiter)</span><br><span class="line">                .decorate();</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">return</span> decoratedSupplier.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Graceful-Degradation"><a href="#Graceful-Degradation" class="headerlink" title="Graceful Degradation"></a>Graceful Degradation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GracefulDegradationService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HealthIndicator healthIndicator;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AlertService alertService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleHighErrorRate</span><span class="params">(HighErrorRateEvent event)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (event.getErrorRate() &gt; <span class="number">50</span>) &#123;</span><br><span class="line">            <span class="comment">// Reduce load automatically</span></span><br><span class="line">            reduceTestLoad(event.getTestId(), <span class="number">0.5</span>); <span class="comment">// Reduce to 50%</span></span><br><span class="line">            alertService.sendAlert(<span class="string">&quot;High error rate detected, reducing load&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (event.getErrorRate() &gt; <span class="number">80</span>) &#123;</span><br><span class="line">            <span class="comment">// Stop test to prevent damage</span></span><br><span class="line">            stopTest(event.getTestId());</span><br><span class="line">            alertService.sendCriticalAlert(<span class="string">&quot;Critical error rate, test stopped&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleResourceExhaustion</span><span class="params">(ResourceExhaustionEvent event)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (event.getResourceType()) &#123;</span><br><span class="line">            <span class="keyword">case</span> MEMORY:</span><br><span class="line">                <span class="comment">// Trigger garbage collection and reduce batch sizes</span></span><br><span class="line">                System.gc();</span><br><span class="line">                adjustBatchSize(event.getTestId(), <span class="number">0.7</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CPU:</span><br><span class="line">                <span class="comment">// Reduce thread pool size</span></span><br><span class="line">                adjustThreadPoolSize(event.getTestId(), <span class="number">0.8</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> NETWORK:</span><br><span class="line">                <span class="comment">// Implement connection throttling</span></span><br><span class="line">                enableConnectionThrottling(event.getTestId());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">reduceTestLoad</span><span class="params">(String testId, <span class="type">double</span> factor)</span> &#123;</span><br><span class="line">        <span class="type">TaskConfiguration</span> <span class="variable">currentConfig</span> <span class="operator">=</span> getTestConfiguration(testId);</span><br><span class="line">        <span class="type">TaskConfiguration</span> <span class="variable">reducedConfig</span> <span class="operator">=</span> currentConfig.toBuilder()</span><br><span class="line">            .qps((<span class="type">int</span>) (currentConfig.getQps() * factor))</span><br><span class="line">            .concurrency((<span class="type">int</span>) (currentConfig.getConcurrency() * factor))</span><br><span class="line">            .build();</span><br><span class="line">            </span><br><span class="line">        updateTestConfiguration(testId, reducedConfig);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Security-and-Authentication"><a href="#Security-and-Authentication" class="headerlink" title="Security and Authentication"></a>Security and Authentication</h2><h3 id="Secure-Test-Execution"><a href="#Secure-Test-Execution" class="headerlink" title="Secure Test Execution"></a>Secure Test Execution</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecureTestExecutor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtTokenProvider tokenProvider;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CertificateManager certificateManager;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> TaskConfiguration <span class="title function_">createSecureTestConfig</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> TaskConfiguration.builder()</span><br><span class="line">            .testId(<span class="string">&quot;secure-api-test&quot;</span>)</span><br><span class="line">            .targetUrl(<span class="string">&quot;https://secure-api.company.com/endpoint&quot;</span>)</span><br><span class="line">            .method(HttpMethod.POST)</span><br><span class="line">            .headers(Map.of(</span><br><span class="line">                <span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;Bearer &quot;</span> + tokenProvider.generateTestToken(),</span><br><span class="line">                <span class="string">&quot;X-API-Key&quot;</span>, getApiKey(),</span><br><span class="line">                <span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span></span><br><span class="line">            ))</span><br><span class="line">            .sslConfig(SslConfig.builder()</span><br><span class="line">                .trustStore(certificateManager.getTrustStore())</span><br><span class="line">                .keyStore(certificateManager.getClientKeyStore())</span><br><span class="line">                .verifyHostname(<span class="literal">false</span>) <span class="comment">// Only for testing</span></span><br><span class="line">                .build())</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 300000)</span> <span class="comment">// Refresh every 5 minutes</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refreshSecurityTokens</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">newToken</span> <span class="operator">=</span> tokenProvider.refreshToken();</span><br><span class="line">        updateAllActiveTestsWithNewToken(newToken);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateAllActiveTestsWithNewToken</span><span class="params">(String newToken)</span> &#123;</span><br><span class="line">        List&lt;String&gt; activeTests = getActiveTestIds();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String testId : activeTests) &#123;</span><br><span class="line">            <span class="type">TaskConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> getTestConfiguration(testId);</span><br><span class="line">            Map&lt;String, String&gt; updatedHeaders = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(config.getHeaders());</span><br><span class="line">            updatedHeaders.put(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;Bearer &quot;</span> + newToken);</span><br><span class="line">            </span><br><span class="line">            <span class="type">TaskConfiguration</span> <span class="variable">updatedConfig</span> <span class="operator">=</span> config.toBuilder()</span><br><span class="line">                .headers(updatedHeaders)</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">            updateTestConfiguration(testId, updatedConfig);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SSL-TLS-Configuration"><a href="#SSL-TLS-Configuration" class="headerlink" title="SSL&#x2F;TLS Configuration"></a>SSL&#x2F;TLS Configuration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SSLConfiguration</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SslContext <span class="title function_">createSslContext</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> SslContextBuilder.forClient()</span><br><span class="line">            .trustManager(createTrustManagerFactory())</span><br><span class="line">            .keyManager(createKeyManagerFactory())</span><br><span class="line">            .protocols(<span class="string">&quot;TLSv1.2&quot;</span>, <span class="string">&quot;TLSv1.3&quot;</span>)</span><br><span class="line">            .ciphers(Arrays.asList(</span><br><span class="line">                <span class="string">&quot;TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384&quot;</span>,</span><br><span class="line">                <span class="string">&quot;TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256&quot;</span>,</span><br><span class="line">                <span class="string">&quot;TLS_DHE_RSA_WITH_AES_256_GCM_SHA384&quot;</span></span><br><span class="line">            ))</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> TrustManagerFactory <span class="title function_">createTrustManagerFactory</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">KeyStore</span> <span class="variable">trustStore</span> <span class="operator">=</span> KeyStore.getInstance(<span class="string">&quot;JKS&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">trustStoreStream</span> <span class="operator">=</span> getClass()</span><br><span class="line">                .getResourceAsStream(<span class="string">&quot;/ssl/truststore.jks&quot;</span>)) &#123;</span><br><span class="line">            trustStore.load(trustStoreStream, <span class="string">&quot;changeit&quot;</span>.toCharArray());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">TrustManagerFactory</span> <span class="variable">trustManagerFactory</span> <span class="operator">=</span> </span><br><span class="line">            TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());</span><br><span class="line">        trustManagerFactory.init(trustStore);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> trustManagerFactory;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Optimization-Techniques"><a href="#Performance-Optimization-Techniques" class="headerlink" title="Performance Optimization Techniques"></a>Performance Optimization Techniques</h2><h3 id="Memory-Management"><a href="#Memory-Management" class="headerlink" title="Memory Management"></a>Memory Management</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemoryOptimizedTestClient</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectPool&lt;ByteBuf&gt; bufferPool;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectPool&lt;StringBuilder&gt; stringBuilderPool;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MemoryOptimizedTestClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Use Netty&#x27;s pooled allocator</span></span><br><span class="line">        <span class="built_in">this</span>.bufferPool = <span class="keyword">new</span> <span class="title class_">DefaultObjectPool</span>&lt;&gt;(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">PooledObjectFactory</span>&lt;ByteBuf&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> ByteBuf <span class="title function_">create</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> PooledByteBufAllocator.DEFAULT.directBuffer(<span class="number">1024</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">(ByteBuf buffer)</span> &#123;</span><br><span class="line">                    buffer.release();</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reset</span><span class="params">(ByteBuf buffer)</span> &#123;</span><br><span class="line">                    buffer.clear();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// String builder pool for JSON construction</span></span><br><span class="line">        <span class="built_in">this</span>.stringBuilderPool = <span class="keyword">new</span> <span class="title class_">DefaultObjectPool</span>&lt;&gt;(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">PooledObjectFactory</span>&lt;StringBuilder&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> StringBuilder <span class="title function_">create</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="number">512</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">(StringBuilder sb)</span> &#123;</span><br><span class="line">                    <span class="comment">// No explicit destruction needed</span></span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reset</span><span class="params">(StringBuilder sb)</span> &#123;</span><br><span class="line">                    sb.setLength(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> HttpRequest <span class="title function_">createOptimizedRequest</span><span class="params">(RequestTemplate template)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> stringBuilderPool.borrowObject();</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">buffer</span> <span class="operator">=</span> bufferPool.borrowObject();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Build JSON request body efficiently</span></span><br><span class="line">            sb.append(<span class="string">&quot;&#123;&quot;</span>)</span><br><span class="line">              .append(<span class="string">&quot;\&quot;timestamp\&quot;:&quot;</span>).append(System.currentTimeMillis()).append(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">              .append(<span class="string">&quot;\&quot;data\&quot;:\&quot;&quot;</span>).append(template.getData()).append(<span class="string">&quot;\&quot;&quot;</span>)</span><br><span class="line">              .append(<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">              </span><br><span class="line">            <span class="comment">// Write to buffer</span></span><br><span class="line">            buffer.writeBytes(sb.toString().getBytes(StandardCharsets.UTF_8));</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> HttpRequest.builder()</span><br><span class="line">                .uri(template.getUri())</span><br><span class="line">                .method(template.getMethod())</span><br><span class="line">                .body(buffer.nioBuffer())</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            stringBuilderPool.returnObject(sb);</span><br><span class="line">            bufferPool.returnObject(buffer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CPU-Optimization"><a href="#CPU-Optimization" class="headerlink" title="CPU Optimization"></a>CPU Optimization</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CPUOptimizedTestExecutor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DisruptorEventBus eventBus;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AffinityExecutor affinityExecutor;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CPUOptimizedTestExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Use Disruptor for lock-free event processing</span></span><br><span class="line">        <span class="built_in">this</span>.eventBus = <span class="keyword">new</span> <span class="title class_">DisruptorEventBus</span>(<span class="string">&quot;test-events&quot;</span>, <span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// CPU affinity for better cache locality</span></span><br><span class="line">        <span class="built_in">this</span>.affinityExecutor = <span class="keyword">new</span> <span class="title class_">AffinityExecutor</span>(<span class="string">&quot;test-executor&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeHighPerformanceTest</span><span class="params">(TaskConfiguration config)</span> &#123;</span><br><span class="line">        <span class="comment">// Partition work across CPU cores</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">coreCount</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors();</span><br><span class="line">        <span class="type">int</span> <span class="variable">requestsPerCore</span> <span class="operator">=</span> config.getQps() / coreCount;</span><br><span class="line">        </span><br><span class="line">        List&lt;CompletableFuture&lt;Void&gt;&gt; futures = IntStream.range(<span class="number">0</span>, coreCount)</span><br><span class="line">            .mapToObj(coreId -&gt; </span><br><span class="line">                CompletableFuture.runAsync(</span><br><span class="line">                    () -&gt; executeOnCore(coreId, requestsPerCore, config),</span><br><span class="line">                    affinityExecutor.getExecutor(coreId)</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// Wait for all cores to complete</span></span><br><span class="line">        CompletableFuture.allOf(futures.toArray(<span class="keyword">new</span> <span class="title class_">CompletableFuture</span>[<span class="number">0</span>]))</span><br><span class="line">            .join();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">executeOnCore</span><span class="params">(<span class="type">int</span> coreId, <span class="type">int</span> requestCount, TaskConfiguration config)</span> &#123;</span><br><span class="line">        <span class="comment">// Pin thread to specific CPU core for better cache performance</span></span><br><span class="line">        <span class="type">AffinityLock</span> <span class="variable">lock</span> <span class="operator">=</span> AffinityLock.acquireLock(coreId);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">RateLimiter</span> <span class="variable">rateLimiter</span> <span class="operator">=</span> RateLimiter.create(requestCount);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; requestCount; i++) &#123;</span><br><span class="line">                rateLimiter.acquire();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// Execute request with minimal object allocation</span></span><br><span class="line">                executeRequestOptimized(config);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.release();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Troubleshooting-Common-Issues"><a href="#Troubleshooting-Common-Issues" class="headerlink" title="Troubleshooting Common Issues"></a>Troubleshooting Common Issues</h2><h3 id="Connection-Pool-Exhaustion"><a href="#Connection-Pool-Exhaustion" class="headerlink" title="Connection Pool Exhaustion"></a>Connection Pool Exhaustion</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConnectionPoolMonitor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConnectionPool connectionPool;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AlertService alertService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 10000)</span> <span class="comment">// Check every 10 seconds</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">monitorConnectionPool</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ConnectionPoolStats</span> <span class="variable">stats</span> <span class="operator">=</span> connectionPool.getStats();</span><br><span class="line">        </span><br><span class="line">        <span class="type">double</span> <span class="variable">utilizationRate</span> <span class="operator">=</span> (<span class="type">double</span>) stats.getActiveConnections() / </span><br><span class="line">                                stats.getMaxConnections();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (utilizationRate &gt; <span class="number">0.8</span>) &#123;</span><br><span class="line">            alertService.sendWarning(<span class="string">&quot;Connection pool utilization high: &quot;</span> + </span><br><span class="line">                                   (utilizationRate * <span class="number">100</span>) + <span class="string">&quot;%&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (utilizationRate &gt; <span class="number">0.95</span>) &#123;</span><br><span class="line">            <span class="comment">// Emergency action: increase pool size or throttle requests</span></span><br><span class="line">            connectionPool.increasePoolSize(stats.getMaxConnections() * <span class="number">2</span>);</span><br><span class="line">            alertService.sendCriticalAlert(<span class="string">&quot;Connection pool nearly exhausted, &quot;</span> +</span><br><span class="line">                                         <span class="string">&quot;increasing pool size&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Monitor for connection leaks</span></span><br><span class="line">        <span class="keyword">if</span> (stats.getLeakedConnections() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            alertService.sendAlert(<span class="string">&quot;Connection leak detected: &quot;</span> + </span><br><span class="line">                                 stats.getLeakedConnections() + <span class="string">&quot; connections&quot;</span>);</span><br><span class="line">            connectionPool.closeLeakedConnections();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Memory-Leak-Detection"><a href="#Memory-Leak-Detection" class="headerlink" title="Memory Leak Detection"></a>Memory Leak Detection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemoryLeakDetector</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MBeanServer mBeanServer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;MemorySnapshot&gt; snapshots = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 60000)</span> <span class="comment">// Check every minute</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkMemoryUsage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MemoryMXBean</span> <span class="variable">memoryBean</span> <span class="operator">=</span> ManagementFactory.getMemoryMXBean();</span><br><span class="line">        <span class="type">MemoryUsage</span> <span class="variable">heapUsage</span> <span class="operator">=</span> memoryBean.getHeapMemoryUsage();</span><br><span class="line">        </span><br><span class="line">        <span class="type">MemorySnapshot</span> <span class="variable">snapshot</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MemorySnapshot</span>(</span><br><span class="line">            System.currentTimeMillis(),</span><br><span class="line">            heapUsage.getUsed(),</span><br><span class="line">            heapUsage.getMax(),</span><br><span class="line">            heapUsage.getCommitted()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        snapshots.add(snapshot);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Keep only last 10 minutes of data</span></span><br><span class="line">        snapshots.removeIf(s -&gt; </span><br><span class="line">            System.currentTimeMillis() - s.getTimestamp() &gt; <span class="number">600000</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Detect memory leak pattern</span></span><br><span class="line">        <span class="keyword">if</span> (snapshots.size() &gt;= <span class="number">10</span>) &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">possibleLeak</span> <span class="operator">=</span> detectMemoryLeakPattern();</span><br><span class="line">            <span class="keyword">if</span> (possibleLeak) &#123;</span><br><span class="line">                triggerMemoryDump();</span><br><span class="line">                alertService.sendCriticalAlert(<span class="string">&quot;Possible memory leak detected&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">detectMemoryLeakPattern</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Simple heuristic: memory usage consistently increasing</span></span><br><span class="line">        List&lt;Long&gt; memoryUsages = snapshots.stream()</span><br><span class="line">            .map(MemorySnapshot::getUsedMemory)</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// Check if memory usage is consistently increasing</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">increasingCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; memoryUsages.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (memoryUsages.get(i) &gt; memoryUsages.get(i - <span class="number">1</span>)) &#123;</span><br><span class="line">                increasingCount++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> increasingCount &gt; (memoryUsages.size() * <span class="number">0.8</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">triggerMemoryDump</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">MBeanServer</span> <span class="variable">server</span> <span class="operator">=</span> ManagementFactory.getPlatformMBeanServer();</span><br><span class="line">            <span class="type">HotSpotDiagnosticMXBean</span> <span class="variable">hotspotMXBean</span> <span class="operator">=</span> </span><br><span class="line">                ManagementFactory.newPlatformMXBeanProxy(</span><br><span class="line">                    server, <span class="string">&quot;com.sun.management:type=HotSpotDiagnostic&quot;</span>,</span><br><span class="line">                    HotSpotDiagnosticMXBean.class);</span><br><span class="line">                    </span><br><span class="line">            <span class="type">String</span> <span class="variable">dumpFile</span> <span class="operator">=</span> <span class="string">&quot;/tmp/memory-dump-&quot;</span> + </span><br><span class="line">                             System.currentTimeMillis() + <span class="string">&quot;.hprof&quot;</span>;</span><br><span class="line">            hotspotMXBean.dumpHeap(dumpFile, <span class="literal">true</span>);</span><br><span class="line">            </span><br><span class="line">            logger.info(<span class="string">&quot;Memory dump created: &quot;</span> + dumpFile);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;Failed to create memory dump&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Interview-Questions-and-Insights"><a href="#Interview-Questions-and-Insights" class="headerlink" title="Interview Questions and Insights"></a>Interview Questions and Insights</h2><p><strong>Q: How do you handle the coordination of thousands of concurrent test clients?</strong></p>
<p>A: We use Zookeepers hierarchical namespace and watches for efficient coordination. Clients register as ephemeral sequential nodes under <code>/test/clients/</code>, allowing automatic discovery and cleanup. We implement a master-slave pattern where the master uses distributed barriers to synchronize test phases. For large-scale coordination, we use consistent hashing to partition clients into groups, with sub-masters coordinating each group to reduce the coordination load on the main master.</p>
<p><strong>Q: What strategies do you use to ensure test result accuracy in a distributed environment?</strong></p>
<p>A: We implement several accuracy measures: 1) Use NTP for time synchronization across all nodes. 2) Implement vector clocks for ordering distributed events. 3) Use HdrHistogram for accurate percentile calculations. 4) Implement consensus algorithms for critical metrics aggregation. 5) Use statistical sampling techniques for large datasets. 6) Implement outlier detection to identify and handle anomalous results. 7) Cross-validate results using multiple measurement techniques.</p>
<p><strong>Q: How do you prevent your load testing from affecting production systems?</strong></p>
<p>A: We implement multiple safeguards: 1) Circuit breakers to automatically stop testing when error rates exceed thresholds. 2) Rate limiting with gradual ramp-up to detect capacity limits early. 3) Monitoring dashboards with automatic alerts for abnormal patterns. 4) Separate network segments or VPCs for testing. 5) Database read replicas for read-heavy tests. 6) Feature flags to enable&#x2F;disable test-specific functionality. 7) Graceful degradation mechanisms that reduce load automatically.</p>
<p><strong>Q: How do you handle test data management in distributed testing?</strong></p>
<p>A: We use a multi-layered approach: 1) Synthetic data generation using libraries like Faker for realistic test data. 2) Data partitioning strategies to avoid hotspots (e.g., user ID sharding). 3) Test data pools with automatic refresh mechanisms. 4) Database seeding scripts for consistent test environments. 5) Data masking for production-like datasets. 6) Cleanup procedures to maintain test data integrity. 7) Version control for test datasets to ensure reproducibility.</p>
<h2 id="Best-Practices-and-Recommendations"><a href="#Best-Practices-and-Recommendations" class="headerlink" title="Best Practices and Recommendations"></a>Best Practices and Recommendations</h2><h3 id="Test-Planning-and-Design"><a href="#Test-Planning-and-Design" class="headerlink" title="Test Planning and Design"></a>Test Planning and Design</h3><ol>
<li><strong>Start Small, Scale Gradually</strong>: Begin with single-node tests before scaling to distributed scenarios</li>
<li><strong>Realistic Load Patterns</strong>: Use production traffic patterns rather than constant load</li>
<li><strong>Comprehensive Monitoring</strong>: Monitor both client and server metrics during tests</li>
<li><strong>Baseline Establishment</strong>: Establish performance baselines before load testing</li>
<li><strong>Test Environment Isolation</strong>: Ensure test environments closely match production</li>
</ol>
<h3 id="Production-Readiness-Checklist"><a href="#Production-Readiness-Checklist" class="headerlink" title="Production Readiness Checklist"></a>Production Readiness Checklist</h3><ul>
<li><input disabled="" type="checkbox"> Comprehensive error handling and retry mechanisms</li>
<li><input disabled="" type="checkbox"> Resource leak detection and prevention</li>
<li><input disabled="" type="checkbox"> Graceful shutdown procedures</li>
<li><input disabled="" type="checkbox"> Monitoring and alerting integration</li>
<li><input disabled="" type="checkbox"> Security hardening (SSL&#x2F;TLS, authentication)</li>
<li><input disabled="" type="checkbox"> Configuration management and hot reloading</li>
<li><input disabled="" type="checkbox"> Backup and disaster recovery procedures</li>
<li><input disabled="" type="checkbox"> Documentation and runbooks</li>
<li><input disabled="" type="checkbox"> Load testing of the load testing system itself</li>
</ul>
<h3 id="Scalability-Considerations"><a href="#Scalability-Considerations" class="headerlink" title="Scalability Considerations"></a>Scalability Considerations</h3><pre>
<code class="mermaid">
graph TD
A[Client Requests] --&gt; B{Load Balancer}
B --&gt; C[Client Node 1]
B --&gt; D[Client Node 2]
B --&gt; E[Client Node N]

C --&gt; F[Zookeeper Cluster]
D --&gt; F
E --&gt; F

F --&gt; G[Master Node]
G --&gt; H[Results Aggregator]
G --&gt; I[Dashboard]

J[Auto Scaler] --&gt; B
K[Metrics Monitor] --&gt; J
H --&gt; K
</code>
</pre>

<h2 id="External-Resources"><a href="#External-Resources" class="headerlink" title="External Resources"></a>External Resources</h2><ul>
<li><a target="_blank" rel="noopener" href="https://zookeeper.apache.org/doc/current/">Apache Zookeeper Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://netty.io/wiki/user-guide-for-4.x.html">Netty User Guide</a></li>
<li><a target="_blank" rel="noopener" href="http://hdrhistogram.org/">HdrHistogram Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://micrometer.io/docs">Micrometer Metrics</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html">Spring Boot Actuator</a></li>
<li><a target="_blank" rel="noopener" href="https://resilience4j.readme.io/">Resilience4j Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/17/gctuning/">JVM Performance Tuning Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/cluster-administration/manage-deployment/">Kubernetes Best Practices</a></li>
</ul>
<p>This comprehensive guide provides a production-ready foundation for building a distributed pressure testing system using Zookeeper. The architecture balances performance, reliability, and scalability while providing detailed insights for system design interviews and real-world implementation.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/25/Spring-Security-Framework-Complete-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/25/Spring-Security-Framework-Complete-Guide/" class="post-title-link" itemprop="url">Spring Security Framework - Complete Guide</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-25 20:24:29 / Modified: 20:26:34" itemprop="dateCreated datePublished" datetime="2025-06-25T20:24:29+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/spring/" itemprop="url" rel="index"><span itemprop="name">spring</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Core-Underlying-Principles"><a href="#Core-Underlying-Principles" class="headerlink" title="Core Underlying Principles"></a>Core Underlying Principles</h2><p>Spring Security is built on several fundamental principles that form the backbone of its architecture and functionality. Understanding these principles is crucial for implementing robust security solutions.</p>
<h3 id="Authentication-vs-Authorization"><a href="#Authentication-vs-Authorization" class="headerlink" title="Authentication vs Authorization"></a>Authentication vs Authorization</h3><p><strong>Authentication</strong> answers Who are you? while <strong>Authorization</strong> answers What can you do? Spring Security treats these as separate concerns, allowing for flexible security configurations.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Authentication - verifying identity</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    auth.inMemoryAuthentication()</span><br><span class="line">        .withUser(<span class="string">&quot;user&quot;</span>)</span><br><span class="line">        .password(passwordEncoder().encode(<span class="string">&quot;password&quot;</span>))</span><br><span class="line">        .roles(<span class="string">&quot;USER&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Authorization - defining access rules</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    http.authorizeRequests()</span><br><span class="line">        .antMatchers(<span class="string">&quot;/admin/**&quot;</span>).hasRole(<span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">        .antMatchers(<span class="string">&quot;/user/**&quot;</span>).hasRole(<span class="string">&quot;USER&quot;</span>)</span><br><span class="line">        .anyRequest().authenticated();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Security-Filter-Chain"><a href="#Security-Filter-Chain" class="headerlink" title="Security Filter Chain"></a>Security Filter Chain</h3><p>Spring Security operates through a chain of filters that intercept HTTP requests. Each filter has a specific responsibility and can either process the request or pass it to the next filter.</p>
<pre>
<code class="mermaid">
flowchart TD
A[HTTP Request] --&gt; B[Security Filter Chain]
B --&gt; C[SecurityContextPersistenceFilter]
C --&gt; D[UsernamePasswordAuthenticationFilter]
D --&gt; E[ExceptionTranslationFilter]
E --&gt; F[FilterSecurityInterceptor]
F --&gt; G[Application Controller]

style B fill:#e1f5fe
style G fill:#e8f5e8
</code>
</pre>

<h3 id="SecurityContext-and-SecurityContextHolder"><a href="#SecurityContext-and-SecurityContextHolder" class="headerlink" title="SecurityContext and SecurityContextHolder"></a>SecurityContext and SecurityContextHolder</h3><p>The SecurityContext stores security information for the current thread of execution. The SecurityContextHolder provides access to this context.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Getting current authenticated user</span></span><br><span class="line"><span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line"><span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> authentication.getName();</span><br><span class="line">Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; authorities = authentication.getAuthorities();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Setting security context programmatically</span></span><br><span class="line"><span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">token</span> <span class="operator">=</span> </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(user, <span class="literal">null</span>, authorities);</span><br><span class="line">SecurityContextHolder.getContext().setAuthentication(token);</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>How does Spring Security maintain security context across requests?</em></p>
<blockquote>
<p>Spring Security uses ThreadLocal to store security context, ensuring thread safety. The SecurityContextPersistenceFilter loads the context from HttpSession at the beginning of each request and clears it at the end.</p>
</blockquote>
<h3 id="Principle-of-Least-Privilege"><a href="#Principle-of-Least-Privilege" class="headerlink" title="Principle of Least Privilege"></a>Principle of Least Privilege</h3><p>Spring Security encourages granting minimal necessary permissions. This is implemented through role-based and method-level security.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreAuthorize(&quot;hasRole(&#x27;ADMIN&#x27;) or (hasRole(&#x27;USER&#x27;) and #username == authentication.name)&quot;)</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">getUserDetails</span><span class="params">(<span class="meta">@PathVariable</span> String username)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> userService.findByUsername(username);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="When-to-Use-Spring-Security-Framework"><a href="#When-to-Use-Spring-Security-Framework" class="headerlink" title="When to Use Spring Security Framework"></a>When to Use Spring Security Framework</h2><h3 id="Enterprise-Applications"><a href="#Enterprise-Applications" class="headerlink" title="Enterprise Applications"></a>Enterprise Applications</h3><p>Spring Security is ideal for enterprise applications requiring:</p>
<ul>
<li>Complex authentication mechanisms (LDAP, OAuth2, SAML)</li>
<li>Fine-grained authorization</li>
<li>Audit trails and compliance requirements</li>
<li>Integration with existing identity providers</li>
</ul>
<h3 id="Web-Applications-with-User-Management"><a href="#Web-Applications-with-User-Management" class="headerlink" title="Web Applications with User Management"></a>Web Applications with User Management</h3><p>Perfect for applications featuring:</p>
<ul>
<li>User registration and login</li>
<li>Role-based access control</li>
<li>Session management</li>
<li>CSRF protection</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">            .authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/register&quot;</span>, <span class="string">&quot;/login&quot;</span>).permitAll()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/admin/**&quot;</span>).hasRole(<span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">            .and()</span><br><span class="line">            .formLogin()</span><br><span class="line">                .loginPage(<span class="string">&quot;/login&quot;</span>)</span><br><span class="line">                .defaultSuccessUrl(<span class="string">&quot;/dashboard&quot;</span>)</span><br><span class="line">            .and()</span><br><span class="line">            .logout()</span><br><span class="line">                .logoutSuccessUrl(<span class="string">&quot;/login?logout&quot;</span>)</span><br><span class="line">            .and()</span><br><span class="line">            .csrf().csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="REST-APIs-and-Microservices"><a href="#REST-APIs-and-Microservices" class="headerlink" title="REST APIs and Microservices"></a>REST APIs and Microservices</h3><p>Essential for securing REST APIs with:</p>
<ul>
<li>JWT token-based authentication</li>
<li>Stateless security</li>
<li>API rate limiting</li>
<li>Cross-origin resource sharing (CORS)</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtSecurityConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JwtAuthenticationEntryPoint <span class="title function_">jwtAuthenticationEntryPoint</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtAuthenticationEntryPoint</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JwtRequestFilter <span class="title function_">jwtRequestFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtRequestFilter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.csrf().disable()</span><br><span class="line">            .authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/api/auth/**&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">            .and()</span><br><span class="line">            .exceptionHandling().authenticationEntryPoint(jwtAuthenticationEntryPoint)</span><br><span class="line">            .and()</span><br><span class="line">            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);</span><br><span class="line">            </span><br><span class="line">        http.addFilterBefore(jwtRequestFilter, UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="When-NOT-to-Use-Spring-Security"><a href="#When-NOT-to-Use-Spring-Security" class="headerlink" title="When NOT to Use Spring Security"></a>When NOT to Use Spring Security</h3><ul>
<li>Simple applications with basic authentication needs</li>
<li>Applications with custom security requirements that conflict with Spring Securitys architecture</li>
<li>Performance-critical applications where the filter chain overhead is unacceptable</li>
<li>Applications requiring non-standard authentication flows</li>
</ul>
<h2 id="User-Login-Logout-and-Session-Management"><a href="#User-Login-Logout-and-Session-Management" class="headerlink" title="User Login, Logout, and Session Management"></a>User Login, Logout, and Session Management</h2><h3 id="Login-Process-Flow"><a href="#Login-Process-Flow" class="headerlink" title="Login Process Flow"></a>Login Process Flow</h3><pre>
<code class="mermaid">
sequenceDiagram
participant U as User
participant B as Browser
participant S as Spring Security
participant A as AuthenticationManager
participant P as AuthenticationProvider
participant D as UserDetailsService

U-&gt;&gt;B: Enter credentials
B-&gt;&gt;S: POST &#x2F;login
S-&gt;&gt;A: Authenticate request
A-&gt;&gt;P: Delegate authentication
P-&gt;&gt;D: Load user details
D--&gt;&gt;P: Return UserDetails
P--&gt;&gt;A: Authentication result
A--&gt;&gt;S: Authenticated user
S-&gt;&gt;B: Redirect to success URL
B-&gt;&gt;U: Display protected resource
</code>
</pre>

<h3 id="Custom-Login-Implementation"><a href="#Custom-Login-Implementation" class="headerlink" title="Custom Login Implementation"></a>Custom Login Implementation</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomUserDetailsService userDetailsService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomAuthenticationSuccessHandler successHandler;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomAuthenticationFailureHandler failureHandler;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">            .formLogin()</span><br><span class="line">                .loginPage(<span class="string">&quot;/custom-login&quot;</span>)</span><br><span class="line">                .loginProcessingUrl(<span class="string">&quot;/perform-login&quot;</span>)</span><br><span class="line">                .usernameParameter(<span class="string">&quot;email&quot;</span>)</span><br><span class="line">                .passwordParameter(<span class="string">&quot;pwd&quot;</span>)</span><br><span class="line">                .successHandler(successHandler)</span><br><span class="line">                .failureHandler(failureHandler)</span><br><span class="line">            .and()</span><br><span class="line">            .logout()</span><br><span class="line">                .logoutUrl(<span class="string">&quot;/perform-logout&quot;</span>)</span><br><span class="line">                .logoutSuccessHandler(customLogoutSuccessHandler())</span><br><span class="line">                .deleteCookies(<span class="string">&quot;JSESSIONID&quot;</span>)</span><br><span class="line">                .invalidateHttpSession(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CustomLogoutSuccessHandler <span class="title function_">customLogoutSuccessHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomLogoutSuccessHandler</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Custom-Authentication-Success-Handler"><a href="#Custom-Authentication-Success-Handler" class="headerlink" title="Custom Authentication Success Handler"></a>Custom Authentication Success Handler</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomAuthenticationSuccessHandler</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationSuccessHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(CustomAuthenticationSuccessHandler.class);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, </span></span><br><span class="line"><span class="params">                                      HttpServletResponse response,</span></span><br><span class="line"><span class="params">                                      Authentication authentication)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Log successful login</span></span><br><span class="line">        logger.info(<span class="string">&quot;User &#123;&#125; logged in successfully&quot;</span>, authentication.getName());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Update last login timestamp</span></span><br><span class="line">        updateLastLoginTime(authentication.getName());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Redirect based on role</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">redirectUrl</span> <span class="operator">=</span> determineTargetUrl(authentication);</span><br><span class="line">        response.sendRedirect(redirectUrl);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">determineTargetUrl</span><span class="params">(Authentication authentication)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isAdmin</span> <span class="operator">=</span> authentication.getAuthorities().stream()</span><br><span class="line">            .anyMatch(authority -&gt; authority.getAuthority().equals(<span class="string">&quot;ROLE_ADMIN&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> isAdmin ? <span class="string">&quot;/admin/dashboard&quot;</span> : <span class="string">&quot;/user/dashboard&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateLastLoginTime</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="comment">// Implementation to update user&#x27;s last login time</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Session-Management"><a href="#Session-Management" class="headerlink" title="Session Management"></a>Session Management</h3><p>Spring Security provides comprehensive session management capabilities:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    http</span><br><span class="line">        .sessionManagement()</span><br><span class="line">            .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED)</span><br><span class="line">            .maximumSessions(<span class="number">1</span>)</span><br><span class="line">            .maxSessionsPreventsLogin(<span class="literal">false</span>)</span><br><span class="line">            .sessionRegistry(sessionRegistry())</span><br><span class="line">            .and()</span><br><span class="line">        .sessionFixation().migrateSession()</span><br><span class="line">        .invalidSessionUrl(<span class="string">&quot;/login?expired&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> HttpSessionEventPublisher <span class="title function_">httpSessionEventPublisher</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HttpSessionEventPublisher</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> SessionRegistry <span class="title function_">sessionRegistry</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SessionRegistryImpl</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>How does Spring Security handle concurrent sessions?</em></p>
<blockquote>
<p>Spring Security can limit concurrent sessions per user through SessionRegistry. When maximum sessions are exceeded, it can either prevent new logins or invalidate existing sessions based on configuration.</p>
</blockquote>
<h3 id="Session-Timeout-Configuration"><a href="#Session-Timeout-Configuration" class="headerlink" title="Session Timeout Configuration"></a>Session Timeout Configuration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// In application.properties</span></span><br><span class="line">server.servlet.session.timeout=30m</span><br><span class="line"></span><br><span class="line"><span class="comment">// Programmatic configuration</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    http</span><br><span class="line">        .sessionManagement()</span><br><span class="line">            .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED)</span><br><span class="line">            .and()</span><br><span class="line">        .rememberMe()</span><br><span class="line">            .key(<span class="string">&quot;uniqueAndSecret&quot;</span>)</span><br><span class="line">            .tokenValiditySeconds(<span class="number">86400</span>) <span class="comment">// 24 hours</span></span><br><span class="line">            .userDetailsService(userDetailsService);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Remember-Me-Functionality"><a href="#Remember-Me-Functionality" class="headerlink" title="Remember Me Functionality"></a>Remember Me Functionality</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RememberMeConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PersistentTokenRepository <span class="title function_">persistentTokenRepository</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">JdbcTokenRepositoryImpl</span> <span class="variable">tokenRepository</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcTokenRepositoryImpl</span>();</span><br><span class="line">        tokenRepository.setDataSource(dataSource);</span><br><span class="line">        <span class="keyword">return</span> tokenRepository;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">            .rememberMe()</span><br><span class="line">                .rememberMeParameter(<span class="string">&quot;remember-me&quot;</span>)</span><br><span class="line">                .tokenRepository(persistentTokenRepository())</span><br><span class="line">                .tokenValiditySeconds(<span class="number">86400</span>)</span><br><span class="line">                .userDetailsService(userDetailsService);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Logout-Process"><a href="#Logout-Process" class="headerlink" title="Logout Process"></a>Logout Process</h2><p>Proper logout implementation is essential for security, ensuring complete cleanup of user sessions and security contexts.</p>
<h3 id="Comprehensive-Logout-Configuration"><a href="#Comprehensive-Logout-Configuration" class="headerlink" title="Comprehensive Logout Configuration"></a>Comprehensive Logout Configuration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogoutConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityFilterChain <span class="title function_">logoutFilterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> http</span><br><span class="line">            .logout(logout -&gt; logout</span><br><span class="line">                .logoutUrl(<span class="string">&quot;/logout&quot;</span>)</span><br><span class="line">                .logoutRequestMatcher(<span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">&quot;/logout&quot;</span>, <span class="string">&quot;POST&quot;</span>))</span><br><span class="line">                .logoutSuccessUrl(<span class="string">&quot;/login?logout=true&quot;</span>)</span><br><span class="line">                .logoutSuccessHandler(customLogoutSuccessHandler())</span><br><span class="line">                .invalidateHttpSession(<span class="literal">true</span>)</span><br><span class="line">                .clearAuthentication(<span class="literal">true</span>)</span><br><span class="line">                .deleteCookies(<span class="string">&quot;JSESSIONID&quot;</span>, <span class="string">&quot;remember-me&quot;</span>)</span><br><span class="line">                .addLogoutHandler(customLogoutHandler())</span><br><span class="line">            )</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LogoutSuccessHandler <span class="title function_">customLogoutSuccessHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomLogoutSuccessHandler</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LogoutHandler <span class="title function_">customLogoutHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomLogoutHandler</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Custom-Logout-Handlers"><a href="#Custom-Logout-Handlers" class="headerlink" title="Custom Logout Handlers"></a>Custom Logout Handlers</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomLogoutHandler</span> <span class="keyword">implements</span> <span class="title class_">LogoutHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SessionRegistry sessionRegistry;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logout</span><span class="params">(HttpServletRequest request, HttpServletResponse response, </span></span><br><span class="line"><span class="params">            Authentication authentication)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (authentication != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> authentication.getName();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Clear user-specific cache</span></span><br><span class="line">            redisTemplate.delete(<span class="string">&quot;user:cache:&quot;</span> + username);</span><br><span class="line">            redisTemplate.delete(<span class="string">&quot;user:permissions:&quot;</span> + username);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Log logout event</span></span><br><span class="line">            logger.info(<span class="string">&quot;User &#123;&#125; logged out from IP: &#123;&#125;&quot;</span>, username, getClientIP(request));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Invalidate all sessions for this user (optional)</span></span><br><span class="line">            sessionRegistry.getAllPrincipals().stream()</span><br><span class="line">                .filter(principal -&gt; principal <span class="keyword">instanceof</span> UserDetails)</span><br><span class="line">                .filter(principal -&gt; ((UserDetails) principal).getUsername().equals(username))</span><br><span class="line">                .forEach(principal -&gt; </span><br><span class="line">                    sessionRegistry.getAllSessions(principal, <span class="literal">false</span>)</span><br><span class="line">                        .forEach(SessionInformation::expireNow)</span><br><span class="line">                );</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Clear security context</span></span><br><span class="line">        SecurityContextHolder.clearContext();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomLogoutSuccessHandler</span> <span class="keyword">implements</span> <span class="title class_">LogoutSuccessHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLogoutSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, </span></span><br><span class="line"><span class="params">            Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Add logout timestamp to response headers</span></span><br><span class="line">        response.addHeader(<span class="string">&quot;Logout-Time&quot;</span>, Instant.now().toString());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Redirect based on user agent or request parameter</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">redirectUrl</span> <span class="operator">=</span> <span class="string">&quot;/login?logout=true&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userAgent</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;User-Agent&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (userAgent != <span class="literal">null</span> &amp;&amp; userAgent.contains(<span class="string">&quot;Mobile&quot;</span>)) &#123;</span><br><span class="line">            redirectUrl = <span class="string">&quot;/mobile/login?logout=true&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        response.sendRedirect(redirectUrl);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Logout-Flow-Diagram"><a href="#Logout-Flow-Diagram" class="headerlink" title="Logout Flow Diagram"></a>Logout Flow Diagram</h3><pre>
<code class="mermaid">
sequenceDiagram
participant User
participant Browser
participant LogoutFilter
participant LogoutHandler
participant SessionRegistry
participant RedisCache
participant Database

User-&gt;&gt;Browser: Click logout
Browser-&gt;&gt;LogoutFilter: POST &#x2F;logout
LogoutFilter-&gt;&gt;LogoutHandler: Handle logout
LogoutHandler-&gt;&gt;SessionRegistry: Invalidate sessions
LogoutHandler-&gt;&gt;RedisCache: Clear user cache
LogoutHandler-&gt;&gt;Database: Log logout event
LogoutHandler--&gt;&gt;LogoutFilter: Cleanup complete
LogoutFilter-&gt;&gt;LogoutFilter: Clear SecurityContext
LogoutFilter--&gt;&gt;Browser: Redirect to login
Browser--&gt;&gt;User: Login page with logout message
</code>
</pre>

<h2 id="Advanced-Authentication-Mechanisms"><a href="#Advanced-Authentication-Mechanisms" class="headerlink" title="Advanced Authentication Mechanisms"></a>Advanced Authentication Mechanisms</h2><h3 id="JWT-Token-Based-Authentication"><a href="#JWT-Token-Based-Authentication" class="headerlink" title="JWT Token-Based Authentication"></a>JWT Token-Based Authentication</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtTokenUtil</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SECRET</span> <span class="operator">=</span> <span class="string">&quot;mySecretKey&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">JWT_TOKEN_VALIDITY</span> <span class="operator">=</span> <span class="number">5</span> * <span class="number">60</span> * <span class="number">60</span>; <span class="comment">// 5 hours</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generateToken</span><span class="params">(UserDetails userDetails)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; claims = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">return</span> createToken(claims, userDetails.getUsername());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">createToken</span><span class="params">(Map&lt;String, Object&gt; claims, String subject)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Jwts.builder()</span><br><span class="line">            .setClaims(claims)</span><br><span class="line">            .setSubject(subject)</span><br><span class="line">            .setIssuedAt(<span class="keyword">new</span> <span class="title class_">Date</span>(System.currentTimeMillis()))</span><br><span class="line">            .setExpiration(<span class="keyword">new</span> <span class="title class_">Date</span>(System.currentTimeMillis() + JWT_TOKEN_VALIDITY * <span class="number">1000</span>))</span><br><span class="line">            .signWith(SignatureAlgorithm.HS512, SECRET)</span><br><span class="line">            .compact();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">validateToken</span><span class="params">(String token, UserDetails userDetails)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> getUsernameFromToken(token);</span><br><span class="line">        <span class="keyword">return</span> (username.equals(userDetails.getUsername()) &amp;&amp; !isTokenExpired(token));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="OAuth2-Integration"><a href="#OAuth2-Integration" class="headerlink" title="OAuth2 Integration"></a>OAuth2 Integration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableOAuth2Client</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OAuth2Config</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> OAuth2RestTemplate <span class="title function_">oauth2RestTemplate</span><span class="params">(OAuth2ClientContext oauth2ClientContext)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OAuth2RestTemplate</span>(googleOAuth2ResourceDetails(), oauth2ClientContext);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> OAuth2ProtectedResourceDetails <span class="title function_">googleOAuth2ResourceDetails</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">AuthorizationCodeResourceDetails</span> <span class="variable">details</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthorizationCodeResourceDetails</span>();</span><br><span class="line">        details.setClientId(<span class="string">&quot;your-client-id&quot;</span>);</span><br><span class="line">        details.setClientSecret(<span class="string">&quot;your-client-secret&quot;</span>);</span><br><span class="line">        details.setAccessTokenUri(<span class="string">&quot;https://oauth2.googleapis.com/token&quot;</span>);</span><br><span class="line">        details.setUserAuthorizationUri(<span class="string">&quot;https://accounts.google.com/o/oauth2/auth&quot;</span>);</span><br><span class="line">        details.setScope(Arrays.asList(<span class="string">&quot;email&quot;</span>, <span class="string">&quot;profile&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> details;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Method-Level-Security"><a href="#Method-Level-Security" class="headerlink" title="Method-Level Security"></a>Method-Level Security</h2><h3 id="Enabling-Method-Security"><a href="#Enabling-Method-Security" class="headerlink" title="Enabling Method Security"></a>Enabling Method Security</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(</span></span><br><span class="line"><span class="meta">    prePostEnabled = true,</span></span><br><span class="line"><span class="meta">    securedEnabled = true,</span></span><br><span class="line"><span class="meta">    jsr250Enabled = true</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MethodSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">GlobalMethodSecurityConfiguration</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> MethodSecurityExpressionHandler <span class="title function_">createExpressionHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DefaultMethodSecurityExpressionHandler</span> <span class="variable">expressionHandler</span> <span class="operator">=</span> </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">DefaultMethodSecurityExpressionHandler</span>();</span><br><span class="line">        expressionHandler.setPermissionEvaluator(<span class="keyword">new</span> <span class="title class_">CustomPermissionEvaluator</span>());</span><br><span class="line">        <span class="keyword">return</span> expressionHandler;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Security-Annotations-in-Action"><a href="#Security-Annotations-in-Action" class="headerlink" title="Security Annotations in Action"></a>Security Annotations in Action</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DocumentService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasRole(&#x27;ADMIN&#x27;)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteDocument</span><span class="params">(Long documentId)</span> &#123;</span><br><span class="line">        <span class="comment">// Only admins can delete documents</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasRole(&#x27;USER&#x27;) and #document.owner == authentication.name&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">editDocument</span><span class="params">(<span class="meta">@P(&quot;document&quot;)</span> Document document)</span> &#123;</span><br><span class="line">        <span class="comment">// Users can only edit their own documents</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostAuthorize(&quot;returnObject.owner == authentication.name or hasRole(&#x27;ADMIN&#x27;)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Document <span class="title function_">getDocument</span><span class="params">(Long documentId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> documentRepository.findById(documentId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PreFilter(&quot;filterObject.owner == authentication.name&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processDocuments</span><span class="params">(List&lt;Document&gt; documents)</span> &#123;</span><br><span class="line">        <span class="comment">// Process only documents owned by the current user</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Whats the difference between @PreAuthorize and @Secured?</em></p>
<blockquote>
<p>@PreAuthorize supports SpEL expressions for complex authorization logic, while @Secured only supports role-based authorization. @PreAuthorize is more flexible and powerful.</p>
</blockquote>
<h2 id="Security-Best-Practices"><a href="#Security-Best-Practices" class="headerlink" title="Security Best Practices"></a>Security Best Practices</h2><h3 id="Password-Security"><a href="#Password-Security" class="headerlink" title="Password Security"></a>Password Security</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PasswordConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>(<span class="number">12</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordValidator <span class="title function_">passwordValidator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PasswordValidator</span>(Arrays.asList(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">LengthRule</span>(<span class="number">8</span>, <span class="number">30</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">CharacterRule</span>(EnglishCharacterData.UpperCase, <span class="number">1</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">CharacterRule</span>(EnglishCharacterData.LowerCase, <span class="number">1</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">CharacterRule</span>(EnglishCharacterData.Digit, <span class="number">1</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">CharacterRule</span>(EnglishCharacterData.Special, <span class="number">1</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">WhitespaceRule</span>()</span><br><span class="line">        ));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CSRF-Protection"><a href="#CSRF-Protection" class="headerlink" title="CSRF Protection"></a>CSRF Protection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    http</span><br><span class="line">        .csrf()</span><br><span class="line">            .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())</span><br><span class="line">            .ignoringAntMatchers(<span class="string">&quot;/api/public/**&quot;</span>)</span><br><span class="line">        .and()</span><br><span class="line">        .headers()</span><br><span class="line">            .frameOptions().deny()</span><br><span class="line">            .contentTypeOptions().and()</span><br><span class="line">            .httpStrictTransportSecurity(hstsConfig -&gt; hstsConfig</span><br><span class="line">                .maxAgeInSeconds(<span class="number">31536000</span>)</span><br><span class="line">                .includeSubdomains(<span class="literal">true</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Input-Validation-and-Sanitization"><a href="#Input-Validation-and-Sanitization" class="headerlink" title="Input Validation and Sanitization"></a>Input Validation and Sanitization</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/users&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;User&gt; <span class="title function_">createUser</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> CreateUserRequest request)</span> &#123;</span><br><span class="line">        <span class="comment">// Validation handled by @Valid annotation</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.createUser(request);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CreateUserRequest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;Username is required&quot;)</span></span><br><span class="line">    <span class="meta">@Size(min = 3, max = 20, message = &quot;Username must be between 3 and 20 characters&quot;)</span></span><br><span class="line">    <span class="meta">@Pattern(regexp = &quot;^[a-zA-Z0-9._-]+$&quot;, message = &quot;Username contains invalid characters&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;Email is required&quot;)</span></span><br><span class="line">    <span class="meta">@Email(message = &quot;Invalid email format&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;Password is required&quot;)</span></span><br><span class="line">    <span class="meta">@Size(min = 8, message = &quot;Password must be at least 8 characters&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Common-Security-Vulnerabilities-and-Mitigation"><a href="#Common-Security-Vulnerabilities-and-Mitigation" class="headerlink" title="Common Security Vulnerabilities and Mitigation"></a>Common Security Vulnerabilities and Mitigation</h2><h3 id="SQL-Injection-Prevention"><a href="#SQL-Injection-Prevention" class="headerlink" title="SQL Injection Prevention"></a>SQL Injection Prevention</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserRepository</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Vulnerable code (DON&#x27;T DO THIS)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">findByUsernameUnsafe</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;SELECT * FROM users WHERE username = &#x27;&quot;</span> + username + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.queryForObject(sql, User.class);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Secure code (DO THIS)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">findByUsernameSafe</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;SELECT * FROM users WHERE username = ?&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.queryForObject(sql, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;username&#125;, User.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="XSS-Prevention"><a href="#XSS-Prevention" class="headerlink" title="XSS Prevention"></a>XSS Prevention</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityHeadersConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FilterRegistrationBean&lt;XSSFilter&gt; <span class="title function_">xssPreventFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        FilterRegistrationBean&lt;XSSFilter&gt; registrationBean = <span class="keyword">new</span> <span class="title class_">FilterRegistrationBean</span>&lt;&gt;();</span><br><span class="line">        registrationBean.setFilter(<span class="keyword">new</span> <span class="title class_">XSSFilter</span>());</span><br><span class="line">        registrationBean.addUrlPatterns(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> registrationBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XSSFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, </span></span><br><span class="line"><span class="params">                        FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">XSSRequestWrapper</span> <span class="variable">wrappedRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XSSRequestWrapper</span>((HttpServletRequest) request);</span><br><span class="line">        chain.doFilter(wrappedRequest, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Testing-Spring-Security"><a href="#Testing-Spring-Security" class="headerlink" title="Testing Spring Security"></a>Testing Spring Security</h2><h3 id="Security-Testing-with-MockMvc"><a href="#Security-Testing-with-MockMvc" class="headerlink" title="Security Testing with MockMvc"></a>Security Testing with MockMvc</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@WebMvcTest(UserController.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserControllerSecurityTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MockMvc mockMvc;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@WithMockUser(roles = &quot;ADMIN&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testAdminAccessToUserData</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        mockMvc.perform(get(<span class="string">&quot;/admin/users&quot;</span>))</span><br><span class="line">            .andExpect(status().isOk());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@WithMockUser(roles = &quot;USER&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUserAccessToAdminEndpoint</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        mockMvc.perform(get(<span class="string">&quot;/admin/users&quot;</span>))</span><br><span class="line">            .andExpect(status().isForbidden());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUnauthenticatedAccess</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        mockMvc.perform(get(<span class="string">&quot;/user/profile&quot;</span>))</span><br><span class="line">            .andExpect(status().isUnauthorized());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Integration-Testing-with-TestContainers"><a href="#Integration-Testing-with-TestContainers" class="headerlink" title="Integration Testing with TestContainers"></a>Integration Testing with TestContainers</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Testcontainers</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityIntegrationTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Container</span></span><br><span class="line">    <span class="keyword">static</span> PostgreSQLContainer&lt;?&gt; postgres = <span class="keyword">new</span> <span class="title class_">PostgreSQLContainer</span>&lt;&gt;(<span class="string">&quot;postgres:13&quot;</span>)</span><br><span class="line">        .withDatabaseName(<span class="string">&quot;testdb&quot;</span>)</span><br><span class="line">        .withUsername(<span class="string">&quot;test&quot;</span>)</span><br><span class="line">        .withPassword(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TestRestTemplate restTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFullAuthenticationFlow</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Test user registration</span></span><br><span class="line">        ResponseEntity&lt;String&gt; registerResponse = restTemplate.postForEntity(</span><br><span class="line">            <span class="string">&quot;/api/auth/register&quot;</span>, </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">RegisterRequest</span>(<span class="string">&quot;test@example.com&quot;</span>, <span class="string">&quot;password123&quot;</span>),</span><br><span class="line">            String.class</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        assertThat(registerResponse.getStatusCode()).isEqualTo(HttpStatus.CREATED);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Test user login</span></span><br><span class="line">        ResponseEntity&lt;LoginResponse&gt; loginResponse = restTemplate.postForEntity(</span><br><span class="line">            <span class="string">&quot;/api/auth/login&quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">LoginRequest</span>(<span class="string">&quot;test@example.com&quot;</span>, <span class="string">&quot;password123&quot;</span>),</span><br><span class="line">            LoginResponse.class</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        assertThat(loginResponse.getStatusCode()).isEqualTo(HttpStatus.OK);</span><br><span class="line">        assertThat(loginResponse.getBody().getToken()).isNotNull();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Optimization"><a href="#Performance-Optimization" class="headerlink" title="Performance Optimization"></a>Performance Optimization</h2><h3 id="Security-Filter-Chain-Optimization"><a href="#Security-Filter-Chain-Optimization" class="headerlink" title="Security Filter Chain Optimization"></a>Security Filter Chain Optimization</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OptimizedSecurityConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">            <span class="comment">// Disable unnecessary features for API-only applications</span></span><br><span class="line">            .csrf().disable()</span><br><span class="line">            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span><br><span class="line">            .and()</span><br><span class="line">            <span class="comment">// Order matters - put most specific patterns first</span></span><br><span class="line">            .authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/api/public/**&quot;</span>).permitAll()</span><br><span class="line">                .antMatchers(HttpMethod.GET, <span class="string">&quot;/api/products/**&quot;</span>).permitAll()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/api/admin/**&quot;</span>).hasRole(<span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">                .anyRequest().authenticated();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Caching-Security-Context"><a href="#Caching-Security-Context" class="headerlink" title="Caching Security Context"></a>Caching Security Context</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityCacheConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CacheManager <span class="title function_">cacheManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConcurrentMapCacheManager</span>(<span class="string">&quot;userCache&quot;</span>, <span class="string">&quot;permissionCache&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Service</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CachedUserDetailsService</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Cacheable(value = &quot;userCache&quot;, key = &quot;#username&quot;)</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">            <span class="keyword">return</span> userRepository.findByUsername(username)</span><br><span class="line">                .map(<span class="built_in">this</span>::createUserPrincipal)</span><br><span class="line">                .orElseThrow(() -&gt; <span class="keyword">new</span> <span class="title class_">UsernameNotFoundException</span>(<span class="string">&quot;User not found: &quot;</span> + username));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Troubleshooting-Common-Issues"><a href="#Troubleshooting-Common-Issues" class="headerlink" title="Troubleshooting Common Issues"></a>Troubleshooting Common Issues</h2><h3 id="Debug-Security-Configuration"><a href="#Debug-Security-Configuration" class="headerlink" title="Debug Security Configuration"></a>Debug Security Configuration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DebugSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        web.debug(<span class="literal">true</span>); <span class="comment">// Enable security debugging</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Logger <span class="title function_">securityLogger</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="string">&quot;org.springframework.security&quot;</span>);</span><br><span class="line">        ((ch.qos.logback.classic.Logger) logger).setLevel(Level.DEBUG);</span><br><span class="line">        <span class="keyword">return</span> logger;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Common-Configuration-Mistakes"><a href="#Common-Configuration-Mistakes" class="headerlink" title="Common Configuration Mistakes"></a>Common Configuration Mistakes</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WRONG: Ordering matters in security configuration</span></span><br><span class="line">http.authorizeRequests()</span><br><span class="line">    .anyRequest().authenticated()  <span class="comment">// This catches everything</span></span><br><span class="line">    .antMatchers(<span class="string">&quot;/public/**&quot;</span>).permitAll(); <span class="comment">// This never gets reached</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// CORRECT: Specific patterns first</span></span><br><span class="line">http.authorizeRequests()</span><br><span class="line">    .antMatchers(<span class="string">&quot;/public/**&quot;</span>).permitAll()</span><br><span class="line">    .anyRequest().authenticated();</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>What happens when Spring Security configuration conflicts occur?</em></p>
<blockquote>
<p>Spring Security evaluates rules in order. The first matching rule wins, so specific patterns must come before general ones. Always place more restrictive rules before less restrictive ones.</p>
</blockquote>
<h2 id="Monitoring-and-Auditing"><a href="#Monitoring-and-Auditing" class="headerlink" title="Monitoring and Auditing"></a>Monitoring and Auditing</h2><h3 id="Security-Events-Logging"><a href="#Security-Events-Logging" class="headerlink" title="Security Events Logging"></a>Security Events Logging</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityEventListener</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(SecurityEventListener.class);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleAuthenticationSuccess</span><span class="params">(AuthenticationSuccessEvent event)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;User &#x27;&#123;&#125;&#x27; logged in successfully from IP: &#123;&#125;&quot;</span>, </span><br><span class="line">            event.getAuthentication().getName(),</span><br><span class="line">            getClientIpAddress());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleAuthenticationFailure</span><span class="params">(AbstractAuthenticationFailureEvent event)</span> &#123;</span><br><span class="line">        logger.warn(<span class="string">&quot;Authentication failed for user &#x27;&#123;&#125;&#x27;: &#123;&#125;&quot;</span>, </span><br><span class="line">            event.getAuthentication().getName(),</span><br><span class="line">            event.getException().getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleAuthorizationFailure</span><span class="params">(AuthorizationFailureEvent event)</span> &#123;</span><br><span class="line">        logger.warn(<span class="string">&quot;Authorization failed for user &#x27;&#123;&#125;&#x27; accessing resource: &#123;&#125;&quot;</span>, </span><br><span class="line">            event.getAuthentication().getName(),</span><br><span class="line">            event.getRequestUrl());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Metrics-and-Monitoring"><a href="#Metrics-and-Monitoring" class="headerlink" title="Metrics and Monitoring"></a>Metrics and Monitoring</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityMetrics</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter loginAttempts;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter loginFailures;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SecurityMetrics</span><span class="params">(MeterRegistry meterRegistry)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.meterRegistry = meterRegistry;</span><br><span class="line">        <span class="built_in">this</span>.loginAttempts = Counter.builder(<span class="string">&quot;security.login.attempts&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Total login attempts&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">        <span class="built_in">this</span>.loginFailures = Counter.builder(<span class="string">&quot;security.login.failures&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Failed login attempts&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLoginAttempt</span><span class="params">(AuthenticationSuccessEvent event)</span> &#123;</span><br><span class="line">        loginAttempts.increment();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLoginFailure</span><span class="params">(AbstractAuthenticationFailureEvent event)</span> &#123;</span><br><span class="line">        loginAttempts.increment();</span><br><span class="line">        loginFailures.increment();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Interview-Questions-and-Answers"><a href="#Interview-Questions-and-Answers" class="headerlink" title="Interview Questions and Answers"></a>Interview Questions and Answers</h2><h3 id="Technical-Deep-Dive-Questions"><a href="#Technical-Deep-Dive-Questions" class="headerlink" title="Technical Deep Dive Questions"></a>Technical Deep Dive Questions</h3><p><strong>Q: Explain the difference between authentication and authorization in Spring Security.</strong><br>A: Authentication verifies identity (who are you?) while authorization determines permissions (what can you do?). Spring Security separates these concerns - AuthenticationManager handles authentication, while AccessDecisionManager handles authorization decisions.</p>
<p><strong>Q: How does Spring Security handle stateless authentication?</strong><br>A: For stateless authentication, Spring Security doesnt maintain session state. Instead, it uses tokens (like JWT) passed with each request. Configure with <code>SessionCreationPolicy.STATELESS</code> and implement token-based filters.</p>
<p><strong>Q: What is the purpose of SecurityContextHolder?</strong><br>A: SecurityContextHolder provides access to the SecurityContext, which stores authentication information for the current thread. It uses ThreadLocal to ensure thread safety and provides three strategies: ThreadLocal (default), InheritableThreadLocal, and Global.</p>
<p><strong>Q: How do you implement custom authentication in Spring Security?</strong><br>A: Implement custom authentication by:</p>
<ol>
<li>Creating a custom AuthenticationProvider</li>
<li>Implementing authenticate() method</li>
<li>Registering the provider with AuthenticationManager</li>
<li>Optionally creating custom Authentication tokens</li>
</ol>
<h3 id="Practical-Implementation-Questions"><a href="#Practical-Implementation-Questions" class="headerlink" title="Practical Implementation Questions"></a>Practical Implementation Questions</h3><p><strong>Q: How would you secure a REST API with JWT tokens?</strong><br>A: Implement JWT security by:</p>
<ol>
<li>Creating JWT utility class for token generation&#x2F;validation</li>
<li>Implementing JwtAuthenticationEntryPoint for unauthorized access</li>
<li>Creating JwtRequestFilter to validate tokens</li>
<li>Configuring HttpSecurity with stateless session management</li>
<li>Adding JWT filter before UsernamePasswordAuthenticationFilter</li>
</ol>
<p><strong>Q: What are the security implications of CSRF and how does Spring Security handle it?</strong><br>A: CSRF attacks trick users into performing unwanted actions. Spring Security provides CSRF protection by:</p>
<ol>
<li>Generating unique tokens for each session</li>
<li>Validating tokens on state-changing requests</li>
<li>Storing tokens in HttpSession or cookies</li>
<li>Automatically including tokens in forms via Thymeleaf integration</li>
</ol>
<h2 id="External-Resources-and-References"><a href="#External-Resources-and-References" class="headerlink" title="External Resources and References"></a>External Resources and References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/">Spring Security Reference Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://spring.io/guides/tutorials/spring-boot-oauth2/">Spring Security OAuth2 Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://owasp.org/www-project-top-ten/">OWASP Security Guidelines</a></li>
<li><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc8725">JWT Best Practices</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/web.html#web.security">Spring Boot Security Auto-configuration</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/servlet/test/index.html">Spring Security Test Documentation</a></li>
</ul>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Spring Security provides a comprehensive, flexible framework for securing Java applications. Its architecture based on filters, authentication managers, and security contexts allows for sophisticated security implementations while maintaining clean separation of concerns. Success with Spring Security requires understanding its core principles, proper configuration, and adherence to security best practices.</p>
<p>The frameworks strength lies in its ability to handle complex security requirements while providing sensible defaults for common use cases. Whether building traditional web applications or modern microservices, Spring Security offers the tools and flexibility needed to implement robust security solutions.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/19/Java-Virtual-Machine-Garbage-Collection-Complete-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/19/Java-Virtual-Machine-Garbage-Collection-Complete-Guide/" class="post-title-link" itemprop="url">Java Virtual Machine Garbage Collection - Complete Guide</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-19 20:00:34 / Modified: 20:02:55" itemprop="dateCreated datePublished" datetime="2025-06-19T20:00:34+08:00">2025-06-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Memory-Management-Fundamentals"><a href="#Memory-Management-Fundamentals" class="headerlink" title="Memory Management Fundamentals"></a>Memory Management Fundamentals</h2><p>Javas automatic memory management through garbage collection is one of its key features that differentiates it from languages like C and C++. The JVM automatically handles memory allocation and deallocation, freeing developers from manual memory management while preventing memory leaks and dangling pointer issues.</p>
<h3 id="Memory-Layout-Overview"><a href="#Memory-Layout-Overview" class="headerlink" title="Memory Layout Overview"></a>Memory Layout Overview</h3><p>The JVM heap is divided into several regions, each serving specific purposes in the garbage collection process:</p>
<pre>
<code class="mermaid">
flowchart TB
subgraph &quot;JVM Memory Structure&quot;
    subgraph &quot;Heap Memory&quot;
        subgraph &quot;Young Generation&quot;
            Eden[&quot;Eden Space&quot;]
            S0[&quot;Survivor 0&quot;]
            S1[&quot;Survivor 1&quot;]
        end
        
        subgraph &quot;Old Generation&quot;
            OldGen[&quot;Old Generation (Tenured)&quot;]
        end
        
        MetaSpace[&quot;Metaspace (Java 8+)&quot;]
    end
    
    subgraph &quot;Non-Heap Memory&quot;
        PC[&quot;Program Counter&quot;]
        Stack[&quot;Java Stacks&quot;]
        Native[&quot;Native Method Stacks&quot;]
        Direct[&quot;Direct Memory&quot;]
    end
end
</code>
</pre>

<p><strong>Interview Insight</strong>: <em>Can you explain the difference between heap and non-heap memory in JVM?</em></p>
<p><strong>Answer</strong>: Heap memory stores object instances and arrays, managed by GC. Non-heap includes method area (storing class metadata), program counter registers, and stack memory (storing method calls and local variables). Only heap memory is subject to garbage collection.</p>
<h2 id="GC-Roots-and-Object-Reachability"><a href="#GC-Roots-and-Object-Reachability" class="headerlink" title="GC Roots and Object Reachability"></a>GC Roots and Object Reachability</h2><h3 id="Understanding-GC-Roots"><a href="#Understanding-GC-Roots" class="headerlink" title="Understanding GC Roots"></a>Understanding GC Roots</h3><p>GC Roots are the starting points for garbage collection algorithms to determine object reachability. An object is considered reachable if theres a path from any GC Root to that object.</p>
<p><strong>Primary GC Roots include:</strong></p>
<ul>
<li><strong>Local Variables</strong>: Variables in currently executing methods</li>
<li><strong>Static Variables</strong>: Class-level static references</li>
<li><strong>JNI References</strong>: Objects referenced from native code</li>
<li><strong>Monitor Objects</strong>: Objects used for synchronization</li>
<li><strong>Thread Objects</strong>: Active thread instances</li>
<li><strong>Class Objects</strong>: Loaded class instances in Metaspace</li>
</ul>
<pre>
<code class="mermaid">
flowchart TD
subgraph &quot;GC Roots&quot;
    LV[&quot;Local Variables&quot;]
    SV[&quot;Static Variables&quot;]
    JNI[&quot;JNI References&quot;]
    TO[&quot;Thread Objects&quot;]
end

subgraph &quot;Heap Objects&quot;
    A[&quot;Object A&quot;]
    B[&quot;Object B&quot;]
    C[&quot;Object C&quot;]
    D[&quot;Object D (Unreachable)&quot;]
end

LV --&gt; A
SV --&gt; B
A --&gt; C
B --&gt; C

style D fill:#ff6b6b
style A fill:#51cf66
style B fill:#51cf66
style C fill:#51cf66
</code>
</pre>

<h3 id="Object-Reachability-Algorithm"><a href="#Object-Reachability-Algorithm" class="headerlink" title="Object Reachability Algorithm"></a>Object Reachability Algorithm</h3><p>The reachability analysis works through a mark-and-sweep approach:</p>
<ol>
<li><strong>Mark Phase</strong>: Starting from GC Roots, mark all reachable objects</li>
<li><strong>Sweep Phase</strong>: Reclaim memory of unmarked (unreachable) objects</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Example: Object Reachability</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReachabilityExample</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object staticRef;  <span class="comment">// GC Root</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demonstrateReachability</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">localRef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();     <span class="comment">// GC Root (local variable)</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">chainedObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Creating reference chain</span></span><br><span class="line">        localRef.someField = chainedObj;    <span class="comment">// chainedObj is reachable</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Breaking reference chain</span></span><br><span class="line">        localRef = <span class="literal">null</span>;                    <span class="comment">// chainedObj becomes unreachable</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>How does JVM determine if an object is eligible for garbage collection?</em></p>
<p><strong>Answer</strong>: JVM uses reachability analysis starting from GC Roots. If an object cannot be reached through any path from GC Roots, it becomes eligible for GC. This is more reliable than reference counting as it handles circular references correctly.</p>
<h2 id="Object-Reference-Types"><a href="#Object-Reference-Types" class="headerlink" title="Object Reference Types"></a>Object Reference Types</h2><p>Java provides different reference types that interact with garbage collection in distinct ways:</p>
<h3 id="Strong-References"><a href="#Strong-References" class="headerlink" title="Strong References"></a>Strong References</h3><p>Default reference type that prevents garbage collection:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();  <span class="comment">// Strong reference</span></span><br><span class="line"><span class="comment">// obj will not be collected while this reference exists</span></span><br></pre></td></tr></table></figure>

<h3 id="Weak-References"><a href="#Weak-References" class="headerlink" title="Weak References"></a>Weak References</h3><p>Allow garbage collection even when references exist:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.ref.WeakReference;</span><br><span class="line"></span><br><span class="line">WeakReference&lt;Object&gt; weakRef = <span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">Object</span>());</span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> weakRef.get();  <span class="comment">// May return null if collected</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Common use case: Cache implementation</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeakCache</span>&lt;K, V&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;K, WeakReference&lt;V&gt;&gt; cache = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> V <span class="title function_">get</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        WeakReference&lt;V&gt; ref = cache.get(key);</span><br><span class="line">        <span class="keyword">return</span> (ref != <span class="literal">null</span>) ? ref.get() : <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Soft-References"><a href="#Soft-References" class="headerlink" title="Soft References"></a>Soft References</h3><p>More aggressive than weak references, collected only when memory is low:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.ref.SoftReference;</span><br><span class="line"></span><br><span class="line">SoftReference&lt;LargeObject&gt; softRef = <span class="keyword">new</span> <span class="title class_">SoftReference</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">LargeObject</span>());</span><br><span class="line"><span class="comment">// Collected only when JVM needs memory</span></span><br></pre></td></tr></table></figure>

<h3 id="Phantom-References"><a href="#Phantom-References" class="headerlink" title="Phantom References"></a>Phantom References</h3><p>Used for cleanup operations, cannot retrieve the object:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.ref.PhantomReference;</span><br><span class="line"><span class="keyword">import</span> java.lang.ref.ReferenceQueue;</span><br><span class="line"></span><br><span class="line">ReferenceQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">ReferenceQueue</span>&lt;&gt;();</span><br><span class="line">PhantomReference&lt;Object&gt; phantomRef = <span class="keyword">new</span> <span class="title class_">PhantomReference</span>&lt;&gt;(obj, queue);</span><br><span class="line"><span class="comment">// Used for resource cleanup notification</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>When would you use WeakReference vs SoftReference?</em></p>
<p><strong>Answer</strong>: Use WeakReference for cache entries that can be recreated easily (like parsed data). Use SoftReference for memory-sensitive caches where you want to keep objects as long as possible but allow collection under memory pressure.</p>
<h2 id="Generational-Garbage-Collection"><a href="#Generational-Garbage-Collection" class="headerlink" title="Generational Garbage Collection"></a>Generational Garbage Collection</h2><h3 id="The-Generational-Hypothesis"><a href="#The-Generational-Hypothesis" class="headerlink" title="The Generational Hypothesis"></a>The Generational Hypothesis</h3><p>Most objects die young - this fundamental observation drives generational GC design:</p>
<pre>
<code class="mermaid">
flowchart LR
subgraph &quot;Object Lifecycle&quot;
    A[&quot;Object Creation&quot;] --&gt; B[&quot;Short-lived Objects (90%+)&quot;]
    A --&gt; C[&quot;Long-lived Objects (&lt;10%)&quot;]
    B --&gt; D[&quot;Die in Young Generation&quot;]
    C --&gt; E[&quot;Promoted to Old Generation&quot;]
end
</code>
</pre>

<h3 id="Young-Generation-Structure"><a href="#Young-Generation-Structure" class="headerlink" title="Young Generation Structure"></a>Young Generation Structure</h3><p><strong>Eden Space</strong>: Where new objects are allocated<br><strong>Survivor Spaces (S0, S1)</strong>: Hold objects that survived at least one GC cycle</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Example: Object allocation flow</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AllocationExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demonstrateAllocation</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Objects allocated in Eden space</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();  <span class="comment">// Allocated in Eden</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">100</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// Some objects may survive longer</span></span><br><span class="line">                longLivedList.add(obj);  <span class="comment">// May get promoted to Old Gen</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Minor-GC-Process"><a href="#Minor-GC-Process" class="headerlink" title="Minor GC Process"></a>Minor GC Process</h3><ol>
<li><strong>Allocation</strong>: New objects go to Eden</li>
<li><strong>Eden Full</strong>: Triggers Minor GC</li>
<li><strong>Survival</strong>: Live objects move to Survivor space</li>
<li><strong>Age Increment</strong>: Survivor objects get age incremented</li>
<li><strong>Promotion</strong>: Old enough objects move to Old Generation</li>
</ol>
<pre>
<code class="mermaid">
sequenceDiagram
participant E as Eden Space
participant S0 as Survivor 0
participant S1 as Survivor 1
participant O as Old Generation

E-&gt;&gt;S0: First GC: Move live objects
Note over S0: Age &#x3D; 1
E-&gt;&gt;S0: Second GC: New objects to S0
S0-&gt;&gt;S1: Move aged objects
Note over S1: Age &#x3D; 2
S1-&gt;&gt;O: Promotion (Age &gt;&#x3D; threshold)
</code>
</pre>

<h3 id="Major-GC-and-Old-Generation"><a href="#Major-GC-and-Old-Generation" class="headerlink" title="Major GC and Old Generation"></a>Major GC and Old Generation</h3><p>Old Generation uses different algorithms optimized for long-lived objects:</p>
<ul>
<li><strong>Concurrent Collection</strong>: Minimize application pause times</li>
<li><strong>Compaction</strong>: Reduce fragmentation</li>
<li><strong>Different Triggers</strong>: Based on Old Gen occupancy or allocation failure</li>
</ul>
<p><strong>Interview Insight</strong>: <em>Why is Minor GC faster than Major GC?</em></p>
<p><strong>Answer</strong>: Minor GC only processes Young Generation (smaller space, most objects are dead). Major GC processes entire heap or Old Generation (larger space, more live objects), often requiring more complex algorithms like concurrent marking or compaction.</p>
<h2 id="Garbage-Collection-Algorithms"><a href="#Garbage-Collection-Algorithms" class="headerlink" title="Garbage Collection Algorithms"></a>Garbage Collection Algorithms</h2><h3 id="Mark-and-Sweep"><a href="#Mark-and-Sweep" class="headerlink" title="Mark and Sweep"></a>Mark and Sweep</h3><p>The fundamental GC algorithm:</p>
<p><strong>Mark Phase</strong>: Identify live objects starting from GC Roots<br><strong>Sweep Phase</strong>: Reclaim memory from dead objects</p>
<pre>
<code class="mermaid">
flowchart TD
subgraph &quot;Mark Phase&quot;
    A[&quot;Start from GC Roots&quot;] --&gt; B[&quot;Mark Reachable Objects&quot;]
    B --&gt; C[&quot;Traverse Reference Graph&quot;]
end

subgraph &quot;Sweep Phase&quot;
    D[&quot;Scan Heap&quot;] --&gt; E[&quot;Identify Unmarked Objects&quot;]
    E --&gt; F[&quot;Reclaim Memory&quot;]
end

C --&gt; D
</code>
</pre>

<p><strong>Advantages</strong>: Simple, handles circular references<br><strong>Disadvantages</strong>: Stop-the-world pauses, fragmentation</p>
<h3 id="Copying-Algorithm"><a href="#Copying-Algorithm" class="headerlink" title="Copying Algorithm"></a>Copying Algorithm</h3><p>Used primarily in Young Generation:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Conceptual representation</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CopyingGC</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Space fromSpace;</span><br><span class="line">    <span class="keyword">private</span> Space toSpace;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">collect</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Copy live objects from &#x27;from&#x27; to &#x27;to&#x27; space</span></span><br><span class="line">        <span class="keyword">for</span> (Object obj : fromSpace.getLiveObjects()) &#123;</span><br><span class="line">            toSpace.copy(obj);</span><br><span class="line">            updateReferences(obj);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Swap spaces</span></span><br><span class="line">        <span class="type">Space</span> <span class="variable">temp</span> <span class="operator">=</span> fromSpace;</span><br><span class="line">        fromSpace = toSpace;</span><br><span class="line">        toSpace = temp;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Clear old space</span></span><br><span class="line">        temp.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Advantages</strong>: No fragmentation, fast allocation<br><strong>Disadvantages</strong>: Requires double memory, inefficient for high survival rates</p>
<h3 id="Mark-Compact-Algorithm"><a href="#Mark-Compact-Algorithm" class="headerlink" title="Mark-Compact Algorithm"></a>Mark-Compact Algorithm</h3><p>Combines marking with compaction:</p>
<ol>
<li><strong>Mark</strong>: Identify live objects</li>
<li><strong>Compact</strong>: Move live objects to eliminate fragmentation</li>
</ol>
<pre>
<code class="mermaid">
flowchart LR
subgraph &quot;Before Compaction&quot;
    A[&quot;Live&quot;] --&gt; B[&quot;Dead&quot;] --&gt; C[&quot;Live&quot;] --&gt; D[&quot;Dead&quot;] --&gt; E[&quot;Live&quot;]
end
</code>
</pre>
<pre>
<code class="mermaid">
flowchart LR
subgraph &quot;After Compaction&quot;
    F[&quot;Live&quot;] --&gt; G[&quot;Live&quot;] --&gt; H[&quot;Live&quot;] --&gt; I[&quot;Free Space&quot;]
end
</code>
</pre>

<p><strong>Interview Insight</strong>: <em>Why doesnt Young Generation use Mark-Compact algorithm?</em></p>
<p><strong>Answer</strong>: Young Generation has high mortality rate (90%+ objects die), making copying algorithm more efficient. Mark-Compact is better for Old Generation where most objects survive and fragmentation is a concern.</p>
<h3 id="Incremental-and-Concurrent-Algorithms"><a href="#Incremental-and-Concurrent-Algorithms" class="headerlink" title="Incremental and Concurrent Algorithms"></a>Incremental and Concurrent Algorithms</h3><p><strong>Incremental GC</strong>: Breaks GC work into small increments<br><strong>Concurrent GC</strong>: Runs GC concurrently with application threads</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Tri-color marking for concurrent GC</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">ObjectColor</span> &#123;</span><br><span class="line">    WHITE,  <span class="comment">// Not visited</span></span><br><span class="line">    GRAY,   <span class="comment">// Visited but children not processed</span></span><br><span class="line">    BLACK   <span class="comment">// Visited and children processed</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConcurrentMarking</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">concurrentMark</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Mark roots as gray</span></span><br><span class="line">        <span class="keyword">for</span> (Object root : gcRoots) &#123;</span><br><span class="line">            root.color = GRAY;</span><br><span class="line">            grayQueue.add(root);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Process gray objects concurrently</span></span><br><span class="line">        <span class="keyword">while</span> (!grayQueue.isEmpty() &amp;&amp; !shouldYield()) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> grayQueue.poll();</span><br><span class="line">            <span class="keyword">for</span> (Object child : obj.getReferences()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (child.color == WHITE) &#123;</span><br><span class="line">                    child.color = GRAY;</span><br><span class="line">                    grayQueue.add(child);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            obj.color = BLACK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Garbage-Collectors-Evolution"><a href="#Garbage-Collectors-Evolution" class="headerlink" title="Garbage Collectors Evolution"></a>Garbage Collectors Evolution</h2><h3 id="Serial-GC-XX-UseSerialGC"><a href="#Serial-GC-XX-UseSerialGC" class="headerlink" title="Serial GC (-XX:+UseSerialGC)"></a>Serial GC (-XX:+UseSerialGC)</h3><p><strong>Characteristics</strong>: Single-threaded, stop-the-world<br><strong>Best for</strong>: Small applications, client-side applications<br><strong>JVM Versions</strong>: All versions</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># JVM flags for Serial GC</span></span><br><span class="line">java -XX:+UseSerialGC -Xmx512m MyApplication</span><br></pre></td></tr></table></figure>

<p><strong>Use Case Example</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Small desktop application</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CalculatorApp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// Serial GC sufficient for small heap sizes</span></span><br><span class="line">        SwingUtilities.invokeLater(() -&gt; <span class="keyword">new</span> <span class="title class_">Calculator</span>().setVisible(<span class="literal">true</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Parallel-GC-XX-UseParallelGC"><a href="#Parallel-GC-XX-UseParallelGC" class="headerlink" title="Parallel GC (-XX:+UseParallelGC)"></a>Parallel GC (-XX:+UseParallelGC)</h3><p><strong>Characteristics</strong>: Multi-threaded, throughput-focused<br><strong>Best for</strong>: Batch processing, throughput-sensitive applications<br><strong>Default</strong>: Java 8 (server-class machines)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Parallel GC configuration</span></span><br><span class="line">java -XX:+UseParallelGC -XX:ParallelGCThreads=4 -Xmx2g MyBatchJob</span><br></pre></td></tr></table></figure>

<p><strong>Production Example</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Data processing application</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataProcessor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processBatch</span><span class="params">(List&lt;Record&gt; records)</span> &#123;</span><br><span class="line">        <span class="comment">// High throughput processing</span></span><br><span class="line">        records.parallelStream()</span><br><span class="line">               .map(<span class="built_in">this</span>::transform)</span><br><span class="line">               .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CMS-GC-XX-UseConcMarkSweepGC-Deprecated-in-Java-14"><a href="#CMS-GC-XX-UseConcMarkSweepGC-Deprecated-in-Java-14" class="headerlink" title="CMS GC (-XX:+UseConcMarkSweepGC) [Deprecated in Java 14]"></a>CMS GC (-XX:+UseConcMarkSweepGC) [Deprecated in Java 14]</h3><p><strong>Phases</strong>:</p>
<ol>
<li>Initial Mark (STW)</li>
<li>Concurrent Mark</li>
<li>Concurrent Preclean</li>
<li>Remark (STW)</li>
<li>Concurrent Sweep</li>
</ol>
<p><strong>Characteristics</strong>: Concurrent, low-latency focused<br><strong>Best for</strong>: Web applications requiring low pause times</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMS configuration (legacy)</span></span><br><span class="line">java -XX:+UseConcMarkSweepGC -XX:+CMSIncrementalMode -Xmx4g WebApp</span><br></pre></td></tr></table></figure>

<h3 id="G1-GC-XX-UseG1GC"><a href="#G1-GC-XX-UseG1GC" class="headerlink" title="G1 GC (-XX:+UseG1GC)"></a>G1 GC (-XX:+UseG1GC)</h3><p><strong>Characteristics</strong>: Low-latency, region-based, predictable pause times<br><strong>Best for</strong>: Large heaps (&gt;4GB), latency-sensitive applications<br><strong>Default</strong>: Java 9+</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># G1 GC tuning</span></span><br><span class="line">java -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:G1HeapRegionSize=16m -Xmx8g</span><br></pre></td></tr></table></figure>

<p><strong>Region-based Architecture</strong>:</p>
<pre>
<code class="mermaid">
flowchart TB
subgraph &quot;G1 Heap Regions&quot;
    subgraph &quot;Young Regions&quot;
        E1[&quot;Eden 1&quot;]
        E2[&quot;Eden 2&quot;]
        S1[&quot;Survivor 1&quot;]
    end
    
    subgraph &quot;Old Regions&quot;
        O1[&quot;Old 1&quot;]
        O2[&quot;Old 2&quot;]
        O3[&quot;Old 3&quot;]
    end
    
    subgraph &quot;Special Regions&quot;
        H[&quot;Humongous&quot;]
        F[&quot;Free&quot;]
    end
end
</code>
</pre>

<p><strong>Interview Insight</strong>: <em>When would you choose G1 over Parallel GC?</em></p>
<p><strong>Answer</strong>: Choose G1 for applications requiring predictable low pause times (&lt;200ms) with large heaps (&gt;4GB). Use Parallel GC for batch processing where throughput is more important than latency.</p>
<h3 id="ZGC-XX-UseZGC-Java-11"><a href="#ZGC-XX-UseZGC-Java-11" class="headerlink" title="ZGC (-XX:+UseZGC) [Java 11+]"></a>ZGC (-XX:+UseZGC) [Java 11+]</h3><p><strong>Characteristics</strong>: Ultra-low latency (&lt;10ms), colored pointers<br><strong>Best for</strong>: Applications requiring consistent low latency</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ZGC configuration</span></span><br><span class="line">java -XX:+UseZGC -XX:+UseTransparentHugePages -Xmx32g LatencyCriticalApp</span><br></pre></td></tr></table></figure>

<h3 id="Shenandoah-GC-XX-UseShenandoahGC-Java-12"><a href="#Shenandoah-GC-XX-UseShenandoahGC-Java-12" class="headerlink" title="Shenandoah GC (-XX:+UseShenandoahGC) [Java 12+]"></a>Shenandoah GC (-XX:+UseShenandoahGC) [Java 12+]</h3><p><strong>Characteristics</strong>: Low pause times, concurrent collection<br><strong>Best for</strong>: Applications with large heaps requiring consistent performance</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Shenandoah configuration</span></span><br><span class="line">-XX:+UseShenandoahGC</span><br><span class="line">-XX:ShenandoahGCHeuristics=adaptive</span><br></pre></td></tr></table></figure>
<h3 id="Collector-Comparison"><a href="#Collector-Comparison" class="headerlink" title="Collector Comparison"></a>Collector Comparison</h3><p><strong>Collector Comparison Table</strong>:</p>
<table>
<thead>
<tr>
<th>Collector</th>
<th>Java Version</th>
<th>Best Heap Size</th>
<th>Pause Time</th>
<th>Throughput</th>
<th>Use Case</th>
</tr>
</thead>
<tbody><tr>
<td>Serial</td>
<td>All</td>
<td>&lt; 100MB</td>
<td>High</td>
<td>Low</td>
<td>Single-core, client apps</td>
</tr>
<tr>
<td>Parallel</td>
<td>All (default 8)</td>
<td>&lt; 8GB</td>
<td>Medium-High</td>
<td>High</td>
<td>Multi-core, batch processing</td>
</tr>
<tr>
<td>G1</td>
<td>7+ (default 9+)</td>
<td>&gt; 4GB</td>
<td>Low-Medium</td>
<td>Medium-High</td>
<td>Server applications</td>
</tr>
<tr>
<td>ZGC</td>
<td>11+</td>
<td>&gt; 8GB</td>
<td>Ultra-low</td>
<td>Medium</td>
<td>Latency-critical applications</td>
</tr>
<tr>
<td>Shenandoah</td>
<td>12+</td>
<td>&gt; 8GB</td>
<td>Ultra-low</td>
<td>Medium</td>
<td>Real-time applications</td>
</tr>
</tbody></table>
<h2 id="GC-Tuning-Parameters-and-Best-Practices"><a href="#GC-Tuning-Parameters-and-Best-Practices" class="headerlink" title="GC Tuning Parameters and Best Practices"></a>GC Tuning Parameters and Best Practices</h2><h3 id="Heap-Sizing-Parameters"><a href="#Heap-Sizing-Parameters" class="headerlink" title="Heap Sizing Parameters"></a>Heap Sizing Parameters</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Basic heap configuration</span></span><br><span class="line">-Xms2g          <span class="comment"># Initial heap size</span></span><br><span class="line">-Xmx8g          <span class="comment"># Maximum heap size</span></span><br><span class="line">-XX:NewRatio=3  <span class="comment"># Old/Young generation ratio</span></span><br><span class="line">-XX:SurvivorRatio=8  <span class="comment"># Eden/Survivor ratio</span></span><br></pre></td></tr></table></figure>

<h3 id="Young-Generation-Tuning"><a href="#Young-Generation-Tuning" class="headerlink" title="Young Generation Tuning"></a>Young Generation Tuning</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Young generation specific tuning</span></span><br><span class="line">-Xmn2g                    <span class="comment"># Set young generation size</span></span><br><span class="line">-XX:MaxTenuringThreshold=7 <span class="comment"># Promotion threshold</span></span><br><span class="line">-XX:TargetSurvivorRatio=90 <span class="comment"># Survivor space target utilization</span></span><br></pre></td></tr></table></figure>

<p><strong>Real-world Example</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Web application tuning scenario</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebAppTuning</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Application characteristics:</span></span><br><span class="line"><span class="comment">     * - High request rate</span></span><br><span class="line"><span class="comment">     * - Short-lived request objects</span></span><br><span class="line"><span class="comment">     * - Some cached data</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * Tuning strategy:</span></span><br><span class="line"><span class="comment">     * - Larger young generation for short-lived objects</span></span><br><span class="line"><span class="comment">     * - G1GC for predictable pause times</span></span><br><span class="line"><span class="comment">     * - Monitoring allocation rate</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// JVM flags:</span></span><br><span class="line"><span class="comment">// -XX:+UseG1GC -Xmx4g -XX:MaxGCPauseMillis=100 </span></span><br><span class="line"><span class="comment">// -XX:G1HeapRegionSize=8m -XX:NewRatio=2</span></span><br></pre></td></tr></table></figure>

<h3 id="Monitoring-and-Logging"><a href="#Monitoring-and-Logging" class="headerlink" title="Monitoring and Logging"></a>Monitoring and Logging</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># GC logging (Java 8)</span></span><br><span class="line">-Xloggc:gc.log -XX:+PrintGCDetails -XX:+PrintGCTimeStamps</span><br><span class="line"></span><br><span class="line"><span class="comment"># GC logging (Java 9+)</span></span><br><span class="line">-Xlog:gc*:gc.log:<span class="keyword">time</span>,tags</span><br><span class="line"></span><br><span class="line"><span class="comment"># Additional monitoring</span></span><br><span class="line">-XX:+PrintGCApplicationStoppedTime</span><br><span class="line">-XX:+PrintStringDeduplicationStatistics (G1)</span><br></pre></td></tr></table></figure>

<h3 id="Production-Tuning-Checklist"><a href="#Production-Tuning-Checklist" class="headerlink" title="Production Tuning Checklist"></a>Production Tuning Checklist</h3><p><strong>Memory Allocation</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Monitor allocation patterns</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AllocationMonitoring</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">trackAllocationRate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MemoryMXBean</span> <span class="variable">memoryBean</span> <span class="operator">=</span> ManagementFactory.getMemoryMXBean();</span><br><span class="line">        </span><br><span class="line">        <span class="type">long</span> <span class="variable">beforeGC</span> <span class="operator">=</span> memoryBean.getHeapMemoryUsage().getUsed();</span><br><span class="line">        <span class="comment">// ... application work</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">afterGC</span> <span class="operator">=</span> memoryBean.getHeapMemoryUsage().getUsed();</span><br><span class="line">        </span><br><span class="line">        <span class="type">long</span> <span class="variable">allocatedBytes</span> <span class="operator">=</span> calculateAllocationRate(beforeGC, afterGC);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>GC Overhead Analysis</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Acceptable GC overhead typically &lt; 5%</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GCOverheadCalculator</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">calculateGCOverhead</span><span class="params">(List&lt;GCEvent&gt; events, <span class="type">long</span> totalTime)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">gcTime</span> <span class="operator">=</span> events.stream()</span><br><span class="line">                           .mapToLong(GCEvent::getDuration)</span><br><span class="line">                           .sum();</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">double</span>) gcTime / totalTime * <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Advanced-GC-Concepts"><a href="#Advanced-GC-Concepts" class="headerlink" title="Advanced GC Concepts"></a>Advanced GC Concepts</h2><h3 id="Escape-Analysis-and-TLAB"><a href="#Escape-Analysis-and-TLAB" class="headerlink" title="Escape Analysis and TLAB"></a>Escape Analysis and TLAB</h3><p><strong>Thread Local Allocation Buffers (TLAB)</strong> optimize object allocation:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TLABExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demonstrateTLAB</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Objects allocated in thread-local buffer</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();  <span class="comment">// Fast TLAB allocation</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Escape analysis may eliminate allocation entirely</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">noEscapeAllocation</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();  <span class="comment">// May be stack-allocated</span></span><br><span class="line">        sb.append(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();  <span class="comment">// Object doesn&#x27;t escape method</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="String-Deduplication-G1"><a href="#String-Deduplication-G1" class="headerlink" title="String Deduplication (G1)"></a>String Deduplication (G1)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Enable string deduplication</span></span><br><span class="line">-XX:+UseG1GC -XX:+UseStringDeduplication</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// String deduplication example</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StringDeduplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demonstrateDeduplication</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;String&gt; strings = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// These strings have same content but different instances</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            strings.add(<span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;duplicate content&quot;</span>));  <span class="comment">// Candidates for deduplication</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Compressed-OOPs"><a href="#Compressed-OOPs" class="headerlink" title="Compressed OOPs"></a>Compressed OOPs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Enable compressed ordinary object pointers (default on 64-bit with heap &lt; 32GB)</span></span><br><span class="line">-XX:+UseCompressedOops</span><br><span class="line">-XX:+UseCompressedClassPointers</span><br></pre></td></tr></table></figure>

<h2 id="Interview-Questions-and-Advanced-Scenarios"><a href="#Interview-Questions-and-Advanced-Scenarios" class="headerlink" title="Interview Questions and Advanced Scenarios"></a>Interview Questions and Advanced Scenarios</h2><h3 id="Scenario-Based-Questions"><a href="#Scenario-Based-Questions" class="headerlink" title="Scenario-Based Questions"></a>Scenario-Based Questions</h3><p><strong>Question</strong>: <em>Your application experiences long GC pauses during peak traffic. How would you diagnose and fix this?</em></p>
<p><strong>Answer</strong>:</p>
<ol>
<li><strong>Analysis</strong>: Enable GC logging, analyze pause times and frequency</li>
<li><strong>Identification</strong>: Check if Major GC is causing long pauses</li>
<li><strong>Solutions</strong>:<ul>
<li>Switch to G1GC for predictable pause times</li>
<li>Increase heap size to reduce GC frequency</li>
<li>Tune young generation size</li>
<li>Consider object pooling for frequently allocated objects</li>
</ul>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Example diagnostic approach</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GCDiagnostics</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">diagnoseGCIssues</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Monitor GC metrics</span></span><br><span class="line">        List&lt;GarbageCollectorMXBean&gt; gcBeans = </span><br><span class="line">            ManagementFactory.getGarbageCollectorMXBeans();</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">for</span> (GarbageCollectorMXBean gcBean : gcBeans) &#123;</span><br><span class="line">            System.out.printf(<span class="string">&quot;GC Name: %s, Collections: %d, Time: %d ms%n&quot;</span>,</span><br><span class="line">                gcBean.getName(),</span><br><span class="line">                gcBean.getCollectionCount(),</span><br><span class="line">                gcBean.getCollectionTime());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Question</strong>: <em>Explain the trade-offs between throughput and latency in GC selection.</em></p>
<p><strong>Answer</strong>:</p>
<ul>
<li><strong>Throughput-focused</strong>: Parallel GC maximizes application processing time</li>
<li><strong>Latency-focused</strong>: G1&#x2F;ZGC minimizes pause times but may reduce overall throughput</li>
<li><strong>Choice depends on</strong>: Application requirements, SLA constraints, heap size</li>
</ul>
<h3 id="Memory-Leak-Detection"><a href="#Memory-Leak-Detection" class="headerlink" title="Memory Leak Detection"></a>Memory Leak Detection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Common memory leak patterns</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemoryLeakExamples</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Set&lt;Object&gt; cache = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();  <span class="comment">// Static collection</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">potentialLeak</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Listeners not removed</span></span><br><span class="line">        someComponent.addListener(event -&gt; &#123;&#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ThreadLocal not cleaned</span></span><br><span class="line">        ThreadLocal&lt;ExpensiveObject&gt; threadLocal = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line">        threadLocal.set(<span class="keyword">new</span> <span class="title class_">ExpensiveObject</span>());</span><br><span class="line">        <span class="comment">// threadLocal.remove(); // Missing cleanup</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Proper cleanup</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">properCleanup</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Use try-with-resources</span></span><br><span class="line">            <span class="keyword">try</span> (<span class="type">AutoCloseable</span> <span class="variable">resource</span> <span class="operator">=</span> createResource()) &#123;</span><br><span class="line">                <span class="comment">// Work with resource</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// Handle exception</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Production-Best-Practices"><a href="#Production-Best-Practices" class="headerlink" title="Production Best Practices"></a>Production Best Practices</h2><h3 id="Monitoring-and-Alerting"><a href="#Monitoring-and-Alerting" class="headerlink" title="Monitoring and Alerting"></a>Monitoring and Alerting</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JMX-based GC monitoring</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GCMonitor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;GarbageCollectorMXBean&gt; gcBeans;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GCMonitor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.gcBeans = ManagementFactory.getGarbageCollectorMXBeans();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setupAlerts</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Alert if GC overhead &gt; 5%</span></span><br><span class="line">        <span class="comment">// Alert if pause times &gt; SLA limits</span></span><br><span class="line">        <span class="comment">// Monitor allocation rate trends</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> GCMetrics <span class="title function_">collectMetrics</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">GCMetrics</span>(</span><br><span class="line">            getTotalGCTime(),</span><br><span class="line">            getGCFrequency(),</span><br><span class="line">            getLongestPause(),</span><br><span class="line">            getAllocationRate()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Capacity-Planning"><a href="#Capacity-Planning" class="headerlink" title="Capacity Planning"></a>Capacity Planning</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Capacity planning calculations</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CapacityPlanning</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> HeapSizeRecommendation <span class="title function_">calculateHeapSize</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="type">long</span> allocationRate, </span></span><br><span class="line"><span class="params">            <span class="type">int</span> targetGCFrequency,</span></span><br><span class="line"><span class="params">            <span class="type">double</span> survivorRatio)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Rule of thumb: Heap size should accommodate </span></span><br><span class="line">        <span class="comment">// allocation rate * GC interval * safety factor</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">recommendedHeap</span> <span class="operator">=</span> allocationRate * targetGCFrequency * <span class="number">3</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HeapSizeRecommendation</span>(</span><br><span class="line">            recommendedHeap,</span><br><span class="line">            calculateYoungGenSize(recommendedHeap, survivorRatio),</span><br><span class="line">            calculateOldGenSize(recommendedHeap, survivorRatio)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Performance-Testing"><a href="#Performance-Testing" class="headerlink" title="Performance Testing"></a>Performance Testing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GC performance testing framework</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GCPerformanceTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">runGCStressTest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Measure allocation patterns</span></span><br><span class="line">        <span class="type">AllocationProfiler</span> <span class="variable">profiler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AllocationProfiler</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Simulate production load</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">iteration</span> <span class="operator">=</span> <span class="number">0</span>; iteration &lt; <span class="number">1000</span>; iteration++) &#123;</span><br><span class="line">            simulateWorkload();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (iteration % <span class="number">100</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                profiler.recordMetrics();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Analyze results</span></span><br><span class="line">        profiler.generateReport();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">simulateWorkload</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Create realistic object allocation patterns</span></span><br><span class="line">        List&lt;Object&gt; shortLived = createShortLivedObjects();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">longLived</span> <span class="operator">=</span> createLongLivedObject();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Process data</span></span><br><span class="line">        processData(shortLived, longLived);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Conclusion-and-Future-Directions"><a href="#Conclusion-and-Future-Directions" class="headerlink" title="Conclusion and Future Directions"></a>Conclusion and Future Directions</h2><p>Javas garbage collection continues to evolve with new collectors like ZGC and Shenandoah pushing the boundaries of low-latency collection. Understanding GC fundamentals, choosing appropriate collectors, and proper tuning remain critical for production Java applications.</p>
<p><strong>Key Takeaways</strong>:</p>
<ul>
<li>Choose GC based on application requirements (throughput vs latency)</li>
<li>Monitor and measure before optimizing</li>
<li>Understand object lifecycle and allocation patterns</li>
<li>Use appropriate reference types for memory-sensitive applications</li>
<li>Regular capacity planning and performance testing</li>
</ul>
<p><strong>Future Trends</strong>:</p>
<ul>
<li>Ultra-low latency collectors (sub-millisecond pauses)</li>
<li>Better integration with container environments</li>
<li>Machine learning-assisted GC tuning</li>
<li>Region-based collectors becoming mainstream</li>
</ul>
<p>The evolution of GC technology continues to make Java more suitable for a wider range of applications, from high-frequency trading systems requiring microsecond latencies to large-scale data processing systems prioritizing throughput.</p>
<h2 id="External-References"><a href="#External-References" class="headerlink" title="External References"></a>External References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/17/gctuning/">Oracle JVM Tuning Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/17/gctuning/garbage-first-g1-garbage-collector1.html">G1 Garbage Collector Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.openjdk.org/display/zgc/Main">ZGC Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.openjdk.org/display/shenandoah/Main">Shenandoah GC</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/openjdk/jdk">GC Algorithms Implementations</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jls/se17/html/jls-17.html#jls-17.4">Java Memory Model Specification</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/19/Redis-Cache-Expiration-Deletion-Policies-Complete-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/19/Redis-Cache-Expiration-Deletion-Policies-Complete-Guide/" class="post-title-link" itemprop="url">Redis Cache Expiration Deletion Policies - Complete Guide</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-06-19 15:25:00 / Modified: 17:05:24" itemprop="dateCreated datePublished" datetime="2025-06-19T15:25:00+08:00">2025-06-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Overview-of-Cache-Expiration-Strategies"><a href="#Overview-of-Cache-Expiration-Strategies" class="headerlink" title="Overview of Cache Expiration Strategies"></a>Overview of Cache Expiration Strategies</h2><p>Redis implements multiple expiration deletion strategies to efficiently manage memory and ensure optimal performance. Understanding these mechanisms is crucial for building scalable, high-performance applications.</p>
<p><strong>Interview Insight</strong>: <em>How does Redis handle expired keys?</em> - Redis uses a combination of lazy deletion and active deletion strategies. It doesnt immediately delete expired keys but employs intelligent algorithms to balance performance and memory usage.</p>
<h2 id="Core-Expiration-Deletion-Policies"><a href="#Core-Expiration-Deletion-Policies" class="headerlink" title="Core Expiration Deletion Policies"></a>Core Expiration Deletion Policies</h2><h3 id="Lazy-Deletion-Passive-Expiration"><a href="#Lazy-Deletion-Passive-Expiration" class="headerlink" title="Lazy Deletion (Passive Expiration)"></a>Lazy Deletion (Passive Expiration)</h3><p>Lazy deletion is the primary mechanism where expired keys are only removed when they are accessed.</p>
<p><strong>How it works</strong>:</p>
<ul>
<li>When a client attempts to access a key, Redis checks if it has expired</li>
<li>If expired, the key is immediately deleted and <code>NULL</code> is returned</li>
<li>No background scanning or proactive deletion occurs</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Example: Lazy deletion in action</span></span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">r = redis.Redis()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set a key with 2-second expiration</span></span><br><span class="line">r.setex(<span class="string">&#x27;temp_key&#x27;</span>, <span class="number">2</span>, <span class="string">&#x27;temporary_value&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Key exists initially</span></span><br><span class="line"><span class="built_in">print</span>(r.get(<span class="string">&#x27;temp_key&#x27;</span>))  <span class="comment"># b&#x27;temporary_value&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Wait for expiration</span></span><br><span class="line">time.sleep(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Key is deleted only when accessed (lazy deletion)</span></span><br><span class="line"><span class="built_in">print</span>(r.get(<span class="string">&#x27;temp_key&#x27;</span>))  <span class="comment"># None</span></span><br></pre></td></tr></table></figure>

<p><strong>Advantages</strong>:</p>
<ul>
<li>Minimal CPU overhead</li>
<li>No background processing required</li>
<li>Perfect for frequently accessed keys</li>
</ul>
<p><strong>Disadvantages</strong>:</p>
<ul>
<li>Memory waste if expired keys are never accessed</li>
<li>Unpredictable memory usage patterns</li>
</ul>
<h3 id="Active-Deletion-Proactive-Scanning"><a href="#Active-Deletion-Proactive-Scanning" class="headerlink" title="Active Deletion (Proactive Scanning)"></a>Active Deletion (Proactive Scanning)</h3><p>Redis periodically scans and removes expired keys to prevent memory bloat.</p>
<p><strong>Algorithm Details</strong>:</p>
<ol>
<li>Redis runs expiration cycles approximately 10 times per second</li>
<li>Each cycle samples 20 random keys from the expires dictionary</li>
<li>If more than 25% are expired, repeat the process</li>
<li>Maximum execution time per cycle is limited to prevent blocking</li>
</ol>
<pre>
<code class="mermaid">
flowchart TD
A[Start Expiration Cycle] --&gt; B[Sample 20 Random Keys]
B --&gt; C{More than 25% expired?}
C --&gt;|Yes| D[Delete Expired Keys]
D --&gt; E{Time limit reached?}
E --&gt;|No| B
E --&gt;|Yes| F[End Cycle]
C --&gt;|No| F
F --&gt; G[Wait ~100ms]
G --&gt; A
</code>
</pre>

<p><strong>Configuration Parameters</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Redis configuration for active expiration</span></span><br><span class="line">hz 10                    <span class="comment"># Frequency of background tasks (10 Hz = 10 times/second)</span></span><br><span class="line">active-expire-effort 1   <span class="comment"># CPU effort for active expiration (1-10)</span></span><br></pre></td></tr></table></figure>

<h3 id="Timer-Based-Deletion"><a href="#Timer-Based-Deletion" class="headerlink" title="Timer-Based Deletion"></a>Timer-Based Deletion</h3><p>While Redis doesnt implement traditional timer-based deletion, you can simulate it using sorted sets:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TimerCache</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = redis.Redis()</span><br><span class="line">        <span class="variable language_">self</span>.timer_key = <span class="string">&quot;expiration_timer&quot;</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_with_timer</span>(<span class="params">self, key, value, ttl</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Set key-value with custom timer deletion&quot;&quot;&quot;</span></span><br><span class="line">        expire_time = time.time() + ttl</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Store the actual data</span></span><br><span class="line">        <span class="variable language_">self</span>.redis_client.<span class="built_in">set</span>(key, value)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Add to timer sorted set</span></span><br><span class="line">        <span class="variable language_">self</span>.redis_client.zadd(<span class="variable language_">self</span>.timer_key, &#123;key: expire_time&#125;)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">cleanup_expired</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Background thread to clean expired keys&quot;&quot;&quot;</span></span><br><span class="line">        current_time = time.time()</span><br><span class="line">        expired_keys = <span class="variable language_">self</span>.redis_client.zrangebyscore(</span><br><span class="line">            <span class="variable language_">self</span>.timer_key, <span class="number">0</span>, current_time</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> expired_keys:</span><br><span class="line">            <span class="comment"># Remove expired keys</span></span><br><span class="line">            <span class="keyword">for</span> key <span class="keyword">in</span> expired_keys:</span><br><span class="line">                <span class="variable language_">self</span>.redis_client.delete(key.decode())</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Remove from timer set</span></span><br><span class="line">            <span class="variable language_">self</span>.redis_client.zremrangebyscore(<span class="variable language_">self</span>.timer_key, <span class="number">0</span>, current_time)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage example</span></span><br><span class="line">cache = TimerCache()</span><br><span class="line">cache.set_with_timer(<span class="string">&#x27;user:1&#x27;</span>, <span class="string">&#x27;John Doe&#x27;</span>, <span class="number">60</span>)  <span class="comment"># 60 seconds TTL</span></span><br></pre></td></tr></table></figure>

<h3 id="Delay-Queue-Deletion"><a href="#Delay-Queue-Deletion" class="headerlink" title="Delay Queue Deletion"></a>Delay Queue Deletion</h3><p>Implement a delay queue pattern for complex expiration scenarios:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DelayQueueExpiration</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis_client = redis.Redis()</span><br><span class="line">        <span class="variable language_">self</span>.queue_key = <span class="string">&quot;delay_expiration_queue&quot;</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">schedule_deletion</span>(<span class="params">self, key, delay_seconds</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Schedule key deletion after specified delay&quot;&quot;&quot;</span></span><br><span class="line">        execution_time = time.time() + delay_seconds</span><br><span class="line">        task = &#123;</span><br><span class="line">            <span class="string">&#x27;key&#x27;</span>: key,</span><br><span class="line">            <span class="string">&#x27;scheduled_time&#x27;</span>: execution_time,</span><br><span class="line">            <span class="string">&#x27;action&#x27;</span>: <span class="string">&#x27;delete&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.redis_client.zadd(</span><br><span class="line">            <span class="variable language_">self</span>.queue_key, </span><br><span class="line">            &#123;json.dumps(task): execution_time&#125;</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_delayed_deletions</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Process pending deletions&quot;&quot;&quot;</span></span><br><span class="line">        current_time = time.time()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Get tasks ready for execution</span></span><br><span class="line">        ready_tasks = <span class="variable language_">self</span>.redis_client.zrangebyscore(</span><br><span class="line">            <span class="variable language_">self</span>.queue_key, <span class="number">0</span>, current_time, withscores=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> task_json, score <span class="keyword">in</span> ready_tasks:</span><br><span class="line">            task = json.loads(task_json)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Execute deletion</span></span><br><span class="line">            <span class="variable language_">self</span>.redis_client.delete(task[<span class="string">&#x27;key&#x27;</span>])</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Remove from queue</span></span><br><span class="line">            <span class="variable language_">self</span>.redis_client.zrem(<span class="variable language_">self</span>.queue_key, task_json)</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Deleted key: <span class="subst">&#123;task[<span class="string">&#x27;key&#x27;</span>]&#125;</span> at <span class="subst">&#123;datetime.now()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage</span></span><br><span class="line">delay_queue = DelayQueueExpiration()</span><br><span class="line">delay_queue.schedule_deletion(<span class="string">&#x27;temp_data&#x27;</span>, <span class="number">300</span>)  <span class="comment"># Delete after 5 minutes</span></span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>Whats the difference between active and passive expiration?</em> - Passive (lazy) expiration only occurs when keys are accessed, while active expiration proactively scans and removes expired keys in background cycles to prevent memory bloat.</p>
<h2 id="Redis-Expiration-Policies-Eviction-Policies"><a href="#Redis-Expiration-Policies-Eviction-Policies" class="headerlink" title="Redis Expiration Policies (Eviction Policies)"></a>Redis Expiration Policies (Eviction Policies)</h2><p>When Redis reaches memory limits, it employs eviction policies to free up space:</p>
<h3 id="Available-Eviction-Policies"><a href="#Available-Eviction-Policies" class="headerlink" title="Available Eviction Policies"></a>Available Eviction Policies</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Configuration in redis.conf</span></span><br><span class="line">maxmemory 2gb</span><br><span class="line">maxmemory-policy allkeys-lru</span><br></pre></td></tr></table></figure>

<p><strong>Policy Types</strong>:</p>
<ol>
<li><p><strong>noeviction</strong> (default)</p>
<ul>
<li>No keys are evicted</li>
<li>Write operations return errors when memory limit reached</li>
<li>Use case: Critical data that cannot be lost</li>
</ul>
</li>
<li><p><strong>allkeys-lru</strong></p>
<ul>
<li>Removes least recently used keys from all keys</li>
<li>Use case: General caching scenarios</li>
</ul>
</li>
<li><p><strong>allkeys-lfu</strong></p>
<ul>
<li>Removes least frequently used keys</li>
<li>Use case: Applications with distinct access patterns</li>
</ul>
</li>
<li><p><strong>volatile-lru</strong></p>
<ul>
<li>Removes LRU keys only from keys with expiration set</li>
<li>Use case: Mixed persistent and temporary data</li>
</ul>
</li>
<li><p><strong>volatile-lfu</strong></p>
<ul>
<li>Removes LFU keys only from keys with expiration set</li>
</ul>
</li>
<li><p><strong>allkeys-random</strong></p>
<ul>
<li>Randomly removes keys</li>
<li>Use case: When access patterns are unpredictable</li>
</ul>
</li>
<li><p><strong>volatile-random</strong></p>
<ul>
<li>Randomly removes keys with expiration set</li>
</ul>
</li>
<li><p><strong>volatile-ttl</strong></p>
<ul>
<li>Removes keys with shortest TTL first</li>
<li>Use case: Time-sensitive data prioritization</li>
</ul>
</li>
</ol>
<h3 id="Policy-Selection-Guide"><a href="#Policy-Selection-Guide" class="headerlink" title="Policy Selection Guide"></a>Policy Selection Guide</h3><pre>
<code class="mermaid">
flowchart TD
A[Memory Pressure] --&gt; B{All data equally important?}
B --&gt;|Yes| C[allkeys-lru&#x2F;lfu]
B --&gt;|No| D{Temporary vs Persistent data?}
D --&gt;|Mixed| E[volatile-lru&#x2F;lfu]
D --&gt;|Time-sensitive| F[volatile-ttl]
C --&gt; G[High access pattern variance?]
G --&gt;|Yes| H[allkeys-lfu]
G --&gt;|No| I[allkeys-lru]
</code>
</pre>

<h2 id="Master-Slave-Cluster-Expiration-Mechanisms"><a href="#Master-Slave-Cluster-Expiration-Mechanisms" class="headerlink" title="Master-Slave Cluster Expiration Mechanisms"></a>Master-Slave Cluster Expiration Mechanisms</h2><h3 id="Replication-of-Expiration"><a href="#Replication-of-Expiration" class="headerlink" title="Replication of Expiration"></a>Replication of Expiration</h3><p>In Redis clusters, expiration handling follows specific patterns:</p>
<p><strong>Master-Slave Expiration Flow</strong>:</p>
<ol>
<li>Only masters perform active expiration</li>
<li>Masters send explicit <code>DEL</code> commands to slaves</li>
<li>Slaves dont independently expire keys (except for lazy deletion)</li>
</ol>
<pre>
<code class="mermaid">
sequenceDiagram
participant M as Master
participant S1 as Slave 1
participant S2 as Slave 2
participant C as Client

Note over M: Active expiration cycle
M-&gt;&gt;M: Check expired keys
M-&gt;&gt;S1: DEL expired_key
M-&gt;&gt;S2: DEL expired_key

C-&gt;&gt;S1: GET expired_key
S1-&gt;&gt;S1: Lazy expiration check
S1-&gt;&gt;C: NULL (key expired)
</code>
</pre>

<h3 id="Cluster-Configuration-for-Expiration"><a href="#Cluster-Configuration-for-Expiration" class="headerlink" title="Cluster Configuration for Expiration"></a>Cluster Configuration for Expiration</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Master configuration</span></span><br><span class="line"><span class="built_in">bind</span> 0.0.0.0</span><br><span class="line">port 6379</span><br><span class="line">maxmemory 1gb</span><br><span class="line">maxmemory-policy allkeys-lru</span><br><span class="line">hz 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># Slave configuration</span></span><br><span class="line"><span class="built_in">bind</span> 0.0.0.0</span><br><span class="line">port 6380</span><br><span class="line">slaveof 127.0.0.1 6379</span><br><span class="line">slave-read-only <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>

<p><strong>Production Example - Redis Sentinel with Expiration</strong>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis.sentinel</span><br><span class="line"></span><br><span class="line"><span class="comment"># Sentinel configuration for high availability</span></span><br><span class="line">sentinels = [(<span class="string">&#x27;localhost&#x27;</span>, <span class="number">26379</span>), (<span class="string">&#x27;localhost&#x27;</span>, <span class="number">26380</span>), (<span class="string">&#x27;localhost&#x27;</span>, <span class="number">26381</span>)]</span><br><span class="line">sentinel = redis.sentinel.Sentinel(sentinels)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get master and slave connections</span></span><br><span class="line">master = sentinel.master_for(<span class="string">&#x27;mymaster&#x27;</span>, socket_timeout=<span class="number">0.1</span>)</span><br><span class="line">slave = sentinel.slave_for(<span class="string">&#x27;mymaster&#x27;</span>, socket_timeout=<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Write to master with expiration</span></span><br><span class="line">master.setex(<span class="string">&#x27;session:user:1&#x27;</span>, <span class="number">3600</span>, <span class="string">&#x27;session_data&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Read from slave (expiration handled consistently)</span></span><br><span class="line">session_data = slave.get(<span class="string">&#x27;session:user:1&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>Interview Insight</strong>: <em>How does Redis handle expiration in a cluster?</em> - In Redis clusters, only master nodes perform active expiration. When a master expires a key, it sends explicit DEL commands to all slaves to maintain consistency.</p>
<h2 id="Durability-and-Expired-Keys"><a href="#Durability-and-Expired-Keys" class="headerlink" title="Durability and Expired Keys"></a>Durability and Expired Keys</h2><h3 id="RDB-Persistence"><a href="#RDB-Persistence" class="headerlink" title="RDB Persistence"></a>RDB Persistence</h3><p>Expired keys are handled during RDB operations:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># RDB configuration</span></span><br><span class="line">save 900 1      <span class="comment"># Save if at least 1 key changed in 900 seconds</span></span><br><span class="line">save 300 10     <span class="comment"># Save if at least 10 keys changed in 300 seconds</span></span><br><span class="line">save 60 10000   <span class="comment"># Save if at least 10000 keys changed in 60 seconds</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Expired keys are not saved to RDB files</span></span><br><span class="line">rdbcompression <span class="built_in">yes</span></span><br><span class="line">rdbchecksum <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>

<h3 id="AOF-Persistence"><a href="#AOF-Persistence" class="headerlink" title="AOF Persistence"></a>AOF Persistence</h3><p>AOF handles expiration through explicit commands:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># AOF configuration</span></span><br><span class="line">appendonly <span class="built_in">yes</span></span><br><span class="line">appendfsync everysec</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line"></span><br><span class="line"><span class="comment"># Expired keys generate explicit DEL commands in AOF</span></span><br><span class="line">no-appendfsync-on-rewrite no</span><br></pre></td></tr></table></figure>

<p><strong>Example AOF entries for expiration</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">*2</span><br><span class="line">$6</span><br><span class="line">SELECT</span><br><span class="line">$1</span><br><span class="line">0</span><br><span class="line">*3</span><br><span class="line">$3</span><br><span class="line">SET</span><br><span class="line">$8</span><br><span class="line">temp_key</span><br><span class="line">$5</span><br><span class="line">value</span><br><span class="line">*3</span><br><span class="line">$6</span><br><span class="line">EXPIRE</span><br><span class="line">$8</span><br><span class="line">temp_key</span><br><span class="line">$2</span><br><span class="line">60</span><br><span class="line">*2</span><br><span class="line">$3</span><br><span class="line">DEL</span><br><span class="line">$8</span><br><span class="line">temp_key</span><br></pre></td></tr></table></figure>

<h2 id="Optimization-Strategies"><a href="#Optimization-Strategies" class="headerlink" title="Optimization Strategies"></a>Optimization Strategies</h2><h3 id="Memory-Efficient-Configuration"><a href="#Memory-Efficient-Configuration" class="headerlink" title="Memory-Efficient Configuration"></a>Memory-Efficient Configuration</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># redis.conf optimizations</span></span><br><span class="line">maxmemory 2gb</span><br><span class="line">maxmemory-policy allkeys-lru</span><br><span class="line"></span><br><span class="line"><span class="comment"># Active deletion tuning</span></span><br><span class="line">hz 10  <span class="comment"># Background task frequency</span></span><br><span class="line">active-expire-cycle-lookups-per-loop 20</span><br><span class="line">active-expire-cycle-fast-duration 1000</span><br><span class="line"></span><br><span class="line"><span class="comment"># Memory sampling for LRU/LFU</span></span><br><span class="line">maxmemory-samples 5</span><br></pre></td></tr></table></figure>

<h3 id="Expiration-Time-Configuration-Optimization"><a href="#Expiration-Time-Configuration-Optimization" class="headerlink" title="Expiration Time Configuration Optimization"></a>Expiration Time Configuration Optimization</h3><p><strong>Hierarchical TTL Strategy</strong>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TTLManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis_client</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Define TTL hierarchy</span></span><br><span class="line">        <span class="variable language_">self</span>.ttl_config = &#123;</span><br><span class="line">            <span class="string">&#x27;hot_data&#x27;</span>: <span class="number">300</span>,      <span class="comment"># 5 minutes - frequently accessed</span></span><br><span class="line">            <span class="string">&#x27;warm_data&#x27;</span>: <span class="number">1800</span>,    <span class="comment"># 30 minutes - moderately accessed</span></span><br><span class="line">            <span class="string">&#x27;cold_data&#x27;</span>: <span class="number">3600</span>,    <span class="comment"># 1 hour - rarely accessed</span></span><br><span class="line">            <span class="string">&#x27;session_data&#x27;</span>: <span class="number">7200</span>, <span class="comment"># 2 hours - user sessions</span></span><br><span class="line">            <span class="string">&#x27;cache_data&#x27;</span>: <span class="number">86400</span>   <span class="comment"># 24 hours - general cache</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_with_smart_ttl</span>(<span class="params">self, key, value, data_type=<span class="string">&#x27;cache_data&#x27;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Set key with intelligent TTL based on data type&quot;&quot;&quot;</span></span><br><span class="line">        ttl = <span class="variable language_">self</span>.ttl_config.get(data_type, <span class="number">3600</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Add jitter to prevent thundering herd</span></span><br><span class="line">        <span class="keyword">import</span> random</span><br><span class="line">        jitter = random.randint(-ttl//<span class="number">10</span>, ttl//<span class="number">10</span>)</span><br><span class="line">        final_ttl = ttl + jitter</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.redis.setex(key, final_ttl, value)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">adaptive_ttl</span>(<span class="params">self, key, access_frequency</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Adjust TTL based on access patterns&quot;&quot;&quot;</span></span><br><span class="line">        base_ttl = <span class="number">3600</span>  <span class="comment"># 1 hour base</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> access_frequency &gt; <span class="number">100</span>:  <span class="comment"># Hot key</span></span><br><span class="line">            <span class="keyword">return</span> base_ttl // <span class="number">4</span>    <span class="comment"># 15 minutes</span></span><br><span class="line">        <span class="keyword">elif</span> access_frequency &gt; <span class="number">10</span>: <span class="comment"># Warm key</span></span><br><span class="line">            <span class="keyword">return</span> base_ttl // <span class="number">2</span>    <span class="comment"># 30 minutes</span></span><br><span class="line">        <span class="keyword">else</span>:                       <span class="comment"># Cold key</span></span><br><span class="line">            <span class="keyword">return</span> base_ttl * <span class="number">2</span>     <span class="comment"># 2 hours</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage example</span></span><br><span class="line">ttl_manager = TTLManager(redis.Redis())</span><br><span class="line">ttl_manager.set_with_smart_ttl(<span class="string">&#x27;user:profile:123&#x27;</span>, user_data, <span class="string">&#x27;hot_data&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="Production-Use-Cases"><a href="#Production-Use-Cases" class="headerlink" title="Production Use Cases"></a>Production Use Cases</h2><h3 id="High-Concurrent-Idempotent-Scenarios"><a href="#High-Concurrent-Idempotent-Scenarios" class="headerlink" title="High-Concurrent Idempotent Scenarios"></a>High-Concurrent Idempotent Scenarios</h3><p>In idempotent(&#x2F;ademptnt&#x2F;) operations, cache expiration must prevent duplicate processing while maintaining consistency.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IdempotentCache</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis.Redis()</span><br><span class="line">        <span class="variable language_">self</span>.default_ttl = <span class="number">300</span>  <span class="comment"># 5 minutes</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_idempotent_key</span>(<span class="params">self, operation, params</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Generate unique key for operation&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Create hash from operation and parameters</span></span><br><span class="line">        content = <span class="string">f&quot;<span class="subst">&#123;operation&#125;</span>:<span class="subst">&#123;<span class="built_in">str</span>(<span class="built_in">sorted</span>(params.items()))&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;idempotent:<span class="subst">&#123;hashlib.md5(content.encode()).hexdigest()&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute_idempotent</span>(<span class="params">self, operation, params, executor_func</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Execute operation with idempotency guarantee&quot;&quot;&quot;</span></span><br><span class="line">        idempotent_key = <span class="variable language_">self</span>.generate_idempotent_key(operation, params)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Check if operation already executed</span></span><br><span class="line">        result = <span class="variable language_">self</span>.redis.get(idempotent_key)</span><br><span class="line">        <span class="keyword">if</span> result:</span><br><span class="line">            <span class="keyword">return</span> json.loads(result)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Use distributed lock to prevent concurrent execution</span></span><br><span class="line">        lock_key = <span class="string">f&quot;lock:<span class="subst">&#123;idempotent_key&#125;</span>&quot;</span></span><br><span class="line">        lock_acquired = <span class="variable language_">self</span>.redis.<span class="built_in">set</span>(lock_key, <span class="string">&quot;1&quot;</span>, nx=<span class="literal">True</span>, ex=<span class="number">60</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> lock_acquired:</span><br><span class="line">            <span class="comment"># Wait and check again</span></span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">            result = <span class="variable language_">self</span>.redis.get(idempotent_key)</span><br><span class="line">            <span class="keyword">if</span> result:</span><br><span class="line">                <span class="keyword">return</span> json.loads(result)</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">&quot;Operation in progress&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># Execute the actual operation</span></span><br><span class="line">            result = executor_func(params)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Cache the result</span></span><br><span class="line">            <span class="variable language_">self</span>.redis.setex(</span><br><span class="line">                idempotent_key, </span><br><span class="line">                <span class="variable language_">self</span>.default_ttl, </span><br><span class="line">                json.dumps(result)</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="comment"># Release lock</span></span><br><span class="line">            <span class="variable language_">self</span>.redis.delete(lock_key)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage example</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_payment</span>(<span class="params">params</span>):</span><br><span class="line">    <span class="comment"># Simulate payment processing</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;success&quot;</span>, <span class="string">&quot;transaction_id&quot;</span>: <span class="built_in">str</span>(uuid.uuid4())&#125;</span><br><span class="line"></span><br><span class="line">idempotent_cache = IdempotentCache()</span><br><span class="line">result = idempotent_cache.execute_idempotent(</span><br><span class="line">    <span class="string">&quot;payment&quot;</span>, </span><br><span class="line">    &#123;<span class="string">&quot;amount&quot;</span>: <span class="number">100</span>, <span class="string">&quot;user_id&quot;</span>: <span class="string">&quot;123&quot;</span>&#125;, </span><br><span class="line">    process_payment</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="Hot-Key-Scenarios"><a href="#Hot-Key-Scenarios" class="headerlink" title="Hot Key Scenarios"></a>Hot Key Scenarios</h3><p><strong>Problem</strong>: Managing frequently accessed keys that can overwhelm Redis.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HotKeyManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis.Redis()</span><br><span class="line">        <span class="variable language_">self</span>.access_stats = defaultdict(<span class="built_in">int</span>)</span><br><span class="line">        <span class="variable language_">self</span>.hot_key_threshold = <span class="number">1000</span>  <span class="comment"># Requests per minute</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_with_hot_key_protection</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get value with hot key protection&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.access_stats[key] += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Check if key is hot</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.access_stats[key] &gt; <span class="variable language_">self</span>.hot_key_threshold:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>._handle_hot_key(key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.redis.get(key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_handle_hot_key</span>(<span class="params">self, hot_key</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Handle hot key with multiple strategies&quot;&quot;&quot;</span></span><br><span class="line">        strategies = [</span><br><span class="line">            <span class="variable language_">self</span>._local_cache_strategy,</span><br><span class="line">            <span class="variable language_">self</span>._replica_strategy,</span><br><span class="line">            <span class="variable language_">self</span>._fragmentation_strategy</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Choose strategy based on key characteristics</span></span><br><span class="line">        <span class="keyword">return</span> random.choice(strategies)(hot_key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_local_cache_strategy</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Use local cache for hot keys&quot;&quot;&quot;</span></span><br><span class="line">        local_cache_key = <span class="string">f&quot;local:<span class="subst">&#123;key&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Check local cache first (simulate with Redis)</span></span><br><span class="line">        local_value = <span class="variable language_">self</span>.redis.get(local_cache_key)</span><br><span class="line">        <span class="keyword">if</span> local_value:</span><br><span class="line">            <span class="keyword">return</span> local_value</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Get from main cache and store locally</span></span><br><span class="line">        value = <span class="variable language_">self</span>.redis.get(key)</span><br><span class="line">        <span class="keyword">if</span> value:</span><br><span class="line">            <span class="comment"># Short TTL for local cache</span></span><br><span class="line">            <span class="variable language_">self</span>.redis.setex(local_cache_key, <span class="number">60</span>, value)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_replica_strategy</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Create multiple replicas of hot key&quot;&quot;&quot;</span></span><br><span class="line">        replica_count = <span class="number">5</span></span><br><span class="line">        replica_key = <span class="string">f&quot;<span class="subst">&#123;key&#125;</span>:replica:<span class="subst">&#123;random.randint(<span class="number">1</span>, replica_count)&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Try to get from replica</span></span><br><span class="line">        value = <span class="variable language_">self</span>.redis.get(replica_key)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> value:</span><br><span class="line">            <span class="comment"># Get from master and update replica</span></span><br><span class="line">            value = <span class="variable language_">self</span>.redis.get(key)</span><br><span class="line">            <span class="keyword">if</span> value:</span><br><span class="line">                <span class="variable language_">self</span>.redis.setex(replica_key, <span class="number">300</span>, value)  <span class="comment"># 5 min TTL</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_fragmentation_strategy</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Fragment hot key into smaller pieces&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># For large objects, split into fragments</span></span><br><span class="line">        fragments = []</span><br><span class="line">        fragment_index = <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            fragment_key = <span class="string">f&quot;<span class="subst">&#123;key&#125;</span>:frag:<span class="subst">&#123;fragment_index&#125;</span>&quot;</span></span><br><span class="line">            fragment = <span class="variable language_">self</span>.redis.get(fragment_key)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> fragment:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">                </span><br><span class="line">            fragments.append(fragment)</span><br><span class="line">            fragment_index += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> fragments:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">b&#x27;&#x27;</span>.join(fragments)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.redis.get(key)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage example</span></span><br><span class="line">hot_key_manager = HotKeyManager()</span><br><span class="line">value = hot_key_manager.get_with_hot_key_protection(<span class="string">&#x27;popular_product:123&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Pre-Loading-and-Predictive-Caching"><a href="#Pre-Loading-and-Predictive-Caching" class="headerlink" title="Pre-Loading and Predictive Caching"></a>Pre-Loading and Predictive Caching</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PredictiveCacheManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis_client</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">preload_related_data</span>(<span class="params">self, primary_key, related_keys_func, short_ttl=<span class="number">300</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Pre-load related data with shorter TTL</span></span><br><span class="line"><span class="string">        Useful for pagination, related products, etc.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Get related keys that might be accessed soon</span></span><br><span class="line">        related_keys = related_keys_func(primary_key)</span><br><span class="line">        </span><br><span class="line">        pipeline = <span class="variable language_">self</span>.redis.pipeline()</span><br><span class="line">        <span class="keyword">for</span> related_key <span class="keyword">in</span> related_keys:</span><br><span class="line">            <span class="comment"># Check if already cached</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.redis.exists(related_key):</span><br><span class="line">                <span class="comment"># Pre-load with shorter TTL</span></span><br><span class="line">                related_data = <span class="variable language_">self</span>._fetch_data(related_key)</span><br><span class="line">                pipeline.setex(related_key, short_ttl, related_data)</span><br><span class="line">        </span><br><span class="line">        pipeline.execute()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">cache_with_prefetch</span>(<span class="params">self, key, value, ttl=<span class="number">3600</span>, prefetch_ratio=<span class="number">0.1</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Cache data and trigger prefetch when TTL is near expiration</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.redis.setex(key, ttl, value)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Set a prefetch trigger at 90% of TTL</span></span><br><span class="line">        prefetch_ttl = <span class="built_in">int</span>(ttl * prefetch_ratio)</span><br><span class="line">        prefetch_key = <span class="string">f&quot;prefetch:<span class="subst">&#123;key&#125;</span>&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.redis.setex(prefetch_key, ttl - prefetch_ttl, <span class="string">&quot;trigger&quot;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_and_prefetch</span>(<span class="params">self, key, refresh_func</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Check if prefetch is needed and refresh in background&quot;&quot;&quot;</span></span><br><span class="line">        prefetch_key = <span class="string">f&quot;prefetch:<span class="subst">&#123;key&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.redis.exists(prefetch_key):</span><br><span class="line">            <span class="comment"># Prefetch trigger expired - refresh in background</span></span><br><span class="line">            threading.Thread(</span><br><span class="line">                target=<span class="variable language_">self</span>._background_refresh,</span><br><span class="line">                args=(key, refresh_func)</span><br><span class="line">            ).start()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_background_refresh</span>(<span class="params">self, key, refresh_func</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Refresh data in background before expiration&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            new_value = refresh_func()</span><br><span class="line">            current_ttl = <span class="variable language_">self</span>.redis.ttl(key)</span><br><span class="line">            <span class="keyword">if</span> current_ttl &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="comment"># Extend current key TTL and set new value</span></span><br><span class="line">                <span class="variable language_">self</span>.redis.setex(key, current_ttl + <span class="number">3600</span>, new_value)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># Log error but don&#x27;t fail main request</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Background refresh failed for <span class="subst">&#123;key&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example usage for e-commerce</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_related_product_keys</span>(<span class="params">product_id</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Return keys for related products, reviews, recommendations&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">f&quot;product:<span class="subst">&#123;product_id&#125;</span>:reviews&quot;</span>,</span><br><span class="line">        <span class="string">f&quot;product:<span class="subst">&#123;product_id&#125;</span>:recommendations&quot;</span>, </span><br><span class="line">        <span class="string">f&quot;product:<span class="subst">&#123;product_id&#125;</span>:similar&quot;</span>,</span><br><span class="line">        <span class="string">f&quot;category:<span class="subst">&#123;get_category(product_id)&#125;</span>:featured&quot;</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pre-load when user views a product</span></span><br><span class="line">predictive_cache = PredictiveCacheManager(redis_client)</span><br><span class="line">predictive_cache.preload_related_data(</span><br><span class="line">    <span class="string">f&quot;product:<span class="subst">&#123;product_id&#125;</span>&quot;</span>,</span><br><span class="line">    get_related_product_keys,</span><br><span class="line">    short_ttl=<span class="number">600</span>  <span class="comment"># 10 minutes for related data</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Monitoring-and-Metrics"><a href="#Performance-Monitoring-and-Metrics" class="headerlink" title="Performance Monitoring and Metrics"></a>Performance Monitoring and Metrics</h2><h3 id="Expiration-Monitoring"><a href="#Expiration-Monitoring" class="headerlink" title="Expiration Monitoring"></a>Expiration Monitoring</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExpirationMonitor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis.Redis()</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_expiration_stats</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get comprehensive expiration statistics&quot;&quot;&quot;</span></span><br><span class="line">        info = <span class="variable language_">self</span>.redis.info()</span><br><span class="line">        </span><br><span class="line">        stats = &#123;</span><br><span class="line">            <span class="string">&#x27;expired_keys&#x27;</span>: info.get(<span class="string">&#x27;expired_keys&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">            <span class="string">&#x27;evicted_keys&#x27;</span>: info.get(<span class="string">&#x27;evicted_keys&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">            <span class="string">&#x27;keyspace_hits&#x27;</span>: info.get(<span class="string">&#x27;keyspace_hits&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">            <span class="string">&#x27;keyspace_misses&#x27;</span>: info.get(<span class="string">&#x27;keyspace_misses&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">            <span class="string">&#x27;used_memory&#x27;</span>: info.get(<span class="string">&#x27;used_memory&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">            <span class="string">&#x27;maxmemory&#x27;</span>: info.get(<span class="string">&#x27;maxmemory&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">            <span class="string">&#x27;memory_usage_percentage&#x27;</span>: <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> stats[<span class="string">&#x27;maxmemory&#x27;</span>] &gt; <span class="number">0</span>:</span><br><span class="line">            stats[<span class="string">&#x27;memory_usage_percentage&#x27;</span>] = (</span><br><span class="line">                stats[<span class="string">&#x27;used_memory&#x27;</span>] / stats[<span class="string">&#x27;maxmemory&#x27;</span>] * <span class="number">100</span></span><br><span class="line">            )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Calculate hit ratio</span></span><br><span class="line">        total_requests = stats[<span class="string">&#x27;keyspace_hits&#x27;</span>] + stats[<span class="string">&#x27;keyspace_misses&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> total_requests &gt; <span class="number">0</span>:</span><br><span class="line">            stats[<span class="string">&#x27;hit_ratio&#x27;</span>] = stats[<span class="string">&#x27;keyspace_hits&#x27;</span>] / total_requests * <span class="number">100</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            stats[<span class="string">&#x27;hit_ratio&#x27;</span>] = <span class="number">0</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> stats</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">analyze_key_expiration_patterns</span>(<span class="params">self, pattern=<span class="string">&quot;*&quot;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Analyze expiration patterns for keys matching pattern&quot;&quot;&quot;</span></span><br><span class="line">        keys = <span class="variable language_">self</span>.redis.keys(pattern)</span><br><span class="line">        expiration_analysis = &#123;</span><br><span class="line">            <span class="string">&#x27;total_keys&#x27;</span>: <span class="built_in">len</span>(keys),</span><br><span class="line">            <span class="string">&#x27;keys_with_ttl&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;keys_without_ttl&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;avg_ttl&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;ttl_distribution&#x27;</span>: &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        ttl_values = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> keys:</span><br><span class="line">            ttl = <span class="variable language_">self</span>.redis.ttl(key)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> ttl == -<span class="number">1</span>:  <span class="comment"># No expiration set</span></span><br><span class="line">                expiration_analysis[<span class="string">&#x27;keys_without_ttl&#x27;</span>] += <span class="number">1</span></span><br><span class="line">            <span class="keyword">elif</span> ttl &gt;= <span class="number">0</span>:  <span class="comment"># Has expiration</span></span><br><span class="line">                expiration_analysis[<span class="string">&#x27;keys_with_ttl&#x27;</span>] += <span class="number">1</span></span><br><span class="line">                ttl_values.append(ttl)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># Categorize TTL</span></span><br><span class="line">                <span class="keyword">if</span> ttl &lt; <span class="number">300</span>:  <span class="comment"># &lt; 5 minutes</span></span><br><span class="line">                    category = <span class="string">&#x27;short_term&#x27;</span></span><br><span class="line">                <span class="keyword">elif</span> ttl &lt; <span class="number">3600</span>:  <span class="comment"># &lt; 1 hour</span></span><br><span class="line">                    category = <span class="string">&#x27;medium_term&#x27;</span></span><br><span class="line">                <span class="keyword">else</span>:  <span class="comment"># &gt;= 1 hour</span></span><br><span class="line">                    category = <span class="string">&#x27;long_term&#x27;</span></span><br><span class="line">                </span><br><span class="line">                expiration_analysis[<span class="string">&#x27;ttl_distribution&#x27;</span>][category] = \</span><br><span class="line">                    expiration_analysis[<span class="string">&#x27;ttl_distribution&#x27;</span>].get(category, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ttl_values:</span><br><span class="line">            expiration_analysis[<span class="string">&#x27;avg_ttl&#x27;</span>] = <span class="built_in">sum</span>(ttl_values) / <span class="built_in">len</span>(ttl_values)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> expiration_analysis</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage</span></span><br><span class="line">monitor = ExpirationMonitor()</span><br><span class="line">stats = monitor.get_expiration_stats()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Hit ratio: <span class="subst">&#123;stats[<span class="string">&#x27;hit_ratio&#x27;</span>]:<span class="number">.2</span>f&#125;</span>%&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Memory usage: <span class="subst">&#123;stats[<span class="string">&#x27;memory_usage_percentage&#x27;</span>]:<span class="number">.2</span>f&#125;</span>%&quot;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Configuration-Checklist"><a href="#Configuration-Checklist" class="headerlink" title="Configuration Checklist"></a>Configuration Checklist</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Memory management</span></span><br><span class="line">maxmemory 2gb</span><br><span class="line">maxmemory-policy allkeys-lru</span><br><span class="line"></span><br><span class="line"><span class="comment"># Expiration tuning</span></span><br><span class="line">hz 10</span><br><span class="line">active-expire-effort 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Persistence (affects expiration)</span></span><br><span class="line">save 900 1</span><br><span class="line">appendonly <span class="built_in">yes</span></span><br><span class="line">appendfsync everysec</span><br><span class="line"></span><br><span class="line"><span class="comment"># Monitoring</span></span><br><span class="line">latency-monitor-threshold 100</span><br></pre></td></tr></table></figure>

<h2 id="Interview-Questions-and-Expert-Answers"><a href="#Interview-Questions-and-Expert-Answers" class="headerlink" title="Interview Questions and Expert Answers"></a>Interview Questions and Expert Answers</h2><p><strong>Q: How does Redis handle expiration in a master-slave setup, and what happens during failover?</strong></p>
<p>A: In Redis replication, only the master performs expiration logic. When a key expires on the master (either through lazy or active expiration), the master sends an explicit <code>DEL</code> command to all slaves. Slaves never expire keys independently - they wait for the masters instruction.</p>
<p>During failover, the promoted slave becomes the new master and starts handling expiration. However, there might be temporary inconsistencies because:</p>
<ol>
<li>The old master might have expired keys that werent yet replicated</li>
<li>Clock differences can cause timing variations</li>
<li>Some keys might appear unexpired on the new master</li>
</ol>
<p>Production applications should handle these edge cases by implementing fallback mechanisms and not relying solely on Redis for strict expiration timing.</p>
<p><strong>Q: Whats the difference between eviction and expiration, and how do they interact?</strong></p>
<p>A: Expiration is time-based removal of keys that have reached their TTL, while eviction is memory-pressure-based removal when Redis reaches its memory limit.</p>
<p>They interact in several ways:</p>
<ul>
<li>Eviction policies like <code>volatile-lru</code> only consider keys with expiration set</li>
<li>Active expiration reduces memory pressure, potentially avoiding eviction</li>
<li>The <code>volatile-ttl</code> policy evicts keys with the shortest remaining TTL first</li>
<li>Proper TTL configuration can reduce eviction frequency and improve cache performance</li>
</ul>
<p><strong>Q: How would you optimize Redis expiration for a high-traffic e-commerce site?</strong></p>
<p>A: For high-traffic e-commerce, Id implement a multi-tier expiration strategy:</p>
<ol>
<li><strong>Product Catalog</strong>: Long TTL (4-24 hours) with background refresh</li>
<li><strong>Inventory Counts</strong>: Short TTL (1-5 minutes) with real-time updates</li>
<li><strong>User Sessions</strong>: Medium TTL (30 minutes) with sliding expiration</li>
<li><strong>Shopping Carts</strong>: Longer TTL (24-48 hours) with cleanup processes</li>
<li><strong>Search Results</strong>: Staggered TTL (15-60 minutes) with jitter to prevent thundering herd</li>
</ol>
<p>Key optimizations:</p>
<ul>
<li>Use <code>allkeys-lru</code> eviction for cache-heavy workloads</li>
<li>Implement predictive pre-loading for related products</li>
<li>Add jitter to TTL values to prevent simultaneous expiration</li>
<li>Monitor hot keys and implement replication strategies</li>
<li>Use pipeline operations for bulk TTL updates</li>
</ul>
<p>The goal is balancing data freshness, memory usage, and system performance while handling traffic spikes gracefully.</p>
<h2 id="External-References-and-Resources"><a href="#External-References-and-Resources" class="headerlink" title="External References and Resources"></a>External References and Resources</h2><ul>
<li><a target="_blank" rel="noopener" href="https://redis.io/commands/expire/">Redis Expiration Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://redis.io/topics/memory-optimization">Redis Memory Optimization Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://redis.io/topics/cluster-spec">Redis Cluster Specification</a></li>
<li><a target="_blank" rel="noopener" href="https://redis.io/topics/persistence">Redis Persistence Demystified</a></li>
<li><a target="_blank" rel="noopener" href="https://redis.io/topics/patterns">High Performance Redis Patterns</a></li>
</ul>
<h2 id="Key-Takeaways"><a href="#Key-Takeaways" class="headerlink" title="Key Takeaways"></a>Key Takeaways</h2><p>Redis expiration deletion policies are crucial for maintaining optimal performance and memory usage in production systems. The combination of lazy deletion, active expiration, and memory eviction policies provides flexible options for different use cases.</p>
<p>Success in production requires understanding the trade-offs between memory usage, CPU overhead, and data consistency, especially in distributed environments. Monitoring expiration efficiency and implementing appropriate TTL strategies based on access patterns is essential for maintaining high-performance Redis deployments.</p>
<p>The key is matching expiration strategies to your specific use case: use longer TTLs with background refresh for stable data, shorter TTLs for frequently changing data, and implement sophisticated hot key handling for high-traffic scenarios.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shayne007.github.io/2025/06/18/Redis-Cache-Eviction-Policies-Complete-Guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charlie Feng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charlie Feng's Tech Space">
      <meta itemprop="description" content="This place is for thinking and sharing.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Charlie Feng's Tech Space">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/18/Redis-Cache-Eviction-Policies-Complete-Guide/" class="post-title-link" itemprop="url">Redis Cache Eviction Policies - Complete Guide</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-06-18 20:51:32" itemprop="dateCreated datePublished" datetime="2025-06-18T20:51:32+08:00">2025-06-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-19 15:27:13" itemprop="dateModified" datetime="2025-06-19T15:27:13+08:00">2025-06-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Overview-of-Redis-Memory-Management"><a href="#Overview-of-Redis-Memory-Management" class="headerlink" title="Overview of Redis Memory Management"></a>Overview of Redis Memory Management</h2><p>Redis is an in-memory data structure store that requires careful memory management to maintain optimal performance. When Redis approaches its memory limit, it must decide which keys to remove to make space for new data. This process is called <strong>memory eviction</strong>.</p>
<pre>
<code class="mermaid">
flowchart TD
A[Redis Instance] --&gt; B{Memory Usage Check}
B --&gt;|Below maxmemory| C[Accept New Data]
B --&gt;|At maxmemory| D[Apply Eviction Policy]
D --&gt; E[Select Keys to Evict]
E --&gt; F[Remove Selected Keys]
F --&gt; G[Accept New Data]

style A fill:#f9f,stroke:#333,stroke-width:2px
style D fill:#bbf,stroke:#333,stroke-width:2px
style E fill:#fbb,stroke:#333,stroke-width:2px
</code>
</pre>

<p><strong>Interview Insight</strong>: <em>Why is memory management crucial in Redis?</em></p>
<ul>
<li>Redis stores all data in RAM for fast access</li>
<li>Uncontrolled memory growth can lead to system crashes</li>
<li>Proper eviction prevents OOM (Out of Memory) errors</li>
<li>Maintains predictable performance characteristics</li>
</ul>
<h2 id="Redis-Memory-Eviction-Policies"><a href="#Redis-Memory-Eviction-Policies" class="headerlink" title="Redis Memory Eviction Policies"></a>Redis Memory Eviction Policies</h2><p>Redis offers 8 different eviction policies, each serving different use cases:</p>
<h3 id="LRU-Based-Policies"><a href="#LRU-Based-Policies" class="headerlink" title="LRU-Based Policies"></a>LRU-Based Policies</h3><h4 id="allkeys-lru"><a href="#allkeys-lru" class="headerlink" title="allkeys-lru"></a>allkeys-lru</h4><p>Evicts the least recently used keys across all keys in the database.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Configuration</span></span><br><span class="line">CONFIG SET maxmemory-policy allkeys-lru</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example scenario</span></span><br><span class="line">SET user:1001 <span class="string">&quot;John Doe&quot;</span>     <span class="comment"># Time: T1</span></span><br><span class="line">GET user:1001               <span class="comment"># Access at T2</span></span><br><span class="line">SET user:1002 <span class="string">&quot;Jane Smith&quot;</span>  <span class="comment"># Time: T3</span></span><br><span class="line"><span class="comment"># If memory is full, user:1002 is more likely to be evicted</span></span><br></pre></td></tr></table></figure>

<p><strong>Best Practice</strong>: Use when you have a natural access pattern where some data is accessed more frequently than others.</p>
<h4 id="volatile-lru"><a href="#volatile-lru" class="headerlink" title="volatile-lru"></a>volatile-lru</h4><p>Evicts the least recently used keys only among keys with an expiration set.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Setup</span></span><br><span class="line">SET session:abc123 <span class="string">&quot;user_data&quot;</span> EX 3600  <span class="comment"># With expiration</span></span><br><span class="line">SET config:theme <span class="string">&quot;dark&quot;</span>                 <span class="comment"># Without expiration</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Only session:abc123 is eligible for LRU eviction</span></span><br></pre></td></tr></table></figure>

<p><strong>Use Case</strong>: Session management where you want to preserve configuration data.</p>
<h3 id="LFU-Based-Policies"><a href="#LFU-Based-Policies" class="headerlink" title="LFU-Based Policies"></a>LFU-Based Policies</h3><h4 id="allkeys-lfu"><a href="#allkeys-lfu" class="headerlink" title="allkeys-lfu"></a>allkeys-lfu</h4><p>Evicts the least frequently used keys across all keys.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Example: Access frequency tracking</span></span><br><span class="line">SET product:1 <span class="string">&quot;laptop&quot;</span>      <span class="comment"># Accessed 100 times</span></span><br><span class="line">SET product:2 <span class="string">&quot;mouse&quot;</span>       <span class="comment"># Accessed 5 times</span></span><br><span class="line">SET product:3 <span class="string">&quot;keyboard&quot;</span>    <span class="comment"># Accessed 50 times</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># product:2 (mouse) would be evicted first due to lowest frequency</span></span><br></pre></td></tr></table></figure>

<h4 id="volatile-lfu"><a href="#volatile-lfu" class="headerlink" title="volatile-lfu"></a>volatile-lfu</h4><p>Evicts the least frequently used keys only among keys with expiration.</p>
<p><strong>Interview Insight</strong>: <em>When would you choose LFU over LRU?</em></p>
<ul>
<li>LFU is better for data with consistent access patterns</li>
<li>LRU is better for data with temporal locality</li>
<li>LFU prevents cache pollution from occasional bulk operations</li>
</ul>
<h3 id="Random-Policies"><a href="#Random-Policies" class="headerlink" title="Random Policies"></a>Random Policies</h3><h4 id="allkeys-random"><a href="#allkeys-random" class="headerlink" title="allkeys-random"></a>allkeys-random</h4><p>Randomly selects keys for eviction across all keys.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Simulation of random eviction</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">keys = [<span class="string">&quot;user:1&quot;</span>, <span class="string">&quot;user:2&quot;</span>, <span class="string">&quot;user:3&quot;</span>, <span class="string">&quot;config:db&quot;</span>, <span class="string">&quot;session:xyz&quot;</span>]</span><br><span class="line">evict_key = random.choice(keys)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Evicting: <span class="subst">&#123;evict_key&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="volatile-random"><a href="#volatile-random" class="headerlink" title="volatile-random"></a>volatile-random</h4><p>Randomly selects keys for eviction only among keys with expiration.</p>
<p><strong>When to Use Random Policies</strong>:</p>
<ul>
<li>When access patterns are completely unpredictable</li>
<li>For testing and development environments</li>
<li>When you need simple, fast eviction decisions</li>
</ul>
<h3 id="TTL-Based-Policy"><a href="#TTL-Based-Policy" class="headerlink" title="TTL-Based Policy"></a>TTL-Based Policy</h3><h4 id="volatile-ttl"><a href="#volatile-ttl" class="headerlink" title="volatile-ttl"></a>volatile-ttl</h4><p>Evicts keys with expiration, prioritizing those with shorter remaining TTL.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Example scenario</span></span><br><span class="line">SET cache:data1 <span class="string">&quot;value1&quot;</span> EX 3600  <span class="comment"># Expires in 1 hour</span></span><br><span class="line">SET cache:data2 <span class="string">&quot;value2&quot;</span> EX 1800  <span class="comment"># Expires in 30 minutes</span></span><br><span class="line">SET cache:data3 <span class="string">&quot;value3&quot;</span> EX 7200  <span class="comment"># Expires in 2 hours</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cache:data2 will be evicted first (shortest TTL)</span></span><br></pre></td></tr></table></figure>

<h3 id="No-Eviction-Policy"><a href="#No-Eviction-Policy" class="headerlink" title="No Eviction Policy"></a>No Eviction Policy</h3><h4 id="noeviction"><a href="#noeviction" class="headerlink" title="noeviction"></a>noeviction</h4><p>Returns errors when memory limit is reached instead of evicting keys.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CONFIG SET maxmemory-policy noeviction</span><br><span class="line"></span><br><span class="line"><span class="comment"># When memory is full:</span></span><br><span class="line">SET new_key <span class="string">&quot;value&quot;</span></span><br><span class="line"><span class="comment"># Error: OOM command not allowed when used memory &gt; &#x27;maxmemory&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>Use Case</strong>: Critical systems where data loss is unacceptable.</p>
<h2 id="Memory-Limitation-Strategies"><a href="#Memory-Limitation-Strategies" class="headerlink" title="Memory Limitation Strategies"></a>Memory Limitation Strategies</h2><h3 id="Why-Limit-Cache-Memory"><a href="#Why-Limit-Cache-Memory" class="headerlink" title="Why Limit Cache Memory?"></a>Why Limit Cache Memory?</h3><pre>
<code class="mermaid">
flowchart LR
A[Unlimited Memory] --&gt; B[System Instability]
A --&gt; C[Unpredictable Performance]
A --&gt; D[Resource Contention]

E[Limited Memory] --&gt; F[Predictable Behavior]
E --&gt; G[System Stability]
E --&gt; H[Better Resource Planning]

style A fill:#fbb,stroke:#333,stroke-width:2px
style E fill:#bfb,stroke:#333,stroke-width:2px
</code>
</pre>

<p><strong>Production Reasons</strong>:</p>
<ul>
<li><strong>System Stability</strong>: Prevents Redis from consuming all available RAM</li>
<li><strong>Performance Predictability</strong>: Maintains consistent response times</li>
<li><strong>Multi-tenancy</strong>: Allows multiple services to coexist</li>
<li><strong>Cost Control</strong>: Manages infrastructure costs effectively</li>
</ul>
<h3 id="Basic-Memory-Configuration"><a href="#Basic-Memory-Configuration" class="headerlink" title="Basic Memory Configuration"></a>Basic Memory Configuration</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Set maximum memory limit (512MB)</span></span><br><span class="line">CONFIG SET maxmemory 536870912</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set eviction policy</span></span><br><span class="line">CONFIG SET maxmemory-policy allkeys-lru</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check current memory usage</span></span><br><span class="line">INFO memory</span><br></pre></td></tr></table></figure>

<h3 id="Using-Lua-Scripts-for-Advanced-Memory-Control"><a href="#Using-Lua-Scripts-for-Advanced-Memory-Control" class="headerlink" title="Using Lua Scripts for Advanced Memory Control"></a>Using Lua Scripts for Advanced Memory Control</h3><h4 id="Limiting-Key-Value-Pairs"><a href="#Limiting-Key-Value-Pairs" class="headerlink" title="Limiting Key-Value Pairs"></a>Limiting Key-Value Pairs</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- limit_keys.lua: Limit total number of keys</span></span><br><span class="line"><span class="keyword">local</span> max_keys = <span class="built_in">tonumber</span>(ARGV[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">local</span> current_keys = redis.call(<span class="string">&#x27;DBSIZE&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> current_keys &gt;= max_keys <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- Get random key and delete it</span></span><br><span class="line">    <span class="keyword">local</span> keys = redis.call(<span class="string">&#x27;RANDOMKEY&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> keys <span class="keyword">then</span></span><br><span class="line">        redis.call(<span class="string">&#x27;DEL&#x27;</span>, keys)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Evicted key: &quot;</span> .. keys</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Add the new key</span></span><br><span class="line">redis.call(<span class="string">&#x27;SET&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">2</span>])</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;Key added successfully&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Usage</span></span><br><span class="line">EVAL <span class="string">&quot;<span class="subst">$(cat limit_keys.lua)</span>&quot;</span> 1 <span class="string">&quot;new_key&quot;</span> 1000 <span class="string">&quot;new_value&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="Limiting-Value-Size"><a href="#Limiting-Value-Size" class="headerlink" title="Limiting Value Size"></a>Limiting Value Size</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- limit_value_size.lua: Reject large values</span></span><br><span class="line"><span class="keyword">local</span> max_size = <span class="built_in">tonumber</span>(ARGV[<span class="number">2</span>])</span><br><span class="line"><span class="keyword">local</span> value = ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">local</span> value_size = <span class="built_in">string</span>.<span class="built_in">len</span>(value)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> value_size &gt; max_size <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> redis.error_reply(<span class="string">&quot;Value size &quot;</span> .. value_size .. <span class="string">&quot; exceeds limit &quot;</span> .. max_size)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">redis.call(<span class="string">&#x27;SET&#x27;</span>, KEYS[<span class="number">1</span>], value)</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;OK&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Usage: Limit values to 1KB</span></span><br><span class="line">EVAL <span class="string">&quot;<span class="subst">$(cat limit_value_size.lua)</span>&quot;</span> 1 <span class="string">&quot;my_key&quot;</span> <span class="string">&quot;my_value&quot;</span> 1024</span><br></pre></td></tr></table></figure>

<h4 id="Memory-Aware-Key-Management"><a href="#Memory-Aware-Key-Management" class="headerlink" title="Memory-Aware Key Management"></a>Memory-Aware Key Management</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- memory_aware_set.lua: Check memory before setting</span></span><br><span class="line"><span class="keyword">local</span> key = KEYS[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">local</span> value = ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">local</span> memory_threshold = <span class="built_in">tonumber</span>(ARGV[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Get current memory usage</span></span><br><span class="line"><span class="keyword">local</span> memory_info = redis.call(<span class="string">&#x27;MEMORY&#x27;</span>, <span class="string">&#x27;USAGE&#x27;</span>, <span class="string">&#x27;SAMPLES&#x27;</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line"><span class="keyword">local</span> used_memory = memory_info[<span class="string">&#x27;used_memory&#x27;</span>]</span><br><span class="line"><span class="keyword">local</span> max_memory = memory_info[<span class="string">&#x27;maxmemory&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> max_memory &gt; <span class="number">0</span> <span class="keyword">and</span> used_memory &gt; (max_memory * memory_threshold / <span class="number">100</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- Trigger manual cleanup</span></span><br><span class="line">    <span class="keyword">local</span> keys_to_check = redis.call(<span class="string">&#x27;RANDOMKEY&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> keys_to_check <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> key_memory = redis.call(<span class="string">&#x27;MEMORY&#x27;</span>, <span class="string">&#x27;USAGE&#x27;</span>, keys_to_check)</span><br><span class="line">        <span class="keyword">if</span> key_memory &gt; <span class="number">1000</span> <span class="keyword">then</span>  <span class="comment">-- If key uses more than 1KB</span></span><br><span class="line">            redis.call(<span class="string">&#x27;DEL&#x27;</span>, keys_to_check)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">redis.call(<span class="string">&#x27;SET&#x27;</span>, key, value)</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;Key set with memory check&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Practical-Cache-Eviction-Solutions"><a href="#Practical-Cache-Eviction-Solutions" class="headerlink" title="Practical Cache Eviction Solutions"></a>Practical Cache Eviction Solutions</h2><h3 id="Big-Object-Evict-First-Strategy"><a href="#Big-Object-Evict-First-Strategy" class="headerlink" title="Big Object Evict First Strategy"></a>Big Object Evict First Strategy</h3><p>This strategy prioritizes evicting large objects to free maximum memory quickly.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Python implementation for big object eviction</span></span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BigObjectEvictionRedis</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis_client</span><br><span class="line">        <span class="variable language_">self</span>.size_threshold = <span class="number">10240</span>  <span class="comment"># 10KB threshold</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_with_size_check</span>(<span class="params">self, key, value</span>):</span><br><span class="line">        <span class="comment"># Calculate value size</span></span><br><span class="line">        value_size = <span class="built_in">len</span>(<span class="built_in">str</span>(value).encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Store size metadata</span></span><br><span class="line">        <span class="variable language_">self</span>.redis.hset(<span class="string">f&quot;<span class="subst">&#123;key&#125;</span>:meta&quot;</span>, <span class="string">&quot;size&quot;</span>, value_size)</span><br><span class="line">        <span class="variable language_">self</span>.redis.hset(<span class="string">f&quot;<span class="subst">&#123;key&#125;</span>:meta&quot;</span>, <span class="string">&quot;created&quot;</span>, <span class="built_in">int</span>(time.time()))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Set the actual value</span></span><br><span class="line">        <span class="variable language_">self</span>.redis.<span class="built_in">set</span>(key, value)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Track large objects</span></span><br><span class="line">        <span class="keyword">if</span> value_size &gt; <span class="variable language_">self</span>.size_threshold:</span><br><span class="line">            <span class="variable language_">self</span>.redis.sadd(<span class="string">&quot;large_objects&quot;</span>, key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">evict_large_objects</span>(<span class="params">self, target_memory_mb</span>):</span><br><span class="line">        large_objects = <span class="variable language_">self</span>.redis.smembers(<span class="string">&quot;large_objects&quot;</span>)</span><br><span class="line">        freed_memory = <span class="number">0</span></span><br><span class="line">        target_bytes = target_memory_mb * <span class="number">1024</span> * <span class="number">1024</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Sort by size (largest first)</span></span><br><span class="line">        objects_with_size = []</span><br><span class="line">        <span class="keyword">for</span> obj <span class="keyword">in</span> large_objects:</span><br><span class="line">            size = <span class="variable language_">self</span>.redis.hget(<span class="string">f&quot;<span class="subst">&#123;obj&#125;</span>:meta&quot;</span>, <span class="string">&quot;size&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> size:</span><br><span class="line">                objects_with_size.append((obj, <span class="built_in">int</span>(size)))</span><br><span class="line">        </span><br><span class="line">        objects_with_size.sort(key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> obj, size <span class="keyword">in</span> objects_with_size:</span><br><span class="line">            <span class="keyword">if</span> freed_memory &gt;= target_bytes:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">                </span><br><span class="line">            <span class="variable language_">self</span>.redis.delete(obj)</span><br><span class="line">            <span class="variable language_">self</span>.redis.delete(<span class="string">f&quot;<span class="subst">&#123;obj&#125;</span>:meta&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.redis.srem(<span class="string">&quot;large_objects&quot;</span>, obj)</span><br><span class="line">            freed_memory += size</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> freed_memory</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage example</span></span><br><span class="line">r = redis.Redis()</span><br><span class="line">big_obj_redis = BigObjectEvictionRedis(r)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set some large objects</span></span><br><span class="line">big_obj_redis.set_with_size_check(<span class="string">&quot;large_data:1&quot;</span>, <span class="string">&quot;x&quot;</span> * <span class="number">50000</span>)</span><br><span class="line">big_obj_redis.set_with_size_check(<span class="string">&quot;large_data:2&quot;</span>, <span class="string">&quot;y&quot;</span> * <span class="number">30000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Evict to free 100MB</span></span><br><span class="line">freed = big_obj_redis.evict_large_objects(<span class="number">100</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Freed <span class="subst">&#123;freed&#125;</span> bytes&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Small-Object-Evict-First-Strategy"><a href="#Small-Object-Evict-First-Strategy" class="headerlink" title="Small Object Evict First Strategy"></a>Small Object Evict First Strategy</h3><p>Useful when you want to preserve large, expensive-to-recreate objects.</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- small_object_evict.lua</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">get_object_size</span><span class="params">(key)</span></span></span><br><span class="line">    <span class="keyword">return</span> redis.call(<span class="string">&#x27;MEMORY&#x27;</span>, <span class="string">&#x27;USAGE&#x27;</span>, key) <span class="keyword">or</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">evict_small_objects</span><span class="params">(count)</span></span></span><br><span class="line">    <span class="keyword">local</span> all_keys = redis.call(<span class="string">&#x27;KEYS&#x27;</span>, <span class="string">&#x27;*&#x27;</span>)</span><br><span class="line">    <span class="keyword">local</span> small_keys = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i, key <span class="keyword">in</span> <span class="built_in">ipairs</span>(all_keys) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> size = get_object_size(key)</span><br><span class="line">        <span class="keyword">if</span> size &lt; <span class="number">1000</span> <span class="keyword">then</span>  <span class="comment">-- Less than 1KB</span></span><br><span class="line">            <span class="built_in">table</span>.<span class="built_in">insert</span>(small_keys, &#123;key, size&#125;)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- Sort by size (smallest first)</span></span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">sort</span>(small_keys, <span class="function"><span class="keyword">function</span><span class="params">(a, b)</span></span> <span class="keyword">return</span> a[<span class="number">2</span>] &lt; b[<span class="number">2</span>] <span class="keyword">end</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">local</span> evicted = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, <span class="built_in">math</span>.<span class="built_in">min</span>(count, #small_keys) <span class="keyword">do</span></span><br><span class="line">        redis.call(<span class="string">&#x27;DEL&#x27;</span>, small_keys[i][<span class="number">1</span>])</span><br><span class="line">        evicted = evicted + <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> evicted</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> evict_small_objects(<span class="built_in">tonumber</span>(ARGV[<span class="number">1</span>]))</span><br></pre></td></tr></table></figure>

<h3 id="Low-Cost-Evict-First-Strategy"><a href="#Low-Cost-Evict-First-Strategy" class="headerlink" title="Low-Cost Evict First Strategy"></a>Low-Cost Evict First Strategy</h3><p>Evicts data thats cheap to regenerate or reload.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CostBasedEviction</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis_client</span><br><span class="line">        <span class="variable language_">self</span>.cost_factors = &#123;</span><br><span class="line">            <span class="string">&#x27;cache:&#x27;</span>: <span class="number">1</span>,      <span class="comment"># Low cost - can regenerate</span></span><br><span class="line">            <span class="string">&#x27;session:&#x27;</span>: <span class="number">5</span>,    <span class="comment"># Medium cost - user experience impact</span></span><br><span class="line">            <span class="string">&#x27;computed:&#x27;</span>: <span class="number">10</span>,  <span class="comment"># High cost - expensive computation</span></span><br><span class="line">            <span class="string">&#x27;external:&#x27;</span>: <span class="number">8</span>    <span class="comment"># High cost - external API call</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_with_cost</span>(<span class="params">self, key, value, custom_cost=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="comment"># Determine cost based on key prefix</span></span><br><span class="line">        cost = custom_cost <span class="keyword">or</span> <span class="variable language_">self</span>._calculate_cost(key)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Store with cost metadata</span></span><br><span class="line">        pipe = <span class="variable language_">self</span>.redis.pipeline()</span><br><span class="line">        pipe.<span class="built_in">set</span>(key, value)</span><br><span class="line">        pipe.hset(<span class="string">f&quot;<span class="subst">&#123;key&#125;</span>:meta&quot;</span>, <span class="string">&quot;cost&quot;</span>, cost)</span><br><span class="line">        pipe.hset(<span class="string">f&quot;<span class="subst">&#123;key&#125;</span>:meta&quot;</span>, <span class="string">&quot;timestamp&quot;</span>, <span class="built_in">int</span>(time.time()))</span><br><span class="line">        pipe.execute()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_calculate_cost</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="keyword">for</span> prefix, cost <span class="keyword">in</span> <span class="variable language_">self</span>.cost_factors.items():</span><br><span class="line">            <span class="keyword">if</span> key.startswith(prefix):</span><br><span class="line">                <span class="keyword">return</span> cost</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>  <span class="comment"># Default medium cost</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">evict_low_cost_items</span>(<span class="params">self, target_count</span>):</span><br><span class="line">        <span class="comment"># Get all keys with metadata</span></span><br><span class="line">        pattern = <span class="string">&quot;*:meta&quot;</span></span><br><span class="line">        meta_keys = <span class="variable language_">self</span>.redis.keys(pattern)</span><br><span class="line">        </span><br><span class="line">        items_with_cost = []</span><br><span class="line">        <span class="keyword">for</span> meta_key <span class="keyword">in</span> meta_keys:</span><br><span class="line">            original_key = meta_key.replace(<span class="string">&#x27;:meta&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            cost = <span class="variable language_">self</span>.redis.hget(meta_key, <span class="string">&#x27;cost&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> cost:</span><br><span class="line">                items_with_cost.append((original_key, <span class="built_in">int</span>(cost)))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Sort by cost (lowest first)</span></span><br><span class="line">        items_with_cost.sort(key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>])</span><br><span class="line">        </span><br><span class="line">        evicted = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> key, cost <span class="keyword">in</span> items_with_cost[:target_count]:</span><br><span class="line">            <span class="variable language_">self</span>.redis.delete(key)</span><br><span class="line">            <span class="variable language_">self</span>.redis.delete(<span class="string">f&quot;<span class="subst">&#123;key&#125;</span>:meta&quot;</span>)</span><br><span class="line">            evicted += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> evicted</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage</span></span><br><span class="line">cost_eviction = CostBasedEviction(redis.Redis())</span><br><span class="line">cost_eviction.set_with_cost(<span class="string">&quot;cache:user:1001&quot;</span>, user_data)</span><br><span class="line">cost_eviction.set_with_cost(<span class="string">&quot;computed:analytics:daily&quot;</span>, expensive_computation)</span><br><span class="line">cost_eviction.evict_low_cost_items(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Cold-Data-Evict-First-Strategy"><a href="#Cold-Data-Evict-First-Strategy" class="headerlink" title="Cold Data Evict First Strategy"></a>Cold Data Evict First Strategy</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ColdDataEviction</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = redis_client</span><br><span class="line">        <span class="variable language_">self</span>.access_tracking_key = <span class="string">&quot;access_log&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_with_tracking</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="comment"># Record access</span></span><br><span class="line">        now = <span class="built_in">int</span>(time.time())</span><br><span class="line">        <span class="variable language_">self</span>.redis.zadd(<span class="variable language_">self</span>.access_tracking_key, &#123;key: now&#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Get value</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.redis.get(key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_with_tracking</span>(<span class="params">self, key, value</span>):</span><br><span class="line">        now = <span class="built_in">int</span>(time.time())</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Set value and track access</span></span><br><span class="line">        pipe = <span class="variable language_">self</span>.redis.pipeline()</span><br><span class="line">        pipe.<span class="built_in">set</span>(key, value)</span><br><span class="line">        pipe.zadd(<span class="variable language_">self</span>.access_tracking_key, &#123;key: now&#125;)</span><br><span class="line">        pipe.execute()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">evict_cold_data</span>(<span class="params">self, days_threshold=<span class="number">7</span>, max_evict=<span class="number">100</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Evict data not accessed within threshold days&quot;&quot;&quot;</span></span><br><span class="line">        cutoff_time = <span class="built_in">int</span>(time.time()) - (days_threshold * <span class="number">24</span> * <span class="number">3600</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Get cold keys (accessed before cutoff time)</span></span><br><span class="line">        cold_keys = <span class="variable language_">self</span>.redis.zrangebyscore(</span><br><span class="line">            <span class="variable language_">self</span>.access_tracking_key, </span><br><span class="line">            <span class="number">0</span>, </span><br><span class="line">            cutoff_time,</span><br><span class="line">            start=<span class="number">0</span>,</span><br><span class="line">            num=max_evict</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        evicted_count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> cold_keys:</span><br><span class="line">            pipe = <span class="variable language_">self</span>.redis.pipeline()</span><br><span class="line">            <span class="keyword">for</span> key <span class="keyword">in</span> cold_keys:</span><br><span class="line">                pipe.delete(key)</span><br><span class="line">                pipe.zrem(<span class="variable language_">self</span>.access_tracking_key, key)</span><br><span class="line">                evicted_count += <span class="number">1</span></span><br><span class="line">                </span><br><span class="line">            pipe.execute()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> evicted_count</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_access_stats</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get access statistics&quot;&quot;&quot;</span></span><br><span class="line">        now = <span class="built_in">int</span>(time.time())</span><br><span class="line">        day_ago = now - <span class="number">86400</span></span><br><span class="line">        week_ago = now - (<span class="number">7</span> * <span class="number">86400</span>)</span><br><span class="line">        </span><br><span class="line">        recent_keys = <span class="variable language_">self</span>.redis.zrangebyscore(<span class="variable language_">self</span>.access_tracking_key, day_ago, now)</span><br><span class="line">        weekly_keys = <span class="variable language_">self</span>.redis.zrangebyscore(<span class="variable language_">self</span>.access_tracking_key, week_ago, now)</span><br><span class="line">        total_keys = <span class="variable language_">self</span>.redis.zcard(<span class="variable language_">self</span>.access_tracking_key)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;total_tracked_keys&#x27;</span>: total_keys,</span><br><span class="line">            <span class="string">&#x27;accessed_last_day&#x27;</span>: <span class="built_in">len</span>(recent_keys),</span><br><span class="line">            <span class="string">&#x27;accessed_last_week&#x27;</span>: <span class="built_in">len</span>(weekly_keys),</span><br><span class="line">            <span class="string">&#x27;cold_keys&#x27;</span>: total_keys - <span class="built_in">len</span>(weekly_keys)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage example</span></span><br><span class="line">cold_eviction = ColdDataEviction(redis.Redis())</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use with tracking</span></span><br><span class="line">cold_eviction.set_with_tracking(<span class="string">&quot;user:1001&quot;</span>, <span class="string">&quot;user_data&quot;</span>)</span><br><span class="line">value = cold_eviction.get_with_tracking(<span class="string">&quot;user:1001&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Evict data not accessed in 7 days</span></span><br><span class="line">evicted = cold_eviction.evict_cold_data(days_threshold=<span class="number">7</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Evicted <span class="subst">&#123;evicted&#125;</span> cold data items&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get statistics</span></span><br><span class="line">stats = cold_eviction.get_access_stats()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Access stats: <span class="subst">&#123;stats&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Algorithm-Deep-Dive"><a href="#Algorithm-Deep-Dive" class="headerlink" title="Algorithm Deep Dive"></a>Algorithm Deep Dive</h2><h3 id="LRU-Implementation-Details"><a href="#LRU-Implementation-Details" class="headerlink" title="LRU Implementation Details"></a>LRU Implementation Details</h3><p>Redis uses an approximate LRU algorithm for efficiency:</p>
<pre>
<code class="mermaid">
flowchart TD
A[Key Access] --&gt; B[Update LRU Clock]
B --&gt; C{Memory Full?}
C --&gt;|No| D[Operation Complete]
C --&gt;|Yes| E[Sample Random Keys]
E --&gt; F[Calculate LRU Score]
F --&gt; G[Select Oldest Key]
G --&gt; H[Evict Key]
H --&gt; I[Operation Complete]

style E fill:#bbf,stroke:#333,stroke-width:2px
style F fill:#fbb,stroke:#333,stroke-width:2px
</code>
</pre>

<p><strong>Interview Question</strong>: <em>Why doesnt Redis use true LRU?</em></p>
<ul>
<li>True LRU requires maintaining a doubly-linked list of all keys</li>
<li>This would consume significant memory overhead</li>
<li>Approximate LRU samples random keys and picks the best candidate</li>
<li>Provides good enough results with much better performance</li>
</ul>
<h3 id="LFU-Implementation-Details"><a href="#LFU-Implementation-Details" class="headerlink" title="LFU Implementation Details"></a>LFU Implementation Details</h3><p>Redis LFU uses a probabilistic counter that decays over time:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Simplified LFU counter simulation</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LFUCounter</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.counter = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.last_access = time.time()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">increment</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Probabilistic increment based on current counter</span></span><br><span class="line">        <span class="comment"># Higher counters increment less frequently</span></span><br><span class="line">        probability = <span class="number">1.0</span> / (<span class="variable language_">self</span>.counter * <span class="number">10</span> + <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> random.random() &lt; probability:</span><br><span class="line">            <span class="variable language_">self</span>.counter += <span class="number">1</span></span><br><span class="line">        <span class="variable language_">self</span>.last_access = time.time()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decay</span>(<span class="params">self, decay_time_minutes=<span class="number">1</span></span>):</span><br><span class="line">        <span class="comment"># Decay counter over time</span></span><br><span class="line">        now = time.time()</span><br><span class="line">        minutes_passed = (now - <span class="variable language_">self</span>.last_access) / <span class="number">60</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> minutes_passed &gt; decay_time_minutes:</span><br><span class="line">            decay_amount = <span class="built_in">int</span>(minutes_passed / decay_time_minutes)</span><br><span class="line">            <span class="variable language_">self</span>.counter = <span class="built_in">max</span>(<span class="number">0</span>, <span class="variable language_">self</span>.counter - decay_amount)</span><br><span class="line">            <span class="variable language_">self</span>.last_access = now</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example usage</span></span><br><span class="line">counter = LFUCounter()</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">    counter.increment()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Counter after 100 accesses: <span class="subst">&#123;counter.counter&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Choosing-the-Right-Eviction-Policy"><a href="#Choosing-the-Right-Eviction-Policy" class="headerlink" title="Choosing the Right Eviction Policy"></a>Choosing the Right Eviction Policy</h2><h3 id="Decision-Matrix"><a href="#Decision-Matrix" class="headerlink" title="Decision Matrix"></a>Decision Matrix</h3><pre>
<code class="mermaid">
flowchart TD
A[Choose Eviction Policy] --&gt; B{Data has TTL?}
B --&gt;|Yes| C{Preserve non-expiring data?}
B --&gt;|No| D{Access pattern known?}

C --&gt;|Yes| E[volatile-lru&#x2F;lfu&#x2F;ttl]
C --&gt;|No| F[allkeys-lru&#x2F;lfu]

D --&gt;|Temporal locality| G[allkeys-lru]
D --&gt;|Frequency based| H[allkeys-lfu]
D --&gt;|Unknown&#x2F;Random| I[allkeys-random]

J{Can tolerate data loss?} --&gt; K[No eviction]
J --&gt;|Yes| L[Choose based on pattern]

style E fill:#bfb,stroke:#333,stroke-width:2px
style G fill:#bbf,stroke:#333,stroke-width:2px
style H fill:#fbb,stroke:#333,stroke-width:2px
</code>
</pre>

<h3 id="Use-Case-Recommendations"><a href="#Use-Case-Recommendations" class="headerlink" title="Use Case Recommendations"></a>Use Case Recommendations</h3><table>
<thead>
<tr>
<th>Use Case</th>
<th>Recommended Policy</th>
<th>Reason</th>
</tr>
</thead>
<tbody><tr>
<td>Web session store</td>
<td><code>volatile-lru</code></td>
<td>Sessions have TTL, preserve config data</td>
</tr>
<tr>
<td>Cache layer</td>
<td><code>allkeys-lru</code></td>
<td>Recent data more likely to be accessed</td>
</tr>
<tr>
<td>Analytics cache</td>
<td><code>allkeys-lfu</code></td>
<td>Popular queries accessed frequently</td>
</tr>
<tr>
<td>Rate limiting</td>
<td><code>volatile-ttl</code></td>
<td>Remove expired limits first</td>
</tr>
<tr>
<td>Database cache</td>
<td><code>allkeys-lfu</code></td>
<td>Hot data accessed repeatedly</td>
</tr>
</tbody></table>
<h3 id="Production-Configuration-Example"><a href="#Production-Configuration-Example" class="headerlink" title="Production Configuration Example"></a>Production Configuration Example</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># redis.conf production settings</span></span><br><span class="line">maxmemory 2gb</span><br><span class="line">maxmemory-policy allkeys-lru</span><br><span class="line">maxmemory-samples 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># Monitor memory usage</span></span><br><span class="line">redis-cli --latency-history -i 1</span><br><span class="line">redis-cli INFO memory | grep used_memory_human</span><br></pre></td></tr></table></figure>

<h2 id="Performance-Monitoring-and-Tuning"><a href="#Performance-Monitoring-and-Tuning" class="headerlink" title="Performance Monitoring and Tuning"></a>Performance Monitoring and Tuning</h2><h3 id="Key-Metrics-to-Monitor"><a href="#Key-Metrics-to-Monitor" class="headerlink" title="Key Metrics to Monitor"></a>Key Metrics to Monitor</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># monitoring_script.py</span></span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">monitor_eviction_performance</span>(<span class="params">redis_client</span>):</span><br><span class="line">    info = redis_client.info(<span class="string">&#x27;stats&#x27;</span>)</span><br><span class="line">    memory_info = redis_client.info(<span class="string">&#x27;memory&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    metrics = &#123;</span><br><span class="line">        <span class="string">&#x27;evicted_keys&#x27;</span>: info.get(<span class="string">&#x27;evicted_keys&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">        <span class="string">&#x27;keyspace_hits&#x27;</span>: info.get(<span class="string">&#x27;keyspace_hits&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">        <span class="string">&#x27;keyspace_misses&#x27;</span>: info.get(<span class="string">&#x27;keyspace_misses&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">        <span class="string">&#x27;used_memory&#x27;</span>: memory_info.get(<span class="string">&#x27;used_memory&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">        <span class="string">&#x27;used_memory_peak&#x27;</span>: memory_info.get(<span class="string">&#x27;used_memory_peak&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">        <span class="string">&#x27;mem_fragmentation_ratio&#x27;</span>: memory_info.get(<span class="string">&#x27;mem_fragmentation_ratio&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Calculate hit ratio</span></span><br><span class="line">    total_requests = metrics[<span class="string">&#x27;keyspace_hits&#x27;</span>] + metrics[<span class="string">&#x27;keyspace_misses&#x27;</span>]</span><br><span class="line">    hit_ratio = metrics[<span class="string">&#x27;keyspace_hits&#x27;</span>] / total_requests <span class="keyword">if</span> total_requests &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    metrics[<span class="string">&#x27;hit_ratio&#x27;</span>] = hit_ratio</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> metrics</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage</span></span><br><span class="line">r = redis.Redis()</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    stats = monitor_eviction_performance(r)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Hit Ratio: <span class="subst">&#123;stats[<span class="string">&#x27;hit_ratio&#x27;</span>]:<span class="number">.2</span>%&#125;</span>, Evicted: <span class="subst">&#123;stats[<span class="string">&#x27;evicted_keys&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Alerting-Thresholds"><a href="#Alerting-Thresholds" class="headerlink" title="Alerting Thresholds"></a>Alerting Thresholds</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># alerts.yml (Prometheus/Grafana style)</span></span><br><span class="line"><span class="attr">alerts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis_hit_ratio_low</span></span><br><span class="line">    <span class="attr">condition:</span> <span class="string">redis_hit_ratio</span> <span class="string">&lt;</span> <span class="number">0.90</span></span><br><span class="line">    <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis_eviction_rate_high</span></span><br><span class="line">    <span class="attr">condition:</span> <span class="string">rate(redis_evicted_keys[5m])</span> <span class="string">&gt;</span> <span class="number">100</span></span><br><span class="line">    <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">    </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis_memory_usage_high</span></span><br><span class="line">    <span class="attr">condition:</span> <span class="string">redis_used_memory</span> <span class="string">/</span> <span class="string">redis_maxmemory</span> <span class="string">&gt;</span> <span class="number">0.90</span></span><br><span class="line">    <span class="attr">severity:</span> <span class="string">warning</span></span><br></pre></td></tr></table></figure>

<h2 id="Interview-Questions-and-Answers"><a href="#Interview-Questions-and-Answers" class="headerlink" title="Interview Questions and Answers"></a>Interview Questions and Answers</h2><h3 id="Advanced-Interview-Questions"><a href="#Advanced-Interview-Questions" class="headerlink" title="Advanced Interview Questions"></a>Advanced Interview Questions</h3><p><strong>Q: How would you handle a scenario where your cache hit ratio drops significantly after implementing LRU eviction?</strong></p>
<p><strong>A</strong>: This suggests the working set is larger than available memory. Solutions:</p>
<ol>
<li>Increase memory allocation if possible</li>
<li>Switch to LFU if theres a frequency-based access pattern</li>
<li>Implement application-level partitioning</li>
<li>Use Redis Cluster for horizontal scaling</li>
<li>Optimize data structures (use hashes for small objects)</li>
</ol>
<p><strong>Q: Explain the trade-offs between different sampling sizes in Redis LRU implementation.</strong></p>
<p><strong>A</strong>: </p>
<ul>
<li>Small samples (3-5): Fast eviction, less accurate LRU approximation</li>
<li>Large samples (10+): Better LRU approximation, higher CPU overhead</li>
<li>Default (5): Good balance for most use cases</li>
<li>Monitor <code>evicted_keys</code> and <code>keyspace_misses</code> to tune</li>
</ul>
<p><strong>Q: How would you implement a custom eviction policy for a specific business requirement?</strong></p>
<p><strong>A</strong>: Use Lua scripts or application-level logic:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Custom: Evict based on business priority</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">business_priority_evict</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> keys = redis.call(<span class="string">&#x27;KEYS&#x27;</span>, <span class="string">&#x27;*&#x27;</span>)</span><br><span class="line">    <span class="keyword">local</span> priorities = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i, key <span class="keyword">in</span> <span class="built_in">ipairs</span>(keys) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> priority = redis.call(<span class="string">&#x27;HGET&#x27;</span>, key .. <span class="string">&#x27;:meta&#x27;</span>, <span class="string">&#x27;business_priority&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> priority <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">table</span>.<span class="built_in">insert</span>(priorities, &#123;key, <span class="built_in">tonumber</span>(priority)&#125;)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">sort</span>(priorities, <span class="function"><span class="keyword">function</span><span class="params">(a, b)</span></span> <span class="keyword">return</span> a[<span class="number">2</span>] &lt; b[<span class="number">2</span>] <span class="keyword">end</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> #priorities &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        redis.call(<span class="string">&#x27;DEL&#x27;</span>, priorities[<span class="number">1</span>][<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">return</span> priorities[<span class="number">1</span>][<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="Best-Practices-Summary"><a href="#Best-Practices-Summary" class="headerlink" title="Best Practices Summary"></a>Best Practices Summary</h2><h3 id="Configuration-Best-Practices"><a href="#Configuration-Best-Practices" class="headerlink" title="Configuration Best Practices"></a>Configuration Best Practices</h3><ol>
<li><strong>Set appropriate maxmemory</strong>: 80% of available RAM for dedicated Redis instances</li>
<li><strong>Choose policy based on use case</strong>: LRU for temporal, LFU for frequency patterns</li>
<li><strong>Monitor continuously</strong>: Track hit ratios, eviction rates, and memory usage</li>
<li><strong>Test under load</strong>: Verify eviction behavior matches expectations</li>
</ol>
<h3 id="Application-Integration-Best-Practices"><a href="#Application-Integration-Best-Practices" class="headerlink" title="Application Integration Best Practices"></a>Application Integration Best Practices</h3><ol>
<li><strong>Graceful degradation</strong>: Handle cache misses gracefully</li>
<li><strong>TTL strategy</strong>: Set appropriate expiration times</li>
<li><strong>Key naming</strong>: Use consistent patterns for better policy effectiveness</li>
<li><strong>Size awareness</strong>: Monitor and limit large values</li>
</ol>
<h3 id="Operational-Best-Practices"><a href="#Operational-Best-Practices" class="headerlink" title="Operational Best Practices"></a>Operational Best Practices</h3><ol>
<li><strong>Regular monitoring</strong>: Set up alerts for key metrics</li>
<li><strong>Capacity planning</strong>: Plan for growth and peak loads</li>
<li><strong>Testing</strong>: Regularly test eviction scenarios</li>
<li><strong>Documentation</strong>: Document policy choices and rationale</li>
</ol>
<h2 id="External-Resources"><a href="#External-Resources" class="headerlink" title="External Resources"></a>External Resources</h2><ul>
<li><a target="_blank" rel="noopener" href="https://redis.io/docs/manual/eviction/">Redis Memory Optimization Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://redis.io/docs/manual/config/">Redis Configuration Best Practices</a></li>
<li><a target="_blank" rel="noopener" href="https://redis.io/docs/manual/admin/">Redis Monitoring Tools</a></li>
<li><a target="_blank" rel="noopener" href="https://redis.io/docs/manual/optimization/">Performance Tuning Guide</a></li>
</ul>
<p>This comprehensive guide provides the foundation for implementing effective memory eviction strategies in Redis production environments. The combination of theoretical understanding and practical implementation examples ensures robust cache management that scales with your application needs.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Charlie Feng</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
